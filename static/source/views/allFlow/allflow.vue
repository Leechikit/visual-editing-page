<style scoped>
.mainText {
  position: absolute !important;
  /*    top: 55px;*/
  left: 0;
  right: 0;
  bottom: 0;
}
.mainText {
  position: relative;
  padding: 8px 8px 0 8px;
  height: 100%;
  background-color: #fff;
}
.leftpanel {
  width: 100%;
  top: 60px;
  left: 0;
  bottom: 10px;
  min-height: 400px;
  box-sizing: border-box;
  background-color: #fff;
  overflow: hidden;
  display: block;
}
.leftpanel {
  top: 9px !important;
  bottom: 60px !important;
  /*display: none;*/
}

.leftpanel .nav {
}
.nav {
  padding-left: 0;
  margin-bottom: 0;
  list-style: none;
}
li {
  /*display: list-item;*/
  text-align: -webkit-match-parent;
}

.nav-pills > li {
  float: left;
}
.nav > li {
  position: relative;
  display: block;
}

.leftpanel > li {
  display: list-item;
  text-align: -webkit-match-parent;
}

.leftpanel > ul,
menu,
dir {
  display: block;
  list-style-type: disc;
  -webkit-margin-before: 1em;
  -webkit-margin-after: 1em;
  -webkit-margin-start: 0px;
  -webkit-margin-end: 0px;
  /*//-webkit-padding-start: 40px;*/
}
.nav.nav-pills.nav-stacked > li {
  width: 100%;
  float: left;
}

.nav > li {
  position: relative;
  display: block;
}

.nav-pills > li.active > a,
.nav-pills > li.active > a:hover,
.nav-pills > li.active > a:focus {
  color: #636e7b;
}
.leftpanel .nav > li > a:hover,
.leftpanel .nav > li > a:focus,
.leftpanel .nav > li > a:active {
}
.leftpanel .nav > li.active > a,
.leftpanel .nav > li > a:hover {
  border-top: 0;
  margin-right: 0;
  background-color: #f9fafb;
  color: #37abfd;
}
.leftpanel .nav > li > a:hover,
.leftpanel .nav > li > a:focus,
.leftpanel .nav > li > a:active {
}
.leftpanel .nav > li.active > a,
.leftpanel .nav > li > a:hover {
  border-top: 0;
  margin-right: 0;
  background-color: #f9fafb;
  color: #37abfd;
}
.nav-pills > li.active > a,
.nav-pills > li.active > a:hover,
.nav-pills > li.active > a:focus {
  color: #fff;
  background-color: #428bca;
}
.leftpanel .nav-pills a:hover {
  background-color: #d4edfe !important;
}
.leftpanel .nav > li > a {
  color: #4b5f6c;
  -moz-border-radius: 0;
  -webkit-border-radius: 0;
  border-radius: 0;
  -moz-transition: all 0.2s ease-out 0s;
  -webkit-transition: all 0.2s ease-out 0s;
  transition: all 0.2s ease-out 0s;
}
.leftpanel .nav > li > a {
  margin: 0 1px 0 0;
  font-size: 14px;
  position: relative;
  border-left: 1px solid #fff;
}
.nav > li > a:hover,
.nav > li > a:focus {
  text-decoration: none;
}
.nav > li > a {
  padding-right: 5px;
}
.nav-pills > li > a {
  -moz-border-radius: 3px;
  -webkit-border-radius: 3px;
  border-radius: 3px;
}
.nav-pills > li > a {
  border-radius: 4px;
}
.nav > li > a {
  position: relative;
  display: block;
}
.nav {
  padding-left: 0;
  margin-bottom: 0;
  list-style: none;
}

.ulclass,
menu,
dir {
  list-style-type: disc;
  -webkit-margin-before: 1em;
  -webkit-margin-after: 1em;
  -webkit-margin-start: 0px;
  -webkit-margin-end: 0px;
  -webkit-padding-start: 40px;
}
.mainpanel {
  /* margin-left: 230px;*/
  position: relative;
  height: 100%;
}

/*.contentpanel {
    position: absolute;
}
.contentpanel {
}
.contentpanel {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    margin-bottom: 50px;
}*/
#ListView {
  height: 100%;
  overflow: hidden;
  bottom: 40px;
  background-color: #fff;
  padding: 0 10px 10px 10px;
}

#ListView .btn-toolbar {
  height: 50px;
  padding: 0 10px 10px 10px;
  padding-left: 0;
  box-sizing: border-box;
  border: 0 solid #ddd;
  background-color: #fff;
  margin: 0 0 0 0 !important;
}

.btn-toolbar {
  margin-left: -5px;
}
.btn-toolbar > .btn,
.btn-toolbar > .btn-group,
.btn-toolbar > .input-group {
  margin-left: 5px;
}
.btn-toolbar .btn-group,
.btn-toolbar .input-group {
  float: left;
}

.btn-group {
  margin-bottom: 10px;
}
.btn-group,
.btn-group-vertical {
  position: relative;
  display: inline-block;
  vertical-align: middle;
}
#ListView .btn-toolbar div#Create {
  background-color: #37abfd;
  color: #fff;
}
#ListView .btn-toolbar .btn {
  height: 30px;
  border: 0;
  background-color: #fff;
  display: inline-block;
  box-sizing: border-box;
  border-radius: 3px;
  padding: 5px 12px;
  font-size: 14px;
  line-height: 1.4285;
  cursor: pointer;
  margin-right: 6px;
}
#ListView .btn-toolbar .btn {
  height: 30px;
  border: 0;
  background-color: #fff;
  display: inline-block;
  box-sizing: border-box;
  border-radius: 3px;
  padding: 5px 12px;
  font-size: 14px;
  line-height: 1.4285;
  cursor: pointer;
  margin-right: 6px;
}
.btn-group > .btn:first-child:not(:last-child):not(.dropdown-toggle) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.btn-group > .btn:first-child {
  margin-left: 0;
}
.btn-group > .btn,
.btn-group-vertical > .btn {
  border-width: 1px;
}
.btn-group > .btn,
.btn-group-vertical > .btn {
  position: relative;
  float: left;
}
.btn-default {
  background: #fff;
  color: #636e7b;
}
.btn {
  -moz-border-radius: 3px;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  line-height: 21px;
  -moz-transition: all 0.2s ease-out 0s;
  -webkit-transition: all 0.2s ease-out 0s;
  transition: all 0.2s ease-out 0s;
  padding: 8px 15px;
  border-width: 0;
}
.btn-default {
  color: #333;
  background-color: #fff;
  border-color: #ccc;
}
.btn {
  display: inline-block;
  padding: 6px 12px;
  margin-bottom: 0;
  font-size: 14px;
  font-weight: 400;
  line-height: 1.42857143;
  text-align: center;
  white-space: nowrap;
  vertical-align: middle;
  cursor: pointer;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  background-image: none;
  border: 1px solid transparent;
  border-radius: 4px;
}

#ListView .backgroundcolor {
  padding-bottom: 1px;
  border: 0 solid #ddd;
  border-bottom: 0;
}

.backgroundcolor {
  background-color: #fff;
}
.backgroundcolor {
  background-color: #f6f7f8;
}

.form-group {
  margin-bottom: 15px;
}

#ListView #divSearch .form-group .control-label.filter-text {
  text-align: left;
  padding-right: 0;
  width: 8%;
  max-width: 8%;
  font-size: 13px;
}
.form-group .control-label {
  padding-right: 16px;
  text-align: left;
}
.form-group .control-label {
  line-height: 30px;
  margin: 0 !important;
  padding: 0;
}
.form-group .control-label {
  margin-top: 3px;
}
</style>
<template>
        <div class="mainText">
        <Row>
         <Col span="3">
            <div class="leftpanel">
                <ul class="nav nav-pills nav-stacked" style="max-height: 880px;" v-for="(item,index) in appInstData">
                    <li :class="{ active: (currentId==null&&index==0)||(item.appName==currentName) }"  @click="changeAdd(item.id,item.appName,item.appKey)">
                        <a href="javascript:void(0)"> <span>{{item.appName}}</span></a>
                    </li>
                </ul>
            </div>
        </Col>
        <Col span="21">
                    <div id="ListView">
                        <div class="btn-toolbar" role="toolbar">
                            <div class="btn-group" role="group">
                                <Button v-if="checkPerm(['act:deal:start:'+currentAppKey])" :disabled="appInstData.length==0" type="primary" @click="showRender()"><Icon type="plus-round"></Icon>新增</Button>
                                <Button  type="text"><Icon type="upload" color="#fabb0c" style="margin-right:10px"></Icon>导入</Button>
                                <Button type="text"><Icon type="android-download" color="#17c295" style="margin-right:10px"></Icon>导出</Button>
                                <Button v-if="checkPerm(['act:deal:remove:'+currentAppKey])" type="text" @click="openDeleteModal()"><Icon type="trash-a" color="#e97763" style="margin-right:10px"></Icon>删除</Button>
                            </div>
                        </div>
                    <i-table highlight-row @on-row-click='rowClick'  :content="self" :columns="columnsCsv" :loading="getLoading" :data="csvData" size="small" ref="tableCsv"></i-table>
                        <Page ref='page' style ="pull:right;margin-top:20px" :total=total size="small" show-elevator show-sizer @on-change="getAppInstanceList(this.appId)"></Page>
                        </div>
                     <Modal v-model="showModal" :mask-closable="false" width="60">
                          <div  class="render-container">
                            <!--  <p slot="header" style="color:#f60;text-align:center">
                                    <Icon type="information-circled"></Icon>
                                    <span>{{appName}}</span>
                                </p> -->
                                <openModal v-if="showModal":code="currentCode"></openModal>
                                <!-- <RenderDev style="margin-top: 50px;" :soul="soul"  ref="myRender"></RenderDev> -->
                            <!--  <Button @click="result(soul.children)" type="primary">check</Button> -->

                          </div>
                           <div slot="footer">
                                    <!-- <Button type="primary" :loading="commitLoading" @click="check(soul.children)">提交</Button>
                                    <Button type="ghost" @click="handleReset()" style="margin-left: 8px">取消</Button> -->
                            </div>
                    </Modal>

            </Col>
        </Row>
    </div>
</template>
<script>
import HTTP from "../../api/app-apply.js";
import { filter } from "./filter.js";
import router from "../../router/router.js";
import ICol from "iview/src/components/grid/col";
import log from "../flow-manager/designFlowModal/appInfoLog.vue";
import { dataFormat } from "../../util/assist.js";
import { parse } from "../../util/assist";
import { mapGetters, mapMutations, mapActions } from "vuex";
import DragableTable from "../tables/components/dragableTable.vue";
import utils from "../../util/utils.js";
import openModal from "../home/openModal.vue";

export default {
  components: { ICol, DragableTable, openModal },
  name: "appRun",
  data() {
    return {
      self: this,
      theme1: {
        type: String,
        default: "light",
        color: "gray"
      },
      showModal: false,
      currentParam: {},
      list: [],
      pageName: "",
      appName: "",
      currentCode: "",
      currentName: "",
      currentAppKey: "",
      currentData: [],
      currentList: "",
      commitLoading: false,
      appRunData: [],
      utils: new utils(),
      selectRowData: "",
      columnsCsv: [
        {
          type: "index",
          width: 80,
          fixed: "left",
          align: "center"
        },
        {
          title: "应用运行名称",
          key: "appRunName",
          width: 250
        },
        {
          title: "应用名称",
          width: 200,
          key: "appName"
        },
        {
          title: "状态",
          width: 180,
          key: "status",
          render: (h, params) => {
            const row = params.row;
            const color =
              row.status == 1 ? "blue" : row.status == 2 ? "yellow" : row.status == 4? "red": "green";
            const text =
              row.status == 1 ? "草稿" : row.status == 2 ? "审批中" :row.status == 4 ? "驳回":"结束";
            return h(
              "Tag",
              {
                props: {
                  type: "dot",
                  color: color
                }
              },
              text
            );
          }
        },
        {
          title: "流程发起人",
          key: "startUserId",
          width: 270
        },
        {
          title: "流程发起时间",
          key: "startTime",
          width: 270,
          render: (h, params) => {
            return h("div", {}, dataFormat(params.row.startTime));
          }
        },
        {
          title: "审批结果",
          key: "actResult",
          width: 200,
          render: (h, params) => {
            return h("div", {}, filter.approvalResult[params.row.actResult]);
            /*这里的this.row能够获取当前行的数据*/
          }
        },
        {
          title: "操作",
          key: "action",
          width: 130,
          align: "center",
          render: (h, params) => {
            return h("div", [
              h(
                "Button",
                {
                  props: {
                    type: "primary",
                    size: "small"
                  },
                  style: {
                    marginRight: "5px"
                  },
                  on: {
                    click: () => {
                      this.openLogModal(params);
                    }
                  }
                },
                "审查记录"
              )
            ]);
          }
        }
      ],
      columnsList: [
        {
          title: "应用名称",
          key: "appName"
        },
        {
          title: "操作",
          key: "action",
          width: 100,
          align: "center",
          render: (h, params) => {
            return h("div", [
              h(
                "Button",
                {
                  props: {
                    type: "primary",
                    size: "small"
                  },
                  style: {
                    marginRight: "5px"
                  },
                  on: {
                    click: () => {
                      this.showRender(params.row.id, params.row.appName);
                    }
                  }
                },
                "应用"
              )
            ]);
          }
        }
      ],
      csvData: [],
      appInstData: [],
      appId: "",
      total: 40,
      selectMinRow: 1,
      selectMinCol: 1,
      minRow: 1,
      minCol: 1,
      fontSize: 16,
      getLoading: false,
      modelId: null,
      appId: null,
      propertyJson: [],
      validResult: true,
      result: true,
      currentId: null
    };
  },
  async beforeRouteUpdate(to, from, next) {
    this.currentId = null;
    await this.getAppList(to.params.moduleId);
    next();
  },
  mounted() {
    this.currentId = this.$router.currentRoute.params.appId;
    this.currentName = this.$router.currentRoute.params.appName;
    this.currentAppKey = this.$router.currentRoute.params.appKey;
    this.getAppList(this.$router.currentRoute.params.moduleId);
    console.log(this.currentAppKey)
    //this.$router.go(0);
    // this.getAppInstanceList();
  },
  computed: {
    ...mapGetters("dragModule", ["soul"]),
    // 计算属性的 getter
    colNum: function() {
      // `this` 指向 vm 实例
      return this.columnsCsv.length;
    },
    rowNum: function() {
      // `this` 指向 vm 实例
      return this.csvData.length;
    },
    selectMaxCol: function() {
      return this.columnsCsv.length;
    },
    selectMaxRow: function() {
      // `this` 指向 vm 实例
      return this.csvData.length;
    },
    maxCol: function() {
      return this.columnsCsv.length;
    },
    maxRow: function() {
      // `this` 指向 vm 实例
      return this.csvData.length;
    }
  },
  methods: {
    ...mapMutations("dragModule", ["setSoul"]),
    changeAdd(id, name, appKey) {
      this.currentId = id;
      this.currentName = name;
      this.currentAppKey = appKey;
      this.getAppInstanceList(id);
    },
    getAppList(moduleId) {
      this.getLoading = true;
      this.appInstData = [];
      HTTP.appList(moduleId)
        .then(res => {
          if (res.code == 0 && res.page.result && res.page.result.length > 0) {
            this.appInstData = res.page.result;
            if (this.utils.judgeNull(this.currentId)) {
              this.currentName = res.page.result[0].appName;
              this.currentId = res.page.result[0].id;
              this.currentAppKey = res.page.result[0].appKey;
              console.log(this.currentAppKey);
            }

            // this.appId="5ed5e836f0a04d43a1edfc434745e9d7";
            if (this.appInstData.length != 0) {
              this.getAppInstanceList(this.appInstData[0].id);
            }
          }

          // this.appId=this.appInstData[0].id;
          // this.modelId = this.appInstData[0].modelId;
        })
        .catch(err => {
          this.$Message.error("This is an error");
        })
        .finally(() => {
          this.getLoading = false;
        });
    },
    handleOnstart1(form) {
      this.getAppInstanceList(this.appInstData[form].id);
      this.appId = this.appInstData[form].id;
    },
    showRender() {
      this.currentCode = this.currentId;
      this.showModal = true;

      //  HTTP.getPageSoul(this.currentId)
      //     .then(res => {
      //         this.showModal = true;
      //         this.appId=res.id;
      //         this.modelId = res.modelId;
      //         this.appName =this.currentName;
      //         let ancestorSoul = parse(res.pagesoul);
      //         console.log(ancestorSoul);
      //         this.setSoul(ancestorSoul)
      //     })
      //     .catch(err => {
      //         this.$Message.error('This is an error'+err);
      //         console.log(err);
      //     }).finally(()=>{
      //     this.getLoading=false;
      // })
    },
    getAppInstanceList(appId) {
      this.selectRowData = "";
      let param = {};
      this.getLoading = true;
      param.pageNum = 1;
      param.appId = appId;
      // console.log(param);
      HTTP.appInstanceList(param)
        .then(res => {
          this.total = res.page.total;
          this.csvData = res.page.result;
        })
        .catch(err => {
          this.$Message.error("This is an error");
        })
        .finally(() => {
          this.getLoading = false;
        });
    },
    handleReset() {
      this.showModal = false;
    },
    check(param) {
      this.validResult = true;
      console.log(this.$refs["myRender"].$children);
      if (this.utils.judgeNull(this.$refs["myRender"].$children)) {
      } else {
        this.validResult = this.checkValidation(
          this.$refs["myRender"].$children
        );
      }

      if (this.validResult) {
        this.propertyJson = [];
        for (var index in param) {
          if (
            param[index].type == "Div" ||
            param[index].type == "Row" ||
            param[index].type == "Col"
          ) {
            this.check(param[index].children);
          } else {
            this.anaData(param[index]);
          }
        }

        this.commitLoading = true;
        HTTP.commitNewData({
          modelId: this.modelId,
          appId: this.appId,
          propertyJson: JSON.stringify(this.propertyJson),
          appName: this.appName
        })
          .then(res => {
            if (res.code == 0) {
              this.$Message.success("提交成功");
            } else {
              this.$Message.error("提交失败");
            }
          })
          .catch(err => {
            this.$Message.error("This is an error");
          })
          .finally(() => {
            this.commitLoading = false;
            this.showModal = false;
          });
      } else {
        this.$Message.error("校验失败");
      }
    },
    checkValidation(param) {
      this.result = true;
      for (var index = 0; index < param.length; index++) {
        if (!param[index].soul.isFormItem) {
          if (this.utils.judgeNull(param[index].$refs))
            this.checkValidation(param[index].$refs);
          else {
          }
        } else {
          if (
            !param[index].$refs["formItem"] ||
            !param[index].$refs["formItem"].validate
          ) {
          } else {
            if (param[index].soul.desc == "FormCheckbox") {
              if (param[index].$refs["formItem"].$children.length < 2) {
                console.log(param[index].$refs["formItem"].$children);
              } else {
                param[index].$refs["formItem"].$children[1].validate(valid => {
                  if (valid) {
                  } else {
                    this.result = false;
                  }
                });
              }
            } else {
              param[index].$refs["formItem"].validate(valid => {
                if (valid) {
                } else {
                  this.result = false;
                }
              });
            }
          }
        }
      }
      return this.result;
    },
    anaData(param) {
      var tmp = {};
      tmp.value = [];
      tmp.id = param.uid;
      if (param.type == "FormCheckbox") {
        let currentChoose = param.model.value.value;
        let retChoose = [];
        for (var i in param.model.items.value) {
          if (currentChoose.indexOf(param.model.items.value[i].value) !== -1) {
            retChoose.push(param.model.items.value[i].label);
          }
        }
        tmp.name = param.model.label.value;
        tmp.value = retChoose;
        this.propertyJson.push(tmp);
      } else {
        tmp.name = param.model.label.value;
        tmp.value.push(param.model.value.value);
        this.propertyJson.push(tmp);
      }
    },
    openLogModal(param) {
      this.$Modal.info({
        render: h => {
          return h(log, {
            props: {
              value: param
            },
            on: {
              value: value1 => {
                this.addParam = value1;
              }
            }
          });
        },
        width: 970
      });
    },
    checkPerm(permList) {
      return this.$_has("permissions", permList);
    },
    rowClick(data, index, event) {
      this.selectRowData = data;
    },
    openDeleteModal() {
      var that = this;
      if (!this.selectRowData) {
        this.$Modal.info({
          title: "提示",
          content: "请先选择一条数据!"
        });
      } else {
        // console.log(234432)
        //  console.log(this.selectRowData);
        //  console.log(typeof this.selectRowData);
        //var rowData = JSON.parse(this.selectRowData)
        //console.log(rowData);
        this.$Modal.confirm({
          title: "删除操作",
          content: "是否删除选中实例？",
          onOk: function() {
            let _this = this;

            //发送请求删除数据
            HTTP.deleteAppInstance(that.selectRowData.id)
              .then(res => {
                if (res.code == 0) {
                  this.$Message.success("删除成功");
                  //刷新
                  that.getAppInstanceList(that.selectRowData.appId);
                } else {
                  //出错
                  this.$Message.error(res.msg);
                }
              })
              .catch(err => {
                console.log(err);
                this.$Message.error(err);
              })
              .finally(() => {
                this.$Modal.remove();
              });

          }
        });
        //关闭框
            this.$nextTick(function() {
              console.log($('.ivu-modal-confirm-body-icon-confirm'))
              $(
                ".ivu-modal-confirm-body-icon-confirm"
              ).hide();
            });
      }
    }
  }
};
</script>
