/* Minification failed. Returning unminified contents.
(15260,32-48): run-time error JS5017: Syntax error in regular expression: /([^\d\+-\s])/ig
 */
/*!
 * jquery-confirm v2.0.0 (http://craftpip.github.io/jquery-confirm/)
 * Author: Boniface Pereira
 * Website: www.craftpip.com
 * Contact: hey@craftpip.com
 *
 * Copyright 2013-2015 jquery-confirm
 * Licensed under MIT (https://github.com/craftpip/jquery-confirm/blob/master/LICENSE)
 */
if (typeof jQuery === "undefined") { throw new Error("jquery-confirm requires jQuery") } var jconfirm, Jconfirm; (function (b) { b.fn.confirm = function (c) { if (typeof c === "undefined") { c = {} } var d = b(this); d.on("click", function (f) { f.preventDefault(); if (d.attr("href")) { c.confirm = function () { location.href = d.attr("href") } } b.confirm(c) }); return d }; b.confirm = function (c) { return jconfirm(c) }; b.alert = function (c) { c.cancelButton = false; return jconfirm(c) }; b.dialog = function (c) { c.cancelButton = false; c.confirmButton = false; c.confirmKeys = [13]; return jconfirm(c) }; jconfirm = function (c) { if (typeof c === "undefined") { c = {} } if (jconfirm.defaults) { b.extend(jconfirm.pluginDefaults, jconfirm.defaults) } var c = b.extend({}, jconfirm.pluginDefaults, c); return new Jconfirm(c) }; Jconfirm = function (c) { b.extend(this, c); this._init() }; Jconfirm.prototype = { _init: function () { var c = this; this._rand = Math.round(Math.random() * 99999); this._buildHTML(); this._bindEvents(); setTimeout(function () { c.open() }, 0) }, animations: ["anim-scale", "anim-top", "anim-bottom", "anim-left", "anim-right", "anim-zoom", "anim-opacity", "anim-none", "anim-rotate", "anim-rotatex", "anim-rotatey", "anim-scalex", "anim-scaley"], _buildHTML: function () { this.animation = "anim-" + this.animation.toLowerCase(); this.closeAnimation = "anim-" + this.closeAnimation.toLowerCase(); this.$el = b(this.template).appendTo(this.container).addClass(this.theme); this.$el.find(".jconfirm-box-container").addClass(this.columnClass); this.CSS = { "-webkit-transition-duration": this.animationSpeed / 1000 + "s", "transition-duration": this.animationSpeed / 1000 + "s", "-webkit-transition-timing-function": "cubic-bezier(.38,1.28,.2, " + this.animationBounce + ")", "transition-timing-function": "cubic-bezier(.38,1.28,.2, " + this.animationBounce + ")" }; this.$el.find(".jconfirm-bg").css(this.CSS); this.$b = this.$el.find(".jconfirm-box").css(this.CSS).addClass(this.animation); this.$body = this.$b; if (this.rtl) { this.$el.addClass("rtl") } this.$title = this.$el.find("div.title"); this.setTitle(); this.contentDiv = this.$el.find("div.content"); this.$content = this.contentDiv; this.$btnc = this.$el.find(".buttons"); if (this.confirmButton && this.confirmButton.trim() !== "") { this.$confirmButton = b('<button class="btn">' + this.confirmButton + "</button>").appendTo(this.$btnc).addClass(this.confirmButtonClass) } if (this.cancelButton && this.cancelButton.trim() !== "") { this.$cancelButton = b('<button class="btn">' + this.cancelButton + "</button>").appendTo(this.$btnc).addClass(this.cancelButtonClass) } if (!this.confirmButton && !this.cancelButton) { this.$btnc.remove() } if (!this.confirmButton && !this.cancelButton && this.closeIcon === null) { this.$closeButton = this.$b.find(".closeIcon").show() } if (this.closeIcon === true) { this.$closeButton = this.$b.find(".closeIcon").show() } this.setContent(); if (this.autoClose) { this._startCountDown() } }, setTitle: function (c) { this.title = (typeof c !== "undefined") ? c : this.title; if (this.title && this.$title) { this.$title.html('<i class="' + this.icon + '"></i> ' + this.title) } else { this.$title.remove() } }, setContent: function (e) { var f = this; this.content = (e) ? e : this.content; var c = (e) ? true : false; if (typeof this.content === "boolean") { if (!this.content) { this.contentDiv.remove() } else { console.error("Invalid option for property content: passed TRUE") } } else { if (typeof this.content === "string") { if (this.content.substr(0, 4).toLowerCase() === "url:") { this.contentDiv.html(""); this.$btnc.find("button").prop("disabled", true); var d = this.content.substring(4, this.content.length); b.get(d).done(function (h) { f.contentDiv.html(h) }).always(function (i, h, j) { if (typeof f.contentLoaded === "function") { f.contentLoaded(i, h, j) } f.$btnc.find("button").prop("disabled", false); f.setDialogCenter() }) } else { this.contentDiv.html(this.content) } } else { if (typeof this.content === "function") { this.contentDiv.html(""); this.$btnc.find("button").attr("disabled", "disabled"); var g = this.content(this); if (typeof g !== "object") { console.error("The content function must return jquery promise.") } else { if (typeof g.always !== "function") { console.error("The object returned is not a jquery promise.") } else { g.always(function (i, h) { f.$btnc.find("button").removeAttr("disabled"); f.setDialogCenter() }) } } } else { console.error("Invalid option for property content, passed: " + typeof this.content) } } } this.setDialogCenter(c) }, _startCountDown: function () { var c = this.autoClose.split("|"); if (/cancel/.test(c[0]) && this.type === "alert") { return false } else { if (/confirm|cancel/.test(c[0])) { this.$cd = b('<span class="countdown">').appendTo(this["$" + c[0] + "Button"]); var d = this; d.$cd.parent().click(); var e = c[1] / 1000; this.interval = setInterval(function () { d.$cd.html(" [" + (e -= 1) + "]"); if (e === 0) { d.$cd.parent().trigger("click"); clearInterval(d.interval) } }, 1000) } else { console.error("Invalid option " + c[0] + ", must be confirm/cancel") } } }, _bindEvents: function () { var d = this; var c = false; this.$el.find(".jconfirm-scrollpane").click(function (f) { if (!c) { if (d.backgroundDismiss) { d.cancel(); d.close() } else { d.$b.addClass("hilight"); setTimeout(function () { d.$b.removeClass("hilight") }, 400) } } c = false }); this.$el.find(".jconfirm-box").click(function (f) { c = true }); if (this.$confirmButton) { this.$confirmButton.click(function (g) { g.preventDefault(); var f = d.confirm(d.$b); d.onAction("confirm"); if (typeof f === "undefined" || f) { d.close() } }) } if (this.$cancelButton) { this.$cancelButton.click(function (g) { g.preventDefault(); var f = d.cancel(d.$b); d.onAction("cancel"); if (typeof f === "undefined" || f) { d.close() } }) } if (this.$closeButton) { this.$closeButton.click(function (f) { f.preventDefault(); d.cancel(); d.onAction("close"); d.close() }) } if (this.keyboardEnabled) { setTimeout(function () { b(window).on("keyup." + this._rand, function (f) { d.reactOnKey(f) }) }, 500) } b(window).on("resize." + this._rand, function () { d.setDialogCenter(true) }) }, reactOnKey: function a(f) { var c = b(".jconfirm"); if (c.eq(c.length - 1)[0] !== this.$el[0]) { return false } var d = f.which; if (this.contentDiv.find(":input").is(":focus") && /13|32/.test(d)) { return false } if (b.inArray(d, this.cancelKeys) !== -1) { if (!this.backgroundDismiss) { this.$el.find(".jconfirm-bg").click(); return false } if (this.$cancelButton) { this.$cancelButton.click() } else { this.close() } } if (b.inArray(d, this.confirmKeys) !== -1) { if (this.$confirmButton) { this.$confirmButton.click() } } }, setDialogCenter: function (d) { var h = b(window).height(); var g = this.$b.outerHeight(); var c = (h - g) / 2; var f = 100; if (g > (h - f)) { var e = { "margin-top": f / 2, "margin-bottom": f / 2 } } else { var e = { "margin-top": c } } if (d) { this.$b.animate(e, { duration: this.animationSpeed, queue: false }) } else { this.$b.css(e) } }, close: function () { var c = this; if (this.isClosed()) { return false } if (typeof this.onClose === "function") { this.onClose() } b(window).unbind("resize." + this._rand); if (this.keyboardEnabled) { b(window).unbind("keyup." + this._rand) } c.$el.find(".jconfirm-bg").removeClass("seen"); this.$b.addClass(this.closeAnimation); var d = (this.closeAnimation == "anim-none") ? 0 : this.animationSpeed; setTimeout(function () { c.$el.remove() }, d + 50); jconfirm.record.closed += 1; jconfirm.record.currentlyOpen -= 1; if (jconfirm.record.currentlyOpen < 1) { b("body").removeClass("jconfirm-noscroll") } return true }, open: function () { var d = this; if (this.isClosed()) { return false } d.$el.find(".jconfirm-bg").addClass("seen"); b("body").addClass("jconfirm-noscroll"); this.$b.removeClass(this.animations.join(" ")); this.$b.find("input[autofocus]:visible:first").focus(); jconfirm.record.opened += 1; jconfirm.record.currentlyOpen += 1; if (typeof this.onOpen === "function") { this.onOpen() } var c = "jconfirm-box" + this._rand; this.$b.attr("aria-labelledby", c).attr("tabindex", -1).focus(); if (this.$title) { this.$title.attr("id", c) } else { if (this.$content) { this.$content.attr("id", c) } } return true }, isClosed: function () { return this.$el.css("display") === "" } }; jconfirm.pluginDefaults = { template: '<div class="jconfirm"><div class="jconfirm-bg"></div><div class="jconfirm-scrollpane"><div class="container"><div class="row"><div class="jconfirm-box-container span6 offset3"><div class="jconfirm-box" role="dialog" aria-labelledby="labelled" tabindex="-1"><div class="closeIcon"><span class="glyphicon glyphicon-remove"></span></div><div class="title"></div><div class="content"></div><div class="buttons"></div><div class="jquery-clear"></div></div></div></div></div></div></div>', title: "Hello", content: "Are you sure to continue?", contentLoaded: function () { }, icon: "", confirmButton: "Okay", cancelButton: "Cancel", confirmButtonClass: "btn-default", cancelButtonClass: "btn-default", theme: "white", animation: "zoom", closeAnimation: "scale", animationSpeed: 500, animationBounce: 1.2, keyboardEnabled: false, rtl: false, confirmKeys: [13, 32], cancelKeys: [27], container: "body", confirm: function () { }, cancel: function () { }, backgroundDismiss: true, autoClose: false, closeIcon: null, columnClass: "col-md-4 col-md-offset-4", onOpen: function () { }, onClose: function () { }, onAction: function () { } }; jconfirm.record = { opened: 0, closed: 0, currentlyOpen: 0 } })(jQuery);;
/* NUGET: BEGIN LICENSE TEXT
 *
 * Microsoft grants you the right to use these script files for the sole
 * purpose of either: (i) interacting through your browser with the Microsoft
 * website or online service, subject to the applicable licensing or use
 * terms; or (ii) using the files as included with a Microsoft product subject
 * to that product's license terms. Microsoft reserves all other rights to the
 * files not expressly granted by Microsoft, whether by implication, estoppel
 * or otherwise. Insofar as a script file is dual licensed under GPL,
 * Microsoft neither took the code under GPL nor distributes it thereunder but
 * under the terms set out in this paragraph. All notices and licenses
 * below are for informational purposes only.
 *
 * NUGET: END LICENSE TEXT */

/**
* bootstrap.js v3.0.0 by @fat and @mdo
* Copyright 2013 Twitter Inc.
* http://www.apache.org/licenses/LICENSE-2.0
*/
/* =========================================================
 * bootstrap-datetimepicker.js
 * =========================================================
 * Copyright 2012 Stefan Petre
 *
 * Improvements by Andrew Rowls
 * Improvements by Sébastien Malot
 * Improvements by Yun Lai
 * Improvements by Kenneth Henderick
 * Improvements by CuGBabyBeaR
 * Improvements by Christian Vaas <auspex@auspex.eu>
 *
 * Project URL : http://www.malot.fr/bootstrap-datetimepicker
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================= */

import HTTP from "../../api/form.js"
import HTTP_INTERFACE from "@/api/interface.js"
import { Message, Modal, Spin } from "iview";
import axios from "axios";
import API from "../../api/work-flow.js"
import userApi from '../../api/user.js';
import organApi from '../../api/organ.js';
import assoModal from "./assoModal.vue"
// import "../form/sheetDesigner/page/design.vue"
import allAddress from './AllAddress.js';
import openModal from "./openModal.vue"
import addRelativeModal from './addRelativeModal';
import { debounce, throttle } from '@/util/utils.js';
import trigger from '@/util/trigger.js';
// import BScroll from 'better-scroll';
import cTablelistTable from "../listview/components/tablelist-query";
import '../form/lib/plugins/zTree/js/jquery.ztree.core.min.js';
import '../form/lib/plugins/zTree/js/jquery.ztree.excheck.min.js';
// import wangeditor from 'wangeditor'
import store from '@/store/index.js';
import './components/orgTree/libs/orgTree.js';
import './components/City/kuCity.js'
import './components/City/kuCity.css'
import { BASE_URL } from '@/api'

import "tui-editor/dist/tui-editor.css"
import "tui-editor/dist/tui-editor-contents.css"
import TEditor from "tui-editor"
import Vue from 'vue';

import '../../assets/editor/editormd.min.js'
import '../../assets/editor/css/editormd.min.css'

import { changeToDingDingUrl } from '@/util/utils.js'
import FormApprovalRecord from '@/component/controls/form-approval-record.vue'



import './components/quill/quill.js'
import './components/quill/quill.snow.css'





(function (factory) {
    if (typeof define === 'function' && define.amd)
        define(['jquery'], factory);
    else if (typeof exports === 'object')
        factory(require('jquery'));
    else
        factory(jQuery);
}(function ($, undefined) {
    // Add ECMA262-5 Array methods if not supported natively (IE8)
    if (!('indexOf' in Array.prototype)) {
        Array.prototype.indexOf = function (find, i) {
            if (i === undefined) i = 0;
            if (i < 0) i += this.length;
            if (i < 0) i = 0;
            for (var n = this.length; i < n; i++) {
                if (i in this && this[i] === find) {
                    return i;
                }
            }
            return -1;
        }
    }

    // Add timezone abbreviation support for ie6+, Chrome, Firefox
    function timeZoneAbbreviation() {
        var abbreviation, date, formattedStr, i, len, matchedStrings, ref, str;
        date = (new Date()).toString();
        formattedStr = ((ref = date.split('(')[1]) != null ? ref.slice(0, -1) : 0) || date.split(' ');
        if (formattedStr instanceof Array) {
            matchedStrings = [];
            for (var i = 0, len = formattedStr.length; i < len; i++) {
                str = formattedStr[i];
                if ((abbreviation = (ref = str.match(/\b[A-Z]+\b/)) !== null) ? ref[0] : 0) {
                    matchedStrings.push(abbreviation);
                }
            }
            formattedStr = matchedStrings.pop();
        }
        return formattedStr;
    }

    function UTCDate() {
        return new Date(Date.UTC.apply(Date, arguments));
    }

    // Picker object
    var Datetimepicker = function (element, options) {
        var that = this;
        this.element = $(element);
        // add container for single page application
        // when page switch the datetimepicker div will be removed also.
        this.container = options.container || "body";//$($(this.element).closest("body")[0]);

        this.language = /*options.language || this.element.data('date-language') ||*/ 'en';
        this.formatType = /*options.formatType || this.element.data('format-type') ||*/ 'standard';
        this.format = DPGlobal.parseFormat(options.format || this.element.data('date-format') || dates[this.language].format || DPGlobal.getDefaultFormat(this.formatType, 'input'), this.formatType);
        this.isInline = false;
        this.isVisible = false;
        this.isInput = this.element.is('input');

        this.component = this.element.is('.date') ? (/*this.bootcssVer === 3 ?*/ this.element.find('.input-group-addon .glyphicon-th, .input-group-addon .glyphicon-time, .input-group-addon .glyphicon-remove, .input-group-addon .glyphicon-calendar, .input-group-addon .fa-calendar, .input-group-addon .fa-clock-o').parent()/* : this.element.find('.add-on .icon-th, .add-on .icon-time, .add-on .icon-calendar, .add-on .fa-calendar, .add-on .fa-clock-o').parent()*/) : false;
        this.componentReset = this.element.is('.date') ? (/*this.bootcssVer === 3 ?*/ this.element.find('.input-group-addon .glyphicon-remove, .input-group-addon .fa-times').parent() /*: this.element.find('.add-on .icon-remove, .add-on .fa-times').parent()*/) : false;
        this.hasInput = this.component && this.element.find('input').length;
        if (this.component && this.component.length === 0) {
            this.component = false;
        }
        this.linkField = options.linkField || this.element.data('link-field') || false;
        this.linkFormat = DPGlobal.parseFormat(options.linkFormat || this.element.data('link-format') || DPGlobal.getDefaultFormat(this.formatType, 'link'), this.formatType);
        this.minuteStep = options.minuteStep || this.element.data('minute-step') || 5;
        this.pickerPosition = options.pickerPosition || this.element.data('picker-position') || 'bottom-right';
        this.showMeridian = options.showMeridian || this.element.data('show-meridian') || false;
        this.initialDate = options.initialDate || new Date();
        this.zIndex = options.zIndex || this.element.data('z-index') || undefined;
        this.title = typeof options.title === 'undefined' ? false : options.title;
        this.timezone = options.timezone || timeZoneAbbreviation();

        // 修正位置
        this.fixTop = 0;

        this._attachEvents();

        this.clickedOutside = function (e) {
            //日期控件下拉出现的情况下再次点击日期控件不会执行任何操作
            if (e.target == e.data.element[0]) {
                return;
            }
            // Clicked outside the datetimepicker, hide it
            if ($(e.target).closest('.datetimepicker').length === 0) {
                that.hide();
            }
        }

        this.formatViewType = 'datetime';
        if ('formatViewType' in options) {
            this.formatViewType = options.formatViewType;
        } else if ('formatViewType' in this.element.data()) {
            this.formatViewType = this.element.data('formatViewType');
        }

        this.minView = 0;
        if ('minView' in options) {
            this.minView = options.minView;
        } else if ('minView' in this.element.data()) {
            this.minView = this.element.data('min-view');
        }
        this.minView = DPGlobal.convertViewMode(this.minView);

        this.maxView = DPGlobal.modes.length - 1;
        if ('maxView' in options) {
            this.maxView = options.maxView;
        } else if ('maxView' in this.element.data()) {
            this.maxView = this.element.data('max-view');
        }
        this.maxView = DPGlobal.convertViewMode(this.maxView);

        this.wheelViewModeNavigation = false;

        this.wheelViewModeNavigationInverseDirection = false;


        this.startViewMode = 2;
        if ('startView' in options) {
            this.startViewMode = options.startView;
        } else if ('startView' in this.element.data()) {
            this.startViewMode = this.element.data('start-view');
        }
        this.startViewMode = DPGlobal.convertViewMode(this.startViewMode);
        //如果只是显示时间则要修改打开视图位选择时间的
        if (this.format.parts.length == 3 || this.format.parts.length == 2) {
            var partArr = this.format.parts;
            if (partArr[0] == 'hh' && partArr[1] == 'ii') {
                this.startViewMode = 1;
            }
        }
        this.viewMode = this.startViewMode;

        this.viewSelect = this.minView;
        if ('viewSelect' in options) {
            this.viewSelect = options.viewSelect;
        } else if ('viewSelect' in this.element.data()) {
            this.viewSelect = this.element.data('view-select');
        }
        this.viewSelect = DPGlobal.convertViewMode(this.viewSelect);

        this.forceParse = true;
        if ('forceParse' in options) {
            this.forceParse = options.forceParse;
        } else if ('dateForceParse' in this.element.data()) {
            this.forceParse = this.element.data('date-force-parse');
        }
        var template = DPGlobal.templateV3;
        //根据日期类型处理view
        var $tmp = $(template);
        if (this.startViewMode == 1) {
            //var $tmp = $(template).find('div.datetimepicker-hours span.back').remove();
            //template = $tmp[0].outerHTML;
            //$tmp.find('div.datetimepicker-hours').remove();
        }
        if (!this.picker) {
            this.picker = $tmp
                .appendTo(this.isInline ? this.element : this.container) // 'body')
                .on({
                    click: $.proxy(this.click, this),
                    mousedown: $.proxy(this.mousedown, this)
                });
            if (this.picker["1"]) {
                delete this.picker["1"];
            }
            if (this.picker["2"]) {
                delete this.picker["2"];
            }
            this.picker.length = 1;
        }

        if (this.isInline) {
            this.picker.addClass('datetimepicker-inline');
        } else {
            this.picker.addClass('datetimepicker-dropdown-' + this.pickerPosition + ' dropdown-menu');
        }

        $(document).on('mousedown touchend', this, this.clickedOutside);

        this.autoclose = true;//点击后自动关闭
        if ('autoclose' in options) {
            this.autoclose = options.autoclose;
        } else if ('dateAutoclose' in this.element.data()) {
            this.autoclose = this.element.data('date-autoclose');
        }

        this.keyboardNavigation = true;
        if ('keyboardNavigation' in options) {
            this.keyboardNavigation = options.keyboardNavigation;
        } else if ('dateKeyboardNavigation' in this.element.data()) {
            this.keyboardNavigation = this.element.data('date-keyboard-navigation');
        }

        this.todayBtn = true;
        this.clearBtn = true;
        this.todayHighlight = false;

        this.weekStart = 0;
        if (typeof options.weekStart !== 'undefined') {
            this.weekStart = options.weekStart;
        } else if (typeof this.element.data('date-weekstart') !== 'undefined') {
            this.weekStart = this.element.data('date-weekstart');
        } else if (typeof dates[this.language].weekStart !== 'undefined') {
            this.weekStart = dates[this.language].weekStart;
        }
        this.weekStart = this.weekStart % 7;
        this.weekEnd = ((this.weekStart + 6) % 7);
        this.onRenderDay = function (date) {
            var render = (options.onRenderDay || function () { return []; })(date);
            if (typeof render === 'string') {
                render = [render];
            }
            var res = ['day'];
            return res.concat((render ? render : []));
        };
        this.onRenderHour = function (date) {
            var render = (options.onRenderHour || function () { return []; })(date);
            var res = ['hour'];
            if (typeof render === 'string') {
                render = [render];
            }
            return res.concat((render ? render : []));
        };
        this.onRenderMinute = function (date) {
            var render = (options.onRenderMinute || function () { return []; })(date);
            var res = ['minute'];
            if (typeof render === 'string') {
                render = [render];
            }
            if (date < this.startDate || date > this.endDate) {
                res.push('disabled');
            } else if (Math.floor(this.date.getUTCMinutes() / this.minuteStep) === Math.floor(date.getUTCMinutes() / this.minuteStep)) {
                res.push('active');
            }
            return res.concat((render ? render : []));
        };
        this.onRenderYear = function (date) {
            var render = (options.onRenderYear || function () { return []; })(date);
            var res = ['year'];
            if (typeof render === 'string') {
                render = [render];
            }
            if (this.date.getUTCFullYear() === date.getUTCFullYear()) {
                res.push('active');
            }
            var currentYear = date.getUTCFullYear();
            var endYear = this.endDate.getUTCFullYear();
            if (date < this.startDate || currentYear > endYear) {
                res.push('disabled');
            }
            return res.concat((render ? render : []));
        }
        this.onRenderMonth = function (date) {
            var render = (options.onRenderMonth || function () { return []; })(date);
            var res = ['month'];
            if (typeof render === 'string') {
                render = [render];
            }
            return res.concat((render ? render : []));
        }
        this.startDate = new Date(-8639968443048000);
        this.endDate = new Date(8639968443048000);
        this.datesDisabled = [];
        this.daysOfWeekDisabled = [];
        this.setStartDate(options.startDate || this.element.data('date-startdate'));
        this.setEndDate(options.endDate || this.element.data('date-enddate'));
        this.setDatesDisabled(options.datesDisabled || this.element.data('date-dates-disabled'));
        this.setDaysOfWeekDisabled(options.daysOfWeekDisabled || this.element.data('date-days-of-week-disabled'));
        this.setMinutesDisabled(options.minutesDisabled || this.element.data('date-minute-disabled'));
        this.setHoursDisabled(options.hoursDisabled || this.element.data('date-hour-disabled'));
        this.fillDow();
        this.fillMonths();
        this.update();
        this.showMode();

        if (this.isInline) {
            this.show();
        }
    };

    Datetimepicker.prototype = {
        constructor: Datetimepicker,

        _events: [],
        _attachEvents: function () {
            this._detachEvents();
            if (this.isInput) { // single input
                this._events = [
                    [this.element, {
                        focus: $.proxy(this.show, this),
                        keyup: $.proxy(this.update, this),
                        keydown: $.proxy(this.keydown, this)
                    }]
                ];
            }
            else if (this.component && this.hasInput) { // component: input + button
                this._events = [
                    // For components that are not readonly, allow keyboard nav
                    [this.element.find('input'), {
                        focus: $.proxy(this.show, this),
                        keyup: $.proxy(this.update, this),
                        keydown: $.proxy(this.keydown, this)
                    }],
                    [this.component, {
                        click: $.proxy(this.show, this)
                    }]
                ];
                if (this.componentReset) {
                    this._events.push([
                        this.componentReset,
                        { click: $.proxy(this.reset, this) }
                    ]);
                }
            }
            else if (this.element.is('div')) {  // inline datetimepicker
                this.isInline = true;
            }
            else {
                this._events = [
                    [this.element, {
                        click: $.proxy(this.show, this)
                    }]
                ];
            }
            for (var i = 0, el, ev; i < this._events.length; i++) {
                el = this._events[i][0];
                ev = this._events[i][1];
                el.on(ev);
            }
        },

        _detachEvents: function () {
            for (var i = 0, el, ev; i < this._events.length; i++) {
                el = this._events[i][0];
                ev = this._events[i][1];
                el.off(ev);
            }
            this._events = [];
        },

        show: function (e) {
            //先隐藏其他的日期控件
            $(".datetimepicker").hide();
            this.picker.show();
            this.height = this.component ? this.component.outerHeight() : this.element.outerHeight();
            if (this.forceParse) {
                this.update();
            }
            this.place();
            $(window).on('resize', $.proxy(this.place, this));

            //绑定滚动事件
            var that = this;
            this.element.parents().each(function (index, obj) {
                $(obj).scroll(function () {
                    that.place();
                });
            })


            if (e) {
                e.stopPropagation();
                e.preventDefault();
            }
            this.isVisible = true;
            this.element.trigger({
                type: 'show',
                date: this.date
            });
        },

        hide: function () {
            if (!this.isVisible) return;
            if (this.isInline) return;
            this.picker.hide();
            $(window).off('resize', this.place);
            this.viewMode = this.startViewMode;
            this.showMode();
            if (!this.isInput) {
                $(document).off('mousedown', this.hide);
            }

            if (
                this.forceParse &&
                (
                    this.isInput && this.element.val() ||
                    this.hasInput && this.element.find('input').val()
                )
            )
                this.setValue();
            this.isVisible = false;
            this.element.trigger({
                type: 'hide',
                date: this.date
            });
        },

        remove: function () {
            this._detachEvents();
            $(document).off('mousedown', this.clickedOutside);
            this.picker.remove();
            delete this.picker;
            delete this.element.data().datetimepicker;
        },

        getDate: function () {
            var d = this.getUTCDate();
            //if (d === null) {
            //    return null;
            //}
            if (d == null) {
                //return null;
                return new Date();
            }
            return new Date(d.getTime() + (d.getTimezoneOffset() * 60000));
        },

        getUTCDate: function () {
            return this.date;
        },

        getInitialDate: function () {
            return this.initialDate
        },

        setInitialDate: function (initialDate) {
            this.initialDate = initialDate;
        },

        setDate: function (d) {
            this.setUTCDate(new Date(d.getTime() - (d.getTimezoneOffset() * 60000)));
        },

        setUTCDate: function (d) {
            if (d >= this.startDate && d <= this.endDate) {
                this.date = d;
                this.setValue();
                this.viewDate = this.date;
                this.fill();
            } else {
                this.element.trigger({
                    type: 'outOfRange',
                    date: d,
                    startDate: this.startDate,
                    endDate: this.endDate
                });
            }
        },

        setFormat: function (format) {
            this.format = DPGlobal.parseFormat(format, this.formatType);
            var element;
            if (this.isInput) {
                element = this.element;
            } else if (this.component) {
                element = this.element.find('input');
            }
            if (element && element.val()) {
                this.setValue();
            }
        },

        setValue: function () {
            var formatted = this.getFormattedDate();
            if (!this.isInput) {
                if (this.component) {
                    this.element.find('input').val(formatted);
                }
                this.element.data('date', formatted);
            } else {
                this.element.val(formatted);
            }
            if (this.linkField) {
                $('#' + this.linkField).val(this.getFormattedDate(this.linkFormat));
            }
        },

        getFormattedDate: function (format) {
            format = format || this.format;
            return DPGlobal.formatDate(this.date, format, this.language, this.formatType, this.timezone);
        },

        setStartDate: function (startDate) {
            this.startDate = startDate || this.startDate;
            if (this.startDate.valueOf() !== 8639968443048000) {
                this.startDate = DPGlobal.parseDate(this.startDate, this.format, this.language, this.formatType, this.timezone);
            }
            this.update();
            this.updateNavArrows();
        },

        setEndDate: function (endDate) {
            this.endDate = endDate || this.endDate;
            if (this.endDate.valueOf() !== 8639968443048000) {
                this.endDate = DPGlobal.parseDate(this.endDate, this.format, this.language, this.formatType, this.timezone);
            }
            this.update();
            this.updateNavArrows();
        },

        setDatesDisabled: function (datesDisabled) {
            this.datesDisabled = datesDisabled || [];
            if (!$.isArray(this.datesDisabled)) {
                this.datesDisabled = this.datesDisabled.split(/,\s*/);
            }
            var mThis = this;
            this.datesDisabled = $.map(this.datesDisabled, function (d) {
                return DPGlobal.parseDate(d, mThis.format, mThis.language, mThis.formatType, mThis.timezone).toDateString();
            });
            this.update();
            this.updateNavArrows();
        },

        setTitle: function (selector, value) {
            return this.picker.find(selector)
                .find('th:eq(2)')
                .text(this.title === false ? value : this.title);
        },

        setDaysOfWeekDisabled: function (daysOfWeekDisabled) {
            this.daysOfWeekDisabled = daysOfWeekDisabled || [];
            if (!$.isArray(this.daysOfWeekDisabled)) {
                this.daysOfWeekDisabled = this.daysOfWeekDisabled.split(/,\s*/);
            }
            this.daysOfWeekDisabled = $.map(this.daysOfWeekDisabled, function (d) {
                return parseInt(d, 10);
            });
            this.update();
            this.updateNavArrows();
        },

        setMinutesDisabled: function (minutesDisabled) {
            this.minutesDisabled = minutesDisabled || [];
            if (!$.isArray(this.minutesDisabled)) {
                this.minutesDisabled = this.minutesDisabled.split(/,\s*/);
            }
            this.minutesDisabled = $.map(this.minutesDisabled, function (d) {
                return parseInt(d, 10);
            });
            this.update();
            this.updateNavArrows();
        },

        setHoursDisabled: function (hoursDisabled) {
            this.hoursDisabled = hoursDisabled || [];
            if (!$.isArray(this.hoursDisabled)) {
                this.hoursDisabled = this.hoursDisabled.split(/,\s*/);
            }
            this.hoursDisabled = $.map(this.hoursDisabled, function (d) {
                return parseInt(d, 10);
            });
            this.update();
            this.updateNavArrows();
        },

        place: function () {
            if (this.isInline) return;

            if (!this.zIndex) {
                var index_highest = 0;
                $('div').each(function () {
                    var index_current = parseInt($(this).css('zIndex'), 10);
                    if (index_current > index_highest) {
                        index_highest = index_current;
                    }
                });
                this.zIndex = index_highest + 10;
            }

            var offset, top, left, containerOffset;
            if (this.container instanceof $) {
                containerOffset = this.container.offset();
            } else {
                containerOffset = $(this.container).offset();
            }
            if (this.component) {
                offset = this.component.offset();
                left = offset.left;
                if (this.pickerPosition === 'bottom-left' || this.pickerPosition === 'top-left') {
                    left += this.component.outerWidth() - this.picker.outerWidth();
                }
            } else {
                offset = this.element.offset();
                left = offset.left;
                if (this.pickerPosition === 'bottom-left' || this.pickerPosition === 'top-left') {
                    left += this.element.outerWidth() - this.picker.outerWidth();
                }
            }

            var bodyWidth = document.body.clientWidth || window.innerWidth;
            if (left + 220 > bodyWidth) {
                left = bodyWidth - 220;
            }

            if (this.pickerPosition === 'top-left' || this.pickerPosition === 'top-right') {
                top = offset.top - this.picker.outerHeight();
            } else {
                top = offset.top + (this.height ? this.height : 0);
            }

            top = top - containerOffset.top + this.fixTop;
            left = left - containerOffset.left;
            this.picker.css({
                top: top,
                left: left,
                zIndex: this.zIndex
            });
        },

        hour_minute: "^([0-9]|0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]",

        update: function () {
            var date, fromArgs = false;
            if (arguments && arguments.length && (typeof arguments[0] === 'string' || arguments[0] instanceof Date)) {
                date = arguments[0];
                fromArgs = true;
            } else {
                date = (this.isInput ? this.element.val() : this.element.find('input').val()) || this.element.data('date') || this.initialDate;
                if (typeof date === 'string') {
                    date = date.replace(/^\s+|\s+$/g, '');
                }
            }

            if (!date) {
                date = new Date();
                fromArgs = false;
            }

            if (typeof date === "string") {
                if (new RegExp(this.hour_minute).test(date) || new RegExp(this.hour_minute + ":[0-5][0-9]").test(date)) {
                    var flag = false;
                    var partArr = this.format.parts;
                    if (partArr.length == 2 || partArr.length == 3) {
                        if (partArr[0].toLowerCase() == 'hh' && partArr[1].toLowerCase() == 'ii') {
                            flag = true;
                            var tmp = date.split(':');
                            var now = new Date();
                            date = new Date(now.getFullYear(), now.getMonth(), now.getDate(), tmp[0], tmp[1], 0);
                        }
                    }
                    if (!flag)
                        date = this.getDate()
                }
            }

            this.date = DPGlobal.parseDate(date, this.format, this.language, this.formatType, this.timezone);

            if (fromArgs) this.setValue();

            if (this.date < this.startDate) {
                this.viewDate = new Date(this.startDate);
            } else if (this.date > this.endDate) {
                this.viewDate = new Date(this.endDate);
            } else {
                this.viewDate = new Date(this.date);
            }
            this.fill();
        },

        //渲染顶部星期
        fillDow: function () {
            var dowCnt = this.weekStart,
                html = '<tr class="weekdays">';
            while (dowCnt < this.weekStart + 7) {
                html += '<th class="dow">' + dates[this.language].daysMin[(dowCnt++) % 7] + '</th>';
            }
            html += '</tr>';
            html += '<tr>';
            for (var i = 0; i < 7; i++) {
                html += '<th></th>';
            }
            html += '</tr>';
            this.picker.find('.datetimepicker-days thead').append(html);
        },
        //渲染月
        fillMonths: function () {
            var html = '';
            var d = new Date(this.viewDate);
            for (var i = 0; i < 12; i++) {
                d.setUTCMonth(i);
                var classes = this.onRenderMonth(d);
                html += '<span class="' + classes.join(' ') + '">' + dates[this.language].monthsShort[i] + '</span>';
            }
            this.picker.find('.datetimepicker-months td').html(html);
        },
        //填充日期
        fill: function () {
            if (!this.date || !this.viewDate) {
                return;
            }
            var d = new Date(this.viewDate),
                year = d.getUTCFullYear(),
                month = d.getUTCMonth(),
                dayMonth = d.getUTCDate(),
                hours = d.getUTCHours(),
                startYear = this.startDate.getUTCFullYear(),
                startMonth = this.startDate.getUTCMonth(),
                endYear = this.endDate.getUTCFullYear(),
                endMonth = this.endDate.getUTCMonth() + 1,
                currentDate = (new UTCDate(this.date.getUTCFullYear(), this.date.getUTCMonth(), this.date.getUTCDate())).valueOf(),
                today = new Date();
            this.setTitle('.datetimepicker-days', year + '年' + dates[this.language].months[month]);
            if (this.formatViewType === 'time') {
                var formatted = this.getFormattedDate();
                this.setTitle('.datetimepicker-hours', formatted);
                this.setTitle('.datetimepicker-minutes', formatted);
            } else {
                if (this.startViewMode == 1) {
                    //如果是hh:ii不要显示时间
                    this.picker.find('div.datetimepicker-hours thead>tr>th,div.datetimepicker-minutes thead>tr>th').empty().css({ 'height': '10px', 'padding': 0 });
                } else {
                    this.setTitle('.datetimepicker-hours', year + '年' + dates[this.language].months[month] + dayMonth + '日');
                    this.setTitle('.datetimepicker-minutes', year + '年' + dates[this.language].months[month] + dayMonth + '日');
                }
            }
            this.picker.find('tfoot th.today').text(dates[this.language].today || dates['en'].today).toggle(this.todayBtn !== false);
            this.picker.find('tfoot th.clear').text(dates[this.language].clear || dates['en'].clear).toggle(this.clearBtn !== false);
            this.updateNavArrows();
            this.fillMonths();
            var prevMonth = UTCDate(year, month - 1, 28, 0, 0, 0, 0),
                day = DPGlobal.getDaysInMonth(prevMonth.getUTCFullYear(), prevMonth.getUTCMonth());
            prevMonth.setUTCDate(day);
            prevMonth.setUTCDate(day - (prevMonth.getUTCDay() - this.weekStart + 7) % 7);
            var nextMonth = new Date(prevMonth);
            nextMonth.setUTCDate(nextMonth.getUTCDate() + 42);
            nextMonth = nextMonth.valueOf();
            var html = [];
            var classes;
            while (prevMonth.valueOf() < nextMonth) {
                if (prevMonth.getUTCDay() === this.weekStart) {
                    html.push('<tr>');
                }
                classes = this.onRenderDay(prevMonth);
                if (prevMonth.getUTCFullYear() < year || (prevMonth.getUTCFullYear() === year && prevMonth.getUTCMonth() < month)) {
                    classes.push('old');
                } else if (prevMonth.getUTCFullYear() > year || (prevMonth.getUTCFullYear() === year && prevMonth.getUTCMonth() > month)) {
                    classes.push('new');
                }
                // Compare internal UTC date with local today, not UTC today
                if (this.todayHighlight &&
                    prevMonth.getUTCFullYear() === today.getFullYear() &&
                    prevMonth.getUTCMonth() === today.getMonth() &&
                    prevMonth.getUTCDate() === today.getDate()) {
                    classes.push('today');
                }
                if (prevMonth.valueOf() === currentDate) {
                    classes.push('active');
                }
                if ((prevMonth.valueOf() + 86400000) <= this.startDate || prevMonth.valueOf() > this.endDate ||
                    $.inArray(prevMonth.getUTCDay(), this.daysOfWeekDisabled) !== -1 ||
                    $.inArray(prevMonth.toDateString(), this.datesDisabled) !== -1) {
                    classes.push('disabled');
                }

                html.push('<td class="' + classes.join(' ') + '"><i>' + prevMonth.getUTCDate() + '</i></td>');
                if (prevMonth.getUTCDay() === this.weekEnd) {
                    html.push('</tr>');
                }

                prevMonth.setUTCDate(prevMonth.getUTCDate() + 1);
            }
            html.push('<tr class="day-below"><td colspan="7"></td></tr>');
            this.picker.find('.datetimepicker-days tbody').empty().append(html.join(''));

            html = [];
            var txt = '', meridian = '', meridianOld = '';
            var hoursDisabled = this.hoursDisabled || [];
            d = new Date(this.viewDate)
            for (var i = 0; i < 24; i++) {
                d.setUTCHours(i);
                classes = this.onRenderHour(d);
                if (hoursDisabled.indexOf(i) !== -1) {
                    classes.push('disabled');
                }
                var actual = UTCDate(year, month, dayMonth, i);
                // We want the previous hour for the startDate
                if ((actual.valueOf() + 3600000) <= this.startDate || actual.valueOf() > this.endDate) {
                    classes.push('disabled');
                } else if (hours === i) {
                    classes.push('active');
                }
                if (this.showMeridian && dates[this.language].meridiem.length === 2) {
                    meridian = (i < 12 ? dates[this.language].meridiem[0] : dates[this.language].meridiem[1]);
                    if (meridian !== meridianOld) {
                        if (meridianOld !== '') {
                            html.push('</fieldset>');
                        }
                        html.push('<fieldset class="hour"><legend>' + meridian.toUpperCase() + '</legend>');
                    }
                    meridianOld = meridian;
                    txt = (i % 12 ? i % 12 : 12);
                    if (i < 12) {
                        classes.push('hour_am');
                    } else {
                        classes.push('hour_pm');
                    }
                    html.push('<span class="' + classes.join(' ') + '">' + txt + '</span>');
                    if (i === 23) {
                        html.push('</fieldset>');
                    }
                } else {
                    txt = i + ':00';
                    html.push('<span class="' + classes.join(' ') + '">' + txt + '</span>');
                }
            }
            if (this.startViewMode == 1) {//时间模式
                html.push('<span class="no-title-hour-below"></span>');
                //时间模式要调整底部button居中
                this.picker.find('.datetimepicker-hours span.now').addClass('no-title-now');
                this.picker.find('.datetimepicker-hours span.clear').addClass('no-title-clear');

            } else {//日期模式
                html.push('<span class="hour-below"></span>');
                this.picker.find('.datetimepicker-hours span.now').removeClass('no-title-now');
                this.picker.find('.datetimepicker-hours span.clear').removeClass('no-title-clear');
            }
            //html.push('<span class="hour-below"></>');
            this.picker.find('.datetimepicker-hours td').html(html.join(''));

            html = [];
            txt = '';
            meridian = '';
            meridianOld = '';
            var minutesDisabled = this.minutesDisabled || [];
            d = new Date(this.viewDate);
            for (var i = 0; i < 60; i += this.minuteStep) {
                if (minutesDisabled.indexOf(i) !== -1) continue;
                d.setUTCMinutes(i);
                d.setUTCSeconds(0);
                classes = this.onRenderMinute(d);
                if (this.showMeridian && dates[this.language].meridiem.length === 2) {
                    meridian = (hours < 12 ? dates[this.language].meridiem[0] : dates[this.language].meridiem[1]);
                    if (meridian !== meridianOld) {
                        if (meridianOld !== '') {
                            html.push('</fieldset>');
                        }
                        html.push('<fieldset class="minute"><legend>' + meridian.toUpperCase() + '</legend>');
                    }
                    meridianOld = meridian;
                    txt = (hours % 12 ? hours % 12 : 12);
                    html.push('<span class="' + classes.join(' ') + '">' + txt + ':' + (i < 10 ? '0' + i : i) + '</span>');
                    if (i === 59) {
                        html.push('</fieldset>');
                    }
                } else {
                    txt = i + ':00';
                    html.push('<span class="' + classes.join(' ') + '">' + hours + ':' + (i < 10 ? '0' + i : i) + '</span>');
                }
            }
            if (this.startViewMode == 1) {
                html.push('<span class="no-title-minute-below"></span>');
            } else {
                html.push('<span class="minute-below"></span>');
            }
            this.picker.find('.datetimepicker-minutes td').html(html.join(''));

            var currentYear = this.date.getUTCFullYear();
            var months = this.setTitle('.datetimepicker-months', year)
                .end()
                .find('.month').removeClass('active');
            if (currentYear === year) {
                // getUTCMonths() returns 0 based, and we need to select the next one
                // To cater bootstrap 2 we don't need to select the next one
                months.eq(this.date.getUTCMonth()).addClass('active');
            }
            if (year < startYear || year > endYear) {
                months.addClass('disabled');
            }
            if (year === startYear) {
                months.slice(0, startMonth).addClass('disabled');
            }
            if (year === endYear) {
                months.slice(endMonth).addClass('disabled');
            }

            html = '';
            year = parseInt(year / 10, 10) * 10;
            var yearCont = this.setTitle('.datetimepicker-years', year + '-' + (year + 9))
                .end()
                .find('td');
            year -= 1;
            d = new Date(this.viewDate);
            for (var i = -1; i < 11; i++) {
                d.setUTCFullYear(year);
                classes = this.onRenderYear(d);
                if (i === -1 || i === 10) {
                    classes.push(old);
                }
                html += '<span class="' + classes.join(' ') + '">' + year + '</span>';
                year += 1;
            }
            yearCont.html(html);
            this.place();
        },

        updateNavArrows: function () {
            var d = new Date(this.viewDate),
                year = d.getUTCFullYear(),
                month = d.getUTCMonth(),
                day = d.getUTCDate(),
                hour = d.getUTCHours();
            switch (this.viewMode) {
                case 0:
                //if (year <= this.startDate.getUTCFullYear()
                //  && month <= this.startDate.getUTCMonth()
                //  && day <= this.startDate.getUTCDate()
                //  && hour <= this.startDate.getUTCHours()) {
                //    this.picker.find('.prev').css({ visibility: 'hidden' });
                //    this.picker.find('.prevYear').css({ visibility: 'hidden' });
                //} else {
                //    this.picker.find('.prev').css({ visibility: 'visible' });
                //    this.picker.find('.prevYear').css({ visibility: 'visible' });
                //}
                //if (year >= this.endDate.getUTCFullYear()
                //  && month >= this.endDate.getUTCMonth()
                //  && day >= this.endDate.getUTCDate()
                //  && hour >= this.endDate.getUTCHours()) {
                //    this.picker.find('.next').css({ visibility: 'hidden' });
                //    this.picker.find('.nextYear').css({ visibility: 'hidden' });
                //} else {
                //    this.picker.find('.next').css({ visibility: 'visible' });
                //    this.picker.find('.nextYear').css({ visibility: 'visible' });
                //}
                //break;
                case 1:
                    //if (year <= this.startDate.getUTCFullYear()
                    //  && month <= this.startDate.getUTCMonth()
                    //  && day <= this.startDate.getUTCDate()) {
                    //    this.picker.find('.prev').css({ visibility: 'hidden' });
                    //    this.picker.find('.prevYear').css({ visibility: 'hidden' });
                    //} else {
                    //    this.picker.find('.prev').css({ visibility: 'visible' });
                    //    this.picker.find('.prevYear').css({ visibility: 'visible' });
                    //}
                    //if (year >= this.endDate.getUTCFullYear()
                    //  && month >= this.endDate.getUTCMonth()
                    //  && day >= this.endDate.getUTCDate()) {
                    //    this.picker.find('.next').css({ visibility: 'hidden' });
                    //    this.picker.find('.nextYear').css({ visibility: 'hidden' });
                    //} else {
                    //    this.picker.find('.next').css({ visibility: 'visible' });
                    //    this.picker.find('.nextYear').css({ visibility: 'visible' });
                    //}
                    this.picker.find('.prev').css({ visibility: 'hidden' });
                    this.picker.find('.prevYear').css({ visibility: 'hidden' });
                    this.picker.find('.next').css({ visibility: 'hidden' });
                    this.picker.find('.nextYear').css({ visibility: 'hidden' });
                    break;
                case 2:
                    if (year <= this.startDate.getUTCFullYear()
                        && month <= this.startDate.getUTCMonth()) {
                        this.picker.find('.prev').css({ visibility: 'hidden' });
                        this.picker.find('.prevYear').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.prev').css({ visibility: 'visible' });
                        this.picker.find('.prevYear').css({ visibility: 'visible' });
                    }
                    if (year >= this.endDate.getUTCFullYear()
                        && month >= this.endDate.getUTCMonth()) {
                        this.picker.find('.next').css({ visibility: 'hidden' });
                        this.picker.find('.nextYear').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.next').css({ visibility: 'visible' });
                        this.picker.find('.nextYear').css({ visibility: 'visible' });
                    }
                    break;
                case 3:
                case 4:
                    if (year <= this.startDate.getUTCFullYear()) {
                        this.picker.find('.prev').css({ visibility: 'hidden' });
                        this.picker.find('.prevYear').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.prev').css({ visibility: 'visible' });
                        this.picker.find('.prevYear').css({ visibility: 'visible' });
                    }
                    if (year >= this.endDate.getUTCFullYear()) {
                        this.picker.find('.next').css({ visibility: 'hidden' });
                        this.picker.find('.nextYear').css({ visibility: 'hidden' });
                    } else {
                        this.picker.find('.next').css({ visibility: 'visible' });
                        this.picker.find('.nextYear').css({ visibility: 'visible' });
                    }
                    break;
            }
        },


        click: function (e) {
            e.stopPropagation();
            e.preventDefault();
            var target = $(e.target).closest('span, td, th, legend');
            if (target.is('.' + this.icontype)) {
                target = $(target).parent().closest('span, td, th, legend');
            }
            if (target.length === 1) {
                if (target.is('.disabled')) {
                    this.element.trigger({
                        type: 'outOfRange',
                        date: this.viewDate,
                        startDate: this.startDate,
                        endDate: this.endDate
                    });
                    return;
                }
                switch (target[0].nodeName.toLowerCase()) {
                    case 'th':
                        switch (target[0].className) {
                            case 'switch':
                                this.showMode(1);
                                break;
                            case 'prevYear':
                            case 'nextYear':
                                var dir = DPGlobal.modes[this.viewMode].navStep * (target[0].className === 'prevYear' ? -1 : 1);
                                switch (this.viewMode) {
                                    case 0:
                                        this.viewDate = this.moveHour(this.viewDate, dir);
                                        break;
                                    case 1:
                                        this.viewDate = this.moveDate(this.viewDate, dir);
                                        break;
                                    case 2:
                                        this.viewDate = this.moveYear(this.viewDate, dir);
                                        break;
                                    case 3:
                                    case 4:
                                        this.viewDate = this.moveYear(this.viewDate, dir);
                                        break;
                                    default:
                                        break;
                                }
                                this.fill();
                                this.element.trigger({
                                    type: target[0].className + ':' + this.convertViewModeText(this.viewMode),
                                    date: this.viewDate,
                                    startDate: this.startDate,
                                    endDate: this.endDate
                                });
                                break;
                            case 'prev':
                            case 'next':
                                var dir = DPGlobal.modes[this.viewMode].navStep * (target[0].className === 'prev' ? -1 : 1);
                                switch (this.viewMode) {
                                    case 0:
                                        this.viewDate = this.moveHour(this.viewDate, dir);
                                        break;
                                    case 1:
                                        this.viewDate = this.moveDate(this.viewDate, dir);
                                        break;
                                    case 2:
                                        this.viewDate = this.moveMonth(this.viewDate, dir);
                                        break;
                                    case 3:
                                    case 4:
                                        this.viewDate = this.moveYear(this.viewDate, dir);
                                        break;
                                }
                                this.fill();
                                this.element.trigger({
                                    type: target[0].className + ':' + this.convertViewModeText(this.viewMode),
                                    date: this.viewDate,
                                    startDate: this.startDate,
                                    endDate: this.endDate
                                });
                                break;
                            case 'clear':
                                this.reset();
                                if (this.autoclose) {
                                    this.hide();
                                }
                                break;
                            case 'today':
                                var date = new Date();
                                date = UTCDate(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds(), 0);

                                // Respect startDate and endDate.
                                if (date < this.startDate) date = this.startDate;
                                else if (date > this.endDate) date = this.endDate;

                                this.viewMode = this.startViewMode;
                                this.showMode(0);
                                this._setDate(date);
                                this.fill();
                                if (this.autoclose) {
                                    this.hide();
                                }
                                break;
                        }
                        break;
                    case 'span':
                        if (!target.is('.disabled')) {
                            var year = this.viewDate.getUTCFullYear(),
                                month = this.viewDate.getUTCMonth(),
                                day = this.viewDate.getUTCDate(),
                                hours = this.viewDate.getUTCHours(),
                                minutes = this.viewDate.getUTCMinutes(),
                                seconds = this.viewDate.getUTCSeconds();
                            if (target.is('.clear')) {
                                this.reset();
                                if (this.autoclose) {
                                    this.hide();
                                }
                                break;
                            } else if (target.is('.back')) {
                                this.showMode(1);
                                break;
                            } else if (target.is('.now')) {
                                var date = new Date();
                                date = UTCDate(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds(), 0);
                                if (date < this.startDate) date = this.startDate;
                                else if (date > this.endDate) date = this.endDate;

                                this.viewMode = this.startViewMode;
                                this.showMode(0);
                                this._setDate(date);
                                this.fill();
                                if (this.autoclose) {
                                    this.hide();
                                }
                                break;
                            } else if (target.is('.month')) {
                                this.viewDate.setUTCDate(1);
                                month = target.parent().find('span').index(target);
                                day = this.viewDate.getUTCDate();
                                this.viewDate.setUTCMonth(month);
                                this.element.trigger({
                                    type: 'changeMonth',
                                    date: this.viewDate
                                });
                                if (this.viewSelect >= 3) {
                                    this._setDate(UTCDate(year, month, day, hours, minutes, seconds, 0));
                                }
                            } else if (target.is('.year')) {
                                this.viewDate.setUTCDate(1);
                                year = parseInt(target.text(), 10) || 0;
                                this.viewDate.setUTCFullYear(year);
                                this.element.trigger({
                                    type: 'changeYear',
                                    date: this.viewDate
                                });
                                if (this.viewSelect >= 4) {
                                    this._setDate(UTCDate(year, month, day, hours, minutes, seconds, 0));
                                }
                            } else if (target.is('.hour')) {
                                hours = parseInt(target.text(), 10) || 0;
                                if (target.hasClass('hour_am') || target.hasClass('hour_pm')) {
                                    if (hours === 12 && target.hasClass('hour_am')) {
                                        hours = 0;
                                    } else if (hours !== 12 && target.hasClass('hour_pm')) {
                                        hours += 12;
                                    }
                                }
                                this.viewDate.setUTCHours(hours);
                                this.element.trigger({
                                    type: 'changeHour',
                                    date: this.viewDate
                                });
                                if (this.viewSelect >= 1) {
                                    this._setDate(UTCDate(year, month, day, hours, minutes, seconds, 0));
                                }
                            } else if (target.is('.minute')) {
                                minutes = parseInt(target.text().substr(target.text().indexOf(':') + 1), 10) || 0;
                                this.viewDate.setUTCMinutes(minutes);
                                this.element.trigger({
                                    type: 'changeMinute',
                                    date: this.viewDate
                                });
                                if (this.viewSelect >= 0) {
                                    this._setDate(UTCDate(year, month, day, hours, minutes, seconds, 0));
                                }
                            } else if (
                                target.is('.icon-date_left_2') ||
                                target.is('.icon-date_right_2') ||
                                target.is('.icon-date_left_1') ||
                                target.is('.icon-date_right_1')
                            ) {
                                target.parent().click();
                                return;
                            }
                            if (this.viewMode !== 0) {
                                var oldViewMode = this.viewMode;
                                this.showMode(-1);
                                this.fill();
                                if (oldViewMode === this.viewMode && this.autoclose) {
                                    this.hide();
                                }
                            } else {
                                this.fill();
                                if (this.autoclose) {
                                    this.hide();
                                }
                            }
                        }
                        break;
                    case 'td':
                        if (target.is('.day') && !target.is('.disabled')) {
                            var day = parseInt(target.text(), 10) || 1;
                            var year = this.viewDate.getUTCFullYear(),
                                month = this.viewDate.getUTCMonth(),
                                hours = this.viewDate.getUTCHours(),
                                minutes = this.viewDate.getUTCMinutes(),
                                seconds = this.viewDate.getUTCSeconds();
                            if (target.is('.old')) {
                                if (month === 0) {
                                    month = 11;
                                    year -= 1;
                                } else {
                                    month -= 1;
                                }
                            } else if (target.is('.new')) {
                                if (month === 11) {
                                    month = 0;
                                    year += 1;
                                } else {
                                    month += 1;
                                }
                            }
                            this.viewDate.setUTCFullYear(year);
                            this.viewDate.setUTCMonth(month, day);
                            this.element.trigger({
                                type: 'changeDay',
                                date: this.viewDate
                            });
                            if (this.viewSelect >= 2) {
                                this._setDate(UTCDate(year, month, day, hours, minutes, seconds, 0));
                            }
                        }
                        //如果是日期格式则直接关闭弹窗
                        if (this.format.parts.length == 3) {
                            var partArr = this.format.parts;
                            if (partArr[0].toLowerCase() == 'yyyy' && partArr[1].toLowerCase() == 'mm' && partArr[2].toLowerCase() == 'dd') {
                                //this._setDate(UTCDate(year, month, day));
                                this.hide();
                                break;
                            }
                        }
                        var oldViewMode = this.viewMode;
                        this.showMode(-1);
                        this.fill();
                        if (oldViewMode === this.viewMode && this.autoclose) {
                            this.hide();
                        }
                        break;
                }
            }
        },

        _setDate: function (date, which) {
            if (!which || which === 'date')
                this.date = date;
            if (!which || which === 'view')
                this.viewDate = date;
            this.fill();
            this.setValue();
            var element;
            if (this.isInput) {
                element = this.element;
            } else if (this.component) {
                element = this.element.find('input');
            }
            if (element) {
                element.change();
            }
            this.element.trigger({
                type: 'changeDate',
                date: this.getDate()
            });
            if (date === null)
                this.date = this.viewDate;
        },

        moveMinute: function (date, dir) {
            if (!dir) return date;
            var new_date = new Date(date.valueOf());
            //dir = dir > 0 ? 1 : -1;
            new_date.setUTCMinutes(new_date.getUTCMinutes() + (dir * this.minuteStep));
            return new_date;
        },

        moveHour: function (date, dir) {
            if (!dir) return date;
            var new_date = new Date(date.valueOf());
            //dir = dir > 0 ? 1 : -1;
            new_date.setUTCHours(new_date.getUTCHours() + dir);
            return new_date;
        },

        moveDate: function (date, dir) {
            if (!dir) return date;
            var new_date = new Date(date.valueOf());
            //dir = dir > 0 ? 1 : -1;
            new_date.setUTCDate(new_date.getUTCDate() + dir);
            return new_date;
        },

        moveMonth: function (date, dir) {
            if (!dir) return date;
            var new_date = new Date(date.valueOf()),
                day = new_date.getUTCDate(),
                month = new_date.getUTCMonth(),
                mag = Math.abs(dir),
                new_month, test;
            dir = dir > 0 ? 1 : -1;
            if (mag === 1) {
                test = dir === -1
                    // If going back one month, make sure month is not current month
                    // (eg, Mar 31 -> Feb 31 === Feb 28, not Mar 02)
                    ? function () {
                        return new_date.getUTCMonth() === month;
                    }
                    // If going forward one month, make sure month is as expected
                    // (eg, Jan 31 -> Feb 31 === Feb 28, not Mar 02)
                    : function () {
                        return new_date.getUTCMonth() !== new_month;
                    };
                new_month = month + dir;
                new_date.setUTCMonth(new_month);
                // Dec -> Jan (12) or Jan -> Dec (-1) -- limit expected date to 0-11
                if (new_month < 0 || new_month > 11)
                    new_month = (new_month + 12) % 12;
            } else {
                // For magnitudes >1, move one month at a time...
                for (var i = 0; i < mag; i++)
                    // ...which might decrease the day (eg, Jan 31 to Feb 28, etc)...
                    new_date = this.moveMonth(new_date, dir);
                // ...then reset the day, keeping it in the new month
                new_month = new_date.getUTCMonth();
                new_date.setUTCDate(day);
                test = function () {
                    return new_month !== new_date.getUTCMonth();
                };
            }
            // Common date-resetting loop -- if date is beyond end of month, make it
            // end of month
            while (test()) {
                new_date.setUTCDate(--day);
                new_date.setUTCMonth(new_month);
            }
            return new_date;
        },

        moveYear: function (date, dir) {
            return this.moveMonth(date, dir * 12);
        },

        dateWithinRange: function (date) {
            return date >= this.startDate && date <= this.endDate;
        },

        keydown: function (e) {
            //if (this.picker.is(':not(:visible)')) {
            //    if (e.keyCode === 27) // allow escape to hide and re-show picker
            //        this.show();
            //    return;
            //}
            //var dateChanged = false,
            //  dir, newDate, newViewDate;
            //switch (e.keyCode) {
            //    case 27: // escape
            //        this.hide();
            //        e.preventDefault();
            //        break;
            //    case 37: // left
            //    case 39: // right
            //        if (!this.keyboardNavigation) break;
            //        dir = e.keyCode === 37 ? -1 : 1;
            //        var viewMode = this.viewMode;
            //        if (e.ctrlKey) {
            //            viewMode += 2;
            //        } else if (e.shiftKey) {
            //            viewMode += 1;
            //        }
            //        if (viewMode === 4) {
            //            newDate = this.moveYear(this.date, dir);
            //            newViewDate = this.moveYear(this.viewDate, dir);
            //        } else if (viewMode === 3) {
            //            newDate = this.moveMonth(this.date, dir);
            //            newViewDate = this.moveMonth(this.viewDate, dir);
            //        } else if (viewMode === 2) {
            //            newDate = this.moveDate(this.date, dir);
            //            newViewDate = this.moveDate(this.viewDate, dir);
            //        } else if (viewMode === 1) {
            //            newDate = this.moveHour(this.date, dir);
            //            newViewDate = this.moveHour(this.viewDate, dir);
            //        } else if (viewMode === 0) {
            //            newDate = this.moveMinute(this.date, dir);
            //            newViewDate = this.moveMinute(this.viewDate, dir);
            //        }
            //        if (this.dateWithinRange(newDate)) {
            //            this.date = newDate;
            //            this.viewDate = newViewDate;
            //            this.setValue();
            //            this.update();
            //            e.preventDefault();
            //            dateChanged = true;
            //        }
            //        break;
            //    case 38: // up
            //    case 40: // down
            //        if (!this.keyboardNavigation) break;
            //        dir = e.keyCode === 38 ? -1 : 1;
            //        viewMode = this.viewMode;
            //        if (e.ctrlKey) {
            //            viewMode += 2;
            //        } else if (e.shiftKey) {
            //            viewMode += 1;
            //        }
            //        if (viewMode === 4) {
            //            newDate = this.moveYear(this.date, dir);
            //            newViewDate = this.moveYear(this.viewDate, dir);
            //        } else if (viewMode === 3) {
            //            newDate = this.moveMonth(this.date, dir);
            //            newViewDate = this.moveMonth(this.viewDate, dir);
            //        } else if (viewMode === 2) {
            //            newDate = this.moveDate(this.date, dir * 7);
            //            newViewDate = this.moveDate(this.viewDate, dir * 7);
            //        } else if (viewMode === 1) {
            //            if (this.showMeridian) {
            //                newDate = this.moveHour(this.date, dir * 6);
            //                newViewDate = this.moveHour(this.viewDate, dir * 6);
            //            } else {
            //                newDate = this.moveHour(this.date, dir * 4);
            //                newViewDate = this.moveHour(this.viewDate, dir * 4);
            //            }
            //        } else if (viewMode === 0) {
            //            newDate = this.moveMinute(this.date, dir * 4);
            //            newViewDate = this.moveMinute(this.viewDate, dir * 4);
            //        }
            //        if (this.dateWithinRange(newDate)) {
            //            this.date = newDate;
            //            this.viewDate = newViewDate;
            //            this.setValue();
            //            this.update();
            //            e.preventDefault();
            //            dateChanged = true;
            //        }
            //        break;
            //    case 13: // enter
            //        if (this.viewMode !== 0) {
            //            var oldViewMode = this.viewMode;
            //            this.showMode(-1);
            //            this.fill();
            //            if (oldViewMode === this.viewMode && this.autoclose) {
            //                this.hide();
            //            }
            //        } else {
            //            this.fill();
            //            if (this.autoclose) {
            //                this.hide();
            //            }
            //        }
            //        e.preventDefault();
            //        break;
            //    case 9: // tab
            //        this.hide();
            //        break;
            //}
            //if (dateChanged) {
            //    var element;
            //    if (this.isInput) {
            //        element = this.element;
            //    } else if (this.component) {
            //        element = this.element.find('input');
            //    }
            //    if (element) {
            //        element.change();
            //    }
            //    this.element.trigger({
            //        type: 'changeDate',
            //        date: this.getDate()
            //    });
            //}
        },

        showMode: function (dir) {
            if (dir) {
                var newViewMode = Math.max(0, Math.min(DPGlobal.modes.length - 1, this.viewMode + dir));
                if (newViewMode >= this.minView && newViewMode <= this.maxView) {
                    this.element.trigger({
                        type: 'changeMode',
                        date: this.viewDate,
                        oldViewMode: this.viewMode,
                        newViewMode: newViewMode
                    });

                    this.viewMode = newViewMode;
                }
            }
            /*
             vitalets: fixing bug of very special conditions:
             jquery 1.7.1 + webkit + show inline datetimepicker in bootstrap popover.
             Method show() does not set display css correctly and datetimepicker is not shown.
             Changed to .css('display', 'block') solve the problem.
             See https://github.com/vitalets/x-editable/issues/37

             In jquery 1.7.2+ everything works fine.
             */
            //this.picker.find('>div').hide().filter('.datetimepicker-'+DPGlobal.modes[this.viewMode].clsName).show();
            this.picker.find('>div').hide().filter('.datetimepicker-' + DPGlobal.modes[this.viewMode].clsName).css('display', 'block');
            this.updateNavArrows();
        },

        reset: function () {
            this._setDate(null, 'date');
        },

        convertViewModeText: function (viewMode) {
            switch (viewMode) {
                case 4:
                    return 'decade';
                case 3:
                    return 'year';
                case 2:
                    return 'month';
                case 1:
                    return 'day';
                case 0:
                    return 'hour';
            }
        }
    };

    var old = $.fn.datetimepicker;
    $.fn.datetimepicker = function (option) {
        var args = Array.apply(null, arguments);
        args.shift();
        var internal_return;
        this.each(function () {
            var $this = $(this),
                data = $this.data('datetimepicker'),
                options = typeof option === 'object' && option;
            if (!data) {
                $this.data('datetimepicker', (data = new Datetimepicker(this, $.extend({}, $.fn.datetimepicker.defaults, options))));
            }
            if (typeof option === 'string' && typeof data[option] === 'function') {
                internal_return = data[option].apply(data, args);
                if (internal_return !== undefined) {
                    return false;
                }
            }
        });
        if (internal_return !== undefined)
            return internal_return;
        else
            return this;
    };

    $.fn.datetimepicker.defaults = {
    };
    $.fn.datetimepicker.Constructor = Datetimepicker;
    var dates = $.fn.datetimepicker.dates = {
        en: {
            days: ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'],
            daysShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六", "周日"],
            //daysMin: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'],
            daysMin: ['日', '一', '二', '三', '四', '五', '六', '日'],
            //months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
            months: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            monthsShort: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            meridiem: ['上午', '下午'],
            suffix: [],
            today: '今天',
            clear: '清空'
        }
    };

    var DPGlobal = {
        modes: [
            {
                clsName: 'minutes',
                navFnc: 'Hours',
                navStep: 1
            },
            {
                clsName: 'hours',
                navFnc: 'Date',
                navStep: 1
            },
            {
                clsName: 'days',
                navFnc: 'Month',
                navStep: 1
            },
            {
                clsName: 'months',
                navFnc: 'FullYear',
                navStep: 1
            },
            {
                clsName: 'years',
                navFnc: 'FullYear',
                navStep: 10
            }
        ],
        isLeapYear: function (year) {
            return (((year % 4 === 0) && (year % 100 !== 0)) || (year % 400 === 0))
        },
        getDaysInMonth: function (year, month) {
            return [31, (DPGlobal.isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31][month]
        },
        getDefaultFormat: function (type, field) {
            if (type === 'standard') {
                if (field === 'input')
                    return 'yyyy-mm-dd hh:ii';
                else
                    return 'yyyy-mm-dd hh:ii:ss';
            } else if (type === 'php') {
                //if (field === 'input')
                //    return 'Y-m-d H:i';
                //else
                //    return 'Y-m-d H:i:s';
            } else {
                throw new Error('Invalid format type.');
            }
        },
        validParts: function (type) {
            if (type === 'standard') {
                return /t|hh?|HH?|p|P|z|Z|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;
            } else if (type === 'php') {
                return /[dDjlNwzFmMnStyYaABgGhHis]/g;
            } else {
                throw new Error('Invalid format type.');
            }
        },
        nonpunctuation: /[^ -\/:-@\[-`{-~\t\n\rTZ]+/g,
        parseFormat: function (format, type) {
            // IE treats \0 as a string end in inputs (truncating the value),
            // so it's a bad format delimiter, anyway
            var separators = format.replace(this.validParts(type), '\0').split('\0'),
                parts = format.match(this.validParts(type));
            if (!separators || !separators.length || !parts || parts.length === 0) {
                throw new Error('Invalid date format.');
            }
            return { separators: separators, parts: parts };
        },
        parseDate: function (date, format, language, type, timezone) {
            if (date instanceof Date) {
                var dateUTC = new Date(date.valueOf() - date.getTimezoneOffset() * 60000);
                dateUTC.setMilliseconds(0);
                return dateUTC;
            }
            if (/^\d{4}\-\d{1,2}\-\d{1,2}$/.test(date)) {
                format = this.parseFormat('yyyy-mm-dd', type);
            }
            if (/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}$/.test(date)) {
                format = this.parseFormat('yyyy-mm-dd hh:ii', type);
            }
            if (/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}\:\d{1,2}[Z]{0,1}$/.test(date)) {
                format = this.parseFormat('yyyy-mm-dd hh:ii:ss', type);
            }
            if (/^[-+]\d+[dmwy]([\s,]+[-+]\d+[dmwy])*$/.test(date)) {
                var part_re = /([-+]\d+)([dmwy])/,
                    parts = date.match(/([-+]\d+)([dmwy])/g),
                    part, dir;
                date = new Date();
                for (var i = 0; i < parts.length; i++) {
                    part = part_re.exec(parts[i]);
                    dir = parseInt(part[1]);
                    switch (part[2]) {
                        case 'd':
                            date.setUTCDate(date.getUTCDate() + dir);
                            break;
                        case 'm':
                            date = Datetimepicker.prototype.moveMonth.call(Datetimepicker.prototype, date, dir);
                            break;
                        case 'w':
                            date.setUTCDate(date.getUTCDate() + dir * 7);
                            break;
                        case 'y':
                            date = Datetimepicker.prototype.moveYear.call(Datetimepicker.prototype, date, dir);
                            break;
                    }
                }
                return UTCDate(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds(), 0);
            }
            var parts = date && date.toString().match(this.nonpunctuation) || [],
                date = new Date(0, 0, 0, 0, 0, 0, 0),
                parsed = {},
                setters_order = ['hh', 'h', 'ii', 'i', 'ss', 's', 'yyyy', 'yy', 'M', 'MM', 'm', 'mm', 'D', 'DD', 'd', 'dd', 'H', 'HH', 'p', 'P', 'z', 'Z'],
                setters_map = {
                    hh: function (d, v) {
                        return d.setUTCHours(v);
                    },
                    h: function (d, v) {
                        return d.setUTCHours(v);
                    },
                    HH: function (d, v) {
                        return d.setUTCHours(v === 12 ? 0 : v);
                    },
                    H: function (d, v) {
                        return d.setUTCHours(v === 12 ? 0 : v);
                    },
                    ii: function (d, v) {
                        return d.setUTCMinutes(v);
                    },
                    i: function (d, v) {
                        return d.setUTCMinutes(v);
                    },
                    ss: function (d, v) {
                        return d.setUTCSeconds(v);
                    },
                    s: function (d, v) {
                        return d.setUTCSeconds(v);
                    },
                    yyyy: function (d, v) {
                        return d.setUTCFullYear(v);
                    },
                    yy: function (d, v) {
                        return d.setUTCFullYear(2000 + v);
                    },
                    m: function (d, v) {
                        v -= 1;
                        while (v < 0) v += 12;
                        v %= 12;
                        d.setUTCMonth(v);
                        while (d.getUTCMonth() !== v)
                            if (isNaN(d.getUTCMonth()))
                                return d;
                            else
                                d.setUTCDate(d.getUTCDate() - 1);
                        return d;
                    },
                    d: function (d, v) {
                        return d.setUTCDate(v);
                    },
                    p: function (d, v) {
                        return d.setUTCHours(v === 1 ? d.getUTCHours() + 12 : d.getUTCHours());
                    },
                    z: function () {
                        return timezone
                    }
                },
                val, filtered, part;
            setters_map['M'] = setters_map['MM'] = setters_map['mm'] = setters_map['m'];
            setters_map['dd'] = setters_map['d'];
            setters_map['P'] = setters_map['p'];
            setters_map['Z'] = setters_map['z'];
            date = UTCDate(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds());
            if (parts.length === format.parts.length) {
                for (var i = 0, cnt = format.parts.length; i < cnt; i++) {
                    val = parseInt(parts[i], 10);
                    part = format.parts[i];
                    if (isNaN(val)) {
                        switch (part) {
                            case 'MM':
                                filtered = $(dates[language].months).filter(function () {
                                    var m = this.slice(0, parts[i].length),
                                        p = parts[i].slice(0, m.length);
                                    return m === p;
                                });
                                val = $.inArray(filtered[0], dates[language].months) + 1;
                                break;
                            case 'M':
                                filtered = $(dates[language].monthsShort).filter(function () {
                                    var m = this.slice(0, parts[i].length),
                                        p = parts[i].slice(0, m.length);
                                    return m.toLowerCase() === p.toLowerCase();
                                });
                                val = $.inArray(filtered[0], dates[language].monthsShort) + 1;
                                break;
                            case 'p':
                            case 'P':
                                val = $.inArray(parts[i].toLowerCase(), dates[language].meridiem);
                                break;
                            case 'z':
                            case 'Z':
                                timezone;
                                break;
                        }
                    }
                    parsed[part] = val;
                }
                for (var i = 0, s; i < setters_order.length; i++) {
                    s = setters_order[i];
                    if (s in parsed && !isNaN(parsed[s]))
                        setters_map[s](date, parsed[s])
                }
            }
            return date;
        },
        formatDate: function (date, format, language, type, timezone) {
            if (date === null) {
                return '';
            }
            var val;
            if (type === 'standard') {
                val = {
                    t: date.getTime(),
                    // year
                    yy: date.getUTCFullYear().toString().substring(2),
                    yyyy: date.getUTCFullYear(),
                    // month
                    m: date.getUTCMonth() + 1,
                    M: dates[language].monthsShort[date.getUTCMonth()],
                    MM: dates[language].months[date.getUTCMonth()],
                    // day
                    d: date.getUTCDate(),
                    D: dates[language].daysShort[date.getUTCDay()],
                    DD: dates[language].days[date.getUTCDay()],
                    p: (dates[language].meridiem.length === 2 ? dates[language].meridiem[date.getUTCHours() < 12 ? 0 : 1] : ''),
                    // hour
                    h: date.getUTCHours(),
                    // minute
                    i: date.getUTCMinutes(),
                    // second
                    s: date.getUTCSeconds(),
                    // timezone
                    z: timezone
                };

                if (dates[language].meridiem.length === 2) {
                    val.H = (val.h % 12 === 0 ? 12 : val.h % 12);
                }
                else {
                    val.H = val.h;
                }
                val.HH = (val.H < 10 ? '0' : '') + val.H;
                val.P = val.p.toUpperCase();
                val.Z = val.z;
                val.hh = (val.h < 10 ? '0' : '') + val.h;
                val.ii = (val.i < 10 ? '0' : '') + val.i;
                val.ss = (val.s < 10 ? '0' : '') + val.s;
                val.dd = (val.d < 10 ? '0' : '') + val.d;
                val.mm = (val.m < 10 ? '0' : '') + val.m;
            } else if (type === 'php') {
                // php format
                //val = {
                //    // year
                //    y: date.getUTCFullYear().toString().substring(2),
                //    Y: date.getUTCFullYear(),
                //    // month
                //    F: dates[language].months[date.getUTCMonth()],
                //    M: dates[language].monthsShort[date.getUTCMonth()],
                //    n: date.getUTCMonth() + 1,
                //    t: DPGlobal.getDaysInMonth(date.getUTCFullYear(), date.getUTCMonth()),
                //    // day
                //    j: date.getUTCDate(),
                //    l: dates[language].days[date.getUTCDay()],
                //    D: dates[language].daysShort[date.getUTCDay()],
                //    w: date.getUTCDay(), // 0 -> 6
                //    N: (date.getUTCDay() === 0 ? 7 : date.getUTCDay()),       // 1 -> 7
                //    S: (date.getUTCDate() % 10 <= dates[language].suffix.length ? dates[language].suffix[date.getUTCDate() % 10 - 1] : ''),
                //    // hour
                //    a: (dates[language].meridiem.length === 2 ? dates[language].meridiem[date.getUTCHours() < 12 ? 0 : 1] : ''),
                //    g: (date.getUTCHours() % 12 === 0 ? 12 : date.getUTCHours() % 12),
                //    G: date.getUTCHours(),
                //    // minute
                //    i: date.getUTCMinutes(),
                //    // second
                //    s: date.getUTCSeconds()
                //};
                //val.m = (val.n < 10 ? '0' : '') + val.n;
                //val.d = (val.j < 10 ? '0' : '') + val.j;
                //val.A = val.a.toString().toUpperCase();
                //val.h = (val.g < 10 ? '0' : '') + val.g;
                //val.H = (val.G < 10 ? '0' : '') + val.G;
                //val.i = (val.i < 10 ? '0' : '') + val.i;
                //val.s = (val.s < 10 ? '0' : '') + val.s;
            } else {
                throw new Error('Invalid format type.');
            }
            var date = [],
                seps = $.extend([], format.separators);
            for (var i = 0, cnt = format.parts.length; i < cnt; i++) {
                if (seps.length) {
                    date.push(seps.shift());
                }
                date.push(val[format.parts[i]]);
            }
            if (seps.length) {
                date.push(seps.shift());
            }
            return date.join('');
        },
        convertViewMode: function (viewMode) {
            switch (viewMode) {
                case 4:
                case 'decade':
                    viewMode = 4;
                    break;
                case 3:
                case 'year':
                    viewMode = 3;
                    break;
                case 2:
                case 'month':
                    viewMode = 2;
                    break;
                case 1:
                case 'day':
                    viewMode = 1;
                    break;
                case 0:
                case 'hour':
                    viewMode = 0;
                    break;
            }

            return viewMode;
        },
        headTemplateV3: '<thead>' +
            '<tr>' +
            '<th class="prevYear"><i class="ivu-icon ivu-icon-chevron-left"></i> </th>' +
            '<th class="prev"><i class="ivu-icon ivu-icon-reply"></i> </th>' +
            '<th colspan="3" class="switch"></th>' +
            '<th class="next"><i class="ivu-icon ivu-icon-forward"></i> </th>' +
            '<th class="nextYear"><i class="ivu-icon ivu-icon-chevron-right"></i> </th>' +
            '</tr>' +
            '</thead>',
        contTemplate: '<tbody><tr><td colspan="7"></td></tr></tbody>',
        footTemplate: function (viewMode) {
            var template = '';
            switch (viewMode) {
                case 4:
                case 'decade':
                    viewMode = 4;
                    break;
                case 3:
                case 'year':
                    viewMode = 3;
                    break;
                case 2:
                case 'month':
                    viewMode = 2;
                    break;
                case 1:
                case 'day':
                    template = '<tfoot>' +
                        '<tr><th colspan="3" class="today"></th><th></th><th colspan="3" class="clear"></th></tr>' +
                        '</tfoot>';
                    break;
                case 0:
                case 'hour':
                    template = '<tfoot>' +
                        '<tr>' +
                        '<th colspan="7">' +
                        '<span class="back">返回</span>' +
                        '<span class="now">当前时刻</span>' +
                        '<span class="clear">清空</span>' +
                        '</th>' +
                        '</tr>' +
                        '</tfoot>'
                    break;
                //case -1:
                //case 'minute':
                //    template = '<tfoot>' +
                //                 '<tr>' +
                //                     '<th colspan="7">' +
                //                         '<span class="back">返回</span>' +
                //                         '<span class="now">当前时刻</span>' +
                //                         '<span class="clear">清空</span>' +
                //                     '</th>' +
                //                 '</tr>' +
                //             '</tfoot>'
                //    break;
            }
            return template;
        }
    };
    //DPGlobal.template = '<div class="datetimepicker">' +
    //  '<div class="datetimepicker-minutes">' +
    //  '<table class=" table-condensed">' +
    //  DPGlobal.headTemplate +
    //  DPGlobal.contTemplate +
    //  DPGlobal.footTemplate(-1) +
    //  '</table>' +
    //  '</div>' +
    //  '<div class="datetimepicker-hours">' +
    //  '<table class=" table-condensed">' +
    //  DPGlobal.headTemplate +
    //  DPGlobal.contTemplate +
    //  DPGlobal.footTemplate(0) +
    //  '</table>' +
    //  '</div>' +
    //  '<div class="datetimepicker-days">' +
    //  '<table class=" table-condensed">' +
    //  DPGlobal.headTemplate +
    //  '<tbody></tbody>' +
    //  DPGlobal.footTemplate(1) +
    //  '</table>' +
    //  '</div>' +
    //  '<div class="datetimepicker-months">' +
    //  '<table class="table-condensed">' +
    //  DPGlobal.headTemplate +
    //  DPGlobal.contTemplate +
    //  DPGlobal.footTemplate(2) +
    //  '</table>' +
    //  '</div>' +
    //  '<div class="datetimepicker-years">' +
    //  '<table class="table-condensed">' +
    //  DPGlobal.headTemplate +
    //  DPGlobal.contTemplate +
    //  DPGlobal.footTemplate(3) +
    //  '</table>' +
    //  '</div>' +
    //  '</div>';
    DPGlobal.templateV3 = '<div class="datetimepicker">' +
        '<div class="datetimepicker-minutes">' +
        '<table class=" table-condensed">' +
        DPGlobal.headTemplateV3 +
        DPGlobal.contTemplate +
        DPGlobal.footTemplate(0) +
        '</table>' +
        '</div>' +
        '<div class="datetimepicker-hours">' +
        '<table class=" table-condensed">' +
        DPGlobal.headTemplateV3 +
        DPGlobal.contTemplate +
        DPGlobal.footTemplate(0) +
        '</table>' +
        '</div>' +
        '<div class="datetimepicker-days">' +
        '<table class=" table-condensed">' +
        DPGlobal.headTemplateV3 +
        '<tbody></tbody>' +
        DPGlobal.footTemplate(1) +
        '</table>' +
        '</div>' +
        '<div class="datetimepicker-months">' +
        '<table class="table-condensed">' +
        DPGlobal.headTemplateV3 +
        DPGlobal.contTemplate +
        DPGlobal.footTemplate(2) +
        '</table>' +
        '</div>' +
        '<div class="datetimepicker-years">' +
        '<table class="table-condensed">' +
        DPGlobal.headTemplateV3 +
        DPGlobal.contTemplate +
        DPGlobal.footTemplate(3) +
        '</table>' +
        '</div>' +
        '</div>';
    $.fn.datetimepicker.DPGlobal = DPGlobal;

    /* DATETIMEPICKER NO CONFLICT
     * =================== */

    $.fn.datetimepicker.noConflict = function () {
        $.fn.datetimepicker = old;
        return this;
    };

    /* DATETIMEPICKER DATA-API
     * ================== */

    $(document).on('focus.datetimepicker.data-api click.datetimepicker.data-api', '[data-provide="datetimepicker"]', function (e) {
        var $this = $(this);
        if ($this.data('datetimepicker')) return;
        e.preventDefault();
        // component click requires us to explicitly show it
        $this.datetimepicker('show');
    });
    $(function () {
        $('[data-provide="datetimepicker-inline"]').datetimepicker();
    });
}));;
(function ($) {
    'use strict';
    function transitionEnd() {
        var el = document.createElement('mm');
        var transEndEventNames = {
            WebkitTransition: 'webkitTransitionEnd',
            MozTransition: 'transitionend',
            OTransition: 'oTransitionEnd otransitionend',
            transition: 'transitionend'
        };
        for (var name in transEndEventNames) {
            if (el.style[name] !== undefined) {
                return {
                    end: transEndEventNames[name]
                };
            }
        }
        return false;
    }
    $.fn.emulateTransitionEnd = function (duration) {
        var called = false;
        var $el = this;
        $(this).one('mmTransitionEnd', function () {
            called = true;
        });
        var callback = function () {
            if (!called) {
                $($el).trigger($transition.end);
            }
        };
        setTimeout(callback, duration);
        return this;
    };
    var $transition = transitionEnd();
    if (!!$transition) {
        $.event.special.mmTransitionEnd = {
            bindType: $transition.end,
            delegateType: $transition.end,
            handle: function (e) {
                if ($(e.target).is(this)) {
                    return e.handleObj.handler.apply(this, arguments);
                }
            }
        };
    }
    var MetisMenu = function (element, options) {
        this.$element = $(element);
        this.options = $.extend({}, MetisMenu.DEFAULTS, options);
        this.transitioning = null;
        if (this.options.toggle) { }
        //this.show();
        this.init();
    };
    MetisMenu.TRANSITION_DURATION = 350;
    MetisMenu.DEFAULTS = {
        toggle: true,
        doubleTapToGo: false,
        onlyforOrganization: false,
        AddChildNodes: function () { }
    };
    MetisMenu.prototype.init = function () {
        var $this = this;
        this.$element.find('li.active').has('ul').children('ul').addClass('collapse in');
        this.$element.find('li').not('.active').has('ul').children('ul').addClass('collapse');
        if (this.options.Ctrl) {
            this.$element.data("ctrl", this.options.Ctrl);
        }
        //add the 'doubleTapToGo' class to active items if needed
        if (this.options.doubleTapToGo) {
            this.$element.find('li.active').has('ul').children('a').addClass('doubleTapToGo');
        }
        this.$element.find('li').children('a').children('.fa-arrow,.icon-xiangyou').on('click.metisMenu', { ctrl: this.$element.data("ctrl") }, function (e) {
            var self = $(this);
            var self = self.parent();
            var UnitID = self.attr("id");
            if ($this.options.onlyforOrganization) {
                if (self.attr("HasChild") != "HasChild")
                    return;
            }
            var $parent = self.parent('li');
            var $list = $parent.children('ul');
            e.preventDefault();
            if ($parent.hasClass('active')) {
                $this.hide($list);
            } else {
                if ($this.options.onlyforOrganization) {
                    var selfarray = new Array();
                    selfarray.push(self);
                    $this.options.AddChildNodes.apply(this, selfarray);
                }
                if ($parent.has("ul").length == 0)
                    return;
                $list = $parent.children('ul');
                $this.show($list);
                if (e.data.ctrl) {
                    var units = e.data.ctrl.GetUnitIDs();
                    if (units && units.length > 0) {
                        for (var i = 0; i < units.length; i++) {
                            $list.find("input[type='checkbox'][id='c_" + units[i] + "']").prop("checked", true);
                        }
                    }
                }
            }
            //Do we need to enable the double tap
            if ($this.options.doubleTapToGo) {
                //if we hit a second time on the link and the href is valid, navigate to that url
                if ($this.doubleTapToGo(self) && self.attr('href') !== '#' && self.attr('href') !== '') {
                    e.stopPropagation();
                    document.location = self.attr('href');
                    return;
                }
            }
        });
    };
    MetisMenu.prototype.doubleTapToGo = function (elem) {
        var $this = this.$element;
        //if the class 'doubleTapToGo' exists, remove it and return
        if (elem.hasClass('doubleTapToGo')) {
            elem.removeClass('doubleTapToGo');
            return true;
        }
        //does not exists, add a new class and return false
        if (elem.parent().children('ul').length) {
            //first remove all other class
            $this.find('.doubleTapToGo').removeClass('doubleTapToGo');
            //add the class on the current element
            elem.addClass('doubleTapToGo');
            return false;
        }
    };
    MetisMenu.prototype.show = function (el) {
        var $this = $(el);
        var $parent = $this.parent('li');
        if (this.transitioning || $this.hasClass('in')) {
            return;
        }
        $parent.addClass('active');
        if (this.options.toggle) {
            this.hide($parent.siblings().children('ul.in'));
        }
        $this
            .removeClass('collapse')
            .addClass('collapsing')
            .height(0);
        this.transitioning = 1;
        var complete = function () {
            $this
                .removeClass('collapsing')
                .addClass('collapse in')
                .height('');
            this.transitioning = 0;
        };
        if (!$transition) {
            return complete.call(this);
        }
        if (!$.isEmptyObject($this[0])) {
            $this
                .one('mmTransitionEnd', $.proxy(complete, this))
                .emulateTransitionEnd(MetisMenu.TRANSITION_DURATION)
                .height($this[0].scrollHeight);
        }
        else {
            $this
                .one('mmTransitionEnd', $.proxy(complete, this))
                .emulateTransitionEnd(MetisMenu.TRANSITION_DURATION)
        }
    };
    MetisMenu.prototype.hide = function (el) {
        var $this = $(el);
        if (this.transitioning || !$this.hasClass('in')) {
            return;
        }
        $this.parent('li').removeClass('active');
        $this.height($this.height())[0].offsetHeight;
        $this
            .addClass('collapsing')
            .removeClass('collapse')
            .removeClass('in');
        this.transitioning = 1;
        var complete = function () {
            this.transitioning = 0;
            $this
                .removeClass('collapsing')
                .addClass('collapse');
        };
        if (!$transition) {
            return complete.call(this);
        }
        $this
            .height(0)
            .one('mmTransitionEnd', $.proxy(complete, this))
            .emulateTransitionEnd(MetisMenu.TRANSITION_DURATION);
    };
    function Plugin(option) {
        return this.each(function () {
            var $this = $(this);
            var data = $this.data('mm');
            var options = $.extend({}, MetisMenu.DEFAULTS, $this.data(), typeof option === 'object' && option);
            if (!data) {
                $this.data('mm', (data = new MetisMenu(this, options)));
            }
            if (typeof option === 'string') {
                data[option]();
            }
        });
    }
    var old = $.fn.metisMenu;
    $.fn.metisMenu = Plugin;
    $.fn.metisMenu.Constructor = MetisMenu;
    $.fn.metisMenu.noConflict = function () {
        $.fn.metisMenu = old;
        return this;
    };
})(jQuery);
;
/* WebUploader 0.1.5 */!function (a, b) { var c, d = {}, e = function (a, b) { var c, d, e; if ("string" == typeof a) return h(a); for (c = [], d = a.length, e = 0; d > e; e++)c.push(h(a[e])); return b.apply(null, c) }, f = function (a, b, c) { 2 === arguments.length && (c = b, b = null), e(b || [], function () { g(a, c, arguments) }) }, g = function (a, b, c) { var f, g = { exports: b }; "function" == typeof b && (c.length || (c = [e, g.exports, g]), f = b.apply(null, c), void 0 !== f && (g.exports = f)), d[a] = g.exports }, h = function (b) { var c = d[b] || a[b]; if (!c) throw new Error("`" + b + "` is undefined"); return c }, i = function (a) { var b, c, e, f, g, h; h = function (a) { return a && a.charAt(0).toUpperCase() + a.substr(1) }; for (b in d) if (c = a, d.hasOwnProperty(b)) { for (e = b.split("/"), g = h(e.pop()); f = h(e.shift());)c[f] = c[f] || {}, c = c[f]; c[g] = d[b] } return a }, j = function (c) { return a.__dollar = c, i(b(a, f, e)) }; "object" == typeof module && "object" == typeof module.exports ? module.exports = j() : "function" == typeof define && define.amd ? define(["jquery"], j) : (c = a.WebUploader, a.WebUploader = j(), a.WebUploader.noConflict = function () { a.WebUploader = c }) }(window, function (a, b, c) {
    return b("dollar-third", [], function () { var b = a.__dollar || a.jQuery || a.Zepto; if (!b) throw new Error("jQuery or Zepto not found!"); return b }), b("dollar", ["dollar-third"], function (a) { return a }), b("promise-third", ["dollar"], function (a) { return { Deferred: a.Deferred, when: a.when, isPromise: function (a) { return a && "function" == typeof a.then } } }), b("promise", ["promise-third"], function (a) { return a }), b("base", ["dollar", "promise"], function (b, c) { function d(a) { return function () { return h.apply(a, arguments) } } function e(a, b) { return function () { return a.apply(b, arguments) } } function f(a) { var b; return Object.create ? Object.create(a) : (b = function () { }, b.prototype = a, new b) } var g = function () { }, h = Function.call; return { version: "0.1.5", $: b, Deferred: c.Deferred, isPromise: c.isPromise, when: c.when, browser: function (a) { var b = {}, c = a.match(/WebKit\/([\d.]+)/), d = a.match(/Chrome\/([\d.]+)/) || a.match(/CriOS\/([\d.]+)/), e = a.match(/MSIE\s([\d\.]+)/) || a.match(/(?:trident)(?:.*rv:([\w.]+))?/i), f = a.match(/Firefox\/([\d.]+)/), g = a.match(/Safari\/([\d.]+)/), h = a.match(/OPR\/([\d.]+)/); return c && (b.webkit = parseFloat(c[1])), d && (b.chrome = parseFloat(d[1])), e && (b.ie = parseFloat(e[1])), f && (b.firefox = parseFloat(f[1])), g && (b.safari = parseFloat(g[1])), h && (b.opera = parseFloat(h[1])), b }(navigator.userAgent), os: function (a) { var b = {}, c = a.match(/(?:Android);?[\s\/]+([\d.]+)?/), d = a.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/); return c && (b.android = parseFloat(c[1])), d && (b.ios = parseFloat(d[1].replace(/_/g, "."))), b }(navigator.userAgent), inherits: function (a, c, d) { var e; return "function" == typeof c ? (e = c, c = null) : e = c && c.hasOwnProperty("constructor") ? c.constructor : function () { return a.apply(this, arguments) }, b.extend(!0, e, a, d || {}), e.__super__ = a.prototype, e.prototype = f(a.prototype), c && b.extend(!0, e.prototype, c), e }, noop: g, bindFn: e, log: function () { return a.console ? e(console.log, console) : g }(), nextTick: function () { return function (a) { setTimeout(a, 1) } }(), slice: d([].slice), guid: function () { var a = 0; return function (b) { for (var c = (+new Date).toString(32), d = 0; 5 > d; d++)c += Math.floor(65535 * Math.random()).toString(32); return (b || "wu_") + c + (a++).toString(32) } }(), formatSize: function (a, b, c) { var d; for (c = c || ["B", "K", "M", "G", "TB"]; (d = c.shift()) && a > 1024;)a /= 1024; return ("B" === d ? a : a.toFixed(b || 2)) + d } } }), b("mediator", ["base"], function (a) { function b(a, b, c, d) { return f.grep(a, function (a) { return !(!a || b && a.e !== b || c && a.cb !== c && a.cb._cb !== c || d && a.ctx !== d) }) } function c(a, b, c) { f.each((a || "").split(h), function (a, d) { c(d, b) }) } function d(a, b) { for (var c, d = !1, e = -1, f = a.length; ++e < f;)if (c = a[e], c.cb.apply(c.ctx2, b) === !1) { d = !0; break } return !d } var e, f = a.$, g = [].slice, h = /\s+/; return e = { on: function (a, b, d) { var e, f = this; return b ? (e = this._events || (this._events = []), c(a, b, function (a, b) { var c = { e: a }; c.cb = b, c.ctx = d, c.ctx2 = d || f, c.id = e.length, e.push(c) }), this) : this }, once: function (a, b, d) { var e = this; return b ? (c(a, b, function (a, b) { var c = function () { return e.off(a, c), b.apply(d || e, arguments) }; c._cb = b, e.on(a, c, d) }), e) : e }, off: function (a, d, e) { var g = this._events; return g ? a || d || e ? (c(a, d, function (a, c) { f.each(b(g, a, c, e), function () { delete g[this.id] }) }), this) : (this._events = [], this) : this }, trigger: function (a) { var c, e, f; return this._events && a ? (c = g.call(arguments, 1), e = b(this._events, a), f = b(this._events, "all"), d(e, c) && d(f, arguments)) : this } }, f.extend({ installTo: function (a) { return f.extend(a, e) } }, e) }), b("uploader", ["base", "mediator"], function (a, b) { function c(a) { this.options = d.extend(!0, {}, c.options, a), this._init(this.options) } var d = a.$; return c.options = {}, b.installTo(c.prototype), d.each({ upload: "start-upload", stop: "stop-upload", getFile: "get-file", getFiles: "get-files", addFile: "add-file", addFiles: "add-file", sort: "sort-files", removeFile: "remove-file", cancelFile: "cancel-file", skipFile: "skip-file", retry: "retry", isInProgress: "is-in-progress", makeThumb: "make-thumb", md5File: "md5-file", getDimension: "get-dimension", addButton: "add-btn", predictRuntimeType: "predict-runtime-type", refresh: "refresh", disable: "disable", enable: "enable", reset: "reset" }, function (a, b) { c.prototype[a] = function () { return this.request(b, arguments) } }), d.extend(c.prototype, { state: "pending", _init: function (a) { var b = this; b.request("init", a, function () { b.state = "ready", b.trigger("ready") }) }, option: function (a, b) { var c = this.options; return arguments.length > 1 ? void (d.isPlainObject(b) && d.isPlainObject(c[a]) ? d.extend(c[a], b) : c[a] = b) : a ? c[a] : c }, getStats: function () { var a = this.request("get-stats"); return a ? { successNum: a.numOfSuccess, progressNum: a.numOfProgress, cancelNum: a.numOfCancel, invalidNum: a.numOfInvalid, uploadFailNum: a.numOfUploadFailed, queueNum: a.numOfQueue, interruptNum: a.numofInterrupt } : {} }, trigger: function (a) { var c = [].slice.call(arguments, 1), e = this.options, f = "on" + a.substring(0, 1).toUpperCase() + a.substring(1); return b.trigger.apply(this, arguments) === !1 || d.isFunction(e[f]) && e[f].apply(this, c) === !1 || d.isFunction(this[f]) && this[f].apply(this, c) === !1 || b.trigger.apply(b, [this, a].concat(c)) === !1 ? !1 : !0 }, destroy: function () { this.request("destroy", arguments), this.off() }, request: a.noop }), a.create = c.create = function (a) { return new c(a) }, a.Uploader = c, c }), b("runtime/runtime", ["base", "mediator"], function (a, b) { function c(b) { this.options = d.extend({ container: document.body }, b), this.uid = a.guid("rt_") } var d = a.$, e = {}, f = function (a) { for (var b in a) if (a.hasOwnProperty(b)) return b; return null }; return d.extend(c.prototype, { getContainer: function () { var a, b, c = this.options; return this._container ? this._container : (a = d(c.container || document.body), b = d(document.createElement("div")), b.attr("id", "rt_" + this.uid), b.css({ position: "absolute", top: "0px", left: "0px", width: "1px", height: "1px", overflow: "hidden" }), a.append(b), a.addClass("webuploader-container"), this._container = b, this._parent = a, b) }, init: a.noop, exec: a.noop, destroy: function () { this._container && this._container.remove(), this._parent && this._parent.removeClass("webuploader-container"), this.off() } }), c.orders = "html5,flash", c.addRuntime = function (a, b) { e[a] = b }, c.hasRuntime = function (a) { return !!(a ? e[a] : f(e)) }, c.create = function (a, b) { var g, h; if (b = b || c.orders, d.each(b.split(/\s*,\s*/g), function () { return e[this] ? (g = this, !1) : void 0 }), g = g || f(e), !g) throw new Error("Runtime Error"); return h = new e[g](a) }, b.installTo(c.prototype), c }), b("runtime/client", ["base", "mediator", "runtime/runtime"], function (a, b, c) { function d(b, d) { var f, g = a.Deferred(); this.uid = a.guid("client_"), this.runtimeReady = function (a) { return g.done(a) }, this.connectRuntime = function (b, h) { if (f) throw new Error("already connected!"); return g.done(h), "string" == typeof b && e.get(b) && (f = e.get(b)), f = f || e.get(null, d), f ? (a.$.extend(f.options, b), f.__promise.then(g.resolve), f.__client++) : (f = c.create(b, b.runtimeOrder), f.__promise = g.promise(), f.once("ready", g.resolve), f.init(), e.add(f), f.__client = 1), d && (f.__standalone = d), f }, this.getRuntime = function () { return f }, this.disconnectRuntime = function () { f && (f.__client-- , f.__client <= 0 && (e.remove(f), delete f.__promise, f.destroy()), f = null) }, this.exec = function () { if (f) { var c = a.slice(arguments); return b && c.unshift(b), f.exec.apply(this, c) } }, this.getRuid = function () { return f && f.uid }, this.destroy = function (a) { return function () { a && a.apply(this, arguments), this.trigger("destroy"), this.off(), this.exec("destroy"), this.disconnectRuntime() } }(this.destroy) } var e; return e = function () { var a = {}; return { add: function (b) { a[b.uid] = b }, get: function (b, c) { var d; if (b) return a[b]; for (d in a) if (!c || !a[d].__standalone) return a[d]; return null }, remove: function (b) { delete a[b.uid] } } }(), b.installTo(d.prototype), d }), b("lib/dnd", ["base", "mediator", "runtime/client"], function (a, b, c) { function d(a) { a = this.options = e.extend({}, d.options, a), a.container = e(a.container), a.container.length && c.call(this, "DragAndDrop") } var e = a.$; return d.options = { accept: null, disableGlobalDnd: !1 }, a.inherits(c, { constructor: d, init: function () { var a = this; a.connectRuntime(a.options, function () { a.exec("init"), a.trigger("ready") }) } }), b.installTo(d.prototype), d }), b("widgets/widget", ["base", "uploader"], function (a, b) { function c(a) { if (!a) return !1; var b = a.length, c = e.type(a); return 1 === a.nodeType && b ? !0 : "array" === c || "function" !== c && "string" !== c && (0 === b || "number" == typeof b && b > 0 && b - 1 in a) } function d(a) { this.owner = a, this.options = a.options } var e = a.$, f = b.prototype._init, g = b.prototype.destroy, h = {}, i = []; return e.extend(d.prototype, { init: a.noop, invoke: function (a, b) { var c = this.responseMap; return c && a in c && c[a] in this && e.isFunction(this[c[a]]) ? this[c[a]].apply(this, b) : h }, request: function () { return this.owner.request.apply(this.owner, arguments) } }), e.extend(b.prototype, { _init: function () { var a = this, b = a._widgets = [], c = a.options.disableWidgets || ""; return e.each(i, function (d, e) { (!c || !~c.indexOf(e._name)) && b.push(new e(a)) }), f.apply(a, arguments) }, request: function (b, d, e) { var f, g, i, j, k = 0, l = this._widgets, m = l && l.length, n = [], o = []; for (d = c(d) ? d : [d]; m > k; k++)f = l[k], g = f.invoke(b, d), g !== h && (a.isPromise(g) ? o.push(g) : n.push(g)); return e || o.length ? (i = a.when.apply(a, o), j = i.pipe ? "pipe" : "then", i[j](function () { var b = a.Deferred(), c = arguments; return 1 === c.length && (c = c[0]), setTimeout(function () { b.resolve(c) }, 1), b.promise() })[e ? j : "done"](e || a.noop)) : n[0] }, destroy: function () { g.apply(this, arguments), this._widgets = null } }), b.register = d.register = function (b, c) { var f, g = { init: "init", destroy: "destroy", name: "anonymous" }; return 1 === arguments.length ? (c = b, e.each(c, function (a) { return "_" === a[0] || "name" === a ? void ("name" === a && (g.name = c.name)) : void (g[a.replace(/[A-Z]/g, "-$&").toLowerCase()] = a) })) : g = e.extend(g, b), c.responseMap = g, f = a.inherits(d, c), f._name = g.name, i.push(f), f }, b.unRegister = d.unRegister = function (a) { if (a && "anonymous" !== a) for (var b = i.length; b--;)i[b]._name === a && i.splice(b, 1) }, d }), b("widgets/filednd", ["base", "uploader", "lib/dnd", "widgets/widget"], function (a, b, c) { var d = a.$; return b.options.dnd = "", b.register({ name: "dnd", init: function (b) { if (b.dnd && "html5" === this.request("predict-runtime-type")) { var e, f = this, g = a.Deferred(), h = d.extend({}, { disableGlobalDnd: b.disableGlobalDnd, container: b.dnd, accept: b.accept }); return this.dnd = e = new c(h), e.once("ready", g.resolve), e.on("drop", function (a) { f.request("add-file", [a]) }), e.on("accept", function (a) { return f.owner.trigger("dndAccept", a) }), e.init(), g.promise() } }, destroy: function () { this.dnd && this.dnd.destroy() } }) }), b("lib/filepaste", ["base", "mediator", "runtime/client"], function (a, b, c) { function d(a) { a = this.options = e.extend({}, a), a.container = e(a.container || document.body), c.call(this, "FilePaste") } var e = a.$; return a.inherits(c, { constructor: d, init: function () { var a = this; a.connectRuntime(a.options, function () { a.exec("init"), a.trigger("ready") }) } }), b.installTo(d.prototype), d }), b("widgets/filepaste", ["base", "uploader", "lib/filepaste", "widgets/widget"], function (a, b, c) { var d = a.$; return b.register({ name: "paste", init: function (b) { if (b.paste && "html5" === this.request("predict-runtime-type")) { var e, f = this, g = a.Deferred(), h = d.extend({}, { container: b.paste, accept: b.accept }); return this.paste = e = new c(h), e.once("ready", g.resolve), e.on("paste", function (a) { f.owner.request("add-file", [a]) }), e.init(), g.promise() } }, destroy: function () { this.paste && this.paste.destroy() } }) }), b("lib/blob", ["base", "runtime/client"], function (a, b) { function c(a, c) { var d = this; d.source = c, d.ruid = a, this.size = c.size || 0, this.type = !c.type && this.ext && ~"jpg,jpeg,png,gif,bmp".indexOf(this.ext) ? "image/" + ("jpg" === this.ext ? "jpeg" : this.ext) : c.type || "application/octet-stream", b.call(d, "Blob"), this.uid = c.uid || this.uid, a && d.connectRuntime(a) } return a.inherits(b, { constructor: c, slice: function (a, b) { return this.exec("slice", a, b) }, getSource: function () { return this.source } }), c }), b("lib/file", ["base", "lib/blob"], function (a, b) { function c(a, c) { var f; this.name = c.name || "untitled" + d++ , f = e.exec(c.name) ? RegExp.$1.toLowerCase() : "", !f && c.type && (f = /\/(jpg|jpeg|png|gif|bmp)$/i.exec(c.type) ? RegExp.$1.toLowerCase() : "", this.name += "." + f), this.ext = f, this.lastModifiedDate = c.lastModifiedDate || (new Date).toLocaleString(), b.apply(this, arguments) } var d = 1, e = /\.([^.]+)$/; return a.inherits(b, c) }), b("lib/filepicker", ["base", "runtime/client", "lib/file"], function (b, c, d) { function e(a) { if (a = this.options = f.extend({}, e.options, a), a.container = f(a.id), !a.container.length) throw new Error("按钮指定错误"); a.innerHTML = a.innerHTML || a.label || a.container.html() || "", a.button = f(a.button || document.createElement("div")), a.button.html(a.innerHTML), a.container.html(a.button), c.call(this, "FilePicker", !0) } var f = b.$; return e.options = { button: null, container: null, label: null, innerHTML: null, multiple: !0, accept: null, name: "file" }, b.inherits(c, { constructor: e, init: function () { var c = this, e = c.options, g = e.button; g.addClass("webuploader-pick"), c.on("all", function (a) { var b; switch (a) { case "mouseenter": g.addClass("webuploader-pick-hover"); break; case "mouseleave": g.removeClass("webuploader-pick-hover"); break; case "change": b = c.exec("getFiles"), c.trigger("select", f.map(b, function (a) { return a = new d(c.getRuid(), a), a._refer = e.container, a }), e.container) } }), c.connectRuntime(e, function () { c.refresh(), c.exec("init", e), c.trigger("ready") }), this._resizeHandler = b.bindFn(this.refresh, this), f(a).on("resize", this._resizeHandler) }, refresh: function () { var a = this.getRuntime().getContainer(), b = this.options.button, c = b.outerWidth ? b.outerWidth() : b.width(), d = b.outerHeight ? b.outerHeight() : b.height(), e = b.offset(); c && d && a.css({ bottom: "auto", right: "auto", width: c + "px", height: d + "px" }).offset(e) }, enable: function () { var a = this.options.button; a.removeClass("webuploader-pick-disable"), this.refresh() }, disable: function () { var a = this.options.button; this.getRuntime().getContainer().css({ top: "-99999px" }), a.addClass("webuploader-pick-disable") }, destroy: function () { var b = this.options.button; f(a).off("resize", this._resizeHandler), b.removeClass("webuploader-pick-disable webuploader-pick-hover webuploader-pick") } }), e }), b("widgets/filepicker", ["base", "uploader", "lib/filepicker", "widgets/widget"], function (a, b, c) { var d = a.$; return d.extend(b.options, { pick: null, accept: null }), b.register({ name: "picker", init: function (a) { return this.pickers = [], a.pick && this.addBtn(a.pick) }, refresh: function () { d.each(this.pickers, function () { this.refresh() }) }, addBtn: function (b) { var e = this, f = e.options, g = f.accept, h = []; if (b) return d.isPlainObject(b) || (b = { id: b }), d(b.id).each(function () { var i, j, k; k = a.Deferred(), i = d.extend({}, b, { accept: d.isPlainObject(g) ? [g] : g, swf: f.swf, runtimeOrder: f.runtimeOrder, id: this }), j = new c(i), j.once("ready", k.resolve), j.on("select", function (a) { e.owner.request("add-file", [a]) }), j.init(), e.pickers.push(j), h.push(k.promise()) }), a.when.apply(a, h) }, disable: function () { d.each(this.pickers, function () { this.disable() }) }, enable: function () { d.each(this.pickers, function () { this.enable() }) }, destroy: function () { d.each(this.pickers, function () { this.destroy() }), this.pickers = null } }) }), b("lib/image", ["base", "runtime/client", "lib/blob"], function (a, b, c) { function d(a) { this.options = e.extend({}, d.options, a), b.call(this, "Image"), this.on("load", function () { this._info = this.exec("info"), this._meta = this.exec("meta") }) } var e = a.$; return d.options = { quality: 90, crop: !1, preserveHeaders: !1, allowMagnify: !1 }, a.inherits(b, { constructor: d, info: function (a) { return a ? (this._info = a, this) : this._info }, meta: function (a) { return a ? (this._meta = a, this) : this._meta }, loadFromBlob: function (a) { var b = this, c = a.getRuid(); this.connectRuntime(c, function () { b.exec("init", b.options), b.exec("loadFromBlob", a) }) }, resize: function () { var b = a.slice(arguments); return this.exec.apply(this, ["resize"].concat(b)) }, crop: function () { var b = a.slice(arguments); return this.exec.apply(this, ["crop"].concat(b)) }, getAsDataUrl: function (a) { return this.exec("getAsDataUrl", a) }, getAsBlob: function (a) { var b = this.exec("getAsBlob", a); return new c(this.getRuid(), b) } }), d }), b("widgets/image", ["base", "uploader", "lib/image", "widgets/widget"], function (a, b, c) { var d, e = a.$; return d = function (a) { var b = 0, c = [], d = function () { for (var d; c.length && a > b;)d = c.shift(), b += d[0], d[1]() }; return function (a, e, f) { c.push([e, f]), a.once("destroy", function () { b -= e, setTimeout(d, 1) }), setTimeout(d, 1) } }(5242880), e.extend(b.options, { thumb: { width: 110, height: 110, quality: 70, allowMagnify: !0, crop: !0, preserveHeaders: !1, type: "image/jpeg" }, compress: { width: 1600, height: 1600, quality: 90, allowMagnify: !1, crop: !1, preserveHeaders: !0 } }), b.register({ name: "image", makeThumb: function (a, b, f, g) { var h, i; return a = this.request("get-file", a), a.type.match(/^image/) ? (h = e.extend({}, this.options.thumb), e.isPlainObject(f) && (h = e.extend(h, f), f = null), f = f || h.width, g = g || h.height, i = new c(h), i.once("load", function () { a._info = a._info || i.info(), a._meta = a._meta || i.meta(), 1 >= f && f > 0 && (f = a._info.width * f), 1 >= g && g > 0 && (g = a._info.height * g), i.resize(f, g) }), i.once("complete", function () { b(!1, i.getAsDataUrl(h.type)), i.destroy() }), i.once("error", function (a) { b(a || !0), i.destroy() }), void d(i, a.source.size, function () { a._info && i.info(a._info), a._meta && i.meta(a._meta), i.loadFromBlob(a.source) })) : void b(!0) }, beforeSendFile: function (b) { var d, f, g = this.options.compress || this.options.resize, h = g && g.compressSize || 0, i = g && g.noCompressIfLarger || !1; return b = this.request("get-file", b), !g || !~"image/jpeg,image/jpg".indexOf(b.type) || b.size < h || b._compressed ? void 0 : (g = e.extend({}, g), f = a.Deferred(), d = new c(g), f.always(function () { d.destroy(), d = null }), d.once("error", f.reject), d.once("load", function () { var a = g.width, c = g.height; b._info = b._info || d.info(), b._meta = b._meta || d.meta(), 1 >= a && a > 0 && (a = b._info.width * a), 1 >= c && c > 0 && (c = b._info.height * c), d.resize(a, c) }), d.once("complete", function () { var a, c; try { a = d.getAsBlob(g.type), c = b.size, (!i || a.size < c) && (b.source = a, b.size = a.size, b.trigger("resize", a.size, c)), b._compressed = !0, f.resolve() } catch (e) { f.resolve() } }), b._info && d.info(b._info), b._meta && d.meta(b._meta), d.loadFromBlob(b.source), f.promise()) } }) }), b("file", ["base", "mediator"], function (a, b) { function c() { return f + g++ } function d(a) { this.name = a.name || "Untitled", this.size = a.size || 0, this.type = a.type || "application/octet-stream", this.lastModifiedDate = a.lastModifiedDate || 1 * new Date, this.id = c(), this.ext = h.exec(this.name) ? RegExp.$1 : "", this.statusText = "", i[this.id] = d.Status.INITED, this.source = a, this.loaded = 0, this.on("error", function (a) { this.setStatus(d.Status.ERROR, a) }) } var e = a.$, f = "WU_FILE_", g = 0, h = /\.([^.]+)$/, i = {}; return e.extend(d.prototype, { setStatus: function (a, b) { var c = i[this.id]; "undefined" != typeof b && (this.statusText = b), a !== c && (i[this.id] = a, this.trigger("statuschange", a, c)) }, getStatus: function () { return i[this.id] }, getSource: function () { return this.source }, destroy: function () { this.off(), delete i[this.id] } }), b.installTo(d.prototype), d.Status = { INITED: "inited", QUEUED: "queued", PROGRESS: "progress", ERROR: "error", COMPLETE: "complete", CANCELLED: "cancelled", INTERRUPT: "interrupt", INVALID: "invalid" }, d }), b("queue", ["base", "mediator", "file"], function (a, b, c) { function d() { this.stats = { numOfQueue: 0, numOfSuccess: 0, numOfCancel: 0, numOfProgress: 0, numOfUploadFailed: 0, numOfInvalid: 0, numofDeleted: 0, numofInterrupt: 0 }, this._queue = [], this._map = {} } var e = a.$, f = c.Status; return e.extend(d.prototype, { append: function (a) { return this._queue.push(a), this._fileAdded(a), this }, prepend: function (a) { return this._queue.unshift(a), this._fileAdded(a), this }, getFile: function (a) { return "string" != typeof a ? a : this._map[a] }, fetch: function (a) { var b, c, d = this._queue.length; for (a = a || f.QUEUED, b = 0; d > b; b++)if (c = this._queue[b], a === c.getStatus()) return c; return null }, sort: function (a) { "function" == typeof a && this._queue.sort(a) }, getFiles: function () { for (var a, b = [].slice.call(arguments, 0), c = [], d = 0, f = this._queue.length; f > d; d++)a = this._queue[d], (!b.length || ~e.inArray(a.getStatus(), b)) && c.push(a); return c }, removeFile: function (a) { var b = this._map[a.id]; b && (delete this._map[a.id], a.destroy(), this.stats.numofDeleted++) }, _fileAdded: function (a) { var b = this, c = this._map[a.id]; c || (this._map[a.id] = a, a.on("statuschange", function (a, c) { b._onFileStatusChange(a, c) })) }, _onFileStatusChange: function (a, b) { var c = this.stats; switch (b) { case f.PROGRESS: c.numOfProgress--; break; case f.QUEUED: c.numOfQueue--; break; case f.ERROR: c.numOfUploadFailed--; break; case f.INVALID: c.numOfInvalid--; break; case f.INTERRUPT: c.numofInterrupt-- }switch (a) { case f.QUEUED: c.numOfQueue++; break; case f.PROGRESS: c.numOfProgress++; break; case f.ERROR: c.numOfUploadFailed++; break; case f.COMPLETE: c.numOfSuccess++; break; case f.CANCELLED: c.numOfCancel++; break; case f.INVALID: c.numOfInvalid++; break; case f.INTERRUPT: c.numofInterrupt++ } } }), b.installTo(d.prototype), d }), b("widgets/queue", ["base", "uploader", "queue", "file", "lib/file", "runtime/client", "widgets/widget"], function (a, b, c, d, e, f) { var g = a.$, h = /\.\w+$/, i = d.Status; return b.register({ name: "queue", init: function (b) { var d, e, h, i, j, k, l, m = this; if (g.isPlainObject(b.accept) && (b.accept = [b.accept]), b.accept) { for (j = [], h = 0, e = b.accept.length; e > h; h++)i = b.accept[h].extensions, i && j.push(i); j.length && (k = "\\." + j.join(",").replace(/,/g, "$|\\.").replace(/\*/g, ".*") + "$"), m.accept = new RegExp(k, "i") } return m.queue = new c, m.stats = m.queue.stats, "html5" === this.request("predict-runtime-type") ? (d = a.Deferred(), this.placeholder = l = new f("Placeholder"), l.connectRuntime({ runtimeOrder: "html5" }, function () { m._ruid = l.getRuid(), d.resolve() }), d.promise()) : void 0 }, _wrapFile: function (a) { if (!(a instanceof d)) { if (!(a instanceof e)) { if (!this._ruid) throw new Error("Can't add external files."); a = new e(this._ruid, a) } a = new d(a) } return a }, acceptFile: function (a) { var b = !a || !a.size || this.accept && h.exec(a.name) && !this.accept.test(a.name); return !b }, _addFile: function (a) { var b = this; return a = b._wrapFile(a), b.owner.trigger("beforeFileQueued", a) ? b.acceptFile(a) ? (b.queue.append(a), b.owner.trigger("fileQueued", a), a) : void b.owner.trigger("error", "Q_TYPE_DENIED", a) : void 0 }, getFile: function (a) { return this.queue.getFile(a) }, addFile: function (a) { var b = this; a.length || (a = [a]), a = g.map(a, function (a) { return b._addFile(a) }), b.owner.trigger("filesQueued", a), b.options.auto && setTimeout(function () { b.request("start-upload") }, 20) }, getStats: function () { return this.stats }, removeFile: function (a, b) { var c = this; a = a.id ? a : c.queue.getFile(a), this.request("cancel-file", a), b && this.queue.removeFile(a) }, getFiles: function () { return this.queue.getFiles.apply(this.queue, arguments) }, fetchFile: function () { return this.queue.fetch.apply(this.queue, arguments) }, retry: function (a, b) { var c, d, e, f = this; if (a) return a = a.id ? a : f.queue.getFile(a), a.setStatus(i.QUEUED), void (b || f.request("start-upload")); for (c = f.queue.getFiles(i.ERROR), d = 0, e = c.length; e > d; d++)a = c[d], a.setStatus(i.QUEUED); f.request("start-upload") }, sortFiles: function () { return this.queue.sort.apply(this.queue, arguments) }, reset: function () { this.owner.trigger("reset"), this.queue = new c, this.stats = this.queue.stats }, destroy: function () { this.reset(), this.placeholder && this.placeholder.destroy() } }) }), b("widgets/runtime", ["uploader", "runtime/runtime", "widgets/widget"], function (a, b) { return a.support = function () { return b.hasRuntime.apply(b, arguments) }, a.register({ name: "runtime", init: function () { if (!this.predictRuntimeType()) throw Error("Runtime Error") }, predictRuntimeType: function () { var a, c, d = this.options.runtimeOrder || b.orders, e = this.type; if (!e) for (d = d.split(/\s*,\s*/g), a = 0, c = d.length; c > a; a++)if (b.hasRuntime(d[a])) { this.type = e = d[a]; break } return e } }) }), b("lib/transport", ["base", "runtime/client", "mediator"], function (a, b, c) { function d(a) { var c = this; a = c.options = e.extend(!0, {}, d.options, a || {}), b.call(this, "Transport"), this._blob = null, this._formData = a.formData || {}, this._headers = a.headers || {}, this.on("progress", this._timeout), this.on("load error", function () { c.trigger("progress", 1), clearTimeout(c._timer) }) } var e = a.$; return d.options = { server: "", method: "POST", withCredentials: !1, fileVal: "file", timeout: 12e4, formData: {}, headers: {}, sendAsBinary: !1 }, e.extend(d.prototype, { appendBlob: function (a, b, c) { var d = this, e = d.options; d.getRuid() && d.disconnectRuntime(), d.connectRuntime(b.ruid, function () { d.exec("init") }), d._blob = b, e.fileVal = a || e.fileVal, e.filename = c || e.filename }, append: function (a, b) { "object" == typeof a ? e.extend(this._formData, a) : this._formData[a] = b }, setRequestHeader: function (a, b) { "object" == typeof a ? e.extend(this._headers, a) : this._headers[a] = b }, send: function (a) { this.exec("send", a), this._timeout() }, abort: function () { return clearTimeout(this._timer), this.exec("abort") }, destroy: function () { this.trigger("destroy"), this.off(), this.exec("destroy"), this.disconnectRuntime() }, getResponse: function () { return this.exec("getResponse") }, getResponseAsJson: function () { return this.exec("getResponseAsJson") }, getStatus: function () { return this.exec("getStatus") }, _timeout: function () { var a = this, b = a.options.timeout; b && (clearTimeout(a._timer), a._timer = setTimeout(function () { a.abort(), a.trigger("error", "timeout") }, b)) } }), c.installTo(d.prototype), d }), b("widgets/upload", ["base", "uploader", "file", "lib/transport", "widgets/widget"], function (a, b, c, d) {
        function e(a, b) { var c, d, e = [], f = a.source, g = f.size, h = b ? Math.ceil(g / b) : 1, i = 0, j = 0; for (d = { file: a, has: function () { return !!e.length }, shift: function () { return e.shift() }, unshift: function (a) { e.unshift(a) } }; h > j;)c = Math.min(b, g - i), e.push({ file: a, start: i, end: b ? i + c : g, total: g, chunks: h, chunk: j++, cuted: d }), i += c; return a.blocks = e.concat(), a.remaning = e.length, d } var f = a.$, g = a.isPromise, h = c.Status; f.extend(b.options, { prepareNextFile: !1, chunked: !1, chunkSize: 5242880, chunkRetry: 2, threads: 3, formData: {} }), b.register({
            name: "upload", init: function () { var b = this.owner, c = this; this.runing = !1, this.progress = !1, b.on("startUpload", function () { c.progress = !0 }).on("uploadFinished", function () { c.progress = !1 }), this.pool = [], this.stack = [], this.pending = [], this.remaning = 0, this.__tick = a.bindFn(this._tick, this), b.on("uploadComplete", function (a) { a.blocks && f.each(a.blocks, function (a, b) { b.transport && (b.transport.abort(), b.transport.destroy()), delete b.transport }), delete a.blocks, delete a.remaning }) }, reset: function () { this.request("stop-upload", !0), this.runing = !1, this.pool = [], this.stack = [], this.pending = [], this.remaning = 0, this._trigged = !1, this._promise = null }, startUpload: function (b) { var c = this; if (f.each(c.request("get-files", h.INVALID), function () { c.request("remove-file", this) }), b) if (b = b.id ? b : c.request("get-file", b), b.getStatus() === h.INTERRUPT) f.each(c.pool, function (a, c) { c.file === b && c.transport && c.transport.send() }), b.setStatus(h.QUEUED); else { if (b.getStatus() === h.PROGRESS) return; b.setStatus(h.QUEUED) } else f.each(c.request("get-files", [h.INITED]), function () { this.setStatus(h.QUEUED) }); if (!c.runing) { c.runing = !0; var d = []; f.each(c.pool, function (a, b) { var e = b.file; e.getStatus() === h.INTERRUPT && (d.push(e), c._trigged = !1, b.transport && b.transport.send()) }); for (var b; b = d.shift();)b.setStatus(h.PROGRESS); b || f.each(c.request("get-files", h.INTERRUPT), function () { this.setStatus(h.PROGRESS) }), c._trigged = !1, a.nextTick(c.__tick), c.owner.trigger("startUpload") } }, stopUpload: function (b, c) { var d = this; if (b === !0 && (c = b, b = null), d.runing !== !1) { if (b) { if (b = b.id ? b : d.request("get-file", b), b.getStatus() !== h.PROGRESS && b.getStatus() !== h.QUEUED) return; return b.setStatus(h.INTERRUPT), f.each(d.pool, function (a, c) { c.file === b && (c.transport && c.transport.abort(), d._putback(c), d._popBlock(c)) }), a.nextTick(d.__tick) } d.runing = !1, this._promise && this._promise.file && this._promise.file.setStatus(h.INTERRUPT), c && f.each(d.pool, function (a, b) { b.transport && b.transport.abort(), b.file.setStatus(h.INTERRUPT) }), d.owner.trigger("stopUpload") } }, cancelFile: function (a) { a = a.id ? a : this.request("get-file", a), a.blocks && f.each(a.blocks, function (a, b) { var c = b.transport; c && (c.abort(), c.destroy(), delete b.transport) }), a.setStatus(h.CANCELLED), this.owner.trigger("fileDequeued", a) }, isInProgress: function () { return !!this.progress }, _getStats: function () { return this.request("get-stats") }, skipFile: function (a, b) { a = a.id ? a : this.request("get-file", a), a.setStatus(b || h.COMPLETE), a.skipped = !0, a.blocks && f.each(a.blocks, function (a, b) { var c = b.transport; c && (c.abort(), c.destroy(), delete b.transport) }), this.owner.trigger("uploadSkip", a) }, _tick: function () { var b, c, d = this, e = d.options; return d._promise ? d._promise.always(d.__tick) : void (d.pool.length < e.threads && (c = d._nextBlock()) ? (d._trigged = !1, b = function (b) { d._promise = null, b && b.file && d._startSend(b), a.nextTick(d.__tick) }, d._promise = g(c) ? c.always(b) : b(c)) : d.remaning || d._getStats().numOfQueue || d._getStats().numofInterrupt || (d.runing = !1, d._trigged || a.nextTick(function () { d.owner.trigger("uploadFinished") }), d._trigged = !0)) }, _putback: function (a) { var b; a.cuted.unshift(a), b = this.stack.indexOf(a.cuted), ~b || this.stack.unshift(a.cuted) }, _getStack: function () { for (var a, b = 0; a = this.stack[b++];) { if (a.has() && a.file.getStatus() === h.PROGRESS) return a; (!a.has() || a.file.getStatus() !== h.PROGRESS && a.file.getStatus() !== h.INTERRUPT) && this.stack.splice(--b, 1) } return null }, _nextBlock: function () { var a, b, c, d, f = this, h = f.options; return (a = this._getStack()) ? (h.prepareNextFile && !f.pending.length && f._prepareNextFile(), a.shift()) : f.runing ? (!f.pending.length && f._getStats().numOfQueue && f._prepareNextFile(), b = f.pending.shift(), c = function (b) { return b ? (a = e(b, h.chunked ? h.chunkSize : 0), f.stack.push(a), a.shift()) : null }, g(b) ? (d = b.file, b = b[b.pipe ? "pipe" : "then"](c), b.file = d, b) : c(b)) : void 0 }, _prepareNextFile: function () { var a, b = this, c = b.request("fetch-file"), d = b.pending; c && (a = b.request("before-send-file", c, function () { return c.getStatus() === h.PROGRESS || c.getStatus() === h.INTERRUPT ? c : b._finishFile(c) }), b.owner.trigger("uploadStart", c), c.setStatus(h.PROGRESS), a.file = c, a.done(function () { var b = f.inArray(a, d); ~b && d.splice(b, 1, c) }), a.fail(function (a) { c.setStatus(h.ERROR, a), b.owner.trigger("uploadError", c, a), b.owner.trigger("uploadComplete", c) }), d.push(a)) }, _popBlock: function (a) { var b = f.inArray(a, this.pool); this.pool.splice(b, 1), a.file.remaning-- , this.remaning-- }, _startSend: function (b) { var c, d = this, e = b.file; return e.getStatus() !== h.PROGRESS ? void (e.getStatus() === h.INTERRUPT && d._putback(b)) : (d.pool.push(b), d.remaning++ , b.blob = 1 === b.chunks ? e.source : e.source.slice(b.start, b.end), c = d.request("before-send", b, function () { e.getStatus() === h.PROGRESS ? d._doSend(b) : (d._popBlock(b), a.nextTick(d.__tick)) }), void c.fail(function () { 1 === e.remaning ? d._finishFile(e).always(function () { b.percentage = 1, d._popBlock(b), d.owner.trigger("uploadComplete", e), a.nextTick(d.__tick) }) : (b.percentage = 1, d.updateFileProgress(e), d._popBlock(b), a.nextTick(d.__tick)) })) }, _doSend: function (b) { var c, e, g = this, i = g.owner, j = g.options, k = b.file, l = new d(j), m = f.extend({}, j.formData), n = f.extend({}, j.headers); b.transport = l, l.on("destroy", function () { delete b.transport, g._popBlock(b), a.nextTick(g.__tick) }), l.on("progress", function (a) { b.percentage = a, g.updateFileProgress(k) }), c = function (a) { var c; return e = l.getResponseAsJson() || {}, e._raw = l.getResponse(), c = function (b) { a = b }, i.trigger("uploadAccept", b, e, c) || (a = a || "server"), a }, l.on("error", function (a, d) { b.retried = b.retried || 0, b.chunks > 1 && ~"http,abort".indexOf(a) && b.retried < j.chunkRetry ? (b.retried++ , l.send()) : (d || "server" !== a || (a = c(a)), k.setStatus(h.ERROR, a), i.trigger("uploadError", k, a), i.trigger("uploadComplete", k)) }), l.on("load", function () { var a; return (a = c()) ? void l.trigger("error", a, !0) : void (1 === k.remaning ? g._finishFile(k, e) : l.destroy()) }), m = f.extend(m, { id: k.id, name: k.name, type: k.type, lastModifiedDate: k.lastModifiedDate, size: k.size }), b.chunks > 1 && f.extend(m, { chunks: b.chunks, chunk: b.chunk }), i.trigger("uploadBeforeSend", b, m, n), l.appendBlob(j.fileVal, b.blob, k.name), l.append(m), l.setRequestHeader(n), l.send() }, _finishFile: function (a, b, c) {
                var d = this.owner; return d.request("after-send-file", arguments, function () { a.setStatus(h.COMPLETE), d.trigger("uploadSuccess", a, b, c) }).fail(function (b) {
                    a.getStatus() === h.PROGRESS && a.setStatus(h.ERROR, b), d.trigger("uploadError", a, b)
                }).always(function () { d.trigger("uploadComplete", a) })
            }, updateFileProgress: function (a) { var b = 0, c = 0; a.blocks && (f.each(a.blocks, function (a, b) { c += (b.percentage || 0) * (b.end - b.start) }), b = c / a.size, this.owner.trigger("uploadProgress", a, b || 0)) }
        })
    }), b("widgets/validator", ["base", "uploader", "file", "widgets/widget"], function (a, b, c) { var d, e = a.$, f = {}; return d = { addValidator: function (a, b) { f[a] = b }, removeValidator: function (a) { delete f[a] } }, b.register({ name: "validator", init: function () { var b = this; a.nextTick(function () { e.each(f, function () { this.call(b.owner) }) }) } }), d.addValidator("fileNumLimit", function () { var a = this, b = a.options, c = 0, d = parseInt(b.fileNumLimit, 10), e = !0; d && (a.on("beforeFileQueued", function (a) { return c >= d && e && (e = !1, this.trigger("error", "Q_EXCEED_NUM_LIMIT", d, a), setTimeout(function () { e = !0 }, 1)), c >= d ? !1 : !0 }), a.on("fileQueued", function () { c++ }), a.on("fileDequeued", function () { c-- }), a.on("reset", function () { c = 0 })) }), d.addValidator("fileSizeLimit", function () { var a = this, b = a.options, c = 0, d = parseInt(b.fileSizeLimit, 10), e = !0; d && (a.on("beforeFileQueued", function (a) { var b = c + a.size > d; return b && e && (e = !1, this.trigger("error", "Q_EXCEED_SIZE_LIMIT", d, a), setTimeout(function () { e = !0 }, 1)), b ? !1 : !0 }), a.on("fileQueued", function (a) { c += a.size }), a.on("fileDequeued", function (a) { c -= a.size }), a.on("reset", function () { c = 0 })) }), d.addValidator("fileSingleSizeLimit", function () { var a = this, b = a.options, d = b.fileSingleSizeLimit; d && a.on("beforeFileQueued", function (a) { return a.size > d ? (a.setStatus(c.Status.INVALID, "exceed_size"), this.trigger("error", "F_EXCEED_SIZE", d, a), !1) : void 0 }) }), d.addValidator("duplicate", function () { function a(a) { for (var b, c = 0, d = 0, e = a.length; e > d; d++)b = a.charCodeAt(d), c = b + (c << 6) + (c << 16) - c; return c } var b = this, c = b.options, d = {}; c.duplicate || (b.on("beforeFileQueued", function (b) { var c = b.__hash || (b.__hash = a(b.name + b.size + b.lastModifiedDate)); return d[c] ? (this.trigger("error", "F_DUPLICATE", b), !1) : void 0 }), b.on("fileQueued", function (a) { var b = a.__hash; b && (d[b] = !0) }), b.on("fileDequeued", function (a) { var b = a.__hash; b && delete d[b] }), b.on("reset", function () { d = {} })) }), d }), b("lib/md5", ["runtime/client", "mediator"], function (a, b) { function c() { a.call(this, "Md5") } return b.installTo(c.prototype), c.prototype.loadFromBlob = function (a) { var b = this; b.getRuid() && b.disconnectRuntime(), b.connectRuntime(a.ruid, function () { b.exec("init"), b.exec("loadFromBlob", a) }) }, c.prototype.getResult = function () { return this.exec("getResult") }, c }), b("widgets/md5", ["base", "uploader", "lib/md5", "lib/blob", "widgets/widget"], function (a, b, c, d) { return b.register({ name: "md5", md5File: function (b, e, f) { var g = new c, h = a.Deferred(), i = b instanceof d ? b : this.request("get-file", b).source; return g.on("progress load", function (a) { a = a || {}, h.notify(a.total ? a.loaded / a.total : 1) }), g.on("complete", function () { h.resolve(g.getResult()) }), g.on("error", function (a) { h.reject(a) }), arguments.length > 1 && (e = e || 0, f = f || 0, 0 > e && (e = i.size + e), 0 > f && (f = i.size + f), f = Math.min(f, i.size), i = i.slice(e, f)), g.loadFromBlob(i), h.promise() } }) }), b("runtime/compbase", [], function () { function a(a, b) { this.owner = a, this.options = a.options, this.getRuntime = function () { return b }, this.getRuid = function () { return b.uid }, this.trigger = function () { return a.trigger.apply(a, arguments) } } return a }), b("runtime/html5/runtime", ["base", "runtime/runtime", "runtime/compbase"], function (b, c, d) { function e() { var a = {}, d = this, e = this.destroy; c.apply(d, arguments), d.type = f, d.exec = function (c, e) { var f, h = this, i = h.uid, j = b.slice(arguments, 2); return g[c] && (f = a[i] = a[i] || new g[c](h, d), f[e]) ? f[e].apply(f, j) : void 0 }, d.destroy = function () { return e && e.apply(this, arguments) } } var f = "html5", g = {}; return b.inherits(c, { constructor: e, init: function () { var a = this; setTimeout(function () { a.trigger("ready") }, 1) } }), e.register = function (a, c) { var e = g[a] = b.inherits(d, c); return e }, a.Blob && a.FileReader && a.DataView && c.addRuntime(f, e), e }), b("runtime/html5/blob", ["runtime/html5/runtime", "lib/blob"], function (a, b) { return a.register("Blob", { slice: function (a, c) { var d = this.owner.source, e = d.slice || d.webkitSlice || d.mozSlice; return d = e.call(d, a, c), new b(this.getRuid(), d) } }) }), b("runtime/html5/dnd", ["base", "runtime/html5/runtime", "lib/file"], function (a, b, c) { var d = a.$, e = "webuploader-dnd-"; return b.register("DragAndDrop", { init: function () { var b = this.elem = this.options.container; this.dragEnterHandler = a.bindFn(this._dragEnterHandler, this), this.dragOverHandler = a.bindFn(this._dragOverHandler, this), this.dragLeaveHandler = a.bindFn(this._dragLeaveHandler, this), this.dropHandler = a.bindFn(this._dropHandler, this), this.dndOver = !1, b.on("dragenter", this.dragEnterHandler), b.on("dragover", this.dragOverHandler), b.on("dragleave", this.dragLeaveHandler), b.on("drop", this.dropHandler), this.options.disableGlobalDnd && (d(document).on("dragover", this.dragOverHandler), d(document).on("drop", this.dropHandler)) }, _dragEnterHandler: function (a) { var b, c = this, d = c._denied || !1; return a = a.originalEvent || a, c.dndOver || (c.dndOver = !0, b = a.dataTransfer.items, b && b.length && (c._denied = d = !c.trigger("accept", b)), c.elem.addClass(e + "over"), c.elem[d ? "addClass" : "removeClass"](e + "denied")), a.dataTransfer.dropEffect = d ? "none" : "copy", !1 }, _dragOverHandler: function (a) { var b = this.elem.parent().get(0); return b && !d.contains(b, a.currentTarget) ? !1 : (clearTimeout(this._leaveTimer), this._dragEnterHandler.call(this, a), !1) }, _dragLeaveHandler: function () { var a, b = this; return a = function () { b.dndOver = !1, b.elem.removeClass(e + "over " + e + "denied") }, clearTimeout(b._leaveTimer), b._leaveTimer = setTimeout(a, 100), !1 }, _dropHandler: function (a) { var b, f, g = this, h = g.getRuid(), i = g.elem.parent().get(0); if (i && !d.contains(i, a.currentTarget)) return !1; a = a.originalEvent || a, b = a.dataTransfer; try { f = b.getData("text/html") } catch (j) { } return f ? void 0 : (g._getTansferFiles(b, function (a) { g.trigger("drop", d.map(a, function (a) { return new c(h, a) })) }), g.dndOver = !1, g.elem.removeClass(e + "over"), !1) }, _getTansferFiles: function (b, c) { var d, e, f, g, h, i, j, k = [], l = []; for (d = b.items, e = b.files, j = !(!d || !d[0].webkitGetAsEntry), h = 0, i = e.length; i > h; h++)f = e[h], g = d && d[h], j && g.webkitGetAsEntry().isDirectory ? l.push(this._traverseDirectoryTree(g.webkitGetAsEntry(), k)) : k.push(f); a.when.apply(a, l).done(function () { k.length && c(k) }) }, _traverseDirectoryTree: function (b, c) { var d = a.Deferred(), e = this; return b.isFile ? b.file(function (a) { c.push(a), d.resolve() }) : b.isDirectory && b.createReader().readEntries(function (b) { var f, g = b.length, h = [], i = []; for (f = 0; g > f; f++)h.push(e._traverseDirectoryTree(b[f], i)); a.when.apply(a, h).then(function () { c.push.apply(c, i), d.resolve() }, d.reject) }), d.promise() }, destroy: function () { var a = this.elem; a && (a.off("dragenter", this.dragEnterHandler), a.off("dragover", this.dragOverHandler), a.off("dragleave", this.dragLeaveHandler), a.off("drop", this.dropHandler), this.options.disableGlobalDnd && (d(document).off("dragover", this.dragOverHandler), d(document).off("drop", this.dropHandler))) } }) }), b("runtime/html5/filepaste", ["base", "runtime/html5/runtime", "lib/file"], function (a, b, c) { return b.register("FilePaste", { init: function () { var b, c, d, e, f = this.options, g = this.elem = f.container, h = ".*"; if (f.accept) { for (b = [], c = 0, d = f.accept.length; d > c; c++)e = f.accept[c].mimeTypes, e && b.push(e); b.length && (h = b.join(","), h = h.replace(/,/g, "|").replace(/\*/g, ".*")) } this.accept = h = new RegExp(h, "i"), this.hander = a.bindFn(this._pasteHander, this), g.on("paste", this.hander) }, _pasteHander: function (a) { var b, d, e, f, g, h = [], i = this.getRuid(); for (a = a.originalEvent || a, b = a.clipboardData.items, f = 0, g = b.length; g > f; f++)d = b[f], "file" === d.kind && (e = d.getAsFile()) && h.push(new c(i, e)); h.length && (a.preventDefault(), a.stopPropagation(), this.trigger("paste", h)) }, destroy: function () { this.elem.off("paste", this.hander) } }) }), b("runtime/html5/filepicker", ["base", "runtime/html5/runtime"], function (a, b) { var c = a.$; return b.register("FilePicker", { init: function () { var a, b, d, e, f = this.getRuntime().getContainer(), g = this, h = g.owner, i = g.options, j = this.label = c(document.createElement("label")), k = this.input = c(document.createElement("input")); if (k.attr("type", "file"), k.attr("name", i.name), k.addClass("webuploader-element-invisible"), j.on("click", function () { k.trigger("click") }), j.css({ opacity: 0, width: "100%", height: "100%", display: "block", cursor: "pointer", background: "#ffffff" }), i.multiple && k.attr("multiple", "multiple"), i.accept && i.accept.length > 0) { for (a = [], b = 0, d = i.accept.length; d > b; b++)a.push(i.accept[b].mimeTypes); k.attr("accept", a.join(",")) } f.append(k), f.append(j), e = function (a) { h.trigger(a.type) }, k.on("change", function (a) { var b, d = arguments.callee; g.files = a.target.files, b = this.cloneNode(!0), b.value = null, this.parentNode.replaceChild(b, this), k.off(), k = c(b).on("change", d).on("mouseenter mouseleave", e), h.trigger("change") }), j.on("mouseenter mouseleave", e) }, getFiles: function () { return this.files }, destroy: function () { this.input.off(), this.label.off() } }) }), b("runtime/html5/util", ["base"], function (b) { var c = a.createObjectURL && a || a.URL && URL.revokeObjectURL && URL || a.webkitURL, d = b.noop, e = d; return c && (d = function () { return c.createObjectURL.apply(c, arguments) }, e = function () { return c.revokeObjectURL.apply(c, arguments) }), { createObjectURL: d, revokeObjectURL: e, dataURL2Blob: function (a) { var b, c, d, e, f, g; for (g = a.split(","), b = ~g[0].indexOf("base64") ? atob(g[1]) : decodeURIComponent(g[1]), d = new ArrayBuffer(b.length), c = new Uint8Array(d), e = 0; e < b.length; e++)c[e] = b.charCodeAt(e); return f = g[0].split(":")[1].split(";")[0], this.arrayBufferToBlob(d, f) }, dataURL2ArrayBuffer: function (a) { var b, c, d, e; for (e = a.split(","), b = ~e[0].indexOf("base64") ? atob(e[1]) : decodeURIComponent(e[1]), c = new Uint8Array(b.length), d = 0; d < b.length; d++)c[d] = b.charCodeAt(d); return c.buffer }, arrayBufferToBlob: function (b, c) { var d, e = a.BlobBuilder || a.WebKitBlobBuilder; return e ? (d = new e, d.append(b), d.getBlob(c)) : new Blob([b], c ? { type: c } : {}) }, canvasToDataUrl: function (a, b, c) { return a.toDataURL(b, c / 100) }, parseMeta: function (a, b) { b(!1, {}) }, updateImageHead: function (a) { return a } } }), b("runtime/html5/imagemeta", ["runtime/html5/util"], function (a) { var b; return b = { parsers: { 65505: [] }, maxMetaDataSize: 262144, parse: function (a, b) { var c = this, d = new FileReader; d.onload = function () { b(!1, c._parse(this.result)), d = d.onload = d.onerror = null }, d.onerror = function (a) { b(a.message), d = d.onload = d.onerror = null }, a = a.slice(0, c.maxMetaDataSize), d.readAsArrayBuffer(a.getSource()) }, _parse: function (a, c) { if (!(a.byteLength < 6)) { var d, e, f, g, h = new DataView(a), i = 2, j = h.byteLength - 4, k = i, l = {}; if (65496 === h.getUint16(0)) { for (; j > i && (d = h.getUint16(i), d >= 65504 && 65519 >= d || 65534 === d) && (e = h.getUint16(i + 2) + 2, !(i + e > h.byteLength));) { if (f = b.parsers[d], !c && f) for (g = 0; g < f.length; g += 1)f[g].call(b, h, i, e, l); i += e, k = i } k > 6 && (l.imageHead = a.slice ? a.slice(2, k) : new Uint8Array(a).subarray(2, k)) } return l } }, updateImageHead: function (a, b) { var c, d, e, f = this._parse(a, !0); return e = 2, f.imageHead && (e = 2 + f.imageHead.byteLength), d = a.slice ? a.slice(e) : new Uint8Array(a).subarray(e), c = new Uint8Array(b.byteLength + 2 + d.byteLength), c[0] = 255, c[1] = 216, c.set(new Uint8Array(b), 2), c.set(new Uint8Array(d), b.byteLength + 2), c.buffer } }, a.parseMeta = function () { return b.parse.apply(b, arguments) }, a.updateImageHead = function () { return b.updateImageHead.apply(b, arguments) }, b }), b("runtime/html5/imagemeta/exif", ["base", "runtime/html5/imagemeta"], function (a, b) { var c = {}; return c.ExifMap = function () { return this }, c.ExifMap.prototype.map = { Orientation: 274 }, c.ExifMap.prototype.get = function (a) { return this[a] || this[this.map[a]] }, c.exifTagTypes = { 1: { getValue: function (a, b) { return a.getUint8(b) }, size: 1 }, 2: { getValue: function (a, b) { return String.fromCharCode(a.getUint8(b)) }, size: 1, ascii: !0 }, 3: { getValue: function (a, b, c) { return a.getUint16(b, c) }, size: 2 }, 4: { getValue: function (a, b, c) { return a.getUint32(b, c) }, size: 4 }, 5: { getValue: function (a, b, c) { return a.getUint32(b, c) / a.getUint32(b + 4, c) }, size: 8 }, 9: { getValue: function (a, b, c) { return a.getInt32(b, c) }, size: 4 }, 10: { getValue: function (a, b, c) { return a.getInt32(b, c) / a.getInt32(b + 4, c) }, size: 8 } }, c.exifTagTypes[7] = c.exifTagTypes[1], c.getExifValue = function (b, d, e, f, g, h) { var i, j, k, l, m, n, o = c.exifTagTypes[f]; if (!o) return void a.log("Invalid Exif data: Invalid tag type."); if (i = o.size * g, j = i > 4 ? d + b.getUint32(e + 8, h) : e + 8, j + i > b.byteLength) return void a.log("Invalid Exif data: Invalid data offset."); if (1 === g) return o.getValue(b, j, h); for (k = [], l = 0; g > l; l += 1)k[l] = o.getValue(b, j + l * o.size, h); if (o.ascii) { for (m = "", l = 0; l < k.length && (n = k[l], "\x00" !== n); l += 1)m += n; return m } return k }, c.parseExifTag = function (a, b, d, e, f) { var g = a.getUint16(d, e); f.exif[g] = c.getExifValue(a, b, d, a.getUint16(d + 2, e), a.getUint32(d + 4, e), e) }, c.parseExifTags = function (b, c, d, e, f) { var g, h, i; if (d + 6 > b.byteLength) return void a.log("Invalid Exif data: Invalid directory offset."); if (g = b.getUint16(d, e), h = d + 2 + 12 * g, h + 4 > b.byteLength) return void a.log("Invalid Exif data: Invalid directory size."); for (i = 0; g > i; i += 1)this.parseExifTag(b, c, d + 2 + 12 * i, e, f); return b.getUint32(h, e) }, c.parseExifData = function (b, d, e, f) { var g, h, i = d + 10; if (1165519206 === b.getUint32(d + 4)) { if (i + 8 > b.byteLength) return void a.log("Invalid Exif data: Invalid segment size."); if (0 !== b.getUint16(d + 8)) return void a.log("Invalid Exif data: Missing byte alignment offset."); switch (b.getUint16(i)) { case 18761: g = !0; break; case 19789: g = !1; break; default: return void a.log("Invalid Exif data: Invalid byte alignment marker.") }if (42 !== b.getUint16(i + 2, g)) return void a.log("Invalid Exif data: Missing TIFF marker."); h = b.getUint32(i + 4, g), f.exif = new c.ExifMap, h = c.parseExifTags(b, i, i + h, g, f) } }, b.parsers[65505].push(c.parseExifData), c }), b("runtime/html5/jpegencoder", [], function () { function a(a) { function b(a) { for (var b = [16, 11, 10, 16, 24, 40, 51, 61, 12, 12, 14, 19, 26, 58, 60, 55, 14, 13, 16, 24, 40, 57, 69, 56, 14, 17, 22, 29, 51, 87, 80, 62, 18, 22, 37, 56, 68, 109, 103, 77, 24, 35, 55, 64, 81, 104, 113, 92, 49, 64, 78, 87, 103, 121, 120, 101, 72, 92, 95, 98, 112, 100, 103, 99], c = 0; 64 > c; c++) { var d = y((b[c] * a + 50) / 100); 1 > d ? d = 1 : d > 255 && (d = 255), z[P[c]] = d } for (var e = [17, 18, 24, 47, 99, 99, 99, 99, 18, 21, 26, 66, 99, 99, 99, 99, 24, 26, 56, 99, 99, 99, 99, 99, 47, 66, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99, 99], f = 0; 64 > f; f++) { var g = y((e[f] * a + 50) / 100); 1 > g ? g = 1 : g > 255 && (g = 255), A[P[f]] = g } for (var h = [1, 1.387039845, 1.306562965, 1.175875602, 1, .785694958, .5411961, .275899379], i = 0, j = 0; 8 > j; j++)for (var k = 0; 8 > k; k++)B[i] = 1 / (z[P[i]] * h[j] * h[k] * 8), C[i] = 1 / (A[P[i]] * h[j] * h[k] * 8), i++ } function c(a, b) { for (var c = 0, d = 0, e = new Array, f = 1; 16 >= f; f++) { for (var g = 1; g <= a[f]; g++)e[b[d]] = [], e[b[d]][0] = c, e[b[d]][1] = f, d++ , c++; c *= 2 } return e } function d() { t = c(Q, R), u = c(U, V), v = c(S, T), w = c(W, X) } function e() { for (var a = 1, b = 2, c = 1; 15 >= c; c++) { for (var d = a; b > d; d++)E[32767 + d] = c, D[32767 + d] = [], D[32767 + d][1] = c, D[32767 + d][0] = d; for (var e = -(b - 1); -a >= e; e++)E[32767 + e] = c, D[32767 + e] = [], D[32767 + e][1] = c, D[32767 + e][0] = b - 1 + e; a <<= 1, b <<= 1 } } function f() { for (var a = 0; 256 > a; a++)O[a] = 19595 * a, O[a + 256 >> 0] = 38470 * a, O[a + 512 >> 0] = 7471 * a + 32768, O[a + 768 >> 0] = -11059 * a, O[a + 1024 >> 0] = -21709 * a, O[a + 1280 >> 0] = 32768 * a + 8421375, O[a + 1536 >> 0] = -27439 * a, O[a + 1792 >> 0] = -5329 * a } function g(a) { for (var b = a[0], c = a[1] - 1; c >= 0;)b & 1 << c && (I |= 1 << J), c-- , J-- , 0 > J && (255 == I ? (h(255), h(0)) : h(I), J = 7, I = 0) } function h(a) { H.push(N[a]) } function i(a) { h(a >> 8 & 255), h(255 & a) } function j(a, b) { var c, d, e, f, g, h, i, j, k, l = 0, m = 8, n = 64; for (k = 0; m > k; ++k) { c = a[l], d = a[l + 1], e = a[l + 2], f = a[l + 3], g = a[l + 4], h = a[l + 5], i = a[l + 6], j = a[l + 7]; var o = c + j, p = c - j, q = d + i, r = d - i, s = e + h, t = e - h, u = f + g, v = f - g, w = o + u, x = o - u, y = q + s, z = q - s; a[l] = w + y, a[l + 4] = w - y; var A = .707106781 * (z + x); a[l + 2] = x + A, a[l + 6] = x - A, w = v + t, y = t + r, z = r + p; var B = .382683433 * (w - z), C = .5411961 * w + B, D = 1.306562965 * z + B, E = .707106781 * y, G = p + E, H = p - E; a[l + 5] = H + C, a[l + 3] = H - C, a[l + 1] = G + D, a[l + 7] = G - D, l += 8 } for (l = 0, k = 0; m > k; ++k) { c = a[l], d = a[l + 8], e = a[l + 16], f = a[l + 24], g = a[l + 32], h = a[l + 40], i = a[l + 48], j = a[l + 56]; var I = c + j, J = c - j, K = d + i, L = d - i, M = e + h, N = e - h, O = f + g, P = f - g, Q = I + O, R = I - O, S = K + M, T = K - M; a[l] = Q + S, a[l + 32] = Q - S; var U = .707106781 * (T + R); a[l + 16] = R + U, a[l + 48] = R - U, Q = P + N, S = N + L, T = L + J; var V = .382683433 * (Q - T), W = .5411961 * Q + V, X = 1.306562965 * T + V, Y = .707106781 * S, Z = J + Y, $ = J - Y; a[l + 40] = $ + W, a[l + 24] = $ - W, a[l + 8] = Z + X, a[l + 56] = Z - X, l++ } var _; for (k = 0; n > k; ++k)_ = a[k] * b[k], F[k] = _ > 0 ? _ + .5 | 0 : _ - .5 | 0; return F } function k() { i(65504), i(16), h(74), h(70), h(73), h(70), h(0), h(1), h(1), h(0), i(1), i(1), h(0), h(0) } function l(a, b) { i(65472), i(17), h(8), i(b), i(a), h(3), h(1), h(17), h(0), h(2), h(17), h(1), h(3), h(17), h(1) } function m() { i(65499), i(132), h(0); for (var a = 0; 64 > a; a++)h(z[a]); h(1); for (var b = 0; 64 > b; b++)h(A[b]) } function n() { i(65476), i(418), h(0); for (var a = 0; 16 > a; a++)h(Q[a + 1]); for (var b = 0; 11 >= b; b++)h(R[b]); h(16); for (var c = 0; 16 > c; c++)h(S[c + 1]); for (var d = 0; 161 >= d; d++)h(T[d]); h(1); for (var e = 0; 16 > e; e++)h(U[e + 1]); for (var f = 0; 11 >= f; f++)h(V[f]); h(17); for (var g = 0; 16 > g; g++)h(W[g + 1]); for (var j = 0; 161 >= j; j++)h(X[j]) } function o() { i(65498), i(12), h(3), h(1), h(0), h(2), h(17), h(3), h(17), h(0), h(63), h(0) } function p(a, b, c, d, e) { for (var f, h = e[0], i = e[240], k = 16, l = 63, m = 64, n = j(a, b), o = 0; m > o; ++o)G[P[o]] = n[o]; var p = G[0] - c; c = G[0], 0 == p ? g(d[0]) : (f = 32767 + p, g(d[E[f]]), g(D[f])); for (var q = 63; q > 0 && 0 == G[q]; q--); if (0 == q) return g(h), c; for (var r, s = 1; q >= s;) { for (var t = s; 0 == G[s] && q >= s; ++s); var u = s - t; if (u >= k) { r = u >> 4; for (var v = 1; r >= v; ++v)g(i); u = 15 & u } f = 32767 + G[s], g(e[(u << 4) + E[f]]), g(D[f]), s++ } return q != l && g(h), c } function q() { for (var a = String.fromCharCode, b = 0; 256 > b; b++)N[b] = a(b) } function r(a) { if (0 >= a && (a = 1), a > 100 && (a = 100), x != a) { var c = 0; c = Math.floor(50 > a ? 5e3 / a : 200 - 2 * a), b(c), x = a } } function s() { a || (a = 50), q(), d(), e(), f(), r(a) } var t, u, v, w, x, y = (Math.round, Math.floor), z = new Array(64), A = new Array(64), B = new Array(64), C = new Array(64), D = new Array(65535), E = new Array(65535), F = new Array(64), G = new Array(64), H = [], I = 0, J = 7, K = new Array(64), L = new Array(64), M = new Array(64), N = new Array(256), O = new Array(2048), P = [0, 1, 5, 6, 14, 15, 27, 28, 2, 4, 7, 13, 16, 26, 29, 42, 3, 8, 12, 17, 25, 30, 41, 43, 9, 11, 18, 24, 31, 40, 44, 53, 10, 19, 23, 32, 39, 45, 52, 54, 20, 22, 33, 38, 46, 51, 55, 60, 21, 34, 37, 47, 50, 56, 59, 61, 35, 36, 48, 49, 57, 58, 62, 63], Q = [0, 0, 1, 5, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0], R = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], S = [0, 0, 2, 1, 3, 3, 2, 4, 3, 5, 5, 4, 4, 0, 0, 1, 125], T = [1, 2, 3, 0, 4, 17, 5, 18, 33, 49, 65, 6, 19, 81, 97, 7, 34, 113, 20, 50, 129, 145, 161, 8, 35, 66, 177, 193, 21, 82, 209, 240, 36, 51, 98, 114, 130, 9, 10, 22, 23, 24, 25, 26, 37, 38, 39, 40, 41, 42, 52, 53, 54, 55, 56, 57, 58, 67, 68, 69, 70, 71, 72, 73, 74, 83, 84, 85, 86, 87, 88, 89, 90, 99, 100, 101, 102, 103, 104, 105, 106, 115, 116, 117, 118, 119, 120, 121, 122, 131, 132, 133, 134, 135, 136, 137, 138, 146, 147, 148, 149, 150, 151, 152, 153, 154, 162, 163, 164, 165, 166, 167, 168, 169, 170, 178, 179, 180, 181, 182, 183, 184, 185, 186, 194, 195, 196, 197, 198, 199, 200, 201, 202, 210, 211, 212, 213, 214, 215, 216, 217, 218, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250], U = [0, 0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0], V = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], W = [0, 0, 2, 1, 2, 4, 4, 3, 4, 7, 5, 4, 4, 0, 1, 2, 119], X = [0, 1, 2, 3, 17, 4, 5, 33, 49, 6, 18, 65, 81, 7, 97, 113, 19, 34, 50, 129, 8, 20, 66, 145, 161, 177, 193, 9, 35, 51, 82, 240, 21, 98, 114, 209, 10, 22, 36, 52, 225, 37, 241, 23, 24, 25, 26, 38, 39, 40, 41, 42, 53, 54, 55, 56, 57, 58, 67, 68, 69, 70, 71, 72, 73, 74, 83, 84, 85, 86, 87, 88, 89, 90, 99, 100, 101, 102, 103, 104, 105, 106, 115, 116, 117, 118, 119, 120, 121, 122, 130, 131, 132, 133, 134, 135, 136, 137, 138, 146, 147, 148, 149, 150, 151, 152, 153, 154, 162, 163, 164, 165, 166, 167, 168, 169, 170, 178, 179, 180, 181, 182, 183, 184, 185, 186, 194, 195, 196, 197, 198, 199, 200, 201, 202, 210, 211, 212, 213, 214, 215, 216, 217, 218, 226, 227, 228, 229, 230, 231, 232, 233, 234, 242, 243, 244, 245, 246, 247, 248, 249, 250]; this.encode = function (a, b) { b && r(b), H = new Array, I = 0, J = 7, i(65496), k(), m(), l(a.width, a.height), n(), o(); var c = 0, d = 0, e = 0; I = 0, J = 7, this.encode.displayName = "_encode_"; for (var f, h, j, q, s, x, y, z, A, D = a.data, E = a.width, F = a.height, G = 4 * E, N = 0; F > N;) { for (f = 0; G > f;) { for (s = G * N + f, x = s, y = -1, z = 0, A = 0; 64 > A; A++)z = A >> 3, y = 4 * (7 & A), x = s + z * G + y, N + z >= F && (x -= G * (N + 1 + z - F)), f + y >= G && (x -= f + y - G + 4), h = D[x++], j = D[x++], q = D[x++], K[A] = (O[h] + O[j + 256 >> 0] + O[q + 512 >> 0] >> 16) - 128, L[A] = (O[h + 768 >> 0] + O[j + 1024 >> 0] + O[q + 1280 >> 0] >> 16) - 128, M[A] = (O[h + 1280 >> 0] + O[j + 1536 >> 0] + O[q + 1792 >> 0] >> 16) - 128; c = p(K, B, c, t, v), d = p(L, C, d, u, w), e = p(M, C, e, u, w), f += 32 } N += 8 } if (J >= 0) { var P = []; P[1] = J + 1, P[0] = (1 << J + 1) - 1, g(P) } i(65497); var Q = "data:image/jpeg;base64," + btoa(H.join("")); return H = [], Q }, s() } return a.encode = function (b, c) { var d = new a(c); return d.encode(b) }, a }), b("runtime/html5/androidpatch", ["runtime/html5/util", "runtime/html5/jpegencoder", "base"], function (a, b, c) { var d, e = a.canvasToDataUrl; a.canvasToDataUrl = function (a, f, g) { var h, i, j, k, l; return c.os.android ? ("image/jpeg" === f && "undefined" == typeof d && (k = e.apply(null, arguments), l = k.split(","), k = ~l[0].indexOf("base64") ? atob(l[1]) : decodeURIComponent(l[1]), k = k.substring(0, 2), d = 255 === k.charCodeAt(0) && 216 === k.charCodeAt(1)), "image/jpeg" !== f || d ? e.apply(null, arguments) : (i = a.width, j = a.height, h = a.getContext("2d"), b.encode(h.getImageData(0, 0, i, j), g))) : e.apply(null, arguments) } }), b("runtime/html5/image", ["base", "runtime/html5/runtime", "runtime/html5/util"], function (a, b, c) { var d = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs%3D"; return b.register("Image", { modified: !1, init: function () { var a = this, b = new Image; b.onload = function () { a._info = { type: a.type, width: this.width, height: this.height }, a._metas || "image/jpeg" !== a.type ? a.owner.trigger("load") : c.parseMeta(a._blob, function (b, c) { a._metas = c, a.owner.trigger("load") }) }, b.onerror = function () { a.owner.trigger("error") }, a._img = b }, loadFromBlob: function (a) { var b = this, d = b._img; b._blob = a, b.type = a.type, d.src = c.createObjectURL(a.getSource()), b.owner.once("load", function () { c.revokeObjectURL(d.src) }) }, resize: function (a, b) { var c = this._canvas || (this._canvas = document.createElement("canvas")); this._resize(this._img, c, a, b), this._blob = null, this.modified = !0, this.owner.trigger("complete", "resize") }, crop: function (a, b, c, d, e) { var f = this._canvas || (this._canvas = document.createElement("canvas")), g = this.options, h = this._img, i = h.naturalWidth, j = h.naturalHeight, k = this.getOrientation(); e = e || 1, f.width = c, f.height = d, g.preserveHeaders || this._rotate2Orientaion(f, k), this._renderImageToCanvas(f, h, -a, -b, i * e, j * e), this._blob = null, this.modified = !0, this.owner.trigger("complete", "crop") }, getAsBlob: function (a) { var b, d = this._blob, e = this.options; if (a = a || this.type, this.modified || this.type !== a) { if (b = this._canvas, "image/jpeg" === a) { if (d = c.canvasToDataUrl(b, a, e.quality), e.preserveHeaders && this._metas && this._metas.imageHead) return d = c.dataURL2ArrayBuffer(d), d = c.updateImageHead(d, this._metas.imageHead), d = c.arrayBufferToBlob(d, a) } else d = c.canvasToDataUrl(b, a); d = c.dataURL2Blob(d) } return d }, getAsDataUrl: function (a) { var b = this.options; return a = a || this.type, "image/jpeg" === a ? c.canvasToDataUrl(this._canvas, a, b.quality) : this._canvas.toDataURL(a) }, getOrientation: function () { return this._metas && this._metas.exif && this._metas.exif.get("Orientation") || 1 }, info: function (a) { return a ? (this._info = a, this) : this._info }, meta: function (a) { return a ? (this._meta = a, this) : this._meta }, destroy: function () { var a = this._canvas; this._img.onload = null, a && (a.getContext("2d").clearRect(0, 0, a.width, a.height), a.width = a.height = 0, this._canvas = null), this._img.src = d, this._img = this._blob = null }, _resize: function (a, b, c, d) { var e, f, g, h, i, j = this.options, k = a.width, l = a.height, m = this.getOrientation(); ~[5, 6, 7, 8].indexOf(m) && (c ^= d, d ^= c, c ^= d), e = Math[j.crop ? "max" : "min"](c / k, d / l), j.allowMagnify || (e = Math.min(1, e)), f = k * e, g = l * e, j.crop ? (b.width = c, b.height = d) : (b.width = f, b.height = g), h = (b.width - f) / 2, i = (b.height - g) / 2, j.preserveHeaders || this._rotate2Orientaion(b, m), this._renderImageToCanvas(b, a, h, i, f, g) }, _rotate2Orientaion: function (a, b) { var c = a.width, d = a.height, e = a.getContext("2d"); switch (b) { case 5: case 6: case 7: case 8: a.width = d, a.height = c }switch (b) { case 2: e.translate(c, 0), e.scale(-1, 1); break; case 3: e.translate(c, d), e.rotate(Math.PI); break; case 4: e.translate(0, d), e.scale(1, -1); break; case 5: e.rotate(.5 * Math.PI), e.scale(1, -1); break; case 6: e.rotate(.5 * Math.PI), e.translate(0, -d); break; case 7: e.rotate(.5 * Math.PI), e.translate(c, -d), e.scale(-1, 1); break; case 8: e.rotate(-.5 * Math.PI), e.translate(-c, 0) } }, _renderImageToCanvas: function () { function b(a, b, c) { var d, e, f, g = document.createElement("canvas"), h = g.getContext("2d"), i = 0, j = c, k = c; for (g.width = 1, g.height = c, h.drawImage(a, 0, 0), d = h.getImageData(0, 0, 1, c).data; k > i;)e = d[4 * (k - 1) + 3], 0 === e ? j = k : i = k, k = j + i >> 1; return f = k / c, 0 === f ? 1 : f } function c(a) { var b, c, d = a.naturalWidth, e = a.naturalHeight; return d * e > 1048576 ? (b = document.createElement("canvas"), b.width = b.height = 1, c = b.getContext("2d"), c.drawImage(a, -d + 1, 0), 0 === c.getImageData(0, 0, 1, 1).data[3]) : !1 } return a.os.ios ? a.os.ios >= 7 ? function (a, c, d, e, f, g) { var h = c.naturalWidth, i = c.naturalHeight, j = b(c, h, i); return a.getContext("2d").drawImage(c, 0, 0, h * j, i * j, d, e, f, g) } : function (a, d, e, f, g, h) { var i, j, k, l, m, n, o, p = d.naturalWidth, q = d.naturalHeight, r = a.getContext("2d"), s = c(d), t = "image/jpeg" === this.type, u = 1024, v = 0, w = 0; for (s && (p /= 2, q /= 2), r.save(), i = document.createElement("canvas"), i.width = i.height = u, j = i.getContext("2d"), k = t ? b(d, p, q) : 1, l = Math.ceil(u * g / p), m = Math.ceil(u * h / q / k); q > v;) { for (n = 0, o = 0; p > n;)j.clearRect(0, 0, u, u), j.drawImage(d, -n, -v), r.drawImage(i, 0, 0, u, u, e + o, f + w, l, m), n += u, o += l; v += u, w += m } r.restore(), i = j = null } : function (b) { var c = a.slice(arguments, 1), d = b.getContext("2d"); d.drawImage.apply(d, c) } }() }) }), b("runtime/html5/transport", ["base", "runtime/html5/runtime"], function (a, b) { var c = a.noop, d = a.$; return b.register("Transport", { init: function () { this._status = 0, this._response = null }, send: function () { var b, c, e, f = this.owner, g = this.options, h = this._initAjax(), i = f._blob, j = g.server; g.sendAsBinary ? (j += (/\?/.test(j) ? "&" : "?") + d.param(f._formData), c = i.getSource()) : (b = new FormData, d.each(f._formData, function (a, c) { b.append(a, c) }), b.append(g.fileVal, i.getSource(), g.filename || f._formData.name || "")), g.withCredentials && "withCredentials" in h ? (h.open(g.method, j, !0), h.withCredentials = !0) : h.open(g.method, j), this._setRequestHeader(h, g.headers), c ? (h.overrideMimeType && h.overrideMimeType("application/octet-stream"), a.os.android ? (e = new FileReader, e.onload = function () { h.send(this.result), e = e.onload = null }, e.readAsArrayBuffer(c)) : h.send(c)) : h.send(b) }, getResponse: function () { return this._response }, getResponseAsJson: function () { return this._parseJson(this._response) }, getStatus: function () { return this._status }, abort: function () { var a = this._xhr; a && (a.upload.onprogress = c, a.onreadystatechange = c, a.abort(), this._xhr = a = null) }, destroy: function () { this.abort() }, _initAjax: function () { var a = this, b = new XMLHttpRequest, d = this.options; return !d.withCredentials || "withCredentials" in b || "undefined" == typeof XDomainRequest || (b = new XDomainRequest), b.upload.onprogress = function (b) { var c = 0; return b.lengthComputable && (c = b.loaded / b.total), a.trigger("progress", c) }, b.onreadystatechange = function () { return 4 === b.readyState ? (b.upload.onprogress = c, b.onreadystatechange = c, a._xhr = null, a._status = b.status, b.status >= 200 && b.status < 300 ? (a._response = b.responseText, a.trigger("load")) : b.status >= 500 && b.status < 600 ? (a._response = b.responseText, a.trigger("error", "server")) : a.trigger("error", a._status ? "http" : "abort")) : void 0 }, a._xhr = b, b }, _setRequestHeader: function (a, b) { d.each(b, function (b, c) { a.setRequestHeader(b, c) }) }, _parseJson: function (a) { var b; try { b = JSON.parse(a) } catch (c) { b = {} } return b } }) }), b("runtime/html5/md5", ["runtime/html5/runtime"], function (a) {
        var b = function (a, b) { return a + b & 4294967295 }, c = function (a, c, d, e, f, g) { return c = b(b(c, a), b(e, g)), b(c << f | c >>> 32 - f, d) }, d = function (a, b, d, e, f, g, h) { return c(b & d | ~b & e, a, b, f, g, h) }, e = function (a, b, d, e, f, g, h) { return c(b & e | d & ~e, a, b, f, g, h) }, f = function (a, b, d, e, f, g, h) { return c(b ^ d ^ e, a, b, f, g, h) }, g = function (a, b, d, e, f, g, h) { return c(d ^ (b | ~e), a, b, f, g, h) }, h = function (a, c) { var h = a[0], i = a[1], j = a[2], k = a[3]; h = d(h, i, j, k, c[0], 7, -680876936), k = d(k, h, i, j, c[1], 12, -389564586), j = d(j, k, h, i, c[2], 17, 606105819), i = d(i, j, k, h, c[3], 22, -1044525330), h = d(h, i, j, k, c[4], 7, -176418897), k = d(k, h, i, j, c[5], 12, 1200080426), j = d(j, k, h, i, c[6], 17, -1473231341), i = d(i, j, k, h, c[7], 22, -45705983), h = d(h, i, j, k, c[8], 7, 1770035416), k = d(k, h, i, j, c[9], 12, -1958414417), j = d(j, k, h, i, c[10], 17, -42063), i = d(i, j, k, h, c[11], 22, -1990404162), h = d(h, i, j, k, c[12], 7, 1804603682), k = d(k, h, i, j, c[13], 12, -40341101), j = d(j, k, h, i, c[14], 17, -1502002290), i = d(i, j, k, h, c[15], 22, 1236535329), h = e(h, i, j, k, c[1], 5, -165796510), k = e(k, h, i, j, c[6], 9, -1069501632), j = e(j, k, h, i, c[11], 14, 643717713), i = e(i, j, k, h, c[0], 20, -373897302), h = e(h, i, j, k, c[5], 5, -701558691), k = e(k, h, i, j, c[10], 9, 38016083), j = e(j, k, h, i, c[15], 14, -660478335), i = e(i, j, k, h, c[4], 20, -405537848), h = e(h, i, j, k, c[9], 5, 568446438), k = e(k, h, i, j, c[14], 9, -1019803690), j = e(j, k, h, i, c[3], 14, -187363961), i = e(i, j, k, h, c[8], 20, 1163531501), h = e(h, i, j, k, c[13], 5, -1444681467), k = e(k, h, i, j, c[2], 9, -51403784), j = e(j, k, h, i, c[7], 14, 1735328473), i = e(i, j, k, h, c[12], 20, -1926607734), h = f(h, i, j, k, c[5], 4, -378558), k = f(k, h, i, j, c[8], 11, -2022574463), j = f(j, k, h, i, c[11], 16, 1839030562), i = f(i, j, k, h, c[14], 23, -35309556), h = f(h, i, j, k, c[1], 4, -1530992060), k = f(k, h, i, j, c[4], 11, 1272893353), j = f(j, k, h, i, c[7], 16, -155497632), i = f(i, j, k, h, c[10], 23, -1094730640), h = f(h, i, j, k, c[13], 4, 681279174), k = f(k, h, i, j, c[0], 11, -358537222), j = f(j, k, h, i, c[3], 16, -722521979), i = f(i, j, k, h, c[6], 23, 76029189), h = f(h, i, j, k, c[9], 4, -640364487), k = f(k, h, i, j, c[12], 11, -421815835), j = f(j, k, h, i, c[15], 16, 530742520), i = f(i, j, k, h, c[2], 23, -995338651), h = g(h, i, j, k, c[0], 6, -198630844), k = g(k, h, i, j, c[7], 10, 1126891415), j = g(j, k, h, i, c[14], 15, -1416354905), i = g(i, j, k, h, c[5], 21, -57434055), h = g(h, i, j, k, c[12], 6, 1700485571), k = g(k, h, i, j, c[3], 10, -1894986606), j = g(j, k, h, i, c[10], 15, -1051523), i = g(i, j, k, h, c[1], 21, -2054922799), h = g(h, i, j, k, c[8], 6, 1873313359), k = g(k, h, i, j, c[15], 10, -30611744), j = g(j, k, h, i, c[6], 15, -1560198380), i = g(i, j, k, h, c[13], 21, 1309151649), h = g(h, i, j, k, c[4], 6, -145523070), k = g(k, h, i, j, c[11], 10, -1120210379), j = g(j, k, h, i, c[2], 15, 718787259), i = g(i, j, k, h, c[9], 21, -343485551), a[0] = b(h, a[0]), a[1] = b(i, a[1]), a[2] = b(j, a[2]), a[3] = b(k, a[3]) }, i = function (a) { var b, c = []; for (b = 0; 64 > b; b += 4)c[b >> 2] = a.charCodeAt(b) + (a.charCodeAt(b + 1) << 8) + (a.charCodeAt(b + 2) << 16) + (a.charCodeAt(b + 3) << 24); return c }, j = function (a) { var b, c = []; for (b = 0; 64 > b; b += 4)c[b >> 2] = a[b] + (a[b + 1] << 8) + (a[b + 2] << 16) + (a[b + 3] << 24); return c }, k = function (a) { var b, c, d, e, f, g, j = a.length, k = [1732584193, -271733879, -1732584194, 271733878]; for (b = 64; j >= b; b += 64)h(k, i(a.substring(b - 64, b))); for (a = a.substring(b - 64), c = a.length, d = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], b = 0; c > b; b += 1)d[b >> 2] |= a.charCodeAt(b) << (b % 4 << 3); if (d[b >> 2] |= 128 << (b % 4 << 3), b > 55) for (h(k, d), b = 0; 16 > b; b += 1)d[b] = 0; return e = 8 * j, e = e.toString(16).match(/(.*?)(.{0,8})$/), f = parseInt(e[2], 16), g = parseInt(e[1], 16) || 0, d[14] = f, d[15] = g, h(k, d), k }, l = function (a) { var b, c, d, e, f, g, i = a.length, k = [1732584193, -271733879, -1732584194, 271733878]; for (b = 64; i >= b; b += 64)h(k, j(a.subarray(b - 64, b))); for (a = i > b - 64 ? a.subarray(b - 64) : new Uint8Array(0), c = a.length, d = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], b = 0; c > b; b += 1)d[b >> 2] |= a[b] << (b % 4 << 3); if (d[b >> 2] |= 128 << (b % 4 << 3), b > 55) for (h(k, d), b = 0; 16 > b; b += 1)d[b] = 0; return e = 8 * i, e = e.toString(16).match(/(.*?)(.{0,8})$/), f = parseInt(e[2], 16), g = parseInt(e[1], 16) || 0, d[14] = f, d[15] = g, h(k, d), k }, m = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f"], n = function (a) { var b, c = ""; for (b = 0; 4 > b; b += 1)c += m[a >> 8 * b + 4 & 15] + m[a >> 8 * b & 15]; return c }, o = function (a) { var b; for (b = 0; b < a.length; b += 1)a[b] = n(a[b]); return a.join("") }, p = function (a) { return o(k(a)) }, q = function () { this.reset() }; return "5d41402abc4b2a76b9719d911017c592" !== p("hello") && (b = function (a, b) { var c = (65535 & a) + (65535 & b), d = (a >> 16) + (b >> 16) + (c >> 16); return d << 16 | 65535 & c }), q.prototype.append = function (a) { return /[\u0080-\uFFFF]/.test(a) && (a = unescape(encodeURIComponent(a))), this.appendBinary(a), this }, q.prototype.appendBinary = function (a) { this._buff += a, this._length += a.length; var b, c = this._buff.length; for (b = 64; c >= b; b += 64)h(this._state, i(this._buff.substring(b - 64, b))); return this._buff = this._buff.substr(b - 64), this }, q.prototype.end = function (a) { var b, c, d = this._buff, e = d.length, f = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]; for (b = 0; e > b; b += 1)f[b >> 2] |= d.charCodeAt(b) << (b % 4 << 3); return this._finish(f, e), c = a ? this._state : o(this._state), this.reset(), c }, q.prototype._finish = function (a, b) { var c, d, e, f = b; if (a[f >> 2] |= 128 << (f % 4 << 3), f > 55) for (h(this._state, a), f = 0; 16 > f; f += 1)a[f] = 0; c = 8 * this._length, c = c.toString(16).match(/(.*?)(.{0,8})$/), d = parseInt(c[2], 16), e = parseInt(c[1], 16) || 0, a[14] = d, a[15] = e, h(this._state, a) }, q.prototype.reset = function () { return this._buff = "", this._length = 0, this._state = [1732584193, -271733879, -1732584194, 271733878], this }, q.prototype.destroy = function () { delete this._state, delete this._buff, delete this._length }, q.hash = function (a, b) { /[\u0080-\uFFFF]/.test(a) && (a = unescape(encodeURIComponent(a))); var c = k(a); return b ? c : o(c) }, q.hashBinary = function (a, b) { var c = k(a); return b ? c : o(c) }, q.ArrayBuffer = function () { this.reset() }, q.ArrayBuffer.prototype.append = function (a) { var b, c = this._concatArrayBuffer(this._buff, a), d = c.length; for (this._length += a.byteLength, b = 64; d >= b; b += 64)h(this._state, j(c.subarray(b - 64, b))); return this._buff = d > b - 64 ? c.subarray(b - 64) : new Uint8Array(0), this }, q.ArrayBuffer.prototype.end = function (a) {
            var b, c, d = this._buff, e = d.length, f = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            for (b = 0; e > b; b += 1)f[b >> 2] |= d[b] << (b % 4 << 3); return this._finish(f, e), c = a ? this._state : o(this._state), this.reset(), c
        }, q.ArrayBuffer.prototype._finish = q.prototype._finish, q.ArrayBuffer.prototype.reset = function () { return this._buff = new Uint8Array(0), this._length = 0, this._state = [1732584193, -271733879, -1732584194, 271733878], this }, q.ArrayBuffer.prototype.destroy = q.prototype.destroy, q.ArrayBuffer.prototype._concatArrayBuffer = function (a, b) { var c = a.length, d = new Uint8Array(c + b.byteLength); return d.set(a), d.set(new Uint8Array(b), c), d }, q.ArrayBuffer.hash = function (a, b) { var c = l(new Uint8Array(a)); return b ? c : o(c) }, a.register("Md5", { init: function () { }, loadFromBlob: function (a) { var b, c, d = a.getSource(), e = 2097152, f = Math.ceil(d.size / e), g = 0, h = this.owner, i = new q.ArrayBuffer, j = this, k = d.mozSlice || d.webkitSlice || d.slice; c = new FileReader, (b = function () { var l, m; l = g * e, m = Math.min(l + e, d.size), c.onload = function (b) { i.append(b.target.result), h.trigger("progress", { total: a.size, loaded: m }) }, c.onloadend = function () { c.onloadend = c.onload = null, ++g < f ? setTimeout(b, 1) : setTimeout(function () { h.trigger("load"), j.result = i.end(), b = a = d = i = null, h.trigger("complete") }, 50) }, c.readAsArrayBuffer(k.call(d, l, m)) })() }, getResult: function () { return this.result } })
    }), b("runtime/flash/runtime", ["base", "runtime/runtime", "runtime/compbase"], function (b, c, d) { function e() { var a; try { a = navigator.plugins["Shockwave Flash"], a = a.description } catch (b) { try { a = new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version") } catch (c) { a = "0.0" } } return a = a.match(/\d+/g), parseFloat(a[0] + "." + a[1], 10) } function f() { function d(a, b) { var c, d, e = a.type || a; c = e.split("::"), d = c[0], e = c[1], "Ready" === e && d === j.uid ? j.trigger("ready") : f[d] && f[d].trigger(e.toLowerCase(), a, b) } var e = {}, f = {}, g = this.destroy, j = this, k = b.guid("webuploader_"); c.apply(j, arguments), j.type = h, j.exec = function (a, c) { var d, g = this, h = g.uid, k = b.slice(arguments, 2); return f[h] = g, i[a] && (e[h] || (e[h] = new i[a](g, j)), d = e[h], d[c]) ? d[c].apply(d, k) : j.flashExec.apply(g, arguments) }, a[k] = function () { var a = arguments; setTimeout(function () { d.apply(null, a) }, 1) }, this.jsreciver = k, this.destroy = function () { return g && g.apply(this, arguments) }, this.flashExec = function (a, c) { var d = j.getFlash(), e = b.slice(arguments, 2); return d.exec(this.uid, a, c, e) } } var g = b.$, h = "flash", i = {}; return b.inherits(c, { constructor: f, init: function () { var a, c = this.getContainer(), d = this.options; c.css({ position: "absolute", top: "-8px", left: "-8px", width: "9px", height: "9px", overflow: "hidden" }), a = '<object id="' + this.uid + '" type="application/x-shockwave-flash" data="' + d.swf + '" ', b.browser.ie && (a += 'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '), a += 'width="100%" height="100%" style="outline:0"><param name="movie" value="' + d.swf + '" /><param name="flashvars" value="uid=' + this.uid + "&jsreciver=" + this.jsreciver + '" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>', c.html(a) }, getFlash: function () { return this._flash ? this._flash : (this._flash = g("#" + this.uid).get(0), this._flash) } }), f.register = function (a, c) { return c = i[a] = b.inherits(d, g.extend({ flashExec: function () { var a = this.owner, b = this.getRuntime(); return b.flashExec.apply(a, arguments) } }, c)) }, e() >= 11.4 && c.addRuntime(h, f), f }), b("runtime/flash/filepicker", ["base", "runtime/flash/runtime"], function (a, b) { var c = a.$; return b.register("FilePicker", { init: function (a) { var b, d, e = c.extend({}, a); for (b = e.accept && e.accept.length, d = 0; b > d; d++)e.accept[d].title || (e.accept[d].title = "Files"); delete e.button, delete e.id, delete e.container, this.flashExec("FilePicker", "init", e) }, destroy: function () { this.flashExec("FilePicker", "destroy") } }) }), b("runtime/flash/image", ["runtime/flash/runtime"], function (a) { return a.register("Image", { loadFromBlob: function (a) { var b = this.owner; b.info() && this.flashExec("Image", "info", b.info()), b.meta() && this.flashExec("Image", "meta", b.meta()), this.flashExec("Image", "loadFromBlob", a.uid) } }) }), b("runtime/flash/transport", ["base", "runtime/flash/runtime", "runtime/client"], function (b, c, d) { var e = b.$; return c.register("Transport", { init: function () { this._status = 0, this._response = null, this._responseJson = null }, send: function () { var a, b = this.owner, c = this.options, d = this._initAjax(), f = b._blob, g = c.server; d.connectRuntime(f.ruid), c.sendAsBinary ? (g += (/\?/.test(g) ? "&" : "?") + e.param(b._formData), a = f.uid) : (e.each(b._formData, function (a, b) { d.exec("append", a, b) }), d.exec("appendBlob", c.fileVal, f.uid, c.filename || b._formData.name || "")), this._setRequestHeader(d, c.headers), d.exec("send", { method: c.method, url: g, forceURLStream: c.forceURLStream, mimeType: "application/octet-stream" }, a) }, getStatus: function () { return this._status }, getResponse: function () { return this._response || "" }, getResponseAsJson: function () { return this._responseJson }, abort: function () { var a = this._xhr; a && (a.exec("abort"), a.destroy(), this._xhr = a = null) }, destroy: function () { this.abort() }, _initAjax: function () { var b = this, c = new d("XMLHttpRequest"); return c.on("uploadprogress progress", function (a) { var c = a.loaded / a.total; return c = Math.min(1, Math.max(0, c)), b.trigger("progress", c) }), c.on("load", function () { var d, e = c.exec("getStatus"), f = !1, g = ""; return c.off(), b._xhr = null, e >= 200 && 300 > e ? f = !0 : e >= 500 && 600 > e ? (f = !0, g = "server") : g = "http", f && (b._response = c.exec("getResponse"), b._response = decodeURIComponent(b._response), d = a.JSON && a.JSON.parse || function (a) { try { return new Function("return " + a).call() } catch (b) { return {} } }, b._responseJson = b._response ? d(b._response) : {}), c.destroy(), c = null, g ? b.trigger("error", g) : b.trigger("load") }), c.on("error", function () { c.off(), b._xhr = null, b.trigger("error", "http") }), b._xhr = c, c }, _setRequestHeader: function (a, b) { e.each(b, function (b, c) { a.exec("setRequestHeader", b, c) }) } }) }), b("runtime/flash/blob", ["runtime/flash/runtime", "lib/blob"], function (a, b) { return a.register("Blob", { slice: function (a, c) { var d = this.flashExec("Blob", "slice", a, c); return new b(d.uid, d) } }) }), b("runtime/flash/md5", ["runtime/flash/runtime"], function (a) { return a.register("Md5", { init: function () { }, loadFromBlob: function (a) { return this.flashExec("Md5", "loadFromBlob", a.uid) } }) }), b("preset/all", ["base", "widgets/filednd", "widgets/filepaste", "widgets/filepicker", "widgets/image", "widgets/queue", "widgets/runtime", "widgets/upload", "widgets/validator", "widgets/md5", "runtime/html5/blob", "runtime/html5/dnd", "runtime/html5/filepaste", "runtime/html5/filepicker", "runtime/html5/imagemeta/exif", "runtime/html5/androidpatch", "runtime/html5/image", "runtime/html5/transport", "runtime/html5/md5", "runtime/flash/filepicker", "runtime/flash/image", "runtime/flash/transport", "runtime/flash/blob", "runtime/flash/md5"], function (a) { return a }), b("widgets/log", ["base", "uploader", "widgets/widget"], function (a, b) { function c(a) { var b = e.extend({}, d, a), c = f.replace(/^(.*)\?/, "$1" + e.param(b)), g = new Image; g.src = c } var d, e = a.$, f = " http://static.tieba.baidu.com/tb/pms/img/st.gif??", g = (location.hostname || location.host || "protected").toLowerCase(), h = g && /baidu/i.exec(g); if (h) return d = { dv: 3, master: "webuploader", online: /test/.exec(g) ? 0 : 1, module: "", product: g, type: 0 }, b.register({ name: "log", init: function () { var a = this.owner, b = 0, d = 0; a.on("error", function (a) { c({ type: 2, c_error_code: a }) }).on("uploadError", function (a, b) { c({ type: 2, c_error_code: "UPLOAD_ERROR", c_reason: "" + b }) }).on("uploadComplete", function (a) { b++ , d += a.size }).on("uploadFinished", function () { c({ c_count: b, c_size: d }), b = d = 0 }), c({ c_usage: 1 }) } }) }), b("webuploader", ["preset/all", "widgets/log"], function (a) { return a }), c("webuploader")
});;
/**
 * Bootstrap Multiselect (https://github.com/davidstutz/bootstrap-multiselect)
 *
 * Apache License, Version 2.0:
 * Copyright (c) 2012 - 2015 David Stutz
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a
 * copy of the License at http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 * BSD 3-Clause License:
 * Copyright (c) 2012 - 2015 David Stutz
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *    - Redistributions of source code must retain the above copyright notice,
 *      this list of conditions and the following disclaimer.
 *    - Redistributions in binary form must reproduce the above copyright notice,
 *      this list of conditions and the following disclaimer in the documentation
 *      and/or other materials provided with the distribution.
 *    - Neither the name of David Stutz nor the names of its contributors may be
 *      used to endorse or promote products derived from this software without
 *      specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
!function ($) {
    "use strict";// jshint ;_;

    if (typeof ko !== 'undefined' && ko.bindingHandlers && !ko.bindingHandlers.multiselect) {
        ko.bindingHandlers.multiselect = {
            after: ['options', 'value', 'selectedOptions', 'enable', 'disable'],

            init: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
                var $element = $(element);
                var config = ko.toJS(valueAccessor());

                $element.multiselect(config);

                if (allBindings.has('options')) {
                    var options = allBindings.get('options');
                    if (ko.isObservable(options)) {
                        ko.computed({
                            read: function () {
                                options();
                                setTimeout(function () {
                                    var ms = $element.data('multiselect');
                                    if (ms)
                                        ms.updateOriginalOptions();//Not sure how beneficial this is.
                                    $element.multiselect('rebuild');
                                }, 1);
                            },
                            disposeWhenNodeIsRemoved: element
                        });
                    }
                }

                //value and selectedOptions are two-way, so these will be triggered even by our own actions.
                //It needs some way to tell if they are triggered because of us or because of outside change.
                //It doesn't loop but it's a waste of processing.
                if (allBindings.has('value')) {
                    var value = allBindings.get('value');
                    if (ko.isObservable(value)) {
                        ko.computed({
                            read: function () {
                                value();
                                setTimeout(function () {
                                    $element.multiselect('refresh');
                                }, 1);
                            },
                            disposeWhenNodeIsRemoved: element
                        }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                    }
                }

                //Switched from arrayChange subscription to general subscription using 'refresh'.
                //Not sure performance is any better using 'select' and 'deselect'.
                if (allBindings.has('selectedOptions')) {
                    var selectedOptions = allBindings.get('selectedOptions');
                    if (ko.isObservable(selectedOptions)) {
                        ko.computed({
                            read: function () {
                                selectedOptions();
                                setTimeout(function () {
                                    $element.multiselect('refresh');
                                }, 1);
                            },
                            disposeWhenNodeIsRemoved: element
                        }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                    }
                }

                var setEnabled = function (enable) {
                    setTimeout(function () {
                        if (enable)
                            $element.multiselect('enable');
                        else
                            $element.multiselect('disable');
                    });
                };

                if (allBindings.has('enable')) {
                    var enable = allBindings.get('enable');
                    if (ko.isObservable(enable)) {
                        ko.computed({
                            read: function () {
                                setEnabled(enable());
                            },
                            disposeWhenNodeIsRemoved: element
                        }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                    } else {
                        setEnabled(enable);
                    }
                }

                if (allBindings.has('disable')) {
                    var disable = allBindings.get('disable');
                    if (ko.isObservable(disable)) {
                        ko.computed({
                            read: function () {
                                setEnabled(!disable());
                            },
                            disposeWhenNodeIsRemoved: element
                        }).extend({ rateLimit: 100, notifyWhenChangesStop: true });
                    } else {
                        setEnabled(!disable);
                    }
                }

                ko.utils.domNodeDisposal.addDisposeCallback(element, function () {
                    $element.multiselect('destroy');
                });
            },

            update: function (element, valueAccessor, allBindings, viewModel, bindingContext) {
                var $element = $(element);
                var config = ko.toJS(valueAccessor());

                $element.multiselect('setOptions', config);
                $element.multiselect('rebuild');
            }
        };
    }

    function forEach(array, callback) {
        for (var index = 0; index < array.length; ++index) {
            callback(array[index], index);
        }
    }

    /**
     * Constructor to create a new multiselect using the given select.
     *
     * @param {jQuery} select
     * @param {Object} options
     * @returns {Multiselect}
     */
    function Multiselect(select, options) {

        this.$select = $(select);

        // Placeholder via data attributes
        if (this.$select.attr("data-placeholder")) {
            options.nonSelectedText = this.$select.data("placeholder");
        }

        this.options = this.mergeOptions($.extend({}, options, this.$select.data()));

        // Initialization.
        // We have to clone to create a new reference.
        this.originalOptions = this.$select.clone()[0].options;
        this.query = '';
        this.searchTimeout = null;
        this.lastToggledInput = null;

        this.options.multiple = this.$select.attr('multiple') === "multiple";
        this.options.onChange = $.proxy(this.options.onChange, this);
        this.options.onDropdownShow = $.proxy(this.options.onDropdownShow, this);
        this.options.onDropdownHide = $.proxy(this.options.onDropdownHide, this);
        this.options.onDropdownShown = $.proxy(this.options.onDropdownShown, this);
        this.options.onDropdownHidden = $.proxy(this.options.onDropdownHidden, this);
        this.options.onInitialized = $.proxy(this.options.onInitialized, this);

        // Build select all if enabled.
        this.buildContainer();
        this.buildButton();
        this.buildDropdown();
        this.buildSelectAll();
        this.buildDropdownOptions();
        this.buildFilter();

        this.updateButtonText();
        this.updateSelectAll(true);

        if (this.options.disableIfEmpty && $('option', this.$select).length <= 0) {
            this.disable();
        }

        this.$select.hide().after(this.$container);
        this.options.onInitialized(this.$select, this.$container);
    }

    Multiselect.prototype = {

        defaults: {
            /**
             * Default text function will either print 'None selected' in case no
             * option is selected or a list of the selected options up to a length
             * of 3 selected options.
             *
             * @param {jQuery} options
             * @param {jQuery} select
             * @returns {String}
             */
            buttonText: function (options, select) {
                if (this.disabledText.length > 0
                    && (this.disableIfEmpty || select.prop('disabled'))
                    && options.length == 0) {

                    return this.disabledText;
                }
                else if (options.length === 0) {
                    return this.nonSelectedText;
                }
                else if (this.allSelectedText
                    && options.length === $('option', $(select)).length
                    && $('option', $(select)).length !== 1
                    && this.multiple) {

                    if (this.selectAllNumber) {
                        return this.allSelectedText + ' (' + options.length + ')';
                    }
                    else {
                        return this.allSelectedText;
                    }
                }
                else if (options.length > this.numberDisplayed) {
                    return options.length + ' ' + this.nSelectedText;
                }
                else {
                    var selected = '';
                    var delimiter = this.delimiterText;

                    options.each(function () {
                        var label = ($(this).attr('label') !== undefined) ? $(this).attr('label') : $(this).text();
                        selected += label + delimiter;
                    });

                    return selected.substr(0, selected.length - 2);
                }
            },
            /**
             * Updates the title of the button similar to the buttonText function.
             *
             * @param {jQuery} options
             * @param {jQuery} select
             * @returns {@exp;selected@call;substr}
             */
            buttonTitle: function (options, select) {
                if (options.length === 0) {
                    return this.nonSelectedText;
                }
                else {
                    var selected = '';
                    var delimiter = this.delimiterText;

                    options.each(function () {
                        var label = ($(this).attr('label') !== undefined) ? $(this).attr('label') : $(this).text();
                        selected += label + delimiter;
                    });
                    return selected.substr(0, selected.length - 2);
                }
            },
            /**
             * Create a label.
             *
             * @param {jQuery} element
             * @returns {String}
             */
            optionLabel: function (element) {
                return $(element).attr('label') || $(element).text();
            },
            /**
             * Create a class.
             *
             * @param {jQuery} element
             * @returns {String}
             */
            optionClass: function (element) {
                return $(element).attr('class') || '';
            },
            /**
             * Triggered on change of the multiselect.
             *
             * Not triggered when selecting/deselecting options manually.
             *
             * @param {jQuery} option
             * @param {Boolean} checked
             */
            onChange: function (option, checked) {

            },
            /**
             * Triggered when the dropdown is shown.
             *
             * @param {jQuery} event
             */
            onDropdownShow: function (event) {

            },
            /**
             * Triggered when the dropdown is hidden.
             *
             * @param {jQuery} event
             */
            onDropdownHide: function (event) {

            },
            /**
             * Triggered after the dropdown is shown.
             *
             * @param {jQuery} event
             */
            onDropdownShown: function (event) {

            },
            /**
             * Triggered after the dropdown is hidden.
             *
             * @param {jQuery} event
             */
            onDropdownHidden: function (event) {

            },
            /**
             * Triggered on select all.
             */
            onSelectAll: function (checked) {

            },
            /**
             * Triggered after initializing.
             *
             * @param {jQuery} $select
             * @param {jQuery} $container
             */
            onInitialized: function ($select, $container) {

            },
            enableHTML: false,
            buttonClass: 'btn btn-default',
            inheritClass: false,
            buttonWidth: 'auto',
            buttonContainer: '<div class="btn-group" />',
            dropRight: false,
            dropUp: false,
            selectedClass: 'active',
            // Maximum height of the dropdown menu.
            // If maximum height is exceeded a scrollbar will be displayed.
            maxHeight: false,
            checkboxName: false,
            includeSelectAllOption: false,
            includeSelectAllIfMoreThan: 0,
            selectAllText: ' Select all',
            selectAllValue: 'multiselect-all',
            selectAllName: false,
            selectAllNumber: true,
            selectAllJustVisible: true,
            enableFiltering: false,
            enableCaseInsensitiveFiltering: false,
            enableFullValueFiltering: false,
            enableClickableOptGroups: false,
            enableCollapsibelOptGroups: false,
            filterPlaceholder: 'Search',
            // possible options: 'text', 'value', 'both'
            filterBehavior: 'text',
            includeFilterClearBtn: true,
            preventInputChangeEvent: false,
            nonSelectedText: 'None selected',
            nSelectedText: 'selected',
            allSelectedText: 'All selected',
            numberDisplayed: 3,
            disableIfEmpty: false,
            disabledText: '',
            delimiterText: ', ',
            templates: {
                button: '<button type="button" class="multiselect dropdown-toggle" data-toggle="dropdown"><span class="multiselect-selected-text"></span> <b class="icon-arrow-down-full"></b></button>',
                ul: '<ul class="multiselect-container dropdown-menu"></ul>',
                filter: '<li class="multiselect-item filter"><div class="input-group"><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span><input class="form-control multiselect-search" type="text"></div></li>',
                filterClearBtn: '<span class="input-group-btn"><button class="btn btn-default multiselect-clear-filter" type="button"><i class="glyphicon glyphicon-remove-circle"></i></button></span>',
                li: '<li><a tabindex="0"><label></label></a></li>',
                divider: '<li class="multiselect-item divider"></li>',
                liGroup: '<li class="multiselect-item multiselect-group"><label></label></li>'
            }
        },

        constructor: Multiselect,

        /**
         * Builds the container of the multiselect.
         */
        buildContainer: function () {
            this.$container = $(this.options.buttonContainer);
            this.$container.on('show.bs.dropdown', this.options.onDropdownShow);
            this.$container.on('hide.bs.dropdown', this.options.onDropdownHide);
            this.$container.on('shown.bs.dropdown', this.options.onDropdownShown);
            this.$container.on('hidden.bs.dropdown', this.options.onDropdownHidden);
        },

        /**
         * Builds the button of the multiselect.
         */
        buildButton: function () {
            this.$button = $(this.options.templates.button).addClass(this.options.buttonClass);
            if (this.$select.attr('class') && this.options.inheritClass) {
                this.$button.addClass(this.$select.attr('class'));
            }
            // Adopt active state.
            if (this.$select.prop('disabled')) {
                this.disable();
            }
            else {
                this.enable();
            }

            // Manually add button width if set.
            if (this.options.buttonWidth && this.options.buttonWidth !== 'auto') {
                this.$button.css({
                    'width': this.options.buttonWidth,
                    'overflow': 'hidden',
                    'text-overflow': 'ellipsis'
                });
                this.$container.css({
                    'width': this.options.buttonWidth
                });
            }

            // Keep the tab index from the select.
            var tabindex = this.$select.attr('tabindex');
            if (tabindex) {
                this.$button.attr('tabindex', tabindex);
            }

            this.$container.prepend(this.$button);
        },

        /**
         * Builds the ul representing the dropdown menu.
         */
        buildDropdown: function () {

            // Build ul.
            this.$ul = $(this.options.templates.ul);

            if (this.options.dropRight) {
                this.$ul.addClass('pull-right');
            }

            // Set max height of dropdown menu to activate auto scrollbar.
            if (this.options.maxHeight) {
                // TODO: Add a class for this option to move the css declarations.
                this.$ul.css({
                    'max-height': this.options.maxHeight + 'px',
                    'overflow-y': 'auto',
                    'overflow-x': 'hidden'
                });
            }

            if (this.options.dropUp) {

                var height = Math.min(this.options.maxHeight, $('option[data-role!="divider"]', this.$select).length * 26 + $('option[data-role="divider"]', this.$select).length * 19 + (this.options.includeSelectAllOption ? 26 : 0) + (this.options.enableFiltering || this.options.enableCaseInsensitiveFiltering ? 44 : 0));
                var moveCalc = height + 34;

                this.$ul.css({
                    'max-height': height + 'px',
                    'overflow-y': 'auto',
                    'overflow-x': 'hidden',
                    'margin-top': "-" + moveCalc + 'px'
                });
            }

            this.$container.append(this.$ul);
        },

        /**
         * Build the dropdown options and binds all nessecary events.
         *
         * Uses createDivider and createOptionValue to create the necessary options.
         */
        buildDropdownOptions: function () {

            this.$select.children().each($.proxy(function (index, element) {

                var $element = $(element);
                // Support optgroups and options without a group simultaneously.
                var tag = $element.prop('tagName')
                    .toLowerCase();

                if ($element.prop('value') === this.options.selectAllValue) {
                    return;
                }

                if (tag === 'optgroup') {
                    this.createOptgroup(element);
                }
                else if (tag === 'option') {

                    if ($element.data('role') === 'divider') {
                        this.createDivider();
                    }
                    else {
                        this.createOptionValue(element);
                    }

                }

                // Other illegal tags will be ignored.
            }, this));

            // Bind the change event on the dropdown elements.
            $('li input', this.$ul).on('change', $.proxy(function (event) {
                var $target = $(event.target);

                var checked = $target.prop('checked') || false;
                var isSelectAllOption = $target.val() === this.options.selectAllValue;

                // Apply or unapply the configured selected class.
                if (this.options.selectedClass) {
                    if (checked) {
                        $target.closest('li')
                            .addClass(this.options.selectedClass);
                    }
                    else {
                        $target.closest('li')
                            .removeClass(this.options.selectedClass);
                    }
                }

                // Get the corresponding option.
                var value = $target.val();
                var $option = this.getOptionByValue(value);

                var $optionsNotThis = $('option', this.$select).not($option);
                var $checkboxesNotThis = $('input', this.$container).not($target);

                if (isSelectAllOption) {
                    if (checked) {
                        this.selectAll(this.options.selectAllJustVisible);
                    }
                    else {
                        this.deselectAll(this.options.selectAllJustVisible);
                    }
                }
                else {
                    if (checked) {
                        $option.prop('selected', true);

                        if (this.options.multiple) {
                            // Simply select additional option.
                            $option.prop('selected', true);
                        }
                        else {
                            // Unselect all other options and corresponding checkboxes.
                            if (this.options.selectedClass) {
                                $($checkboxesNotThis).closest('li').removeClass(this.options.selectedClass);
                            }

                            $($checkboxesNotThis).prop('checked', false);
                            $optionsNotThis.prop('selected', false);

                            // It's a single selection, so close.
                            this.$button.click();
                        }

                        if (this.options.selectedClass === "active") {
                            $optionsNotThis.closest("a").css("outline", "");
                        }
                    }
                    else {
                        // Unselect option.
                        $option.prop('selected', false);
                    }

                    // To prevent select all from firing onChange: #575
                    this.options.onChange($option, checked);
                }

                this.$select.change();

                this.updateButtonText();
                this.updateSelectAll();

                if (this.options.preventInputChangeEvent) {
                    return false;
                }
            }, this));

            $('li a', this.$ul).on('mousedown', function (e) {
                if (e.shiftKey) {
                    // Prevent selecting text by Shift+click
                    return false;
                }
            });

            $('li a', this.$ul).on('touchstart click', $.proxy(function (event) {
                event.stopPropagation();

                var $target = $(event.target);

                if (event.shiftKey && this.options.multiple) {
                    if ($target.is("label")) { // Handles checkbox selection manually (see https://github.com/davidstutz/bootstrap-multiselect/issues/431)
                        event.preventDefault();
                        $target = $target.find("input");
                        $target.prop("checked", !$target.prop("checked"));
                    }
                    var checked = $target.prop('checked') || false;

                    if (this.lastToggledInput !== null && this.lastToggledInput !== $target) { // Make sure we actually have a range
                        var from = $target.closest("li").index();
                        var to = this.lastToggledInput.closest("li").index();

                        if (from > to) { // Swap the indices
                            var tmp = to;
                            to = from;
                            from = tmp;
                        }

                        // Make sure we grab all elements since slice excludes the last index
                        ++to;

                        // Change the checkboxes and underlying options
                        var range = this.$ul.find("li").slice(from, to).find("input");

                        range.prop('checked', checked);

                        if (this.options.selectedClass) {
                            range.closest('li')
                                .toggleClass(this.options.selectedClass, checked);
                        }

                        for (var i = 0, j = range.length; i < j; i++) {
                            var $checkbox = $(range[i]);

                            var $option = this.getOptionByValue($checkbox.val());

                            $option.prop('selected', checked);
                        }
                    }

                    // Trigger the select "change" event
                    $target.trigger("change");
                }

                // Remembers last clicked option
                if ($target.is("input") && !$target.closest("li").is(".multiselect-item")) {
                    this.lastToggledInput = $target;
                }

                $target.blur();
            }, this));

            // Keyboard support.
            this.$container.off('keydown.multiselect').on('keydown.multiselect', $.proxy(function (event) {
                if ($('input[type="text"]', this.$container).is(':focus')) {
                    return;
                }

                if (event.keyCode === 9 && this.$container.hasClass('open')) {
                    this.$button.click();
                }
                else {
                    var $items = $(this.$container).find("li:not(.divider):not(.disabled) a").filter(":visible");

                    if (!$items.length) {
                        return;
                    }

                    var index = $items.index($items.filter(':focus'));

                    // Navigation up.
                    if (event.keyCode === 38 && index > 0) {
                        index--;
                    }
                    // Navigate down.
                    else if (event.keyCode === 40 && index < $items.length - 1) {
                        index++;
                    }
                    else if (!~index) {
                        index = 0;
                    }

                    var $current = $items.eq(index);
                    $current.focus();

                    if (event.keyCode === 32 || event.keyCode === 13) {
                        var $checkbox = $current.find('input');

                        $checkbox.prop("checked", !$checkbox.prop("checked"));
                        $checkbox.change();
                    }

                    event.stopPropagation();
                    event.preventDefault();
                }
            }, this));

            if (this.options.enableClickableOptGroups && this.options.multiple) {
                $('li.multiselect-group', this.$ul).on('click', $.proxy(function (event) {
                    event.stopPropagation();
                    console.log('test');
                    var group = $(event.target).parent();

                    // Search all option in optgroup
                    var $options = group.nextUntil('li.multiselect-group');
                    var $visibleOptions = $options.filter(":visible:not(.disabled)");

                    // check or uncheck items
                    var allChecked = true;
                    var optionInputs = $visibleOptions.find('input');
                    var values = [];

                    optionInputs.each(function () {
                        allChecked = allChecked && $(this).prop('checked');
                        values.push($(this).val());
                    });

                    if (!allChecked) {
                        this.select(values, false);
                    }
                    else {
                        this.deselect(values, false);
                    }

                    this.options.onChange(optionInputs, !allChecked);
                }, this));
            }

            if (this.options.enableCollapsibleOptGroups && this.options.multiple) {
                $("li.multiselect-group input", this.$ul).off();
                $("li.multiselect-group", this.$ul).siblings().not("li.multiselect-group, li.multiselect-all", this.$ul).each(function () {
                    $(this).toggleClass('hidden', true);
                });

                $("li.multiselect-group", this.$ul).on("click", $.proxy(function (group) {
                    group.stopPropagation();
                }, this));

                $("li.multiselect-group > a > b", this.$ul).on("click", $.proxy(function (t) {
                    t.stopPropagation();
                    var n = $(t.target).closest('li');
                    var r = n.nextUntil("li.multiselect-group");
                    var i = true;

                    r.each(function () {
                        i = i && $(this).hasClass('hidden');
                    });

                    r.toggleClass('hidden', !i);
                }, this));

                $("li.multiselect-group > a > input", this.$ul).on("change", $.proxy(function (t) {
                    t.stopPropagation();
                    var n = $(t.target).closest('li');
                    var r = n.nextUntil("li.multiselect-group", ':not(.disabled)');
                    var s = r.find("input");

                    var i = true;
                    s.each(function () {
                        i = i && $(this).prop("checked");
                    });

                    s.prop("checked", !i).trigger("change");
                }, this));

                // Set the initial selection state of the groups.
                $('li.multiselect-group', this.$ul).each(function () {
                    var r = $(this).nextUntil("li.multiselect-group", ':not(.disabled)');
                    var s = r.find("input");

                    var i = true;
                    s.each(function () {
                        i = i && $(this).prop("checked");
                    });

                    $(this).find('input').prop("checked", i);
                });

                // Update the group checkbox based on new selections among the
                // corresponding children.
                $("li input", this.$ul).on("change", $.proxy(function (t) {
                    t.stopPropagation();
                    var n = $(t.target).closest('li');
                    var r1 = n.prevUntil("li.multiselect-group", ':not(.disabled)');
                    var r2 = n.nextUntil("li.multiselect-group", ':not(.disabled)');
                    var s1 = r1.find("input");
                    var s2 = r2.find("input");

                    var i = $(t.target).prop('checked');
                    s1.each(function () {
                        i = i && $(this).prop("checked");
                    });

                    s2.each(function () {
                        i = i && $(this).prop("checked");
                    });

                    n.prevAll('.multiselect-group').find('input').prop('checked', i);
                }, this));

                $("li.multiselect-all", this.$ul).css('background', '#f3f3f3').css('border-bottom', '1px solid #eaeaea');
                $("li.multiselect-group > a, li.multiselect-all > a > label.checkbox", this.$ul).css('padding', '3px 20px 3px 35px');
                $("li.multiselect-group > a > input", this.$ul).css('margin', '4px 0px 5px -20px');
            }
        },

        /**
         * Create an option using the given select option.
         *
         * @param {jQuery} element
         */
        createOptionValue: function (element) {
            var $element = $(element);
            if ($element.is(':selected')) {
                $element.prop('selected', true);
            }

            // Support the label attribute on options.
            var label = this.options.optionLabel(element);
            var classes = this.options.optionClass(element);
            var value = $element.val();
            var inputType = this.options.multiple ? "checkbox" : "radio";

            var $li = $(this.options.templates.li);
            var $label = $('label', $li);
            $label.addClass(inputType);
            $li.addClass(classes);

            if (this.options.enableHTML) {
                $label.html(" " + label);
            }
            else {
                $label.text(" " + label);
            }

            var $checkbox = $('<input/>').attr('type', inputType);

            if (this.options.checkboxName) {
                $checkbox.attr('name', this.options.checkboxName);
            }

            //����ʽ
            if ($.IGuid) {
                var id = $.IGuid();
                var $a = $('a', $li);
                $a.addClass("multiselect-item");
                $checkbox.attr("id", id);
                $label.attr("for", id);
                $a.prepend($checkbox);
            } else {
                $label.prepend($checkbox);
            }


            var selected = $element.prop('selected') || false;
            $checkbox.val(value);

            if (value === this.options.selectAllValue) {
                $li.addClass("multiselect-item multiselect-all");
                $checkbox.parent().parent()
                    .addClass('multiselect-all');
            }

            $label.attr('title', $element.attr('title'));

            this.$ul.append($li);

            if ($element.is(':disabled')) {
                $checkbox.attr('disabled', 'disabled')
                    .prop('disabled', true)
                    .closest('a')
                    .attr("tabindex", "-1")
                    .closest('li')
                    .addClass('disabled');
            }

            $checkbox.prop('checked', selected);

            if (selected && this.options.selectedClass) {
                $checkbox.closest('li')
                    .addClass(this.options.selectedClass);
            }
        },

        /**
         * Creates a divider using the given select option.
         *
         * @param {jQuery} element
         */
        createDivider: function (element) {
            var $divider = $(this.options.templates.divider);
            this.$ul.append($divider);
        },

        /**
         * Creates an optgroup.
         *
         * @param {jQuery} group
         */
        createOptgroup: function (group) {
            if (this.options.enableCollapsibleOptGroups && this.options.multiple) {
                var label = $(group).attr("label");
                var value = $(group).attr("value");
                var r = $('<li class="multiselect-item multiselect-group"><a href="javascript:void(0);"><input type="checkbox" value="' + value + '"/><b> ' + label + '<b class="icon-arrow-down-full"></b></b></a></li>');

                if (this.options.enableClickableOptGroups) {
                    r.addClass("multiselect-group-clickable")
                }
                this.$ul.append(r);
                if ($(group).is(":disabled")) {
                    r.addClass("disabled")
                }
                $("option", group).each($.proxy(function ($, group) {
                    this.createOptionValue(group)
                }, this))
            }
            else {
                var groupName = $(group).prop('label');

                // Add a header for the group.
                var $li = $(this.options.templates.liGroup);

                if (this.options.enableHTML) {
                    $('label', $li).html(groupName);
                }
                else {
                    $('label', $li).text(groupName);
                }

                if (this.options.enableClickableOptGroups) {
                    $li.addClass('multiselect-group-clickable');
                }

                this.$ul.append($li);

                if ($(group).is(':disabled')) {
                    $li.addClass('disabled');
                }

                // Add the options of the group.
                $('option', group).each($.proxy(function (index, element) {
                    this.createOptionValue(element);
                }, this));
            }
        },

        /**
         * Build the select all.
         *
         * Checks if a select all has already been created.
         */
        buildSelectAll: function () {
            if (typeof this.options.selectAllValue === 'number') {
                this.options.selectAllValue = this.options.selectAllValue.toString();
            }

            var alreadyHasSelectAll = this.hasSelectAll();

            if (!alreadyHasSelectAll && this.options.includeSelectAllOption && this.options.multiple
                && $('option', this.$select).length > this.options.includeSelectAllIfMoreThan) {

                // Check whether to add a divider after the select all.
                if (this.options.includeSelectAllDivider) {
                    this.$ul.prepend($(this.options.templates.divider));
                }

                var $li = $(this.options.templates.li);
                $('label', $li).addClass("checkbox");

                if (this.options.enableHTML) {
                    $('label', $li).html(" " + this.options.selectAllText);
                }
                else {
                    $('label', $li).text(" " + this.options.selectAllText);
                }

                if (this.options.selectAllName) {
                    $('label', $li).prepend('<input type="checkbox" name="' + this.options.selectAllName + '" />');
                }
                else {
                    $('label', $li).prepend('<input type="checkbox" />');
                }

                var $checkbox = $('input', $li);
                $checkbox.val(this.options.selectAllValue);

                $li.addClass("multiselect-item multiselect-all");
                $checkbox.parent().parent()
                    .addClass('multiselect-all');

                this.$ul.prepend($li);

                $checkbox.prop('checked', false);
            }
        },

        /**
         * Builds the filter.
         */
        buildFilter: function () {

            // Build filter if filtering OR case insensitive filtering is enabled and the number of options exceeds (or equals) enableFilterLength.
            if (this.options.enableFiltering || this.options.enableCaseInsensitiveFiltering) {
                var enableFilterLength = Math.max(this.options.enableFiltering, this.options.enableCaseInsensitiveFiltering);

                if (this.$select.find('option').length >= enableFilterLength) {

                    this.$filter = $(this.options.templates.filter);
                    $('input', this.$filter).attr('placeholder', this.options.filterPlaceholder);

                    // Adds optional filter clear button
                    if (this.options.includeFilterClearBtn) {
                        var clearBtn = $(this.options.templates.filterClearBtn);
                        clearBtn.on('click', $.proxy(function (event) {
                            clearTimeout(this.searchTimeout);
                            this.$filter.find('.multiselect-search').val('');
                            $('li', this.$ul).show().removeClass("filter-hidden");
                            this.updateSelectAll();
                        }, this));
                        this.$filter.find('.input-group').append(clearBtn);
                    }

                    this.$ul.prepend(this.$filter);

                    this.$filter.val(this.query).on('click', function (event) {
                        event.stopPropagation();
                    }).on('input keydown', $.proxy(function (event) {
                        // Cancel enter key default behaviour
                        if (event.which === 13) {
                            event.preventDefault();
                        }

                        // This is useful to catch "keydown" events after the browser has updated the control.
                        clearTimeout(this.searchTimeout);

                        this.searchTimeout = this.asyncFunction($.proxy(function () {

                            if (this.query !== event.target.value) {
                                this.query = event.target.value;

                                var currentGroup, currentGroupVisible;
                                $.each($('li', this.$ul), $.proxy(function (index, element) {
                                    var value = $('input', element).length > 0 ? $('input', element).val() : "";
                                    var text = $('label', element).text();

                                    var filterCandidate = '';
                                    if ((this.options.filterBehavior === 'text')) {
                                        filterCandidate = text;
                                    }
                                    else if ((this.options.filterBehavior === 'value')) {
                                        filterCandidate = value;
                                    }
                                    else if (this.options.filterBehavior === 'both') {
                                        filterCandidate = text + '\n' + value;
                                    }

                                    if (value !== this.options.selectAllValue && text) {

                                        // By default lets assume that element is not
                                        // interesting for this search.
                                        var showElement = false;

                                        if (this.options.enableCaseInsensitiveFiltering) {
                                            filterCandidate = filterCandidate.toLowerCase();
                                            this.query = this.query.toLowerCase();
                                        }

                                        if (this.options.enableFullValueFiltering && this.options.filterBehavior !== 'both') {
                                            var valueToMatch = filterCandidate.trim().substring(0, this.query.length);
                                            if (this.query.indexOf(valueToMatch) > -1) {
                                                showElement = true;
                                            }
                                        }
                                        else if (filterCandidate.indexOf(this.query) > -1) {
                                            showElement = true;
                                        }

                                        // Toggle current element (group or group item) according to showElement boolean.
                                        $(element).toggle(showElement).toggleClass('filter-hidden', !showElement);

                                        // Differentiate groups and group items.
                                        if ($(element).hasClass('multiselect-group')) {
                                            // Remember group status.
                                            currentGroup = element;
                                            currentGroupVisible = showElement;
                                        }
                                        else {
                                            // Show group name when at least one of its items is visible.
                                            if (showElement) {
                                                $(currentGroup).show().removeClass('filter-hidden');
                                            }

                                            // Show all group items when group name satisfies filter.
                                            if (!showElement && currentGroupVisible) {
                                                $(element).show().removeClass('filter-hidden');
                                            }
                                        }
                                    }
                                }, this));
                            }

                            this.updateSelectAll();
                        }, this), 300, this);
                    }, this));
                }
            }
        },

        /**
         * Unbinds the whole plugin.
         */
        destroy: function () {
            this.$container.remove();
            this.$select.show();
            this.$select.data('multiselect', null);
        },

        /**
         * Refreshs the multiselect based on the selected options of the select.
         */
        refresh: function () {
            var inputs = $.map($('li input', this.$ul), $);

            $('option', this.$select).each($.proxy(function (index, element) {
                var $elem = $(element);
                var value = $elem.val();
                var $input;
                for (var i = inputs.length; 0 < i--; /**/) {
                    if (value !== ($input = inputs[i]).val())
                        continue; // wrong li

                    if ($elem.is(':selected')) {
                        $input.prop('checked', true);

                        if (this.options.selectedClass) {
                            $input.closest('li')
                                .addClass(this.options.selectedClass);
                        }
                    }
                    else {
                        $input.prop('checked', false);

                        if (this.options.selectedClass) {
                            $input.closest('li')
                                .removeClass(this.options.selectedClass);
                        }
                    }

                    if ($elem.is(":disabled")) {
                        $input.attr('disabled', 'disabled')
                            .prop('disabled', true)
                            .closest('li')
                            .addClass('disabled');
                    }
                    else {
                        $input.prop('disabled', false)
                            .closest('li')
                            .removeClass('disabled');
                    }
                    break; // assumes unique values
                }
            }, this));

            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Select all options of the given values.
         *
         * If triggerOnChange is set to true, the on change event is triggered if
         * and only if one value is passed.
         *
         * @param {Array} selectValues
         * @param {Boolean} triggerOnChange
         */
        select: function (selectValues, triggerOnChange) {
            if (!$.isArray(selectValues)) {
                selectValues = [selectValues];
            }

            for (var i = 0; i < selectValues.length; i++) {
                var value = selectValues[i];

                if (value === null || value === undefined) {
                    continue;
                }

                var $option = this.getOptionByValue(value);
                var $checkbox = this.getInputByValue(value);

                if ($option === undefined || $checkbox === undefined) {
                    continue;
                }

                if (!this.options.multiple) {
                    this.deselectAll(false);
                }

                if (this.options.selectedClass) {
                    $checkbox.closest('li')
                        .addClass(this.options.selectedClass);
                }

                $checkbox.prop('checked', true);
                $option.prop('selected', true);

                if (triggerOnChange) {
                    this.options.onChange($option, true);
                }
            }

            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Clears all selected items.
         */
        clearSelection: function () {
            this.deselectAll(false);
            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Deselects all options of the given values.
         *
         * If triggerOnChange is set to true, the on change event is triggered, if
         * and only if one value is passed.
         *
         * @param {Array} deselectValues
         * @param {Boolean} triggerOnChange
         */
        deselect: function (deselectValues, triggerOnChange) {
            if (!$.isArray(deselectValues)) {
                deselectValues = [deselectValues];
            }

            for (var i = 0; i < deselectValues.length; i++) {
                var value = deselectValues[i];

                if (value === null || value === undefined) {
                    continue;
                }

                var $option = this.getOptionByValue(value);
                var $checkbox = this.getInputByValue(value);

                if ($option === undefined || $checkbox === undefined) {
                    continue;
                }

                if (this.options.selectedClass) {
                    $checkbox.closest('li')
                        .removeClass(this.options.selectedClass);
                }

                $checkbox.prop('checked', false);
                $option.prop('selected', false);

                if (triggerOnChange) {
                    this.options.onChange($option, false);
                }
            }

            this.updateButtonText();
            this.updateSelectAll();
        },

        /**
         * Selects all enabled & visible options.
         *
         * If justVisible is true or not specified, only visible options are selected.
         *
         * @param {Boolean} justVisible
         * @param {Boolean} triggerOnSelectAll
         */
        selectAll: function (justVisible, triggerOnSelectAll) {
            justVisible = (this.options.enableCollapsibleOptGroups && this.options.multiple) ? false : justVisible;

            var justVisible = typeof justVisible === 'undefined' ? true : justVisible;
            var allCheckboxes = $("li input[type='checkbox']:enabled", this.$ul);
            var visibleCheckboxes = allCheckboxes.filter(":visible");
            var allCheckboxesCount = allCheckboxes.length;
            var visibleCheckboxesCount = visibleCheckboxes.length;

            if (justVisible) {
                visibleCheckboxes.prop('checked', true);
                $("li:not(.divider):not(.disabled)", this.$ul).filter(":visible").addClass(this.options.selectedClass);
            }
            else {
                allCheckboxes.prop('checked', true);
                $("li:not(.divider):not(.disabled)", this.$ul).addClass(this.options.selectedClass);
            }

            if (allCheckboxesCount === visibleCheckboxesCount || justVisible === false) {
                $("option:not([data-role='divider']):enabled", this.$select).prop('selected', true);
            }
            else {
                var values = visibleCheckboxes.map(function () {
                    return $(this).val();
                }).get();

                $("option:enabled", this.$select).filter(function (index) {
                    return $.inArray($(this).val(), values) !== -1;
                }).prop('selected', true);
            }

            if (triggerOnSelectAll) {
                this.options.onSelectAll();
            }
        },

        /**
         * Deselects all options.
         *
         * If justVisible is true or not specified, only visible options are deselected.
         *
         * @param {Boolean} justVisible
         */
        deselectAll: function (justVisible) {
            justVisible = (this.options.enableCollapsibleOptGroups && this.options.multiple) ? false : justVisible;
            justVisible = typeof justVisible === 'undefined' ? true : justVisible;

            if (justVisible) {
                var visibleCheckboxes = $("li input[type='checkbox']:not(:disabled)", this.$ul).filter(":visible");
                visibleCheckboxes.prop('checked', false);

                var values = visibleCheckboxes.map(function () {
                    return $(this).val();
                }).get();

                $("option:enabled", this.$select).filter(function (index) {
                    return $.inArray($(this).val(), values) !== -1;
                }).prop('selected', false);

                if (this.options.selectedClass) {
                    $("li:not(.divider):not(.disabled)", this.$ul).filter(":visible").removeClass(this.options.selectedClass);
                }
            }
            else {
                $("li input[type='checkbox']:enabled", this.$ul).prop('checked', false);
                $("option:enabled", this.$select).prop('selected', false);

                if (this.options.selectedClass) {
                    $("li:not(.divider):not(.disabled)", this.$ul).removeClass(this.options.selectedClass);
                }
            }
        },

        /**
         * Rebuild the plugin.
         *
         * Rebuilds the dropdown, the filter and the select all option.
         */
        rebuild: function () {
            this.$ul.html('');

            // Important to distinguish between radios and checkboxes.
            this.options.multiple = this.$select.attr('multiple') === "multiple";

            this.buildSelectAll();
            this.buildDropdownOptions();
            this.buildFilter();

            this.updateButtonText();
            this.updateSelectAll(true);

            if (this.options.disableIfEmpty && $('option', this.$select).length <= 0) {
                this.disable();
            }
            else {
                this.enable();
            }

            if (this.options.dropRight) {
                this.$ul.addClass('pull-right');
            }
        },

        /**
         * The provided data will be used to build the dropdown.
         */
        dataprovider: function (dataprovider) {

            var groupCounter = 0;
            var $select = this.$select.empty();

            $.each(dataprovider, function (index, option) {
                var $tag;

                if ($.isArray(option.children)) { // create optiongroup tag
                    groupCounter++;

                    $tag = $('<optgroup/>').attr({
                        label: option.label || 'Group ' + groupCounter,
                        disabled: !!option.disabled
                    });

                    forEach(option.children, function (subOption) { // add children option tags
                        $tag.append($('<option/>').attr({
                            value: subOption.value,
                            label: subOption.label || subOption.value,
                            title: subOption.title,
                            selected: !!subOption.selected,
                            disabled: !!subOption.disabled
                        }));
                    });
                }
                else {
                    $tag = $('<option/>').attr({
                        value: option.value,
                        label: option.label || option.value,
                        title: option.title,
                        class: option.class,
                        selected: !!option.selected,
                        disabled: !!option.disabled
                    });
                    $tag.text(option.label || option.value);
                }

                $select.append($tag);
            });

            this.rebuild();
        },

        /**
         * Enable the multiselect.
         */
        enable: function () {
            this.$select.prop('disabled', false);
            this.$button.prop('disabled', false)
                .removeClass('disabled');
        },

        /**
         * Disable the multiselect.
         */
        disable: function () {
            this.$select.prop('disabled', true);
            this.$button.prop('disabled', true)
                .addClass('disabled');
        },

        /**
         * Set the options.
         *
         * @param {Array} options
         */
        setOptions: function (options) {
            this.options = this.mergeOptions(options);
        },

        /**
         * Merges the given options with the default options.
         *
         * @param {Array} options
         * @returns {Array}
         */
        mergeOptions: function (options) {
            return $.extend(true, {}, this.defaults, this.options, options);
        },

        /**
         * Checks whether a select all checkbox is present.
         *
         * @returns {Boolean}
         */
        hasSelectAll: function () {
            return $('li.multiselect-all', this.$ul).length > 0;
        },

        /**
         * Updates the select all checkbox based on the currently displayed and selected checkboxes.
         */
        updateSelectAll: function (notTriggerOnSelectAll) {
            if (this.hasSelectAll()) {
                var allBoxes = $("li:not(.multiselect-item):not(.filter-hidden) input:enabled", this.$ul);
                var allBoxesLength = allBoxes.length;
                var checkedBoxesLength = allBoxes.filter(":checked").length;
                var selectAllLi = $("li.multiselect-all", this.$ul);
                var selectAllInput = selectAllLi.find("input");

                if (checkedBoxesLength > 0 && checkedBoxesLength === allBoxesLength) {
                    selectAllInput.prop("checked", true);
                    selectAllLi.addClass(this.options.selectedClass);
                    this.options.onSelectAll(true);
                }
                else {
                    selectAllInput.prop("checked", false);
                    selectAllLi.removeClass(this.options.selectedClass);
                    if (checkedBoxesLength === 0) {
                        if (!notTriggerOnSelectAll) {
                            this.options.onSelectAll(false);
                        }
                    }
                }
            }
        },

        /**
         * Update the button text and its title based on the currently selected options.
         */
        updateButtonText: function () {
            var options = this.getSelected();

            // First update the displayed button text.
            if (this.options.enableHTML) {
                $('.multiselect .multiselect-selected-text', this.$container).html(this.options.buttonText(options, this.$select));
            }
            else {
                $('.multiselect .multiselect-selected-text', this.$container).text(this.options.buttonText(options, this.$select));
            }

            // Now update the title attribute of the button.
            $('.multiselect', this.$container).attr('title', this.options.buttonTitle(options, this.$select));
        },

        /**
         * Get all selected options.
         *
         * @returns {jQUery}
         */
        getSelected: function () {
            return $('option', this.$select).filter(":selected");
        },

        /**
         * Gets a select option by its value.
         *
         * @param {String} value
         * @returns {jQuery}
         */
        getOptionByValue: function (value) {

            var options = $('option', this.$select);
            var valueToCompare = value.toString();

            for (var i = 0; i < options.length; i = i + 1) {
                var option = options[i];
                if (option.value === valueToCompare) {
                    return $(option);
                }
            }
        },

        /**
         * Get the input (radio/checkbox) by its value.
         *
         * @param {String} value
         * @returns {jQuery}
         */
        getInputByValue: function (value) {

            var checkboxes = $('li input', this.$ul);
            var valueToCompare = value.toString();

            for (var i = 0; i < checkboxes.length; i = i + 1) {
                var checkbox = checkboxes[i];
                if (checkbox.value === valueToCompare) {
                    return $(checkbox);
                }
            }
        },

        /**
         * Used for knockout integration.
         */
        updateOriginalOptions: function () {
            this.originalOptions = this.$select.clone()[0].options;
        },

        asyncFunction: function (callback, timeout, self) {
            var args = Array.prototype.slice.call(arguments, 3);
            return setTimeout(function () {
                callback.apply(self || window, args);
            }, timeout);
        },

        setAllSelectedText: function (allSelectedText) {
            this.options.allSelectedText = allSelectedText;
            this.updateButtonText();
        }
    };

    $.fn.multiselect = function (option, parameter, extraOptions) {
        return this.each(function () {
            var data = $(this).data('multiselect');
            var options = typeof option === 'object' && option;

            // Initialize the multiselect.
            if (!data) {
                data = new Multiselect(this, options);
                $(this).data('multiselect', data);
            }

            // Call multiselect method.
            if (typeof option === 'string') {
                data[option](parameter, extraOptions);

                if (option === 'destroy') {
                    $(this).data('multiselect', false);
                }
            }
        });
    };

    $.fn.multiselect.Constructor = Multiselect;

    $(function () {
        $("select[data-role=multiselect]").multiselect();
    });

}(window.jQuery);
;
Number.prototype.toFixed = function (j) {
    var h = this + "";

    j = isNaN(parseInt(j)) ? 0 : parseInt(j);

    if (h.indexOf(".") == -1) {
        h += "."
    }
    h += new Array(j + 1).join("0");
    if (new RegExp("^(-|\\+)?(\\d+(\\.\\d{0," + (j + 1) + "})?)\\d*$").test(h)) {
        var h = "0" + RegExp.$2,
            g = RegExp.$1,
            e = RegExp.$3.length,
            c = true;
        if (e == j + 2) {
            e = h.match(/\d/g);
            if (parseInt(e[e.length - 1]) > 4) {
                for (var f = e.length - 2; f >= 0; f--) {
                    e[f] = parseInt(e[f]) + 1;
                    if (e[f] == 10) {
                        e[f] = 0;
                        c = f != 1
                    } else {
                        break
                    }
                }
            }
            h = e.join("").replace(new RegExp("(\\d+)(\\d{" + j + "})\\d$"), "$1.$2")
        }
        if (c) {
            h = h.substr(1)
        }
        return (g + h).replace(/\.$/, "")
    }
    return this + ""
};
var CalcEval = function () { };
CalcEval.prototype.eval = function (str) {
    var result = this.evalRecursion(str);
    if (typeof result == "string") {
        result = result.replace(/"/g, "");
    }
    return result;
};

CalcEval.prototype.evalRecursion = function (str) {
    //console.log("a:"+str);
    var isRetStr = str.match(new RegExp(/^".+"$/g)) != null;
    if (isRetStr == true) {
        str = str.replace(/^"|"$/g, "")
    }
    var bracketsList = this.matchOutBrackets(str);
    for (var i = 0; i < bracketsList.length; i++) {
        var newCalc = bracketsList[i];
        var calcStr = this.evalRecursion(newCalc.str.replace(/^\(|\)$/g, ""));
        str = str.replace(newCalc.str, calcStr)
    }
    var errorObj = new Array();
    var tIndex = new Date().getTime();

    //console.log("b:"+str);

    //除
    while (1) {
        var multObj = this.matchExp(str, "/");
        if (multObj == null) {
            break
        }
        var v = this.executeDivi(multObj.firstValue, multObj.secondValue);
        if (v == "NaN") {
            var t = "T" + (tIndex++);
            errorObj.push({
                Name: t,
                Exp: multObj.str
            });
            str = str.replace(multObj.str, t)
        } else {
            str = str.replace(multObj.str, v)
        }
    }

    //console.log("c:"+str);

    //乘
    while (1) {
        var multObj = this.matchExp(str, "*");
        if (multObj == null) {
            break
        }
        var v = this.executeMult(multObj.firstValue, multObj.secondValue);

        if (v == "NaN") {
            var t = "T" + (tIndex++);
            errorObj.push({
                Name: t,
                Exp: multObj.str
            });
            str = str.replace(multObj.str, t)
        } else {
            //str = str.replace(multObj.firstValue+"*"+multObj.secondValue, v)
            str = str.replace(multObj.str, v)
        }
        //console.log("d:"+str);
    }


    //加
    while (1) {
        var multObj = this.matchExp(str, "+");
        if (multObj == null) {
            break
        }
        var v = this.executeAddi(multObj.firstValue, multObj.secondValue);
        if (v == "NaN" || isNaN(v)) {
            var t = "T" + (tIndex++);
            errorObj.push({
                Name: t,
                Exp: multObj.str
            });
            str = str.replace(multObj.str, t)
        } else {
            str = str.replace(multObj.str, v)
        }
    }

    //console.log("e:"+str);

    //减
    while (1) {
        var multObj = this.matchExp(str, "-");
        if (multObj == null) {
            break
        }
        var v = this.executeSubt(multObj.firstValue, multObj.secondValue);
        if (v == "NaN") {
            var t = "T" + (tIndex++);
            errorObj.push({
                Name: t,
                Exp: multObj.str
            });
            str = str.replace(multObj.str, t)
        } else {
            str = str.replace(multObj.str, v)
        }
    }
    for (var i = errorObj.length - 1; i >= 0; i--) {
        var ex = errorObj[i];
        str = str.replace(ex.Name, ex.Exp)
    }

    //连等
    while (1) {
        //var multObj = str.match(/\d*={2,3}\d*/g);
        var multObj = str.match(/\S*={2,3}\S*/g);
        if (multObj == null) {
            break
        }
        var replaceTemp = multObj[0];
        if (multObj[0].indexOf('"=="') > 0 || multObj[0].indexOf('"==="') > 0) {
            replaceTemp = '"' + replaceTemp + '"';
        }
        var v = eval(replaceTemp);
        str = str.replace(multObj[0], v)
    }


    //console.log("f:"+str);


    if (isRetStr == true) {
        try {
            return eval('"' + str + '"')
        } catch (e) { }
        try {
            return eval(str)
        } catch (e) { }
        return str
    }
    if (str.match(/(^true$)|(^false$)/g)) {
        return str === "true"
    }
    if (!isNaN(Number(str))) {
        return Number(str)
    }
    try {
        var evalTemp = eval(str);
        if (typeof evalTemp == "string") {
            evalTemp = '"' + eval(str) + '"';
        }
        return evalTemp;
    } catch (e) { }
    return str
};
CalcEval.prototype.matchOutBrackets = function (f) {
    var h = new Array();
    if (f == null) {
        return h
    }
    if (typeof f != "string") {
        f = f + ""
    }
    var d = f.split("");
    var a = 0;
    var g = false;
    var b = -1;
    for (var c = 0; c < d.length; c++) {
        if (d[c] == "(") {
            a++;
            g = true;
            if (b == -1) {
                b = c
            }
        }
        if (d[c] == ")") {
            a--
        }
        if (g == true && a == 0) {
            var e = new Object();
            e.str = f.substring(b, c + 1);
            e.firstIndex = b;
            e.lastIndex = c + 1;
            h.push(e);
            b = -1;
            g = false;
            a = 0
        }
    }
    return h
};
CalcEval.prototype.matchExp = function (l, f) {
    var j = null;
    if (l == null) {
        return retList
    }
    if (typeof l != "string") {
        l = l + ""
    }
    var k = l.split("");
    var c = 0;
    var b = 0;
    var g = "";
    var e = "";
    var a = "";
    var d = false;
    for (var h = 0; h <= k.length; h++) {
        if (k[h] == "+" || k[h] == "-" || k[h] == "*" || k[h] == "/" || k[h] == "%" || h == k.length) {
            if (a == "" && k[h] == "-") {
                a += k[h];
                continue
            }
            if (d == true) {
                e = a;
                b = h;
                j = new Object();
                j.firstIndex = c;
                j.secondIndex = b;
                //j.str = l.substring(c, b);
                j.str = g + f + e;
                j.firstValue = Number(g);
                j.secondValue = Number(e);
                break
            }
            if (k[h] == null) {
                break
            }
            if (k[h] == f) {
                d = true;
                g = a;
                a = ""
            } else {
                a = "";
                c = -1
            }
        } else {
            a += k[h];
            if (c == -1) {
                c = h
            }
        }
    }
    return j
};
CalcEval.prototype.executeAddi = function (arg1, arg2) {
    var r1, r2, m;
    try {
        r1 = arg1.toString().split(".")[1].length
    } catch (e) {
        r1 = 0
    }
    try {
        r2 = arg2.toString().split(".")[1].length
    } catch (e) {
        r2 = 0
    }
    m = Math.pow(10, Math.max(r1, r2));
    return this.numToString((this.evalRecursion(arg1 + "*" + m) + this.evalRecursion(arg2 + "*" + m)) / m);
};
CalcEval.prototype.executeSubt = function (arg1, arg2) {
    var r1, r2, m, n;
    try {
        r1 = arg1.toString().split(".")[1].length
    } catch (e) {
        r1 = 0
    }
    try {
        r2 = arg2.toString().split(".")[1].length
    } catch (e) {
        r2 = 0
    }
    m = Math.pow(10, Math.max(r1, r2));
    n = (r1 >= r2) ? r1 : r2;

    return this.numToString(((this.evalRecursion(arg1 + "*" + m) - this.evalRecursion(arg2 + "*" + m)) / m).toFixed(n));
};
CalcEval.prototype.executeMult = function (arg1, arg2) {
    var a = 0,
        f = arg1.toString(),
        c = arg2.toString();
    try {
        a += f.split(".")[1].length
    } catch (g) { }
    try {
        a += c.split(".")[1].length
    } catch (g) { }

    return this.numToString(Number(f.replace(".", "")) * Number(c.replace(".", "")) / Math.pow(10, a));
};
CalcEval.prototype.executeDivi = function (arg1, arg2) {
    var t1 = 0,
        t2 = 0,
        r1, r2;
    try {
        t1 = arg1.toString().split(".")[1].length
    } catch (e) { }
    try {
        t2 = arg2.toString().split(".")[1].length
    } catch (e) { }
    r1 = Number(arg1.toString().replace(".", ""));
    r2 = Number(arg2.toString().replace(".", ""));

    return this.executeMult(this.numToString(r1 / r2), Math.pow(10, t2 - t1).toString);
    //return this.executeMult(r1 / r2, pow(10, t2 - t1))
};

CalcEval.prototype.numToString = function (n) {
    var d,
        l,
        r,
        len,
        lArr;
    if (typeof n == 'number') {
        d = n.toString();
        if (d.indexOf('e') != -1) {
            // l: 1234564120000.0000000
            l = d.split('e')[0]; //    1.23456412e+20   1.23456412e-20
            // +20
            r = d.split('e')[1]; // 1.23456412e+20   1.23456412e-20
            // 20
            len = parseInt(r.substring(2, r.length - 1));
            // +20
            if (r.indexOf('+') != -1) {
                // 1.2345.6412000000000000000000000000
                l = l + "00000000000000000000000000000000000000";

                // 1          2345664120000000
                lArr = l.split('.');
                // 12345664120000000000000
                l = lArr[0] + lArr[1].substring(0, len);
                return l;
            } else if (l.indexOf('-') != 1) {
                // 000000000000000001.23456412e+20
                l = "00000000000000000000000000000000000000" + l;
                // 000000000000000001    23456412e+20
                lArr = l.split('.');
                //
                var str = lArr[0].substring(lArr[0].length - len, lArr[0].length) + lArr[1];
                l = '0.' + str;
                return l;
            }
        } else {
            return n.toString();
        }
    } else {
        return n;
    }
};;
//用于计算规则的公式
(function ($) {


    $.fn.extend({
        '_isMobile': function () {
            return false;//如果隐藏规则和计算规则做了处理这里就不要处理了。直接返回所有格式为yyyy-MM-dd
            if ((navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i))) {
                return true;
            }
            return false;
        },
        //SUM(a,b,...),求和
        'SUM': function () {

            var sum = 0;
            var str = "";
            for (var i = 0; i < arguments.length; i++) {
                if (arguments[i] != '' && !isNaN(arguments[i])) {
                    sum += Number(arguments[i]);
                    str += arguments[i] + "+";
                }
            }
            str = str.substring(0, str.length - 1);
            if (str == "") {
                return 0;
            }
            var cal = new CalcEval();
            return cal.eval(str);
        },
        //MAX(a,b,c,...),求最大值
        'MAX': function () {
            var max = arguments[0];
            for (var i = 0; i < arguments.length; i++) {
                if (max < arguments[i]) {
                    max = arguments[i];
                }
            }
            return max;
        },
        //MIN(a,b,...),求最小值
        'MIN': function () {

            var min = arguments[0];
            for (var i = 0; i < arguments.length; i++) {
                if (min > arguments[i]) {
                    min = arguments[i];
                }
            }
            return min;
        },
        //ABS(a),求绝对值
        'ABS': function () {
            var abs = 0;
            if (!isNaN(arguments[0])) {
                abs = Math.abs(Number(arguments[0]));
            }
            return Number(abs);
        },
        //AVG(a,b,...),求平均值
        'AVG': function () {
            var length = 0;
            var sum = 0;
            var str = "";
            for (var i = 0, len = arguments.length; i < len; i++) {
                if (!isNaN(arguments[i])) {
                    //sum += Number(arguments[i]);
                    str += arguments[i] + "+";
                    length++;
                }
            }
            if (length == 0) {
                return 0;
            }
            str = str.substring(0, str.length - 1);
            if (str == "") {
                return 0;
            }
            str = "(" + str + ")/" + length;
            var cal = new CalcEval();
            return cal.eval(str);
        },
        //SIN(a)//参数是角度
        'SIN': function () {
            var sin = 0;
            var arg = arguments[0];
            if (!isNaN(arg)) {
                sin = Math.sin(Number(arg) * 2 * Math.PI / 360);
            }
            return Number(sin);
        },
        //COS(a)//参数是角度
        'COS': function () {
            var cos = 0;
            var arg = arguments[0];
            if (!isNaN(arg))
                cos = Math.cos(Number(arg) * 2 * Math.PI / 360);
            return Number(cos);
        },
        //PI()
        'PI': function () {
            return Number(Math.PI);
        },
        //ROUND(a,b) 四舍五入到制定位数
        'ROUND': function () {
            var target = arguments[0];
            var accuracy = arguments[1];

            if (isNaN(target) || isNaN(accuracy)) {
                return 0;
            }
            return Number(Number(target).toFixed(Number(accuracy)));
        },
        //SQRT(a)
        'SQRT': function () {
            var sqrt = 0;
            if (!isNaN(arguments[0])) {
                sqrt = Math.sqrt(Number(arguments[0]));
            }
            return Number(sqrt);
        },
        //NOW(),当前时间
        'NOW': function () {
            if ($.fn._isMobile()) {
                return new Date().Format('yyyy/MM/dd hh:mm:ss');
            } else {
                return new Date().Format('yyyy-MM-dd hh:mm:ss');
            }
        },
        //YEAR(date),返回日期年份()
        'YEAR': function () {
            var year = 1900;
            if (arguments.length < 1) {
                return year;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            //Error要处理data格式
            date = date.toString().replace(/-/g, '/');
            var d = new Date(date);
            year = d.getFullYear();
            return Number(year);
        },
        //YEARS(endDate,startDate)返回两个日期之间年份差
        'YEARS': function () {
            var end = arguments[0];
            var start = arguments[1];
            var second = 1000, minute = second * 60, hour = minute * 60, day = hour * 24, year = day * 365;
            if (!end || !start) {
                return 0;
            }
            end = end.toString().replace(/-/g, '/');
            start = start.toString().replace(/-/g, '/');
            var dateEnd = new Date(end);
            var dateStart = new Date(start);
            var diff = dateEnd - dateStart;
            //if (isNaN(diff)) return NaN;
            if (isNaN(diff)) return 0;
            return Number((diff / year).toFixed(2));
        },
        //QUARTER(date),返回日期季度
        'QUARTER': function () {
            var quarter = 1;
            if (arguments.length < 1) {
                return quarter;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            var d = new Date(date);
            // quarter = parseInt((d.getMonth() + 2) / 4) + 1;
            var curMonth = d.getMonth() + 1;
            if (curMonth >= 1 && curMonth <= 3) {
                return 1;
            } else if (curMonth > 3 && curMonth <= 6) {
                return 2;
            } else if (curMonth > 6 && curMonth <= 9) {
                return 3;
            } else if (curMonth > 9 && curMonth <= 12) {
                return 4;
            } else {
                return null;
            }
            //return Number(quarter);
        },
        //MONTH(date),返回日期月份
        'MONTH': function () {
            var month = 1;
            if (arguments.length < 1) {
                return month;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            var d = new Date(date);
            month = d.getMonth() + 1;
            return Number(month);
        },
        //DAY(date),返回日期天
        'DAY': function () {
            var day = 1;
            if (arguments.length < 1) {
                return day;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            var d = new Date(date);
            day = d.getDate();
            return Number(day);
        },
        //HOUR(time),返回时间中小时部分
        'HOUR': function () {
            var hour = 0;
            if (arguments.length < 1) {
                return hour;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            if (date.trim().length <= 5 && date.indexOf(':') > 0) {
                return Number(date.trim().split(':')[0]);
            }
            var d = new Date(date);
            hour = d.getHours();
            return Number(hour);
        },
        //MINUTE(time),返回时间中分钟部分
        'MINUTE': function () {
            var minute = 0;
            if (arguments.length < 1) {
                return minute;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            if (date.trim().length <= 5 && date.indexOf(':') > 0) {
                return Number(date.trim().split(':')[1]);
            }
            var d = new Date(date);
            minute = d.getMinutes();
            return Number(minute);
        },
        //SECOND(time),返回时间中秒部分
        'SECOND': function () {
            var second = 0;
            if (arguments.length < 1) {
                return second;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            var d = new Date(date);
            second = d.getSeconds();
            return Number(second);
        },
        //TODAY(),返回当前日期
        'TODAY': function () {
            var newDate = new Date();
            if ($.fn._isMobile()) {
                return new Date().Format('yyyy/MM/dd');
            } else {
                return new Date().Format('yyyy-MM-dd');
            }
        },
        //WEEKDAY(date),返回指定日期为星期几
        'WEEKDAY': function () {
            var weekday = 0;
            if (arguments[0].length == 0) {
                return weekday;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            date = new Date(date);
            weekday = date.getDay();
            return weekday;
        },
        //WEEKNUM(date),返回指定日期是一年中第几周
        'WEEKNUM': function () {
            var weeknum = 0;
            if (arguments[0].length == 0) {
                return weeknum;
            }
            var date = arguments[0];
            if (!date) {
                return -1;
            }
            date = date.toString().replace(/-/g, '/');
            date = new Date(date);
            var year = date.getFullYear();
            var month = date.getMonth();
            var day = date.getDate();

            var today = new Date(year, month, day);
            var firstDayOfYear = new Date(year, 0, 1);
            var days = (today.getTime() - firstDayOfYear.getTime()) / (1000 * 60 * 60 * 24);

            var firstWeekDay = firstDayOfYear.getDay();//第一天星期几
            weeknum = Math.ceil(Number(days - (6 - firstWeekDay)) / 7);
            return weeknum + 1;
        },
        //DATE(year,month,day,[hour,minute,second]),将年月日时分秒转成日期对象
        'DATE': function () {
            var date = null;
            if (arguments.length != 3 && arguments.length != 6) {
                return date;
            }
            var y = arguments[0];
            if (!y) {
                return null;
            }
            var m = arguments[1] ? arguments[1] : 0;
            var d = arguments[2] ? arguments[2] : 0;
            var h = arguments[3] ? arguments[3] : 0;
            var mm = arguments[4] ? arguments[4] : 0;
            var s = arguments[5] ? arguments[5] : 0;
            date = new Date(y, m - 1, d, h, mm, s);
            if ($.fn._isMobile()) {
                if (arguments.length == 3) {
                    return date.Format('yyyy/MM/dd');
                } else if (arguments.length == 6) {
                    return date.Format('yyyy/MM/dd hh:mm:ss');
                }
            } else {
                if (arguments.length == 3) {
                    return date.Format('yyyy-MM-dd');
                } else if (arguments.length == 6) {
                    return date.Format('yyyy-MM-dd hh:mm:ss');
                }
            }
        },
        //转换日期格式为yyyy-mm-dd hh:m:ss
        'CONVERTTIME': function (time) {
            time = time.toString().replace(/-/g, '/');
            if ($.fn._isMobile()) {
                return new Date(time).Format('yyyy/MM/dd hh:mm:ss');
            } else {
                return new Date(time).Format('yyyy-MM-dd hh:mm:ss');
            }
        },
        //ADDYEAR(date,years),将指定日期加减指定年数
        'ADDYEAR': function () {
            var date = arguments[0];
            var days = arguments[1];
            if (date == void 0 || date == '') {
                return void 0;
            }
            var flag = false;
            if (date.length <= 10) {
                flag = true;
            }
            date = date.toString().replace(/-/g, '/');
            date = new Date(date);
            var newDate = new Date(date.setYear(date.getFullYear() + parseInt(arguments[1])));
            if ($.fn._isMobile()) {
                if (flag) {
                    newDate = new Date(newDate).Format('yyyy/MM/dd');
                } else {
                    newDate = new Date(newDate).Format('yyyy/MM/dd hh:mm');
                }
            } else {
                if (flag) {
                    newDate = new Date(newDate).Format('yyyy-MM-dd');
                } else {
                    newDate = new Date(newDate).Format('yyyy-MM-dd hh:mm');
                }
            }
            return newDate;
        },
        //ADDMONTH(date,months),将指定日期加减指定月数
        'ADDMONTH': function () {
            var date = arguments[0];
            var days = arguments[1];
            if (date == void 0 || date == '') {
                return void 0;
            }
            var flag = false;
            if (date.length <= 10) {
                flag = true;
            }
            date = date.toString().replace(/-/g, '/');
            date = new Date(date);
            var newDate = new Date(date.setMonth(date.getMonth() + parseInt(arguments[1])));
            if ($.fn._isMobile()) {
                if (flag) {
                    newDate = new Date(newDate).Format('yyyy/MM/dd');
                } else {
                    newDate = new Date(newDate).Format('yyyy/MM/dd hh:mm');
                }
            } else {
                if (flag) {
                    newDate = new Date(newDate).Format('yyyy-MM-dd');
                } else {
                    newDate = new Date(newDate).Format('yyyy-MM-dd hh:mm');
                }
            }
            return newDate;
        },
        //ADDDAY(date,days),将指定日期加减指定天数
        'ADDDAY': function () {
            var date = arguments[0];
            var days = arguments[1];
            if (date == void 0 || date == '') {
                return void 0;
            }
            //Error,建议用正则表达式匹配
            var flag = false;//标识是否只是日期格式yyyy-mm-dd
            if (date.length <= 10) {
                flag = true;
            }
            date = date.toString().replace(/-/g, '/');

            date = new Date(date);
            var newDate = new Date(date.setDate(date.getDate() + parseInt(days)));
            if ($.fn._isMobile()) {
                if (flag) {
                    newDate = new Date(newDate).Format('yyyy/MM/dd');
                } else {
                    newDate = new Date(newDate).Format('yyyy/MM/dd hh:mm');
                }
            } else {
                if (flag) {
                    newDate = new Date(newDate).Format('yyyy-MM-dd');
                } else {
                    newDate = new Date(newDate).Format('yyyy-MM-dd hh:mm');
                }
            }
            return newDate;
        },
        //DAYS(end,start) 两个日期之间天数
        'DAYS': function () {
            var end = arguments[0];
            var start = arguments[1];

            var temp1 = ((diff / hour).toString()).split('.')[0];
            var temp2 = ((diff / hour).toString()).split('.')[1];

            if (end == void 0 || start == void 0)
                return 0;
            var second = 1000, minute = second * 60, hour = minute * 60, day = hour * 24;
            end = end.toString().replace(/-/g, '/');
            start = start.toString().replace(/-/g, '/');
            var dateEnd = new Date(end);
            var dateStart = new Date(start);
            var diff = dateEnd - dateStart;
            //if (isNaN(diff)) return NaN;
            if (isNaN(diff)) return 0;
            return Number((diff / day).toFixed(2));
        },
        'FILTERWEEK': async function () {
            var total = 0;
            var workour = 0;
            var dy = 24 * 60 * 60 * 1000

            if (arguments.length >= 4) {
                var end = arguments[0];
                var start = arguments[1];
                var flag = arguments[2];
                var endString = (end.split(' '))[0];
                var startString = (start.split(' '))[0]
                var endDay = new Date(endString);
                var startDay = new Date(startString);
                var ruleList = [];

                var dateEnd = new Date(end);
                var dateStart = new Date(start);
                if (dateStart > dateEnd) {
                    return 0;
                }
                for (var i = 3; i < arguments.length; i++) {
                    var temp1 = arguments[i].split('-')[0]
                    var temp2 = arguments[i].split('-')[1]
                    var nowTime1 = new Date(endString + ' ' + temp1)
                    var nowTime2 = new Date(endString + ' ' + temp2)
                    workour += (nowTime2 - nowTime1)
                }

                if(startString==""||endString==""){
                    return 0;
                }

                var res = await HTTP.dateFilter({ startTime: startString, endTime: endString });
                var Rounding = function (diff) {
                    var hour = (60 * 60 * 1000)
                    if(flag.toLowerCase()=='hh'){
                        var temp1 = ((diff / hour).toString()).split('.')[0];
                        var temp2 = ((diff / hour).toString()).split('.')[1];
                    }
                    else if(flag.toLowerCase()=='dd'){
                        var temp1 = ((diff / workour).toString()).split('.')[0];
                        var temp2 = ((diff / workour).toString()).split('.')[1];
                    }
                    else{
                        return 0;
                    }
                   
                    if (temp2) {
                        if (parseFloat('0.' + temp2) > 0.5) {
                            return parseInt(temp1) + 1
                        }
                        else {
                            return parseFloat(temp1) + 0.5
                        }
                    }
                    else {
                        return temp1;
                    }

                }
                if (res.code != 0) {
                    this.$Message.error(res.msg);
                }
                else {
                    //在同一天
                    if (endString == startString) {
                        if (res.data.startTime == 0) {
                            return 0;
                        }
                        var dayTime = 0;
                        for (var i = 3; i < arguments.length; i++) {
                            var obj = {}
                            var temp1 = arguments[i].split('-')[0]
                            var temp2 = arguments[i].split('-')[1]
                            var nowTime1 = new Date(endString + ' ' + temp1)
                            var nowTime2 = new Date(endString + ' ' + temp2)
                            obj.start = nowTime1;
                            obj.end = nowTime2;
                            if (dateStart <= nowTime1) {
                                if (dateEnd <= nowTime1) {
                                    return Rounding(total);
                                }
                                else if (nowTime1 < dateEnd && dateEnd <= nowTime2) {

                                    total += dateEnd - nowTime1
                                    console.log(Rounding(total));
                                    return Rounding(total);
                                }
                                else if (dateEnd > nowTime2) {
                                    total += (nowTime2 - nowTime1)
                                }
                            }
                            else if (nowTime1 < dateStart && dateStart <= nowTime2) {
                                if (nowTime1 < dateEnd && dateEnd <= nowTime2) {

                                    total += dateEnd - dateStart
                                    console.log(Rounding(total));
                                    return Rounding(total);
                                }
                                else if (dateEnd > nowTime2) {
                                    total += (nowTime2 - dateStart)
                                }
                            }
                            else {
                                continue;
                            }

                        }
                        console.log(Rounding(total));
                        return Rounding(total);
                    }
                    //不再同一天
                    else {
                        //中间没有间隔  
                        if (((endDay - startDay) / dy) < 2) {

                        }
                        //中间有间隔
                        else {
                            total = total + res.data.intervalDay * workour;
                        }
                        var first = 0
                        var last = 0
                        var firstflag = true
                        if(res.data.startTime==1){
                            for (var i = 3; i < arguments.length; i++) {
                                var temp1 = arguments[i].split('-')[0]
                                var temp2 = arguments[i].split('-')[1]
                                var startTime1 = new Date(startString + ' ' + temp1)
                                var startTime2 = new Date(startString + ' ' + temp2)
    
                                if (firstflag == true) {
                                    if (dateStart <= startTime1) {
                                        total += workour
                                        break;
                                    }
                                    else if (startTime1 < dateStart && dateStart <= startTime2) {
                                        total += (startTime2 - dateStart)
                                        firstflag = false
                                        continue;
                                    }
                                    else if (dateStart > startTime2) {
    
                                    }
                                }
                                else {
                                    total += (startTime2 - startTime1)
                                }
    
    
                            }
                        }
                        if(res.data.endTime==1){
                            for (var i = 3; i < arguments.length; i++) {
                                var temp1 = arguments[i].split('-')[0]
                                var temp2 = arguments[i].split('-')[1]
                                var endTime1 = new Date(endString + ' ' + temp1)
                                var endTime2 = new Date(endString + ' ' + temp2)
    
    
                                if (dateEnd <= endTime1) {
    
                                }
                                else if (endTime1 < dateEnd && dateEnd <= endTime2) {
                                    total += (dateEnd - endTime1)
                                    continue;
                                }
                                else if (dateEnd > endTime2) {
                                    total += (endTime2 - endTime1)
                                }
                            }
                        }
                        
                        return Rounding(total)

                    }
                }




            }
            else {
                return 0;
            }

        },

        'INTIMESTAMP': function () {
            var total = 0;
            var workour = 0;
            var dy = 24 * 60 * 60 * 1000
            var Rounding = function (diff) {
                var hour = (60 * 60 * 1000)
                var temp1 = ((diff / hour).toString()).split('.')[0];
                var temp2 = ((diff / hour).toString()).split('.')[1];
                if (temp2) {
                    if (parseFloat('0.' + temp2) > 0.5) {
                        return parseInt(temp1) + 1
                    }
                    else {
                        return parseFloat(temp1) + 0.5
                    }
                }
                else {
                    return temp1;
                }

            }
            if (arguments.length >= 3) {
                var end = arguments[0];
                var start = arguments[1];
                var endString = (end.split(' '))[0];
                var startString = (start.split(' '))[0]
                var endDay = new Date(endString);
                var startDay = new Date(startString);
                var ruleList = [];

                var dateEnd = new Date(end);
                var dateStart = new Date(start);
                if (dateStart > dateEnd) {
                    return Rounding(total);
                }
                for (var i = 2; i < arguments.length; i++) {
                    var temp1 = arguments[i].split('-')[0]
                    var temp2 = arguments[i].split('-')[1]
                    var nowTime1 = new Date(endString + ' ' + temp1)
                    var nowTime2 = new Date(endString + ' ' + temp2)
                    workour += (nowTime2 - nowTime1)
                }


                //在同一天
                if (endString == startString) {
                    var dayTime = 0;
                    for (var i = 2; i < arguments.length; i++) {
                        var obj = {}
                        var temp1 = arguments[i].split('-')[0]
                        var temp2 = arguments[i].split('-')[1]
                        var nowTime1 = new Date(endString + ' ' + temp1)
                        var nowTime2 = new Date(endString + ' ' + temp2)
                        obj.start = nowTime1;
                        obj.end = nowTime2;
                        if (dateStart <= nowTime1) {
                            if (dateEnd <= nowTime1) {
                                return Rounding(total);
                            }
                            else if (nowTime1 < dateEnd && dateEnd <= nowTime2) {

                                total += dateEnd - nowTime1
                                console.log(Rounding(total));
                                return Rounding(total);
                            }
                            else if (dateEnd > nowTime2) {
                                total += (nowTime2 - nowTime1)
                            }
                        }
                        else if (nowTime1 < dateStart && dateStart <= nowTime2) {
                            if (nowTime1 < dateEnd && dateEnd <= nowTime2) {

                                total += dateEnd - dateStart
                                console.log(Rounding(total));
                                return Rounding(total);
                            }
                            else if (dateEnd > nowTime2) {
                                total += (nowTime2 - dateStart)
                            }
                        }
                        else {
                            continue;
                        }

                    }
                    console.log(Rounding(total));
                    return Rounding(total);
                }
                //不再同一天
                else {
                    //中间没有间隔  
                    if (((endDay - startDay) / dy) < 2) {

                    }
                    //中间有间隔
                    else {
                        total = ((endDay - startDay) / dy - 1) * workour
                    }
                    var first = 0
                    var last = 0
                    var firstflag = true
                    for (var i = 2; i < arguments.length; i++) {
                        var temp1 = arguments[i].split('-')[0]
                        var temp2 = arguments[i].split('-')[1]
                        var startTime1 = new Date(startString + ' ' + temp1)
                        var startTime2 = new Date(startString + ' ' + temp2)

                        if (firstflag == true) {
                            if (dateStart <= startTime1) {
                                total += workour
                                break;
                            }
                            else if (startTime1 < dateStart && dateStart <= startTime2) {
                                total += (startTime2 - dateStart)
                                firstflag = false
                                continue;
                            }
                            else if (dateStart > startTime2) {

                            }
                        }
                        else {
                            total += (startTime2 - startTime1)
                        }


                    }
                    for (var i = 2; i < arguments.length; i++) {
                        var temp1 = arguments[i].split('-')[0]
                        var temp2 = arguments[i].split('-')[1]
                        var endTime1 = new Date(endString + ' ' + temp1)
                        var endTime2 = new Date(endString + ' ' + temp2)


                        if (dateEnd <= endTime1) {

                        }
                        else if (endTime1 < dateEnd && dateEnd <= endTime2) {
                            total += (dateEnd - endTime1)
                            continue;
                        }
                        else if (dateEnd > endTime2) {
                            total += (endTime2 - endTime1)
                        }



                    }
                    console.log(Rounding(total));
                    return Rounding(total)

                }

            }
            return Rounding(total)

        },




        //DAY8S(end,start) 两个日期之间天数,一天八小时工作制
        'DAY8S': function () {
            var end = arguments[0];
            var start = arguments[1];
            if (end == void 0 || start == void 0)
                return 0;

            var second = 1000, minute = second * 60, hour = minute * 60, day = hour * 24;
            end = end.toString().replace(/-/g, '/');
            start = start.toString().replace(/-/g, '/');

            var endString = (end.split(' '))[0];
            var startString = (start.split(' '))[0]

            var endDay = new Date(endString);
            var startDay = new Date(startString);

            var dateEnd = new Date(end);
            var dateStart = new Date(start);

            if (dateEnd <= dateStart) {
                return 0;
            }

            if (dateStart.getHours() < 9) {
                dateStart = new Date(startString + ' 08:59')
            }
            else if (dateStart.getHours() >= 9 && dateStart.getHours() < 12) {

            }
            else if (dateStart.getHours() >= 12 && dateStart.getHours() < 13) {
                dateStart = new Date(startString + ' 12:59')
            }

            if (dateEnd.getHours() >= 18) {
                dateEnd = new Date(endString + ' 17:59')
            }
            else if (dateEnd.getHours() >= 13 && dateEnd.getHours() < 18) {

            }
            else if (dateEnd.getHours() >= 12 && dateEnd.getHours() < 13) {
                dateEnd = new Date(endString + ' 11:59')
            }


            //减去中午1个小时的休息时间


            //1.第一种情况 ，在同一天
            if (endString == startString) {
                if (dateEnd.getHours() > 12 && dateStart.getHours() < 12) {
                    var diff = dateEnd - dateStart - hour;
                }
                else {
                    var diff = dateEnd - dateStart
                }

                if (diff <= 0) {
                    return 0
                }
                else if (dateEnd.getHours() < 9 || dateStart.getHours() > 17) {
                    return 0
                }
                else {
                    var temp1 = ((diff / hour).toString()).split('.')[0];
                    var temp2 = ((diff / hour).toString()).split('.')[1];
                    if (temp2) {
                        if (parseFloat('0.' + temp2) > 0.5) {
                            return parseInt(temp1) + 1
                        }
                        else {
                            return parseFloat(temp1) + 0.5
                        }
                    }
                    else {
                        return temp1;
                    }

                }
            }
            //不在同一天
            else {
                var day1, dayMiddle, day2 = 0;
                //获取第一天的时间
                if (dateStart.getHours() < 9) {
                    day1 = 8 * hour
                }
                else if (dateStart.getHours() >= 18) {
                    day1 = 0
                }
                else if (dateStart.getHours() >= 9 && dateStart.getHours() < 12) {
                    day1 = new Date(startString + ' 12:00') - dateStart + 5 * hour
                }
                else if (dateStart.getHours() >= 12 && dateStart.getHours() < 13) {
                    day1 = 5 * hour
                }
                else {
                    day1 = new Date(startString + ' 18:00') - dateStart
                }

                //获取最后一天的时间
                if (dateEnd.getHours() < 9) {
                    day2 = 0
                }
                else if (dateEnd.getHours() >= 9 && dateEnd.getHours() < 12) {
                    day2 = dateEnd - new Date(endString + ' 9:00')
                }
                else if (dateEnd.getHours() >= 12 && dateEnd.getHours() < 13) {
                    day12 = 3 * hour
                }
                else if (dateEnd.getHours() >= 13 && dateEnd.getHours() < 18) {
                    day2 = dateEnd - new Date(endString + ' 13:00') + 3 * hour
                }
                else {
                    day2 = 8 * hour
                }
                //获取中间时间
                var abc = (endDay - startDay)
                if (((endDay - startDay) / day) <= 1) {
                    dayMiddle = 0
                }
                else {
                    dayMiddle = ((endDay - startDay) / day - 1) * 8 * hour
                }


                var totleTime = day2 + day1 + dayMiddle

                var temp1 = ((totleTime / hour).toString()).split('.')[0];
                var temp2 = ((totleTime / hour).toString()).split('.')[1];
                if (temp2) {
                    if (parseFloat('0.' + temp2) > 0.5) {
                        return parseInt(temp1) + 1
                    }
                    else {
                        return parseFloat(temp1) + 0.5
                    }
                }
                else {
                    return temp1;
                }


            }




            //if (isNaN(diff)) return NaN;

        },

        //HOURS(end,start) 两个日期之间小时数
        'HALF': function () {
            var end = arguments[0];
            if (end.length == 10) {
                end += ' 00:00';
            }
            var reg = new RegExp(/^\d{2}:\d{2}/);
            if (reg.test(end)) {
                var date = new Date();
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                m = m > 9 ? m : '0' + m;
                d = d > 9 ? d : '0' + d;
                end = y + '-' + m + '-' + d + ' ' + end;
            }
            var start = arguments[1];
            if (start.length == 10) {
                start += ' 00:00';
            }
            if (reg.test(start)) {
                var date = new Date();
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                m = m > 9 ? m : '0' + m;
                d = d > 9 ? d : '0' + d;
                start = y + '-' + m + '-' + d + ' ' + start;
            }
            var second = 1000, minute = second * 60, hour = minute * 60, day = hour * 24;
            end = end.toString().replace(/-/g, '/');
            start = start.toString().replace(/-/g, '/');
            var dateEnd = new Date(end);
            var dateStart = new Date(start);
            var diff = dateEnd - dateStart;
            //if (isNaN(diff)) return NaN;
            if (isNaN(diff)) return 0;

            var temp = (diff / hour).toString().split('.')
            var temp1 = temp[0];
            var temp2 = temp[1];

            if (temp2) {
                temp2 = '0.' + temp2;
                if (parseFloat(temp2) <= 0.5) {
                    return parseFloat(temp1) + 0.5
                }
                else {
                    return parseInt(temp1) + 1
                }
            }
            else {
                return parseInt(temp1)
            }
        },

        //HOURS(end,start) 两个日期之间小时数
        'HOURS': function () {
            var end = arguments[0];
            if (end.length == 10) {
                end += ' 00:00';
            }
            var reg = new RegExp(/^\d{2}:\d{2}/);
            if (reg.test(end)) {
                var date = new Date();
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                m = m > 9 ? m : '0' + m;
                d = d > 9 ? d : '0' + d;
                end = y + '-' + m + '-' + d + ' ' + end;
            }
            var start = arguments[1];
            if (start.length == 10) {
                start += ' 00:00';
            }
            if (reg.test(start)) {
                var date = new Date();
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                m = m > 9 ? m : '0' + m;
                d = d > 9 ? d : '0' + d;
                start = y + '-' + m + '-' + d + ' ' + start;
            }
            var second = 1000, minute = second * 60, hour = minute * 60, day = hour * 24;
            end = end.toString().replace(/-/g, '/');
            start = start.toString().replace(/-/g, '/');
            var dateEnd = new Date(end);
            var dateStart = new Date(start);
            var diff = dateEnd - dateStart;
            //if (isNaN(diff)) return NaN;
            if (isNaN(diff)) return 0;
            return Number((diff / hour).toFixed(2));
        },
        //MINUTES(end,start) 两个日期之间分钟数
        'MINUTES': function () {
            var end = arguments[0];
            if (end.length == 10) {
                end += ' 00:00';
            }
            var reg = new RegExp(/^\d{2}:\d{2}/);
            if (reg.test(end)) {
                var date = new Date();
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                m = m > 9 ? m : '0' + m;
                d = d > 9 ? d : '0' + d;
                end = y + '-' + m + '-' + d + ' ' + end;
            }
            var start = arguments[1];
            if (start.length == 10) {
                start += ' 00:00';
            }
            if (reg.test(start)) {
                var date = new Date();
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                m = m > 9 ? m : '0' + m;
                d = d > 9 ? d : '0' + d;
                start = y + '-' + m + '-' + d + ' ' + start;
            }
            var second = 1000, minute = second * 60, hour = minute * 60, day = hour * 24;
            end = end.toString().replace(/-/g, '/');
            start = start.toString().replace(/-/g, '/');
            var dateEnd = new Date(end);
            var dateStart = new Date(start);
            var diff = dateEnd - dateStart;
            //if (isNaN(diff)) return NaN;
            if (isNaN(diff)) return 0;
            return Number((diff / minute).toFixed(2));
        },
        //StartsWith(string,start) 判断字符串是否以特定字符串开始
        'STARTSWITH': function () {
            var string = arguments[0];
            var starter = arguments[1];
            if (!isNaN(string)) {
                string += '';
            }
            if (!isNaN(starter)) {
                starter += '';
            }
            var str = string.substring(0, starter.length);
            return str == starter;
        },
        //IsNullOrEmpty(a) 判断字符串是否为空
        'ISEMPTY': function () {
            var arg = arguments[0];
            if (typeof arg == 'boolean' && !arg) {
                return true;
            }
            return arg == null || arg == '';
        },
        //FORMAT(a,b) 格式化字符串
        'FORMAT': function () { },
        //IIF(a,b,c) 如果a成立则返回b否则返回c
        //'IIF': function () {
        //    var condition = arguments[0];
        //    if (eval(condition)) {
        //        return arguments[1];
        //    } else {
        //        return arguments[2];
        //    }
        //},
        'IF': function () {
            var condition = arguments[0];
            if (eval(condition)) {
                return arguments[1];
            } else {
                return arguments[2];
            }
        },
        'CASE': function () {
            for (var i = 0; i < arguments.length - 1; i++) {
                if (i % 2 == 0 && eval(arguments[i])) {
                    return arguments[i + 1];
                }
            }
        },
        'NEWGUID': function () {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        },
        //COUNT(v) 统计
        'COUNT': function () {
            return arguments.length;
        },
        //MOD(a,b)两数相除余数
        'MOD': function () {
            var mod = 0;
            if (arguments.length = 0) {
                return 0;
            } else if (arguments.length == 1) {
                return Number(arguments[0]);
            }
            var num = Number(arguments[0]);
            var div = Number(arguments[1]);
            if (div == 0) {
                return mod;
            }
            var r1, r2, m;
            try {
                r1 = num.toString().split(".")[1].length;
            } catch (e) {
                r1 = 0;
            }
            try {
                r2 = div.toString().split(".")[1].length;
            } catch (e) {
                r2 = 0;
            }
            m = r1 > r2 ? r1 : r2;
            var ret = ((num * Math.pow(10, m)) % (div * Math.pow(10, m))) / Math.pow(10, m);
            return ret;
        },
        //INT(v),向下取整
        'INT': function () {
            var int = 0;
            if (arguments.length == 0) {
                return 0;
            }
            return Math.floor(Number(arguments[0]));
        },
        'FLOOR': function () {

        },
        //trunc(number,digits),将数字截为整数或保留指定位数小数
        'TRUNC': function () {
            var trunc = 0;
            if (arguments.length == 0) {
                return trunc;
            } else if (arguments.length < 2) {
                return arguments[0];
            }
            var number = '' + arguments[0];
            var digits = Number(arguments[1]);
            var arr = number.split('.');
            var decimal = arr[1] || '';
            if (decimal.length <= digits) {
                trunc = Number(arr[0] + '.' + decimal);
            } else {
                decimal = decimal.slice(0, digits);
                trunc = Number(arr[0] + '.' + decimal);
            }
            return trunc;
        },
        //IsNumber(v),判断是否是数字
        'ISNUMBER': function () {
            var isNumber = false;
            if (arguments.length > 0) {
                isNumber = !isNaN(arguments[0]);
            }
            return isNumber;
        },
        //LEFT(text,number),从左边第一个字符串开始截取制定长度的字符串
        'LEFT': function () {
            var left = '';
            if (arguments.length > 0) {
                var str = arguments[0];
                var len = arguments[1] ? arguments[1] : 0;
                if (Number(len) <= 0) {
                    return "";
                }
                left = (str + '').slice(0, len);
            }
            return left;
        },
        //LEN(text),计算字符串长度
        'LENGTH': function () {
            var len = 0;
            if (!arguments[0]) {
                return 0;
            }
            if (arguments.length > 0) {
                len = (arguments[0] + '').length;
            }
            return len;
        },
        //LOWER(text),将字符串转成小写
        'TOLOWER': function () {
            var lower = '';
            if (arguments.length > 0) {
                var notNum = isNaN(arguments[0]);
                if (notNum) {
                    lower = arguments[0].toLowerCase();
                }
                else {
                    lower = arguments[0];
                }
            }
            return lower;
        },
        //ToUpper(text),将字符串转成大写
        'TOUPPER': function () {
            var upper = '';
            if (arguments.length > 0) {
                var notNum = isNaN(arguments[0]);
                if (notNum) {
                    upper = arguments[0].toUpperCase();
                }
                else {
                    upper = arguments[0];
                }
            }
            return upper;
        },
        //replace(oldtext,start,num,newtext),将字符串中部分字符串用另外字符串替换
        'REPLACE': function () {
            var replace = '';
            if (arguments.length == 0) {
                return replace;
            } else if (arguments.length < 4) {
                return arguments[0];
            }
            var oldStr = arguments[0] || '';
            oldStr += '';
            var start = parseInt(arguments[1]);
            var num = parseInt(arguments[2]);
            var newStr = arguments[3];
            //如果旧字符串为空，则返回新字符串
            if (oldStr.length == 0) {
                return newStr;
            }
            if (start <= 0) {
                start = 1;
            }
            //如果替换起始位置大于旧字符串长度，返回旧字符串+新字符串
            if (start > oldStr.length) {
                return oldStr + newStr;
            }
            //如果替换起始位置+替换长度>旧字符串长度,返回前部+新字符串
            if (start + num - 1 > oldStr.length) {
                var pre = oldStr.slice(0, start - 1);
                return pre + newStr;
            }
            var pre = oldStr.slice(0, start - 1);
            var post = oldStr.slice(start + num - 1);
            return pre + newStr + post;
        },
        //right(text,num),从字符串右边查找指定位数字符
        'RIGHT': function () {
            var right = '';
            if (arguments.length == 0) {
                return right;
            } else if (arguments.length < 2) {
                return arguments[0];
            }
            var text = arguments[0] || '';
            var num = Number(arguments[1]);
            var len = text.length;
            var start = len - num;
            if (start <= 0) {
                return text;
            }
            right = (text + '').slice(start);
            return right;
        },
        //search(text_find,text_within,start_num),在第二个字符串中从指定位置开始查找第一个字符串
        'SEARCH': function () {
            var index = 0;
            if (arguments.length < 3) {
                return index;
            }
            var oldStr = arguments[1] || '';
            var target = arguments[0];
            var start = Number(arguments[2]);
            if (start <= 0) {
                start = 1;
            }
            index = (oldStr + '').indexOf(target, start - 1);
            //index = (target + '').indexOf(oldStr, start - 1);
            return index + 1;
        },
        //substitute(text,old,new,times),将字符串中旧字符串用新字符串替换
        'SUBSTITUTE': function () {
            var postText = '';
            if (arguments.length >= 4) {
                //subsitute = arguments[0];
                var originalText = arguments[0] || '';
                var oldText = arguments[1] || '';
                var newText = arguments[2] || '';
                var times = arguments[3];
                originalText += '';
                if (isNaN(times)) {
                    postText = originalText.replace(oldText, newText);
                } else {
                    var tag = 0;
                    while (tag < times) {
                        originalText = originalText.replace(oldText, newText)
                        tag++;
                    }
                    postText = originalText;
                }

            } else {
                postText = arguments[0];
            }
            return postText;
        },
        //trim(t),去掉字符首位空格
        'TRIM': function () {
            var trim = '';
            if (arguments.length > 0) {
                trim = $.trim(arguments[0]);
            }
            return trim;
        },
        //Concatenate(a,b,c,...),拼接字符串
        'CONCATENATE': function () {
            var concatenate = '';
            var arg = arguments;
            for (var i = 0; i < arg.length; i++) {
                concatenate += arg[i];
            }
            return concatenate;
        },
        //VALUE(t),将文本转化为数字
        'VALUE': function () {
            var value = 0;
            if (arguments.length > 0) {
                value = Number(arguments[0]);
            }
            return value;
        },
        //CONTAIN()
        'CONTAINS': function () {
            var ret = false;
            if (arguments.length < 2) {
                return ret;
            }
            var source = arguments[0];
            var target = arguments[1];
            ret = source.indexOf(target) > -1;
            return ret;
        },
        //split(text,separator),分割字符串
        'SPLIT': function () {
            if (arguments.length == 0) {
                return [];
            }
            if (arguments.length == 1) {
                var split = [];
                split.push(arguments[0]);
                return split;
            }
            var text = arguments[0];
            var separator = arguments[1];
            return text.split(separator);
        },
        //substring(text,start,num)
        'SUBSTRING': function () {
            if (arguments.length < 3 || arguments[0] == '') {
                return null;
            }
            var start = Number(arguments[1]);
            var length = Number(arguments[2]);
            if (start <= 0) {
                start = 1;
            }
            if (length <= 0) {
                length = 0;
            }
            var substring = (arguments[0] + '').slice(start - 1, start + length - 1);
            return substring;
        },
        //获取地址控件值
        'GETADDRESS': function () {
            var address = '';
            if (arguments.length == 0) {
                return '';
            }
            address = arguments[0];
            if (address == "") {
                return address;
            } else {
                var temp = $.parseJSON(address);
                //address = temp.Province + temp.City + temp.Town + temp.Detail;
                address = temp.adname;
                if ($.trim(temp.Detail) != "") {
                    if ($.trim(address) != "") {
                        address += (" " + temp.Detail);
                    } else {
                        address = temp.Detail;
                    }
                }
            }
            return address;
        },
        //将数值转成大写人民币
        'UPPERMONEY': function () {
            var currency = '';
            if (arguments.length == 0) {
                return '';
            }
            var money = arguments[0];
            if (isNaN(money)) {
                money = 0;
            }
            money = new String(Math.round(money * 100));
            var chineseMoney = '';//准换后的汉字金额
            var str1 = '零壹贰叁肆伍陆柒捌玖';//汉字数字
            var str2 = '万仟佰拾亿仟佰拾万仟佰拾元角分';//对应单位
            var len = money.length;//money的字符串长度
            var ch1;//数字的汉语读法
            var ch2;//数字位的汉字读法
            var nZero = 0;//用来计算连续的零值的个数
            var str3;//指定位置的数值
            if (len > 15) {
                //超出计算范围
                return '';
            }
            if (money == 0) {
                chineseMoney = '零元整';
                return chineseMoney;
            }
            str2 = str2.substr(str2.length - len, len);//取出对应位数的string2值
            for (var i = 0; i < len; i++) {
                str3 = parseInt(money.substr(i, 1), 10);
                if (i != (len - 3) && i != (len - 7) && i != (len - 11) && i != (len - 15)) {
                    if (str3 == 0) {
                        ch1 = '';
                        ch2 = '';
                        nZero = nZero + 1;
                    } else if (str3 != 0 && nZero != 0) {
                        ch1 = '零' + str1.substr(str3, 1);
                        ch2 = str2.substr(i, 1);
                        nZero = 0;
                    } else {
                        ch1 = str1.substr(str3, 1);
                        ch2 = str2.substr(i, 1);
                        nZero = 0;
                    }
                } else {
                    //该位是万亿，亿，万，元位等关键位
                    if (str3 != 0 && nZero != 0) {
                        ch1 = '零' + str1.substr(str3, 1);
                        ch2 = str2.substr(i, 1);
                        nZero = 0;
                    } else if (str3 != 0 && nZero != 0) {
                        ch1 = '零' + str1.substr(str3, 1);
                        ch2 = str2.substr(i, 1);
                        nZero = 0;
                    }
                    else if (str3 != 0 && nZero == 0) {
                        ch1 = str1.substr(str3, 1);
                        ch2 = str2.substr(i, 1);
                        nZero = 0;
                    } else if (str3 == 0 && nZero >= 3) {
                        ch1 = '';
                        ch2 = '';
                        nZero = nZero + 1;
                    } else {
                        ch1 = '';
                        ch2 = str2.substr(i, 1);
                        nZero = nZero + 1;
                    }
                    if (i == (len - 11) || i == (len - 3)) {
                        //如果该位是亿位或元位，则必须写上
                        ch2 = str2.substr(i, 1);
                    }
                }
                chineseMoney = chineseMoney + ch1 + ch2;
            }
            if (str3 == 0) {
                //最后一位（分）为0时，加上“整”
                chineseMoney = chineseMoney + '整';
            }
            return chineseMoney;
        }
    });
})(jQuery);;
(function (b) { b.gritter = {}; b.gritter.options = { position: "", class_name: "", fade_in_speed: "medium", fade_out_speed: 1000, time: 1000 }; b.gritter.add = function (f) { try { return a.add(f || {}) } catch (d) { var c = "Gritter Error: " + d; (typeof (console) != "undefined" && console.error) ? console.error(c, f) : alert(c) } }; b.gritter.remove = function (d, c) { a.removeSpecific(d, c || {}) }; b.gritter.removeAll = function (c) { a.stop(c || {}) }; var a = { position: "", fade_in_speed: "", fade_out_speed: "", time: "", _custom_timer: 0, _item_count: 0, _is_setup: 0, _tpl_close: '<a class="gritter-close" href="#" tabindex="1">Close Notification</a>', _tpl_title: '<span class="gritter-title">[[title]]</span>', _tpl_item: '<div id="gritter-item-[[number]]" class="gritter-item-wrapper [[item_class]]" style="display:none" role="alert"><div class="gritter-top"></div><div class="gritter-item">[[close]][[image]]<div class="[[class_name]]">[[title]]<p>[[text]]</p></div><div style="clear:both"></div></div><div class="gritter-bottom"></div></div>', _tpl_wrap: '<div id="gritter-notice-wrapper"></div>', add: function (g) { if (typeof (g) == "string") { g = { text: g } } if (g.text === null) { throw 'You must supply "text" parameter.' } if (!this._is_setup) { this._runSetup() } var k = g.title, n = g.text, e = g.image || "", l = g.sticky || false, m = g.class_name || b.gritter.options.class_name, j = b.gritter.options.position, d = g.time || ""; this._verifyWrapper(); this._item_count++; var f = this._item_count, i = this._tpl_item; b(["before_open", "after_open", "before_close", "after_close"]).each(function (p, q) { a["_" + q + "_" + f] = (b.isFunction(g[q])) ? g[q] : function () { } }); this._custom_timer = 0; if (d) { this._custom_timer = d } var c = (e != "") ? '<img src="' + e + '" class="gritter-image" />' : "", h = (e != "") ? "gritter-with-image" : "gritter-without-image"; if (k) { k = this._str_replace("[[title]]", k, this._tpl_title) } else { k = "" } i = this._str_replace(["[[title]]", "[[text]]", "[[close]]", "[[image]]", "[[number]]", "[[class_name]]", "[[item_class]]"], [k, n, this._tpl_close, c, this._item_count, h, m], i); if (this["_before_open_" + f]() === false) { return false } b("#gritter-notice-wrapper").addClass(j).append(i); var o = b("#gritter-item-" + this._item_count); o.fadeIn(this.fade_in_speed, function () { a["_after_open_" + f](b(this)) }); if (!l) { this._setFadeTimer(o, f) } b(o).bind("mouseenter mouseleave", function (p) { if (p.type == "mouseenter") { if (!l) { a._restoreItemIfFading(b(this), f) } } else { if (!l) { a._setFadeTimer(b(this), f) } } a._hoverState(b(this), p.type) }); b(o).find(".gritter-close").click(function () { a.removeSpecific(f, {}, null, true); return false; }); return f }, _countRemoveWrapper: function (c, d, f) { d.remove(); this["_after_close_" + c](d, f); if (b(".gritter-item-wrapper").length == 0) { b("#gritter-notice-wrapper").remove() } }, _fade: function (g, d, j, f) { var j = j || {}, i = (typeof (j.fade) != "undefined") ? j.fade : true, c = j.speed || this.fade_out_speed, h = f; this["_before_close_" + d](g, h); if (f) { g.unbind("mouseenter mouseleave") } if (i) { g.animate({ opacity: 0 }, c, function () { g.animate({ height: 0 }, 300, function () { a._countRemoveWrapper(d, g, h) }) }) } else { this._countRemoveWrapper(d, g) } }, _hoverState: function (d, c) { if (c == "mouseenter") { d.addClass("hover"); d.find(".gritter-close").show() } else { d.removeClass("hover"); d.find(".gritter-close").hide() } }, removeSpecific: function (c, g, f, d) { if (!f) { var f = b("#gritter-item-" + c) } this._fade(f, c, g || {}, d) }, _restoreItemIfFading: function (d, c) { clearTimeout(this["_int_id_" + c]); d.stop().css({ opacity: "", height: "" }) }, _runSetup: function () { for (opt in b.gritter.options) { this[opt] = b.gritter.options[opt] } this._is_setup = 1 }, _setFadeTimer: function (f, d) { var c = (this._custom_timer) ? this._custom_timer : this.time; this["_int_id_" + d] = setTimeout(function () { a._fade(f, d) }, c) }, stop: function (e) { var c = (b.isFunction(e.before_close)) ? e.before_close : function () { }; var f = (b.isFunction(e.after_close)) ? e.after_close : function () { }; var d = b("#gritter-notice-wrapper"); c(d); d.fadeOut(function () { b(this).remove(); f() }) }, _str_replace: function (v, e, o, n) { var k = 0, h = 0, t = "", m = "", g = 0, q = 0, l = [].concat(v), c = [].concat(e), u = o, d = c instanceof Array, p = u instanceof Array; u = [].concat(u); if (n) { this.window[n] = 0 } for (k = 0, g = u.length; k < g; k++) { if (u[k] === "") { continue } for (h = 0, q = l.length; h < q; h++) { t = u[k] + ""; m = d ? (c[h] !== undefined ? c[h] : "") : c[0]; u[k] = (t).split(l[h]).join(m); if (n && u[k] !== t) { this.window[n] += (t.length - u[k].length) / l[h].length } } } return p ? u : u[0] }, _verifyWrapper: function () { if (b("#gritter-notice-wrapper").length == 0) { b("body").append(this._tpl_wrap) } } } })(jQuery);
;
// 系统属性扩张函数 \ 元素扩张插件
(function ($) {
    // 获取字符串类看，所有的字符串添加Trim()函数
    String.prototype.Trim = function () {
        return this.replace(/[ ]/g, "");
    }

    Array.prototype.distinct = function () {
        var newArr = [], obj = {};
        for (var i = 0, len = this.length; i < len; i++) {
            if (!obj[typeof (this[i]) + this[i]]) {
                newArr.push(this[i]);
                obj[typeof (this[i]) + this[i]] = 'new';
            }
        }
        return newArr;
    };

    //a.AddMinutes();
    //a.AddHours();
    //a.AddDays();
    //a.AddMonths();
    //a.AddYears();
    Date.prototype.AddMinutes = function (double) {
        if (isNaN(double))
            return this;
        var result = new Date();
        var totalMilliSeconds = this.getTime();
        var addMilliSeconds = double * 1000 * 60;
        totalMilliSeconds = totalMilliSeconds + addMilliSeconds;
        result.setTime(totalMilliSeconds);
        return result;
    };
    Date.prototype.AddHours = function (double) {
        if (isNaN(double))
            return this;
        var result = new Date();
        var totalMilliSeconds = this.getTime();
        var addMilliSeconds = double * 1000 * 60 * 60;
        totalMilliSeconds = totalMilliSeconds + addMilliSeconds;
        result.setTime(totalMilliSeconds);
        return result;
    };
    Date.prototype.AddDays = function (double) {
        if (isNaN(double))
            return this;
        var result = new Date();
        var totalMilliSeconds = this.getTime();
        var addMilliSeconds = double * 1000 * 60 * 60 * 24;
        totalMilliSeconds = totalMilliSeconds + addMilliSeconds;
        result.setTime(totalMilliSeconds);
        return result;
    };
    Date.prototype.AddMonths = function (double) {
        if (isNaN(double))
            return this;
        var result = new Date();
        var totalMilliSeconds = this.getTime();
        var month = result.getMonth() + 1;
        var year = result.getFullYear();
        var days = this.GetMonthDays(year, month);
        var days = 30;
        var addMilliSeconds = double * 1000 * 60 * 60 * 24 * days;
        totalMilliSeconds = totalMilliSeconds + addMilliSeconds;
        result.setTime(totalMilliSeconds);
        return result;
    };
    Date.prototype.AddYears = function (double) {
        if (isNaN(double))
            return this;
        var result = new Date();
        var totalMilliSeconds = this.getTime();
        var year = result.getFullYear();
        var days = this.IsLeap(year) ? 366 : 365;
        var addMilliSeconds = double * 60 * 1000 * 24 * days;
        totalMilliSeconds = totalMilliSeconds + addMilliSeconds;
        result.setTime(totalMilliSeconds);
        return result;
    };
    Date.prototype.IsLeap = function (year) {
        isLeap = false;
        if (year / 4 == 0) {
            if (year / 100 == 0) {
                if (year / 400 == 0) {
                    isLeap = true;
                }
            }
            else {
                isLeap = true;
            }
        }
        return isLeap;
    }
    Date.prototype.GetMonthDays = function (year, month) {
        var days = 30;
        switch (month) {
            case 1:
                days = 31;
                break;
            case 2:
                if (this.IsLeap(year)) {
                    days = 29;
                }
                else {
                    days = 28;
                }
                break;
            case 3:
                days = 31;
                break;
            case 4:
                days = 30;
                break;
            case 5:
                days = 31;
                break;
            case 6:
                days = 30;
                break;
            case 7:
                days = 31;
                break;
            case 8:
                days = 31;
                break;
            case 9:
                days = 30;
                break;
            case 10:
                days = 31;
                break;
            case 11:
                days = 30;
                break;
            case 12:
                days = 31;
                break;
        }
        return days;
    }
    //继承:所有的类继承关系，通过这个函数实现
    //用法:
    //var parentClass=function(){};
    //var subClass=function(){};
    //subClass.Inherit(parentClass,{subFun:function(){}});
    Function.prototype.Inherit = function (parent, overrides) {
        if (typeof parent != 'function') return this;
        // 保存对父类的引用
        this.Base = parent.prototype;
        this.Base.constructor = parent;
        // 继承
        var f = function () { };
        f.prototype = parent.prototype;
        this.prototype = new f();
        this.prototype.constructor = this;
        //附加属性方法
        if (overrides) $.extend(this.prototype, overrides);
    };

    // 对Date的扩展，将 Date 转化为指定格式的String
    // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
    // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
    // 例子：
    // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
    // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1,                 //月份
            "d+": this.getDate(),                    //日
            "h+": this.getHours(),                   //小时
            "m+": this.getMinutes(),                 //分
            "s+": this.getSeconds(),                 //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds()             //毫秒
        };
        if (/(y+)/.test(fmt))
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt))
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };
    //支持contructor.name
    if (!(function f() { }).name) {
        Object.defineProperty(Function.prototype, 'name', {
            configurable: true,
            get: function () {
                var name = (this.toString().match(/function (.+?)\(/) || [, ''])[1];
                // For better performance only parse once, and then cache the
                // result through a new accessor for repeated access.
                Object.defineProperty(this, 'name', { value: name });
                return name;
            }
        });
    }

    //浮动弹出框
    $.fn.FloatBox = function (opt) {
        var _Default = {
            width: 200,
            height: 250,
            offsetLeft: 20,
            offsetHeight: 30,
            base_x: 'innerright',//相对基目标的显示方向  left、innerright、innerLeft、right
            base_y: 'bottom',//target对齐方式目标底部  bottom 、top
            target: null,
            source: this,
            shownCallback: null,
            hiddenCallback: null,
            actions: [],//[title,callback]
            baseDom: null,  //基准对象 如右侧对齐，上侧对齐
            documentClickVisible: true,//点击其他位置隐藏
            topbox: false
        };
        opt = $.extend({}, _Default, opt);
        var container = opt.target;
        return {
            opt: opt,
            getAbsPosition: function (element) {
                var left = 0;
                if (window.parent != window) {
                    if (window.screenLeft != void 0) {
                        left = window.screenLeft;
                    }
                    else if (window.screenX != void 0) {
                        left = window.screenX;
                    }
                }
                var abs = { x: 0, y: 0 };
                if (document.documentElement.getBoundingClientRect) {
                    abs.x = element.getBoundingClientRect().left;
                    abs.y = element.getBoundingClientRect().top;

                    abs.x += left + document.documentElement.scrollLeft - document.documentElement.clientLeft;
                    abs.y += document.body.scrollTop | document.documentElement.scrollTop + document.documentElement.scrollTop - document.documentElement.clientTop;
                } else {
                    while (element != document.body) {
                        abs.x += element.offsetLeft;
                        abs.y += element.offsetTop;
                        element = element.offsetParent;
                    }

                    abs.x += left + document.body.clientLeft - document.body.scrollLeft;
                    abs.y += document.body.scrollTop | document.documentElement.scrollTop + document.body.clientTop - document.body.scrollTop;
                }
                return abs;
            },
            show: function () {
                var right_dis = null, bottom_dis = null, position = this.getAbsPosition(opt.source.get(0));
                if (opt.baseDom) {
                    if (opt.base_x == 'innerright') {
                        var pos = this.getAbsPosition($(opt.baseDom).get(0));
                        var width = $(opt.baseDom).outerWidth();
                        right_dis = pos.x + width;
                    } else if (opt.base_x == 'innerleft' || opt.base_x == 'right') {
                        right_dis = 1000;//取无穷大
                    } else if (opt.base_x == 'left') {
                        var pos = this.getAbsPosition(opt.baseDom);
                        right_dis = pos.x;
                    }

                    //高度不限制
                    bottom_dis = $(window).height();
                } else {
                    right_dis = $(window).width();
                    bottom_dis = $(window).height();
                }

                //判断是否超出区域
                var top = 0, left = 0, selfHeight = $(opt.source).height();
                if ((position.y + selfHeight + opt.offsetHeight + opt.height) > bottom_dis) {
                    //超出屏幕高度，就在上面显示
                    top = position.y - opt.height - opt.offsetHeight;
                } else {
                    if (opt.base_y == 'top') {
                        top = position.y + opt.offsetHeight;
                    } else {
                        top = position.y + selfHeight + opt.offsetHeight;
                    }

                }
                if (position.x + opt.width > right_dis) {
                    left = right_dis - opt.width;
                } else {
                    left = position.x + opt.width;
                }
                container.css({
                    'position': 'absolute', 'top': top,
                    'left': left, 'width': opt.width + 'px',
                    'height': opt.height + 'px',
                    'border': '1px solid #ddd',
                    'box-shadow': '0 0 8px #ddd',
                    'z-index': 10002, 'background-color': '#fff',
                    'overflow-y': 'auto'
                });
                container.show();
                if (opt.shownCallback) {
                    opt.shownCallback();
                }

                document.onclick = function (event) {

                    if ($.ReportDesigner.FloatPanels.length == 0) {
                        return;
                    }
                    //如果编辑框显示也不处理
                    if ($('div#field-edit-panel').is(':visible')) {
                        return;
                    }
                    var curFloatPanel = $.ReportDesigner.FloatPanels[$.ReportDesigner.FloatPanels.length - 1];
                    if ($.ReportDesigner.FloatPanels.length - 2 >= 0) {
                        if ($.ReportDesigner.FloatPanels[$.ReportDesigner.FloatPanels.length - 1].opt.target.attr("id") && $.ReportDesigner.FloatPanels[$.ReportDesigner.FloatPanels.length - 1].opt.target.attr("id") == $.ReportDesigner.FloatPanels[$.ReportDesigner.FloatPanels.length - 2].opt.target.attr("id")) {
                            $.ReportDesigner.FloatPanels.pop();
                            $.ReportDesigner.FloatPanels.pop();
                            $.ReportDesigner.FloatPanels.push(curFloatPanel);

                        }
                        //
                    }
                    //if (!opt.documentClickVisible) {
                    //    curFloatPanel.onlyhide();
                    //    return;
                    //}
                    var target = curFloatPanel.opt.target;
                    if (!$(target).is(':visible')) {

                        return;
                    }
                    //判断点击范围
                    var x = event.pageX == 0 ? Math.abs(event.offsetX) : event.pageX;
                    var y = event.pageY == 0 ? Math.abs(event.offsetY) : event.pageY;
                    if (y > ($(target).position().top + $(target).height() + 30) ||
                        y < $(target).position().top - 30 ||
                        x > $(target).position().left + $(target).width() ||
                        x < $(target).position().left - 30
                    ) {
                        //if ($(target).is(':visible')) {
                        //    if (curFloatPanel.opt.hiddenCallback) {
                        //        curFloatPanel.opt.hiddenCallback();
                        //    }

                        //}
                        if (!opt.documentClickVisible) {
                            curFloatPanel.onlyhide();
                        }
                        else {
                            curFloatPanel.hide();
                        }


                    }
                };
            },
            hide: function () {
                //if ($(this.opt.target).is(':visible')) {
                if (this.opt.hiddenCallback) {
                    this.opt.hiddenCallback();
                }
                $(this.opt.target).hide();
                $.ReportDesigner.FloatPanels.pop();
                //}
            },
            onlyhide: function () {
                //if ($(this.opt.target).is(':visible')) {

                $(this.opt.target).hide();
                $.ReportDesigner.FloatPanels.pop();
                //}
            }
        };
    };

    //---------------------------------------下拉框------------------------------------------------
    var AppFilterMultiSelect = function (opt, Base) {
        var that = this;
        this.Options = $.extend({}, opt);
        this.base = $(Base);
        this.Value = null;
        this.configurable = true;
        this.Init();

    };
    $.fn.AppFilterMultiSelect = function (opt) {
        return new AppFilterMultiSelect(opt, this);
    }
    AppFilterMultiSelect.prototype = {
        Init: function () {
            var that = this;
            if (that.Options.OnChange && $.isFunction(that.Options.OnChange)) {
                that.OnChange = that.Options.OnChange;
            }
            that.Render();
        },
        Render: function () {
            var that = this;
            var $this = that.base;
            $this.multiselect({
                enableFiltering: true,
                filterPlaceholder: '搜索',
                buttonText: function (options, select) {
                    if (options.length === 0) {
                        return "";
                    }
                    else {
                        var labels = [];

                        options.each(function () {
                            if ($(this).attr("label") !== void 0) {
                                labels.push($(this).attr("label"));
                            }
                            else {
                                labels.push($(this).html());
                            }
                        });
                        return labels.join(";") + "";
                    }
                },
                onChange: function () {
                    if (!that.configurable)
                        return;
                    var v = [];
                    var selectedText = that.base.val();
                    if (selectedText)
                        v = selectedText;
                    that.Value = v;
                    that.OnChange();
                },
                onDropdownShow: function () {
                    //点击时选人控件隐藏
                    $("div[data-FormMultiUserPanel='SelectorPanel'],div[data-FormUserPanel='SelectorPanel'],div[data-formmultiuserpanel='searchdiv']").hide();
                    $(".form-query-dropdown").hide();
                },
                selectedClass: "multiselect-selected",
                nonSelectedText: ""
            });
            var propertyname = $this.attr("id");
            if (that.Options.defaultValue) {
                this.configurable = false;
                $this.multiselect("select", that.Options.defaultValue);
                this.configurable = true;
                this.Value = that.Options.defaultValue;
            }
            $this.parent().find("b.caret").removeClass("caret").addClass("icon-arrow-down-full");
            $this.next().find("ul.multiselect-container").off("scroll.list").on("scroll.list", function () {
                var scrollTop = $(this).scrollTop();
                $(this).find("li.filter").css({ "top": scrollTop + "px" });
            });
        },
        GetValue: function () {
            return this.Value;
        },
        SetValue: function (v) {
            this.configurable = false;
            this.base.multiselect("select", v);
            this.OnChange();
            this.configurable = true;
        },
        OnChange: function () {

        }
    }

})(jQuery);
//新增和查看按钮
(function ($) {
    var NewOrCheckList = function (opt, Base) {
        this.opt = opt;
        this.base = $(Base);
        this.schemaCode = opt.schemaCode;
        this.Init()
    }
    $.fn.NewOrCheckList = function (opt) {
        return new NewOrCheckList(opt, this);
    }
    NewOrCheckList.prototype = {
        Init: function () {
            var that = this;
            $(this.base[0]).off('click').on('click', function (e) {
                var $target = $(e.target);
                if ($target.hasClass("chakanliebiao")) {
                    var url = "/App/?id=" + that.schemaCode;
                    window.open(url);
                    e.stopPropagation();
                    return false;
                } else if ($target.hasClass("xinzengshuju")) {
                    var url = '/Form/DefaultSheet?SchemaCode=' + that.schemaCode;
                    $.ISideModal.Show(url);
                    e.stopPropagation();
                    return false;
                } else {
                    var hasCreate = $(this).find(".box-recent-operate").find(".xinzengshuju").length > 0;
                    if (hasCreate) {
                        var url = '/Form/DefaultSheet?SchemaCode=' + that.schemaCode;
                        $.ISideModal.Show(url);
                    }
                    e.stopPropagation();
                    return false;
                }
            });
            $(this.base[0]).off('mouseenter').on('mouseenter', function (e) {
                $(this).find(".box-recent-operate").show();
            });
            $(this.base[0]).off('mouseleave').on('mouseleave', function (e) {
                $(this).find(".box-recent-operate").hide();
            });
        }
    }
})(jQuery);

(function ($) {
    $.H3Popup = {};
    $.H3Popup.IsShow = false;
    $.H3Popup.options = {
        title: "",
        message: "",
        error_detail: "",
        type: "danger",
        ShowInRootWindow: false,
        MessageTip1: "查看错误详情",
        MessageTip2: "错误详情",
        showCancel: true,
        callBack: undefined
    };
    $.H3Popup.show = function (options) {
        try {
            var options = $.extend({}, $.H3Popup.options, options);
            //if (!$.H3Popup.IsShow) { //一次只显示一个modal窗口
            popup.add(options)
            //}
        } catch (msg) {

        }
    };

    var popup = {
        _modal: '<div class="modal fade jconfirm"  tabindex= "-1" role= "dialog"  data-backdrop="false" ></div>',
        _modal_dialog: '<div class="modal-dialog " role="document"></div>',
        _modal_content: ' <div class="modal-content"></div>',
        _modal_header: ' <div class="modal-header modal-header-h3base "><button type="button" class="close" data-dismiss="modal">' +
            '<span class="icon-guanbi" aria-hidden="true" style= "color:#FFFFFF" ></span></button> <h4 class="modal-title">提示</h4> </div>',
        _modal_body: ' <div class="modal-body" style="padding-top:55px;"></div>',
        _modal_message: '<span style="display: block;" class="messagesummary"></span>',
        _modal_errordetail: ' <div><div class="" style="text-align:center;margin-top:20px;margin-bottom:20px;">  <a class="has-error"><span class="messagetip1"></span><i class="fa icon-chevron-down-outline"></i></a></div>  <div class="modal-errordetail">  <div class="modal-errorcode messagetip2"></div>   <div class="modal-errordetails">  </div>  </div></div>',
        _modal_footer: '<div class="modal-footer"><div type="button" class="button btn btn-ok">确定</div><div type="button" class="button btn btn-cancel" >取消</div></div>',

        add: function (option) {
            option.ShowInRootWindow = true;
            var that = this;
            $.H3Popup.IsShow = true;
            if (option && option.message) {
                var $modal = $(this._modal);
                var $Header = $(this._modal_header);
                var dialogClassName = "modal-dialog-" + option.type;
                var headerClassName = "modal-header-" + option.type;
                if (option.title) {
                    $Header.find("h4").html(option.title);
                }
                var $modaldialog = $(this._modal_dialog).addClass(dialogClassName);
                $Header.addClass(headerClassName);
                //var $modalbody = $(this._modal_body).append($(this._modal_message).text(option.message));
                var $modalbody = $(this._modal_body).append($(this._modal_message).html(option.message));

                var $modalerrordetail = $(this._modal_errordetail);
                $modalerrordetail.find(".modal-errordetails").html(option.error_detail);
                $modalbody.append($modalerrordetail);

                //提示信息
                $modalerrordetail.find(".messagetip1").text(option.MessageTip1);
                $modalerrordetail.find(".messagetip2").html(option.MessageTip2 + ":");

                $modalerrordetail.find("a.has-error").off("click.errordetail").on("click.errordetail", function () {
                    $modalerrordetail.find("div.modal-errordetail").toggle();
                    var $i = $(this).find("i");
                    if ($i.hasClass("icon-chevron-up-outline")) {
                        $i.removeClass("icon-chevron-up-outline").addClass("icon-chevron-down-outline");
                    } else {
                        $i.removeClass("icon-chevron-down-outline").addClass("icon-chevron-up-outline");
                    }
                })
                if (!option.error_detail) {
                    $($modalerrordetail.find("a.has-error")).hide();
                }

                var $modalfooter = $(this._modal_footer);

                //取消按钮
                if (!option.showCancel) {
                    $modalfooter.find(".btn-cancel").hide();
                }

                var $modalcontent = $(this._modal_content).append($Header).append($modalbody).append($modalfooter);
                $modaldialog.append($modalcontent)
                if (option.ShowInRootWindow) {
                    $modal.append($modaldialog).appendTo($(top.window.document.body))
                } else {
                    $modal.append($modaldialog).appendTo($("body"))
                }
                $modal.modal('show');

                //高斯模糊处理
                $.MsgFilter.show();

                //确定按钮
                $modalfooter.find(".btn-ok").click(function () {
                    $modal.modal('hide');
                    $(this).attr("disabled", "disabled").text("处理中");
                    if ($.isFunction(option.callBack)) {
                        option.callBack.apply(that, [true]);
                    }
                });

                //取消操作
                $modalfooter.find(".btn-cancel").click(function () {
                    $modal.modal('hide');
                    if ($.isFunction(option.callBack)) {
                        option.callBack.apply(that, [false]);
                    }
                });

                $modal.on("shown.bs.modal", function () {
                    //设置居中
                    var windowHeight = 0;
                    if (option.ShowInRootWindow) {
                        windowHeight = $(top.window).height();
                    } else {
                        windowHeight = $(window).height();
                    }

                    var topValue = windowHeight / 2 - $modalcontent.height();
                    $modalcontent.css("margin-top", topValue);
                });

                $modal.on("hidden.bs.modal", function () {
                    $.H3Popup.IsShow = false;
                    $modal.remove();
                    $.MsgFilter.remove();
                });
            }
        }
    };

})(jQuery);

(function ($) {
    $.H3WarningBox = {};
    $.H3WarningBox.options = {
        message: "",
        type: "danger",
        fade_in_speed: 1000,
        ShowInRootWindow: false
    };

    $.H3WarningBox.BoxArray = [];

    var box = new Object();
    box._box = '<div class="alert" role= "alert" style="z-index:999999" ></div>';
    box.add = function (option) {
        var that = this;
        this.$box = $(this._box);
        var id = $.IGuid();
        this.$box.attr("id", id);
        if (option && option.message) {
            this.$box.html(option.message);
        }
        this.$box.addClass("alert-" + option.type);

        if (option.cls) {
            this.$box.addClass(option.cls);
        }

        var $close = $("<span class='icon-close hide' style='position:absolute;font-size:16px;float:right;right:8px;top:16px;'></span>")
        $close.click(function (e) {
            that.$box.remove();
            e.stopPropagation();
            e.preventDefault();
            $(window).off("unload.warningbox");
        });
        this.$box.append($close);

        var windowWidth = option.ShowInRootWindow ? top.window.innerWidth : window.innerWidth;
        var boxWidth = this.$box.outerWidth();
        if (option.ShowInRootWindow) {
            this.$box.appendTo($(top.document.body));
            $(window).off("unload.warningbox").on("unload.warningbox", function () {
                that.$box.remove();
            });
        }
        else {
            this.$box.appendTo($("body"));
        }

        this.$box.on("mouseenter", function () {
            console.log('mouseenter');
            //停止淡出
            $(this).stop().css({
                opacity: "",
                height: ""
            });
            if (that.timeOut) {
                clearTimeout(that.timeOut);
            }
            $close.removeClass("hide");

        }).on("mouseleave", function () {
            console.log('mouseleave');
            $close.addClass("hide");
            that.timeOut = setTimeout(function () { that._fadeout() }, 1000);

        });

        // this.$box.css("left", (windowWidth - 600) / 2 + "px");
        this.timeOut;
        this.$box.fadeIn(option.fade_in_speed, function () {
            that.timeOut = setTimeout(
                function () { that._fadeout(); }, 1000 * 3
            )
        });
        return this;
    },
        box.clear = function () {
            if (this.$box) {
                this.$box.remove();
                $(window).off("unload.warningbox");
            }
        },
        //淡出并移除
        box._fadeout = function () {
            var that = this;
            $.each(top.$.H3WarningBox.BoxArray, function (index, obj) {
                if (obj == that) {
                    //delete obj;
                }
            });

            this.timeOut = this.$box.fadeOut(1000, function () {
                that.$box.remove();
                $(window).off("unload.warningbox");
            })
        }

    $.H3WarningBox.show = function (options) {
        try {
            //清空
            if (top.$.H3WarningBox.BoxArray.length > 0) {
                for (var i = 0; i < top.$.H3WarningBox.BoxArray.length; i++) {
                    console.log(i);
                    var _box = top.$.H3WarningBox.BoxArray[i];
                    if (_box) {
                        _box.clear();
                    }
                }
                top.$.H3WarningBox.BoxArray.splice(0, top.$.H3WarningBox.BoxArray.length);
            }
            var options = $.extend({}, $.H3Popup.options, options);
            var b = box.add(options);
            top.$.H3WarningBox.BoxArray.push(b);

        } catch (msg) {

        }
    };

})(jQuery);

(function ($) {
    $.GetRequest = function () {
        var url = location.search;
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    };
})(jQuery);


(function ($) {
    //高斯模糊处理
    $.MsgFilter = {};
    $.MsgFilter.count = 0;
    $.MsgFilter.show = function () {
        if (this.count == 0) {
            $("body header").addClass("msg-filter");
            $("body section > div").addClass("msg-filter");
            $('body').find("iframe.filter").addClass("msg-filter");
        }
        ++this.count;
    };
    $.MsgFilter.remove = function () {
        if (this.count == 1) {
            $("body header").removeClass("msg-filter");
            $("body section > div").removeClass("msg-filter");
            $('body').find("iframe.filter").removeClass("msg-filter");
            this.count = 0;
        } else if (this.count > 0) {
            --this.count;
        }
    };
})(jQuery);

(function ($) {
    //关闭所有弹窗，选人控件，时间控件，下拉框, FormQuery
    $.HideAllPopup = function () {
        //选人
        $("div[data-FormMultiUserPanel='SelectorPanel'],div[data-FormUserPanel='SelectorPanel'],div[data-formmultiuserpanel='searchdiv']").hide();
        //下拉
        $("ul.drop-list.drop-list_s").hide();
        $(document).find("#ListView .fa-chevron-up").removeClass("fa-chevron-up").addClass("fa-chevron-down");
        //时间
        $('[data-provide="datetimepicker"]').each(function () {
            var $this = $(this);
            if ($this.data('datetimepicker')) return;
            $this.datetimepicker('hide');
        });
        //FormQuery
        $(".form-query-dropdown").hide();
    }
})(jQuery);


// JQ 扩张插件
jQuery.extend({
    SheetRuntimeContentCache: {

    },
    //创建Guid，用法:$.IGuid()
    IGuid: function () {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    },
    isJsonLike: function (str) {
        var JSON_START = /^\[|^\{(?!\{)/;
        var JSON_ENDS = {
            '[': /]$/,
            '{': /}$/
        };
        var jsonStart = str.match(JSON_START);
        return jsonStart && JSON_ENDS[jsonStart[0]].test(str);
    },
    // 读取url的参数值
    IQuery: function (name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = decodeURI(window.location.search.substr(1)).match(reg);
        if (r != null) return decodeURI(r[2]);
        return "";
    },

    IShowSuccess: function () {
        //title, msg, detail, showInRootWindow
        //{title:"",msg:"",detail:""}
        var title;
        var msg;
        var detail;
        if (!arguments) { return; } //没有输入相应参数
        if (arguments.length == 2) {
            title = arguments[0];
            msg = arguments[1]
        } else if (arguments.length == 1) {
            if (typeof (arguments[0]) == "string") {
                msg = arguments[0];
            } else if (typeof (arguments[0]) == "object") {
                var json = arguments[0];
                title = json.title;
                msg = json.msg;
                detail = json.detail;
            }
        }

        if ($.isEmptyObject(title) || title == "") {
            title = "提示";
        }
        if ($.isEmptyObject(msg) || msg == "") {
            msg = title || "";
        }
        if (detail) {
            $.H3Popup.show({ title: title, message: msg, error_detail: detail, type: "success", ShowInRootWindow: true });
        } else {
            $.H3WarningBox.show({ message: msg, type: "success", ShowInRootWindow: true });
        }
    },

    IShowError: function () {
        var title;
        var msg;
        var detail;
        if (!arguments) { return; } //没有输入相应参数
        if (arguments.length == 2) {
            title = arguments[0];
            msg = arguments[1]
        } else if (arguments.length == 1) {
            if (typeof (arguments[0]) == "string") {
                msg = arguments[0];
            } else if (typeof (arguments[0]) == "object") {
                var json = arguments[0];
                title = json.title;
                msg = json.msg;
                detail = json.detail;
            }
        }
        if ($.isEmptyObject(title) || title == "") {
            title = "提示";
        }
        if ($.isEmptyObject(msg) || msg == "") {
            msg = title || "";
        }

        if (detail) {
            $.H3Popup.show({ title: title, message: msg, error_detail: detail, type: "danger", ShowInRootWindow: true });
        } else {
            if (msg.length > 25) {

                $.H3Popup.show({ title: title, message: msg.substring(0, 20) + "...", error_detail: msg, type: "danger", ShowInRootWindow: true, MessageTip1: "查看错误详情", MessageTip2: "错误详情" });
            }
            else {
                $.H3WarningBox.show({ message: msg, type: "danger", ShowInRootWindow: true });
            }

        }
    },

    IShowWarn: function () {
        var title;
        var msg;
        var detail;
        if (!arguments) { return; } //没有输入相应参数
        if (arguments.length == 2) {
            title = arguments[0];
            msg = arguments[1]
        } else if (arguments.length == 1) {
            if (typeof (arguments[0]) == "string") {
                msg = arguments[0];
            } else if (typeof (arguments[0]) == "object") {
                var json = arguments[0];
                title = json.title;
                msg = json.msg;
                detail = json.detail;
            }
        }

        if ($.isEmptyObject(title) || title == "") {
            title = "提示";
        }
        if ($.isEmptyObject(msg) || msg == "") {
            msg = title || "";
        }

        if (detail) {
            $.H3Popup.show({ title: title, message: msg, error_detail: detail, type: "warning", ShowInRootWindow: true });
        } else {
            if (msg.length > 25) {
                $.H3Popup.show({ title: title, message: msg.substring(0, 20) + "...", error_detail: msg, type: "warning", ShowInRootWindow: true, MessageTip1: "查看警示详情", MessageTip2: "警示详情" });
            } else {
                $.H3WarningBox.show({ message: msg, type: "warning", ShowInRootWindow: true });
            }
        }
    },
    IShowTip: function () {
        var title;
        var msg;
        var detail;
        if (!arguments) { return; } //没有输入相应参数
        if (arguments.length == 2) {
            title = arguments[0];
            msg = arguments[1]
        } else if (arguments.length == 1) {
            if (typeof (arguments[0]) == "string") {
                msg = arguments[0];
            } else if (typeof (arguments[0]) == "object") {
                var json = arguments[0];
                title = json.title;
                msg = json.msg;
                detail = json.detail;
            }
        }

        if ($.isEmptyObject(title) || title == "") {
            title = "提示";
        }
        if ($.isEmptyObject(msg) || msg == "") {
            msg = title || "";
        }

        if (detail) {
            $.H3Popup.show({ title: title, message: msg, error_detail: detail, type: "remind", ShowInRootWindow: true });
        } else {
            if (msg.length > 68) {
                $.H3Popup.show({ title: title, message: msg.substring(0, 68) + "...", error_detail: msg, type: "warning", ShowInRootWindow: true, MessageTip1: "查看提示详情", MessageTip2: "提示详情", showCancel: false });
            } else {
                $.H3WarningBox.show({ message: msg, type: "remind", ShowInRootWindow: true });
            }
        }
    },

    //使用bootstrap扩展插件pnotify弹出确认框
    //@title:对话框标题，可以为空
    //@text:对话框弹出消息
    //@callBack:回调函数，传回true/false
    IConfirm: function (title, text, callBack) {
        var that = this;
        //$.confirm({
        //    title: $.isEmptyObject(title) ? "提示" : title,
        //    content: $.isEmptyObject(text) ? title : text,
        //    confirmButton: "确定",
        //    confirmButtonClass: "btn-danger",
        //    cancelButton: "取消",
        //    cancelButtonClass: "btn-info",
        //    cancel: function () {
        //        if ($.isFunction(callBack)) {
        //            callBack.apply(that, [false]);
        //        }
        //    },
        //    confirm: function () {
        //        this.$confirmButton.attr("disabled", "disabled").text("处理中");
        //        if ($.isFunction(callBack)) {
        //            callBack.apply(that, [true]);
        //        }
        //    }
        //})

        top.$.H3Popup.show({
            title: $.isEmptyObject(title) ? "提示" : title,
            message: $.isEmptyObject(text) ? title : text,
            type: "remind",
            ShowInRootWindow: true,
            callBack: callBack
        });
        return false;
    },

    //使用bootstrap的模态框，用法:$.SheetModal("",$("div"),[]);
    //@title:标题
    //@target:内容，可以是$("<div>") ,也可以是 url地址
    //@actions:工具栏，可不传；[{Text:"test",CallBack:function,Theme:btn-ok其他想要的参数},{Text:"test",DoAction:function,其他想要的参数}],btn-ok,btn-cancel,btn-normal
    //@callback:modal显示后的回调函数
    //@hiddenCallback隐藏后的回调函数
    //@type 内容类型Dom:0,html:1,url:2
    //@Class modalcontainer的样式
    //@ShowInRootWindow 如果在iframe中使用是否显示在最顶层
    //@ObjectId modal的Id,不传为随机数
    IModal: function (opt) {
        //title, Content, ToolButtons, OnShowCallback, OnHiddenCallback
        var iModal = new Object;
        var DefaultOption = {
            Title: "",
            Content: "",
            ToolButtons: [],
            OnShowCallback: null,
            OnHiddenCallback: null,
            ShowHeader: true,
            ShowFooter: true,
            Type: 0,
            Height: "auto",
            Width: "80%",
            Firstload: null,
            Params: {},
            ShowInRootWindow: false,
            ObjectId: null,
            Class: ""
        }
        opt = $.extend({}, DefaultOption, opt);

        iModal.ActionObjects = [];
        iModal.Target = opt.Content;
        iModal.IsUrl = opt.Type == 2;
        iModal.ShowModal = function (title, Content, ToolButtons) {
            localStorage.setItem('DialogArguments', JSON.stringify(opt.Params));
            this.ContainerId = $.IGuid()
            this.Container = $("<div class='modalcontainer " + opt.Class + "' id='" + this.ContainerId + "'>");
            var currentWindow = window;
            var that = this;
            this.IsShow = false;
            this.ID = opt.ObjectId != null ? opt.ObjectId : $.IGuid();
            var $body = $("body");
            if (opt.ShowInRootWindow) {
                $body = $($(top.document).find("body")[0]);

            }

            if (opt.ShowInRootWindow) {

                this.Modal = $('<div class="modal fade" id="' + this.ID + '"  role="dialog" data-backdrop="false" ></div>').css("overflow", "hidden");
            }
            else {
                this.Modal = $('<div class="modal fade" id="' + this.ID + '"  role="dialog" data-backdrop="false" ></div>').css("overflow", "hidden");
            }
            $body.append(this.Container);
            this.Container.append(this.Modal);
            var modalDialog = $('<div class="modal-dialog" style=""></div>').css("width", opt.Width).css("height", opt.Height - 0 + 26);
            this.ModalContent = $('<div class="modal-content" style="border-radius:0px;width:100%;height:98%;"></div>');
            this.ModalHeader = $('<div class="modal-header modal-header-form"><div type="button" class="close" data-dismiss="modal" style="margin-top:-2px;margin-right: 10px;"><span aria-hidden="true" class="icon-guanbi" style="font-size:16px;"></span></div></div>');

            //以下三个主要才是需要填充的
            this.ModalTitle = $('<h4 class="modal-title modal-title-form" id="myModalLabel"></h4>');

            this.Content = $('<div class="modal-body" ></div>').css("background-color", "#fff").css("width", "100%")
                .css("height", opt.Height.constructor.name == "Number" ? (opt.Height - 85) : "100%");


            this.ModalFooter = $('<div class="modal-footer modal-footer-form "></div>')
                .css({
                    "background-color": "#fff",
                    'height': '52px'
                });
            this.Modal.append(modalDialog);
            modalDialog.append(this.ModalContent);
            if (opt.ShowHeader) {
                this.ModalContent.append(this.ModalHeader);
                this.ModalHeader.append(this.ModalTitle);
            }
            this.ModalContent.append(this.Content);
            if (opt.ShowFooter) {
                this.ModalContent.append(this.ModalFooter);
                //操作
                this.SetFooter(ToolButtons);
            }
            this.FooterHeiht = 100;
            this.SetTile(opt.Title);
            this.SetBody(opt.Content);
            if (typeof opt.Firstload === "function")
                opt.Firstload();
            //显示
            this.Modal.on("show.bs.modal", function (e) {
                $.MsgFilter.show();
            });
            this.Modal.on("hide.bs.modal", function (e) {
                $.MsgFilter.remove();
            });
            this.show();
            var findparentmodal = false;
            if (window.parent != window) {
                $(window.parent.document).find(".modal").each(function () {
                    if (findparentmodal) return;
                    var iframe = $(this).find("iframe");
                    if (!$.isEmptyObject(iframe)) {
                        if (iframe[0])
                            if (!$.isEmptyObject($(iframe[0].contentDocument).find("#" + that.ID))) {
                                that.ParentModal = $(this);
                                $(this).find(".modal-header").attr("style", "background-color: #000;opacity: 0.5;border-bottom:none;")
                                $(this).find(".modal-body").css("box-shadow", "0 5px 15px rgba(0,0,0,.5)");
                                findparentmodal = true;
                            }
                    }
                });
            }



            this.Modal.on("shown.bs.modal", this, function (e) {
                // edited by xc
                var margintop = 0;
                var speed = 1000;
                var height = ((opt.ShowInRootWindow ? $(top).outerHeight() : ($(window.document.body).outerHeight() > window.innerHeight ? window.innerHeight : $(window.document.body).outerHeight())) - (modalDialog.height())) / 2;
                var time = (height - 0) / speed;
                var tempModal = that.Modal.find(".modal-dialog");
                tempModal.css("transition", "margin ease-in-out " + time + "s");
                tempModal.css("-moz-transition", "margin ease-in-out " + time + "s");
                tempModal.css("-webkit-transition", "margin ease-in-out " + time + "s");
                tempModal.css("-o-transition", "margin ease-in-out " + time + "s");
                if (height > 0) {
                    margintop = height + "px";
                }
                modalDialog.css("margin-top", margintop);
                if (typeof opt.OnShowCallback === "function")
                    opt.OnShowCallback.apply(that);
            });
            //绑定关闭事件
            this.Modal.on("hidden.bs.modal", this, function (e) {
                e.data.IsShow = false;
                localStorage.setItem('DialogArguments', "");//关闭时清空参数值
                if (typeof opt.OnHiddenCallback === "function")
                    opt.OnHiddenCallback.apply(that);
            });

        },

            iModal.SetTile = function (title) {
                this.ModalTitle.html(title || " ");
            };
        iModal.SetBody = function (Content) {
            if (this.IsUrl) {

                this.Modal.find(".modal-dialog").css("height", opt.Height).css("width", opt.Width).css("margin", "0 auto 0 auto");
                if (opt.ShowFooter) {
                    //this.Content.css("margin", "0px").css("padding", "0px").height(opt.ShowInRootWindow ? $(top).height :$(window).height() - this.FooterHeiht);
                }
                else {
                    //this.Content.css("margin", "0px").css("padding", "0px").css("height", "100%");//
                    this.Content.css("margin", "0px").css("padding", "0px");//
                }

                //计算modal-body高度
                var reduceHeight = 0;
                if (opt.ShowFooter) { reduceHeight += 61; }
                if (opt.ShowHeader) { reduceHeight += 50; }
                if (opt.Height.constructor == Number) {
                    var bodyHeight = opt.Height - reduceHeight - 5;
                    this.Content.css("height", bodyHeight);
                }

                //兼容firefox
                var iframe = $("<iframe height='100%' width='100%'>").attr("frameborder", 0).attr("src", Content).attr("id", "iframe_" + this.ID);
                this.Content.append(iframe);
            }
            else {
                $(Content).show();
                if (opt.type == 0)
                    this.Content.append($(Content));
                else (opt.type == 1)
                this.Content.html(Content)
            }
        };
        iModal.SetFooter = function (ToolButtons) {
            this.ModalFooter.html("");
            if (ToolButtons) {
                this.FooterHeiht = 120;
                for (var i = 0; i < ToolButtons.length; i++) {
                    var btnJson = ToolButtons[i];
                    this.AddAction(btnJson);
                }
            }
        }
        iModal.AddAction = function (actionObject) {

            var btn = $('<button type="button" class="masBox-btn ' + actionObject.Theme + '">' + actionObject.Text + '</button>');
            if (actionObject.position && actionObject.position == 'left') {
                btn.css('float', 'left').removeClass('masBox-btn');
            }
            $.extend(actionObject, { ModalManager: this, Element: btn })
            // 绑定修改事件
            if (actionObject.CallBack) {
                btn.unbind("click").bind("click", actionObject, function (e) {
                    e.data.CallBack.apply(e.data);
                });
            }
            this.ActionObjects.push(actionObject);
            this.ModalFooter.append(btn);
        };

        iModal.TrrigeFrameFun = function (action) {
            var frame = window.frames["iframe_" + this.ID];
            if (frame != null) {
                if ($.isFunction(frame.BoxCall)) {
                    frame.BoxCall.apply(this, [action]);
                } else if ($.isFunction(frame.contentWindow.BoxCall)) {
                    frame.contentWindow.BoxCall.apply(this, [action]);
                }
            }
        };

        iModal.show = function (src) {
            if (this.IsShow) return;
            this.IsShow = true;
            var that = this;

            if (typeof opt.OnShowBeforeCallback === "function")
                opt.OnShowBeforeCallback.apply(this);

            this.Modal.modal("show");
            if (opt.ShowInRootWindow) {
                //$(top.document.body).append("<div id='backdropid' class='modal-backdrop fade in ' ></div>");
            }
            if (this.IsUrl) {
                var iframeSrc = src || this.Content.find("iframe").attr("src");
                this.Content.find("iframe").attr("src", iframeSrc);

            }
            if (this.ParentModal) {
                this.ParentModal.find(".modal-header").attr("style", "background-color: #000;opacity: 0.5;border-bottom:none;")
            }
        };

        iModal.destroy = function () {
            //if (opt.ShowInRootWindow)
            //$(top.document.body).find("#backdropid").remove();
            this.Container.remove();
            for (var key in this) {
                //delete this[key];
            }
        }

        iModal.hide = function () {
            if (!this.IsShow) return;
            this.IsShow = false;
            $(this.Modal).closest("modal-header").attr("style", "");
            this.Modal.modal("hide");
            if (opt.ShowInRootWindow) {
                //var t = $(top.document.body).find("#backdropid");
                //if (t)
                //    t.remove();
            }
            if (this.ParentModal) {
                this.ParentModal.find(".modal-header").attr("style", "")
            }
        };

        iModal.SetButtonLoading = function () {
            for (var i = 0; i < this.ActionObjects.length; i++) {
                this.ActionObjects[i].Element.attr("data-loading-text", "loading");
                this.ActionObjects[i].Element.button("loading");
            }
        };

        iModal.ResetButton = function () {
            for (var i = 0; i < this.ActionObjects.length; i++) {
                this.ActionObjects[i].Element.button("reset");
            }
        };

        iModal.ShowModal(opt.title, opt.Content, opt.ToolButtons);
        iModal.GetRootWindow = function (w) {
            if (w.parent == w)
                return w;
            else {
                w = w.parent;
                w = GetRootWindow(w)
            }
        };
        iModal.openModal = function () {
            var t = $(top.document.body);
            var id = "topMadal";
            var d = $("#" + id);
            if (d.length == 0) {
                d = $("<div class='modal fade' role='dialog' id='" + id + "' ></div>");
                d.appendTo(t);
            }
            d.load("model.html", function () { d.modal({ backdrop: false }); });
            //t.append("<div id='backdropid' class'modal-backdrop fade in ' ></div>");
        }
        iModal.closeModal = function () {
            var t = $(top.document.body);
            t.find("#topMadal").on("hidden.bs.modal", function (e) {
                //t.find("#backdropid").remove();
            })
        }
        return iModal;
    },

    /*
   //浮动层
   //使用bootstrap的popover，用法:$.IToolTipBox($("div"),[{}]);
   //前提：需要引用bootstrap tooltip 和popover插件
   //$target:目标元素，jquery对象
   //@title:标题
   //@content:内容
   //@html : 标志内容是按html格式还是文本格式填充
   //@ToolButtons:按钮，可不传；[{Text:"test",CallBack:function,Theme:btn-ok其他想要的参数},{Text:"test",DoAction:function,其他想要的参数}],btn-ok,btn-cancel,btn-normal
   //@shownCallback显示后的回调函数
   //@hiddenCallback隐藏后的回调函数
   //@align: 箭头指向方向  top | bottom | left | right | auto, 对其方式
   //@trigger: 目标元素触发浮层方式： click | hover | focus | manual[手工]
   */
    IToolTipBox: function ($target, opt) {
        //title, Content, ToolButtons, OnShowCallback, OnHiddenCallback
        var iToolTip = new Object;
        var DefaultOption = {
            ToolButtons: [],
            trigger: 'click',//触发方式： click | hover | focus |manual
            container: 'body',
            align: 'bottom', //top | bottom | left | right | auto, 对其方式
            shownCallback: null,
            hiddenCallback: null,
            html: true, // true:内容作html处理，false：内容作文本处理
            title: '',
            content: '',//内容 文本或html

        }
        opt = $.extend({}, DefaultOption, opt);
        // iToolTip.Container = $("<div>");
        iToolTip.ActionObjects = [];
        iToolTip.Target = $target;
        var toolbox = $target.data("h3.itoolbox");
        if (toolbox) {
            return toolbox;
        }
        iToolTip.ShowToolTip = function (title, Content, ToolButtons) {
            var that = this;
            this.IsShow = false;
            this.ID = $.IGuid();
            thisTemplate = '<div class="popover" id="' + this.ID + '" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div><div class="popover-footer"></div></div>',
                this.Target.popover({
                    trigger: opt.trigger,//触发方式： click | hover | focus |manual
                    container: opt.container,
                    placement: opt.align, //top | bottom | left | right | auto, 对其方式
                    html: opt.html, // true:内容作html处理，false：内容作文本处理
                    title: opt.title,
                    content: opt.content,//内容 文本或html
                    template: that.Template
                })

            var data = this.Target.data("bs.popover");
            this.popoverData = data;
            if (data) {
                this.$Tip = data.tip();
                this.TipTitle = this.$Tip.find("h3.popover-title");
                this.TipFooter = this.$Tip.find("div.popover-footer");
                this.TipContent = this.$Tip.find("div.popover-content");
            }

            //绑定关闭事件
            this.Target.on("hidden.bs.popover", this, function (e) {
                e.data.IsShow = false;
                if (typeof opt.hiddenCallback === "function")
                    opt.hiddenCallback(that);
                return false;
            });

            this.Target.on("shown.bs.popover", this, function (e) {
                if (typeof opt.shownCallback === "function")
                    opt.shownCallback(that);

                return false;
            });

            this.SetFooter(opt.ToolButtons);

            this.Target.data("h3.itoolbox", this);
            //显示
            this.show();
        },

            iToolTip.SetTile = function (title) {
                this.TipTitle.html(title || " ");
                this.TipTitle.show();
            };

        iToolTip.SetFooter = function (ToolButtons) {
            this.TipFooter.html("");
            if (ToolButtons) {
                this.FooterHeiht = 120;
                for (var i = 0; i < ToolButtons.length; i++) {
                    var btnJson = ToolButtons[i];
                    this.AddAction(btnJson);
                }
            }
        }
        iToolTip.AddAction = function (actionObject) {
            var btn = $('<button type="button" class="masBox-btn ' + actionObject.Theme + '">' + actionObject.Text + '</button>');
            if (actionObject.position && actionObject.position == 'left') {
                btn.css('float', 'left').removeClass('masBox-btn');
            }
            $.extend(actionObject, { TipManager: this, Element: btn })
            // 绑定修改事件
            if (actionObject.CallBack) {
                btn.unbind("click").bind("click", actionObject, function (e) {
                    e.data.CallBack.apply(e.data);
                });
            }
            this.ActionObjects.push(actionObject);
            this.TipFooter.append(btn);
        };

        iToolTip.show = function () {
            if (this.IsShow) return;
            this.IsShow = true;
            this.Target.popover('show');

        };

        iToolTip.destroy = function () {
            iToolTip.Target.popover('destroy');
            this.Target.data("h3.itoolbox", null);
        }

        iToolTip.hide = function () {
            iToolTip.Target.popover('hide');
        };

        iToolTip.SetButtonLoading = function () {
            for (var i = 0; i < this.ActionObjects.length; i++) {
                this.ActionObjects[i].Element.attr("data-loading-text", "loading");
                this.ActionObjects[i].Element.button("loading");
            }
        };

        iToolTip.ResetButton = function () {
            for (var i = 0; i < this.ActionObjects.length; i++) {
                this.ActionObjects[i].Element.button("reset");
            }
        };

        iToolTip.ShowToolTip(opt.title, opt.Content, opt.ToolButtons);


        return iToolTip;
    },

    //对象克隆,只对对象有效,用法:$.IClone(Obj)
    IClone: function (obj) {
        if (obj == null) return;
        var objClone;
        if (obj.constructor == Object
            || obj.constructor == Array) {
            objClone = new obj.constructor();
        }
        else {
            objClone = new obj.constructor(obj.valueOf());
        }
        jQuery.extend(true, objClone, obj);
        return objClone;

    },

    //数字格式
    //@num:数值
    //@保留小数后几位
    //@separator 千分位分割
    IFormatNumber: function (num, precision, separator) {
        var parts;
        // 判断是否为数字
        if (!isNaN(parseFloat(num)) && isFinite(num)) {
            // 把类似 .5, 5. 之类的数据转化成0.5, 5, 为数据精度处理做准, 至于为什么
            // 不在判断中直接写 if (!isNaN(num = parseFloat(num)) && isFinite(num))
            // 是因为parseFloat有一个奇怪的精度问题, 比如 parseFloat(12312312.1234567119)
            // 的值变成了 12312312.123456713
            num = Number(num);
            // 处理小数点位数
            num = (typeof precision !== 'undefined' ? num.toFixed(precision) : num).toString();
            // 分离数字的小数部分和整数部分
            parts = num.split('.');
            // 整数部分加[separator]分隔, 借用一个著名的正则表达式
            parts[0] = parts[0].toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1' + (separator || ','));

            return parts.join('.');
        }
        return NaN;
    },

    //读取url的参数值
    IQuery: function (name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = decodeURI(window.location.search.substr(1)).match(reg);
        if (r != null) return decodeURI(r[2]);
        return "";
    },

    IDialogModal: {
        ModalIdArray: [],
        DialogModalArray: [],
        currentWindow: window,
        Show: function (schemaCode, objectId, title, height, width, params, onShowCallback, onHiddenCallback) {

            this.SheetData = null;//弹出框表单数据
            this.ExecuteHideFunction = true;//是否执行隐藏回调事件onHiddenCallback

            var that = this;
            var url = "/Form/DefaultSheet/" + schemaCode + "?SchemaCode=" + schemaCode + "&ShowInModal=true";
            if (objectId) {
                url = url + "&BizObjectId=" + objectId;
            }
            this.iModal = new $.IModal({
                Content: url,
                OnShowCallback: onShowCallback,
                OnHiddenCallback: null,//挪到IDialogModal执行
                Title: title || "",
                ShowHeader: true,
                ShowFooter: false,
                Type: 2, //2 =IsUrl
                Height: height || 500,
                Width: width || 820,
                Params: params, //弹框全局参数
            });
            this.iModal.show();
            //隐藏时显示工具栏
            this.iModal.Modal.on("hide.bs.modal.dialog", function () {

                that.ShowPreModalNav();//显示上一层的工具栏
                //根据条件判断是否执行回调函数
                if (that.ExecuteHideFunction && that.SheetData != null) {
                    if (typeof onHiddenCallback === "function") {
                        //新增传递打开表单的数据到回调函数
                        onHiddenCallback.apply(that, [that.SheetData]);
                    }
                }

                $(document.body).removeClass("modal-open");
                localStorage.setItem('DialogArguments', "");//关闭时清空参数值
            })
            this.HidePreModalNav();
            this.ID = this.iModal.ContainerId;
            top.$.IDialogModal.ModalIdArray.push(this.ID);
            top.$.IDialogModal.DialogModalArray.push(this.iModal);

            //绑定关闭事件
            this.iModal.Container.find("div.close").off("click.close").on("click.close",
                function () {
                    that.Close();
                });
        },
        CloseAllModal: function () {
            // for (var i = top.$.IDialogModal.DialogModalArray.length - 1; i >= 0; i--) {
            //     this.Close(top.$.IDialogModal.DialogModalArray[i].ContainerId);
            // }
            // top.$.IDialogModal.DialogModalArray = [];
        },
        //手工关闭
        Close: function (ModalId) {
            var that = this;
            this.ShowPreModalNav();
            if (ModalId) {
                //移除
                if (this.currentWindow == undefined) { this.currentWindow = top; }
                //关闭弹出框
                $(this.currentWindow.document).unbind("click.Close_" + ModalId);
                //ModalId移除
                top.$.IDialogModal.ModalIdArray.splice(ModalId, 1);
                if (top.$.IDialogModal.DialogModalArray && top.$.IDialogModal.DialogModalArray.length > 0) {
                    for (var i = top.$.IDialogModal.DialogModalArray.length - 1; i >= 0; i--) {
                        var modal = top.$.IDialogModal.DialogModalArray[i];
                        var id = modal.ContainerId;
                        modal.hide(); //触发回调事件
                        //移出对话框
                        if (modal.Container) {
                            modal.Container.find("iframe").remove();//先移除iframe再移除div，解决ie下新增后再打开侧滑框不能编辑文本框的问题
                            modal.Container.remove();
                        }
                        //delete modal;
                        //当前对话框之后出现的都关闭掉
                        if (ModalId == id) {
                            break;
                        }
                    }
                }
            }
            else {
                this.CloseLastModal();
            }
        },

        CloseLastModal: function (params) {
            if (top.$.IDialogModal.DialogModalArray.length > 0) {
                var lastModal = top.$.IDialogModal.DialogModalArray[top.$.IDialogModal.DialogModalArray.length - 1];
                if (lastModal) {
                    this.Close(lastModal.ContainerId, params);
                }

            }
        },
        //隐藏上级侧滑框的按钮
        HidePreModalNav: function () {
            if (this.currentWindow == top) {
                return;
            }
            $(this.currentWindow.document.body).find("ul.navbar-nav").hide();
        },
        //显示上级侧滑框的按钮
        ShowPreModalNav: function () {
            $(this.currentWindow.document.body).find("ul.navbar-nav").show();
        }

    },

    //右侧划出的表单
    ISideModal: {
        ModalIdArray: [],
        CallBackArray: {},
        ModalBody: {},
        IsChanged: false,
        CustomParams: {},
        CheckIsChange: true,//检查改变
        //selfWindow : 计算从哪一层开始添加document.click事件
        Show: function (target, title, hiddenCallback, parentId, checkIsChange, params, selfWindow) {
            var that = this;
            if (this.IsChanged) return;
            if (checkIsChange == void 0) {
                this.CheckIsChange = true;
            }
            else {
                this.CheckIsChange = checkIsChange;
            }
            this.oldWindow = selfWindow || self;
            this.currentWindow = window;
            this.currentbody = $("body");
            var topValue = -1;
            var width = "70%"; //"70%";
            var oldself = self;
            //判断是否有通知公告
            if (this.currentWindow != top) {
                //this.HideLastModal();
                var $curentModal = top.$("#" + top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 1]);
                if (this.IsAnnounceShow()) {
                    topValue = 80;
                } else {
                    topValue = 50;
                }

                width = "100%"; // "100%";// $curentModal.width();

            }
            else {
                if (this.IsAnnounceShow()) {
                    topValue = 83;
                } else {
                    topValue = 53;
                }

                this.CloseAllModal();
            }

            var $Modal = null;
            var id = $.IGuid();
            $Modal = $('<div></div>');
            $Modal.css("left", "auto");

            //$Modal.css("margin-top", top.$.ISideModal.ModalIdArray.length > 0 ? "37px" : "61px");
            $Modal.css("width", width);
            $Modal.css("z-index", "1040");
            $Modal.css("position", "fixed");
            $Modal.css("top", topValue + "px");
            $Modal.css("bottom", "-1px");
            $Modal.css("padding", "0");
            $Modal.css("background-color", "#fff");
            $Modal.css("background-clip", "padding-box");
            //$Modal.css("border", "1px solid #adadad");
            $Modal.css("box-shadow", "0 2px 27px 0 rgba(0,0,0,0.30");
            if (!title) {
                title = "&nbsp;&nbsp;";
            }
            var $titlePanel = $('<div class="panel" style="margin-bottom:0px;"><div class="panel-heading"><span id="tile_' + id + '">' + title + '<span></div></div>');
            $titlePanel.children("div.panel-heading").append('<button type="button" class="close" data-dismiss="modal"><i aria-hidden="true" class="fa fa-times"></i></button>');
            $Modal.append($titlePanel.hide());
            $Modal.appendTo(this.currentbody);
            if (target.indexOf("?") > -1) {
                target += "&SideModal=true&mid=" + id;
            }
            else {
                target += "?SideModal=true&mid=" + id;
            }

            //var iframe = $("<iframe name='frame_" + id + "'>").height($(window).height() - $titlePanel.height() - 50).css("width", "100%").attr("frameborder", 0).attr("src", target);
            var iframe = $("<iframe name='frame_" + id + "'>").css("margin", "0").css("margin-left", "-1px").css("padding", "0").css("height", "100%").css("width", "100%").attr("frameborder", 0).attr("src", target).addClass("filter");
            $Modal.append(iframe);


            $Modal.css("right", this.currentbody.width() * -1);
            $Modal.children("div.panel:first").find("button.close").click(this, function (e) {
                e.data.AutoClose.apply(e.data, [id]);
            });

            $Modal.attr("id", id);
            $Modal.animate({ right: 0 }, function () {
                //if (self != top) {
                that.currentbody.css("overflow-y", "hidden");
                that.currentbody.addClass("modal-back");
                //}
            });

            if ($.inArray(id, top.$.ISideModal.ModalIdArray) < 0) {
                top.$.ISideModal.ModalIdArray.push(id);
            }
            //iframe 加载完后读取内容，判断内容是否改变
            // var that = this;
            that.HidePreModalNav();
            iframe.load(function () {
                var checkLoadTimes = 0;
                var iframeLoaded = function () {
                    checkLoadTimes++;
                    if (that.currentWindow.frames["frame_" + id] == undefined) {
                        return;
                    }
                    var $frameBody = $(that.currentWindow.frames["frame_" + id].document.body);
                    if ($frameBody.find("form").children().length == 0 && checkLoadTimes < 5) {
                        setTimeout(iframeLoaded, 500);
                    }
                    that.ModalBody[id] = $frameBody.clone(true);
                    var oldInputs = $(that.ModalBody[id]).find("input,select,area,radio,textarea");
                    var currentInputs = $frameBody.find("input,select,area,radio,textarea");
                    for (var i = 0; i < oldInputs.length; i++) {
                        $(oldInputs[i]).val($(currentInputs[i]).val());
                    }

                    if (/msie/.test(navigator.userAgent.toLowerCase()) && !/opera/.test(navigator.userAgent.toLowerCase())) {
                        // 兼容ie关掉iframe后文本框不能输入值的问题
                        var $ie11focus = $frameBody.find("#ie11focus");
                        if ($ie11focus.length == 0) {
                            $ie11focus = $("<input type='text' id='ie11focus' style='width:0;height:0;padding:0;margin:0;border:0;' />");
                            $frameBody.find(".sheet_container").prepend($ie11focus);
                        }
                        $ie11focus.focus();
                    }
                    //点击其他地方，关闭，这里可能会执行多次
                    // that.ClickDocumentToClose.apply(that, [id]);
                };
                iframeLoaded();

                //点击其他地方，关闭
                that.ClickDocumentToClose.apply(that, [id]);
            });

            if (typeof (params) != "undefined") {
                top.$.ISideModal.CustomParams[id] = params;
            }

            if ($.isFunction(hiddenCallback)) {
                this.CallBackArray[id] = hiddenCallback;
            }
        },

        SetTile: function (Text, ModalId) {
            if (ModalId) {
                $("#tile_" + ModalId).text(Text);
            }
            else {
                ModalId = top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 1];
                if (ModalId) {
                    this.SetTile(Text, ModalId);
                }
            }
        },

        GetParamValue: function (name) {
            var modalId = top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 1];
            if (top.$.ISideModal.CustomParams[modalId] == null || (top.$.ISideModal.CustomParams[modalId][name]) == "undefined") {
                return null;
            }
            else {
                return top.$.ISideModal.CustomParams[modalId][name];
            }
        },

        ClickDocumentToClose: function (ModalId) {
            var windows = [];
            var that = this;
            windows.push(this.oldWindow);
            var currentWindow = this.oldWindow;
            while (currentWindow != top) {
                windows.push(currentWindow.parent);
                currentWindow = currentWindow.parent;
            }

            if (currentWindow == top) {
                var iframes = $(top.document).find('iframe[data-active="true"]');
                if (iframes.length > 0) {
                    windows.push(iframes[0].contentWindow);
                }
            }

            $.each(windows, function (index, obj) {
                var objEvents = $(obj.document).data("events");
                if (objEvents && objEvents["click"]) {
                    var evts = objEvents["click"];
                    for (var i = 0; i < evts.length; i++) {
                        if (evts[i].namespace == "Close_" + ModalId) {
                            return;
                        }
                    }
                }
                //console.log("绑定document");
                //为什么one绑定的事件执行不止一次？
                $(obj.document).off("click.Close_" + ModalId).one("click.Close_" + ModalId, [ModalId, that], function (e) {
                    var tid = e.data[0];
                    if ($(e.target).closest("#" + tid).length == 0 &&
                        $(e.target).closest("div.jconfirm").length == 0 &&
                        $(e.target).closest("div.modal-backdrop").length == 0 &&
                        $(e.target).closest("div.modal-dialog-confirm").length == 0 &&
                        $(e.target).closest(".DeveloperTool").length == 0 &&
                        $(e.target).closest(".DeveloperMask").length == 0) {

                        //if (top.$.ISideModal.ModalIdArray.length > 0 && tid == top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 1]) {
                        //    $.ISideModal.AutoClose(tid, true);
                        //}
                        //else if ($.inArray(ModalId, top.$.ISideModal.ModalIdArray)<0) {
                        //    return false;
                        //}
                        //else {
                        //    $.ISideModal.CloseAllModal();//一次性关闭多个嵌套侧滑框时，关闭所有
                        //    return false;
                        //}
                        if (obj == top && top.$.ISideModal.ModalIdArray.length > 1 && tid == top.$.ISideModal.ModalIdArray[0]) {
                            $.ISideModal.CloseAllModal();
                            return false;
                        }

                        if (top.$.ISideModal.ModalIdArray.length == 0) {
                            return false;
                        }

                        $.ISideModal.AutoClose(tid, true);
                        return !e.data[1].IsChanged;
                    }
                    else {
                        e.data[1].ClickDocumentToClose.apply(e.data[1], [ModalId]);
                    }
                    return false;
                });
            })
        },

        //检查是否改变
        CheckBodyIsChange: function (ModalId) {
            var oldBody = this.ModalBody[ModalId];
            if (oldBody == null) {
                return false;
            }
            if (this.currentWindow.frames["frame_" + ModalId] == null) {
                return false;
            }
            var currentBody = $(this.currentWindow.frames["frame_" + ModalId].document.body);
            //if (oldBody[0].outerHTML != currentBody[0].outerHTML) {
            //    return true;
            //}

            var oldInputs = oldBody.find("input:not([type='file']),select,area,radio,textarea");
            var currentInputs = currentBody.find("input:not([type='file']),select,area,radio,textarea");
            for (var i = 0; i < oldInputs.length; i++) {
                var oldItem = $(oldInputs[i]);
                var currentItem = $(currentInputs[i]);
                if (oldItem.val() != currentItem.val()) {

                    return true;
                }
                else if (oldItem.attr("type") == "radio" || oldItem.attr("type") == "checkbox") {
                    if (oldItem.prop("checked") != currentItem.prop("checked"))
                        return true;
                }
            }

            //判断选人控件
            var oldUsers = oldBody.find("div.SheetUser[data-datafield][data-controlkey='FormUser']");
            var currentUsers = currentBody.find("div.SheetUser[data-datafield][data-controlkey='FormUser']");
            for (var i = 0; i < oldUsers.length; i++) {
                if ($(oldUsers[i]).find("span.SheetUser-Item").length != $(currentUsers[i]).find("span.SheetUser-Item").length) {
                    return true;
                }
                else if ($(oldUsers[i]).find("span.SheetUser-Item").length > 0) {
                    console.log($(oldUsers[i]).find("span.SheetUser-Item").text());
                    if ($(oldUsers[i]).find("span.SheetUser-Item").text() != $(currentUsers[i]).find("span.SheetUser-Item").text()) {
                        return true;
                    }
                }
            }

            oldUsers = oldBody.find("div.SheetUser[data-datafield][data-controlkey='FormMultiUser']");
            currentUsers = currentBody.find("div.SheetUser[data-datafield][data-controlkey='FormMultiUser']");
            for (var i = 0; i < oldUsers.length; i++) {
                if ($(oldUsers[i]).find("span.SheetUser-Item").length != $(currentUsers[i]).find("span.SheetUser-Item").length) {
                    return true;
                }
                else if ($(oldUsers[i]).find("span.SheetUser-Item").length > 0) {
                    console.log($(oldUsers[i]).find("span.SheetUser-Item").text());
                    if ($(oldUsers[i]).find("span.SheetUser-Item").text() != $(currentUsers[i]).find("span.SheetUser-Item").text()) {
                        return true;
                    }
                }
            }


            //判断关联查询
            var oldQuery = oldBody.find("div[data-datafield][data-controlkey='SheetQuery']");
            var currentQuery = currentBody.find("div[data-datafield][data-controlkey='SheetQuery']");
            for (var i = 0; i < oldQuery.length; i++) {
                if ($(oldQuery[i]).find("pre").html() != $(currentQuery[i]).find("pre").html()) {
                    return true;
                }
            }

            return false;
        },

        HideLastModal: function () {
            if (top.$.ISideModal.ModalIdArray.length > 0) {
                $("#" + top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 1]).animate({ right: $("body").width() * -0.75 });
            }
        },

        CloseAllModal: function () {
            // for (var i = top.$.ISideModal.ModalIdArray.length - 1; i >= 0; i--) {
            //     this.Close(top.$.ISideModal.ModalIdArray[i]);
            // }
            // top.$.ISideModal.ModalIdArray = [];
        },

        //自动关闭
        AutoClose: function (ModalId, isDocuemnt) {
            var that = this;
            //判断是否改变
            if (this.CheckIsChange && this.CheckBodyIsChange(ModalId)) {
                this.IsChanged = true;
                $.IConfirm("", "确定放弃保存?放弃后数据不会被保存！", function (isTrue) {
                    that.IsChanged = false;
                    if (isTrue) {
                        delete that.ModalBody[ModalId];
                        that.Close.apply(that, [ModalId]);
                    }
                    else if (isDocuemnt) {
                        that.ClickDocumentToClose.apply(that, [ModalId]);
                    }
                });
                return;
            }
            this.Close(ModalId);
        },

        //手工关闭
        Close: function (ModalId, Params) {
            var that = this;
            if (ModalId) {
                //移除
                if (this.currentWindow == undefined) { this.currentWindow = top; }

                that.ShowPreModalNav();

                $(this.currentWindow.document).unbind("click.Close_" + ModalId);
                this.currentWindow.$("#" + ModalId).animate({ right: this.currentWindow.$("body").width() * -0.75 }, function () {
                    that.currentWindow.$("#" + ModalId).find("iframe").remove();//先移除iframe再移除div，解决ie下新增后再打开侧滑框不能编辑文本框的问题
                    that.currentWindow.$("#" + ModalId).remove();
                    that.currentWindow.$("body").css("overflow-y", "auto");
                    that.currentWindow.$("body").removeClass("modal-back");
                });

                var index = $.inArray(ModalId, top.$.ISideModal.ModalIdArray);
                if (index > -1) {
                    top.$.ISideModal.ModalIdArray.splice(index, 1);
                }

                if (this.CallBackArray[ModalId] && $.isFunction(this.CallBackArray[ModalId])) {
                    this.CallBackArray[ModalId].call(this, Params);
                }

                //移除后，还有的话，显示最后一个
                //this.ShowLastModal();
            }
            else {
                this.CloseLastModal(Params);
            }
        },

        CloseLastModal: function (params) {
            if (top.$.ISideModal.ModalIdArray.length > 0) {
                this.Close(top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 1], params);
            }
        },

        ShowLastModal: function () {
            if (top.$.ISideModal.ModalIdArray.length > 0) {
                var id = top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 1];
                $("#" + id).animate({ right: 0 });
                //点击其他地方，关闭
                this.ClickDocumentToClose.apply(this, [id]);
            }
        },

        GetPreModalBody: function () {
            if (top.$.ISideModal.ModalIdArray && top.$.ISideModal.ModalIdArray.length > 1) {
                return window.frames["frame_" + top.$.ISideModal.ModalIdArray[top.$.ISideModal.ModalIdArray.length - 2]].document.body;
            }
            else {
                return null;
            }
        },
        //隐藏上级侧滑框的按钮
        HidePreModalNav: function () {
            if (this.currentWindow == top) {
                return;
            }
            $(this.currentWindow.document.body).find("ul.navbar-nav").hide();
        },
        //显示上级侧滑框的按钮
        ShowPreModalNav: function () {
            if (window.parent) {
                $(this.currentWindow.document.body).find("ul.navbar-nav").show();
            }
        },
        //判断通知公告是否显示
        IsAnnounceShow: function () {
            var announce = $('.announce');
            if (announce && announce.is(':visible')) {
                return true;
            }
            return false;

        }

    },

    //打开表单模态窗口
    ISheetModal: {
        SheetMoal: null,
        //url:地址,title：模态窗口标题，可为空
        Show: function (url, title, hiddenCallback) {
            url = url.indexOf("?") > -1 ? url + "&t=" + $.IGuid() : url + "?t=" + $.IGuid();
            if (this.SheetMoal) {
                this.SheetMoal.Show(url);
            }
            else {
                this.SheetMoal = new $.IModal(title, url, null, null, hiddenCallback);
            }
        },
        Hide: function () {
            this.SheetMoal.Hide();
        }
    },

    //获取日期时间字符串，格式yyyy-MM-dd HH:mm:ss
    IGetDateString: function (datetime) {
        var Year = datetime.getFullYear();
        var Month = datetime.getMonth() + 1;
        var Day = datetime.getDate();
        var Hour = datetime.getHours();
        var Minutes = datetime.getMinutes();
        var Seconds = datetime.getSeconds();
        var DateStr = "";

        DateStr = Year + "-";
        if (Month > 10) {
            DateStr = DateStr + Month + "-";
        } else {
            DateStr = DateStr + "0" + Month + "-";
        }
        if (Day > 10) {
            DateStr = DateStr + Day + " ";
        } else {
            DateStr = DateStr + "0" + Day + " ";
        }
        if (Hour > 10) {
            DateStr = DateStr + Hour + ":";
        } else {
            DateStr = DateStr + "0" + Hour + ":";
        }
        if (Minutes > 10) {
            DateStr = DateStr + Minutes + ":";
        } else {
            DateStr = DateStr + "0" + Minutes + ":";
        }
        if (Seconds > 10) {
            DateStr = DateStr + Seconds;
        } else {
            DateStr = DateStr + "0" + Seconds;
        }
        return DateStr;
    },

    //查询数组里对象跟指定对象的某个属性相等的第一个位置
    IGetIndex: function (obj, array, attr) {
        for (var i = 0; i < array.length; i++) {
            if (array[i][attr] == obj[attr]) {
                return i;
            }
        }
        return -1;
    },

    //判断浏览器设备类型
    IIfMobile: function () {
        var MobileUA = (function () {
            var ua = navigator.userAgent.toLowerCase();

            var mua = {
                IOS: /ipod|iphone|ipad/.test(ua), //iOS
                IPHONE: /iphone/.test(ua), //iPhone
                IPAD: /ipad/.test(ua), //iPad
                ANDROID: /android/.test(ua), //Android Device
                WINDOWS: /windows/.test(ua), //Windows Device
                TOUCH_DEVICE: ('ontouchstart' in window) || /touch/.test(ua), //Touch Device
                MOBILE: /mobile/.test(ua), //Mobile Device (iPad)
                ANDROID_TABLET: false, //Android Tablet
                WINDOWS_TABLET: false, //Windows Tablet
                TABLET: false, //Tablet (iPad, Android, Windows)
                SMART_PHONE: false //Smart Phone (iPhone, Android)
            };

            mua.ANDROID_TABLET = mua.ANDROID && !mua.MOBILE;
            mua.WINDOWS_TABLET = mua.WINDOWS && /tablet/.test(ua);
            mua.TABLET = mua.IPAD || mua.ANDROID_TABLET || mua.WINDOWS_TABLET;
            mua.SMART_PHONE = mua.MOBILE && !mua.TABLET;

            return mua;
        }());
        if (MobileUA.SMART_PHONE) {
            return true;
        }
        return false;
    },

    //检查是否是严格的文本:非空，不含有特殊字符 `!@#$%^&*()-_+=[{]}\\|;:\'\",<.>/? ~！￥…（）【】、：；‘“”，。《》？
    //IgnoreChars 可不传，数组，排除的类
    IValidateStrictText: function (str, IgnoreChars) {
        if (str == null || str.trim() == "") {
            return false;
        }
        var SpecialChars = ['`', '!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '-', '_', '+', '=', '[', '{', ']', '}', '\\', '|', ';', ':', '\'', '\"', ',', '<', '.', '>', '/?', ' ', '~', '！', '￥', '…', '（', '）', '【', '】', '、', '：', '；', '‘', '“', '”', '，', '。', '《', '》', '？'];
        if (!$.isEmptyObject(IgnoreChars)) {
            for (var i = 0; i < IgnoreChars.length; i++) {
                var index = SpecialChars.indexOf(IgnoreChars[i]);
                if (index > -1)
                    SpecialChars.splice(index, 1);
            }
        }
        for (var i = 0; i < str.length; i++) {
            if (SpecialChars.indexOf(str.charAt(i)) > -1) {
                return false;
            }
        }
        return true;
    },

    //检查是否是严格的文本:非空，不含有特殊字符 `!@#$%^&*()-_+=[{]}\\|;:\'\",<.>/? ~！￥…（）【】、：；‘“”，。《》？
    //IgnoreChars 可不传，数组，排除的类
    IValidatePassword: function (str) {
        if (str == null || str.trim() == "") {
            return false;
        }
        var match = /^[a-zA-Z0-9,.'"~!@@#$%^&*()_+{}[]|\/:;<>?`-=·！￥…（）—【】、，。《》？]*$/;
        var match1 = /\s/;
        if (str.length < 6 || str.length > 20) {
            return false;
        }
        for (var ooo = 0; ooo < str.length; ooo++) {
            if (!match.test(str.charAt(ooo)) || match1.test(str.charAt(ooo)))
                return false;
        }
        //密码强度
        var match2 = /^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,20}$/;
        if (!match2.test(str))
            return false;
        return true;
    },

    //校验电话号码
    IValidateMobile: function (str) {
        if (str == null || str.trim() == "") {
            return false;
        }
        var expression = /^1[3-8]\d{9}$/;
        return expression.test(str);
    },

    //校验邮箱
    IValidateEmail: function (str) {
        if (str == null || str.trim() == "") {
            return false;
        }
        var expression = /^\w+([-+.]\w+)*@\w+([-.]\\w+)*\.\w+([-.]\w+)*$/;
        return expression.test(str);
    },

    //校验微信号
    IValidateChat: function (str) {

    },
    /*
    鼠标滑过元素时在页面上生成缩略图
    selector：元素选择器
    imgPath：图片的路径
    */
    Ipreview: function (selector) {
        var imgPath = selector.attr("data-imgurl");
        if (imgPath == "null" || imgPath == null || imgPath == void 0) {
            return;
        }
        if(imgPath.lastIndexOf("ctg-workflow")>=0){
          
            
            imgPath= imgPath.substring(imgPath.lastIndexOf("ctg-workflow"));
           
            while(imgPath.indexOf('%252F')>=0){
                imgPath = imgPath.replace('%252F','/')
            }
        }
        var $preImgHtml = $('<div class="preimg"><img src="' + imgPath + '"  class="pcimg" /></div>');

        selector.mouseover(function (e) {
            selector.after($preImgHtml);
            $(".preimg").css({ top: e.clientY + 3, left: e.clientX + 10 });
        }).mousemove(function (e) {
            $(".preimg").css({ top: e.clientY + 3, left: e.clientX + 10 });
        }).mouseout(function () {
            $(".preimg").remove();
        });
    },

    //设置Cookie
    ISetCookie: function (name, value) {
        var str = name + "=" + escape(value);
        document.cookie = str;
    },

    //读取Cookie
    IGetCookie: function (name) {
        var arr = document.cookie.split(";");
        if (!name)
            return null;
        var name = name.trim();
        for (var i = 0; i < arr.length; i++) {
            var key = arr[i].split("=")[0].trim();
            if (key == name) {
                return arr[i].split("=")[1];
            }
        }
        return null;
    },

    //删除Cookie
    IRemoveCookie: function (name) {
        document.cookie = name + "=;expires=" + (new Date(0)).toGMTString();
    },

    // 字符图标选择器
    IFontPicker: function () {
        var source = [];
        var fontPickerCollection = [];
        var init = function () {
            var path = document.location.href;
            var pathName = document.location.pathname;
            var localPath = path.substr(0, path.indexOf(pathName));
            $.ajaxSettings.async = false;
            $.getJSON(localPath + '/Content/H3-Icon/selection.json', function (data) {
                var icons = [];
                for (var i = 0, len = data.icons.length; i < len; i++) {
                    icons.push('icon-' + data.icons[i].properties.name);
                }
                source = icons;
            });
        };
        init();

        this.AddFontPicker = function (selecter) {
            if (source.length > 0) {
                var fontPicker = $(selecter).fontIconPicker({
                    source: source,
                    emptyIcon: false,
                    hasSearch: false
                });
                fontPickerCollection.push({ 'selecter': selecter.selecter, 'picker': fontPicker });
            }
        };
        var getFontPicker = function (selecter) {
            if (selecter) {
                if (fontPickerCollection.length == 1) return fontPickerCollection[0].picker;
                for (var i = 0, len = fontPickerCollection.length; i < len; i++) {
                    if (fontPickerCollection[i].picker && fontPickerCollection[i].picker.selector == selecter.selector) {
                        return fontPickerCollection[i].picker;
                    }
                }
                return null;
            }
        };
        //动态参数
        this.SetIcon = function (icon, selecter) {
            var fontPicker = null;
            if (!selecter) {
                fontPicker = fontPickerCollection[0].picker;
            } else {
                fontPicker = getFontPicker(selecter);
            }
            if (fontPicker) {
                fontPicker.refreshPicker({
                    source: source,
                    emptyIcon: true,
                    emptyIconValue: icon,
                    hasSearch: false
                });
            }

        };
        return this;
    },
    isArray: function (o) {
        return Object.prototype.toString.call(o) === '[object Array]';
    },
    IShowLoading: function (text) {
        var text = text || "处理中，请稍等...";
        var $loading = $(".loading-back");
        if ($loading.length > 0) {
            $loading.find("load-title").text(text).end().show();
        } else {
            $loading = $('<div class="loading-back">' +
                '<div class="loading">' +
                '<i class="fa fa-spinner fa-4x fa-pulse"></i>' +
                '<span class="load-title">' + text + '</span>' +
                '</div>' +
                '</div>');
            $("body").append($loading.show());
        }
    },
    IHideLoading: function () {
        $(".loading-back").hide();
    },
    //只允许输入中英文数字符号，目的是过滤表情
    IFilterCharacter: function (str) {
        var newStr = str;
        var range = /[\u4e00-\u9fa5a-zA-Z0-9\~\!\@\#\$\%\&\*\(\)\_\+\|\:\"\<\>\?\/\-\=\[\]\;\,\.\！\￥\……]/g;
        var arr = str.match(range);
        if (arr == null)
            newStr = "";
        else
            newStr = arr.join('');
        return newStr
    },
    //数字转成千分位(对小数位没有做限制)
    IToKbit: function (num) {
        var temp = num;
        var num = (num || 0).toString(), result = '';
        if (isNaN(num)) return 0;
        var numStr = num + '';
        var potIndex = numStr.indexOf('.');
        var decimal = '';
        if (potIndex > -1) {
            num = numStr.slice(0, potIndex);
            decimal = numStr.slice(potIndex);
        }
        num = parseInt(num);
        var negative = false;//负数
        if (parseFloat(temp) < 0) {
            negative = true;
            num = Math.abs(num) + '';
        }
        num += '';
        while (num.length > 3) {
            result = ',' + num.slice(-3) + result;
            num = num.slice(0, num.length - 3);
        }
        if (num) { result = num + result; }
        if (potIndex > -1) {
            result += decimal;
        } else {
            //result += '.00';
        }
        if (negative) {
            result = '-' + result;
        }
        return result;
    },
    //获取当月最后一天日期
    GetFirstAndLastMonthDay: function (year, month) {
        var firstdate = year + '-' + month + '-01';
        var day = new Date(year, month, 0);
        var lastdate = year + '-' + month + '-' + day.getDate();
        return lastdate;
    },
    //获取本周的第一天和最后一天
    GetFirstAndLastdayweek: function () {
        var time = new Date();
        if (time.getDay() != 0) {
            time.setDate(time.getDate() - time.getDay() + 1);
        }
        else {
            time.setDate(time.getDate() - 6);
        }
        weekfirstday = time.getFullYear() + "-" + (time.getMonth() - 0 + 1) + "-" + time.getDate();
        time.setDate(time.getDate() + 6);
        weekdayLast = time.getFullYear() + "-" + (time.getMonth() - 0 + 1) + "-" + time.getDate();
        return [weekfirstday, weekdayLast];
    },
    //获取本季第一天，最后一天
    GetFirstAndLastDayQuarter: function () {
        var mydate = new Date();
        var month = mydate.getMonth() - 0 + 1;
        var year = mydate.getFullYear();
        if (month >= 1 && month <= 3) {
            var firstdate = year + '-' + 1 + '-01';
            var day = new Date(year, 3, 0);
            var lastdate = year + '-' + 3 + '-' + day.getDate();//获取第一季度最后一天日期
            return [firstdate, lastdate];
        } else if (month >= 4 && month <= 6) {
            var firstdate = year + '-' + 4 + '-01';
            var day = new Date(year, 6, 0);
            var lastdate = year + '-' + 6 + '-' + day.getDate();//获取第二季度最后一天日期
            return [firstdate, lastdate];
        } else if (month >= 7 && month <= 9) {
            var firstdate = year + '-07-01';
            var day = new Date(year, 9, 0);
            var lastdate = year + '-09-' + day.getDate();//获取第三季度最后一天日期
            return [firstdate, lastdate];
        } else if (month >= 10 && month <= 12) {
            var firstdate = year + '-' + 10 + '-01';
            var day = new Date(year, 12, 0);
            var lastdate = year + '-' + 12 + '-' + day.getDate();//获取第四季度最后一天日期
            return [firstdate, lastdate];
        }

    },
    nodeToString: function (node) {
        var tmpNode = document.createElement("div");
        tmpNode.appendChild(node.cloneNode(true));
        var str = tmpNode.innerHTML;
        tmpNode = node = null; // prevent memory leaks in IE
        return str;
    },
    ClearArray: function (array) {
        if (array) {
            var obj;
            for (var i = array.length - 1; i >= 0; i--) {
                obj = array.pop();
                obj.free && obj.free();
                obj = null;
            }
        }
    },
    // 函数节流
    Throttle: function (fn, context, delay) {
        return function () {
            var args = arguments;
            clearTimeout(fn.timerId);
            fn.timerId = setTimeout(function () {
                fn.apply(context, args);
            }, delay);
        };
    },
    ////Date(1506476541000)/ 格式的日期转为date;
    GetDateTime: function (d) {
        return eval("new " + d.substr(1, d.length - 2));
    }
});

jQuery.extend(
    $.SheetRuntimeContentCache,
    {
        MaxSheetNumber: 200,
        KeyName: "SheetRuntimeContentCache",
        TimeStampName: "TimeStamp",
        SheetContentName: "SheetContent",
        SchemaCodeName: "SchemaCode",
        JavaScriptName: "Javascript",
        EngineCodeName: "EngineCode",
        ListJavaScriptName: "ListJavascript",
        ListPostFix: "_List",
        Init: function (engineCode) {
            var cache = localStorage.getItem(this.KeyName);
            if (!cache || cache == "") {
                return;
            }
            var itemCache = JSON.parse(cache);
            //切换引擎后，清除缓存
            if (itemCache[this.EngineCodeName] != engineCode) {
                this.Clear();
                itemCache[this.EngineCodeName] = engineCode;
            }
            var num = 0;
            for (var key in itemCache) {
                num++;
            }
            //数量超过200后，清除缓存
            if (num > this.MaxSheetNumber) {
                this.Clear();
            }
        },
        Get: function (schemaCode, type) {
            var cache = localStorage.getItem(this.KeyName);
            if (!cache || cache == "") {
                return null;
            }
            var itemCache = JSON.parse(cache);
            if (type == "form") {
                if (itemCache[schemaCode]) {
                    return itemCache[schemaCode];
                }
                else {
                    return null;
                }
            }
            else if (type == "list") {
                if (itemCache[schemaCode + this.ListPostFix]) {
                    return itemCache[schemaCode + this.ListPostFix];
                }
                else {
                    return null;
                }
            }
        },
        Set: function (schemaCode, content, timestamp, javaScript, type, engineCode, appRunId_) {
            if (type == "form") {
                if (!schemaCode || !content || !timestamp) {
                    return;
                }
                var cache = localStorage.getItem(this.KeyName);
                var itemCache;
                window.currentCode = schemaCode;
                //luzx add
                window.appRunId_ = appRunId_;
                console.log('Set.appRunId_=' + appRunId_);
                console.log('Set.window.appRunId_=' + window.appRunId_);
                if (!cache || cache == "") {
                    itemCache = {};
                }
                else {
                    itemCache = JSON.parse(cache);
                }
                if (!itemCache[schemaCode]) {
                    itemCache[schemaCode] = {};
                }
                itemCache[schemaCode][this.TimeStampName] = timestamp;
                itemCache[schemaCode][this.SheetContentName] = content;
                itemCache[schemaCode][this.JavaScriptName] = javaScript;
                itemCache[this.EngineCodeName] = engineCode;
                localStorage.setItem(this.KeyName, JSON.stringify(itemCache));
            }
            else if (type == "list") {
                var cache = localStorage.getItem(this.KeyName);
                var itemCache;
                if (!cache || cache == "") {
                    itemCache = {};
                }
                else {
                    itemCache = JSON.parse(cache);
                }
                if (!itemCache[schemaCode + this.ListPostFix]) {
                    itemCache[schemaCode + this.ListPostFix] = {};
                }
                //列表只更新javascript
                itemCache[schemaCode + this.ListPostFix][this.TimeStampName] = timestamp;
                itemCache[schemaCode + this.ListPostFix][this.ListJavaScriptName] = javaScript;
                itemCache[this.EngineCodeName] = engineCode;
                localStorage.setItem(this.KeyName, JSON.stringify(itemCache));
            }

        },
        Clear: function () {
            localStorage.setItem(this.KeyName, "");
        }
    }
);


;
jQuery.extend({
    // 打开表单的接口
    //otherParam其他参数，json格式:{showInModal:是否显示在弹出框中,title:"",height:500,widht:500,OnShowCallback:function,OnHiddenCallback:function}
    /*{ 1.schemaCode SchemaCode表单编码参数
        2.objectId ,BizObjectID不传时打开新增时的表单
        3.params ,传递到表单的参数
        4.checkIsChange,是否检查修改
        5.showlist,兼容移动端是否显示列表
        6.showInModal：是否弹出框中显示，如果为false，title height width OnShowCallback OnHiddenCallback 等属性不起作用
        7.title: 对话框标题
        8.height:对话框高度，格式 500 数值类型
        9.width: 对话框宽度，格式 500
        10.OnShowCallback 显示时事件
        11.OnHiddenCallback 隐藏时显示
    }*/
    IShowForm: function () {
        //schemaCode, objectId, params, checkIsChange 其他参数使用JSON格式
        if (arguments.length < 1) {
            return;
        }
        var args = {
            schemaCode: "",
            objectId: "",
            params: "",
            checkIsChange: false,
            showInModal: false,
            title: "",
            height: 500,
            width: 820,
            onShowCallback: null,
            onHiddenCallback: null
        };

        for (var i = 0; i < arguments.length; i++) {
            var data = arguments[i];
            if (data == null) { continue; }
            if (typeof (data) == "string" || data.constructor == String
                || typeof (data) == "boolean" || data.constructor == Boolean
                || typeof (data) == "function" || data.constructor == Function
            ) {
                if (i == 0) {
                    args.schemaCode = data;
                } else if (i == 1) {
                    args.objectId = data;
                } else if (i == 2) {
                    args.params = JSON.parse(data);
                } else if (i == 3) {
                    args.checkIsChange = data;
                }

            } else if (typeof (data) == "object" || data.constructor == Object) {
                if (i == 2 && !data.params && data.showInModal == undefined) {
                    args.params = data;
                } else {
                    args = $.extend({}, args, data);
                }
            }
        }

        if (args.showInModal) {
            $.IDialogModal.Show(args.schemaCode, args.objectId, args.title, args.height, args.width, args.params, args.onShowCallback, args.onHiddenCallback);
        }
        else {
            $.ISideModal.Show("/Form/DefaultSheet/" + args.schemaCode + "?SchemaCode=" + args.schemaCode + "&BizObjectId=" + args.objectId, "", null, null, args.checkIsChange, args.params);
        }
    },
    // 获取参数值
    IGetParams: function (name) {
        //SideModal 侧滑框
        var sideModalValue = top.$.ISideModal.GetParamValue(name);
        if (sideModalValue) {
            return sideModalValue;
        }
        //弹出框表单参数
        var dialogArguments = localStorage.getItem('DialogArguments');
        if (dialogArguments) {
            var jsonData = JSON.parse(dialogArguments);
            return jsonData[name];
        }
        return null;
    },

    // 定位
    ILocation: function () {
        //$.IShowWarn("PC端不支持定位");
        //console.log("PC端不支持定位");
        //return null;
        var Address = "深圳市南山区科技南十路航天科技研究院";
        var Point = { lat: '21.345', lng: '114.454' };
        return {
            Address: Address,
            Point: Point
        };
    },

    // 下载附件
    IDownloadAttachments: function (attachmentIds) {
        var attachmentIdStr = attachmentIds.join(";");
        window.open("/Form/DownloadAttachments/?AttachmentIdStr=" + attachmentIdStr);
    },

    //显示提示框
    IShowPreLoader: function (title) {

    },
    //隐藏提示框
    IHidePreLoader: function () {

    },
    //扫描二维码
    IScanBarCode: function () { },
    //扫描条形码
    IScanQrCode: function () { },
    //扫描名片
    IScanCard: function () { },

    IOpenLink: function (url) {
        window.open(url);
    },


    //显示钉钉个人资料页
    IShowUserInfo: function (userId, corpId) {

    },
    //显示钉钉聊天页面
    IShowChatPage: function (users, corpId) {

    },
    //拨打免费电话
    IShowFreeCall: function () {

    },
    //图片类型钉消息
    IPostImageDing: function (users, corpId, text, success, fail) {

    },
    //Link类型钉消息
    IPostLinkDing: function (users, corpId, text, title, url, imageUrl, subText, success, fail) {

    }

});;
/**
 * @author zhixin wen <wenzhixin2010@gmail.com>
 * version: 1.10.1
 * https://github.com/wenzhixin/bootstrap-table/
 */

!function ($) {
    'use strict';

    // TOOLS DEFINITION
    // ======================

    var cachedWidth = null;

    // it only does '%s', and return '' when arguments are undefined
    var sprintf = function (str) {
        var args = arguments,
            flag = true,
            i = 1;

        str = str.replace(/%s/g, function () {
            var arg = args[i++];

            if (typeof arg === 'undefined') {
                flag = false;
                return '';
            }
            return arg;
        });
        return flag ? str : '';
    };

    var getPropertyFromOther = function (list, from, to, value) {
        var result = '';
        $.each(list, function (i, item) {
            if (item[from] === value) {
                result = item[to];
                return false;
            }
            return true;
        });
        return result;
    };

    var getFieldIndex = function (columns, field) {
        var index = -1;

        $.each(columns, function (i, column) {
            try {
                if (column.field === field) {
                    index = i;
                    return false;
                }
            }

            catch (e) {
                var a = e;
            }
            return true;
        });
        return index;
    };

    // http://jsfiddle.net/wenyi/47nz7ez9/3/
    var setFieldIndex = function (columns) {
        var i, j, k,
            totalCol = 0,
            flag = [];

        for (i = 0; i < columns[0].length; i++) {
            totalCol += columns[0][i].colspan || 1;
        }

        for (i = 0; i < columns.length; i++) {
            flag[i] = [];
            for (j = 0; j < totalCol; j++) {
                flag[i][j] = false;
            }
        }

        for (i = 0; i < columns.length; i++) {
            for (j = 0; j < columns[i].length; j++) {
                var r = columns[i][j],
                    rowspan = r.rowspan || 1,
                    colspan = r.colspan || 1,
                    index = $.inArray(false, flag[i]);

                if (colspan === 1) {
                    r.fieldIndex = index;
                    // when field is undefined, use index instead
                    if (typeof r.field === 'undefined') {
                        r.field = index;
                    }
                }

                for (k = 0; k < rowspan; k++) {
                    flag[i + k][index] = true;
                }
                for (k = 0; k < colspan; k++) {
                    flag[i][index + k] = true;
                }
            }
        }
    };

    var getScrollBarWidth = function () {
        if (cachedWidth === null) {
            var inner = $('<p/>').addClass('fixed-table-scroll-inner'),
                outer = $('<div/>').addClass('fixed-table-scroll-outer'),
                w1, w2;

            outer.append(inner);
            $('body').append(outer);

            w1 = inner[0].offsetWidth;
            outer.css('overflow', 'scroll');
            w2 = inner[0].offsetWidth;

            if (w1 === w2) {
                w2 = outer[0].clientWidth;
            }

            outer.remove();
            cachedWidth = w1 - w2;
        }
        return cachedWidth;
    };

    var calculateObjectValue = function (self, name, args, defaultValue) {
        var func = name;

        if (typeof name === 'string') {
            // support obj.func1.func2
            var names = name.split('.');

            if (names.length > 1) {
                func = window;
                $.each(names, function (i, f) {
                    func = func[f];
                });
            } else {
                func = window[name];
            }
        }
        if (typeof func === 'object') {
            return func;
        }
        if (typeof func === 'function') {
            return func.apply(self, args);
        }
        if (!func && typeof name === 'string' && sprintf.apply(this, [name].concat(args))) {
            return sprintf.apply(this, [name].concat(args));
        }
        return defaultValue;
    };

    var compareObjects = function (objectA, objectB, compareLength) {
        // Create arrays of property names
        var objectAProperties = Object.getOwnPropertyNames(objectA),
            objectBProperties = Object.getOwnPropertyNames(objectB),
            propName = '';

        if (compareLength) {
            // If number of properties is different, objects are not equivalent
            if (objectAProperties.length !== objectBProperties.length) {
                return false;
            }
        }

        for (var i = 0; i < objectAProperties.length; i++) {
            propName = objectAProperties[i];

            // If the property is not in the object B properties, continue with the next property
            if ($.inArray(propName, objectBProperties) > -1) {
                // If values of same property are not equal, objects are not equivalent
                if (objectA[propName] !== objectB[propName]) {
                    return false;
                }
            }
        }

        // If we made it this far, objects are considered equivalent
        return true;
    };

    var escapeHTML = function (text) {
        if (typeof text === 'string') {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
                .replace(/`/g, '&#x60;');
        }
        return text;
    };

    var getRealHeight = function ($el) {
        var height = 0;
        $el.children().each(function () {
            if (height < $(this).outerHeight(true)) {
                height = $(this).outerHeight(true);
            }
        });
        return height;
    };

    var getRealDataAttr = function (dataAttr) {
        for (var attr in dataAttr) {
            var auxAttr = attr.split(/(?=[A-Z])/).join('-').toLowerCase();
            if (auxAttr !== attr) {
                dataAttr[auxAttr] = dataAttr[attr];
                delete dataAttr[attr];
            }
        }

        return dataAttr;
    };

    var getItemField = function (item, field, escape) {
        var value = item;

        if (typeof field !== 'string' || item.hasOwnProperty(field)) {
            return escape ? escapeHTML(item[field]) : item[field];
        }
        var props = field.split('.');
        for (var p in props) {
            value = value && value[props[p]];
        }
        return escape ? escapeHTML(value) : value;
    };

    var isIEBrowser = function () {
        return !!(navigator.userAgent.indexOf("MSIE ") > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./));
    };

    // BOOTSTRAP TABLE CLASS DEFINITION
    // ======================

    var BootstrapTable = function (el, options) {
        this.options = options;
        this.$el = $(el);
        this.$el_ = this.$el.clone();
        this.timeoutId_ = 0;
        this.timeoutFooter_ = 0;

        this.init();
    };

    BootstrapTable.DEFAULTS = {
        classes: 'table table-hover',
        locale: undefined,
        height: undefined,
        undefinedText: '-',
        sortName: undefined,
        sortOrder: 'asc',
        striped: false,
        columns: [[]],
        data: [],
        dataField: 'rows',
        method: 'get',
        url: undefined,
        ajax: undefined,
        cache: true,
        contentType: 'application/json',
        dataType: 'json',
        ajaxOptions: {},
        queryParams: function (params) {
            return params;
        },
        queryParamsType: 'limit', // undefined
        responseHandler: function (res) {
            return res;
        },
        pagination: false,
        onlyInfoPagination: false,
        sidePagination: 'client', // client or server
        totalRows: 0, // server side need to set
        pageNumber: 1,
        pageSize: 10,
        pageList: [10, 25, 50, 100],
        paginationHAlign: 'right', //right, left
        paginationVAlign: 'bottom', //bottom, top, both
        paginationDetailHAlign: 'left', //right, left
        paginationPreText: '&lsaquo;',
        paginationNextText: '&rsaquo;',
        search: false,
        searchOnEnterKey: false,
        strictSearch: false,
        searchAlign: 'right',
        selectItemName: 'btSelectItem',
        showHeader: true,
        showFooter: false,
        showColumns: false,
        showPaginationSwitch: false,
        showRefresh: false,
        showToggle: false,
        buttonsAlign: 'right',
        smartDisplay: true,
        escape: false,
        minimumCountColumns: 1,
        idField: undefined,
        uniqueId: undefined,
        cardView: false,
        detailView: false,
        detailFormatter: function (index, row) {
            return '';
        },
        trimOnSearch: true,
        clickToSelect: false,
        singleSelect: false,
        toolbar: undefined,
        toolbarAlign: 'left',
        checkboxHeader: true,
        sortable: true,
        silentSort: true,
        maintainSelected: false,
        searchTimeOut: 500,
        searchText: '',
        iconSize: undefined,
        iconsPrefix: 'glyphicon', // glyphicon of fa (font awesome)
        icons: {
            paginationSwitchDown: 'glyphicon-collapse-down icon-chevron-down',
            paginationSwitchUp: 'glyphicon-collapse-up icon-chevron-up',
            refresh: 'glyphicon-refresh icon-refresh',
            toggle: 'glyphicon-list-alt icon-list-alt',
            columns: 'glyphicon-th icon-th',
            detailOpen: 'glyphicon-plus icon-plus',
            detailClose: 'glyphicon-minus icon-minus'
        },

        rowStyle: function (row, index) {
            return {};
        },

        rowAttributes: function (row, index) {
            return {};
        },

        onAll: function (name, args) {
            return false;
        },
        onClickCell: function (field, value, row, $element) {
            return false;
        },
        onDblClickCell: function (field, value, row, $element) {
            return false;
        },
        onClickRow: function (item, $element) {
            return false;
        },
        onDblClickRow: function (item, $element) {
            return false;
        },
        onSort: function (name, order) {
            return false;
        },
        onCheck: function (row) {
            return false;
        },
        onUncheck: function (row) {
            return false;
        },
        onCheckAll: function (rows) {
            return false;
        },
        onUncheckAll: function (rows) {
            return false;
        },
        onCheckSome: function (rows) {
            return false;
        },
        onUncheckSome: function (rows) {
            return false;
        },
        onLoadSuccess: function (data) {
            return false;
        },
        onLoadError: function (status) {
            return false;
        },
        onColumnSwitch: function (field, checked) {
            return false;
        },
        onPageChange: function (number, size) {
            return false;
        },
        onSearch: function (text) {
            return false;
        },
        onToggle: function (cardView) {
            return false;
        },
        onPreBody: function (data) {
            return false;
        },
        onPostBody: function () {
            return false;
        },
        onPostHeader: function () {
            return false;
        },
        onExpandRow: function (index, row, $detail) {
            return false;
        },
        onCollapseRow: function (index, row) {
            return false;
        },
        onRefreshOptions: function (options) {
            return false;
        },
        onResetView: function () {
            return false;
        }
    };

    BootstrapTable.LOCALES = [];

    BootstrapTable.LOCALES['en-US'] = BootstrapTable.LOCALES['en'] = {
        formatLoadingMessage: function () {
            return 'Loading, please wait...';
        },
        formatRecordsPerPage: function (pageNumber) {
            return sprintf('%s records per page', pageNumber);
        },
        formatShowingRows: function (pageFrom, pageTo, totalRows) {
            return sprintf('Showing %s to %s of %s rows', pageFrom, pageTo, totalRows);
        },
        formatDetailPagination: function (totalRows) {
            return sprintf('Showing %s rows', totalRows);
        },
        formatSearch: function () {
            return 'Search';
        },
        formatNoMatches: function () {
            return 'No matching records found';
        },
        formatPaginationSwitch: function () {
            return 'Hide/Show pagination';
        },
        formatRefresh: function () {
            return 'Refresh';
        },
        formatToggle: function () {
            return 'Toggle';
        },
        formatColumns: function () {
            return 'Columns';
        },
        formatAllRows: function () {
            return 'All';
        }
    };

    $.extend(BootstrapTable.DEFAULTS, BootstrapTable.LOCALES['en-US']);

    BootstrapTable.COLUMN_DEFAULTS = {
        radio: false,
        checkbox: false,
        checkboxEnabled: true,
        field: undefined,
        title: undefined,
        titleTooltip: undefined,
        'class': undefined,
        align: undefined, // left, right, center
        halign: undefined, // left, right, center
        falign: undefined, // left, right, center
        valign: undefined, // top, middle, bottom
        width: undefined,
        sortable: false,
        order: 'asc', // asc, desc
        visible: true,
        switchable: true,
        clickToSelect: true,
        formatter: undefined,
        footerFormatter: undefined,
        events: undefined,
        sorter: undefined,
        sortName: undefined,
        cellStyle: undefined,
        searchable: true,
        searchFormatter: true,
        cardVisible: true
    };

    BootstrapTable.EVENTS = {
        'all.bs.table': 'onAll',
        'click-cell.bs.table': 'onClickCell',
        'dbl-click-cell.bs.table': 'onDblClickCell',
        'click-row.bs.table': 'onClickRow',
        'dbl-click-row.bs.table': 'onDblClickRow',
        'sort.bs.table': 'onSort',
        'check.bs.table': 'onCheck',
        'uncheck.bs.table': 'onUncheck',
        'check-all.bs.table': 'onCheckAll',
        'uncheck-all.bs.table': 'onUncheckAll',
        'check-some.bs.table': 'onCheckSome',
        'uncheck-some.bs.table': 'onUncheckSome',
        'load-success.bs.table': 'onLoadSuccess',
        'load-error.bs.table': 'onLoadError',
        'column-switch.bs.table': 'onColumnSwitch',
        'page-change.bs.table': 'onPageChange',
        'search.bs.table': 'onSearch',
        'toggle.bs.table': 'onToggle',
        'pre-body.bs.table': 'onPreBody',
        'post-body.bs.table': 'onPostBody',
        'post-header.bs.table': 'onPostHeader',
        'expand-row.bs.table': 'onExpandRow',
        'collapse-row.bs.table': 'onCollapseRow',
        'refresh-options.bs.table': 'onRefreshOptions',
        'reset-view.bs.table': 'onResetView'
    };

    BootstrapTable.prototype.init = function () {
        this.initLocale();
        this.initContainer();
        this.initTable();
        this.initHeader();
        this.initData();
        this.initFooter();
        this.initToolbar();
        this.initPagination();
        this.initBody();
        this.initSearchText();
        this.initServer();
    };

    BootstrapTable.prototype.initLocale = function () {
        if (this.options.locale) {
            var parts = this.options.locale.split(/-|_/);
            parts[0].toLowerCase();
            parts[1] && parts[1].toUpperCase();
            if ($.fn.bootstrapTable.locales[this.options.locale]) {
                // locale as requested
                $.extend(this.options, $.fn.bootstrapTable.locales[this.options.locale]);
            } else if ($.fn.bootstrapTable.locales[parts.join('-')]) {
                // locale with sep set to - (in case original was specified with _)
                $.extend(this.options, $.fn.bootstrapTable.locales[parts.join('-')]);
            } else if ($.fn.bootstrapTable.locales[parts[0]]) {
                // short locale language code (i.e. 'en')
                $.extend(this.options, $.fn.bootstrapTable.locales[parts[0]]);
            }
        }
    };

    BootstrapTable.prototype.initContainer = function () {
        this.$container = $([
            '<div class="bootstrap-table">',
            '<div class="fixed-table-toolbar"></div>',
            this.options.paginationVAlign === 'top' || this.options.paginationVAlign === 'both' ?
                '<div class="fixed-table-pagination" style="clear: both;"></div>' :
                '',
            '<div class="fixed-table-container">',
            '<div class="fixed-table-header"><table></table></div>',
            '<div class="fixed-table-body">',
            '<div class="fixed-table-loading">',
            this.options.formatLoadingMessage(),
            '</div>',
            '</div>',
            '<div class="fixed-table-footer"><table><tr></tr></table></div>',
            this.options.paginationVAlign === 'bottom' || this.options.paginationVAlign === 'both' ?
                '<div class="fixed-table-pagination"></div>' :
                '',
            '</div>',
            '</div>'
        ].join(''));

        this.$container.insertAfter(this.$el);
        this.$tableContainer = this.$container.find('.fixed-table-container');
        this.$tableHeader = this.$container.find('.fixed-table-header');
        this.$tableBody = this.$container.find('.fixed-table-body');
        this.$tableLoading = this.$container.find('.fixed-table-loading');
        this.$tableFooter = this.$container.find('.fixed-table-footer');
        this.$toolbar = this.$container.find('.fixed-table-toolbar');
        this.$pagination = this.$container.find('.fixed-table-pagination');

        this.$tableBody.append(this.$el);
        this.$container.after('<div class="clearfix"></div>');

        this.$el.addClass(this.options.classes);
        if (this.options.striped) {
            this.$el.addClass('table-striped');
        }
        if ($.inArray('table-no-bordered', this.options.classes.split(' ')) !== -1) {
            this.$tableContainer.addClass('table-no-bordered');
        }
    };

    BootstrapTable.prototype.initTable = function () {
        var that = this,
            columns = [],
            data = [];

        this.$header = this.$el.find('>thead');
        if (!this.$header.length) {
            this.$header = $('<thead></thead>').appendTo(this.$el);
        }
        this.$header.find('tr').each(function () {
            var column = [];

            $(this).find('th').each(function () {
                column.push($.extend({}, {
                    title: $(this).html(),
                    'class': $(this).attr('class'),
                    titleTooltip: $(this).attr('title'),
                    rowspan: $(this).attr('rowspan') ? +$(this).attr('rowspan') : undefined,
                    colspan: $(this).attr('colspan') ? +$(this).attr('colspan') : undefined
                }, $(this).data()));
            });
            columns.push(column);
        });
        if (!$.isArray(this.options.columns[0])) {
            this.options.columns = [this.options.columns];
        }
        this.options.columns = $.extend(true, [], columns, this.options.columns);
        this.columns = [];

        setFieldIndex(this.options.columns);
        $.each(this.options.columns, function (i, columns) {
            $.each(columns, function (j, column) {
                column = $.extend({}, BootstrapTable.COLUMN_DEFAULTS, column);

                if (typeof column.fieldIndex !== 'undefined') {
                    that.columns[column.fieldIndex] = column;
                }

                that.options.columns[i][j] = column;
            });
        });

        // if options.data is setting, do not process tbody data
        if (this.options.data.length) {
            return;
        }

        this.$el.find('>tbody>tr').each(function () {
            var row = {};

            // save tr's id, class and data-* attributes
            row._id = $(this).attr('id');
            row._class = $(this).attr('class');
            row._data = getRealDataAttr($(this).data());

            $(this).find('td').each(function (i) {
                var field = that.columns[i].field;

                row[field] = $(this).html();
                // save td's id, class and data-* attributes
                row['_' + field + '_id'] = $(this).attr('id');
                row['_' + field + '_class'] = $(this).attr('class');
                row['_' + field + '_rowspan'] = $(this).attr('rowspan');
                row['_' + field + '_title'] = $(this).attr('title');
                row['_' + field + '_data'] = getRealDataAttr($(this).data());
            });
            data.push(row);
        });
        this.options.data = data;
    };

    BootstrapTable.prototype.initHeader = function () {
        var that = this,
            visibleColumns = {},
            html = [];

        this.header = {
            fields: [],
            styles: [],
            classes: [],
            formatters: [],
            events: [],
            sorters: [],
            sortNames: [],
            cellStyles: [],
            searchables: []
        };

        $.each(this.options.columns, function (i, columns) {
            html.push('<tr>');

            if (i == 0 && !that.options.cardView && that.options.detailView) {
                html.push(sprintf('<th class="detail" rowspan="%s"><div class="fht-cell"></div></th>',
                    that.options.columns.length));
            }

            $.each(columns, function (j, column) {
                var text = '',
                    halign = '', // header align style
                    align = '', // body align style
                    style = '',
                    class_ = sprintf(' class="%s"', column['class']),
                    order = that.options.sortOrder || column.order,
                    unitWidth = 'px',
                    width = column.width;

                if (column.width !== undefined && (!that.options.cardView)) {
                    if (typeof column.width === 'string') {
                        if (column.width.indexOf('%') !== -1) {
                            unitWidth = '%';
                        }
                    }
                }
                if (column.width && typeof column.width === 'string') {
                    width = column.width.replace('%', '').replace('px', '');
                }

                halign = sprintf('text-align: %s; ', column.halign ? column.halign : column.align);
                align = sprintf('text-align: %s; ', column.align);
                style = sprintf('vertical-align: %s; ', column.valign);
                style += sprintf('width: %s; ', (column.checkbox || column.radio) && !width ?
                    '36px' : (width ? width + unitWidth : undefined));

                if (typeof column.fieldIndex !== 'undefined') {
                    that.header.fields[column.fieldIndex] = column.field;
                    that.header.styles[column.fieldIndex] = align + style;
                    that.header.classes[column.fieldIndex] = class_;
                    that.header.formatters[column.fieldIndex] = column.formatter;
                    that.header.events[column.fieldIndex] = column.events;
                    that.header.sorters[column.fieldIndex] = column.sorter;
                    that.header.sortNames[column.fieldIndex] = column.sortName;
                    that.header.cellStyles[column.fieldIndex] = column.cellStyle;
                    that.header.searchables[column.fieldIndex] = column.searchable;

                    if (!column.visible) {
                        return;
                    }

                    if (that.options.cardView && (!column.cardVisible)) {
                        return;
                    }

                    visibleColumns[column.field] = column;
                }

                html.push('<th' + sprintf(' title="%s"', column.titleTooltip),
                    column.checkbox || column.radio ?
                        sprintf(' class="bs-checkbox %s"', column['class'] || '') :
                        class_,
                    sprintf(' style="%s"', halign + style),
                    sprintf(' rowspan="%s"', column.rowspan),
                    sprintf(' colspan="%s"', column.colspan),
                    sprintf(' data-field="%s"', column.field),
                    "tabindex='0'",
                    '>');

                html.push(sprintf('<div class="th-inner %s">', that.options.sortable && column.sortable ?
                    'sortable both' : ''));

                text = column.title;

                if (column.checkbox) {
                    if (!that.options.singleSelect && that.options.checkboxHeader) {
                        //text = '<input name="btSelectAll" type="checkbox" />';
                        var GID = $.IGuid();
                        text = '<input name="btSelectAll" id="' + GID + '" type="checkbox" style="display:none;" /><label for="' + GID + '"></label>';
                    }
                    that.header.stateField = column.field;
                }
                if (column.radio) {
                    text = '';
                    that.header.stateField = column.field;
                    that.options.singleSelect = true;
                }

                html.push(text);
                html.push('</div>');
                html.push('<div class="fht-cell"></div>');
                html.push('</div>');
                html.push('</th>');
            });
            html.push('</tr>');
        });

        this.$header.html(html.join(''));
        this.$header.find('th[data-field]').each(function (i) {
            $(this).data(visibleColumns[$(this).data('field')]);
        });
        this.$container.off('click', '.th-inner').on('click', '.th-inner', function (event) {
            var target = $(this);
            if (target.closest('.bootstrap-table')[0] !== that.$container[0])
                return false;

            if (that.options.sortable && target.parent().data().sortable) {
                that.onSort(event);
            }
        });

        this.$header.children().children().off('keypress').on('keypress', function (event) {
            if (that.options.sortable && $(this).data().sortable) {
                var code = event.keyCode || event.which;
                if (code == 13) { //Enter keycode
                    that.onSort(event);
                }
            }
        });

        if (!this.options.showHeader || this.options.cardView) {
            this.$header.hide();
            this.$tableHeader.hide();
            this.$tableLoading.css('top', 0);
        } else {
            this.$header.show();
            this.$tableHeader.show();
            this.$tableLoading.css('top', this.$header.outerHeight() + 1);
            // Assign the correct sortable arrow
            this.getCaret();
        }

        this.$selectAll = this.$header.find('[name="btSelectAll"]');
        this.$selectAll.off('click').on('click', function () {
            var checked = $(this).prop('checked');
            that[checked ? 'checkAll' : 'uncheckAll']();
            that.updateSelected();
        });
    };

    BootstrapTable.prototype.initFooter = function () {
        if (!this.options.showFooter || this.options.cardView) {
            this.$tableFooter.hide();
        } else {
            this.$tableFooter.show();
        }
    };

    /**
     * @param data
     * @param type: append / prepend
     */
    BootstrapTable.prototype.initData = function (data, type) {
        if (type === 'append') {
            this.data = this.data.concat(data);
        } else if (type === 'prepend') {
            this.data = [].concat(data).concat(this.data);
        } else {
            this.data = data || this.options.data;
        }

        // Fix #839 Records deleted when adding new row on filtered table
        if (type === 'append') {
            this.options.data = this.options.data.concat(data);
        } else if (type === 'prepend') {
            this.options.data = [].concat(data).concat(this.options.data);
        } else {
            this.options.data = this.data;
        }

        if (this.options.sidePagination === 'server') {
            return;
        }
        this.initSort();
    };

    BootstrapTable.prototype.initSort = function () {
        var that = this,
            name = this.options.sortName,
            order = this.options.sortOrder === 'desc' ? -1 : 1,
            index = $.inArray(this.options.sortName, this.header.fields);

        if (index !== -1) {
            this.data.sort(function (a, b) {
                if (that.header.sortNames[index]) {
                    name = that.header.sortNames[index];
                }
                var aa = getItemField(a, name, that.options.escape),
                    bb = getItemField(b, name, that.options.escape),
                    value = calculateObjectValue(that.header, that.header.sorters[index], [aa, bb]);

                if (value !== undefined) {
                    return order * value;
                }

                // Fix #161: undefined or null string sort bug.
                if (aa === undefined || aa === null) {
                    aa = '';
                }
                if (bb === undefined || bb === null) {
                    bb = '';
                }

                // IF both values are numeric, do a numeric comparison
                if ($.isNumeric(aa) && $.isNumeric(bb)) {
                    // Convert numerical values form string to float.
                    aa = parseFloat(aa);
                    bb = parseFloat(bb);
                    if (aa < bb) {
                        return order * -1;
                    }
                    return order;
                }

                if (aa === bb) {
                    return 0;
                }

                // If value is not a string, convert to string
                if (typeof aa !== 'string') {
                    aa = aa.toString();
                }

                if (aa.localeCompare(bb) === -1) {
                    return order * -1;
                }

                return order;
            });
        }
    };

    BootstrapTable.prototype.onSort = function (event) {
        var $this = event.type === "keypress" ? $(event.currentTarget) : $(event.currentTarget).parent(),
            $this_ = this.$header.find('th').eq($this.index());

        this.$header.add(this.$header_).find('span.order').remove();

        if (this.options.sortName === $this.data('field')) {
            this.options.sortOrder = this.options.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            this.options.sortName = $this.data('field');
            this.options.sortOrder = $this.data('order') === 'asc' ? 'desc' : 'asc';
        }
        this.trigger('sort', this.options.sortName, this.options.sortOrder);

        $this.add($this_).data('order', this.options.sortOrder);

        // Assign the correct sortable arrow
        this.getCaret();

        if (this.options.sidePagination === 'server') {
            this.initServer(this.options.silentSort);
            return;
        }

        this.initSort();
        this.initBody();
    };

    BootstrapTable.prototype.initToolbar = function () {
        var that = this,
            html = [],
            timeoutId = 0,
            $keepOpen,
            $search,
            switchableCount = 0;

        if (this.$toolbar.find('.bars').children().length) {
            $('body').append($(this.options.toolbar));
        }
        this.$toolbar.html('');

        if (typeof this.options.toolbar === 'string' || typeof this.options.toolbar === 'object') {
            $(sprintf('<div class="bars pull-%s"></div>', this.options.toolbarAlign))
                .appendTo(this.$toolbar)
                .append($(this.options.toolbar));
        }

        // showColumns, showToggle, showRefresh
        html = [sprintf('<div class="columns columns-%s btn-group pull-%s">',
            this.options.buttonsAlign, this.options.buttonsAlign)];

        if (typeof this.options.icons === 'string') {
            this.options.icons = calculateObjectValue(null, this.options.icons);
        }

        if (this.options.showPaginationSwitch) {
            html.push(sprintf('<button class="btn btn-default" type="button" name="paginationSwitch" title="%s">',
                this.options.formatPaginationSwitch()),
                sprintf('<i class="%s %s"></i>', this.options.iconsPrefix, this.options.icons.paginationSwitchDown),
                '</button>');
        }

        if (this.options.showRefresh) {
            html.push(sprintf('<button class="btn btn-default' +
                sprintf(' btn-%s', this.options.iconSize) +
                '" type="button" name="refresh" title="%s">',
                this.options.formatRefresh()),
                sprintf('<i class="%s %s"></i>', this.options.iconsPrefix, this.options.icons.refresh),
                '</button>');
        }

        if (this.options.showToggle) {
            html.push(sprintf('<button class="btn btn-default' +
                sprintf(' btn-%s', this.options.iconSize) +
                '" type="button" name="toggle" title="%s">',
                this.options.formatToggle()),
                sprintf('<i class="%s %s"></i>', this.options.iconsPrefix, this.options.icons.toggle),
                '</button>');
        }

        if (this.options.showColumns) {
            html.push(sprintf('<div class="keep-open btn-group" title="%s">',
                this.options.formatColumns()),
                '<button type="button" class="btn btn-default' +
                sprintf(' btn-%s', this.options.iconSize) +
                ' dropdown-toggle" data-toggle="dropdown">',
                sprintf('<i class="%s %s"></i>', this.options.iconsPrefix, this.options.icons.columns),
                ' <span class="caret"></span>',
                '</button>',
                '<ul class="dropdown-menu" role="menu">');

            $.each(this.columns, function (i, column) {
                if (column.radio || column.checkbox) {
                    return;
                }

                if (that.options.cardView && (!column.cardVisible)) {
                    return;
                }

                var checked = column.visible ? ' checked="checked"' : '';

                if (column.switchable) {
                    html.push(sprintf('<li>' +
                        '<label><input type="checkbox" data-field="%s" value="%s"%s> %s</label>' +
                        '</li>', column.field, i, checked, column.title));
                    switchableCount++;
                }
            });
            html.push('</ul>',
                '</div>');
        }

        html.push('</div>');

        // Fix #188: this.showToolbar is for extensions
        if (this.showToolbar || html.length > 2) {
            this.$toolbar.append(html.join(''));
        }

        if (this.options.showPaginationSwitch) {
            this.$toolbar.find('button[name="paginationSwitch"]')
                .off('click').on('click', $.proxy(this.togglePagination, this));
        }

        if (this.options.showRefresh) {
            this.$toolbar.find('button[name="refresh"]')
                .off('click').on('click', $.proxy(this.refresh, this));
        }

        if (this.options.showToggle) {
            this.$toolbar.find('button[name="toggle"]')
                .off('click').on('click', function () {
                    that.toggleView();
                });
        }

        if (this.options.showColumns) {
            $keepOpen = this.$toolbar.find('.keep-open');

            if (switchableCount <= this.options.minimumCountColumns) {
                $keepOpen.find('input').prop('disabled', true);
            }

            $keepOpen.find('li').off('click').on('click', function (event) {
                event.stopImmediatePropagation();
            });
            $keepOpen.find('input').off('click').on('click', function () {
                var $this = $(this);

                that.toggleColumn(getFieldIndex(that.columns,
                    $(this).data('field')), $this.prop('checked'), false);
                that.trigger('column-switch', $(this).data('field'), $this.prop('checked'));
            });
        }

        if (this.options.search) {
            html = [];
            html.push(
                '<div class="pull-' + this.options.searchAlign + ' search">',
                sprintf('<input class="form-control' +
                    sprintf(' input-%s', this.options.iconSize) +
                    '" type="text" placeholder="%s">',
                    this.options.formatSearch()),
                '</div>');

            this.$toolbar.append(html.join(''));
            $search = this.$toolbar.find('.search input');
            $search.off('keyup drop').on('keyup drop', function (event) {
                if (that.options.searchOnEnterKey) {
                    if (event.keyCode !== 13) {
                        return;
                    }
                }

                clearTimeout(timeoutId); // doesn't matter if it's 0
                timeoutId = setTimeout(function () {
                    that.onSearch(event);
                }, that.options.searchTimeOut);
            });

            if (isIEBrowser()) {
                $search.off('mouseup').on('mouseup', function (event) {
                    clearTimeout(timeoutId); // doesn't matter if it's 0
                    timeoutId = setTimeout(function () {
                        that.onSearch(event);
                    }, that.options.searchTimeOut);
                });
            }
        }
    };

    BootstrapTable.prototype.onSearch = function (event) {
        var text = $.trim($(event.currentTarget).val());

        // trim search input
        if (this.options.trimOnSearch && $(event.currentTarget).val() !== text) {
            $(event.currentTarget).val(text);
        }

        if (text === this.searchText) {
            return;
        }
        this.searchText = text;
        this.options.searchText = text;

        this.options.pageNumber = 1;
        this.initSearch();
        this.updatePagination();
        this.trigger('search', text);
    };

    BootstrapTable.prototype.initSearch = function () {
        var that = this;

        if (this.options.sidePagination !== 'server') {
            var s = this.searchText && this.searchText.toLowerCase();
            var f = $.isEmptyObject(this.filterColumns) ? null : this.filterColumns;

            // Check filter
            this.data = f ? $.grep(this.options.data, function (item, i) {
                for (var key in f) {
                    if ($.isArray(f[key])) {
                        if ($.inArray(item[key], f[key]) === -1) {
                            return false;
                        }
                    } else if (item[key] !== f[key]) {
                        return false;
                    }
                }
                return true;
            }) : this.options.data;

            this.data = s ? $.grep(this.data, function (item, i) {
                for (var key in item) {
                    key = $.isNumeric(key) ? parseInt(key, 10) : key;
                    var value = item[key],
                        column = that.columns[getFieldIndex(that.columns, key)],
                        j = $.inArray(key, that.header.fields);

                    // Fix #142: search use formatted data
                    if (column && column.searchFormatter) {
                        value = calculateObjectValue(column,
                            that.header.formatters[j], [value, item, i], value);
                    }

                    var index = $.inArray(key, that.header.fields);
                    if (index !== -1 && that.header.searchables[index] && (typeof value === 'string' || typeof value === 'number')) {
                        if (that.options.strictSearch) {
                            if ((value + '').toLowerCase() === s) {
                                return true;
                            }
                        } else {
                            if ((value + '').toLowerCase().indexOf(s) !== -1) {
                                return true;
                            }
                        }
                    }
                }
                return false;
            }) : this.data;
        }
    };

    BootstrapTable.prototype.initPagination = function () {
        if (!this.options.pagination) {
            this.$pagination.hide();
            return;
        } else {
            this.$pagination.show();
        }

        var that = this,
            html = [],
            $allSelected = false,
            i, from, to,
            $pageList,
            $first, $pre,
            $next, $last,
            $number,
            data = this.getData();

        if (this.options.sidePagination !== 'server') {
            this.options.totalRows = data.length;
        }

        this.totalPages = 0;
        if (this.options.totalRows) {
            if (this.options.pageSize === this.options.formatAllRows()) {
                this.options.pageSize = this.options.totalRows;
                $allSelected = true;
            } else if (this.options.pageSize === this.options.totalRows) {
                // Fix #667 Table with pagination,
                // multiple pages and a search that matches to one page throws exception
                var pageLst = typeof this.options.pageList === 'string' ?
                    this.options.pageList.replace('[', '').replace(']', '')
                        .replace(/ /g, '').toLowerCase().split(',') : this.options.pageList;
                if ($.inArray(this.options.formatAllRows().toLowerCase(), pageLst) > -1) {
                    $allSelected = true;
                }
            }

            this.totalPages = ~~((this.options.totalRows - 1) / this.options.pageSize) + 1;

            this.options.totalPages = this.totalPages;
        }
        if (this.totalPages > 0 && this.options.pageNumber > this.totalPages) {
            this.options.pageNumber = this.totalPages;
        }

        this.pageFrom = (this.options.pageNumber - 1) * this.options.pageSize + 1;
        this.pageTo = this.options.pageNumber * this.options.pageSize;
        if (this.pageTo > this.options.totalRows) {
            this.pageTo = this.options.totalRows;
        }

        html.push(
            '<div class="pull-' + this.options.paginationDetailHAlign + ' pagination-detail">',
            '<span class="pagination-info">',
            this.options.onlyInfoPagination ? this.options.formatDetailPagination(this.options.totalRows) :
                this.options.formatShowingRows(this.pageFrom, this.pageTo, this.options.totalRows),
            '</span>');

        if (!this.options.onlyInfoPagination) {
            html.push('<span class="page-list">');

            var pageNumber = [
                sprintf('<span class="btn-group %s">',
                    this.options.paginationVAlign === 'top' || this.options.paginationVAlign === 'both' ?
                        'dropdown' : 'dropup'),
                '<button type="button" class="btn btn-default ' +
                sprintf(' btn-%s', this.options.iconSize) +
                ' dropdown-toggle" data-toggle="dropdown">',
                '<span class="page-size">',
                $allSelected ? this.options.formatAllRows() : this.options.pageSize,
                '</span>',
                ' <span class="caret"></span>',
                '</button>',
                '<ul class="dropdown-menu" role="menu">'
            ],
                pageList = this.options.pageList;

            if (typeof this.options.pageList === 'string') {
                var list = this.options.pageList.replace('[', '').replace(']', '')
                    .replace(/ /g, '').split(',');

                pageList = [];
                $.each(list, function (i, value) {
                    pageList.push(value.toUpperCase() === that.options.formatAllRows().toUpperCase() ?
                        that.options.formatAllRows() : +value);
                });
            }

            $.each(pageList, function (i, page) {
                if (!that.options.smartDisplay || i === 0 || pageList[i - 1] <= that.options.totalRows) {
                    var active;
                    if ($allSelected) {
                        active = page === that.options.formatAllRows() ? ' class="active"' : '';
                    } else {
                        active = page === that.options.pageSize ? ' class="active"' : '';
                    }
                    pageNumber.push(sprintf('<li%s><a href="javascript:void(0)">%s</a></li>', active, page));
                }
            });
            pageNumber.push('</ul></span>');

            html.push(this.options.formatRecordsPerPage(pageNumber.join('')));
            html.push('</span>');

            html.push('</div>',
                '<div class="pull-' + this.options.paginationHAlign + ' pagination">',
                '<ul class="pagination' + sprintf(' pagination-%s', this.options.iconSize) + '">',
                '<li class="page-pre"><a href="javascript:void(0)">' + this.options.paginationPreText + '</a></li>');

            if (this.totalPages < 5) {
                from = 1;
                to = this.totalPages;
            } else {
                from = this.options.pageNumber - 2;
                to = from + 4;
                if (from < 1) {
                    from = 1;
                    to = 5;
                }
                if (to > this.totalPages) {
                    to = this.totalPages;
                    from = to - 4;
                }
            }

            if (this.totalPages >= 6) {
                if (this.options.pageNumber >= 3) {
                    html.push('<li class="page-first' + (1 === this.options.pageNumber ? ' active' : '') + '">',
                        '<a href="javascript:void(0)">', 1, '</a>',
                        '</li>');

                    from++;
                }

                if (this.options.pageNumber >= 4) {
                    if (this.options.pageNumber == 4 || this.totalPages == 6 || this.totalPages == 7) {
                        from--;
                    } else {
                        html.push('<li class="page-first-separator disabled">',
                            '<a href="javascript:void(0)">...</a>',
                            '</li>');
                    }

                    to--;
                }
            }

            if (this.totalPages >= 7) {
                if (this.options.pageNumber >= (this.totalPages - 2)) {
                    from--;
                }
            }

            if (this.totalPages == 6) {
                if (this.options.pageNumber >= (this.totalPages - 2)) {
                    to++;
                }
            } else if (this.totalPages >= 7) {
                if (this.totalPages == 7 || this.options.pageNumber >= (this.totalPages - 3)) {
                    to++;
                }
            }

            for (i = from; i <= to; i++) {
                html.push('<li class="page-number' + (i === this.options.pageNumber ? ' active' : '') + '">',
                    '<a href="javascript:void(0)">', i, '</a>',
                    '</li>');
            }

            if (this.totalPages >= 8) {
                if (this.options.pageNumber <= (this.totalPages - 4)) {
                    html.push('<li class="page-last-separator disabled">',
                        '<a href="javascript:void(0)">...</a>',
                        '</li>');
                }
            }

            if (this.totalPages >= 6) {
                if (this.options.pageNumber <= (this.totalPages - 3)) {
                    html.push('<li class="page-last' + (this.totalPages === this.options.pageNumber ? ' active' : '') + '">',
                        '<a href="javascript:void(0)">', this.totalPages, '</a>',
                        '</li>');
                }
            }

            html.push(
                '<li class="page-next"><a href="javascript:void(0)">' + this.options.paginationNextText + '</a></li>',
                '</ul>',
                '</div>');
        }
        this.$pagination.html(html.join(''));

        if (!this.options.onlyInfoPagination) {
            $pageList = this.$pagination.find('.page-list a');
            $first = this.$pagination.find('.page-first');
            $pre = this.$pagination.find('.page-pre');
            $next = this.$pagination.find('.page-next');
            $last = this.$pagination.find('.page-last');
            $number = this.$pagination.find('.page-number');

            if (this.options.smartDisplay) {
                if (this.totalPages <= 1) {
                    this.$pagination.find('div.pagination').hide();
                }
                if (pageList.length < 2 || this.options.totalRows <= pageList[0]) {
                    this.$pagination.find('span.page-list').hide();
                }

                // when data is empty, hide the pagination
                this.$pagination[this.getData().length ? 'show' : 'hide']();
            }
            if ($allSelected) {
                this.options.pageSize = this.options.formatAllRows();
            }
            $pageList.off('click').on('click', $.proxy(this.onPageListChange, this));
            $first.off('click').on('click', $.proxy(this.onPageFirst, this));
            $pre.off('click').on('click', $.proxy(this.onPagePre, this));
            $next.off('click').on('click', $.proxy(this.onPageNext, this));
            $last.off('click').on('click', $.proxy(this.onPageLast, this));
            $number.off('click').on('click', $.proxy(this.onPageNumber, this));
        }
    };

    BootstrapTable.prototype.updatePagination = function (event) {
        // Fix #171: IE disabled button can be clicked bug.
        if (event && $(event.currentTarget).hasClass('disabled')) {
            return;
        }

        if (!this.options.maintainSelected) {
            this.resetRows();
        }

        this.initPagination();
        if (this.options.sidePagination === 'server') {
            this.initServer();
        } else {
            this.initBody();
        }

        this.trigger('page-change', this.options.pageNumber, this.options.pageSize);
    };

    BootstrapTable.prototype.onPageListChange = function (event) {
        var $this = $(event.currentTarget);

        $this.parent().addClass('active').siblings().removeClass('active');
        this.options.pageSize = $this.text().toUpperCase() === this.options.formatAllRows().toUpperCase() ?
            this.options.formatAllRows() : +$this.text();
        this.$toolbar.find('.page-size').text(this.options.pageSize);

        this.updatePagination(event);
    };

    BootstrapTable.prototype.onPageFirst = function (event) {
        this.options.pageNumber = 1;
        this.updatePagination(event);
    };

    BootstrapTable.prototype.onPagePre = function (event) {
        if ((this.options.pageNumber - 1) == 0) {
            this.options.pageNumber = this.options.totalPages;
        } else {
            this.options.pageNumber--;
        }
        this.updatePagination(event);
    };

    BootstrapTable.prototype.onPageNext = function (event) {
        if ((this.options.pageNumber + 1) > this.options.totalPages) {
            this.options.pageNumber = 1;
        } else {
            this.options.pageNumber++;
        }
        this.updatePagination(event);
    };

    BootstrapTable.prototype.onPageLast = function (event) {
        this.options.pageNumber = this.totalPages;
        this.updatePagination(event);
    };

    BootstrapTable.prototype.onPageNumber = function (event) {
        if (this.options.pageNumber === +$(event.currentTarget).text()) {
            return;
        }
        this.options.pageNumber = +$(event.currentTarget).text();
        this.updatePagination(event);
    };

    BootstrapTable.prototype.initBody = function (fixedScroll) {
        var that = this,
            html = [],
            data = this.getData();

        this.trigger('pre-body', data);

        this.$body = this.$el.find('>tbody');
        if (!this.$body.length) {
            this.$body = $('<tbody></tbody>').appendTo(this.$el);
        }

        //Fix #389 Bootstrap-table-flatJSON is not working

        if (!this.options.pagination || this.options.sidePagination === 'server') {
            this.pageFrom = 1;
            this.pageTo = data.length;
        }

        for (var i = this.pageFrom - 1; i < this.pageTo; i++) {
            var key,
                item = data[i],
                style = {},
                csses = [],
                data_ = '',
                attributes = {},
                htmlAttributes = [];

            style = calculateObjectValue(this.options, this.options.rowStyle, [item, i], style);

            if (style && style.css) {
                for (key in style.css) {
                    csses.push(key + ': ' + style.css[key]);
                }
            }

            attributes = calculateObjectValue(this.options,
                this.options.rowAttributes, [item, i], attributes);

            if (attributes) {
                for (key in attributes) {
                    htmlAttributes.push(sprintf('%s="%s"', key, escapeHTML(attributes[key])));
                }
            }

            if (item._data && !$.isEmptyObject(item._data)) {
                $.each(item._data, function (k, v) {
                    // ignore data-index
                    if (k === 'index') {
                        return;
                    }
                    data_ += sprintf(' data-%s="%s"', k, v);
                });
            }

            html.push('<tr',
                sprintf(' %s', htmlAttributes.join(' ')),
                sprintf(' id="%s"', $.isArray(item) ? undefined : item._id),
                sprintf(' class="%s"', style.classes || ($.isArray(item) ? undefined : item._class)),
                sprintf(' data-index="%s"', i),
                sprintf(' data-uniqueid="%s"', item[this.options.uniqueId]),
                sprintf('%s', data_),
                '>'
            );

            if (this.options.cardView) {
                html.push(sprintf('<td colspan="%s">', this.header.fields.length));
            }

            if (!this.options.cardView && this.options.detailView) {
                html.push('<td>',
                    '<a class="detail-icon" href="javascript:">',
                    sprintf('<i class="%s %s"></i>', this.options.iconsPrefix, this.options.icons.detailOpen),
                    '</a>',
                    '</td>');
            }

            $.each(this.header.fields, function (j, field) {
                var text = '',
                    value = getItemField(item, field, that.options.escape),
                    type = '',
                    cellStyle = {},
                    id_ = '',
                    class_ = that.header.classes[j],
                    data_ = '',
                    rowspan_ = '',
                    title_ = '',
                    column = that.columns[getFieldIndex(that.columns, field)];

                if (!column || !column.visible) {
                    return;
                }

                style = sprintf('style="%s"', csses.concat(that.header.styles[j]).join('; '));

                value = calculateObjectValue(column,
                    that.header.formatters[j], [value, item, i], value);

                // handle td's id and class
                if (item['_' + field + '_id']) {
                    id_ = sprintf(' id="%s"', item['_' + field + '_id']);
                }
                if (item['_' + field + '_class']) {
                    class_ = sprintf(' class="%s"', item['_' + field + '_class']);
                }
                if (item['_' + field + '_rowspan']) {
                    rowspan_ = sprintf(' rowspan="%s"', item['_' + field + '_rowspan']);
                }
                if (item['_' + field + '_title']) {
                    title_ = sprintf(' title="%s"', item['_' + field + '_title']);
                }
                cellStyle = calculateObjectValue(that.header,
                    that.header.cellStyles[j], [value, item, i], cellStyle);
                if (cellStyle.classes) {
                    class_ = sprintf(' class="%s"', cellStyle.classes);
                }
                if (cellStyle.css) {
                    var csses_ = [];
                    for (var key in cellStyle.css) {
                        csses_.push(key + ': ' + cellStyle.css[key]);
                    }
                    style = sprintf('style="%s"', csses_.concat(that.header.styles[j]).join('; '));
                }

                if (item['_' + field + '_data'] && !$.isEmptyObject(item['_' + field + '_data'])) {
                    $.each(item['_' + field + '_data'], function (k, v) {
                        // ignore data-index
                        if (k === 'index') {
                            return;
                        }
                        data_ += sprintf(' data-%s="%s"', k, v);
                    });
                }

                if (column.checkbox || column.radio) {
                    type = column.checkbox ? 'checkbox' : type;
                    type = column.radio ? 'radio' : type;
                    var GID = $.IGuid();
                    text = [sprintf(that.options.cardView ?
                        '<div class="card-view %s">' : '<td class="bs-checkbox %s">', column['class'] || ''),
                    '<input id="' + GID + '" style="display:none;"' +
                    sprintf(' data-index="%s"', i) +
                    sprintf(' name="%s"', that.options.selectItemName) +
                    sprintf(' type="%s"', type) +
                    sprintf(' value="%s"', item[that.options.idField]) +
                    sprintf(' checked="%s"', value === true ||
                        (value && value.checked) ? 'checked' : undefined) +
                    sprintf(' disabled="%s"', !column.checkboxEnabled ||
                        (value && value.disabled) ? 'disabled' : undefined) +
                    ' /><label for="' + GID + '"></label>',
                    that.header.formatters[j] && typeof value === 'string' ? value : '',
                    that.options.cardView ? '</div>' : '</td>'
                    ].join('');

                    item[that.header.stateField] = value === true || (value && value.checked);
                } else {
                    value = typeof value === 'undefined' || value === null ?
                        that.options.undefinedText : value;
                    // 处理附件、关联表单等取值问题
                    if (Array.isArray(value) || ['图片', '附件'].indexOf(column.title) !== -1) {                      // 
                        let pre = value
                        try {
                            value = JSON.parse(value);
                        } catch (e) {
                            value = pre
                        }
                        pre = null
                        let texts = [];
                        try{
                            if((value instanceof Array )|| (value instanceof Object)){
                                value.forEach(item => {
                                    if (item.Name || item.DisplayName) {
                                        texts.push(item.Name || item.DisplayName);
                                    }
                                })
                            }
                            
                        }
                        catch(e){
                            console.log(value);
                            console.log(e);
                            
                        }
                       
                        value = texts.join(',');
                    }
                    text = that.options.cardView ? ['<div class="card-view">',
                        that.options.showHeader ? sprintf('<span class="title" %s>%s</span>', style,
                            getPropertyFromOther(that.columns, 'field', 'title', field)) : '',
                        sprintf('<span class="value">%s</span>', value),
                        '</div>'
                    ].join('') : [sprintf('<td%s %s %s %s %s %s>', id_, class_, style, data_, rowspan_, title_),
                        value,
                        '</td>'
                    ].join('');

                    // Hide empty data on Card view when smartDisplay is set to true.
                    if (that.options.cardView && that.options.smartDisplay && value === '') {
                        // Should set a placeholder for event binding correct fieldIndex
                        text = '<div class="card-view"></div>';
                    }
                }

                html.push(text);
            });

            if (this.options.cardView) {
                html.push('</td>');
            }

            html.push('</tr>');
        }

        // show no records
        if (!html.length) {
            html.push('<tr class="no-records-found table-nodata">',
                sprintf('<td colspan="%s">%s</td>',
                    this.$header.find('th').length, this.options.formatNoMatches()),
                '</tr>');
        }

        this.$body.html(html.join(''));

        if (!fixedScroll) {
            this.scrollTo(0);
        }

        // click to select by column
        this.$body.find('> tr[data-index] > td').off('click dblclick').on('click dblclick', function (e) {
            var $td = $(this),
                $tr = $td.parent(),
                item = that.data[$tr.data('index')],
                index = $td[0].cellIndex,
                field = that.header.fields[that.options.detailView && !that.options.cardView ? index - 1 : index],
                column = that.columns[getFieldIndex(that.columns, field)],
                value = getItemField(item, field, that.options.escape);

            if ($td.find('.detail-icon').length) {
                return;
            }

            that.trigger(e.type === 'click' ? 'click-cell' : 'dbl-click-cell', field, value, item, $td);
            that.trigger(e.type === 'click' ? 'click-row' : 'dbl-click-row', item, $tr);

            // if click to select - then trigger the checkbox/radio click
            if (e.type === 'click' && that.options.clickToSelect && column.clickToSelect) {
                var $selectItem = $tr.find(sprintf('[name="%s"]', that.options.selectItemName));
                if ($selectItem.length) {
                    $selectItem[0].click(); // #144: .trigger('click') bug
                }
            }
        });

        this.$body.find('> tr[data-index] > td > .detail-icon').off('click').on('click', function () {
            var $this = $(this),
                $tr = $this.parent().parent(),
                index = $tr.data('index'),
                row = data[index]; // Fix #980 Detail view, when searching, returns wrong row

            // remove and update
            if ($tr.next().is('tr.detail-view')) {
                $this.find('i').attr('class', sprintf('%s %s', that.options.iconsPrefix, that.options.icons.detailOpen));
                $tr.next().remove();
                that.trigger('collapse-row', index, row);
            } else {
                $this.find('i').attr('class', sprintf('%s %s', that.options.iconsPrefix, that.options.icons.detailClose));
                $tr.after(sprintf('<tr class="detail-view"><td colspan="%s"></td></tr>', $tr.find('td').length));
                var $element = $tr.next().find('td');
                var content = calculateObjectValue(that.options, that.options.detailFormatter, [index, row, $element], '');
                if ($element.length === 1) {
                    $element.append(content);
                }
                that.trigger('expand-row', index, row, $element);
            }
            that.resetView();
        });

        this.$selectItem = this.$body.find(sprintf('[name="%s"]', this.options.selectItemName));
        this.$selectItem.off('click').on('click', function (event) {
            event.stopImmediatePropagation();

            var $this = $(this),
                checked = $this.prop('checked'),
                row = that.data[$this.data('index')];

            if (that.options.maintainSelected && $(this).is(':radio')) {
                $.each(that.options.data, function (i, row) {
                    row[that.header.stateField] = false;
                });
            }

            row[that.header.stateField] = checked;

            if (that.options.singleSelect) {
                that.$selectItem.not(this).each(function () {
                    that.data[$(this).data('index')][that.header.stateField] = false;
                });
                that.$selectItem.filter(':checked').not(this).prop('checked', false);
            }

            that.updateSelected();
            that.trigger(checked ? 'check' : 'uncheck', row, $this);
        });

        $.each(this.header.events, function (i, events) {
            if (!events) {
                return;
            }
            // fix bug, if events is defined with namespace
            if (typeof events === 'string') {
                events = calculateObjectValue(null, events);
            }

            var field = that.header.fields[i],
                fieldIndex = $.inArray(field, that.getVisibleFields());

            if (that.options.detailView && !that.options.cardView) {
                fieldIndex += 1;
            }

            for (var key in events) {
                that.$body.find('>tr:not(.no-records-found)').each(function () {
                    var $tr = $(this),
                        $td = $tr.find(that.options.cardView ? '.card-view' : 'td').eq(fieldIndex),
                        index = key.indexOf(' '),
                        name = key.substring(0, index),
                        el = key.substring(index + 1),
                        func = events[key];

                    $td.find(el).off(name).on(name, function (e) {
                        var index = $tr.data('index'),
                            row = that.data[index],
                            value = row[field];

                        func.apply(this, [e, value, row, index]);
                    });
                });
            }
        });

        this.updateSelected();
        this.resetView();

        this.trigger('post-body');
    };

    BootstrapTable.prototype.initServer = function (silent, query) {
        var that = this,
            data = {},
            params = {
                searchText: this.searchText,
                sortName: this.options.sortName,
                sortOrder: this.options.sortOrder
            },
            request;

        if (this.options.pagination) {
            params.pageSize = this.options.pageSize === this.options.formatAllRows() ?
                this.options.totalRows : this.options.pageSize;
            params.pageNumber = this.options.pageNumber;
        }

        if (!this.options.url && !this.options.ajax) {
            return;
        }

        if (this.options.queryParamsType === 'limit') {
            params = {
                search: params.searchText,
                sort: params.sortName,
                order: params.sortOrder
            };
            if (this.options.pagination) {
                params.limit = this.options.pageSize === this.options.formatAllRows() ?
                    this.options.totalRows : this.options.pageSize;
                params.offset = this.options.pageSize === this.options.formatAllRows() ?
                    0 : this.options.pageSize * (this.options.pageNumber - 1);
            }
        }

        if (!($.isEmptyObject(this.filterColumnsPartial))) {
            params['filter'] = JSON.stringify(this.filterColumnsPartial, null);
        }

        data = calculateObjectValue(this.options, this.options.queryParams, [params], data);
        data.pageNum = this.options.pageNumber;
        $.extend(data, query || {});

        // false to stop request
        if (data === false) {
            return;
        }

        if (!silent) {
            this.$tableLoading.show();
        }
        request = $.extend({}, calculateObjectValue(null, this.options.ajaxOptions), {
            type: this.options.method,
            url: this.options.url,
            data: this.options.contentType === 'application/json' && this.options.method === 'post' ?
                JSON.stringify(data) : data,
            cache: this.options.cache,
            contentType: this.options.contentType,
            dataType: this.options.dataType,
            success: function (res) {
                if (res.code != 0 && res.Code != 0) {
                    //$.IShowError({ title: "", msg: "", detail: res.ErrorMessage });
                    Message.error(res.Msg);
                    return;
                }
                var handle = function (response) {
                    response = calculateObjectValue(that.options, that.options.responseHandler, [response], response);
                    if (!(response.rows && response.total)) {
                        for (var i = 0; i < res.Result.ReturnData.length; i++) {
                            var temp = res.Result.ReturnData[i]
                            for (var index in temp) {
                                if (index.indexOf('Name') > 0 && index != 'Name') {
                                    var n = index.split("_");
                                    temp[n[0]] = temp[index]
                                }
                            }
                        }
                        response.rows = res.Result.ReturnData;
                        response.total = res.Result.Count;
                    }
                    that.load(response);
                    that.trigger('load-success', response);
                    if (!silent) that.$tableLoading.hide();
                };
                //Debugging = 0,
                //Exceptional = 1,
                //Finished = 2
                if (res.ReturnData && res.ReturnData.Response != null && res.ReturnData.Response.DebugTrack != null && res.ReturnData.Response.DebugTrack.DebugState == 0) {
                    top.$.IPushDebugTrack(res.ReturnData.Response, that, handle);
                }
                else {
                    if (res.ReturnData && res.ReturnData.Response) {
                        handle(res.ReturnData.Response);
                    } else if (res.Result) {
                        handle(res);
                    } else {
                        handle(res.ReturnData);
                    }
                }
            },
            error: function (res) {
                that.trigger('load-error', res.status, res);
                if (!silent) that.$tableLoading.hide();
            }
        });

        if (this.options.ajax) {
            calculateObjectValue(this, this.options.ajax, [request], null);
        } else {
            $.ajax(request);
        }
    };

    BootstrapTable.prototype.initSearchText = function () {
        if (this.options.search) {
            if (this.options.searchText !== '') {
                var $search = this.$toolbar.find('.search input');
                $search.val(this.options.searchText);
                this.onSearch({ currentTarget: $search });
            }
        }
    };

    BootstrapTable.prototype.getCaret = function () {
        var that = this;

        $.each(this.$header.find('th'), function (i, th) {
            $(th).find('.sortable').removeClass('desc asc').addClass($(th).data('field') === that.options.sortName ? that.options.sortOrder : 'both');
        });
    };

    BootstrapTable.prototype.updateSelected = function () {
        var checkAll = this.$selectItem.filter(':enabled').length &&
            this.$selectItem.filter(':enabled').length ===
            this.$selectItem.filter(':enabled').filter(':checked').length;

        this.$selectAll.add(this.$selectAll_).prop('checked', checkAll);

        this.$selectItem.each(function () {
            $(this).closest('tr')[$(this).prop('checked') ? 'addClass' : 'removeClass']('selected');
        });
    };

    BootstrapTable.prototype.updateRows = function () {
        var that = this;

        this.$selectItem.each(function () {
            that.data[$(this).data('index')][that.header.stateField] = $(this).prop('checked');
        });
    };

    BootstrapTable.prototype.resetRows = function () {
        var that = this;

        $.each(this.data, function (i, row) {
            that.$selectAll.prop('checked', false);
            that.$selectItem.prop('checked', false);
            if (that.header.stateField) {
                row[that.header.stateField] = false;
            }
        });
    };

    BootstrapTable.prototype.trigger = function (name) {
        var args = Array.prototype.slice.call(arguments, 1);

        name += '.bs.table';
        this.options[BootstrapTable.EVENTS[name]].apply(this.options, args);
        this.$el.trigger($.Event(name), args);

        this.options.onAll(name, args);
        this.$el.trigger($.Event('all.bs.table'), [name, args]);
    };

    BootstrapTable.prototype.resetHeader = function () {
        // fix #61: the hidden table reset header bug.
        // fix bug: get $el.css('width') error sometime (height = 500)
        clearTimeout(this.timeoutId_);
        this.timeoutId_ = setTimeout($.proxy(this.fitHeader, this), this.$el.is(':hidden') ? 100 : 0);
    };

    BootstrapTable.prototype.fitHeader = function () {
        var that = this,
            fixedBody,
            scrollWidth,
            focused,
            focusedTemp;

        if (that.$el.is(':hidden')) {
            that.timeoutId_ = setTimeout($.proxy(that.fitHeader, that), 100);
            return;
        }
        fixedBody = this.$tableBody.get(0);

        scrollWidth = fixedBody.scrollWidth > fixedBody.clientWidth &&
            fixedBody.scrollHeight > fixedBody.clientHeight + this.$header.outerHeight() ?
            getScrollBarWidth() : 0;

        this.$el.css('margin-top', -this.$header.outerHeight());

        focused = $(':focus');
        if (focused.length > 0) {
            var $th = focused.parents('th');
            if ($th.length > 0) {
                var dataField = $th.attr('data-field');
                if (dataField !== undefined) {
                    var $headerTh = this.$header.find("[data-field='" + dataField + "']");
                    if ($headerTh.length > 0) {
                        $headerTh.find(":input").addClass("focus-temp");
                    }
                }
            }
        }

        this.$header_ = this.$header.clone(true, true);

        //��������ӱ��ȫѡ��Ч��clone�������������⣩
        this.$selectAll_ = this.$header_.find('[name="btSelectAll"]');
        this.$selectAll_.off('click').on('click', function () {
            var checked = $(this).prop('checked');
            that[checked ? 'checkAll' : 'uncheckAll']();
            that.updateSelected();
        });

        this.$tableHeader.css({
            'margin-right': scrollWidth
        }).find('table').css('width', this.$el.outerWidth())
            .html('').attr('class', this.$el.attr('class'))
            .append(this.$header_);


        focusedTemp = $('.focus-temp:visible:eq(0)');
        if (focusedTemp.length > 0) {
            focusedTemp.focus();
            this.$header.find('.focus-temp').removeClass('focus-temp');
        }

        // fix bug: $.data() is not working as expected after $.append()
        this.$header.find('th[data-field]').each(function (i) {
            that.$header_.find(sprintf('th[data-field="%s"]', $(this).data('field'))).data($(this).data());
        });

        var visibleFields = this.getVisibleFields();

        this.$body.find('>tr:first-child:not(.no-records-found) > *').each(function (i) {
            var $this = $(this),
                index = i;

            if (that.options.detailView && !that.options.cardView) {
                if (i === 0) {
                    that.$header_.find('th.detail').find('.fht-cell').width($this.innerWidth());
                }
                index = i - 1;
            }

            that.$header_.find(sprintf('th[data-field="%s"]', visibleFields[index]))
                .find('.fht-cell').width($this.innerWidth());
        });
        // horizontal scroll event
        // TODO: it's probably better improving the layout than binding to scroll event
        this.$tableBody.off('scroll').on('scroll', function () {
            that.$tableHeader.scrollLeft($(this).scrollLeft());

            if (that.options.showFooter && !that.options.cardView) {
                that.$tableFooter.scrollLeft($(this).scrollLeft());
            }
        });
        that.trigger('post-header');
    };

    BootstrapTable.prototype.resetFooter = function () {
        var that = this,
            data = that.getData(),
            html = [];

        if (!this.options.showFooter || this.options.cardView) { //do nothing
            return;
        }

        if (!this.options.cardView && this.options.detailView) {
            html.push('<td><div class="th-inner">&nbsp;</div><div class="fht-cell"></div></td>');
        }

        $.each(this.columns, function (i, column) {
            var falign = '', // footer align style
                style = '',
                class_ = sprintf(' class="%s"', column['class']);

            if (!column.visible) {
                return;
            }

            if (that.options.cardView && (!column.cardVisible)) {
                return;
            }

            falign = sprintf('text-align: %s; ', column.falign ? column.falign : column.align);
            style = sprintf('vertical-align: %s; ', column.valign);

            html.push('<td', class_, sprintf(' style="%s"', falign + style), '>');
            html.push('<div class="th-inner">');

            html.push(calculateObjectValue(column, column.footerFormatter, [data], '&nbsp;') || '&nbsp;');

            html.push('</div>');
            html.push('<div class="fht-cell"></div>');
            html.push('</div>');
            html.push('</td>');
        });

        this.$tableFooter.find('tr').html(html.join(''));
        clearTimeout(this.timeoutFooter_);
        this.timeoutFooter_ = setTimeout($.proxy(this.fitFooter, this),
            this.$el.is(':hidden') ? 100 : 0);
    };

    BootstrapTable.prototype.fitFooter = function () {
        var that = this,
            $footerTd,
            elWidth,
            scrollWidth;

        clearTimeout(this.timeoutFooter_);
        if (this.$el.is(':hidden')) {
            this.timeoutFooter_ = setTimeout($.proxy(this.fitFooter, this), 100);
            return;
        }

        elWidth = this.$el.css('width');
        scrollWidth = elWidth > this.$tableBody.width() ? getScrollBarWidth() : 0;

        this.$tableFooter.css({
            'margin-right': scrollWidth
        }).find('table').css('width', elWidth)
            .attr('class', this.$el.attr('class'));

        $footerTd = this.$tableFooter.find('td');

        this.$body.find('>tr:first-child:not(.no-records-found) > *').each(function (i) {
            var $this = $(this);

            $footerTd.eq(i).find('.fht-cell').width($this.innerWidth());
        });
    };

    BootstrapTable.prototype.toggleColumn = function (index, checked, needUpdate) {
        if (index === -1) {
            return;
        }
        this.columns[index].visible = checked;
        this.initHeader();
        this.initSearch();
        this.initPagination();
        this.initBody();

        if (this.options.showColumns) {
            var $items = this.$toolbar.find('.keep-open input').prop('disabled', false);

            if (needUpdate) {
                $items.filter(sprintf('[value="%s"]', index)).prop('checked', checked);
            }

            if ($items.filter(':checked').length <= this.options.minimumCountColumns) {
                $items.filter(':checked').prop('disabled', true);
            }
        }
    };

    BootstrapTable.prototype.toggleRow = function (index, uniqueId, visible) {
        if (index === -1) {
            return;
        }

        this.$body.find(typeof index !== 'undefined' ?
            sprintf('tr[data-index="%s"]', index) :
            sprintf('tr[data-uniqueid="%s"]', uniqueId))
        [visible ? 'show' : 'hide']();
    };

    BootstrapTable.prototype.getVisibleFields = function () {
        var that = this,
            visibleFields = [];

        $.each(this.header.fields, function (j, field) {
            var column = that.columns[getFieldIndex(that.columns, field)];

            if (!column || !column.visible) {
                return;
            }
            visibleFields.push(field);
        });
        return visibleFields;
    };

    // PUBLIC FUNCTION DEFINITION
    // =======================

    BootstrapTable.prototype.resetView = function (params) {
        var padding = 0;

        if (params && params.height) {
            this.options.height = params.height;
        }

        this.$selectAll.prop('checked', this.$selectItem.length > 0 &&
            this.$selectItem.length === this.$selectItem.filter(':checked').length);

        if (this.options.height) {
            var toolbarHeight = getRealHeight(this.$toolbar),
                paginationHeight = getRealHeight(this.$pagination),
                height = this.options.height - toolbarHeight - paginationHeight;

            this.$tableContainer.css('height', height + 'px');
        }

        if (this.options.cardView) {
            // remove the element css
            this.$el.css('margin-top', '0');
            this.$tableContainer.css('padding-bottom', '0');
            return;
        }

        if (this.options.showHeader && this.options.height) {
            this.$tableHeader.show();
            this.resetHeader();
            padding += this.$header.outerHeight();
        } else {
            this.$tableHeader.hide();
            this.trigger('post-header');
        }

        if (this.options.showFooter) {
            this.resetFooter();
            if (this.options.height) {
                padding += this.$tableFooter.outerHeight() + 1;
            }
        }

        // Assign the correct sortable arrow
        this.getCaret();
        this.$tableContainer.css('padding-bottom', padding + 'px');
        this.trigger('reset-view');
    };

    BootstrapTable.prototype.getData = function (useCurrentPage) {
        return (this.searchText || !$.isEmptyObject(this.filterColumns) || !$.isEmptyObject(this.filterColumnsPartial)) ?
            (useCurrentPage ? this.data.slice(this.pageFrom - 1, this.pageTo) : this.data) :
            (useCurrentPage ? this.options.data.slice(this.pageFrom - 1, this.pageTo) : this.options.data);
    };

    BootstrapTable.prototype.load = function (data) {
        var fixedScroll = false;

        // #431: support pagination
        if (this.options.sidePagination === 'server') {
            if (data) {
                this.options.totalRows = data.total;
                fixedScroll = data.fixedScroll;
                data = data[this.options.dataField];
            }
        } else if (!$.isArray(data)) { // support fixedScroll
            if (data) {
                fixedScroll = data.fixedScroll;
                data = data.data;
            }
        }

        this.initData(data);
        this.initSearch();
        this.initPagination();
        this.initBody(fixedScroll);
    };

    BootstrapTable.prototype.append = function (data) {
        this.initData(data, 'append');
        this.initSearch();
        this.initPagination();
        this.initSort();
        this.initBody(true);
    };

    BootstrapTable.prototype.prepend = function (data) {
        this.initData(data, 'prepend');
        this.initSearch();
        this.initPagination();
        this.initSort();
        this.initBody(true);
    };

    BootstrapTable.prototype.remove = function (params) {
        var len = this.options.data.length,
            i, row;

        if (!params.hasOwnProperty('field') || !params.hasOwnProperty('values')) {
            return;
        }

        for (i = len - 1; i >= 0; i--) {
            row = this.options.data[i];

            if (!row.hasOwnProperty(params.field)) {
                continue;
            }
            if ($.inArray(row[params.field], params.values) !== -1) {
                this.options.data.splice(i, 1);
            }
        }

        if (len === this.options.data.length) {
            return;
        }

        this.initSearch();
        this.initPagination();
        this.initSort();
        this.initBody(true);
    };

    BootstrapTable.prototype.removeAll = function () {
        if (this.options.data.length > 0) {
            this.options.data.splice(0, this.options.data.length);
            this.initSearch();
            this.initPagination();
            this.initBody(true);
        }
    };

    BootstrapTable.prototype.getRowByUniqueId = function (id) {
        var uniqueId = this.options.uniqueId,
            len = this.options.data.length,
            dataRow = null,
            i, row, rowUniqueId;

        for (i = len - 1; i >= 0; i--) {
            row = this.options.data[i];

            if (row.hasOwnProperty(uniqueId)) { // uniqueId is a column
                rowUniqueId = row[uniqueId];
            } else if (row._data.hasOwnProperty(uniqueId)) { // uniqueId is a row data property
                rowUniqueId = row._data[uniqueId];
            } else {
                continue;
            }

            if (typeof rowUniqueId === 'string') {
                id = id.toString();
            } else if (typeof rowUniqueId === 'number') {
                if ((Number(rowUniqueId) === rowUniqueId) && (rowUniqueId % 1 === 0)) {
                    id = parseInt(id);
                } else if ((rowUniqueId === Number(rowUniqueId)) && (rowUniqueId !== 0)) {
                    id = parseFloat(id);
                }
            }

            if (rowUniqueId === id) {
                dataRow = row;
                break;
            }
        }

        return dataRow;
    };

    BootstrapTable.prototype.removeByUniqueId = function (id) {
        var len = this.options.data.length,
            row = this.getRowByUniqueId(id);

        if (row) {
            this.options.data.splice(this.options.data.indexOf(row), 1);
        }

        if (len === this.options.data.length) {
            return;
        }

        this.initSearch();
        this.initPagination();
        this.initBody(true);
    };

    BootstrapTable.prototype.updateByUniqueId = function (params) {
        var rowId;

        if (!params.hasOwnProperty('id') || !params.hasOwnProperty('row')) {
            return;
        }

        rowId = $.inArray(this.getRowByUniqueId(params.id), this.options.data);

        if (rowId === -1) {
            return;
        }

        $.extend(this.data[rowId], params.row);
        this.initSort();
        this.initBody(true);
    };

    BootstrapTable.prototype.insertRow = function (params) {
        if (!params.hasOwnProperty('index') || !params.hasOwnProperty('row')) {
            return;
        }
        this.data.splice(params.index, 0, params.row);
        this.initSearch();
        this.initPagination();
        this.initSort();
        this.initBody(true);
    };

    BootstrapTable.prototype.updateRow = function (params) {
        if (!params.hasOwnProperty('index') || !params.hasOwnProperty('row')) {
            return;
        }
        $.extend(this.data[params.index], params.row);
        this.initSort();
        this.initBody(true);
    };

    BootstrapTable.prototype.showRow = function (params) {
        if (!params.hasOwnProperty('index') && !params.hasOwnProperty('uniqueId')) {
            return;
        }
        this.toggleRow(params.index, params.uniqueId, true);
    };

    BootstrapTable.prototype.hideRow = function (params) {
        if (!params.hasOwnProperty('index') && !params.hasOwnProperty('uniqueId')) {
            return;
        }
        this.toggleRow(params.index, params.uniqueId, false);
    };

    BootstrapTable.prototype.getRowsHidden = function (show) {
        var rows = $(this.$body[0]).children().filter(':hidden'),
            i = 0;
        if (show) {
            for (; i < rows.length; i++) {
                $(rows[i]).show();
            }
        }
        return rows;
    };

    BootstrapTable.prototype.mergeCells = function (options) {
        var row = options.index,
            col = $.inArray(options.field, this.getVisibleFields()),
            rowspan = options.rowspan || 1,
            colspan = options.colspan || 1,
            i, j,
            $tr = this.$body.find('>tr'),
            $td;

        if (this.options.detailView && !this.options.cardView) {
            col += 1;
        }

        $td = $tr.eq(row).find('>td').eq(col);

        if (row < 0 || col < 0 || row >= this.data.length) {
            return;
        }

        for (i = row; i < row + rowspan; i++) {
            for (j = col; j < col + colspan; j++) {
                $tr.eq(i).find('>td').eq(j).hide();
            }
        }

        $td.attr('rowspan', rowspan).attr('colspan', colspan).show();
    };

    BootstrapTable.prototype.updateCell = function (params) {
        if (!params.hasOwnProperty('index') ||
            !params.hasOwnProperty('field') ||
            !params.hasOwnProperty('value')) {
            return;
        }
        this.data[params.index][params.field] = params.value;

        if (params.reinit === false) {
            return;
        }
        this.initSort();
        this.initBody(true);
    };

    BootstrapTable.prototype.getOptions = function () {
        return this.options;
    };

    BootstrapTable.prototype.getSelections = function () {
        var that = this;

        return $.grep(this.data, function (row) {
            return row[that.header.stateField];
        });
    };

    BootstrapTable.prototype.getAllSelections = function () {
        var that = this;

        return $.grep(this.options.data, function (row) {
            return row[that.header.stateField];
        });
    };

    BootstrapTable.prototype.checkAll = function () {
        this.checkAll_(true);
    };

    BootstrapTable.prototype.uncheckAll = function () {
        this.checkAll_(false);
    };

    BootstrapTable.prototype.checkInvert = function () {
        var that = this;
        var rows = that.$selectItem.filter(':enabled');
        var checked = rows.filter(':checked');
        rows.each(function () {
            $(this).prop('checked', !$(this).prop('checked'));
        });
        that.updateRows();
        that.updateSelected();
        that.trigger('uncheck-some', checked);
        checked = that.getSelections();
        that.trigger('check-some', checked);
    };

    BootstrapTable.prototype.checkAll_ = function (checked) {
        var rows;
        if (!checked) {
            rows = this.getSelections();
        }
        this.$selectAll.add(this.$selectAll_).prop('checked', checked);
        this.$selectItem.filter(':enabled').prop('checked', checked);
        this.updateRows();
        if (checked) {
            rows = this.getSelections();
        }
        this.trigger(checked ? 'check-all' : 'uncheck-all', rows);
    };

    BootstrapTable.prototype.check = function (index) {
        this.check_(true, index);
    };

    BootstrapTable.prototype.uncheck = function (index) {
        this.check_(false, index);
    };

    BootstrapTable.prototype.check_ = function (checked, index) {
        var $el = this.$selectItem.filter(sprintf('[data-index="%s"]', index)).prop('checked', checked);
        this.data[index][this.header.stateField] = checked;
        this.updateSelected();
        this.trigger(checked ? 'check' : 'uncheck', this.data[index], $el);
    };

    BootstrapTable.prototype.checkBy = function (obj) {
        this.checkBy_(true, obj);
    };

    BootstrapTable.prototype.uncheckBy = function (obj) {
        this.checkBy_(false, obj);
    };

    BootstrapTable.prototype.checkBy_ = function (checked, obj) {
        if (!obj.hasOwnProperty('field') || !obj.hasOwnProperty('values')) {
            return;
        }

        var that = this,
            rows = [];
        $.each(this.options.data, function (index, row) {
            if (!row.hasOwnProperty(obj.field)) {
                return false;
            }
            if ($.inArray(row[obj.field], obj.values) !== -1) {
                var $el = that.$selectItem.filter(':enabled')
                    .filter(sprintf('[data-index="%s"]', index)).prop('checked', checked);
                row[that.header.stateField] = checked;
                rows.push(row);
                that.trigger(checked ? 'check' : 'uncheck', row, $el);
            }
        });
        this.updateSelected();
        this.trigger(checked ? 'check-some' : 'uncheck-some', rows);
    };

    BootstrapTable.prototype.destroy = function () {
        this.$el.insertBefore(this.$container);
        $(this.options.toolbar).insertBefore(this.$el);
        this.$container.next().remove();
        this.$container.remove();
        this.$el.html(this.$el_.html())
            .css('margin-top', '0')
            .attr('class', this.$el_.attr('class') || ''); // reset the class
    };

    BootstrapTable.prototype.showLoading = function () {
        this.$tableLoading.show();
    };

    BootstrapTable.prototype.hideLoading = function () {
        this.$tableLoading.hide();
    };

    BootstrapTable.prototype.togglePagination = function () {
        this.options.pagination = !this.options.pagination;
        var button = this.$toolbar.find('button[name="paginationSwitch"] i');
        if (this.options.pagination) {
            button.attr("class", this.options.iconsPrefix + " " + this.options.icons.paginationSwitchDown);
        } else {
            button.attr("class", this.options.iconsPrefix + " " + this.options.icons.paginationSwitchUp);
        }
        this.updatePagination();
    };

    BootstrapTable.prototype.refresh = function (params) {
        if (params && params.url) {
            this.options.url = params.url;
            this.options.pageNumber = 1;
        }
        this.initServer(params && params.silent, params && params.query);
    };

    BootstrapTable.prototype.resetWidth = function () {
        if (this.options.showHeader && this.options.height) {
            this.fitHeader();
        }
        if (this.options.showFooter) {
            this.fitFooter();
        }
    };

    BootstrapTable.prototype.showColumn = function (field) {
        this.toggleColumn(getFieldIndex(this.columns, field), true, true);
    };

    BootstrapTable.prototype.hideColumn = function (field) {
        this.toggleColumn(getFieldIndex(this.columns, field), false, true);
    };

    BootstrapTable.prototype.getHiddenColumns = function () {
        return $.grep(this.columns, function (column) {
            return !column.visible;
        });
    };

    BootstrapTable.prototype.filterBy = function (columns) {
        this.filterColumns = $.isEmptyObject(columns) ? {} : columns;
        this.options.pageNumber = 1;
        this.initSearch();
        this.updatePagination();
    };

    BootstrapTable.prototype.scrollTo = function (value) {
        if (typeof value === 'string') {
            value = value === 'bottom' ? this.$tableBody[0].scrollHeight : 0;
        }
        if (typeof value === 'number') {
            this.$tableBody.scrollTop(value);
        }
        if (typeof value === 'undefined') {
            return this.$tableBody.scrollTop();
        }
    };

    BootstrapTable.prototype.getScrollPosition = function () {
        return this.scrollTo();
    };

    BootstrapTable.prototype.selectPage = function (page) {
        if (page > 0 && page <= this.options.totalPages) {
            this.options.pageNumber = page;
            this.updatePagination();
        }
    };

    BootstrapTable.prototype.prevPage = function () {
        if (this.options.pageNumber > 1) {
            this.options.pageNumber--;
            this.updatePagination();
        }
    };

    BootstrapTable.prototype.nextPage = function () {
        if (this.options.pageNumber < this.options.totalPages) {
            this.options.pageNumber++;
            this.updatePagination();
        }
    };

    BootstrapTable.prototype.toggleView = function () {
        this.options.cardView = !this.options.cardView;
        this.initHeader();
        // Fixed remove toolbar when click cardView button.
        //that.initToolbar();
        this.initBody();
        this.trigger('toggle', this.options.cardView);
    };

    BootstrapTable.prototype.refreshOptions = function (options) {
        //If the objects are equivalent then avoid the call of destroy / init methods
        if (compareObjects(this.options, options, true)) {
            return;
        }
        this.options = $.extend(this.options, options);
        this.trigger('refresh-options', this.options);
        this.destroy();
        this.init();
    };

    BootstrapTable.prototype.resetSearch = function (text) {
        var $search = this.$toolbar.find('.search input');
        $search.val(text || '');
        this.onSearch({ currentTarget: $search });
    };

    BootstrapTable.prototype.expandRow_ = function (expand, index) {
        var $tr = this.$body.find(sprintf('> tr[data-index="%s"]', index));
        if ($tr.next().is('tr.detail-view') === (expand ? false : true)) {
            $tr.find('> td > .detail-icon').click();
        }
    };

    BootstrapTable.prototype.expandRow = function (index) {
        this.expandRow_(true, index);
    };

    BootstrapTable.prototype.collapseRow = function (index) {
        this.expandRow_(false, index);
    };

    BootstrapTable.prototype.expandAllRows = function (isSubTable) {
        if (isSubTable) {
            var $tr = this.$body.find(sprintf('> tr[data-index="%s"]', 0)),
                that = this,
                detailIcon = null,
                executeInterval = false,
                idInterval = -1;

            if (!$tr.next().is('tr.detail-view')) {
                $tr.find('> td > .detail-icon').click();
                executeInterval = true;
            } else if (!$tr.next().next().is('tr.detail-view')) {
                $tr.next().find(".detail-icon").click();
                executeInterval = true;
            }

            if (executeInterval) {
                try {
                    idInterval = setInterval(function () {
                        detailIcon = that.$body.find("tr.detail-view").last().find(".detail-icon");
                        if (detailIcon.length > 0) {
                            detailIcon.click();
                        } else {
                            clearInterval(idInterval);
                        }
                    }, 1);
                } catch (ex) {
                    clearInterval(idInterval);
                }
            }
        } else {
            var trs = this.$body.children();
            for (var i = 0; i < trs.length; i++) {
                this.expandRow_(true, $(trs[i]).data("index"));
            }
        }
    };

    BootstrapTable.prototype.collapseAllRows = function (isSubTable) {
        if (isSubTable) {
            this.expandRow_(false, 0);
        } else {
            var trs = this.$body.children();
            for (var i = 0; i < trs.length; i++) {
                this.expandRow_(false, $(trs[i]).data("index"));
            }
        }
    };

    BootstrapTable.prototype.updateFormatText = function (name, text) {
        if (this.options[sprintf('format%s', name)]) {
            if (typeof text === 'string') {
                this.options[sprintf('format%s', name)] = function () {
                    return text;
                };
            } else if (typeof text === 'function') {
                this.options[sprintf('format%s', name)] = text;
            }
        }
        this.initToolbar();
        this.initPagination();
        this.initBody();
    };

    // BOOTSTRAP TABLE PLUGIN DEFINITION
    // =======================

    var allowedMethods = [
        'getOptions',
        'getSelections', 'getAllSelections', 'getData',
        'load', 'append', 'prepend', 'remove', 'removeAll',
        'insertRow', 'updateRow', 'updateCell', 'updateByUniqueId', 'removeByUniqueId',
        'getRowByUniqueId', 'showRow', 'hideRow', 'getRowsHidden',
        'mergeCells',
        'checkAll', 'uncheckAll', 'checkInvert',
        'check', 'uncheck',
        'checkBy', 'uncheckBy',
        'refresh',
        'resetView',
        'resetWidth',
        'destroy',
        'showLoading', 'hideLoading',
        'showColumn', 'hideColumn', 'getHiddenColumns',
        'filterBy',
        'scrollTo',
        'getScrollPosition',
        'selectPage', 'prevPage', 'nextPage',
        'togglePagination',
        'toggleView',
        'refreshOptions',
        'resetSearch',
        'expandRow', 'collapseRow', 'expandAllRows', 'collapseAllRows',
        'updateFormatText'
    ];

    $.fn.bootstrapTable = function (option) {
        var value,
            args = Array.prototype.slice.call(arguments, 1);

        this.each(function () {
            var $this = $(this),
                data = $this.data('bootstrap.table'),
                options = $.extend({}, BootstrapTable.DEFAULTS, $this.data(),
                    typeof option === 'object' && option);

            if (typeof option === 'string') {
                if ($.inArray(option, allowedMethods) < 0) {
                    throw new Error("Unknown method: " + option);
                }

                if (!data) {
                    return;
                }

                value = data[option].apply(data, args);

                if (option === 'destroy') {
                    $this.removeData('bootstrap.table');
                }
            }

            if (!data) {
                $this.data('bootstrap.table', (data = new BootstrapTable(this, options)));
            }
        });

        return typeof value === 'undefined' ? this : value;
    };

    $.fn.bootstrapTable.Constructor = BootstrapTable;
    $.fn.bootstrapTable.defaults = BootstrapTable.DEFAULTS;
    $.fn.bootstrapTable.columnDefaults = BootstrapTable.COLUMN_DEFAULTS;
    $.fn.bootstrapTable.locales = BootstrapTable.LOCALES;
    $.fn.bootstrapTable.methods = allowedMethods;
    $.fn.bootstrapTable.utils = {
        sprintf: sprintf,
        getFieldIndex: getFieldIndex,
        compareObjects: compareObjects,
        calculateObjectValue: calculateObjectValue
    };

    // BOOTSTRAP TABLE INIT
    // =======================

    $(function () {
        $('[data-toggle="table"]').bootstrapTable();
    });
}(jQuery);
;
/**
 * Bootstrap Table Chinese translation
 * Author: Zhixin Wen<wenzhixin2010@gmail.com>
 */
(function ($) {
    'use strict';

    $.fn.bootstrapTable.locales['zh-CN'] = {
        formatLoadingMessage: function () {
            return '正在努力地加载数据中，请稍候……';
        },
        formatRecordsPerPage: function (pageNumber) {
            return '每页显示 ' + pageNumber + ' 条记录';
        },
        formatShowingRows: function (pageFrom, pageTo, totalRows) {
            return '显示第 ' + pageFrom + ' 到第 ' + pageTo + ' 条记录，总共 ' + totalRows + ' 条记录';
        },
        formatSearch: function () {
            return '搜索';
        },
        formatNoMatches: function () {
            //return '没有找到匹配的记录';
            return "";
        },
        formatPaginationSwitch: function () {
            return '隐藏/显示分页';
        },
        formatRefresh: function () {
            return '刷新';
        },
        formatToggle: function () {
            return '切换';
        },
        formatColumns: function () {
            return '列';
        },
        formatExport: function () {
            return '导出数据';
        },
        formatClearFilters: function () {
            return '清空过滤';
        }
    };

    $.extend($.fn.bootstrapTable.defaults, $.fn.bootstrapTable.locales['zh-CN']);

})(jQuery);
;
//add by xc 2016-11-12
(function ($) {
    function DropDownList(opt) {
        this.Opt = opt || {};
        this.Width = opt.Width;
        this.Init();
    }
    DropDownList.prototype = {
        Init: function () {
            this.GetOptions();
            this.Render();
            this.BindEvent();
        },
        GetOptions: function () {
            this.Options = {};
            this.OptionAyy = [];
            var ops = this.Opt.Target.options;
            for (var i = 0, len = ops.length; i < len; i++) {
                var item = ops[i];
                this.OptionAyy.push(item.value);
                this.Options[item.value] = item.text;
            }
        },
        Render: function () {
            var that = this;
            var html = '<div class="dropdownlist">' +
                '<div class="drop-handle">' +
                '<div class="drop-text"></div>' +
                '<span class="drop-btn"></span>' +
                '</div>' +
                '</div>';
            that.Height = $(that.Opt.Target).outerHeight();
            that.Height = that.Height < 26 ? 26 : that.Height;
            var w = $(that.Opt.Target).outerWidth();

            var pec = parseInt($(that.Opt.Target).outerWidth()) * 100 / parseInt($(that.Opt.Target).parent().width());
            pec = pec > 100 ? 100 : pec;
            that.$DropDown = $(html).attr("style", $(that.Opt.Target).attr("style")).css("width", (that.Width || pec + "%"));
            that.$DropList = $('<ul class="drop-list drop-list_s"></ul>').appendTo($("body"));
            that.$DropDown.height(that.Height);
            that.$DropHandle = that.$DropDown.children('.drop-handle').css({
                "height": that.Height + 'px',
                "line-height": that.Height - 2 + 'px'
            });
            that.$DropText = that.$DropHandle.children('.drop-text');
            var $target = $(that.Opt.Target);
            $target.before(that.$DropDown.css("display", "inline-block")).hide();

            //if ($target.attr('disabled') != undefined && $target.attr('disabled') == 'disabled') {
            //    that.$DropDown.children('.drop-handle').css('background-color', 'rgb(235,235,228)');
            //    that.$DropDown.children('.drop-btn').css('background-color','rgb(235,235,228)');
            //}
            that.RenderOptions();
        },
        RenderOptions: function () {
            var that = this;
            that.$DropList.html("");
            for (var i = 0, len = that.OptionAyy.length; i < len; i++) {
                var opt = that.OptionAyy[i];
                that.$DropList.append('<li class="dropdownlist-item ' + (that.Opt.Target.value == opt ? 'active' : null) + '" data-index="' + i + '" data-value="' + opt + '"><a class="drop-item-btn">' + that.Options[opt] + '</a></li>');
            }

            that.SetValue.apply(that, [that.Opt.Target.value]);
        },
        BindEvent: function () {
            //如果target设置了disable则不要绑定事件
            var that = this;

            var $target = $(that.Opt.Target);
            //if ($target.attr('disabled')!=undefined&&$target.attr('disabled')=='disabled') {
            //    return;
            //}
            that.$DropHandle.bind('click', function (e) {
                if ($(that.$DropHandle).find(".fa-chevron-down").length == 1) {
                    $(that.$DropHandle).find(".fa-chevron-down").removeClass("fa-chevron-down").addClass("fa-chevron-up");
                } else {
                    $(that.$DropHandle).find(".fa-chevron-up").removeClass("fa-chevron-up").addClass("fa-chevron-down");
                }

                var $Tar = that.$DropList;
                $("ul.drop-list").not($Tar).hide();
                that.$DropList.css("min-width", that.$DropDown.width());
                var w = 30 * that.OptionAyy.length;
                w = w > 300 ? 300 : w;
                var offset = that.$DropDown.offset();
                var left = 0;
                var $par = that.$DropDown.parent();
                while ($par.length > 1 && $par[0].tagName.toLowerCase() != "window") {
                    left += $par.scrollLeft();
                    $par = that.$DropDown.parent();
                }
                var top = $(window).height() - offset.top + $(window).scrollTop() - that.Height - 10;
                if (top < w) {
                    that.$DropList.css({ "top": offset.top - that.$DropList.outerHeight(), "left": offset.left - left });
                } else {
                    that.$DropList.css({ "top": offset.top + that.Height, "left": offset.left - left });
                }
                $Tar.toggle();
                return false;
            });
            that.$DropList.on("click", ".dropdownlist-item", function () {
                if ($(this).hasClass("active")) return;
                $(this).addClass("active").siblings(".dropdownlist-item").removeClass("active");
                that.SetValue.apply(that, [$(this).attr("data-value")]);
                $(this).parent().hide();
                $(that.Opt.Target).change();
                return false;
            })

            $(that.Opt.Target).unbind("change.dropdownlist-select").bind("change.dropdownlist-select", function () {
                that.$DropText.html(that.Options[this.value]);
                that.$DropList.children("li.dropdownlist-item").removeClass("active").end().children("li.dropdownlist-item[data-value='" + this.value + "']").addClass("active");

                $(that.$DropHandle).find(".fa-chevron-up").removeClass("fa-chevron-up").addClass("fa-chevron-down");
                return false;
            });

            $(document).unbind("click.dropdownlist-cl").bind("click.dropdownlist-cl", function () {
                $("ul.drop-list.drop-list_s").hide();
                $(document).find("#ListView .fa-chevron-up").removeClass("fa-chevron-up").addClass("fa-chevron-down");
            })
        },
        SetValue: function (val, index) {
            this.$DropText.html(this.Options[val]);
            if (index) {
                this.Opt.Target.selectedIndex = index;
            }
            this.Opt.Target.value = val;
            this.$DropList.children("li.dropdownlist-item").removeClass("active").end().children("li.dropdownlist-item[data-value='" + val + "']").addClass("active");
        },
        Destroy: function () {
            var that = this;
            that.$DropDown.remove();
            that.$DropList.remove();
            $(that.Opt.Target).show().removeData("DropDownList");
        },
        Refresh: function (width) {
            this.GetOptions();
            this.RenderOptions();
            width && this.$DropDown.css("width", width);
            return this;
        },
        AddItem: function (value, text) {
            var that = this;
            that.OptionAyy = this.OptionAyy || [];
            that.Options = this.Options || {};
            that.OptionAyy.push(value);
            that.Options[value] = text;

            that.$DropList.append('<li class="dropdownlist-item" data-index="' + that.OptionAyy.length - 1 + '" data-value="' + value + '"><a class="drop-item-btn">' + text + '</a></li>');
        },
        ClearItems: function () {
            this.$DropText.html("");
            this.$DropList.children("li.dropdownlist-item").removeClass("active")
        }
    }

    $.fn.DropDownList = function (param) {
        var args = Array.prototype.slice.call(arguments, 1);

        $(this).each(function () {
            var $this = $(this), DropDown = $this.data("DropDownList");

            if (DropDown && param && typeof param === "string") {
                DropDown[param].apply(DropDown, args);
            } else if (DropDown) {
                DropDown.Refresh.call(DropDown);
            } else {
                var opt = { Target: this };
                typeof param === "object" && (opt = $.extend(opt, param));
                $(this).data("DropDownList", new DropDownList(opt));
            }
        });
        return $(this);
    }

}(jQuery));


//支持单选和多选下拉框（多选情况下多个Value值以分号隔开）
(function ($) {
    function SelectForm(opt) {
        this.Options = $.extend({}, DefaultOpt, opt);
        this.$Wrapper = $('<div ' + (this.Options.ID ? ('ID="' + this.Options.ID + '"') : '') + ' class="dropdownlist">' +
            '<div class="drop-handle">' +
            '<div class="drop-text"></div>' +
            '<span class="drop-btn"></span>' +
            '</div>' +
            '<ul class="drop-list"></ul>' +
            '</div>');
        this.$Items = this.$Wrapper.find(".drop-list");
        this.$Text = this.$Wrapper.find(".drop-text");
        this.$Btn = this.$Wrapper.find(".drop-btn");
        this.$DropHandle = this.$Wrapper.find(".drop-handle");
        this.LiHTML = this.Options.IsMultiple ? '<li class="dropdownlist-item" data-index="{{0}}" data-value="{{1}}" style="padding-left:1em;"><input type="checkbox" class="input-drop" id="{{2}}"><label for="{{2}}" class="drop-item-btn">{{3}}</label></li>' : '<li class="dropdownlist-item" data-index="{{0}}" data-value="{{1}}"><a class="drop-item-btn">{{2}}</a></li>';

        this._Init();
    }

    SelectForm.prototype = {
        _Init: function () {
            var that = this;
            that.ItemLength = that.Options.DropList.length
            var index = 0;
            this.ListItems = {};
            //全选
            if (that.Options.IsMultiple) {
                var ID = $.IGuid();
                this.$Items.append('<li class="dropdownlist-item" style="padding-left:1em;"><input type="checkbox" class="input-drop selectall" id="' + ID + '"><label for="' + ID + '" class="drop-item-btn">全选</label></li>');
            }

            for (var i = 0; i < that.ItemLength; i++) {
                var obj = this.Options.DropList[i];
                obj.Index = index;
                this.ListItems[obj.Value] = obj;
                if (that.Options.IsMultiple) {
                    var ID = $.IGuid();
                    this.$Items.append(that.LiHTML.replace(/\{{0\}}/g, index++).replace(/\{{1\}}/g, obj.Value).replace(/\{{2\}}/g, ID).replace(/\{{3\}}/g, obj.Text));
                }
                else {
                    this.$Items.append(that.LiHTML.replace(/\{{0\}}/g, index++).replace(/\{{1\}}/g, obj.Value).replace(/\{{2\}}/g, obj.Text));
                }
            }

            that.$DropHandle = that.$Wrapper.children('.drop-handle').css({
                "height": that.Options.Height + 'px',
                "line-height": that.Options.Height - 2 + 'px'
            });
            this.$Wrapper.width(this.Options.Width).height(this.Options.Height);
            that.$Items.css({ "left": 0, 'min-width': "100%" });
            this.SetValue(this.Options.DefaultValue);

            this._BindEvent();

            that.Options.Target && $(that.Options.Target).append(this.$Wrapper);
        },
        _BindEvent: function () {
            var that = this;
            that.$DropHandle.bind('click', function (e) {
                //var $Tar = that.$Items;
                $("ul.drop-list").not(that.$Items).hide();
                var w = 20 * that.ItemLength;
                w = w > 200 ? 200 : w;
                var offset = that.$Wrapper.offset();

                var top = $(window).height() - offset.top + $(window).scrollTop() - that.Options.Height - 1;
                if (top < w) {
                    that.$Items.css({ bottom: "100%", top: "auto" });
                } else {
                    that.$Items.css({ bottom: "auto", top: "100%" });
                }
                that.$Items.toggle();
                return false;
            });

            if (that.Options.IsMultiple) {
                that.$Items.on("click", "input[type=checkbox].input-drop", function (e) {
                    //全选
                    if ($(this).hasClass("selectall")) {
                        if (this.checked) {
                            var texts = [];
                            for (var key in that.ListItems) {
                                texts.push(key);
                            }
                            that.SetValue.call(that, texts.join(";"));

                            that.$Items.find("input[type=checkbox].input-drop").prop("checked", true);
                        } else {
                            that.SetValue.call(that, "");
                            that.$Items.find("input[type=checkbox].input-drop:checked").prop("checked", false);
                        }
                    } else {
                        var value = "";
                        var len = 0;
                        that.$Items.find("input[type=checkbox].input-drop:checked").not(".selectall").each(function () {
                            len++;
                            value = value ? value + ";" + $(this).parent(".dropdownlist-item").attr("data-value") : $(this).parent(".dropdownlist-item").attr("data-value");
                        })
                        if (this.checked) {
                            len === that.ItemLength && that.$Items.find("input[type=checkbox].selectall").prop("checked", true);
                        } else {
                            that.$Items.find("input[type=checkbox].selectall").prop("checked", false);
                        }
                        that.SetValue.call(that, value);
                    }
                    e.stopPropagation();
                })


                that.$Items.on("click", "input[type=checkbox]+label", function (e) {
                    e.stopPropagation();
                })
            } else {
                that.$Items.on("click", ".dropdownlist-item", function () {
                    if ($(this).hasClass("active")) return;
                    $(this).addClass("active").siblings(".dropdownlist-item").removeClass("active");
                    that.SetValue.apply(that, [$(this).attr("data-value")]);
                    //下拉框选择后关闭 --wangj
                    that.$Items.hide();
                })

                $(document).unbind("click.dropdownlist-cl").bind("click.dropdownlist-cl", function (e) {
                    $(".drop-handle + ul.drop-list").hide();
                });
            }
        },
        SetValue: function (val) {
            var that = this;
            if (val) {
                var items = (val + "").split(';');
                var text = '';
                for (var i = 0, len = items.length; i < len; i++) {
                    var obj = this.ListItems[items[i]];
                    if (obj) {
                        text += obj.Text + (i == len - 1 ? "" : ';');
                        that.Options.IsMultiple == false ? this.$Items.children("li.dropdownlist-item[data-value='" + obj.Value + "']").addClass("active") : this.$Items.children("li.dropdownlist-item[data-value='" + obj.Value + "']").find("input[type=checkbox]").prop("checked", true);
                    }
                    else {
                        console.log("设置的值不存在");
                    }
                }
                this.$Text.text(text);
            }
            else {
                this.$Text.text(this.Options.DefaultText);
            }
            this.Value = val || "";
            this.$Wrapper.attr("data-value", val);
            if (this.Options.Change) {
                this.Options.Change(this);
            }
        },
        AddItem: function (obj, index) {
            var that = this;
            index = index || that.ItemLength;
            obj.Index = index;
            that.ListItems[obj.Value] = obj;
            that.Refresh();
            that.ItemLength++;
        },
        RemoveItem: function (val) {
            var that = this;
            var item = that.ListItems[val];
            for (var key in that.ListItems) {
                if (that.ListItems[key].Index > item.Index) that.ListItems[key].Index--;
            }
            that.ItemLength--;
            delete that.ListItems[val];
            this.Refresh();
        },
        RemoveAt: function (index) {
            //待新增
        },
        Refresh: function () {
            var that = this;
            var l = 0, html = "";
            while (l < that.ItemLength) {
                html += "{{" + i + "}}";
            }

            if (that.Options.IsMultiple) {
                var ID = $.IGuid();
                this.$Items.append('<li class="dropdownlist-item" style="padding-left:1em;"><input type="checkbox" class="input-drop selectall" id="' + ID + '"><label for="' + ID + '" class="drop-item-btn">全选</label></li>');
            }

            for (var key in that.ListItems) {
                var obj = that.ListItems[key];
                var reg = new RegExp("\\{" + obj.Index + "\\}", "g");

                var lihtml = "";
                if (that.Options.IsMultiple) {
                    var ID = $.IGuid();
                    lihtml = that.LiHTML.replace(/\{{0\}}/g, obj.Index).replace(/\{{1\}}/g, obj.Value).replace(/\{{2\}}/g, ID).replace(/\{{3\}}/g, obj.Text);
                }
                else {
                    lihtml = that.LiHTML.replace(/\{{0\}}/g, obj.Index).replace(/\{{1\}}/g, obj.Value).replace(/\{{2\}}/g, obj.Text);
                }
                html.replace(reg, lihtml);
            }
            that.$Items.append(html);
        },
        AppendTo: function ($tar) {
            var that = this;
            $tar && $tar.append(that.$Wrapper);
            return that;
        },
        AppendAftar: function ($tar) {
            var that = this;
            $tar && $tar.after(that.$Wrapper);
            return that;
        },
    }

    var DefaultOpt = {
        Height: 30,
        Width: '100%',
        DropList: [],//object 数组{Value:xxx,Text:xxx}
        DefaultValue: null,
        DefaultText: "--请选择--",
        IsMultiple: false,  //是否多选
        ID: null,
        Target: null,
        Change: null
    }

    $.SelectForm = function (opt) {
        return new SelectForm(opt);
    }

    $.fn.SelectForm = function (opt) {
        var args = Array.prototype.slice.call(arguments, 1);
        $(this).each(function () {
            var $this = $(this), DropDown = $this.data("SelectForm");

            if (DropDown && typeof opt === 'string') {
                DropDown[opt].apply(DropDown, args);
            } else if (DropDown) {
                DropDown.Refresh.call(DropDown);
            } else {
                var option = $.extend({ Target: this }, opt);
                $(this).data("SelectForm", new SelectForm(opt));
            }
        })
        return $(this);
    }
}(jQuery));;
(function ($) {
    // 所有的控件，都可以通过这个接口选择
    $.fn.JControl = function () {
        var jControl;
        var args = arguments;
        $(this).each(function () {
            var $control = $(this);

            //add by xc 若已经渲染过该控件，则不进行重新渲染
            jControl = $control.data("JControl");
            if (!$.isEmptyObject(jControl)) {
                return true;
            }

            //数据项
            var datafield = $control.data($.ControlManager.DataFieldKey.toLocaleLowerCase());
            var controlkey = $control.data($.ControlManager.SheetControlKey.toLocaleLowerCase());
            if (!controlkey) {
                return jControl;
            }
            var dataitem = $.Controls.GetSheetDataItem(datafield, $control);

            if (args.length > 0) {
                dataitem = $.extend(dataitem, args[0]);
            }
            jControl = $.ControlManager.Run.call($control, controlkey, [dataitem]);
            //add by xc 保存JControl值，避免重复渲染同一个控件
            $control.data("JControl", jControl);
        });
        return jControl;
    };

    $.Controls = {};
    //控件属性
    $.Controls.GetDefaultOptions = function (controlKey) {
        var p = {};
        var options = FormControls[controlKey];
        if (options != null) {
            for (var key in options) {
                if (options[key].constructor == String
                    || options[key].constructor == Number
                    || options[key].constructor == Object) {
                    p[key] = options[key] || "";
                }
                else if (options[key].constructor == Array) {
                    for (var i = 0; i < options[key].length; ++i) {
                        p[options[key][i].Name] = options[key][i].DefaultValue == void 0 ? "" : options[key][i].DefaultValue;
                    }
                }
            }
        }
        return p;
    };

    // 读取表单数据
    $.Controls.GetSheetDataItem = function (datafield, $control) {
        if ($.SmartForm.ResponseContext == null) return null;
        // Error:
        if (datafield == "Comments") {
            //审批控件
            return $.IClone($.SmartForm.ResponseContext.Comments);
        }
        var DataItems;
        if ($.SmartForm.TabResData[store.state.listview.currentTabIndex]) {
            DataItems = $.SmartForm.TabResData[store.state.listview.currentTabIndex].ReturnData
        }
        else {
            DataItems = $.SmartForm.ResponseContext.ReturnData;
        }

        if (datafield == void 0) return null;
        var dataitem = DataItems[datafield];

        if (dataitem == null && (datafield + "").indexOf(".") > -1) {
            var pDataField = datafield.split(".")[0];
            var pDataItem = DataItems[pDataField];
            var $trRow = $control.closest("tr");
            var ObjectId = $trRow.attr("data-ObjectId");
            //从已存到数据库地方取数据
            if (ObjectId) {
                if (pDataItem != void 0 && pDataItem != null) {
                    var rows = pDataItem.Value.R;
                    dataitem = $.IClone(pDataItem.Value.T[datafield]);
                    for (var i = 0; i < rows.length; i++) {
                        var rowData = rows[i];
                        if (rowData[pDataField + ".ObjectId"].Value == ObjectId) {
                            dataitem.Value = rowData[datafield].Value;
                            dataitem.Editable = rowData[datafield].Editable;
                            // 某单元格的可见属性自己控制
                            if (dataitem.Visible) {
                                dataitem.Visible = rowData[datafield].Visible;
                            }
                            break;
                        }
                    }
                }
            }
            else {
                ObjectId = $.IGuid();
                $trRow.attr("data-ObjectId", ObjectId);
            }

            if (dataitem == null && pDataItem) {
                dataitem = pDataItem.Value.T[datafield];
            }

            if (dataitem) {
                // 为区别子表里不同行的同一字段
                dataitem["ObjectId"] = ObjectId;
            }
        }

        return $.IClone(dataitem);
    };

})(jQuery);

(function ($) {
    //控件基类
    //1,完成界面初始化:设置组件id并存入组件管理器池,初始化参数
    //2,渲染的工作,细节交给子类实现
    //parm [element] 组件对应的dom element对象
    //parm [options] 组件的参数
    $.Controls.BaseControl = function (element, options, ResponseContext) {
        this.IsQueryControl = false; //标记控件是在表单中还是列表过滤中
        // 表单信息
        this.ResponseContext = ResponseContext;

        //外链表单  0/1
        this.IsExternalForm = ResponseContext && ResponseContext.IsExternalForm;

        //是否支持Html5
        this.IsSupportHtml5 = window.applicationCache != undefined;
        this.SchemaCode = ResponseContext == null ? "" : ResponseContext.SchemaCode;
        this.IsMobile = ResponseContext == null ? false : ResponseContext.IsMobile;
        //页面元素，可以通过$(this.Element)得到jquery对象
        this.Element = element;

        //是否发起模式
        this.Originate = $.IQuery("Mode").toLowerCase() == "originate";
        // 记录当前控件是否验证通过
        this.ValidateResult = true;
        //配置参数,包含属性和事件
        this.Options = options || {};

        //样式列表
        this.Css = {
            ControlTitle: "ControlTitle",
            ControlContent: "ControlContent"
        };

        this.ChangeEvents = {};

        //初始化参数
        this.Init();

        // 是否可见
        if (this.Visible == null) {
            this.Visible = true;
        }

        // 是否可编辑
        if (this.Editable == null) {
            this.Editable = true;
        }
        // 代码内嵌控件是否可见
        this.FormEmbedCodeVisible = true
        //渲染控件前函数
        this.PreRender();
        //渲染控件
        this.Render();
        //渲染后函数
        //this.Rendered();
        this.RenderDescription();
        //隐藏规则和计算规则可能会耗时较长，所以他们异步执行
        //这种情况导致的问题是，如果A的规则中配置了B，B的规则中配置了C。
        //在初始化A的时候需要给B绑定事件，但是B的初始化函数中由于InitHideRule和InitComputationRule函数执行时间较长没有返回，导致A的初始化函数中无法取到B对象无法绑定事件
        //隐藏规则
        //this.InitHideRule();
        //计算规则
        //this.InitComputationRule();

        //异步执行
        var that = this;
        //setTimeout(function () {
        that.InitHideRule.apply(that, []);
        that.InitComputationRule.apply(that, []);
        //}, 0);
    };

    //基础属性
    $.Controls.BaseControl.prototype = {
        // 从页面读取参数,将页面上 data-***的设置读取到Options里面
        // 初始化参数，转为容易用的方式this.***
        // 循环所有默认属性事件,构造成 this.***的格式
        Init: function () {
            var that = this;
            var options = this.Options;
            for (var key in options) {
                var elementkey = key.toLowerCase();
                var $el = $(that.Element);
                var val = $el.data(elementkey);
                if (val != void 0) {
                    if (options[key] == null) {
                        options[key] = val;
                    } else if (options[key].constructor == Boolean) {
                        if (val.constructor == Boolean) {
                            options[key] = val;
                        } else {
                            val = val.toString().toLowerCase();
                            options[key] = val == "true" || val == "1";
                        }
                    } else if (options[key].constructor == Number) {
                        options[key] = parseInt(val);
                    } else if (key.toLocaleLowerCase() != "displayname" || options[key] == "" || options[key] == "CreatedBy.FullName") {
                        options[key] = val;
                    }
                }
            }

            for (var key in options) {
                this[key] = options[key];
            }
        },

        // 控件渲染前函数
        PreRender: function () {
            //PC
            var spanCss = "col-sm-2 col-xs-2";
            var inputCss = "col-sm-10 col-xs-10";
            var $el = $(this.Element);
            if ($el.parent().hasClass("col-sm-6")) {
                $el.parent().css('padding', 0);
                spanCss = "col-sm-2 col-xs-2";
                inputCss = "col-sm-10 col-xs-10";
            }
            //标题列模式
            if (this.TitleDirection == "Vertical") {
                spanCss = "col-sm-12";
                inputCss = "col-sm-12";
            }

            $el.addClass("form-group");
            //标题
            //this.$Title = $("<span></span>").text(this.DisplayName).addClass(spanCss).addClass(this.Css.ControlTitle);
            this.$Title = $("<span class='" + spanCss + " " + this.Css.ControlTitle + "'>" + this.DisplayName + "</span>");
            if (this.Editable && this.Required) {
                this.$Title.append("<span style='color:red;vertical-align:middle'>*<span>");
            }
            var controlkey = $el.attr("data-controlkey");
            this.$InputBody = $("<div>");
            //添加样式
            if (($.isEmptyObject(this.Options.DataField)
                || this.Options.DataField.indexOf('.') == -1
                || this.Options.DataField == "CreatedBy.FullName")
                && (this.DisplayName || this.DataField) && controlkey) {
                if (controlkey != "FormButton") {
                    $el.append(this.$Title);
                    if (controlkey == "FormCheckBoxList" && !this.isCheckbox) {
                        //this.$display = $("<sapn class='display'></span>");
                        //$el.append(this.$display);
                        $el.append("<span class='display'></span>");
                    }
                }
                this.$InputBody.addClass(inputCss);
            }

            $el.append(this.$InputBody);
            //对于可见的字段，添加是否打印属性
            if (this.Visible) {
                //如果字段没有设置是否可打印则默认可打印
                $el.attr("data-printable", this.Printable == void 0 ? true : this.Printable);
            }
            if (controlkey == "FormBoList") {
                $el.empty();
            }
        },

        // 控件渲染
        Render: function () { },
        //计算规则
        InitComputationRule: function () {
            if (!$(this.Element).hasClass('sheet-control')) {
                return;
            }
            //try {
            if (this.DataItem == null || this.DataItem.ComputationRule == null) { return; }
            var computationRule = this.DataItem.ComputationRule;//计算规则
            var computationRuleFields = this.DataItem.ComputationRuleFields;//计算规则使用的字段
            //原来是如果规则没有控件字段则直接执行，修改后只有新建表单时候执行
            //公式型控件每次加载页面都要执行计算
            //子流程第一个节点执行计算规则
            if (this.ResponseContext.IsCreateMode ||
                this instanceof $.Controls.FormFormula ||
                this.ResponseContext.IsChildInstance && (this.ResponseContext.ActivityCode == this.ResponseContext.StartActivityCode)) {
                this.SetComputationResult(computationRule, computationRuleFields);
            }
            var that = this
            var eventName = "change.cr." + this.DataField;
            for (var fi = 0, flen = computationRuleFields.length; fi < flen; fi++) {
                var field = computationRuleFields[fi];
                if (field == 'CreatedBy') {
                    field += '.FullName';
                }
                // 子表字段
                if (field.indexOf(".") > -1) {//规则字段在子表
                    if (this.DataField.indexOf(".") > -1) {//配置规则的字段在子表
                        eventName = "change.cr." + this.ObjectId + "." + this.DataField;
                        //eidt by xc 不需要选择整列再筛选，直接找出对应的单元格，缩短时间
                        //这里要判断是否是在同一个子表
                        var childSchemaName1 = this.DataField.slice(0, this.DataField.indexOf("."));
                        var childSchemaName2 = field.slice(0, field.indexOf("."));
                        if (childSchemaName1 == childSchemaName2) {//同一个子表
                            var $ctrl = $(this.Element).closest("tr").find("div.sheet-control[data-controlkey][data-datafield='" + field + "']");
                            if ($ctrl && $ctrl.length > 0) {
                                var controlMgr = $ctrl.JControl();
                                if (!controlMgr) continue;
                                controlMgr.UnbindChange(eventName);
                                controlMgr.BindChange(eventName, function () {
                                    that.SetComputationResult(computationRule, computationRuleFields);
                                });
                                if (that.ResponseContext.IsCreateMode) {
                                    // 被绑定的值，已经有可能已经渲染
                                    controlMgr.ChangeEvents[eventName].apply(this);
                                }
                            }
                        } else {//跨子表
                            var $ctrl = $("div.sheet-control[data-controlkey][data-datafield='" + field + "']").not(".table_th");
                            for (var i = 0; i < $ctrl.length; i++) {
                                var controlMgr = $ctrl.JControl();
                                eventName = "change.cr." + controlMgr.ObjectId + "." + controlMgr.DataField;
                                if (!controlMgr) continue;
                                controlMgr.UnbindChange(eventName);
                                controlMgr.BindChange(eventName, function () {
                                    that.SetComputationResult(computationRule, computationRuleFields);
                                });
                                if (that.ResponseContext.IsCreateMode) {
                                    // 被绑定的值，已经有可能已经渲染
                                    controlMgr.ChangeEvents[eventName].apply(this);
                                }
                            }
                            eventName = "change.cr." + field.slice(0, field.indexOf(".")) + this.DataField.slice(this.DataField.indexOf("."));
                            var gridMgr = $("div.sheet-control[data-datafield='" + field.slice(0, field.indexOf(".")) + "']").JControl();
                            if (gridMgr) {
                                if (gridMgr.ChangeEvents[eventName] == undefined) {
                                    gridMgr.BindChange(eventName, function (args) {
                                        if (window[eventName]) {
                                            window.clearTimeout(window[eventName]);
                                            window[eventName] = null;
                                        }
                                        window[eventName] = setTimeout(function () {
                                            var targetCtrls = $("div.sheet-control[data-controlkey][data-datafield='" + that.DataField + "']").not(".table_th");
                                            for (var i = 0; i < targetCtrls.length; i++) {
                                                $(targetCtrls[i]).JControl().SetComputationResult(computationRule, computationRuleFields);
                                            }
                                        }, 600);
                                    });
                                }
                            }
                        }
                    } else {
                        eventName = "change.cr." + this.DataField;

                        // 子表删除行、添加行会触发子表Change，将field的事件绑定放到子表Change事件中
                        var gridMgr = $("div.sheet-control[data-datafield='" + field.slice(0, field.indexOf(".")) + "']").JControl();

                        // 给子表上对应的列绑定Change事件
                        var tdCtrl = $("div.sheet-control[data-controlkey][data-datafield='" + field + "']:not(.table_th)");
                        for (var i = 0; i < tdCtrl.length; i++) {
                            var controlMgr = $(tdCtrl[i]).JControl();
                            if (controlMgr) {
                                controlMgr.UnbindChange(eventName);
                                controlMgr.BindChange(eventName, function () {
                                    that.SetComputationResult(computationRule, computationRuleFields);
                                });
                                if (that.ResponseContext.IsCreateMode) {
                                    // 被绑定的值，已经有可能已经渲染
                                    controlMgr.ChangeEvents[eventName].apply($(tdCtrl[i]));
                                }
                            }
                        }
                        if (gridMgr) {
                            gridMgr.UnbindChange(eventName);
                            gridMgr.BindChange(eventName, function (args) {
                                // 子表删除行前触发change事件，要等待行删除后，才重新计算值，所以用setTimeout
                                // 连续添加行，最后一次新增或者删除行，才执行计算规则

                                if (window[eventName]) {
                                    window.clearTimeout(window[eventName]);
                                    window[eventName] = null;
                                }
                                window[eventName] = setTimeout(function () {
                                    that.SetComputationResult(computationRule, computationRuleFields);
                                }, 600);
                            });
                            if (that.ResponseContext.IsCreateMode) {
                                // 被绑定的值，已经有可能已经渲染
                                gridMgr.ChangeEvents[eventName].apply(this);
                            }
                        }
                    }
                } else {
                    eventName = "change.cr." + this.DataField;
                    var changeControl = $("div.sheet-control[data-datafield='" + field + "']").JControl();
                    if (!changeControl) {
                        continue;
                    }
                    changeControl.UnbindChange(eventName);
                    changeControl.BindChange(eventName, function () {
                        //这里不能调用SetComputationResult,如果子表字段规则配置了主表则在主表字段change的时候要更新同一列所有行的字段
                        var targetCtrls = $('div.sheet-control[data-controlkey][data-datafield="' + that.DataField + '"]:not(.table_th)');
                        var appId = sessionStorage.getItem("tabAppId");
                        targetCtrls.each(async function () {
                            // Error :主表会自己调用自己

                            var targetCtrl = $(this).JControl();
                            if (targetCtrl && targetCtrl.SchemaCode == appId) {
                                $("#navbar").css("pointer-events","none");
                                var ret = await targetCtrl.GetComputationResult(computationRule, computationRuleFields);
                                targetCtrl.SetValue(ret);
                                $("#navbar").css("pointer-events","auto");
                            }
                        });
                    });
                    if (that.ResponseContext.IsCreateMode) {
                        // 被绑定的值，已经有可能已经渲染
                        changeControl.ChangeEvents[eventName].apply(this);
                    }
                }
            }
        },
        SetComputationResult: async function (computationRule, computationRuleFields) {
            //设置计算规则时候先判断控件是否是隐藏的，如果控件是隐藏的则不执行计算规则
            $("#navbar").css("pointer-events","none");
            var ret = await this.GetComputationResult(computationRule, computationRuleFields);
            this.SetValue(ret);
            $("#navbar").css("pointer-events","auto");
        },
        GetComputationResult: async function (rule, fields) {
            if (rule == undefined || fields == undefined) {
                return;
            }
            var ruleTemp = rule;
            for (var j = 0, len = fields.length; j < len; j++) {
                //需要考虑字段是子表情况
                var ctrlField = fields[j];
                var val = [];
                if (ctrlField.indexOf('.') > -1) {
                    //子表外部聚合函数计算规则
                    if (this.DataField.indexOf(".") == -1) {
                        //如果是公式控件,其计算来源是子表要先初始化子表，因为公式控件的值不会保存
                        if ($(this.Element).attr("data-controlkey") == "FormFormula" && $.SmartForm.ResponseContext.IsCreateMode == false) {
                            //先初始化子表
                            var gridViewField = ctrlField.split(".")[0];
                            var gridView = $("div.sheet-control[data-controlkey][data-datafield='" + gridViewField + "']").JControl();
                        }
                        //配置字段在主表，规则字段在子表
                        var ctrls = $('div.sheet-control[data-controlkey][data-datafield="' + ctrlField + '"]:not(.table_th)');
                        var ctrlKey = ctrls.attr('data-controlkey');
                        //var ctrl = ctrls.JControl();
                        if (ctrls.length > 0) {
                            for (var childFieldIndex = 0, childFieldLen = ctrls.length; childFieldIndex < childFieldLen; childFieldIndex++) {
                                var ctrl = $(ctrls[childFieldIndex]).JControl();
                                if (ctrl) {
                                    if (ctrlKey == 'FormNumber' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Number)) {
                                        val.push(ctrl.GetNum());
                                    } else if (ctrlKey == 'FormCheckbox' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Bool)) {
                                        val.push(ctrl.GetValue());
                                    } else if (ctrlKey == 'FormTextBox') {
                                        var v = ctrl.GetValue();
                                        v = v.replace(/"/g, '\\"');
                                        val.push('"' + v + '"');
                                        //val.push('"' + ctrl.GetValue() + '"');
                                    } else if (ctrlKey == 'FormTextArea') {
                                        var v = ctrl.GetValue().replace(/[\r\n]/g, "");
                                        v = v.replace(/"/g, '\\"');
                                        val.push('"' + v + '"');
                                        //val.push('"' + ctrl.GetValue().replace(/[\r\n]/g, "") + '"');
                                    } else if (ctrlKey == 'Formuser') {
                                        var uid = ctrl.GetUnitIDs()[0];
                                        val.push('"' + (uid == undefined ? "" : uid) + '"');
                                    } else if (ctrlKey == 'FormMultiKey') {
                                        //不支持多人
                                        val.push('""');
                                    }
                                    else if (ctrlKey == 'FormDateTime') {
                                        var ctrlVal = ctrl.GetValue();
                                        val.push('"' + ctrlVal + '"');
                                    }
                                    else if (ctrlKey == 'FormFormula') {
                                        var ctrlVal = ctrl.GetValue();
                                        val.push('"' + ctrlVal + '"');
                                    } else {
                                        //其他类型控件，取值后判断是否是输入，不是数字则转成字符串
                                        var ctrlVal = ctrl.GetValue();
                                        if ($.isNumeric(ctrlVal)) {
                                            val.push(ctrlVal);
                                        } else {
                                            val.push('"' + ctrlVal + '"');
                                        }
                                    }
                                } else {
                                    val.push(ctrlKey == "FormNumber" ? 0 : "''");
                                }
                            }
                        } else {
                            // 当出现如 $.fn.COUNT({}) 这样的表达式时，将其替换成 $.fn.COUNT(),防止当子表中没有行时还返回 1 的错误结果
                            var tempRegex = new RegExp("\\$\\.fn\\.COUNT\\(\\{" + ctrlField.replace(".", "\\.") + "\\}\\)", "g");
                            ruleTemp = ruleTemp.replace(tempRegex, "$.fn.COUNT()");
                            val.push('""');
                        }
                    } else {//行内字段计算规则
                        //配置字段在子表，规则字段在子表
                        //eidt byxc 优化不需要选择整列再筛选，直接渠道对应的单元格
                        var childSchemaName1 = this.DataField.slice(0, this.DataField.indexOf("."));//当前子表
                        var childSchemaName2 = ctrlField.slice(0, ctrlField.indexOf("."));//规则字段子表
                        if (childSchemaName1 == childSchemaName2) {
                            //同一个子表，取与当前字段在同一行的字段
                            var ctrls = $(this.Element).closest("tr").find("div.sheet-control[data-controlkey][data-datafield='" + ctrlField + "']");
                            if (ctrls.length == 0) continue;
                            var ctrlKey = ctrls.attr('data-controlkey');
                            var ctrl = ctrls.JControl();
                            if (ctrl) {
                                if (ctrlKey == 'FormNumber' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Number)) {
                                    val.push(ctrl.GetNum());
                                } else if (ctrlKey == 'FormCheckbox' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Bool)) {
                                    val.push(ctrl.GetValue());
                                } else if (ctrlKey == 'FormTextBox') {
                                    var v = ctrl.GetValue();
                                    v = v.replace(/"/g, '\\"');
                                    val.push('"' + v + '"');
                                    //val.push('"' + ctrl.GetValue() + '"');
                                } else if (ctrlKey == 'FormTextArea') {
                                    var v = ctrl.GetValue().replace(/[\r\n]/g, "");
                                    v = v.replace(/"/g, '\\"');
                                    val.push('"' + v + '"');
                                    //val.push('"' + ctrl.GetValue().replace(/[\r\n]/g, "") + '"');
                                } else if (ctrlKey == 'FormUser') {
                                    var uid = ctrl.GetUnitIDs()[0];
                                    val.push('"' + (uid == undefined ? "" : uid) + '"');
                                } else if (ctrlKey == 'FormMultiUser') {
                                    //不支持多人
                                    val.push('""');
                                } else if (ctrlKey == 'FormFormula') {
                                    var ctrlVal = ctrl.GetValue();
                                    val.push('"' + ctrlVal + '"');
                                }
                                else if (ctrlKey == 'FormDateTime') {
                                    var ctrlVal = ctrl.GetValue();
                                    val.push('"' + ctrlVal + '"');
                                }
                                else {
                                    var ctrlVal = ctrl.GetValue();
                                    if ($.isNumeric(ctrlVal)) {
                                        val.push(ctrlVal);
                                    } else {
                                        val.push('"' + ctrlVal + '"');
                                    }
                                }
                            } else {
                                val.push(ctrlKey == "FormNumber" ? 0 : "''");
                            }
                        } else {
                            //跨子表
                            var ctrls = $("div.sheet-control[data-controlkey][data-datafield='" + ctrlField + "']").not('.table_th');
                            if (ctrls.length > 0) {
                                for (var i = 0; i < ctrls.length; i++) {
                                    var ctrlKey = $(ctrls[i]).attr("data-controlkey");
                                    var ctrl = $(ctrls[i]).JControl();
                                    if (ctrl) {
                                        if (ctrlKey == 'FormNumber' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Number)) {
                                            val.push(ctrl.GetNum());
                                        } else if (ctrlKey == 'FormCheckbox' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Bool)) {
                                            val.push(ctrl.GetValue());
                                        } else if (ctrlKey == 'FormTextBox') {
                                            var v = ctrl.GetValue();
                                            v = v.replace(/"/g, '\\"');
                                            val.push('"' + v + '"');
                                            //val.push('"' + ctrl.GetValue() + '"');
                                        } else if (ctrlKey == 'FormTextArea') {
                                            var v = ctrl.GetValue().replace(/[\r\n]/g, "");
                                            v = v.replace(/"/g, '\\"');
                                            val.push('"' + v + '"');
                                            //val.push('"' + ctrl.GetValue().replace(/[\r\n]/g, "") + '"');
                                        } else if (ctrlKey == 'FormUser') {
                                            var uid = ctrl.GetUnitIDs()[0];
                                            val.push('"' + (uid == undefined ? "" : uid) + '"');
                                        } else if (ctrlKey == 'FormMultiUser') {
                                            //不支持多人
                                            val.push('""');
                                        } else if (ctrlKey == 'FormFormula') {
                                            var ctrlVal = ctrl.GetValue();
                                            val.push('"' + ctrlVal + '"');
                                        }
                                        else if (ctrlKey == 'FormDateTime') {
                                            var ctrlVal = ctrl.GetValue();
                                            val.push('"' + ctrlVal + '"');
                                        } else {
                                            var ctrlVal = ctrl.GetValue();
                                            if ($.isNumeric(ctrlVal)) {
                                                val.push(ctrlVal);
                                            } else {
                                                val.push('"' + ctrlVal + '"');
                                            }
                                        }
                                    } else {
                                        val.push(ctrlKey == "FormNumber" ? 0 : "''");
                                    }
                                }
                            } else {
                                val.push('""');
                            }
                        }
                    }
                } else {
                    //非子表字段
                    var ctrl = $('div.sheet-control[data-controlkey][data-datafield="' + ctrlField + '"]');
                    var id = sessionStorage.getItem("tabAppId");
                    for (var i = 0; i < ctrl.length; i++) {
                        var temp = ctrl.eq(i).JControl();
                        if (temp && temp.SchemaCode == id) {
                            ctrl = ctrl.eq(i)
                            break;
                        }
                    }

                    if (ctrl.length > 0) {
                        ctrl = ctrl.eq(0)
                    }
                    var ctrlKey = ctrl.attr('data-controlkey');
                    ctrl = ctrl.JControl();
                    if (ctrl) {
                        if (ctrlKey == 'FormNumber' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Number)) {
                            val.push(ctrl.GetNum());
                        } else if (ctrlKey == 'FormTextBox') {
                            var v = ctrl.GetValue();
                            v = v.replace(/"/g, '\\"');
                            val.push('"' + v + '"');
                            //val.push('"' + ctrl.GetValue() + '"');
                        } else if (ctrlKey == 'FormTextArea') {
                            var v = ctrl.GetValue().replace(/[\r\n]/g, "");
                            v = v.replace(/"/g, '\\"');
                            val.push('"' + v + '"');
                            //val.push('"' + ctrl.GetValue().replace(/[\r\n]/g, "") + '"');
                        } else if (ctrlKey == void 0) {
                            if (ctrlField == 'CreatedBy') {
                                val.push('"' + $.SmartForm.ResponseContext.Originator + '"');
                            } else if (ctrlField == 'CreatedTime') {
                                val.push('"' + $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value + '"');
                            } else if (ctrlField == 'ModifiedTime') {
                                var modifiedTime = $.SmartForm.ResponseContext.ReturnData.ModifiedTime.Value;
                                val.push(modifiedTime == void 0 ? "''" : modifiedTime);
                            }
                        } else if (ctrlKey == 'FormLabel') {
                            if (ctrlField == 'CreatedTime') {
                                val.push('"' + $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value + '"');
                            } else if (ctrlField == 'ModifiedTime') {
                                var modifiedTime = $.SmartForm.ResponseContext.ReturnData.ModifiedTime.Value;
                                val.push(modifiedTime == void 0 ? "''" : modifiedTime);
                            }
                        } else if (ctrlKey == 'OwnerId') {
                            val.push('"' + $.SmartForm.ResponseContext.ReturnData.OwnerId.Value[0].UnitId + '"');
                        } else if (ctrlKey == 'FormAreaSelect') {
                            val.push("'" + ctrl.GetValue() + "'");
                        } else if (ctrlKey == 'FormCheckbox' || (ctrlKey == "FormFormula" && ctrl.BindType == ctrl.BindControlType.Bool)) {
                            val.push(ctrl.GetValue());
                        } else if (ctrlKey == 'FormUser') {
                            if (ctrl.GetUnitIDs) {
                                var uid = ctrl.GetUnitIDs()[0];
                                val.push('"' + (uid == undefined ? "" : uid) + '"');
                            }
                        } else if (ctrlKey == 'FormMultiUser') {
                            //不支持多人
                            val.push('""');
                        } else if (ctrlKey == 'FormFormula') {
                            var ctrlVal = ctrl.GetValue();
                            val.push('"' + ctrlVal + '"');
                        }
                        else if (ctrlKey == 'FormDateTime') {
                            var ctrlVal = ctrl.GetValue();
                            val.push('"' + ctrlVal + '"');
                        } else {
                            //其他类型控件，取值后判断是否是输入，不是数字则转成字符串
                            var ctrlVal = ctrl.GetValue();
                            if ($.isNumeric(ctrlVal)) {
                                val.push(ctrlVal);
                            } else {
                                val.push('"' + ctrlVal + '"');
                            }
                        }
                    } else {
                        if (ctrlField == 'CreatedTime') { //创建时间
                            val.push('"' + $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value + '"');
                        } else if (ctrlField == 'ModifiedTime') { //修改时间
                            var modifiedTime = $.SmartForm.ResponseContext.ReturnData.ModifiedTime.Value;
                            val.push(modifiedTime == void 0 ? "''" : modifiedTime);
                        } else if (ctrlField == "CreatedBy") { //创建人
                            val.push('"' + $.SmartForm.ResponseContext.Originator + '"');
                        } else if (ctrlField == "OwnerId") { //拥有者
                            val.push('"' + $.SmartForm.ResponseContext.ReturnData.OwnerId.Value[0].UnitId + '"');
                        } else if (ctrlField == "OwnerDeptId") { //所属部门
                            val.push('"' + $.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0].UnitId + '"');
                        } else {
                            val.push("''");
                        }
                    }
                }
                var replaceField = '{' + ctrlField + '}';
                var reg = new RegExp(replaceField, 'g');
                ruleTemp = ruleTemp.replace(reg, val);
            }
            if (this.Type == 7) {
                //数值类型为了保证精度用逆波兰表达式计算
                var expression = await this.CalculateFn(ruleTemp);
                expression = expression.replace(/\(/g, " ( ").replace(/\)/g, " ) ");
                var ret = this.CalcExpression(expression);
                return ret;
            } else {
                // if(ruleTemp.indexOf('(')>=0){
                //     ruleTemp= ruleTemp.substr(0,ruleTemp.indexOf('('))
                // }
                // // var tmp =$.fn[ruleTemp]
                // //return new Function('return ' + ruleTemp)();
                var tmp = new Function('$', 'return ' + ruleTemp)($);
                console.log(tmp);
                return tmp
            }
        },
        // 计算隐藏规则表达式结果
        GetHideRuleResult: function (rule, fields) {

            //如果字段权限设置了不可见，则隐藏规则不生效
            if (this.Visible == false) {
                return true;
            }
            if (rule == null) {
                return false;
            }
            var ruleTemp = rule;
            for (var j = 0, len = fields.length; j < len; j++) {
                //需要考虑字段是子表情况
                var ctrlField = fields[j];
                var val = [];
                if (ctrlField.indexOf('.') > -1) {
                    //子表字段
                    var ctrls = [];
                    if (this.DataField.indexOf('.') > -1) {
                        //当前字段也是子表字段
                        ctrls = $($(this.Element).closest('tr')).find('div.sheet-control[data-datafield="' + ctrlField + '"]');
                    } else {
                        ctrls = $('div.sheet-control[data-controlkey][data-datafield="' + ctrlField + '"]:not(.table_th)');
                    }
                    var ctrlKey = ctrls.attr('data-controlkey');
                    for (var childFieldIndex = 0, childFieldLen = ctrls.length; childFieldIndex < childFieldLen; childFieldIndex++) {
                        var jCtrl = $(ctrls[childFieldIndex]).JControl();
                        if (jCtrl) {
                            if (ctrlKey == 'FormNumber') {
                                val.push(jCtrl.GetNum());
                            } else if (ctrlKey == 'FormTextBox') {
                                var v = jCtrl.GetValue();
                                val.push(v == "" ? "''" : ("'" + v + "'"));
                            } else if (ctrlKey == 'FormTextArea') {
                                var v = jCtrl.GetValue() + "";
                                val.push('"' + v.replace(/[\r\n]/g, "") + '"');
                            } else if (ctrlKey == 'FormUser' || ctrlKey == 'FormMultiUser') {
                                var units = jCtrl.GetUnitIDs();
                                if (units != null && units != void 0 && units != '') {
                                    for (var i = 0; i < units.length; i++) {
                                        val.push('"' + units[i] + '"');
                                    }
                                } else { val.push('""'); }
                            } else if (ctrlKey == 'FormAreaSelect') {
                                var area = jCtrl.GetValue();
                                val.push(area == '' ? '""' : ("'" + area + "'"));
                            } else if (ctrlKey == 'FormAttachment' || ctrlKey == 'FormPhoto') {
                                var attach = jCtrl.GetValue();
                                if (attach == void 0 || attach == "") {
                                    val.push("''");
                                } else {
                                    val.push(attach.AttachmentIds == '' ? "''" : ('"' + attach.AttachmentIds + '"'));
                                }
                            } else if (ctrlKey == 'FormCheckbox') {
                                var c = jCtrl.GetValue();
                                val.push(c);
                            } else if (ctrlKey == 'FormDropDownList') {
                                var dropDown = jCtrl.GetValue();
                                if (dropDown == void 0 || dropDown == "") {
                                    val.push("''");
                                } else {
                                    val.push('"' + dropDown + '"');
                                }
                            } else {
                                //其他类型控件，取值后判断是否是输入，不是数字则转成字符串
                                var ctrlVal = jCtrl.GetValue();
                                if ($.isNumeric(ctrlVal)) {
                                    val.push(ctrlVal);
                                } else {
                                    val.push((ctrlVal == void 0 || ctrlVal == '') ? '""' : ('"' + ctrlVal + '"'));
                                }
                            }
                        } else {
                            val.push('""');
                        }
                    }
                } else {
                    //非子表字段
                    var ctrl = $('div.sheet-control[data-datafield="' + ctrlField + '"]');
                    if (ctrl.length > 0) {
                        ctrl = ctrl.eq(ctrl.length - 1);
                    }
                    var ctrlKey = ctrl.attr('data-controlkey');
                    var jCtrl = ctrl.JControl();
                    if (ctrlKey == 'FormNumber') {
                        val.push(jCtrl == undefined ? 0 : jCtrl.GetNum());
                    } else if (ctrlKey == 'FormTextBox') {
                        var v = jCtrl == undefined ? "" : jCtrl.GetValue();
                        val.push(v == '' ? "''" : ('"' + v + '"'));
                    } else if (ctrlKey == 'FormTextArea') {
                        var v = jCtrl == undefined ? "" : jCtrl.GetValue();
                        val.push(v == '' ? "''" : ('"' + v.replace(/[\r\n]/g, "") + '"'));
                    } else if (ctrlKey == 'FormUser' || ctrlKey == 'FormMultiUser') {
                        var units = jCtrl == undefined ? "" : jCtrl.GetUnitIDs();
                        if (units != null && units != void 0 && units != "") {
                            for (var i = 0; i < units.length; i++) {
                                val.push('"' + units[i] + '"');
                            }
                        } else {
                            val.push('""');
                        }
                    } else if (ctrlKey == 'FormAreaSelect') {
                        var area = jCtrl == undefined ? "" : jCtrl.GetValue();
                        val.push(area == '' ? '""' : ("'" + area + "'"));
                    } else if (ctrlKey == 'FormAttachment' || ctrlKey == 'FormPhoto') {
                        var attach = jCtrl == undefined ? "" : ctrl.JControl().GetValue();
                        if (attach == "") {
                            val.push("''");
                        } else {
                            val.push('"' + attach.AttachmentIds + '"');
                        }
                    } else if (ctrlKey == 'FormCheckbox') {
                        var c = jCtrl == undefined ? "" : jCtrl.GetValue();
                        val.push(c);
                    } else if (ctrlKey == 'FormDropDownList') {
                        var dropDown = jCtrl == undefined ? "" : jCtrl.GetValue();
                        val.push(dropDown == null ? '""' : ('"' + dropDown + '"'));
                    } else if (ctrlKey == 'FormLabel') {
                        if (ctrlField == 'CreatedTime') {
                            val.push('"' + $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value + '"');
                        } else if (ctrlKey == 'ModifiedTime') {
                            var modifiedTime = $.SmartForm.ResponseContext.ReturnData.ModifiedTime.Value;
                            val.push(modifiedTime == void 0 ? "''" : modifiedTime);
                        }
                    } else {
                        //createdby
                        if (ctrlKey == void 0) {
                            if (ctrlField == 'CreatedBy')
                                val.push('"' + $.SmartForm.ResponseContext.Originator + '"');
                            else if (ctrlField == 'OwnerId') {
                                val.push('"' + $.SmartForm.ResponseContext.ReturnData.OwnerId.Value[0].UnitId + '"');
                            } else if (ctrlField == 'OwnerDeptId') {
                                val.push('"' + $.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0].UnitId + '"');
                            }
                        } else {
                            //其他类型控件，取值后判断是否是数字，不是数字则转成字符串
                            for (var childFieldIndex = 0, childFieldLen = ctrl.length; childFieldIndex < childFieldLen; childFieldIndex++) {
                                var jCtrl = $(ctrl[childFieldIndex]).JControl();
                                var ctrlVal = jCtrl == undefined ? "" : jCtrl.GetValue();
                                if ($.isNumeric(ctrlVal)) {
                                    val.push(ctrlVal);
                                } else {
                                    if (ctrlVal) {
                                        val.push("'" + ctrlVal + "'");
                                    } else {
                                        val.push("''");
                                    }
                                }
                            }
                        }
                    }
                }
                var replaceField = '{' + ctrlField + '}';
                var reg = new RegExp(replaceField, 'g');
                ruleTemp = ruleTemp.replace(reg, val);
            }
            return ruleTemp;
        },
        SetHideResult: function (rule, fields, canHideColumn) {
            var startIndex = 0;
            var ruleTemp = this.GetHideRuleResult(rule, fields) + '';
            while (ruleTemp.indexOf("$.fn.", startIndex) > -1) {
                var fnIndex = ruleTemp.indexOf("$.fn.", startIndex);
                var leftBracket = ruleTemp.indexOf("(", fnIndex + 1);//左括号位置
                var rightBracket = ruleTemp.indexOf(")", leftBracket + 1);//右括号位置
                leftBracket = ruleTemp.indexOf("(", leftBracket + 1);//下一个左括号位置
                while (leftBracket > -1 && rightBracket > leftBracket) {
                    rightBracket = ruleTemp.indexOf(")", rightBracket + 1);
                    leftBracket = ruleTemp.indexOf("(", leftBracket + 1);
                }
                //截取fnIndex到rightBracket之间的字符串为函数体
                //先把函数计算出来，再替换到表达式中
                ruleTemp.slice(fnIndex, rightBracket + 1);
                startIndex = rightBracket + 1;
            }

            var fun = new Function("$", "return " + ruleTemp)($);

            if (!fun) {
                this.SetVisible(true);
            } else {
                this.SetVisible(false);
                if (canHideColumn) {
                    this.HideColumn(true);
                }
            }
            this.HidePreHeaderTitle();
        },
        //只用于主表字段隐藏子表列使用
        //子表字段隐藏规则配置了主表字段，当条件满足时候隐藏子表列
        HideColumn: function (hide) {
            //Error 这里逻辑要重新整理
            if (!hide && !this.Visible) {
                return;
            }
            var dataField = this.DataField;
            var thatCtrl = $('div.sheet-control[data-controlkey][data-datafield="' + dataField + '"]');
            var table = thatCtrl.closest('.SheetGridView').find('.table-body table');
            if (table != void 0 && table.length > 0) {
                var th = table.find('div.sheet-control[data-datafield="' + dataField + '"][class*="table_th"]').parent();
                var td = $('div.sheet-control[data-controlkey][data-datafield="' + dataField + '"]:not(".table_th")').parent();
                if (!hide) {
                    //PC端
                    $(td).show();
                    $(th).show();
                    $(th).trigger('DomProChange.form', dataField);
                } else {
                    //PC端
                    $(td).hide();
                    $(th).hide();
                    $(th).trigger('DomProChange.form', [dataField, 'hide']);
                }
            }
        },
        InitHideRule: function () {
            //如果不在表单中不要执行
            if (!$(this.Element).hasClass('sheet-control')) {
                return;
            }
            //如果有新的规则则使用新的，否则判断是否有旧规则
            var that = this;
            if (this.DataItem != null && this.DataItem.DisplayRule) {
                var rule = ''//规则表达式
                rule = this.DataItem.DisplayRule;
                try {
                    let start = 0
                    let item = this.DataItem.DisplayRule.indexOf('u(', start)
                    while (item >= 0 && start < this.DataItem.DisplayRule.length) {
                        this.DataItem.DisplayRule = this.DataItem.DisplayRule.slice(0, item + 2) + "'" + this.DataItem.DisplayRule.slice(item + 2);
                        var key = this.DataItem.DisplayRule.indexOf(')', item + 2);
                        this.DataItem.DisplayRule = this.DataItem.DisplayRule.slice(0, key) + "'" + this.DataItem.DisplayRule.slice(key);
                        start = key + 1;
                        item = this.DataItem.DisplayRule.indexOf('u(', start)
                    }

                    start = 0;
                    item = this.DataItem.DisplayRule.indexOf('o(', start)
                    while (item >= 0 && start < this.DataItem.DisplayRule.length) {
                        this.DataItem.DisplayRule = this.DataItem.DisplayRule.slice(0, item + 2) + "'" + this.DataItem.DisplayRule.slice(item + 2);
                        var key = this.DataItem.DisplayRule.indexOf(')', item + 2);
                        this.DataItem.DisplayRule = this.DataItem.DisplayRule.slice(0, key) + "'" + this.DataItem.DisplayRule.slice(key);
                        start = key + 1;
                        item = this.DataItem.DisplayRule.indexOf('o(', start)
                    }
                    while (rule.indexOf("u(") >= 0 || rule.indexOf("o(") >= 0) {
                        rule = this.DataItem.DisplayRule.replace(/[uo]\((.*?)\)/, "$1")
                    }
                }
                catch (e) {
                    console.log(e);
                    rule = this.DataItem.DisplayRule;
                }
                var re = /{(.*?)}/g;
                var newArray = [];
                var temp = [];
                while (temp = re.exec(rule)) {
                    newArray.push(temp[1])
                }
                var fields = newArray;//规则中引用的字段

                //如果规则中没有子表字段且当前字段是子表字段则为true
                //1.先要确定当前控件是否是子表控件
                //2.判断规则中的控件是否都是主表控件
                var canHideColumn = (that.DataField.indexOf('.') > -1) && that.DataField != 'CreatedBy.FullName';
                if (canHideColumn) {
                    for (var i = 0; i < fields.length; i++) {
                        var field = fields[i];
                        if (field.indexOf('.') > -1) {
                            //规则中字段是子表字段，不隐藏该列
                            canHideColumn = false;
                            break;
                        }
                    }
                }
                //如果that是子表控件，且fields里面全是主表字段或者常量，则当子表控件不可见的时候隐藏该列
                if (fields.length == 0) {
                    //规则中没有字段，直接执行
                    that.SetHideResult(rule, fields, canHideColumn);
                    return;
                }

                //给规则中引用到的字段绑定change事件
                for (var i = 0; i < fields.length; i++) {
                    var field = fields[i];
                    if (field == 'CreatedBy') {
                        field += '.FullName';
                    }
                    var ctrl = $('div.sheet-control[data-datafield="' + field + '"]');
                    if (field.indexOf(".") > -1) {
                        if (this.DataField.indexOf(".") > -1) {
                            //规则中字段在子表,配置的字段在子表
                            var eventName = "change.hr." + this.ObjectId + "." + this.DataField;
                            var $ctrl = $(this.Element).closest("tr").find("div.sheet-control[data-controlkey][data-datafield='" + field + "']");
                            if ($ctrl && $ctrl.length > 0) {
                                var controlMgr = $ctrl.JControl();
                                controlMgr && controlMgr.BindChange(eventName, function () {
                                    that.SetHideResult(rule, fields);
                                });
                                if (that.ResponseContext.IsCreateMode || that.Value == null) {
                                    controlMgr && controlMgr.ChangeEvents[eventName].apply(this);
                                }
                            }
                        } else {
                            //规则中字段在子表,配置的字段在主表
                            //子表删除/添加行会触发子表Change，将field的事件绑定放到子表Change事件中
                            var eventName = "change.hr." + this.DataField;
                            var gridMgr = $("div.sheet-control[data-datafield='" + field.slice(0, field.indexOf(".")) + "']").JControl();
                            //给子表上对应列绑定Change事件
                            var tdCtrl = $("div.sheet-control[data-controlkey][data-datafield='" + field + "']:not('.table_th')");
                            for (var j = 0; j < tdCtrl.length; j++) {
                                var controlMgr = $(tdCtrl[j]).JControl();
                                if (controlMgr) {
                                    controlMgr.UnbindChange(eventName);
                                    controlMgr.BindChange(eventName, function () {
                                        that.SetHideResult(rule, fields);
                                    });
                                    if (that.ResponseContext.IsCreateMode || that.Value == null) {
                                        controlMgr.ChangeEvents[eventName].apply($(tdCtrl[j]));
                                    }
                                }
                            }
                            if (gridMgr) {
                                gridMgr.UnbindChange(eventName);
                                gridMgr.BindChange(eventName, function (args) {
                                    if (window[eventName]) {
                                        window.clearTimeout(window[eventName]);
                                        window[eventName] = null;
                                    }
                                    window[eventName] = setTimeout(function () {
                                        that.SetHideResult(rule, fields);
                                    }, 600);
                                });
                                if (that.ResponseContext.IsCreateMode || that.Value == null) {
                                    gridMgr.ChangeEvents[eventName].apply(this);
                                }
                            }
                        }
                    } else {
                        var ruleCtrl = ctrl.JControl();
                        if (ruleCtrl) {
                            ruleCtrl.BindChange('change.' + this.DataField, function () {
                                var ruleTemp = that.GetHideRuleResult(rule, fields) + '';
                                var startIndex = 0
                                while (ruleTemp.indexOf("$.fn.", startIndex) > -1) {
                                    var fnIndex = ruleTemp.indexOf("$.fn.", startIndex);
                                    var leftBracket = ruleTemp.indexOf("(", fnIndex + 1);//左括号位置
                                    var rightBracket = ruleTemp.indexOf(")", leftBracket + 1);//右括号位置
                                    leftBracket = ruleTemp.indexOf("(", leftBracket + 1);//下一个左括号位置
                                    while (leftBracket > -1 && rightBracket > leftBracket) {
                                        rightBracket = ruleTemp.indexOf(")", rightBracket + 1);
                                        leftBracket = ruleTemp.indexOf("(", leftBracket + 1);
                                    }
                                    //截取fnIndex到rightBracket之间的字符串为函数体
                                    //先把函数计算出来，再替换到表达式中
                                    ruleTemp.slice(fnIndex, rightBracket + 1);
                                    startIndex = rightBracket + 1;
                                }
                                var fun = new Function("$", "return " + ruleTemp)($);
                                // 代码内嵌
                                if (+that.Type === 49) {
                                    const $formEmbedCodeEl = $('div.formEmbedCode[data-datafield="' + that.DataField + '"]');
                                    if (!fun) {
                                        $formEmbedCodeEl.show()
                                    } else {
                                        $formEmbedCodeEl.hide()
                                    }
                                } else {
                                    var thatCtrl = $('div.sheet-control[data-datafield="' + that.DataField + '"]:not(".table_th")');
                                    for (var m = 0; m < thatCtrl.length; m++) {
                                        var jCtrl = $(thatCtrl[m]).JControl();
                                        jCtrl && jCtrl.SetVisible(!fun);
                                    }
                                }
                                if (!fun) {
                                    if (canHideColumn) {
                                        that.HideColumn(false);
                                    }
                                } else {
                                    if (canHideColumn) {
                                        that.HideColumn(true);
                                    }
                                }
                                that.HidePreHeaderTitle();
                            });
                        }
                    }
                }
                var ruleTemp = this.GetHideRuleResult(rule, fields) + '';
                var startIndex = 0
                while (ruleTemp.indexOf("$.fn.", startIndex) > -1) {
                    var fnIndex = ruleTemp.indexOf("$.fn.", startIndex);
                    var leftBracket = ruleTemp.indexOf("(", fnIndex + 1);//左括号位置
                    var rightBracket = ruleTemp.indexOf(")", leftBracket + 1);//右括号位置
                    leftBracket = ruleTemp.indexOf("(", leftBracket + 1);//下一个左括号位置
                    while (leftBracket > -1 && rightBracket > leftBracket) {
                        rightBracket = ruleTemp.indexOf(")", rightBracket + 1);
                        leftBracket = ruleTemp.indexOf("(", leftBracket + 1);
                    }
                    //截取fnIndex到rightBracket之间的字符串为函数体
                    //先把函数计算出来，再替换到表达式中
                    ruleTemp.slice(fnIndex, rightBracket + 1);
                    startIndex = rightBracket + 1;
                }

                var func = new Function("$", "return " + ruleTemp)($);
                if (!func) {
                    that.SetVisible(true);
                    if (canHideColumn) {
                        that.HideColumn(false);
                    }
                } else {
                    that.SetVisible(false);
                    if (canHideColumn) {
                        that.HideColumn(true);
                    }
                }
                // 代码内嵌
                if (+that.Type === 49) {
                    that.FormEmbedCodeVisible = !func
                }
            } else if (this.DisplayRule) {//兼容旧的规则
                if (this.DisplayRule.RuleDataField != void 0) {
                    //旧的
                    var $controls = $('div.sheet-control[data-datafield="' + this.DisplayRule.RuleDataField + '"]');
                    if (this.DataField.toString().indexOf('.') > -1) {
                        $controls = $(this.Element).closest('tr').find('div.sheet-control[data-datafield="' + this.DisplayRule.RuleDataField + '"]');
                    }
                    var ruleControl = $controls.JControl();
                    if (ruleControl) {
                        ruleControl.BindChange('OnChange.' + this.DataField, function () {
                            if (this.GetValue() + '' == that.DisplayRule.RuleValue) {
                                that.SetVisible(true);
                            } else {
                                that.SetVisible(false);
                            }
                        });
                        ruleControl.OnChange();
                    }
                }
            }
        },
        //如果控件设置了不可见，且控件后面没有可见控件，则隐藏控件前面的标题栏
        HidePreHeaderTitle: function () {
            var $headerDescribles, $headerTitles;
            if (this.ResponseContext.SheetView) {//移动端
                $headerDescribles = $(this.ResponseContext.SheetView).find(".page-header.page-describle");
                $headerTitles = $(this.ResponseContext.SheetView).find(".page-header").not(".page-describle");
            } else {//pc端
                $headerDescribles = $(".page-header.page-describle");
                $headerTitles = $(".page-header").not(".page-describle");
            }
            $headerTitles.css("display", "block");
            $headerDescribles.css("display", "block");
            $.SmartForm.HideEmptyHeader();
        },

        // 增加验证消息显示
        AddInvalidText: function ($el, invalidText) {
            $el = $el || $(this.Element);
            this.invalidText = invalidText;
            //单选框，复选框
            if ($el.length > 0 && $el[0].tagName.toLowerCase() === "label") {
                $el.closest(".radiolistwrap").css({
                    "border": "1px solid red ",
                    "box-shadow": "0 0 3px rgba(255,0,0,0.7)"
                });
            } else {
                if (($el.length > 0 && $el[0].tagName.toLowerCase() === "select") || $(this.Element).data("controlkey") == "FormDropDownList") {
                    //下拉框
                    $el.css({
                        "outline": "1px solid red ",
                        "box-shadow": "0 0 3px rgba(255,0,0,0.7)"
                    }).siblings(".btn-group").css({
                        "outline": "1px solid red ",
                        "box-shadow": "0 0 3px rgba(255,0,0,0.7)"
                    });
                    $el.prev("span").css({
                        "outline": "1px solid red ",
                        "box-shadow": "0 0 3px rgba(255,0,0,0.7)"
                    });
                } else if ($el.find(".AreaSelectWrap").length > 0) {
                    //地址
                    $el.find(".AreaSelectWrap").css({
                        "border": "1px solid red",
                        "box-shadow": "0 0 3px rgba(255,0,0,0.7)"
                    });
                }
                //其它
                else if ($el.attr("class") && $el.attr("class").indexOf("col-") > -1) {
                    $el.find(".form-control").css({
                        "border": "1px solid red",
                        "box-shadow": "0 0 3px rgba(255,0,0,0.7)"
                    });
                } else {
                    $el.css({
                        "border": "1px solid red",
                        "box-shadow": "0 0 3px rgba(255,0,0,0.7)"
                    });
                }
            }
            $el.addClass('invalid');//添加这个类的目的是判断控件是否校验过，并无样式


            if (invalidText != "必填" && invalidText.length > 0) {
                //top.$.IShowWarn("抱歉，[" + this.DisplayName + "]选项" + invalidText);
                Message.warning({
                    content: ("抱歉，[" + this.DisplayName + "]选项" + invalidText),
                    duration: 3
                });
            }

            //add by xc定位到相应位置
            var Offset = $el.offset();
            var Top = Offset.top - $(window).scrollTop();
            if (Top > $(window).height()) {
                $(window).scrollTop(Offset.top + $el.outerHeight() - $(window).height());
            } else if (Top < 0) {
                $(window).scrollTop(Offset.top - 40);
            }
            //子表内部定位
            var $par = $el.closest(".SheetGridView[data-controlkey='FormGridView']");
            if ($par.length > 0) {
                var $scroll = $par.find("div.table-scroll");
                var Left = Offset.left - $par.scrollLeft() - $par.width();
                if (Left > 5) {
                    $scroll.scrollLeft(Offset.left + $el.outerWidth() - $par.width() + 100);
                }
            }
        },

        // 移除验证显示信息
        RemoveInvalidText: function ($el) {
            $el = $el || $(this.Element);
            this.invalidText = "";
            $el.removeClass('invalid').css({ "border": "", "box-shadow": "" });
            //if (($el.length > 0 && $el[0].tagName.toLowerCase() === "select") || $(this.Element).data("controlkey") == "FormDropDownList") {
            //    $el.siblings(".btn-group").removeClass('invalid');
            //    $el.siblings(".btn-group").css({ "border": "", "outline": "", "box-shadow": "" });
            //    $el.prev("span").removeClass('invalid');
            //    $el.prev("span").css({ "outline": "", "box-shadow": "" });
            //}

            if ($el.length > 0 && $el[0].tagName.toLowerCase() === "label") {
                $el.closest(".radiolistwrap").css({ "border": "", "box-shadow": "" });
            } else {
                if ($el.length > 0 && $el[0].tagName.toLowerCase() === "select" || $(this.Element).data("controlkey") == "FormDropDownList") {
                    $el.css({ "outline": "", "box-shwdow": "" }).siblings(".btn-group").css({ "outline": "", "box-shadow": "" });
                    $el.prev("span").css({ "outline": "", "box-shadow": "" });
                } else if ($el.find(".AreaSelectWrap").length > 0) {
                    //地址
                    $el.find(".AreaSelect").css({ "border": "", "box-shadow": "" });
                } else if ($el.attr("class") && $el.attr("class").indexOf("col-") > -1) {
                    $el.find(".form-control").css({ "border": "", "box-shadow": "" });
                } else {
                    $el.css({ "border": "", "box-shadow": "" });
                }
            }
        },

        // 控件的保存函数
        SaveDataField: function () {
            return {
            };
        },

        // 获取值
        GetValue: function () {
            return this.$InputBody.val();
        },

        //设置值:复杂控件必须重写该接口
        SetValue: function (obj) {
            this.$InputBody.val(obj);
        },

        // 对应复杂控件，Value可能是ID或Code，但是Text是显示名称
        GetText: function () {
            return this.$InputBody.text();
        },

        //设置是否可编辑
        SetReadonly: function (flag) {
        },

        //设置是否可见
        SetVisible: function (flag) {
            var lastVisible = this.Visible || $(this.Element).css('visibility') == 'visible';
            var $el = $(this.Element);
            if (flag) {
                //Error:如果原来是隐藏的话，有可能控件就没渲染，需要渲染后在显示
                //如果权限控制了visible则不执行隐藏规则的结果
                //edit by xc
                if (this.DataField.indexOf(".") == -1 || this.DataField == 'CreatedBy.FullName') {
                    $el.show();
                } else {
                    $el.css("visibility", 'visible');
                }
                //end
                if (($el.attr('data-controlkey') == 'FormTextBox' || $el.attr('data-controlkey') == 'FormTextArea') && !this.Editable) {
                    $el.find('pre').css('border', 'none');
                }
                //如果控件有计算规则，要重新计算
                if (this.DataItem.ComputationRule && lastVisible == false) {
                    var rule = this.DataItem.ComputationRule;
                    var fields = this.DataItem.ComputationRuleFields;
                    $("#navbar").css("pointer-events","none");
                    var ret = this.GetComputationResult(rule, fields);
                    this.SetValue(ret);
                    $("#navbar").css("pointer-events","auto");
                }
                if (this.$Element && this.$Element.attr("data-controlkey") == "FormGridView") {
                    this.AdapteHeight();
                }
            } else {
                //先清除再隐藏
                if (($.SmartForm.IsLoaded || this.ResponseContext.IsCreateMode) && this.Editable) {
                    // 表单加载完，才隐藏清空值
                    this.ClearValue();
                }
                //edit by xc
                if (this.DataField.indexOf(".") == -1 || this.DataField == 'CreatedBy.FullName') {
                    $el.hide();
                } else {
                    $el.css("visibility", 'hidden');
                }
            }
        },

        //中缀表达式解析成后缀表达式
        //1）如果遇到操作数，我们就直接将其输出。
        //2）如果遇到操作符，则我们将其放入到栈中，遇到左括号时我们也将其放入栈中。
        //3）如果遇到一个右括号，则将栈元素弹出，将弹出的操作符输出直到遇到左括号为止。注意，左括号只弹出并不输出。
        //4）如果遇到任何其他的操作符，如（“+”， “*”，“（”）等，从栈中弹出元素直到遇到发现更低优先级的元素(或者栈为空)为止。弹出完这些元素后，才将遇到的操作符压入到栈中。有一点需要注意，只有在遇到" ) "的情况下我们才弹出" ( "，其他情况我们都不会弹出" ( "。
        //5）如果我们读到了输入的末尾，则将栈中所有元素依次弹出。
        ParseExpression: function (expression) {
            //输入的表达式每一个运算数和运算符之间都会是空格分割
            //先将表达式分割成数组并去掉空的
            if (expression.indexOf("*") >= 0) {
                expression = expression.replace(/\*/g, " * ")
            }
            if (expression.indexOf("-") >= 0) {
                let key = 0
                while (expression.indexOf("-", key) >= 0) {
                    let index = expression.indexOf("-", key);
                    if (index == 0) {

                    }
                    else if (expression[index - 1] < "0" || expression[index - 1] > "9") {

                    }
                    else {
                        let expression1 = expression.substr(0, index);
                        let expression2 = expression.substr(index + 1, expression.length - index - 1);
                        expression = expression1 + ' - ' + expression2;
                    }
                    key = index + 1;
                }

            }
            if (expression.indexOf("/") >= 0) {
                expression = expression.replace(/\//g, " / ")
            }
            if (expression.indexOf("+") >= 0) {
                expression = expression.replace(/\+/g, " + ")
            }
            if (expression.indexOf("(") >= 0) {
                expression = expression.replace(/\(/g, " ( ")
            }
            if (expression.indexOf(")") >= 0) {
                expression = expression.replace(/\)/g, " ) ")
            }

            var items = expression.split(" ");
            var temp = [];
            for (var i = 0; i < items.length; i++) {
                if (items[i] != "") {
                    temp.push(items[i]);
                }
            }
            items = temp;
            var outItems = []; //输出队列
            var stack = new Stack(); //保存运算符的栈
            var reg = /\d/;
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                if (reg.test(item)) {
                    //操作数直接输出
                    outItems.push(item);
                    continue;
                }
                if (item == "(") {
                    //左括号直接入栈
                    stack.push(item);
                } else if (item == ")") {
                    //右括号弹出栈中运算符，直到遇到左括号
                    while (stack.store.length > 0 && stack.store[stack.top - 1] != "(") {
                        outItems.push(stack.pop());
                    }
                    //弹出左括号
                    stack.pop();
                } else if (item == "+" || item == "-") {
                    //如果栈顶不是左括号则将栈中运算符出栈，最后再入栈
                    while (stack.store.length > 0 && stack.store[stack.top - 1] != "(") {
                        outItems.push(stack.pop());
                    }
                    stack.push(item);
                } else if (item == "*" || item == "/") {
                    //如果栈顶元素是左括号，直接入栈
                    //如果栈顶元素优先级比当前运算符高则先出栈再入栈
                    if (stack.store.length == 0 || stack.store[stack.top - 1] == "(") {
                        stack.push(item);
                    } else {
                        while (stack.store.length > 0 && (stack.store[stack.top - 1] == "*" || stack.store[stack.top - 1] == "/")) {
                            outItems.push(stack.pop());
                        }
                        stack.push(item);
                    }
                }
            }
            while (stack.store.length > 0) {
                outItems.push(stack.pop());
            }
            return outItems;
        },

        CalcExpression: function (expression) {
            var cal = new CalcEval();
            var stack = new Stack();
            var char = this.ParseExpression(expression);
            var p = 0;
            var s = 0;
            var str = "";
            var reg = /\d/;
            for (var i = 0; i < char.length; i++) {
                if (reg.test(char[i])) {
                    stack.push(char[i]);
                } else {
                    switch (char[i]) {
                        case "-":
                            p = stack.pop();
                            s = stack.pop();
                            //判断是表达式还是负数
                            if (p === null || p === undefined || p === "" || s === null || s === undefined || s === "") {
                                return expression;
                            }
                            str = s + "-" + p;
                            stack.push(cal.eval(str));
                            break;
                        case "+":
                            p = stack.pop();
                            s = stack.pop();
                            if (p === null || p === undefined || p === "" || s === null || s === undefined || s === "") {
                                return expression;
                            }
                            str = s + "+" + p;
                            stack.push(cal.eval(str));
                            break;
                        case "*":
                            p = stack.pop();
                            s = stack.pop();
                            str = s + "*" + p;
                            stack.push(cal.eval(str));
                            break;
                        case "/":
                            p = stack.pop();
                            s = stack.pop();
                            str = s + "/" + p;
                            stack.push(cal.eval(str));
                            break;
                        default:
                    }
                }
            }
            return stack.store[0];
        },
        //计算表达式

        //去掉规则中的函数:$.fn
        CalculateFn: async function  (rule) {
            var functionExpression = [];//方法表达式
            var functionValue = [];//方法计算值
            var startIndex = 0;
            while (rule.indexOf("$.fn.", startIndex) > -1) {
                var fnIndex = rule.indexOf("$.fn.", startIndex);
                var leftBracket = rule.indexOf("(", fnIndex + 1);//左括号位置
                var rightBracket = rule.indexOf(")", leftBracket + 1);//右括号位置
                leftBracket = rule.indexOf("(", leftBracket + 1);//下一个左括号位置
                while (leftBracket > -1 && rightBracket > leftBracket) {
                    rightBracket = rule.indexOf(")", rightBracket + 1);
                    leftBracket = rule.indexOf("(", leftBracket + 1);
                }
                //截取fnIndex到rightBracket之间的字符串为函数体
                //先把函数计算出来，再替换到表达式中
                var fn = rule.slice(fnIndex, rightBracket + 1);
                var val = await new Function("$", "return " + fn)($);
                functionExpression.push(fn);
                functionValue.push(val);
                startIndex = rightBracket + 1;
            }

            for (var i = 0; i < functionExpression.length; i++) {
                rule = rule.replace(functionExpression[i], functionValue[i]);
            }
            return rule;
        },

        ClearValue: function () {
            //对于配置了隐藏规则的字段，字段隐藏的时候Visible是true，值会被清掉，如果该字段参与了其他字段的计算则会出现问题
            if (this.Visible && $(this.Element).is(':visible')) {
                this.SetValue("");
            }
        },

        // 设置为焦点
        SetFocus: function () {
            if (this.$InputBody) {
                if (this.$InputBody.is("div")) {
                    this.$InputBody.find("input,select").focus();
                } else {
                    this.$InputBody.focus();
                }
            }
        },

        //值改变事件
        OnChange: function () {
            if (this.ChangeEvents == null || $.isEmptyObject(this.ChangeEvents)) return;
            for (var key in this.ChangeEvents) {
                if ($.isFunction(this.ChangeEvents[key])) {
                    this.ChangeEvents[key].apply(this, [arguments]);
                }
            }
        },

        //绑定改变值事件
        BindChange: function (key, fn) {
            this.ChangeEvents[key] = fn;
        },

        ///解除绑定
        UnbindChange: function (key) {
            delete this.ChangeEvents[key];
        },

        //如果控件有添加描述信息，则渲染
        RenderDescription: function () {
            var that = this;
            var description = that.Description || that.Describe || "";
            if (description != "") {
                var $title = that.$Title;
                var $element = $(that.Element);
                var h_title = $title.height();

                var $icon = $("<i>i</i>");
                $icon.css({
                    "height": "12px",
                    "width": "12px",
                    "line-height": "12px",
                    "color": "#fff",
                    "background-color": "#2d7fff",
                    "margin-left": "4px",
                    "cursor": "pointer",
                    "position": "absolute",
                    "top": (h_title - 12) / 2,
                    "border": "1px solid #2d7fff",
                    "border-radius": "6px",
                    "display": "inline-block",
                    "font-style": "normal",
                    "font-size": "12px",
                    "font-weight": "bold",
                    "text-align": "center"
                });
                $icon.off("click").on("click", function () {
                    $(that.Element).find("div.description").toggle();
                });
                $title.append($icon);

                //描述信息容器
                var $description = $("<div class='description'>" + description + "</div>").hide();
                //描述信息的宽度
                var w_element = $element.width();
                var padding_right = parseInt(that.$InputBody.css("padding-right"));
                var w_description = w_element - padding_right;

                $description.css({
                    "color": "#666",
                    "background-color": "#f5f5f5",
                    "font-size": "14px",
                    "position": "relative",
                    "margin-top": $element.height() + 10,
                    "width": w_description,
                    "padding": "8px 12px",
                    "word-wrap": "break-word",
                    "word-break": "break-all"
                });

                //描述信息的箭头
                var $arrowUp = $("<i></i>");
                //计算箭头的位置
                var left_arrow = parseInt($icon.css("left")) + 1;

                $arrowUp.css({
                    "height": "0",
                    "width": "0",
                    "position": "absolute",
                    "top": "-8px",
                    "left": left_arrow + "px",
                    "border-right": "8px solid transparent",
                    "border-bottom": "8px solid #f5f5f5",
                    "border-left": "8px solid transparent"
                });

                $description.append($arrowUp);
                $element.append($description);
            }
        },

        //
        // Error : 这里需要去掉，统一从 $.SmartForm.PostForm 入口
        //异步取数
        //@url:地址
        //@type:类型，post、get
        //@dataParam:传入的json数据
        //@successCallBack:回调，可不传
        //@isAsync:是否异步，可不传
        //@errorCallBack:回调，可不传
        Ajax: function (url, type, dataParam, successCallBack, isAsync, errorCallBack) {
            console.log("Ajax 这个接口后续将移除，请关注!");
            if(!window.isExpAccount){
                url = window.zuul + url   //配置接口地址
            }
            var sharingKey = $.IQuery("SharingKey");
            var engineCode = $.IQuery("EngineCode");
            var data = $.extend({
                SharingKey: sharingKey, EngineCode: engineCode
            }, dataParam);

            $.ajax({
                type: type,
                url: url,
                data: data,
                dataType: "json",
                xhrFields:{
                    withCredentials: true
                },
                crossDomain:true,
                async: isAsync == null ? true : isAsync,
                success: function (data) {
                    if ($.isFunction(successCallBack))
                        successCallBack.apply(this, [data]);
                },
                error: function (data) {
                    if ($.isFunction(errorCallBack))
                        errorCallBack.apply(this, [data]);
                }
            });
        }
    }
    function Stack() {
        this.store = [];
        this.top = 0;
        this.push = function (ele) {
            this.store[this.top++] = ele;
        };
        this.pop = function () {
            var top = --this.top;
            if (top >= 0) {
                var val = this.store[top];
                this.store.splice(this.top, 1);
                return val;
            } else {
                return "";
            }
        };
    };
})(jQuery);;
// 所有控件的定义
// Error:这里改名字
var FormControls = {
    FormSeqNo: {
        Text: "流水号",
        Icon: "fa-barcode",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "流水号", Description: "" },
            { Name: "Prefix", Text: "前置字符(最多4位字母或数字)", DefaultValue: "", MaxLength: 4 },
            { Name: "DateTimeMode", Text: "日期格式", DefaultValue: "YYYY", ValueRange: [{ Val: "None", Text: "无" }, { Val: "YYYY", Text: "年" }, { Val: "YYYYMM", Text: "年月" }, { Val: "YYYYMMDD", Text: "年月日" }] },
            { Name: 'IncrementNum', Text: '自增序号位数', DefaultValue: 8 },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },
    FormTextArea: {
        Text: "多行文本",
        Icon: "fa-bars",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "多行文本", Description: "普通字段,记录文本信息" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "Rows", Text: "可见行数", DefaultValue: 3 },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "ComputationRule", Text: "计算公式", DefaultValue: "" },
            { Name: "PlaceHolder", Text: "提示语", DefaultValue: "", Description: "普通字段,记录文本信息" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormTextBox: {
        Text: "单行文本1111",
        Icon: "fa-tag",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "单行文本", Description: "普通字段,记录文本信息" },
            { Name: "TransferItems", Text: "控件转换", DefaultValue: "FormTextBox", ValueRange: [{ Val: "FormTextBox", Text: "文本框" }, { Val: "FormDropDownList", Text: "下拉框" }, { Val: "FormRadioButtonList", Text: "单选框" }, { Val: "FormCheckboxList", Text: "复选框" }] },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "ComputationRule", Text: "计算公式", DefaultValue: "" },
            { Name: "Mode", Text: "格式", DefaultValue: "Normal", ValueRange: [{ Val: "Normal", Text: "普通文本" }, { Val: "Email", Text: "邮箱" }, { Val: "Card", Text: "身份证" }, /*{ Val: "Mobile", Text: "手机" },*/ { Val: "Telephone", Text: "固话/手机" }] },
            { Name: "InputByScan", Text: "允许扫码输入", DefaultValue: false },
            { Name: "ScanUpdateEnable", Text: "可修改扫码结果", DefaultValue: false },
            { Name: "NoRepeat", Text: "不允许重复录入", DefaultValue: false },
            //{ Name: "IsMultiple", Text: "模式", DefaultValue: false, ValueRange: [{ Val: false, Text: "单行" }, { Val: true, Text: "多行" }] },
            { Name: "DefaultItems", Text: "选项", DefaultValue: ["选项1", "选项2", "选项3"] },
            { Name: "PlaceHolder", Text: "提示语", DefaultValue: "", Description: "普通字段,记录文本信息" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormDateTime: {
        Text: "日期",
        Icon: "fa-bell-o",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "日期", Description: "普通字段,存储日期、时间信息" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "ComputationRule", Text: "计算公式", DefaultValue: "" },
            { Name: "DateTimeMode", Text: "格式", DefaultValue: "yyyy-mm-dd", ValueRange: [{ Val: "yyyy-mm-dd", Text: "年-月-日" }, { Val: "yyyy-mm", Text: "年-月" }, { Val: "yyyy-mm-dd hh:ii", Text: "年-月-日 时:分" }, { Val: "hh:ii", Text: "时:分" }] },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },
    FormDateTimeStamp: {
        Text: "日期区间",
        Icon: "fa-bell-o",
        Designable: false,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "", Description: "普通字段,存储日期、时间信息" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "DateTimeMode", Text: "日期格式", DefaultValue: "yyyy-mm-dd", ValueRange: [{ Val: "yyyy-mm-dd", Text: "年-月-日" }, { Val: "yyyy-mm-dd hh:ii", Text: "年-月-日 时:分" }] },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormNumber: {
        Text: "数字",
        Icon: "fa-sort-numeric-asc",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "数字", Description: "普通字段,记录数值信息" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "ComputationRule", Text: "计算公式", DefaultValue: "" },
            { Name: "DecimalPlaces", Text: "格式", DefaultValue: "" },
            { Name: "DecimalPlaces", Text: "小数位数", Visiable: false, DefaultValue: "0", ValueRange: [{ Val: "0", Text: "整数" }, { Val: "2", Text: "两位小数" }, { Val: "3", Text: "三位小数" }, { Val: "4", Text: "四位小数" }] },
            { Name: "ShowMode", Text: "显示模式", Visiable: false, DefaultValue: "0", ValueRange: [{ Val: "0", Text: "正常" }, { Val: "1", Text: "显示千位分隔符" }] },
            // { Name: "PlaceHolder", Text: "提示语",Visiable: false, DefaultValue: "", Description: "普通字段,记录数值信息" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },
    FormNumberStamp: {
        Text: '数值区间',
        Icon: "fa-sort-numeric-asc",
        Designable: false,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "", Description: "普通字段,记录数值信息" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "ComputationRule", Text: "计算规则", DefaultValue: "" },
            { Name: "DecimalPlaces", Text: "格式", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "整数" }, { Val: "2", Text: "两位小数" }, { Val: "3", Text: "三位小数" }, { Val: "4", Text: "四位小数" }] },
            { Name: "PlaceHolder", Text: "提示语", DefaultValue: "", Description: "普通字段,记录数值信息" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormRadioButtonList: {
        Text: "单选框",
        Icon: "fa-bullseye",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "单选框", Description: "普通字段,可与数据字典关联,存储选择项" },
            { Name: "TransferItems", Text: "控件转换", DefaultValue: "FormRadioButtonList", ValueRange: [{ Val: "FormTextBox", Text: "文本框" }, { Val: "FormDropDownList", Text: "下拉框" }, { Val: "FormRadioButtonList", Text: "单选框" }, { Val: "FormCheckboxList", Text: "复选框" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "SelectShowMode", Text: "移动端显示模式", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "侧滑选择" }, { Val: "1", Text: "平铺显示" }] },
            { Name: "DataDictItemName", Text: "绑定数据字典", Visiable: false, DefaultValue: "" },
            { Name: "DefaultItems", Text: "选项", DefaultValue: ["选项1", "选项2", "选项3"] },
            { Name: "DefaultValue", Text: "默认值", Visiable: false },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormCheckboxList: {
        Text: "复选框",
        Icon: "fa-check-square-o",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "复选框", Description: "普通字段,可与数据字典关联,存储选择项" },
            { Name: "TransferItems", Text: "控件转换", DefaultValue: "FormCheckboxList", ValueRange: [{ Val: "FormTextBox", Text: "文本框" }, { Val: "FormDropDownList", Text: "下拉框" }, { Val: "FormRadioButtonList", Text: "单选框" }, { Val: "FormCheckboxList", Text: "复选框" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "SelectShowMode", Text: "移动端显示模式", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "侧滑选择" }, { Val: "1", Text: "平铺显示" }] },
            { Name: "DataDictItemName", Text: "绑定数据字典", DefaultValue: "", Visiable: false },
            { Name: "DefaultItems", Text: "选项", DefaultValue: ["选项1", "选项2", "选项3"] },
            { Name: "DefaultValue", Text: "默认值", Visiable: false },
            { Name: "IsCheckbox", Text: "模式", DefaultValue: "false", ValueRange: [{ Val: "false", Text: "复选框" }] },
            //级联新增属性-过滤
            { Name: "BOSchemaCode", Text: "关联表单", Visiable: false, DefaultValue: "" },
            { Name: "MappingField", Text: "关联字段", Visiable: false, DefaultValue: "" },
            { Name: "AssociationFilter", Text: "表单过滤条件", Visiable: false, DefaultValue: "" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormCheckbox: {//是/否控件
        Text: "是/否",
        Icon: "fa-check-circle-o",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "是/否", Description: "普通字段,可与数据字典关联,存储选择项" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "DefaultItems", Text: "选项", DefaultValue: ["是/否"] },
            { Name: "DefaultValue", Text: "默认值", Visiable: false }
        ]
    },

    FormDropDownList: {
        Text: "下拉框",
        Icon: "fa-tasks",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "下拉框", Description: "普通字段,可与数据字典关联,存储选择项" },
            { Name: "TransferItems", Text: "控件转换", DefaultValue: "FormDropDownList", ValueRange: [{ Val: "FormTextBox", Text: "文本框" }, { Val: "FormDropDownList", Text: "下拉框" }, { Val: "FormRadioButtonList", Text: "单选框" }, { Val: "FormCheckboxList", Text: "复选框" }] },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "SelectShowMode", Text: "移动端显示模式", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "侧滑选择" }, { Val: "1", Text: "平铺显示" }] },
            { Name: "DataSource", Text: "数据来源", DefaultValue: "Custom", ValueRange: [{ Val: "Custom", Text: "自定义" }] }, { Name: "DataDictItemName", Text: "绑定数据字典", Visiable: false, DefaultValue: "" },
            { Name: "DefaultItems", Text: "选项", DefaultValue: ["选项1", "选项2", "选项3"] },
            { Name: "DefaultValue", Text: "默认值", Visiable: false },
            //级联新增属性
            { Name: "BOSchemaCode", Text: "关联表单", Visiable: true, DefaultValue: "" },
            { Name: "MappingField", Text: "关联字段", Visiable: true, DefaultValue: "" },
            { Name: "AssociationFilter", Text: "数据范围限定", Visiable: true, DefaultValue: "" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ],
    },

    FormMultiUser: {
        Text: "人员多选",
        Icon: "fa-sitemap",
        Designable: true,
        //可设计属性
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "人员多选", Description: "从组织机构中选择人员" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "IsMultiple", Text: "模式", Visiable: false, DefaultValue: true, ValueRange: [{ Val: false, Text: "单选" }, { Val: true, Text: "多选" }] },
            { Name: "UnitSelectionRange", Text: "仅以下人员可被选择", DefaultValue: "", placeholder: '添加人员范围' },
            { Name: "OrgUnitVisible", Text: "部门可见", Visiable: false, DefaultValue: false, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }] },
            { Name: "UserVisible", Text: "用户可见", Visiable: false, DefaultValue: true, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }] },
            // { Name: "IsRelatedMember", Text: "启动表单相关权限控制", DefaultValue: false, ValueRange: [{ Val: false, Text: "不启动" }, { Val: true, Text: "启动" }] },
            { Name: "MappingControls", Text: "关联配置", Visiable: false },
            { Name: "IsRelatedMember", Text: "允许控件所选人员查看数据", DefaultValue: false, ValueRange: [{ Val: true, Text: "允许" }, { Val: false, Text: "不允许" }] },
            { Name: "UseDataCache", Text: "是否缓存", DefaultValue: true, Visiable: false, ValueRange: [{ Val: true, Text: "是" }, { Val: false, Text: "否" }] },
            { Name: "DefaultValue", Text: "默认值", Visiable: false },
            { Name: "ShowUnActive", Text: "显示离职人员", Visiable: true, DefaultValue: false, ValueRange: [{ Val: false, Text: "不显示" }, { Val: true, Text: "显示" }] },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ],
    },

    FormUser: {
        Text: "人员单选",
        Icon: "fa-user",
        Designable: true,
        //可设计属性
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "人员单选", Description: "从组织机构中选择人员" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "IsMultiple", Text: "模式", Visiable: false, DefaultValue: false, ValueRange: [{ Val: false, Text: "单选" }, { Val: true, Text: "多选" }] },
            { Name: "UnitSelectionRange", Text: "仅以下人员可被选择", DefaultValue: "", placeholder: '添加人员范围' },
            { Name: "OrgUnitVisible", Text: "部门可见", Visiable: false, DefaultValue: false, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }] },
            { Name: "UserVisible", Text: "用户可见", Visiable: false, DefaultValue: true, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }] },
            // { Name: "IsRelatedMember", Text: "启动表单相关权限控制", DefaultValue: false, ValueRange: [{ Val: false, Text: "不启动" }, { Val: true, Text: "启动" }] },
            { Name: "MappingControls", Text: "人员信息填充" },
            { Name: "IsRelatedMember", Text: "允许控件所选人员查看数据", DefaultValue: false, ValueRange: [{ Val: true, Text: "允许" }, { Val: false, Text: "不允许" }] },
            { Name: "ShowUnActive", Text: "显示离职人员", Visiable: true, DefaultValue: false, ValueRange: [{ Val: false, Text: "不显示" }, { Val: true, Text: "显示" }] },
            { Name: "UseDataCache", Text: "是否缓存", DefaultValue: true, Visiable: false, ValueRange: [{ Val: true, Text: "是" }, { Val: false, Text: "否" }] },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ],
    },

    FormDeFormDepartment: {
        Text: "部门单选",
        Icon: "fa-user",
        Designable: true,
        //可设计属性
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "部门单选", Description: "从组织机构中选择部门" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "IsMultiple", Text: "模式", Visiable: false, DefaultValue: false, ValueRange: [{ Val: false, Text: "单选" }, { Val: true, Text: "多选" }] },
            { Name: "UnitSelectionRange", Text: "仅以下部门可被选择", DefaultValue: "", placeholder: '添加部门范围' },
            { Name: "OrgUnitVisible", Text: "部门可见", DefaultValue: true, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }], Visiable: false },
            { Name: "UserVisible", Text: "用户可见", DefaultValue: false, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }], Visiable: false },
            { Name: "IsRelatedMember", Text: "启动表单相关权限控制", DefaultValue: false, ValueRange: [{ Val: false, Text: "不启动" }, { Val: true, Text: "启动" }], Visiable: false },
            { Name: "IsRelatedMember", Text: "启动表单相关权限控制", DefaultValue: false, ValueRange: [{ Val: false, Text: "不启动" }, { Val: true, Text: "启动" }], Visiable: false },
            { Name: "MappingControls", Text: "关联配置", Visiable: false },
            { Name: "ShowUnActive", Text: "显示离职人员", Visiable: true, DefaultValue: false, ValueRange: [{ Val: false, Text: "不显示" }, { Val: true, Text: "显示" }] },
            { Name: "UseDataCache", Text: "是否缓存", DefaultValue: true, Visiable: false, ValueRange: [{ Val: true, Text: "是" }, { Val: false, Text: "否" }] },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ],
    },
    FormMultiDepartment: {
        Text: "部门多选",
        Icon: "fa-sitemap",
        Designable: true,
        //可设计属性
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "部门多选", Description: "从组织机构中选择部门" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "IsMultiple", Text: "模式", Visiable: false, DefaultValue: true, ValueRange: [{ Val: false, Text: "单选" }, { Val: true, Text: "多选" }] },
            { Name: "UnitSelectionRange", Text: "仅以下部门可被选择", DefaultValue: "", placeholder: '添加部门范围' },
            { Name: "OrgUnitVisible", Text: "部门可见", DefaultValue: true, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }], Visiable: false },
            { Name: "UserVisible", Text: "用户可见", DefaultValue: false, ValueRange: [{ Val: true, Text: "可选" }, { Val: false, Text: "不可选" }], Visiable: false },
            { Name: "IsRelatedMember", Text: "启动表单相关权限控制", DefaultValue: false, ValueRange: [{ Val: false, Text: "不启动" }, { Val: true, Text: "启动" }], Visiable: false },
            { Name: "MappingControls", Text: "关联配置", Visiable: false },
            { Name: "UseDataCache", Text: "是否缓存", DefaultValue: true, Visiable: false, ValueRange: [{ Val: true, Text: "是" }, { Val: false, Text: "否" }] },
            { Name: "DefaultValue", Text: "默认值", Visiable: false },
            { Name: "ShowUnActive", Text: "显示离职人员", Visiable: true, DefaultValue: false, ValueRange: [{ Val: false, Text: "不显示" }, { Val: true, Text: "显示" }] },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ],
    },

    FormAttachment: {
        Text: "附件",
        Icon: "fa-chain-broken",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "附件", Description: "普通字段,存储文件信息" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            // { Name: "MaxUploadSize", Text: "文件限制大小", DefaultValue: 10, ValueRange: [{ Val: "1", Text: "1MB" }, { Val: "5", Text: "5MB" }, { Val: "10", Text: "10MB" }, { Val: "50", Text: "50MB" }] }
        ]
    },
    FormCitySelect: {
        Text: "城市",
        Icon: "fa-flag",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "城市", Description: "普通字段,记录城市" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" }
        ]
    },

    FormFolder: {
        Text: "文档库",
        Icon: "fa-chain-broken",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "文档库", Description: "普通字段,存储文件信息" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "FolderName", Text: "选择文档库", DefaultValue: "" },
            // { Name: "MaxUploadSize", Text: "文件限制大小", DefaultValue: 10, ValueRange: [{ Val: "1", Text: "1MB" }, { Val: "5", Text: "5MB" }, { Val: "10", Text: "10MB" }, { Val: "50", Text: "50MB" }] }
        ]
    },

    FormPhoto: {
        Text: "图片",
        Icon: "icon-picture",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "图片" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "UpLoadMultiple", Text: "允许上传多张图片", Visiable: true, DefaultValue: false },
            { Name: "CameraOnly", Text: "仅允许拍照上传", Visiable: true, DefaultValue: false }
        ]
    },

    FormQuery: {
        Text: "关联表单",
        Icon: "fa-file-o",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "关联表单", Description: "表单引用另一个表单时使用，比如：项目汇报需要先输入项目，这个“项目”就是关联查询类型" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "BOSchemaCode", Text: "关联表单", DefaultValue: "" },
            { Name: "AssociationFilter", Text: "数据范围限定", DefaultValue: "" },
            { Name: "InputByScan", Text: "允许扫码输入", DefaultValue: false },
            { Name: "ScanUpdateEnable", Text: "允许手动修改扫码结果", DefaultValue: false },
            { Name: "DataRule", Text: "数据填充规则", DefaultValue: "" },
            { Name: "BOSchemaName", Text: "关联表单名称", DefaultValue: "", Visiable: false },//针对应用树类型选择添加的属性，还原选择的表单名称
            { Name: "IsListView", Text: "是否列表视图", Visiable: false, DefaultValue: false },
            { Name: "MappingControls", Text: "关联配置", Visiable: false },
            { Name: "MappingProperties", Text: "关联属性", Visiable: false },
            { Name: "IsMultiple", Text: "是否多选", Visiable: false, DefaultValue: false },
            { Name: "BOSchemaInfo", Text: "关联表单信息", Visiable: false, DefaultValue: "" },//关联表单的信息，{AppPackage：xxx，AppGroup：xxx，AppMenu:xxx,IsChildSchema:xxx}
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },
    FormMultiQuery: {
        Text: "关联多选",
        Icon: "fa-files-o",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "关联多选", Description: "表单引用另一个表单时使用，比如：项目汇报需要先输入项目，这个“项目”就是关联查询类型" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "BOSchemaCode", Text: "关联表单", DefaultValue: "" },
            { Name: "AssociationFilter", Text: "数据范围限定", DefaultValue: "" },
            { Name: "BOSchemaName", Text: "关联表单名称", DefaultValue: "", Visiable: false },//针对应用树类型选择添加的属性，还原选择的表单名称
            { Name: "IsListView", Text: "是否列表视图", Visiable: false, DefaultValue: false },
            { Name: "IsMultiple", Text: "是否多选", Visiable: false, DefaultValue: true },
            { Name: "BOSchemaInfo", Text: "关联表单信息", Visiable: false, DefaultValue: "" },//关联表单的信息，{AppPackage：xxx，AppGroup：xxx，AppMenu:xxx,IsChildSchema:xxx}
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },
    FormAssociateProperty: {
        Text: "关联属性",
        Icon: "fa-chain",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "关联属性", Description: "" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "BOSchemaField", Text: "关联表单字段", DefaultValue: "" },//针对应用树类型选择添加的属性，还原选择的表单名称
            { Name: "AsFilter", Text: "作为关联表单搜索项", DefaultValue: false },
            { Name: "IsMappingProperty", Visiable: false, DefaultValue: true },
            { Name: "SourceType", Visiable: false, DefaultValue: "" }
            // { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormList: {
        Text: "列表查询",
        Icon: "fa-chain",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "关联列表", Description: "表单引用另一个表单时使用，比如：项目汇报需要先输入项目，这个“项目”就是关联查询类型" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "BOSchemaCode", Text: "关联表单", DefaultValue: "" },
            { Name: "AssociationFilter", Text: "数据范围限定", DefaultValue: "" },
            { Name: "BOSchemaName", Text: "关联表单名称", DefaultValue: "", Visiable: false },//针对应用树类型选择添加的属性，还原选择的表单名称
            { Name: "BOSchemaInfo", Text: "关联表单信息", Visiable: false, DefaultValue: "" },//关联表单的信息，{AppPackage：xxx，AppGroup：xxx，AppMenu:xxx,IsChildSchema:xxx}
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },




    FormAreaSelect: {
        Text: "地址",
        Icon: "fa-flag",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "地址", Description: "普通字段,记录文本信息" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "AreaMode", Text: "格式", DefaultValue: "P-C-T", ValueRange: [{ Val: "P-C-T", Text: "省-市-县" }, { Val: "P-C", Text: "省-市" }, { Val: "P", Text: "省" }] },
            { Name: "ShowDetailAddr", Text: "显示详细地址", DefaultValue: "true" }
        ]
    },

    FormMap: {
        Text: "位置",
        Icon: "fa-map-marker",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "位置", Description: "普通字段,存储地理位置" },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "Range", Text: "位置范围", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "限定附近位置" }, { Val: "1", Text: "允许任意位置" }] }
        ],
    },

    //关联列表控件
    FormBoList: {
        Text: "关联列表",
        Icon: "fa-align-justify",
        Designable: false,
        DesignProperties: [
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "关联列表", Description: "自动列出关联的表单，无实质保存字段，而是方便查阅" },
            { Name: "BOSchemaCode", Text: "关联对象" },
            { Name: "MappingDataField", Text: "关联字段" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormGridView: {
        Text: "子表",
        Icon: "fa-table",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "子表", Description: "表单中的多行重复数据录入" },
            { Name: "NameItems", Text: "数据标题", DefaultValue: "", Description: "" },
            { Name: "DisplayName", Text: "标题", DefaultValue: "", Description: "", Visiable: false },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "GridViewFields", Text: "子表字段", DefaultValue: "" },
            { Name: "GridViewMode", Text: "移动端显示模式", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "平铺显示" }, { Val: "1", Text: "矩阵显示" }] },
            { Name: "DisplayFields", Text: "移动端显示字段" }
        ]
    },
    FormFormula: {
        Text: "公式型控件",
        Designable: true,
        Icon: "icon-formula",
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "公式型控件", Description: "" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "ComputationRule", Text: "计算公式", DefaultValue: "" },
            { Name: "BindType", Text: "类型", DefaultValue: "number", ValueRange: [{ Val: "number", Text: "数值" }, { Val: "text", Text: "文本" }, { Val: "datetime", Text: "日期" }, { Val: "boolean", Text: "是否" }] },
            { Name: "DecimalPlaces", Text: "格式", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "整数" }, { Val: "2", Text: "两位小数" }, { Val: "3", Text: "三位小数" }, { Val: "4", Text: "四位小数" }] },
            { Name: "ShowMode", Text: "显示模式", DefaultValue: "0", ValueRange: [{ Val: "0", Text: "正常" }, { Val: "1", Text: "显示千位分隔符" }] },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },
    FormLabel: {
        Text: "",
        Icon: "fa-italic",
        Designable: false,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "创建人" },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "Description", Text: "描述", DefaultValue: "", Description: "" }
        ]
    },

    FormButton: {
        Text: "按钮",
        Icon: "fa-hand-o-up",
        Designable: true,
        DesignProperties: [
            { Name: "DataField", Text: "方法名", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "" }
        ]
    },


    FormSns: {
        Text: "动态",
        Icon: "fa-comments",
        Designable: false,
        DesignProperties: []
    },

    FormTaskTips: {
        Text: "任务提醒",
        Icon: "fa-comments",
        Designable: false,
        DesignProperties: []
    },

    FormComment: {
        Text: "审批",
        Designable: false,
        DesignProperties: [
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "审批" },
            { Name: "TitleDirection", Text: "标题布局", DefaultValue: "Vertical", ValueRange: [{ Val: "Horizontal", Text: "横" }, { Val: "Vertical", Text: "列" }] },
            { Name: "Width", Text: "控件大小", DefaultValue: "100%", ValueRange: [{ Val: "100%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] }
        ]
    },


    FormAclScope: {
        Text: '查询范围',
        Designable: false,
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "查询范围" },
            { Name: "DefaultItems", Text: "选项", DefaultValue: ["选项1", "选项2", "选项3"] },
            { Name: "Width", Text: "控件大小", DefaultValue: "100%", ValueRange: [{ Val: "100%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] }
        ]
    },

    FormComboBox: {
        Text: "组合框",
        Designable: false,
        //可设计属性
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "", Description: "普通字段,记录文本信息" },
            { Name: "TransferItems", Text: "控件转换", DefaultValue: "FormTextBox", ValueRange: [{ Val: "FormTextBox", Text: "文本框" }, { Val: "FormDropDownList", Text: "下拉框" }, { Val: "FormRadioButtonList", Text: "单选框" }, { Val: "FormCheckboxList", Text: "复选框" }] },
            { Name: "Width", Text: "控件大小", Visiable: false, DefaultValue: "100%", ValueRange: [{ Val: "25%", Text: "小尺寸" }, { Val: "75%", Text: "标准尺寸" }, { Val: "100%", Text: "大尺寸" }] },
            { Name: "DisplayRule", Text: "隐藏条件", DefaultValue: "" },
            { Name: "ComputationRule", Text: "计算规则", DefaultValue: "" },
            { Name: "Mode", Text: "校验模式", DefaultValue: "Normal", ValueRange: [{ Val: "Normal", Text: "普通文本" }, { Val: "Email", Text: "邮箱" }, { Val: "Card", Text: "身份证" }, /*{ Val: "Mobile", Text: "手机" },*/ { Val: "Telephone", Text: "固话/手机" }] },
            //{ Name: "IsMultiple", Text: "模式", DefaultValue: false, ValueRange: [{ Val: false, Text: "单行" }, { Val: true, Text: "多行" }] },
            { Name: "DefaultItems", Text: "选项", DefaultValue: ["选项1", "选项2", "选项3"] },
            { Name: "PlaceHolder", Text: "提示语", DefaultValue: "", Description: "普通字段,记录文本信息" },
            { Name: "SchemaCode", Text: "关联表单", DefaultValue: "", Description: "关联数据的表单" },
            { Name: "DefaultValue", Text: "默认值", DefaultValue: "", Description: "默认值" }
        ]
    },
    FormComboBoxList: {
        Text: "组合框多选",
        Designable: false,
        //可设计属性
        DesignProperties: [
            { Name: "DataField", Text: "控件编码", DefaultValue: "" },
            { Name: "DisplayName", Text: "控件名称", DefaultValue: "", Description: "普通字段,记录文本信息" },
            { Name: "SchemaCode", Text: "关联表单", DefaultValue: "", Description: "关联数据的表单" },
            { Name: "DefaultValue", Text: "默认值", DefaultValue: "", Description: "默认值" }
        ]
    }
};

// 所有控件对开发者开放的API
var FormControlAPI = {
    FormSeqNo: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormTextArea: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormTextBox: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange", "BindClickEvent"],

    FormDateTime: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormNumber: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange", "BindClickEvent"],

    FormRadioButtonList: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange", "AddItem", "ClearItems"],

    FormCheckboxList: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange", "AddItem", "ClearItems"],

    FormCheckbox: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormDropDownList: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange", "AddItem", "ClearItems"],

    FormMultiUser: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormUser: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormApapt: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormMultiApapt: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormAttachment: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormQuery: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormMultiQuery: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormAreaSelect: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormMap: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    FormGridView: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange", "AddRow", "ClearRows", "UpdateRow"],

    FormLabel: ["GetValue", "SetValue", "SetVisible", "BindChange", "UnBindChange"],

    $extend: ["IGuid", "IClone", "IQuery", "IShowForm", "IGetParams", "ILocation", "IShowGraph", "IShowList", "IReloadForm", "IShowSuccess", "IShowError", "IShowWarn", "IShowTip", "IConfirm", "IDownloadAttachments", "IShowPreLoader", "IHidePreLoader", "IScanBarCode", "IScanQrCode", "IScanCard", "IShowUserInfo", "IShowChatPage", "IShowFreeCall", "IPostImageDing", "IPostLinkDing", "SmartForm"],

    SmartForm: ["ResponseContext", "PostForm"],

    ControlAPIDetails: {
        "ResponseContext": { Type: "property", Demo: "（property）$.SmartForm.ResponseContext", Summary: "" },
        "SmartForm": { Type: "property", Demo: "（property）$.SmartForm", Summary: "表单操作对象" },
        "PostForm": { Type: "function", Demo: "（method）$.SmartForm.PostForm(actionName,data,callBack,errorBack,async)", Summary: "表单提交，参数说明：actionName:提交的ActionName;data:提交后台的数据;callback:回调函数;errorBack:错误回调函数;async:是否异步;" },
        "GetValue": { Type: "function", Demo: "（method）this.DataFieldID.GetValue()", Summary: "读取控件的值" },
        "SetValue": { Type: "function", Demo: "（method）this.DataFieldID.SetValue(value)", Summary: "给控件赋值，参数说明：value:控件的值" },
        "SetVisible": { Type: "function", Demo: "（method）this.DataFieldID.SetVisible(true/false)", Summary: "显示/隐藏控件，参数说明：bool，true显示，false隐藏" },
        "BindChange": { Type: "function", Demo: "（method）this.DataFieldID.BindChange(key, callback)", Summary: "给控件绑定一个变更事件，当控件值变化执行自定义函数，参数说明：key:事件标识，callback：回调函数" },
        "BindClickEvent": { Type: "function", Demo: "（method）this.DataFieldID.BindClickEvent(function(){自定义代码})", Summary: "给控件绑定一个单击事件，控件后面会多出一个图标，点击触发绑定的事件，参数说明：function：绑定的函数" },
        "UnBindChange": { Type: "function", Demo: "（method）this.DataFieldID.UnBindChange(key)", Summary: "解除控件值变化事件，参数说明：" },
        "AddItem": { Type: "function", Demo: "（method）$.DataFieldID.AddItem(value,text)", Summary: "给控件添加选项，参数说明：" },
        "ClearItems": { Type: "function", Demo: "（method）$.DataFieldID.ClearItems()", Summary: "清除控件选项，参数说明：" },
        "AddRow": { Type: "function", Demo: "（method）this.SubTable.AddRow(subObjectId,{“SubTable.ColumnName”:Value})", Summary: "新建子表行，并给子表字段赋值，参数说明：" },
        "ClearRows": { Type: "function", Demo: "（method）this.SubTable.ClearRows()", Summary: "清除子表的所有数据，参数说明：" },
        "UpdateRow": { Type: "function", Demo: "（method）this.SubTable.UpdateRow(subObjectId,{“SubTable.ColumnName”:Value})", Summary: "更新子表行记录，参数说明：" },
        "IGuid": { Type: "function", Demo: "$.IGuid()", Summary: "创建Guid" },
        "IClone": { Type: "function", Demo: "$.IClone(Obj)", Summary: "对象克隆,只对对象有效，参数说明：obj:被克隆对象" },
        "IQuery": { Type: "function", Demo: "$.IQuery", Summary: "" },
        "IShowForm": { Type: "function", Demo: "$.IShowForm", Summary: "显示表单" },
        "IGetParams": { Type: "function", Demo: "$.IGetParams", Summary: "获取参数值" },
        "ILocation": { Type: "function", Demo: "$.ILocation", Summary: "定位" },
        "IShowGraph": { Type: "function", Demo: "$.IShowGraph", Summary: "显示地图" },
        "IShowList": { Type: "function", Demo: "$.IShowList", Summary: "" },
        "IReloadForm": { Type: "function", Demo: "$.IReloadForm", Summary: "重新加载表单" },
        "IShowSuccess": { Type: "function", Demo: "$.IShowSuccess(title,message)", Summary: "成功弹出框，参数说明：title：消息框标题，message：消息体" },
        "IShowError": { Type: "function", Demo: "$.IShowError(title,message)", Summary: "失败弹出框，参数说明：title：消息框标题，message：消息体" },
        "IShowWarn": { Type: "function", Demo: "$.IShowWarn(title,message)", Summary: "警告弹出框，参数说明：title：消息框标题，message：消息体" },
        "IShowTip": { Type: "function", Demo: "$.IShowTip(title,message)", Summary: "提示弹出框，参数说明：title：消息框标题，message：消息体" },
        "IConfirm": { Type: "function", Demo: "$.IConfirm(title,message,callback)", Summary: "使用bootstrap扩展插件pnotify弹出确认框，参数说明：title:消息标题，message:消息体，callback:回调函数" },
        "IDownloadAttachments": { Type: "function", Demo: "$.IDownloadAttachments(attachmentIds)", Summary: "批量下载附件,移动端不支持，参数说明：attachmentIds：array 附件ID数组" },
        "IShowPreLoader": { Type: "function", Demo: "$.SheetRuntimeContentCache(text)", Summary: "显示加载提示框，参数说明：text:弹出信息" },
        "IHidePreLoader": { Type: "function", Demo: "$.IHidePreLoader()", Summary: "隐藏加载提示框" },
        "IScanBarCode": { Type: "function", Demo: "$.IScanBarCode(callback)", Summary: "(移动端)扫描条形码，参数说明：callback:回调函数" },
        "IScanQrCode": { Type: "function", Demo: "$.IScanQrCode(callback)", Summary: "(移动端)扫描二位码，参数说明：callback:回调函数" },
        "IScanCard": { Type: "function", Demo: "$.IScanCard(callback)", Summary: "(移动端)扫描名片，参数说明：callback：回调函数" },
        "IShowUserInfo": { Type: "function", Demo: "$.IShowUserInfo(userId,corpId)", Summary: "(移动端)显示钉钉个人资料页，参数说明：userId:用户ID，corpId：企业ID" },
        "IShowChatPage": { Type: "function", Demo: "$.IShowChatPage(sers, corpId)", Summary: "(移动端)显示钉钉聊天页面，参数说明：userId:用户ID，corpId：企业ID" },
        "IShowFreeCall": { Type: "function", Demo: "$.IShowFreeCall()", Summary: "(移动端)拨打免费电话" },
        "IPostImageDing": { Type: "function", Demo: "$.IPostImageDing(users, corpId, text, success, fail)", Summary: "(移动端)图片类型钉消息，参数说明：userId:用户ID，corpId：企业ID，text:消息体，success：成功回调，fail:失败回调" },
        "IPostLinkDing": { Type: "function", Demo: "$.IPostLinkDing(users, corpId, text, title, url, imageUrl, subText, success, fail)", Summary: "(移动端)Link类型钉消息，参数说明：userId:用户ID，corpId：企业ID，text:消息体，title:标题，url:链接地址，imageUrl:图片地址，subText:描述，success：成功回调，fail:失败回调" }
    }
};

//选人控件数据,单个页面所有数据库共用
$.FormMultiUserData = {
    //部门
    OrgUnitItems: [],
    //标签
    OrgTagItems: [],
    //部门用户:{部门ID:[]}
    DepUserItems: {},
    //用户
    UserItems: [],
};;
// JS框架,JS框架加载所有JS部件，提供与后台通讯方法
// 属性定义
// 定义Form命名控件
jQuery.extend({
    SmartForm: {
        // 所有的请求入口
        AjaxUrl: "/Form/OnAction",
        BaseActionName: "DoAction",
        // 表单编码
        FormCode: "",
        // 加载参数值,会根据各种信息，构造出是流程表单加载还是Bo开发平台加载,替换原来
        RequestParameters: {},

        // 所有跟后台交互，都通过Action_****
        // 加载
        Action_Load: "Load",
        // 加载表单标示
        LOADKEY: "Load",
        // 所有事件集合
        Actions: [],
        // 保存表单标示
        Action_Save: "Save",
        // 修改
        Action_Modify: "Modify",
        // 删除表单标示
        Aciton_Remove: "Remove",
        // 打印表单
        Action_Print: "Print",
        // 取消流程
        Action_CancelInstance: "CancelInstance",
        // 驳回
        Action_Reject: "Reject",
        // 提交
        Action_Submit: "Submit",
        // 取回流程
        Action_RetrieveInstance: "RetrieveInstance",
        // 结束流程
        Action_FinishInstance: "FinishInstance",
        // 查看流程实例
        Action_ViewInstance: "ViewInstance",
        // 转发
        Action_Forward: "Forward",
        // 查看二维码
        Action_QrCode: "ViewQrCode",
        // 关闭
        Action_Close: "Close",
        //提交中
        IsPosting: false,

        //表单是否加载完
        IsLoaded: false,
        //add by rmd  用来存储所有Tab页的表单数据
        TabResData: {},

        // 审批节点类型
        WorkItemType: {
            // 普通工作项
            Fill: 0,
            // 审批节点
            Approve: 2
        },

        //// 提交并添加
        //SubmitAndAdd: {
        //    Action: "SubmitAndAdd", Icon: "icon-ok", Text: "提交并添加", OnActionDone: function (data) {
        //        if (data.Successful) {
        //            if (window.parent.$.ListView != null && $.isFunction(window.parent.$.ListView.RefreshView)) {
        //                window.parent.$.ListView.RefreshView();
        //            }
        //            var href = window.location.href;
        //            href = href.replace("&mid=", "&mid=" + Math.round(Math.random() * 100, 0));
        //            window.location.href = href;
        //        } else {
        //            if (data.Errors != void 0 && data.Errors != null && data.Errors.length > 0) {
        //                $.IShowError('错误', data.Errors[0]);
        //            }
        //        }
        //        return false;
        //    }
        //},

        // 表单数据类型
        SmartFormDataType: {
            /// 未指定
            Unspecified: 0,
            /// 流程数据
            Workflow: 1,
            /// 业务对象
            BizObject: 2
        },

        // 表单状态
        SmartFormMode: {
            // 未指定
            Unspecified: -1,
            // 编辑模式
            Edit: 0,
            // 查看模式
            Readonly: 1,
            // 发起流程
            Create: 2,
            // 打印模式
            Print: 3
        },

        //  表单状态
        BizObjectStatus: {
            Draft: 0, //草稿
            Effective: 1, //审批通过或表单提交后
            Running: 2, //流程运行中
            Canceled: 3 //被取消
        }
    }
});

// 函数定义
jQuery.extend(
    $.SmartForm,
    {
        // 初始化
        // Error: 移动端参数需要打包传递
        Init: function (ResponseContext) {
            this.IsLoaded = false;
            // 是否调试状态
            if (ResponseContext.DebugTrack != null && ResponseContext.DebugTrack.DebugState == 0) {
                parent.$.IPushDebugTrack(ResponseContext, this, this.Run);
            }
            else {
                // 运行表单
                this.Run(ResponseContext);
            }
            this.IsLoaded = true;
        },

        // 运行
        Run: function (ResponseContext) {
            if (ResponseContext.constructor != Object) {
                //经过apply返回的参数，constructor是判断不了的
                ResponseContext = JSON.parse(JSON.stringify(ResponseContext));
            }

            var that = this;
            that.ResponseContext = ResponseContext;
            that.RequestParameters = ResponseContext.RequestParameters;
            // 失败
            if (!ResponseContext.Successful) {

                // 提示错误信息
                for (var i = 0; i < ResponseContext.Errors.length; i++) {
                    // $.IShowError('错误', ResponseContext.Errors[i]);
                    Message.error({
                        content: ResponseContext.Errors[i],
                        duration: 3
                    });

                }
                return;
            }
            // 输出Debug日志
            that.DebugLog(ResponseContext.DebugLogs);
            that.TabResData[store.state.listview.currentTabIndex] = ResponseContext
            that.UpgradeHtml();

            // 渲染表单属性：动态、关联列表、任务
            that.RenderFormProperty(ResponseContext);
            that.IsPosting = false;

            // // 移动端处理
            if (that.ResponseContext.IsMobile) {
                if (ResponseContext != null && ResponseContext.Actions != void 0) {
                    // 初始化Action集合
                    that.Actions = [];
                    for (var action in ResponseContext.Actions) {
                        that.Actions.push(ResponseContext.Actions[action]);
                    }
                }

                // 移动端去掉一行两列布局
                var $layouts = [];
                var $colsm6;
                if (ResponseContext.SheetView) {
                    $colsm6 = $(ResponseContext.SheetView).find(".col-sm-6");
                }
                else {
                    $colsm6 = $(".col-sm-6");
                }
                $colsm6.each(function () {
                    var $control = $(this).children(".sheet-control");
                    var $parent = $(this).parent();
                    $parent.before($control);
                    $layouts.push($parent);
                });
                for (var i = 0; i < $layouts.length; i++) {
                    $layouts[i].remove();
                }
            }
            // // 加载所有的控件
            that.Load(ResponseContext);

            //清空Invalid状态
            that.ClearInvalidState();

            // 清空描述
            that.HideEmptyHeader();

            // 隐藏空的tab页签
            that.HideEmptyTab(ResponseContext);
        },

        // Html 升级
        UpgradeHtml: function () {
            // 1. 读取所有控件
            // 2. 控件标示修改：Sheet =》 Form
            // 3. 多行文本 =》 换控件
            // 4. 多人参与者 =》 多人控件

            var $sheet = "";
            if (this.ResponseContext.IsMobile) {
                $sheet = this.ResponseContext.SheetView;
            }
            else {
                $sheet = $("#SheetContent");
            }
            $sheet.find('.col-sm-6').addClass('col-xs-6 col-md-6');//兼容其他屏幕尺寸
            var rows = $sheet.find("div.sheet-control[data-controlkey^='Sheet']");
            for (var i = 0; i < rows.length; i++) {
                var $row = $(rows[i]);
                var controlkey = $row.attr("data-controlkey");
                controlkey = "Form" + controlkey.substring("sheet".length, controlkey.length);
                if (controlkey.toLocaleLowerCase() == "formtextbox") {
                    var isMultiple = $row.attr("data-IsMultiple");
                    if (isMultiple != null && (isMultiple.toLocaleLowerCase() == "true" || isMultiple == true)) {
                        controlkey = "FormTextArea";
                    }
                }
                else if (controlkey.toLocaleLowerCase() == "formuser") {
                    var isMultiple = $row.attr("data-IsMultiple");
                    if (isMultiple != null && (isMultiple.toLocaleLowerCase() == "true" || isMultiple == true)) {
                        controlkey = "FormMultiUser";
                    }
                }
                else if (controlkey.toLocaleLowerCase() == "formuser") {
                    var isCheckbox = $row.attr("data-isCheckbox");
                    if (isCheckbox != null && (isCheckbox.toLocaleLowerCase() == "true" || isCheckbox == true)) {
                        controlkey = "FormCheckbox";
                    }
                }
                $row.attr("data-controlkey", controlkey);
            }
        },

        // 绑定数据
        Load: function (ResponseContext) {
            var that = this;
            console.log(this);
            // 编码不存在
            if ($.isEmptyObject(ResponseContext.SchemaCode)) {
                //$.IShowError(ResponseContext.Message);
                Message.error({
                    content: ResponseContext.Message,
                    duration: 3
                });
                // Error: 调用this.Close();
                if (ResponseContext.IsMobile && H3Config.GlobalHistory) {
                    H3Config.GlobalHistory.goBack();
                }
                return;
            }

            // 设置从后台加载过来的数据
            this.ResponseContext = ResponseContext;

            // 判断元素类型，渲染成MvcControl
            if (this.ResponseContext.IsMobile) {
                $.ControlManager.ClearControls();
                this.ResponseContext.SheetView.find("div[data-controlkey]:not(.table_th)").each(function () {
                    // 初始化控件
                    $(this).JControl();
                });
            }
            else {
                // PC端
                $.ControlManager.ClearControls(this.ResponseContext.SchemaCode);
                $.ControlManager.SetSchemaCode(this.ResponseContext.SchemaCode);
                /* $("div[data-controlkey]:not(.table_th)").each(function () {
                     //初始化控件
                     $(this).JControl();
                 });*/
                let allJControl = $('div[data-controlkey]:not(.table_th)');
                let container = $('.open-modal-scroll-container');
                let step = 6; // 每次滚动渲染的个数
                let start = 0; // 起始
                let end = 10000; // 结束
                let partialRendering = function (originData, startNum, endNum) {
                    if (originData.length > 0 && originData.length > startNum) {
                        originData.slice(startNum, endNum).each(function () {
                            // 初始化控件
                            $(this).JControl();
                        });
                    } else {
                        container.off('scroll');
                    }
                };
                partialRendering(allJControl, start, end);
                let partialRenderingCb = throttle(function () {
                    start = end;
                    end += step;
                    console.log(start, end);
                    partialRendering(allJControl, start, end);
                });
                container.off('scroll').on('scroll', partialRenderingCb);
                /* let scroll = new BScroll(container[0], {
                  scrollbar: {
                    fade: false,
                    interactive: true
                  },
                  mouseWheel: true,
                  probeType: 1

                })
                scroll.on('scroll', () => {
                  start = end;
                  end += step;
                  partialRendering(allJControl, start, end);
                }) */
            }

            // 初始化工具栏
            this.InitToolBar();

            if (this.ResponseContext.IsMobile) {
                // 审批控件且有审批意见
                if (!this.ResponseContext.IsCreateMode && this.ResponseContext.InstanceId) {
                    //审批环节,需要添加审批控件
                    var $CommentControl = $("<div class='row sheet-control form-group'>").attr({
                        "data-DataField": "Comments",
                        "data-controlkey": "FormComment",
                        "data-DisplayName": "审批"
                    });//.addClass("row sheet-control form-group");
                    if (this.ResponseContext.SheetView) {
                        $(this.ResponseContext.SheetView).find(".sheetcontentdiv").prepend($CommentControl);
                    }
                    else {
                        $(".sheetcontentdiv:last").prepend($CommentControl);
                    }
                    this.CommentManager = $CommentControl.FormComment(this.ResponseContext.Comments);
                }
            } else {
                // 审批控件且有审批意见
                if (this.ResponseContext.WorkItemType == 2 || (!$.isEmptyObject(this.ResponseContext.Comments) && this.ResponseContext.Comments.length > 0)) {
                    //审批环节,需要添加审批控件
                    var $CommentControl = $("<div class='row sheet-control form-group'>").attr({
                        "data-DataField": "Comments",
                        "data-controlkey": "FormComment",
                        "data-DisplayName": "审批"
                    });//.addClass("row sheet-control form-group");
                    $("#SheetContent").append($CommentControl);
                    this.CommentManager = $CommentControl.FormComment(this.ResponseContext.Comments);
                }
            }


            // 调用自定义加载事件
            $.JForm._OnLoad(this);
        },

        // 渲染表单属性，动态，任务，关联列表
        RenderFormProperty: function (ResponseContext) {
            if (this.ResponseContext.IsMobile ||
                ResponseContext.IsCreateMode ||
                ResponseContext.BizObjectStatus == this.BizObjectStatus.Draft ||
                ResponseContext.BizObjectStatus == this.BizObjectStatus.Running) return;

            var $newTabs = [];
            var tabNames = [];
            if (ResponseContext.EnableFormSns) {
                var $snsTab = $("<div class='tab-pane'>")/*.addClass("tab-pane")*/.append($("<div data-controlkey='FormSns' class='row sheet-control SheetSns'>")/*.addClass("row sheet-control SheetSns")*/);
                $newTabs.push($snsTab);
                tabNames.push("动态");
            }
            if (ResponseContext.EnableTask) {
                var $taskTab = $('<div class="tab-pane">').append($('<div data-controlkey="FormTaskTips" class="row sheet-control SheetTaskTips">'));
                $newTabs.push($taskTab);
                tabNames.push("任务提醒 ");
            }

            if (!$.isEmptyObject(ResponseContext.AssociationLists)) {
                for (var code in ResponseContext.AssociationLists) {
                    var $boListTab = $("<div class='tab-pane'>");//.addClass("tab-pane");
                    var $boList = $("<div data-controlkey='FormBoList' class='row sheet-control SheetBoList'>")/*.addClass("row sheet-control SheetBoList")*/.attr("data-BOSchemaCode", code);
                    $boListTab.append($boList);
                    $newTabs.push($boListTab);
                    tabNames.push(ResponseContext.AssociationLists[code]);
                }
            }


            if ($newTabs.length > 0 && !this.ResponseContext.IsMobile) {
                var $tabs = $("<ul class='nav nav-tabs'>");//.addClass("nav nav-tabs");
                var $tabcontent = $("<div class='tab-content'>");//.addClass("tab-content");

                var tabId = $.IGuid();
                var $li = $("<li class='active'>");
                var $a = $('<a href="#' + tabId + '" data-toggle="tab" aria-expanded="true"><strong>' + ResponseContext.DisplayName + '信息</strong></a>')
                var $sheetTab = $("<div id='" + tabId + "' class='tab-pane active'>")/*.addClass("tab-pane active")*/.html($("#SheetContent").html());

                $tabs.append($li.append($a));
                $tabcontent.append($sheetTab);

                for (var i = 0; i < $newTabs.length; i++) {
                    var tabId = $.IGuid();
                    var $li = $("<li>");
                    var $a = $('<a href="#' + tabId + '" data-toggle="tab" aria-expanded="true"><strong>' + tabNames[i] + '</strong></a>')
                    $tabs.append($li.append($a));
                    $tabcontent.append($newTabs[i].attr("id", tabId));
                }

                $("#SheetContent").html("").append($("<div class='nav-tabs-wrap'></div>").append($tabs)).append($tabcontent);//edit by xc
            }
        },

        // 隐藏空的tab页签
        HideEmptyTab: function (ResponseContext) {
            var that = this;
            var isCreateMode = ResponseContext.IsCreateMode;
            var isApproving = ResponseContext.BizObjectStatus == this.BizObjectStatus.Draft || ResponseContext.BizObjectStatus.Running;
            if (isCreateMode || isApproving) {
                var tabpanels;
                if (ResponseContext.SheetView) {
                    tabpanels = $(ResponseContext.SheetView).find("#tabContent>.tab-pane");
                }
                else {
                    tabpanels = $("#tabContent>.tab-pane");
                }

                if (tabpanels == null || tabpanels.length == 0) return;

                var $sheetTabpanel;
                for (var ti = 0, tlen = tabpanels.length; ti < tlen; ti++) {
                    var $tabpanel = $(tabpanels[ti]);
                    var controls = $tabpanel.children();
                    var needHide = true;
                    for (var ci = 0, clen = controls.length; ci < clen; ci++) {
                        var $control = $(controls[ci]);
                        var controlKey = $control.attr("data-controlkey");
                        var visiable = false;
                        // 一行两列布局控件
                        if (!controlKey) {
                            $control.find(".sheet-control").each(function () {
                                if ($(this).css("display") != "none") {
                                    visiable = true;
                                }
                            });
                        }
                        else {
                            visiable = $control.css("display") != "none";
                        }

                        // 审批中时，把只含关联列表、隐藏控件的标签隐藏起来
                        if (isCreateMode && controlKey != "SheetBoList" && controlKey != "SheetSns" && visiable
                            || !isCreateMode && isApproving && controlKey != "SheetBoList" && visiable) {
                            needHide = false;
                            break;
                        }
                    }
                    if (needHide) {
                        $tabpanel.hide();
                        if (ResponseContext.SheetView) {
                            $(ResponseContext.SheetView).find("#navTabs").find("li[data-panelid='" + $tabpanel.attr("id") + "']").hide();
                        }
                        else {
                            $("#navTabs").find("li[data-panelid='" + $tabpanel.attr("id") + "']").hide();
                        }
                    }
                    else {
                        if (!$sheetTabpanel) {
                            $sheetTabpanel = $tabpanel;
                        }
                    }
                }
            }
            // 只有一个可见的navTab时，将其隐藏
            var $visibleTabs;
            if (ResponseContext.SheetView) {
                $visibleTabs = $(ResponseContext.SheetView).find("#navTabs>li:visible");
            }
            else {
                $visibleTabs = $("#navTabs>li:visible");
            }
            if ($visibleTabs.length == 1) {
                $visibleTabs.hide();
            }

            // Panel都不显示时，将包含表单内容的Panel显示出来
            var $visiblePanel;
            if (ResponseContext.SheetView) {
                $visiblePanel = $(ResponseContext.SheetView).find("#tabContent>.tab-pane:visible");
            }
            else {
                $visiblePanel = $("#tabContent>.tab-pane:visible");
            }
            if ($visiblePanel.length == 0) {
            }
        },

        // 清空描述
        HideEmptyHeader: function () {
            //如果"分组标题"后面的控件都隐藏，则隐藏"分组标题"
            //确定哪些describle显示
            //显示所有描述
            var $headerDescribles = $(".page-header.page-describle"); //描述
            var $headerTitles = $(".page-header").not(".page-describle"); //分组标题
            $headerDescribles.css({ "display": "block" });

            for (var i = 0; i < $headerTitles.length; i++) {
                var isEmpty = true;
                var $headerTitle = $($headerTitles[i]);
                var $nextControl = $headerTitle.next();
                var $nextControlIsDescrible = false;
                var $nextControlIsTitle = false
                var $nextControlIsDisplay = $nextControl.css("display") != "none";

                //如果当前"分组标题"不可见，则不执行以下操作
                if ($headerTitle.css("display") == "none") {
                    continue;
                }
                //如果当前"分组标题"后面的控件也是"分组标题",则隐藏当前"分组标题"
                //如果当前"分组标题"后面的控件都不可见，则隐藏当前"分组标题"
                while ($nextControl.length > 0) {
                    $nextControlIsDescrible = $nextControl.hasClass("page-header") && $nextControl.hasClass("page-describle");
                    $nextControlIsTitle = $nextControl.hasClass("page-header") && !$nextControl.hasClass("page-describle");
                    $nextControlIsDisplay = $nextControl.css("display") != "none";

                    if ($nextControlIsDescrible && $nextControlIsDisplay) {
                        isEmpty = false;
                        break;
                    }
                    if ($nextControlIsTitle) break;
                    var controlKey = $nextControl.attr("data-controlKey");
                    if (!controlKey) {
                        $nextControl.find(".sheet-control").each(function () {
                            if ($(this).css("display") != "none") {
                                isEmpty = false;
                                return false;
                            }
                        });
                    } else {
                        if (controlKey != "FormComment") {
                            if ($nextControl.css("display") != "none") {
                                isEmpty = false;
                                break;
                            }
                        }
                    }
                    $nextControl = $nextControl.next();
                }
                if (isEmpty) {
                    $headerTitle.css({ "display": "none" });
                }
            }
        },

        // 开放给开发者的接口:校验
        ValidateAction: function (ActionControl) {
            let result = -1;
            if ($.JForm._OnValidate(this, ActionControl)) {
                result = $.ControlManager.Validate(ActionControl);
                if (result == -1) {
                    Message.error({
                        content: '必填项，不能为空',
                        duration: 3
                    })
                }
                else if(result==-2){
                    // Message.error({
                    //     content: '校验失败',
                    //     duration: 3
                    // })
                }
            }
            return result==1;
        },

        // 初始化工具栏
        InitToolBar: function () {
            //添加默认的操作
            // 初始化Actions,避免不同页面间按钮覆盖
            this.Actions = []
            if (this.Actions && this.Actions.length == 0) {
                this.AddDefaultActions();
            }

            // 调用自定义按钮
            $.JForm._OnLoadActions(this, this.Actions);

            // 移动端不直接显示工具栏
            if (this.ResponseContext && !this.ResponseContext.IsMobile) {
                //表单显示在弹出框时，ToolBar显示到表单底部
                if (this.ResponseContext.ShowInModal) {
                    $("ul[data-sheettoolbar='true']").closest("nav.sheet-navbar").addClass("hide");
                    $("ul[data-sheettoolbar-bottom='true']").closest("nav.sheet-navbar").removeClass("hide");

                    //去掉关闭按钮和二维码
                    var temp = [];
                    for (var i = 0; i < this.Actions.length; i++) {
                        if (this.Actions[i].Action != "ViewQrCode" && this.Actions[i].Action != "Code") {
                            temp.push(this.Actions[i]);
                        }
                    }
                    $("ul[data-sheettoolbar-bottom='true']").FormToolBar(temp);
                } else {
                    $("ul[data-sheettoolbar='true']").FormToolBar(this.Actions);
                }
            } else {
                //显示更多按钮逻辑
            }
        },

        // 执行动作: {Action:"方法名称",Datas:[{数据项1},{数据项2}]}
        OnAction: function (actionControl) {
            //执行动作标示
            var actionName = actionControl.Action;
            //参数：[{数据项1},{数据项2},...]或["#ID1"，"#ID2",...]或["数据1","数据2"]或混合
            var datas = actionControl.Datas;

            if (actionName == "ViewQrCode") {
                return false;
            }
            //全屏
            if (actionName == 'FullScreen') {
                var url = window.location.href;
                var h = window.top.document.body.offsetHeight;
                var w = window.top.document.body.offsetWidth;
                var fullWindow = window.open(url, 'big', 'fullscreen=yes,height=' + h + ',width=' + w);
                this.ClosePage();
                return false;
            }

            if (actionName != "Remove" && actionName != "Read") {
                if (!$.JForm._OnValidate(this, actionControl)) {
                    return false;
                }
            }
            //构造数据项的值
            var CommandParams = {
                Command: actionName
            };
            var params = [];
            if (typeof (actionControl.LoadControlValue) == "undefined" || actionControl.LoadControlValue) {
                if (datas) {
                    for (var i = 0; i < datas.length; i++) {
                        if (datas[i].toString().indexOf("{") == 0) {
                            var key = datas[i].replace("{", "").replace("}", "");
                            params.push($.ControlManager.GetControlValue(key));
                        }
                        else if (datas[i].toString().indexOf("#") == 0) {
                            var key = datas[i].replace("#");
                            params.push($.ControlManager.GetControlValue(datas[i]));
                        }
                        else {
                            params.push(datas[i]);
                        }
                    }
                }
            }
            else {
                params = datas;
            }
            CommandParams["Param"] = JSON.stringify(params);
            CommandParams["PostValue"] = JSON.stringify(this.GetPostValue(this.actionName));

            var that = this;
            //提交到后台执行
            this.PostForm(actionName,
                CommandParams,
                function (data) {
                    that.ResultHandler.apply(that, [actionControl, data]);
                    if (actionControl.CloseAfterAction) {
                        this.ClosePage();
                    }
                }
            );
        },

        // Error: 交互提示
        ConfirmAction: function (message, doneCallback) {

            // 判断是否移动端
            if (this.ResponseContext.IsMobile) {
                if (H3Config.GlobalIonicPopup) {
                    var confirmPopup = H3Config.GlobalIonicPopup.confirm({
                        template: message,
                        title: '操作',
                        cancelText: '取消',
                        okText: '确定'
                    });
                    confirmPopup.then(function (res) {
                        if (res) {
                            doneCallback();
                        }
                    });
                }
            }

            else {
                $.IConfirm("", message, function (isTrue) {
                    if (isTrue) {
                        doneCallback.call();
                    }
                });
            }
        },

        // 保存
        Save: function (actionControl) {
            if (!this.ValidateAction(actionControl)) return false;
            var SheetPostValue = this.GetPostValue(this.Action_Save);
            var that = this;
            if (that.IsPosting) return;
            that.IsPosting = true;


            Message.warning({
                content: '正在努力提交中...',
                duration: 1
            });

            var param = {}
            param.postValue = JSON.stringify(SheetPostValue.Data);
            param.appId = actionControl.ResponseContext.SchemaCode;
            param.appRunId = actionControl.ResponseContext.appRunId;
            HTTP.commitDraft(param).then((data) => {
                if (data.code == 0) {
                    Message.success({
                        content: '暂存成功',
                        duration: 3
                    });

                    // 应用新增提交成功后关闭Tab
                    $('#app-add-submit-success').click();
                }
                else {
                    Message.error({
                        content: '暂存失败',
                        duration: 3
                    });

                }
            }).catch((e) => {
                Message.error({
                    content: e.message,
                    duration: 3
                });
            }).finally(() => {
                that.IsPosting = false;
            })

            // this.PostForm(this.Action_Save,
            //     { PostValue: JSON.stringify(SheetPostValue) },
            //     function (data) {
            //         $.IHidePreLoader();
            //         that.ResultHandler.apply(that, [actionControl, data]);
            //     });
        },

        // 修改
        Modify: function (actionControl, text, destActivity, postValue, groupValue) {
            if (this.ValidateAction(actionControl)!=1) return false;
            var SheetPostValue = JSON.stringify($.ControlManager.GetSheetData());
            var that = this;
            if (that.IsPosting) return;
            this.IsPosting = true;

            $.IShowPreLoader('修改中');

            var param = { appRunId: actionControl.ResponseContext.appRunId, postValue: SheetPostValue };
            $('.loading-spin').show()
            HTTP.editForm(param).then((data) => {
                if (data.code != 0) {

                    Message.error({
                        content: data.msg,
                        duration: 3
                    });

                }
                else {
                    Message.success({
                        content: "修改成功",
                        duration: 3
                    });
                    // $('#searchBtn').click();
                    // rebuild ui
                    $('.mod-close-btn').click();
                    // var closeBtns = $('.ivu-modal-confirm-footer .ivu-btn-primary')
                    // closeBtns[closeBtns.length - 1].click()
                }
                that.ResultHandler.apply(that, [actionControl, data]);

            }).catch((err) => {
                console.log(err)
            }).finally(() => {
                // 回调DoActionDone函数
                that.IsPosting = false
                $('.loading-spin').hide()
            })

        },

        // 删除
        Remove: function (actionControl) {
            //移动端标识，是否是提交类型的操作，不缓存当前表单
            if (typeof (MobileCacheManager) != 'undefined') {
                MobileCacheManager.CurMobileFormObj.IsSubmit = true;
            }
            var that = this;
            $.IConfirm("提示", "删除后将无法恢复，确定删除？", function (isConfirm) {
                if (isConfirm) {
                    $.IShowPreLoader('提交中');
                    Message.warning({
                        content: '正在努力提交中...',
                        duration: 3
                    });
                    return;
                    //that.TimeOut = setTimeout(function () {
                    //    that.ShowHappyLoading();
                    //}, 1500);

                    var SheetPostValue = that.GetPostValue(that.Aciton_Remove);
                    that.PostForm(that.Aciton_Remove, { PostValue: JSON.stringify(SheetPostValue) },
                        function (data) {
                            $.IHidePreLoader();
                            //that.HideHappyLoading();
                            //that.TimeOut && window.clearTimeout(that.TimeOut);
                            that.ResultHandler.apply(that, [actionControl, data]);
                        });
                }
            });
        },

        // 转发
        Forward: function (actionControl) {
            if (!this.ForwardModal) {
                var $divForward = $("#divForward").show();
                var $participant = $divForward.find("#forwardParticipant");
                var $comment = $divForward.find('#forwardComment');
                var sheetUserMgr = $participant.FormUser();
                $participant.removeClass("form-group");

                var that = this;
                var Actions = [{
                    Key: "btn_Ok",
                    Text: "确定",
                    Theme: 'btn_ok',
                    CallBack: function () {
                        var participants = sheetUserMgr.GetUnitIDs();
                        if (!participants || participants.length == 0) {
                            Message.error({
                                content: ResponseContext.Message,
                                duration: 3
                            });
                            return;
                        }
                        var comment = $comment.val();


                        var SheetPostValue = that.GetPostValue(that.Action_Forward);
                        SheetPostValue.ForwardTo = participants[0];
                        if (comment) {
                            SheetPostValue.Comment = {
                                CommentId: $.IGuid(),
                                Text: comment,
                                IsNewComment: true
                            };
                        }
                        that.PostForm(that.Action_Forward,
                            { PostValue: JSON.stringify(SheetPostValue) },
                            function (data) {
                                that.ResultHandler.apply(that, [actionControl, data]);
                            });
                    }
                },
                {
                    Text: '取消',
                    Theme: 'btn_cancel',
                    CallBack: function () {
                        that.ForwardModal.hide();

                    }
                }];
                this.ForwardModal = $.IModal({
                    Title: '转发',
                    Width: 500,
                    Height: 300,
                    ShowBack: true,
                    HasIframe: false,
                    Content: $divForward,
                    ToolButtons: Actions,
                    ContentUrl: ''
                });
            }
            else {
                this.ForwardModal.show();
            }
        },

        // 提交
        Submit: function (actionControl, text, destActivity, postValue, groupValue) {
            var that = this;
            //if (that.IsPosting) return;
            if (that.IsPosting) {
                //$.IShowWarn('','正在努力提交中...');
                Message.warning({
                    content: '正在努力提交中...',
                    duration: 3
                });
                return;
            }
            //移动端标识，是否是提交类型的操作，不缓存当前表单
            if (typeof (MobileCacheManager) != 'undefined') {
                MobileCacheManager.CurMobileFormObj.IsSubmit = true;
            }
            if (actionControl.Text != "已阅" && this.ValidateAction(actionControl)!=1) {
                if (this.ResponseContext.IsMobile) {
                    MobileCacheManager.CurMobileFormObj.Submitting = false;
                }
                return false;
            }
            $.IShowPreLoader('提交中');
            //that.TimeOut = setTimeout(function () {
            //    that.ShowHappyLoading();
            //}, 1500);

            this.IsPosting = true;
            //提交API
            try {
                var SheetPostValue = that.GetPostValue(that.Action_Submit, destActivity, postValue, groupValue, actionControl.ResponseContext.SchemaCode);
            }
            catch (e) {
                console.log(e)
                this.IsPosting = false;
            }
            SheetPostValue.schemaCode = window.currentCode;
            if (this.ResponseContext.IsMobile) {
                if (text) {
                    var result = {
                        CommentId: $.IGuid(),
                        Text: text,
                        IsNewComment: true
                    };
                    SheetPostValue.Comment = result;
                } else {
                    var result = {
                        CommentId: $.IGuid(),
                        Text: '',
                        IsNewComment: true
                    };
                    SheetPostValue.Comment = result;
                }
            }
            //提交API
            //luzx add formalaExecAndStartFlow2
            if (store.state.listview.currentTabType!='modify') {
                if ($('.loading-spin').is(':visible')) {
                    return
                }
                $('.loading-spin').show()

                HTTP.formalaExecAndStartFlow({ postValue: JSON.stringify(SheetPostValue.Data), appId: actionControl.ResponseContext.SchemaCode })
                    .then(data => {
                        //$.IHidePreLoader();
                        //that.HideHappyLoading();
                        //that.TimeOut && window.clearTimeout(that.TimeOut);
                        if (data.code != 0) {
                            //$.IShowError('',data.msg);
                            Message.error({
                                content: data.msg,
                                duration: 3
                            });
                            //return 0;
                        }
                        else {
                            //$.IShowSuccess('',"提交成功");
                            //$.ControlManager.ClearControls()
                            Message.success({
                                content: '提交成功',
                                duration: 3
                            });
                            $('#searchBtn').click();

                            // 应用新增提交成功后关闭Tab
                            $('#app-add-submit-success').click();

                            var modals = $('#createNewApp')
                            var currentModal = modals.eq(0)
                            var closeBtns = currentModal.find('.ivu-modal-close')
                            if (!!closeBtns.length) {
                                closeBtns[closeBtns.length - 1].click()
                                $.ControlManager.ClearControls();
                            }
                            var tmpClose = currentModal.find('.close-btn')
                            if (!!tmpClose.length) {
                                $('.close-btn')[tmpClose.length - 1].click()
                            }
                        }
                        // 从关联查询跳转到非流程表单中新增关联对象，在提交后，将值反写回去
                        var sheetQueryField = $.IQuery("SheetQueryField");
                        if (sheetQueryField && that.ResponseContext.FormDataType == that.SmartFormDataType.BizObject) {
                            var rowId = $.IQuery("SheetQueryRowId");
                            if (window.parent != window && window.parent.$.SmartForm) {
                                window.parent.$.SmartForm.WritebackSheetQuery(rowId, sheetQueryField, data.BizObjectId, data.InstanceName);
                            }
                        }
                        that.ResultHandler.apply(that, [actionControl, data]);

                    })
                    .catch(err => {
                        Message.error(err)
                        
                    }).finally(() => {
                        $('.loading-spin').hide();
                        trigger.emit('start-and-load-flow');
                        that.IsPosting=false
                    })

            } else {
                HTTP.formalaExecAndStartFlow2({ postValue: JSON.stringify(SheetPostValue.Data), appRunId: window.appRunId_, isDraft: actionControl.ResponseContext.IsDraft })
                    .then(data => {
                        //$.IHidePreLoader();
                        //that.HideHappyLoading();
                        //that.TimeOut && window.clearTimeout(that.TimeOut);
                        if (data.code != 0) {
                            //$.IShowError('',data.msg);
                            Message.error({
                                content: data.msg,
                                duration: 3
                            });
                            //return 0;
                        }
                        else {
                            //$.IShowSuccess('',"提交成功");
                            Message.success({
                                content: '提交成功',
                                duration: 3
                            });
                            // 刷新数据
                            $('#searchBtn').click();
                            // 应用新增提交成功后关闭Tab
                            $('#app-add-submit-success').click();
                            var modals = $('#createNewApp')
                            var currentModal = modals.eq(0)
                            var closeBtns = currentModal.find('.ivu-modal-close')
                            if (!!closeBtns.length) {
                                closeBtns[closeBtns.length - 1].click()
                                $.ControlManager.ClearControls();
                            }
                            var tmpClose = currentModal.find('.close-btn')
                            if (!!tmpClose.length) {
                                $('.close-btn')[tmpClose.length - 1].click()
                            }
                        }
                        // 从关联查询跳转到非流程表单中新增关联对象，在提交后，将值反写回去
                        var sheetQueryField = $.IQuery("SheetQueryField");
                        if (sheetQueryField && that.ResponseContext.FormDataType == that.SmartFormDataType.BizObject) {
                            var rowId = $.IQuery("SheetQueryRowId");
                            if (window.parent != window && window.parent.$.SmartForm) {
                                window.parent.$.SmartForm.WritebackSheetQuery(rowId, sheetQueryField, data.BizObjectId, data.InstanceName);
                            }
                        }
                        that.ResultHandler.apply(that, [actionControl, data]);

                    })
                    .catch(err => {
                        this.$Message.error(err)
                    }).finally(() => {
                        $('.loading-spin').hide();
                        that.IsPosting=false
                        trigger.emit('start-and-load-flow');
                    })

            }

            return true;
        },

        // 关联查询新增，返写回界面
        WritebackSheetQuery: function (rowId, fieldName, ObjectId, displayName) {
            var $element;
            if (rowId) {
                $element = $("tr[data-ObjectId='" + rowId + "']").find("[data-datafield='" + fieldName + "']").not('.table_th');
            }
            else {
                $element = $("[data-datafield='" + fieldName + "']").not('.table_th');
            }
            if ($element.length > 0) {
                var controlManager = $element.JControl();
                if (controlManager) {
                    controlManager.SetValue({ ObjectId: ObjectId, Name: displayName });
                    controlManager._refreshTable();
                }
            }
        },

        // 驳回
        Reject: function (actionControl, destActivity, text) {
            if (!$.JForm._OnValidate(this, actionControl)) {
                return false;
            }

            var SheetPostValue = this.GetPostValue(this.Action_Reject, destActivity);
            if (this.ResponseContext.IsMobile) {
                if (text) {
                    var result = {
                        CommentId: $.IGuid(),
                        Text: text,
                        IsNewComment: true
                    };
                    SheetPostValue.Comment = result;
                } else {
                    var result = {
                        CommentId: $.IGuid(),
                        Text: '',
                        IsNewComment: true
                    };
                    SheetPostValue.Comment = result;
                }
            }
            var that = this;
            this.PostForm(that.Action_Reject, { PostValue: JSON.stringify(SheetPostValue) }, function (data) {
                that.ResultHandler.apply(that, [actionControl, data]);
            });
        },

        //结束流程
        FinishInstance: function (actionControl) {
            IsSubmit = true;
            var SheetPostValue = this.GetPostValue(this.Action_FinishInstance);
            var that = this;
            this.PostForm(that.Action_FinishInstance,
                { PostValue: JSON.stringify(SheetPostValue) },
                function (data) {
                    that.ResultHandler.apply(that, [actionControl, data]);
                });
        },

        // 取回流程
        RetrieveInstance: function (actionControl) {
            var that = this;
            this.PostForm(this.Action_RetrieveInstance,
                {},
                function (data) {
                    that.ResultHandler.apply(that, [actionControl, data]);
                });
        },

        ViewQrCode: function (actionControl) {
            var that = this;
            //二维码提示框
            var $action = actionControl.Element;
            $("#action_more").parent().hide();//
            if ($("#dvQrCode").length > 0) {
                $("#dvQrCode").parent().show();//鼠标移入按钮时一直显示
                return false;
            }

            var tipText = "钉钉扫码查看数据";
            var fontSize = 16;
            if (that.ResponseContext.IsCreateMode) {
                tipText = "钉钉扫码添加数据";
                if (that.ResponseContext.IsExternalForm) {
                    tipText = "复制二维码，分享给好友";
                    fontSize = 14;
                }
            }

            var $QrCodeTip = $('<div class="qrcode-tip" style="height:220px;width:200px;text-align:center;padding:10px;font-size:' + fontSize + 'px;display:none"><div id="dvQrCode"></div><div>' + tipText + '<div></div>').appendTo($("body"));
            $("body").off("click.tooltip").on("click.tooltip", function (e) {
                var $target = $(e.target);
                if ($target.hasClass("fa-qrcode") || $target.hasClass("qrcode-tip") || $target.attr("id") == "dvQrCode"
                    || $target[0].tagName == "CANVAS" || $target.closest("li[data-action='ViewQrCode']").length > 0) {
                    return false;
                }
                else {
                    $QrCodeTip.hide();
                }
            })

            $QrCodeTip.off("dbclick.ToolTip").on("dbclick.ToolTip", function (e) {
                e.preventDefault();
            });
            //鼠标移开时隐藏二维码
            $QrCodeTip.off("mouseout.tooltip").on("mouseout.tooltip", function (e) {
                // console.log(e);
                var e = event || window.event;
                var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
                var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
                var x = e.pageX || e.clientX + scrollX;
                var y = e.pageY || e.clientY + scrollY;

                var offset = $QrCodeTip.offset();
                var minx = offset.left;
                var minY = offset.top;
                var maxX = offset.left + $QrCodeTip.width();
                var maxY = offset.top + $QrCodeTip.height();

                if (x < minx || x > maxX || y < minY || y > maxY) {
                    $QrCodeTip.hide();
                }
            });

            var offset = $action.offset();
            var tipDiv = $("div.qrcode-tip");
            $QrCodeTip.css({ left: offset.left + ($action.outerWidth() - $QrCodeTip.outerWidth()) / 2 - $(window).scrollLeft() - 56, bottom: $(window).height() - $action.outerHeight() - tipDiv.outerHeight() - 16 });

            $QrCodeTip.show(); //第一次显示
            var qrcodeUrl = that.ResponseContext.QrCodeUrl;
            qrcodeUrl = decodeURIComponent(qrcodeUrl);
            $("#dvQrCode").qrcode({ width: 160, height: 160, text: qrcodeUrl });

            return false;
        },

        // 获取Mvc表单传给后台的数据
        GetPostValue: function (actionName, destActivity, postValue, groupValue, schemaCode) {
            var SheetPostValue = {
                Command: actionName,
                DestActivityCode: destActivity,
                InstanceName: "",
                Data: {},//当前表单的数据项集合值
                Comment: {}
            };

            if (actionName == this.Aciton_Remove || actionName == this.Action_Forward) {
                return SheetPostValue;
            }

            SheetPostValue.Data = $.ControlManager.SaveSheetData(schemaCode);
            //区分移动端和pc端
            if (this.ResponseContext.IsMobile) { }
            else {
                if (this.CommentManager) {
                    SheetPostValue.Comment = this.CommentManager.SaveDataField();
                    if (SheetPostValue.Comment.Text == null || SheetPostValue.Comment.Text == "") {
                        if (actionName == "Submit") {
                            var result = {
                                CommentId: $.IGuid(),
                                Text: "同意",
                                IsNewComment: true
                            };
                            SheetPostValue.Comment = result;
                        } else if (actionName == "Reject") {
                            var result = {
                                CommentId: $.IGuid(),
                                Text: "不同意",
                                IsNewComment: true
                            };
                            SheetPostValue.Comment = result;
                        }
                    }
                }
            }

            SheetPostValue.Priority = $.ControlManager.Priority;
            SheetPostValue.HiddenFields = $.ControlManager.HiddenFields;
            return SheetPostValue;
        },

        // 回调函数处理
        ResultHandler: function (actionControl, data) {
            if (actionControl.OnActionDone) {
                if (!actionControl.OnActionDone.apply(actionControl, [data])) {
                    this.IsPosting = false;
                    return;
                }
            }
            if (data.Successful) {
                if (data.ClosePage) {
                    // TODO:关闭当前页面，并且刷新父页面
                    //传入当前Action

                    if (data.Message) {
                        $.IShowTip(data.Message);
                    }

                    var param = { Action: actionControl.Action };
                    this.ClosePage(param);
                }
                else if (data.Url) {
                    if (window.parent.$.ListView != null && $.isFunction(window.parent.$.ListView.RefreshView)) {
                        window.parent.$.ListView.RefreshView();
                    }
                    window.location.href = data.Url;
                }
                else if (data.Refresh) {
                    if (data.Message) {
                        $.IShowTip(data.Message);
                    }
                    var href = window.location.href;
                    href = href.replace("&mid=", "&mid=" + Math.round(Math.random() * 100, 0));
                    window.location.href = href;
                }
            }
            else {
                //Error:错误提示方式需要修改
                if (data.Errors) {
                    for (var i = 0; i < data.Errors.length; i++) {
                        //top.$.IShowError('提示', data.Errors[i]);
                        Message.error({
                            content: data.Errors[i],
                            duration: 3
                        });
                    }
                }
                //虽然有错误信息，但是不是异常
                if (data.Infos && data.Infos.length > 0) {
                    for (var i = 0; i < data.Infos.length; i++) {
                        //top.$.IShowError('提示', data.Infos[i]);
                        Message.error({
                            content: data.Infos[i],
                            duration: 3
                        });
                    }
                }
                //不满足提交规则,修改标记，还可以继续提交
                this.IsPosting = false;
            }
            if (data.Message) {
                $.IShowTip(data.Message);
            }
        },

        // 关闭页面
        ClosePage: function (data) {
            //判断是否是移动端
            if (this.ResponseContext.IsMobile && H3Config.GlobalHistory) {
                //判断是否通过消息传过来的
                if (H3Config.messageType) {
                    MessageProcessed();
                } else {
                    H3Config.GlobalHistory.goBack();
                }
            } else {
                //if (window.parent.frames.length > 0) {
                if ((window.parent.frames.length > 0 && !this.ResponseContext.IsExternalForm) || (this.ResponseContext.IsExternalForm && window.parent.frames.length > window.parent.$("div[data-controlkey='FormMap']").length)) {
                    window.opener = null;
                    if (data != void 0 && data != null && data.Action == "Close") {
                    }
                    else {
                        //刷新列表
                        if (window.parent.$.ListView != null && $.isFunction(window.parent.$.ListView.RefreshView)) {
                            window.parent.$.ListView.RefreshView();
                        }
                        else if ($.isFunction(window.parent.RefreshView)) {
                            window.parent.RefreshView.call();
                        }
                    }
                    if (data != undefined) {

                    }
                    //传递action到sidemodal
                    var param = null;
                    if (data != undefined) {
                        param = { Action: data.Action };
                    }

                    //关闭弹出框
                    if (top.$.IDialogModal.ModalIdArray.length > 0) {
                        //计算表单弹出框回调函数需要传递的表单数据
                        //关闭按钮不需要执行回调函数
                        if (data && (data.Action == "Close" || data.NoFunction)) {
                            window.parent.$.IDialogModal.ExecuteHideFunction = false;
                        } else {
                            var actionName = "";
                            if (data && data.Action) { actionName = data.Action; }
                            window.parent.$.IDialogModal.SheetData = this.GetPostValue(actionName);
                        }
                        window.parent.$.IDialogModal.Close(null);
                        return;
                    }

                    window.parent.$.ISideModal.Close(null, param);
                    return;
                }

                if (navigator.userAgent.indexOf("MSIE") > 0) {
                    if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {
                        window.opener = null; window.close();
                    }
                    else {
                        window.open('', '_top'); window.top.close();
                    }
                }
                else if (navigator.userAgent.indexOf("Firefox") > 0 || navigator.userAgent.indexOf("Chrome") > 0) {
                    window.location.href = 'about:blank ';
                    window.close();
                    //window.history.go(-2);
                }
                else {
                    window.opener = null;
                    window.open('', '_self', '');
                    window.close();
                }
            }
        },

        // 添加默认的事件
        AddDefaultActions: function () {
            if (!this.ResponseContext || $.isEmptyObject(this.ResponseContext.Actions)) return;
            for (var key in this.ResponseContext.Actions) {
                //新建流程不应该有查看流程按钮
                if (this.ResponseContext.IsCreateMode
                    && this.ResponseContext.Actions[this.Action_Submit]) {
                    if (this.ResponseContext.Actions[key].Action == "ViewInstance") {
                        continue;
                    }
                }

                this.Actions.push(this.ResponseContext.Actions[key]);
            }

        },

        // 显示调试信息
        DebugLog: function (logs) {
            if (logs != null) {
                for (var i = 0; i < logs.length; i++) {
                    console.log(logs[i]);
                }
            }
        },

        //当使用POST方式时，浏览器把各表单字段元素及其数据作为HTTP消息的实体内容发送给Web服务器，
        //而不是作为URL地址的参数进行传递，使用POST方式传递的数据量要比使用GET方式传送的数据量大的多
        PostForm: function (action, data, callback, errorhandler, async) {
            var that = this;
            if (data.PostValue) {
                var PostValue = JSON.parse(data.PostValue);
                var beforSubmitResult = $.JForm._BeforeSubmit(this, action, PostValue);
                if (typeof (beforSubmitResult) != "undefined" && !beforSubmitResult) {
                    return;
                }

                data.PostValue = JSON.stringify(PostValue);
            }

            var paramData = $.extend({ Command: action }, data, this.RequestParameters);
            paramData.ActionName = this.BaseActionName;
            $.ajax({
                type: "POST",
                url: this.AjaxUrl,
                data: { PostData: JSON.stringify(paramData) },
                dataType: "json",
                async: async == null ? true : async,
                success: function (data) {
                    that.DebugLog(data.ReturnData.StartFormResponse.DebugLogs);
                    var handle = function (data) {
                        $.JForm._AfterSubmit(that, action, data);
                        if ($.isFunction(callback))
                            callback.apply(this, [data]);
                    };

                    if (data.ReturnData.StartFormResponse.DebugTrack != null && data.ReturnData.StartFormResponse.DebugTrack.DebugState == 0) {
                        parent.$.IPushDebugTrack(data.ReturnData.StartFormResponse, that, handle);
                    }
                    else {

                        handle(data.ReturnData.StartFormResponse);
                    }
                },
                error: errorhandler,
                complete: function () {
                    // that.IsPosting = false;//重置提交状态
                }
            });
        },
        ClearInvalidState: function () {
            for (var key in $.ControlManager.Controls) {
                var control = $.ControlManager.Controls[key];
                var $invalidControl = $(control.Element).find(".invalid");

                if ($invalidControl.length && control.RemoveInvalidText) {
                    control.RemoveInvalidText($invalidControl);
                }
            }
        }
    });


//封装自定义代码扩展接口
jQuery.extend({
    JForm: {
        // 已经初始化
        _isInitialization: false,
        _Init: function (form) {
            if (this._isInitialization) return;
            // 把所有控件转为 this.DataField的模式,如  this.F****.SetValue();
            for (var key in $.ControlManager.Controls) {
                if ($.ControlManager.Controls[key].DataField != null && $.ControlManager.Controls[key].DataField.toString().indexOf(".") < 0) {
                    this[$.ControlManager.Controls[key].DataField] = $.ControlManager.Controls[key];
                }
            }
            this._isInitialization = true;
            //var inp = null;
            //var inputs = $('input[type="text"]');
            //for (var i = 0, len = inputs.length; i < len; i++) {
            //    inputs[i].addEventListener('focus', function () {
            //        inp = this;
            //    }, false);
            //}
            //window.onresize = function () {
            //    var inpPos = inp.getBoundingClientRect();
            //    if (inpPos.bottom > window.innerHeight) {
            //        inp.scrollIntoView();
            //    }
            //};
        },

        // 表单加载
        _OnLoad: function (form) {
            if ($.isFunction($.JForm.OnLoad)) {
                this._Init(form);
                $.JForm.OnLoad();
            }
        },

        // 加载菜单
        _OnLoadActions: function (form, actions) {
            if ($.isFunction($.JForm.OnLoadActions)) {
                this._Init(form);
                $.JForm.OnLoadActions(actions);
            }
        },

        // 表单校验
        _OnValidate: function (Form, ActionControl) {
            if ($.isFunction($.JForm.OnValidate)) {
                this._Init(Form);
                ActionControl.doingWork = false;
                return $.JForm.OnValidate(ActionControl);
            }
            return true;
        },

        // 提交前事件
        _BeforeSubmit: function (Form, action, postValue) {
            if ($.isFunction($.JForm.BeforeSubmit)) {
                this._Init(Form);
                return $.JForm.BeforeSubmit(action, postValue);
            }
        },

        // 提交后事件
        _AfterSubmit: function (Form, action, postValue) {
            if ($.isFunction($.JForm.AfterSubmit)) {
                this._Init(Form);
                return $.JForm.AfterSubmit(action, postValue);
            }
        },

        // 清理所有自定义事件
        CleanEvents: function () {
            this.OnLoad = null;
            this.OnLoadActions = null;
            this.OnValidate = null;
            this._isInitialization = false;
        }
    }
});;
// 控件管理器
(function ($) {
    //核心属性
    $.ControlManager = {
        //页面参数属性、事件的属性
        PreDataKey: "data-",
        //已经渲染过后的标示前缀
        SheetIDKey: "jcontrolid",
        //数据项属性
        DataFieldKey: "DataField",
        //控件名称
        SheetControlKey: "controlkey",
        //表单ID
        SchemaCode: '',
        // 控件数量
        ControlCount: 0,
        // 管理器
        Controls: {},
        // 管理器备份，在移动端多个表单间切换时使用
        Controls_bak: {},
        //表单自定义js脚本，在移动端多个表单间切换时使用
        CustomJSScript_bak: {},

        // ** $.fn.Sheet{control}
        // ** 会调用这个方法,并传入作用域(this)
        // ** control [control]  控件名
        // ** parm [args] 参数(数组):从后台加载出来的相关数据
        Run: function (control, args) {
            // 读取默认属性
            var p;

            // 当前的ID
            var currentSheetIDKey = 0;
            //如果只有一个的话，就会返回
            var isOneControl = 0;
            //循环页面上的控件
            this.each(function () {
                if (!$(this).attr("data-" + $.ControlManager.SheetIDKey)) {
                    //edit by xc
                    p = $.Controls.GetDefaultOptions(control);
                    //ERROR这里把开发者没有更改的数据，也传到浏览器了，没有更改的这一部分不传;
                    if (args.length > 0) {
                        // Error:DataItem 应该是没必要的
                        $.extend(p, { DataItem: args[0] });
                        // 后台属性覆盖
                        $.extend(p, args[0]);
                    }
                    //edit end

                    // 控件数量加1
                    $.ControlManager.ControlCount++;
                    // 添加控件属性
                    currentSheetIDKey = $.ControlManager.SheetIDKey + "-" + $.ControlManager.ControlCount.toString();
                    var datafield = $(this).attr("data-" + $.ControlManager.DataFieldKey.toLocaleLowerCase());
                    p[$.ControlManager.DataFieldKey] = $(this).attr("data-" + $.ControlManager.DataFieldKey.toLocaleLowerCase());
                    $(this).attr("data-" + $.ControlManager.SheetIDKey, currentSheetIDKey);
                    // new 控件
                    if (store.state.listview.currentTabIndex !== null && store.state.listview.currentTabIndex !== undefined) {
                        var currentIndex = store.state.listview.currentTabIndex
                        $.ControlManager.Controls[$.ControlManager.SchemaCode + '_' + currentIndex][currentSheetIDKey] = new $.Controls[control](this, p, $.SmartForm.ResponseContext);
                    }
                    else {
                        $.ControlManager.Controls[$.ControlManager.SchemaCode][currentSheetIDKey] = new $.Controls[control](this, p, $.SmartForm.ResponseContext);
                    }


                }
                isOneControl++;
            });

            //如果是一个的话，返回当前控件管理器
            if (isOneControl == 1) {
                if (store.state.listview.currentTabIndex !== null && store.state.listview.currentTabIndex !== undefined) {
                    var index = store.state.listview.currentTabIndex
                    return $.ControlManager.Controls[$.ControlManager.SchemaCode + '_' + index][$(this).attr("data-" + $.ControlManager.SheetIDKey)];

                }
                else {
                    return $.ControlManager.Controls[$.ControlManager.SchemaCode][$(this).attr("data-" + $.ControlManager.SheetIDKey)];

                }
            }
        },

        SetSchemaCode: function (SchemaCode) {
            this.SchemaCode = SchemaCode
            if (store.state.listview.currentTabIndex !== null && store.state.listview.currentTabIndex !== undefined) {
                var indexNew = store.state.listview.currentTabIndex
                this.Controls[SchemaCode + '_' + indexNew] = {}
            }
            else {
                this.Controls[SchemaCode] = {}
            }

        },

        ClearControls: function (SchemaCode) {
            if (SchemaCode) {
                delete this.Controls[SchemaCode];
                if (store.state.listview.currentTabIndex !== null && store.state.listview.currentTabIndex !== undefined) {
                    var index = store.state.listview.currentTabIndex
                    delete this.Controls[SchemaCode + "_" + index];
                }
            } else {
                this.Controls = {}
            }
            this.ControlCount = 0;
        },

        // 保存事件，获取所有控件的保存后返回的值
        SaveSheetData: function (SchemaCode) {
            if (!SchemaCode) {
                SchemaCode = this.SchemaCode
            }
            var SheetData = {};
            var index = store.state.listview.currentTabIndex
            if (index !== null && index !== undefined) {
                var data = this.Controls[SchemaCode + "_" + index]
            }
            else {
                var data = this.Controls[SchemaCode]
            }

            for (var control in data) {
                var controlManager = data[control];
                //过滤掉过滤条件中的控件
                var controlKey = $(controlManager.Element).attr("data-controlkey");
                if (controlKey == undefined || controlKey == "FormList") {
                    continue;
                }
                // debugger
                //关联属性控件有sourceType属性,其数据不保存到数据库
                var sourceType = $(controlManager.Element).attr("data-sourcetype");
                if (sourceType != undefined) {
                    continue;
                }
                // if(controlManager.Type==57){
                //     var leng=controlManager.SaveDataField()[controlManager.DataField]
                //     if(leng&&leng.length>2000){
                //         Message.error("富文本编辑器内容过长")
                //         throw "超出长度";
                //     }
                // }
                //字表中的control不调用SaveDataField，由子表自己调用SaveDataField保存值
                if (!$.isFunction(controlManager.SaveDataField) || controlManager.DataField == void 0 || (controlManager.DataField + "").indexOf(".") != -1 || controlManager.DataField == "Comments") continue;
                $.extend(SheetData, controlManager.SaveDataField());
            }
            return SheetData;
        },
        // 获取表单已有数据
        GetSheetData: function (param) {
            param = param || this.SchemaCode;
            var SheetData = {};
            var index = store.state.listview.currentTabIndex;
            if (index !== null && index !== undefined) {
                var data = this.Controls[param + "_" + index]
            }
            else {
                var data = this.Controls[param]
            }
            for (var control in data) {
                var controlManager = data[control];
                //过滤掉过滤条件中的控件
                var controlKey = $(controlManager.Element).attr("data-controlkey");
                if (controlKey == undefined || controlKey == "FormList") {
                    continue;
                }
                //关联属性控件有sourceType属性,其数据不保存到数据库
                var sourceType = $(controlManager.Element).attr("data-sourcetype");
                if (sourceType != undefined) {
                    continue;
                }
                //字表中的control不调用SaveDataField，由子表自己调用SaveDataField保存值
                if (!$.isFunction(controlManager.GetValue) || controlManager.DataField == void 0 || (controlManager.DataField + "").indexOf(".") != -1 || controlManager.DataField == "Comments") continue;

                var getValue = controlManager.GetValue();
                // 为了解决部门多选问题,只需要取键值
                if (['FormMultiUser', 'FormUser', 'FormApapt', 'FormMultiApapt'].indexOf(controlKey) !== -1
                    && typeof getValue === 'object') {
                    getValue = Object.keys(getValue);
                } else if (typeof getValue === 'string') {
                    getValue = getValue.trim();
                } else if (['FormAttachment', 'FormPhoto'].indexOf(controlKey) !== -1) { //  附件修复bug
                    getValue = controlManager.getEditValue();
                    // getValue = controlManager.Value;
                }
                if (controlManager.Visible == true) {
                    SheetData[controlManager.DataField] = getValue;
                }

            }
            return SheetData;
        },

        // 获取控件Dom元素(JQuery对象)，参数可以是数据项名称，也可以是#id
        GetElement: function (datafiled, bizObjectId) {
            var element, $sheet;
            if ($.SmartForm.ResponseContext.IsMobile) {
                $sheet = $.SmartForm.ResponseContext.SheetView;
            }
            else {
                $sheet = $("#SheetContent");
            }
            if (!datafiled) {
                return $('');
            }
            if (datafiled.indexOf("#") == 0) {
                element = $(datafiled);
            }
            else {
                if (datafiled.indexOf('.') > -1) {
                    //如果是子表，创建的时候，得先处理子表的渲染
                    this.GetElement(datafiled.split('.')[0]).JControl();
                }
                if ($.isEmptyObject(bizObjectId)) {
                    element = $sheet.find("[" + this.PreDataKey + this.DataFieldKey.toLowerCase() + "='" + datafiled + "']:not(.table_th)");
                }
                else {
                    element = $sheet.find("[data-ObjectId='" + bizObjectId + "']").find("[" + this.PreDataKey + this.DataFieldKey.toLowerCase() + "='" + datafiled + "']:not(.table_th)");
                }
            }
            return element;
        },

        // 读取数据，参数可以是数据项名称，也可以是#id
        GetControlValue: function (datafiled) {
            var control = this.GetElement(datafiled);
            var vals = new Array();
            for (var i = 0; i < control.length; i++) {
                var manager = $(control[i]).JControl();
                if (manager) {
                    vals.push(manager.GetValue());
                }
            }
            return vals.length == 0 ? null : (vals.length == 1 ? vals[0] : vals);
        },

        // 设置数据项前端控件的值
        // 参数1：数据项名称，参数2：数据项的值
        SetControlValue: function (datafiled, val, BizObjectId) {
            var control = this.GetElement(datafiled, BizObjectId);
            for (var i = 0; i < control.length; i++) {
                var manager = $(control[i]).JControl();
                if (manager) {
                    manager.SetValue(val);
                }
            }

        },

        // 函数：控件校验
        Validate: function (ActionControl) {
            var flag = 1;
            var index = store.state.listview.currentTabIndex
            if (index !== null && index !== undefined) {
                var data = this.Controls[this.SchemaCode + "_" + index]
            }
            else {
                var data = this.Controls[this.SchemaCode]
            }
            for (var control in data) {
                var controlManager = data[control];

                if (ActionControl != null && (ActionControl.Action == $.SmartForm.Action_Save) && !(controlManager instanceof $.Controls.FormAttachment)) {
                    //保存或修改的时候，需要校验附件是上传完整
                    continue;
                }

                if (!$.isFunction(controlManager.Validate)) continue;
                if (controlManager.DataField == void 0) continue;
                //控件不可见不校验
                if (!$(controlManager.Element).is(":visible") || $(controlManager.Element).css('visibility') == 'hidden') continue;
                if (!controlManager.Validate(ActionControl.Action) && flag==1) {

                    if(controlManager.invalidText=="必填"){
                        flag = -1;
                    }
                    else{
                        flag = -2;
                    }
                   
                    if (ActionControl.doingWork != undefined) {
                        ActionControl.doingWork = false;
                    }
                

                    // 自动定位到验证失败的控件
                    if (controlManager.IsMobile) {
                        var $elment = $(controlManager.Element);
                        //edit by xc
                        //// 滚动高度为，当前元素相对页面顶部的top+元素自身height - 手机页口可视高度 - 底部操作按钮高度
                        //var $par = $elment.closest(".ionic-scroll.sheetcontent").children(".scroll");
                        //var bottomToolBarHeight = 50;
                        ////获取$par的translateY值
                        //var ty = $par.length > 0 ? -parseInt(getTranslateY($par[0])) : 0;
                        //var top = $elment.offset().top - $(window).height() + bottomToolBarHeight + $elment.height() + ty;
                        var top = $elment.position().top;
                        //end
                        H3Config.GlobalScrollDelegate.scrollTo(null, top, true);

                        //$.IShowError("提示", "抱歉，[" + controlManager.DisplayName.replace(/(^\s*)|(\s*$)/g, "") + "]选项" + controlManager.invalidText);
                        Message.error({
                            content: ("抱歉，[" + controlManager.DisplayName.replace(/(^\s*)|(\s*$)/g, "") + "]选项" + controlManager.invalidText),
                            duration: 3
                        });
                        $elment.find("input").focus();
                    }
                }
            }
            if (flag=== -1) {
                $("#SheetContent").trigger("ValidateFail");//必填验证失败的提示框可能会撑高子表行高
            }
            return flag;
        }
    };

    //var getTranslateY = function (node) {
    //    var regRule = /translate(Y|\dd)?\(\s*(\w+\s*,)?\s*([^,]+)(\s*,[^)]+)?\s*\)/;
    //    var regRule2 = /matrix\(.*,\s*(\w+)\s*\)/;
    //    var transform = node.style.transform;
    //    var reg;
    //    if (!transform) {
    //        return null;
    //    }
    //    reg = regRule.exec(transform);
    //    if (null === reg) {
    //        reg = regRule2.exec(transform);
    //        return reg ? reg[1] : null;
    //    }
    //    return reg[3];
    //}


})(jQuery);;
(function ($) {
    $.fn.FormButton = function () {
        return $.ControlManager.Run.call(this, "FormButton", arguments);
    };

    // 构造函数
    $.Controls.FormButton = function (element, options, sheetInfo) {
        $.Controls.FormButton.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormButton.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            this.Action = this.DataField;

            //渲染Html页面
            this.HtmlRender();

            //绑定事件
            this.BindEvent();
        },
        //渲染html内容
        HtmlRender: function () {
            this.$Input = $("<button class='btn btn-config' name='" + this.DataField + "' class='form-control'>" + this.DisplayName + "</button>");
            this.$InputBody.append(this.$Input);
        },
        //绑定事件
        BindEvent: function () {
            $(this.$Input).off("click.FormButton").on("click.FormButton", this, function (e) {
                var that = e.data;
                $.SmartForm.OnAction(that);
                return false;
            });
        },

        //$.Buttons.BaseButton 有该方法，方便saas开发者统一操作
        DoAction: function () {
            $.SmartForm.OnAction(this);
        }
    });
})(jQuery);;
//文本框(FormTextBox)
(function ($) {
    $.fn.FormTextBox = function () {
        return $.ControlManager.Run.call(this, "FormTextBox", arguments);
    };

    // 构造函数
    $.Controls.FormTextBox = function (element, options, sheetInfo) {
        $.Controls.FormTextBox.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormTextBox.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            debugger
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            //是否在子表里面
            //this.IsInGridView = !$.isEmptyObject(this.ObjectId);
            //渲染Html页面
            this.HtmlRender();
            //渲染校验模式
            //this.ModeRender();
            //绑定事件
            this.BindEvent();

            //Error:新建的话，可以制作默认值 ，非新建设置值加载的值
            if (this.Value) {
                this.SetDefaultValue(this.Value);
            }

            //设置placeholder
            if (this.PlaceHolder) {
                this.SetPlaceHolder(this.PlaceHolder);
            }
            // 不可编辑
            if (!this.Editable) {
                this.SetReadonly(true);
                return;
            }
        },

        //渲染html内容
        HtmlRender: function () {
            if (!this.Editable) {//overflow:auto;
                this.$Input = $('<pre style="border:none;white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;word-break:break-all">');
            }
            else {
                this.$Input = $("<input type='text' name='" + this.DataField + "' class='form-control'  autocomplete='off' style='height:32px;'>");
                if (this.IsMultiple) {
                    this.$Input = $("<textarea name='" + this.DataField + "' class='form-control' maxlength='300'>");
                }

                if (this.Mode == "Normal") {
                    if (!$.isEmptyObject(this.ObjectId)) { //border: 1px solid #ddd;overflow-y: scroll;
                        this.$Input = $("<textarea name='" + this.DataField +
                            "' class='form-control' maxlength='300' style='display:block;overflow-y: hidden;resize: none'>");
                        this.$Input.attr('rows', 1).css({ 'resize': 'none', 'height': '32px' });
                    }
                }
            }
            this.$InputBody.append(this.$Input);
        },

        //渲染模式：邮件、电话、身份证
        ModeRender: function () {
            switch (this.Mode) {
                case "Email":
                    this.Expression = /^\w+([-+.]\w+)*@\w+([-+.]\w+)*\.\w+([-.]\w+)*$/;
                    this.ErrorAlert = "错误的邮箱格式!";
                    break;
                case "Mobile":
                    this.Expression = "^(\\+\\d{2}-)?(\\d{2,3}-)?([1][3,4,5,6,7,8][0-9]\\d{8})$";
                    this.ErrorAlert = "错误的手机格式!";
                    break;
                case "Telephone":
                    this.Expression = "^(((\\+\\d{2}-)?0\\d{2,3}-\\d{7,8})|((\\+\\d{2}-)?(\\d{2,3}-)?([1][3,4,5,7,8][0-9]\\d{8})))$";
                    this.ErrorAlert = "错误的电话/手机格式!";
                    break;
                case "Card":
                    this.Expression = /^\d{15}(\d{2}[A-Za-z0-9])?$/
                    this.ErrorAlert = "错误的身份证格式!";
                    break;
            }

        },

        //绑定事件
        BindEvent: function () {
            $(this.$Input).off("blur.FormTextBox").on("blur.FormTextBox", this, function (e) {
                var $this = $(this);
                var that = e.data;
                that.ValChange();
                if ($.isEmptyObject(that.ObjectId)) {
                    that.Required && ($this.val() != "" && $this.removeAttr("style"));
                }
            });
            if (!$.isEmptyObject(this.ObjectId)) {
                //设置文本控件高度自动适应
                $(this.$Input).on('keydown', function (e) {
                    if (e.keyCode == 13) return false;
                    this.style.height = (this.scrollHeight + 2) + 'px';
                });
                $(this.$Input).on('focus', function () {
                    if ($(this).val() != "") {
                        this.style.height = (this.scrollHeight + 2) + 'px';
                    }
                });
            }
        },

        //值改变
        ValChange: function () {
            this.OnChange();
            this.Validate();
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.Visible)
                    this.$Input.html(this.Value);
            }
            else {
                this.$Input.val(v);
            }
            this.ValChange();
        },

        SetDefaultValue:function(v){
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.Visible)
                    this.$Input.html(this.Value);
            }
            else {
                this.$Input.val(v);
            }
            this.OnChange();
        },
        //设置placeholder Add:20160408
        SetPlaceHolder: function (ph) {
            if (this.Editable && this.ResponseContext.IsCreateMode) {
                this.PlaceHolder = ph.toString();//.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                this.$Input.attr("placeholder", this.PlaceHolder);
            }
        },

        GetValue: function () {
            if (!this.Editable) {
                var v = this.Value;
                return v == null ? "" : v;
            }
            else {
                if (this.$Input != void 0) {
                    return this.$Input.val().trim();
                } else {
                    return this.Value || '';
                }
            }
        },

        GetText: function () {
            return this.GetValue();
        },

        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("readonly", "readonly");
            }
            else {
                this.$Input.removeProp("readonly");
            }
        },
        strlen(str){
            var len = 0;
            for (var i=0; i<str.length; i++) { 
             var c = str.charCodeAt(i); 
            //单字节加1 
             if ((c >= 0x0001 && c <= 0x007e) || (0xff60<=c && c<=0xff9f)) { 
               len++; 
             } 
             else { 
              len+=1; 
             } 
            } 
            return len;
        
        },

        // 数据验证
        Validate: function () {
            //不可编辑，不可编辑状态为什么还要校验？
            //if (!this.Editable) return true;
            var val = this.GetValue();

            if (this.Required && val != null && val.trim() == "") {

                this.AddInvalidText(this.$Input, "必填");
                return false;
            }
            if (!$.isEmptyObject(val)) {
                if (!this.IsMultiple) {
                    //200字符长度
                    if (this.strlen(val.trim()) > 240) {


                        this.AddInvalidText(this.$Input, '字符长度超出限制240个字');
                        return false;
                    }
                } else {
                    if (this.strlen(val.trim()) > 1000) {
                        this.AddInvalidText(this.$Input, '字符长度超出限制1000个字');
                        return false;
                    }
                }
            }
            //if (!$.isEmptyObject(val) && this.Expression && !this.Expression.test(val)) {
            //    this.AddInvalidText(this.$Input, this.ErrorAlert);
            //    return false;
            //}
            //格式验证
            if (!$.isEmptyObject(val) && this.Mode) {
                var exp1 = '';
                var exp2 = '';
                var err = '';
                switch (this.Mode) {
                    case "Email":
                        exp1 = /^\w+([-+.]\w+)*@\w+([-+.]\w+)*\.\w+([-.]\w+)*$/;
                        err = "错误的邮箱格式!";
                        break;
                    case "Mobile":
                    case "Telephone":
                        exp1 = /^((\+?86)|(\(\+86\)))?\d{3,4}-\d{7,8}(-\d{3,4})?$/;
                        exp2 = /^((\+?86)|(\(\+86\)))?(13[012356789][0-9]{8}|15[012356789][0-9]{8}|18[02356789][0-9]{8}|147[0-9]{8}|1349[0-9]{7})$/;
                        //exp2 = /^[0-9-()（）]{7,18}$/;
                        //exp1 = /([^\d\+-\s])/ig; //电话号码只能有数字 空格 + -不能出现其他字符
                        err = "错误的电话或手机号码格式!";
                        break;
                    case "Card":
                        exp1 = /^\d{15}(\d{2}[Xx0-9])?$/
                        err = "错误的身份证格式!";
                        break;
                    default:
                }
                var isValid1 = true;
                var isValid2 = true;
                if (exp1) {
                    if(val!==""&&val!==void 0)
                    isValid1 = exp1.test(val);
                }
                if (exp2) {
                    if(val!==""&&val!==void 0)
                    isValid2 = exp2.test(val);
                }
                if (this.Mode == "Mobile" || this.Mode == "Telephone") {
                    if (!isValid1 && !isValid2) {         
                       this.AddInvalidText(this.$Input, err);
                       return false;
                    }
                } else {
                    if (!isValid1) {
                        //if (this.invalidText != err)
                        this.AddInvalidText(this.$Input, err);
                        return false;
                    }
                }
            }

            this.RemoveInvalidText(this.$Input);
            return true;
        },

        //返回数据值
        SaveDataField: function () {
            var result = {
            };
            var oldResult = {
            };
            if (this.ComputationRule == null && !this.Visible) return result;
            oldResult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldResult) {
                return {};
            }

            if (("" + oldResult.Value) != this.GetValue()) {
                result[this.DataField] = this.GetValue().trim();

            }
            else {
                result[this.DataField] = oldResult.Value;
            }
            return result;

        },

        //文本框点击事件
        BindClickEvent: function (clickfun) {
            var that = this;
            //if (this.ClickEvent) return;
            //显示图标并标识
            this.HasBindClick = true;

            if (clickfun == null) return;
            //if ($.isEmptyObject(clickfun)) return;

            this.ClickEvent = clickfun;

            //RenderClickMode样式
            $(this.$InputBody).css("position", "relative");
            var $span1 = $(this.Element).find("span.icon-nav_search");
            var $span = $("<span class='icon-nav_search textclickspan' style='float:right;position: absolute;right: 0;top: 8px;margin-right: 20px'></span>")
            $(this.$Input).before($span);
            $span.off("click." + this.DataField).on("click." + this.DataField, function () {
                if (clickfun && clickfun.constructor.name == "Function") {
                    clickfun.apply(that, [that, that.ObjectId]);
                }
            })
        },
        UnBindClickEvent: function () {

        }
    });
})(jQuery);;
//多行文本框(FormTextArea)
(function ($) {
    $.fn.FormTextArea = function () {
        return $.ControlManager.Run.call(this, "FormTextArea", arguments);
    };

    // 构造函数
    $.Controls.FormTextArea = function (element, options, sheetInfo) {
        $.Controls.FormTextArea.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormTextArea.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }

            //渲染Html页面
            this.HtmlRender();
            //绑定事件
            this.BindEvent();

            //Error:新建的话，可以制作默认值 ，非新建设置值加载的值
            if (this.Value) {
                this.SetDefaultValue(this.Value);
            }

            //设置placeholder
            if (this.PlaceHolder) {
                this.SetPlaceHolder(this.PlaceHolder);
            }


            // 不可编辑
            if (!this.Editable) {
                this.SetReadonly(true);
                return;
            }

        },

        //渲染html内容
        HtmlRender: function () {
            if (!this.Editable) {//overflow:auto;
                this.$Input = $('<pre style="border:none;white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;word-break:break-all">');
            } else {
                // border: 1px solid #ddd; overflow-y: scroll;
                this.$Input = $("<textarea name='" + this.DataField + "' rows='" + this.Rows + "' class='form-control' maxlength='2000' style='display:block; resize: none'>");
                //如果是在子表中，则将rows设置成1，并允许纵向拉伸
                if (!$.isEmptyObject(this.ObjectId)) {
                    this.$Input.attr('rows', this.Rows).css({ 'resize': 'none', 'overflow-y': 'hidden' });//'resize': 'vertical' 'height': '32px'
                } else {
                    this.$Input.css({ "border": "1px solid #ddd;" })
                }
            }
            this.$InputBody.append(this.$Input);
        },

        //绑定事件
        BindEvent: function () {
            $(this.$Input).off("blur.FormTextArea").on("blur.FormTextArea", this, function (e) {
                var $this = $(this);
                var that = e.data;
                that.ValChange();
                that.Required && ($this.val() != "" && $this.removeAttr("style"));
            });
            //设置文本控件高度自动适应
            $(this.$Input).on('input', function () {
                this.style.height = (this.scrollHeight + 2) + 'px';
            });
            $(this.$Input).on('focus', function () {
                if ($(this).val() != "") {
                    this.style.height = (this.scrollHeight + 2) + 'px';
                }
            });
            // fix: 多行输入框 focus和blur的时候宽高度会变动
            // if ($.isEmptyObject(this.ObjectId)) {
            //     $(this.$Input).on('blur', function () {
            //         this.style.height = '32px';
            //     });
            // }
        },

        //值改变
        ValChange: function () {
            this.OnChange();
            this.Validate();
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br\/&gt;/g, "<br/>");
                if (this.Visible) {
                    this.$Input.html(this.Value);
                    var newValue = this.$Input.html().replace(/\\n/g, '<br/>');
                    this.$Input.html(newValue);
                }
            }
            else {
                //换行
                var newVal = v;
                if (typeof newVal == "string") {
                    newVal = v.replace(/\\n/g, "\r\n");
                }
                this.$Input.val(newVal);
            }
            this.ValChange();
        },



        SetDefaultValue:function(v){
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&lt;br\/&gt;/g, "<br/>");
                if (this.Visible) {
                    this.$Input.html(this.Value);
                    var newValue = this.$Input.html().replace(/\\n/g, '<br/>');
                    this.$Input.html(newValue);
                }
            }
            else {
                //换行
                var newVal = v;
                if (typeof newVal == "string") {
                    newVal = v.replace(/\\n/g, "\r\n");
                }
                this.$Input.val(newVal);
            }
            this.OnChange();
        },

        //设置placeholder Add:20160408
        SetPlaceHolder: function (ph) {
            if (this.Editable && this.ResponseContext.IsCreateMode) {
                this.PlaceHolder = ph.toString();//.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                this.$Input.attr("placeholder", this.PlaceHolder);
            }
        },

        GetValue: function () {
            if (!this.Editable) {
                var v = this.Value;
                return v == null ? "" : v;
            }
            else {
                if (this.$Input != void 0)
                    return this.$Input.val().trim();
                else {
                    return this.Value || "";
                }
            }
        },

        GetText: function () {
            return this.GetValue();
        },

        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("readonly", "readonly");
            }
            else {
                this.$Input.removeProp("readonly");
            }
        },

        strlen(str){
            var len = 0;
            for (var i=0; i<str.length; i++) { 
             var c = str.charCodeAt(i); 
            //单字节加1 
             if ((c >= 0x0001 && c <= 0x007e) || (0xff60<=c && c<=0xff9f)) { 
               len++; 
             } 
             else { 
              len+=1; 
             } 
            } 
            return len;
        
        },

        // 数据验证
        Validate: function () {
            //不可编辑
            //if (!this.Editable) return true;

            var val = this.GetValue();

            if (this.Required && val != null && val.trim() == "") {

                this.AddInvalidText(this.$Input, "必填");
                return false;
            }
            if (!$.isEmptyObject(val)) {

                if (this.strlen(val.trim())> 1000) {
                    this.AddInvalidText(this.$Input, '字符长度超出限制1000个字节');
                    return false;
                }
            }
            if (!$.isEmptyObject(val) && this.Expression && !this.Expression.test(val)) {
                this.AddInvalidText(this.$Input, this.ErrorAlert);
                return false;
            }

            this.RemoveInvalidText(this.$Input);
            return true;
        },

        //返回数据值
        SaveDataField: function () {
            var result = {};
            //if (!this.Visible) return result;
            if (this.ComputationRule == null && !this.Visible) {
                return result;
            }
            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldresult) {
                return {};
            }

            if (("" + oldresult.Value) != this.GetValue()) {
                result[this.DataField] = this.GetValue().trim();
                return result;
            }

            return {};
        }
    });
})(jQuery);;
//选人控件
(function ($) {
    // 控件执行
    // 参数{AutoTrim:true,DefaultValue:datavalue,OnChange:""}
    //可以通过  $("#id").SheetTextBox(参数)  来渲染控件和获取控件对象
    $.fn.FormUser = function (opt) {
        return $.ControlManager.Run.call(this, "FormUser", arguments);
    };

    //选人控件数据,单个页面所有数据库共用
    //原来没有对选人控件设定选择范围，所有控件加载出来unit相同，控件共用一个缓存，增加选择范围后控件各自缓存
    //20161130注释FormUserData，用this.UserData替代
    //$.FormUserData = {
    //    //部门
    //    OrgUnitItems: {},
    //    //标签
    //    //OrgTagItems: [],
    //    //部门用户:{部门ID:[]}
    //    DepUserItems: {},
    //    //用户
    //    UserItems: {},
    //};

    // 构造函数
    $.Controls.FormUser = function (element, ptions, sheetInfo) {
        //原来是$.FormUserData,修改为每个控件各自缓存
        this.UserData = {
            //部门
            OrgUnitItems: {},
            //标签
            //OrgTagItems: [],
            //部门用户:{部门ID:[]}
            DepUserItems: {},
            //用户
            UserItems: {},
        };
        //选择数据集合
        this.Units = {};
        //所有选择的元素
        this.UnitsElement = null;
        //搜索输入框元素
        this.SearchElement = null;
        this.SearchTxtElement = null;

        //组织机构容器
        this.SelectorPanel = null;
        this.OrgTreePanel = null;
        this.OrgListPanel = null;
        this.IsOverSelectorPanel = false;
        this.FormUserHandler = '/ctg-workflow/user/querylist'; //SheetUserAction
        this.Options = ptions;
        this.CpLock = false;
        this.SearchOrg = debounce(this.SearchOrg, 500, this);
        $.Controls.FormUser.Base.constructor.call(this, element, ptions, sheetInfo);
        this.FromNum = 0;
        this.ToNum = 10;
        // this.IsQueryControl = false;//true为查询条件使用，false：作为表单控件使用
    };

    // 继承及控件实现
    $.Controls.FormUser.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            this.CurrentDocument = $(this.Element).closest("html").length == 1 ? $(this.Element).closest("html").parent() : $(document);
            this.CurrentBody = $(this.Element).closest("body").length == 1 ? $(this.Element).closest("body") : $("body");
            //是否在子表里面子表
            this.IsInGridView = !$.isEmptyObject(this.ObjectId);
            // 2018-11-19 add by zyy 是否为所属部门控件
            this.isOwerDep = this.DataField === 'OwnerDeptId';
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            // 拥有者不能选部门
            if (this.DataField == "OwnerId") {
                this.OrgUnitVisible = false;
                $(this.Element).attr("data-OrgUnitVisible", false);
            }
            //拥有者，所属部门必填写
            if (this.DataField == "OwnerId" || this.DataField == "OwnerDeptId") {
                this.Required = true;
            }
            //渲染界面
            this.HtmlRender();

            //初始化默认值
            this.InitValue();

            //绑定事件
            this.BindEvents();
        },

        //初始化值
        InitValue: function () {
            if (this.Value) {
                this.SetValue(this.Value);
                if ($.SmartForm.ResponseContext.IsCreateMode) {
                    var val = this.Value.constructor == Array ? this.Value[0] : this.Value;
                    this.MappingControlsHandler(val);
                }
            }
        },
        //判断默认只是否在给定选人范围内
        CheckUnitValidate: function (Obj) {
            //2017/6/12修改，原因是关联携带了大量数据过来校验导致超时
            return Obj;

            var that = this;
            var newObj = [];
            if ($.isEmptyObject(that.UserData.OrgUnitItems)) {
                //if ($.SmartForm.ResponseContext && !$.SmartForm.ResponseContext.IsCreateMode) {
                //如果不是创建模式则不执行check，因为非创建模式的数据已经check过
                //if (Obj.constructor == String || Obj.constructor == Object) {
                //    newObj.push(Obj);
                //}
                //else if (Obj.constructor == Array) {
                //    newObj = Obj;
                //}
                //return newObj;
                //}
                var UnitIds = [];
                if (Obj.constructor == Object) {
                    UnitIds.push(Obj.UnitID || Obj.UnitId);
                } else if (Obj.constructor == Array) {
                    for (var i = 0; i < Obj.length; i++) {
                        if (Obj[i].constructor == Object) {
                            UnitIds.push(Obj[i].UnitID || Obj[i].UnitId);
                        }
                        else if (Obj[i].constructor == String) {
                            UnitIds.push(Obj[i]);
                        }
                    }
                } else if (Obj.constructor == String) {
                    UnitIds.push(Obj);
                }
                //请求后台，判断Obj是否在给定范围内，如果在给定范围内则返回Unit对象，后续调用AddChoice
                var unitTemp = '';
                for (var i = 0; i < UnitIds.length; i++) {
                    unitTemp += UnitIds[i] + ';';
                }

                var params = {
                    ActionName: "SheetUserAction",
                    Command: "CheckUnitValidate",
                    UnitSelectionRange: that.UnitSelectionRange,
                    UnitIds: unitTemp
                }
                this.Ajax(
                    that.FormUserHandler,
                    "POST",
                    { PostData: JSON.stringify(params) },
                    function (data) {
                        newObj = data.ReturnData.UnitItems;
                    }, false);
            }
            return newObj;
        },
        //设置值
        SetValue: function (Obj, isUser) {
            //对于设置默认值的情况，开始时候没有LoadUnitsTree
            //需要考虑到值是否在选人范围内以及是否显示离职人员
            //这里要加载所有的unit，判断值是否在给定unit内
            //加载树
            var that = this;
            if (Obj == void 0 || Obj == null || Obj == "" || Obj.length == 0) {
                this.ClearChoices();
                return;
            }

            //if (!that.SelectorPanel) {
            //    that.RenderNext();
            //    $(that.$InputBody).unbind("click.UserOnce");
            //}

            //要校验的情况
            //1.创建模式
            //2.修改模式可写且没有值
            if (this.UnitSelectionRange) {
                //有设置选人范围
                if ($.SmartForm && $.SmartForm.ResponseContext && $.SmartForm.ResponseContext.IsCreateMode) {
                    //创建模式
                    Obj = that.CheckUnitValidate(Obj);
                } else {
                    //修改模式
                    if (this.Editable && (Obj == void 0 || Obj == null || Obj == "" || Obj.length == 0)) {
                        //可编辑
                        Obj = that.CheckUnitValidate(Obj);
                    }
                }
            }

            //if (this.UnitSelectionRange && this.Editable)
            //    Obj = that.CheckUnitValidate(Obj);

            if (!Obj) { return; } //CheckUnitValidate可能返回空

            if (Obj.constructor == Object) {
                this.AddChoice(Obj);
            }
            else if (Obj.constructor == Array) {
                for (var i = 0; i < Obj.length; i++) {
                    if (Obj[i].constructor == Object) {
                        this.AddChoice(Obj[i]);
                    }
                    else if (Obj[i].constructor == String) {
                        this.AddUserID(Obj, isUser);
                        break;
                    }
                }
            }
            else if (Obj.constructor == String) {
                // var date = new Date();
                this.AddUserID(Obj, isUser);
            }
            //this.OnChange();
        },

        //返回 {UnitID1:{UnitID: , Code:, DisplayName:Type, Icon ,ParentId},UnitID1:{UnitID: , Code:, DisplayName: }}对象
        GetValue: function () {
            return $.IClone(this.Units);
        },

        GetUnitIDs: function () {
            return this.GetUnitIds();
        },

        //读取选中的UnitID
        GetUnitIds: function () {
            var ValObjs = this.GetValue();
            var UintIDs = new Array();
            for (var key in ValObjs) {
                UintIDs.push(key);
            }
            return UintIDs;
        },

        //获取显示
        GetText: function () {
            var userNames;
            for (var ObjectId in this.Units) {
                if (this.IsMultiple) {
                    if (userNames == void 0) userNames = new Array();
                    userNames.push(this.Units[ObjectId].DisplayName);
                }
                else {
                    userNames = this.Units[ObjectId].DisplayName;
                }
            }
            return userNames == void 0 ? "" : userNames.toString();
        },

        //保存数据
        SaveDataField: function () {
            var result = {
            };
            if (!this.Visible) return result;
            var oldresult = this.DataItem;
            if (!oldresult) {
                return {
                };
            }

            var UnitIDs = this.GetUnitIDs();
            if (oldresult.Value != UnitIDs) {
                result[this.DataField] = UnitIDs;
                return result;
            }
            result[this.DataField] = [];
            return result;
        },

        //根据ChoiceID，获取已经选择的组织
        GetSelectUnitByChoiceID: function (choiceID) {
            if (this.Units == null || this.Units.length == 0) return null;
            for (var key in this.Units) {
                if (this.Units[key].ChoiceID == choiceID) {
                    return this.Units[key];
                }
            }
            return null;
        },

        //渲染样式
        HtmlRender: function () {
            var $Element = $(this.Element);
            $Element.addClass("SheetUser");
            if (!this.IsInGridView) {
                //不在子表里面
                $Element.css("position", "relative")
            }
            if (!this.Editable) {
                this.$Input = $("<pre>").css("border", "none");
                this.$InputBody.append(this.$Input);
                return;
            }
            //设置当前控件的ID
            this.ID = $.IGuid();

            //this.$InputBody.attr("ID", this.ID);

            //this.UnitsElement = $("<div>").attr("data-targetid", this.ID).attr("name", this.DataField).addClass("form-control form-query-add").css("overflow", "auto").css("width", "100%").css("min-height", "30px").css("max-height", "100px");//.width(this.Width);
            this.UnitsElement = $('<div data-targetid="' + this.ID + '" name="' + this.DataField + '" class="form-control form-user-add icon-arrow-down-full" style="overflow:auto; width:100%; min-height:32px; max-height：100px;"></div>')
            //this.$Input = $("<input>").addClass("SheetUser-Input");
            this.$Input = $("<input class='SheetUser-Input' style='width:1px;display:none'>");
            var that = this;
            this.$Input.on("compositionstart", function () {
                that.CpLock = true;
            });
            this.$Input.on("compositionend", function () {
                that.CpLock = false;
            });
            //this.UnitsElement.append(this.$Input);
            this.$InputBody.attr("ID", this.ID).css({ "min-width": "100px" }).append(this.UnitsElement.append(this.$Input));

            //作为筛选条件时显示样式
            //if (this.IsQueryControl) {
            //this.UnitsElement.removeClass("icon-arrow-down-full");
            //this.UnitsElement.removeClass("icon-arrow-down-full").css("border", "1px dashed #cccccc");
            //this.$tipDiv = $("<div style='width:98%;height:30px;float:right;text-align:center;'><div><span class='sp_placeholder'>点击选择" + this.DisplayName.replace(/^\s+|\s+$/g, '') + "</span></div></div>")
            //this.UnitsElement.append(this.$tipDiv);
            //}

            var placeHolder = "点击选择";

            if (this.IsQueryControl) {
                placeHolder += this.DisplayName.replace(/^\s+|\s+$/g, '');
            } else {
                if (this.OrgUnitVisible && this.UserVisible) {
                    placeHolder += "人员/部门";
                } else if (this.OrgUnitVisible && !this.UserVisible) {
                    placeHolder += "部门";
                } else if (!this.OrgUnitVisible && this.UserVisible) {
                    placeHolder += "人员";
                }
            }
            this.UnitsElement.removeClass("icon-arrow-down-full");
            this.UnitsElement.removeClass("icon-arrow-down-full").css("border", "1px dashed #cccccc");
            this.$tipDiv = $("<div style='width:98%;height:30px;float:right;text-align:center;'><div><span class='sp_placeholder'>" + placeHolder + "</span></div></div>")
            this.UnitsElement.append(this.$tipDiv);
        },

        RenderNext: function () {
            var that = this;
            that.$SearchDiv = $("<div data-targetid='" + that.ID + "' data-formmultiuserpanel='searchdiv' class='searchdiv' ><input class='searchinput' type='text'></input></div>")
            that.$SearchInput = that.$SearchDiv.find("input"); //搜索输入框
            that.Placeholder = "输入" + that.DisplayName + "查找";
            that.$SearchInput.attr("placeholder", that.Placeholder);

            that.$SearchInput.on("compositionstart", function () {
                that.CpLock = true;
            });
            that.$SearchInput.on("compositionend", function () {
                that.CpLock = false;
            });

            //搜索面板
            //that.$SearchPanel = $("<div>").attr("data-targetid", that.ID).addClass("SheetUser-SelectorPanel").attr("data-FormUserPanel", "SearchPanel");
            that.$SearchPanel = $("<div data-targetid='" + that.ID + "' class='SheetUser-SelectorPanel' data-FormUserPanel='SearchPanel' style='overflow-y: auto;'>");
            $(that.$SearchPanel).on('scroll', 'ul', function () { });

            //组织机构选择面板
            //that.SelectorPanel = $("<div>").attr("data-targetid", that.ID).addClass("SheetUser-SelectorPanel").attr("data-FormUserPanel", "SelectorPanel");//.width(this.Width);
            that.SelectorPanel = $("<div data-targetid='" + that.ID + "' class='SheetUser-SelectorPanel' data-FormUserPanel='SelectorPanel'>");
            //that.SelectorPanel.append(that.$SearchDiv);
            //组织标签
            //that.SelectorTabs = $("<ul>").addClass("nav").addClass("nav-tabs user-tabs");
            that.SelectorTabs = $("<ul class='nav nav-tabs user-tabs'>");
            if (that.UnitSelectionRange) {
                that.SelectorTabs.append($("<li data-tabtype='tab_RoleUsers' style='cursor:pointer;'><a>用户</a></li>"));
                that.UserVisible = false;
                that.OrgUnitVisible = false;
            }
            // 2018-11-19 add by zyy
            if (that.isOwerDep) {
                that.SelectorTabs.append($("<li data-tabtype='tab_owerDep' style='cursor:pointer;'><a>所属部门</a></li>"));
                that.UserVisible = false;
                that.OrgUnitVisible = false;
            }
            if (that.UserVisible) {
                //that.SelectorTabs.append($("<li>").append("<a>用户</a>").attr("data-tabtype", "tab_Users").css("cursor", "pointer"));
                that.SelectorTabs.append($("<li data-tabtype='tab_Users' style='cursor:pointer;'><a>用户</a></li>"));
            }
            if (that.OrgUnitVisible) {
                //that.SelectorTabs.append($("<li>").append("<a>部门</a>").attr("data-tabtype", "tab_Deps").css("cursor", "pointer"));
                that.SelectorTabs.append($("<li data-tabtype='tab_Deps' style='cursor:pointer;'><a>部门</a></li>"));
            }
            that.SelectorPanel.append(that.SelectorTabs);

            //用户面板
            //that.UsersDataPanel = $("<div>").addClass("SheetUser_DataPanel").addClass("row").addClass("SheetUser_tab_Users");
            that.UsersDataPanel = $("<div class='SheetUser_DataPanel row SheetUser_tab_Users'>");
            //部门面板
            //that.DepsDataPanel = $("<div>").addClass("SheetUser_DataPanel").addClass("row").addClass("SheetUser_tab_Deps");
            that.DepsDataPanel = $("<div class='SheetUser_DataPanel row SheetUser_tab_Deps'>");

            that.SelectorPanel.append(that.DepsDataPanel);
            that.SelectorPanel.append(that.UsersDataPanel);

            that.$UserPanel = $("<div class='userpanel'>");
            that.$UserPanel.append(that.$SearchDiv).append(that.SelectorPanel).append(that.$SearchPanel);

            //that.$UserPanel.appendTo("body");
            that.$UserPanel.appendTo(this.CurrentBody);
            //绑定对应事件
            //页签切换
            that.SelectorTabs.find("li").unbind("click.SelectorTabs").bind("click.SelectorTabs", that, function (e) {
                if ($(this).hasClass("active")) return;
                var that = e.data;
                var $parent = $(this).parent();
                $parent.find("li").removeClass("active");
                $(this).addClass("active");

                var tabType = $(this).attr("data-tabtype");
                that.SelectorPanel.find(".SheetUser_DataPanel").hide();
                that.SelectorPanel.find(".SheetUser_" + tabType).show();
                that.LoadOrgByTabType(tabType);
                setTimeout(function () {
                    e.data.$SearchInput[0].focus();
                }, 50)
            });

            //点击到当前元素，设置input焦点
            $(that.$InputBody).children("div").unbind("click.FormUser").bind("click.FormUser", that, function (e) {
                var $target = $(e.target);
                if (!$target.closest("span").hasClass("SheetUser-Item")) {
                    e.data.FocusInput.apply(e.data);
                    //弹出对话框后手动获取搜索框焦点,不执行绑定的focusin事件
                    setTimeout(function () {
                        e.data.$SearchInput[0].focus();
                    }, 50)
                    // 停止冒泡，防止与SheetQuery冲突而添加
                    e.stopPropagation();
                }
            });

            that.$UserPanel.children("div").unbind("click.FormUser").bind("click.FormUser", that, function (e) {
                var $target = $(e.target);
                if (!$target.closest("li").hasClass("SheetUser-LiItem")) {
                    //e.data.$Input.focus();
                    //e.data.$SearchInput.focus();
                    // 停止冒泡，防止与SheetQuery冲突而添加
                    e.stopPropagation();
                }
            });

            //得到焦点显示
            $(that.$SearchInput).unbind("focusin.Input").bind("focusin.Input", that, function (e) {
                //e.data.FocusInput.apply(e.data);
                e.data.$SearchInput.removeAttr("placeholder");
            });

            $(that.$SearchInput).off("input propertychange").on("input propertychange", that, function (e) {
                //IE下才执行
                var isIE = navigator.userAgent.indexOf("MSIE") > -1 || navigator.userAgent.indexOf("Edge") > -1
                    || (navigator.userAgent.indexOf("Trident") > -1 && navigator.userAgent.indexOf("rv") > -1);
                if (isIE) {
                    var that = e.data;
                    that.TimeOut && window.clearTimeout(that.TimeOut);
                    that.TimeOut = setTimeout(function () {
                        that.SearchOrg.apply(that, [that]);
                    }, 500);
                }
            });

            //控件输入
            $(that.$SearchInput).unbind("keyup.SearchTxtElement").bind("keyup.SearchTxtElement", that, function (e) {
                e.data.SetSearchTxtElementWidth.apply(e.data);

                var that = e.data;
                that.TimeOut && window.clearTimeout(that.TimeOut);
                that.TimeOut = setTimeout(function () {
                    that.SearchOrg.apply(that, [that]);
                }, 500);
            });

            $(that.$SearchInput).unbind("keydown.SearchTxtElement").bind("keydown.SearchTxtElement", that, function (e) {
                if (e.keyCode == 8 && $(this).val() == "" && $(this).prev().length > 0) {
                    var unit = e.data.GetSelectUnitByChoiceID.apply(e.data, [$(this).prev().attr("id")]);
                    e.data.RemoveChoice.apply(e.data, [unit.UnitID]);
                }
            });

            //点击屏幕的其他地方 $(document)
            $(this.CurrentDocument).unbind("mousedown." + that.ID).bind("mousedown." + that.ID, that, function (e) {
                //edit by xc 特殊情况处理
                if ($(e.target).hasClass("row") && $(e.target).children(".col-md-6").children("div[data-controlkey='FormUser']").length > 0) {
                    return false;
                }
                else if ($(e.target).closest("div[data-targetid='" + e.data.ID + "']").length == 0) {
                    e.data.FocusOutput.apply(e.data);
                    e.stopPropagation();
                }
            });
        },

        //绑定事件
        BindEvents: function () {
            var that = this;
            //不可用
            if (!this.Editable) {
                return;
            }

            //点击选人控件再渲染
            $(this.$InputBody).one("click.UserOnce", function () {
                that.RenderNext.apply(that);
                that.FocusInput();
            });
            //获取焦点选人控件再渲染
            $(this.$InputBody).find("input").on("focus.UserOnce", function () {
                if (!that.$UserPanel) {
                    that.RenderNext.apply(that);
                }
                that.FocusInput();
                $(that.$InputBody).unbind("click.UserOnce");
            });

            //映射关系
            if (!$.isEmptyObject(this.MappingControls)) {
                this.BindChange("sys_MappingControlsHandler", function () {
                    var val = that.GetValue();
                    if (val != null) {
                        for (var key in val) {
                            that.MappingControlsHandler.apply(that, [val[key]]);
                            break;
                        }
                    }
                });
            }

        },

        //设置输入框的宽度
        SetSearchTxtElementWidth: function () {
            //var w = "1px";
            //var length = this.$Input.val().length;
            //if (length > 0) {
            //    w = length * 15 + "px";
            //    this.$Input.removeAttr("PlaceHolder", this.PlaceHolder);
            //}
            //$(this.$Input).width(w);
        },

        //获取焦点焦点
        FocusInput: function () {
            //if (this.IsInGridView) {
            //    var position = this.$InputBody.offset();
            //    this.SelectorPanel.css("top", position.top + this.$InputBody.height());
            //    this.SelectorPanel.css("left", position.left);
            //    this.SelectorPanel.width(this.UnitsElement.width());
            //}
            // edit by xiechang
            var padding = this.$InputBody.css("padding-left");
            padding = padding ? parseInt(padding) : 0;
            var position = this.$InputBody.offset();
            var WindowW = $(this.CurrentBody).outerWidth(); // $(window).outerWidth();




            if (this.IsInGridView) {
                if (WindowW - position.left < 500) {
                    this.$UserPanel.css("right", WindowW - position.left - this.$InputBody.outerWidth());
                } else {
                    this.$UserPanel.css("left", position.left);
                }
            }
            else {
                if (WindowW - position.left < 500) {
                    this.$UserPanel.css("right", this.$InputBody.css("paddingRight"));
                } else {
                    this.$UserPanel.css("left", position.left + padding);
                }
            }


            ////判断控件距离底部的可视高度
            //var bottom = $(window).height() - position.top - this.$InputBody.height() + $(window).scrollTop();
            //var userPanelHeight = $(this.$UserPanel).height();

            //if (bottom > userPanelHeight) {
            //    this.$UserPanel.css("top", position.top + this.$InputBody.height());
            //} else {
            //    this.$UserPanel.css("top", position.top - userPanelHeight);
            //}

            this.$UserPanel.css("top", position.top + this.$InputBody.height());

            //this.$SearchDiv.css("top", position.top + this.$InputBody.height());
            //this.SelectorPanel.css("top", position.top + this.$InputBody.height() + this.$SearchDiv.height());
            //this.$SearchPanel.css("top", position.top + this.$InputBody.height() + this.$SearchDiv.height());

            //绑定元素父元素的滚动事件，重新赋值$UserPanel的高度和left
            var that = this;
            $.each($(this.Element).parents(), function (index, obj) {
                $(obj).scroll(function () {
                    that.$UserPanel.css("top", that.$InputBody.height() + that.$InputBody.offset().top);
                });
            });

            if (this.SelectorPanel.is(":visible")) return;



            //其他的选人控件都隐藏(包括单人和多人 edit by xc)
            //$("div[data-FormUserPanel='SelectorPanel']").hide();
            $("div[data-FormMultiUserPanel='SelectorPanel'],div[data-FormUserPanel='SelectorPanel'],div[data-formmultiuserpanel='searchdiv']").hide();
            //下拉框隐藏
            $("ul.drop-list.drop-list_s").hide();
            //关联表单隐藏
            $(".form-query-dropdown").hide();
            if (this.SelectorTabs.find("li.active").length == 0) {
                this.SelectorTabs.find("li:first").click();
            }
            var searchkey = $(this.$SearchInput).val().trim();
            // edit by zyy
            if (!this.isOwerDep && !this.UnitSelectionRange && !searchkey) {
                this.SelectorPanel.show();
                this.$SearchPanel.hide();
                this.$SearchDiv.show();
            } else {
                //有搜索关键字时，点击搜索结果div
                this.$SearchDiv.show();
                this.$SearchPanel.show();
            }

            //弹窗中（非表单中）选人控件超出bottom处理
            if ($(this.$InputBody).parents(".sheet_container").length == 0) {
                if (this.$InputBody.parents(".modal-dialog").length == 1) {
                    var bottom = $(window).height() - position.top - this.$InputBody.height();
                    var userPanelHeight = $(this.$UserPanel).height();
                    if (bottom < userPanelHeight) {
                        this.SelectorPanel.css("height", bottom - 50);
                        this.SelectorPanel.find(".SheetUser_DataPanel").css("height", bottom - 90);
                    }
                }
            }
        },

        //失去焦点
        FocusOutput: function () {
            if (this.SelectorPanel) {
                this.SelectorPanel.hide();
                this.$SearchPanel.hide();
                this.$SearchDiv.hide();
                //this.$Input.val("");
                this.$SearchInput.val("");
                this.Required && (this.UnitsElement.text() != "" && this.UnitsElement.css({ "border": "1px solid #ddd", "box-shadow": "none" }));

                $("body").css("overflow", "auto");
            }
        },

        //添加:UserID/UserCode
        AddUserID: function (UserID, isUser) {
            var that = this;
            //需要后台取数的id
            var ids = [];
            var cacheItems = [];
            if (UserID.constructor == Array) {
                for (var i = 0; i < UserID.length; i++) {
                    var id = UserID[i];
                    if (!that.UserData.UserItems[id]) {
                        ids.push(id);
                    }
                    else {
                        cacheItems.push(that.UserData.UserItems[id]);
                    }
                }
            }
            else {
                if (!that.UserData.UserItems[UserID]) {
                    ids.push(UserID);
                }
            }

            if (ids.length > 0) {
                var param = {
                    ActionName: "SheetUserAction", Command: "GetUserProperty", UnitID: ids
                };
                //添加已经存在缓存中的对象
                if (cacheItems && cacheItems.length > 0) {
                    for (var item in cacheItems) {
                        that.AddChoice.apply(that, item);
                    }
                }
                if (isUser) {
                    HTTP.getUserProperty(param).then((data) => {
                        if (data && data.ReturnData.UnitItems) {
                            that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                            that.AddChoice.apply(that, data.ReturnData.UnitItems);
                        }
                    })
                }
                else {
                    HTTP.getOrganProperty(param).then((data) => {
                        if (data && data.ReturnData.UnitItems && data.ReturnData.UnitItems.length > 0) {
                            that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                            that.AddChoice.apply(that, data.ReturnData.UnitItems);
                        }
                        else {
                            HTTP.getUserProperty(param).then((data) => {
                                if (data && data.ReturnData.UnitItems) {
                                    that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                                    that.AddChoice.apply(that, data.ReturnData.UnitItems);
                                }
                            })
                        }
                    })
                }

                //  从后台添加没在缓存中的对象
                // this.Ajax(
                //     that.FormUserHandler,
                //     "POST",
                //     { PostData: JSON.stringify(param) },
                //     function (data) {
                //         if (data && data.ReturnData.UnitItems) {
                //             that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                //             that.AddChoice.apply(that, data.ReturnData.UnitItems);
                //         }
                //     },
                //     true);
            }
            else if (UserID.constructor == Array) {
                for (var i = 0; i < UserID.length; i++) {
                    var id = UserID[i];
                    if (that.UserData.UserItems[id]) {
                        that.AddChoice(that.UserData.UserItems[id]);
                    }
                }
            } else if (that.UserData.UserItems[UserID]) {
                that.AddChoice(that.UserData.UserItems[UserID]);
            }
        },

        //添加用户数据到缓存中
        AddUserData: function (UnitItems) {
            for (var i = 0; i < UnitItems.length; i++) {
                if (UnitItems[i].UnitID)
                    this.UserData.UserItems[(UnitItems[i].UnitID)] = UnitItems[i];
                else {
                    this.UserData.UserItems[(UnitItems[i].id)] = UnitItems[i];
                }
            }
        },

        //添加选择
        AddChoice: function (UnitObject) {
            if (this.$tipDiv) { this.$tipDiv.remove(); } //筛选条件移除提示字样
            if (!UnitObject) return;
            if ((UnitObject.ObjectId || UnitObject.id) && !UnitObject.UnitID)
                UnitObject.UnitID = UnitObject.ObjectId || UnitObject.id;

            if ((UnitObject.Name || UnitObject.name || UnitObject.userName) && !UnitObject.DisplayName)
                UnitObject.DisplayName = UnitObject.Name || UnitObject.name || UnitObject.userName;
            if (!UnitObject.UnitID) return;
            if (this.Units[UnitObject.UnitID]) {
                if (!this.IsMultiple) {
                    this.FocusOutput();
                }
                return;
            }

            if (!this.IsMultiple) {
                this.ClearChoices(true);
            }
            var NewUnitObject = $.extend(true, {}, UnitObject);

            this.Units[NewUnitObject.UnitID] = NewUnitObject;


            this.OnChange(NewUnitObject);
            this.Validate();
            if (!this.Editable) {
                if (this.Visible)
                    this.$Input.text(NewUnitObject.DisplayName);
                return;
            }

            var choiceID = $.IGuid();
            NewUnitObject.ChoiceID = choiceID;
            var choice = $("<span class='SheetUser-Item label label-info icon-close-middle'></span>");

            var icon = "";
            switch (NewUnitObject.Type) {
                case 1:
                    icon = "fa icon-gongsi";
                    break;
                case 2:
                    icon = "fa icon-xiashuguanli";
                    break;
                case 4:
                    icon = "glyphicon icon-people"; //glyphicon glyphicon-user
                    break;
            }
            //choice.append($("<i>").addClass(icon));
            var itemName = $("<span>").text(NewUnitObject.DisplayName);
            choice.append(itemName);
            choice.attr("id", choiceID).data("UnitID", NewUnitObject.UnitID);
            this.$Input.before(choice);

            var that = this;
            //可用
            if (this.Editable) {
                choice.unbind("click.choice").bind("click.choice", this, function (e) {
                    e.data.RemoveChoice.apply(e.data, [$(this).data("UnitID")]);
                    e.data.ClearMapping.apply(e.data);
                    // //
                    that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                });

                // 放到onchage事件里面， 映射关系
                //if (!$.isEmptyObject(this.MappingControls)) {
                //    this.MappingControlsHandler(NewUnitObject);
                //}
            }

            if (!this.IsMultiple) {
                this.FocusOutput();
            }

            //作为筛选控件时，添加元素时需要移除
            if (this.$tipDiv) {
                this.$tipDiv.remove();
            }

            $(this.DepsDataPanel).find("i[data-unitid='" + NewUnitObject.UnitID + "']").addClass("icon-Check");
            $(this.UserListPanel).find("i[data-unitid='" + NewUnitObject.UnitID + "']").addClass("icon-Check");
            $(this.OwnDepsDataPanel).find("i[data-unitid='" + NewUnitObject.UnitID + "']").addClass("icon-Check");
            $(this.OwnUsersDataPanel).find("i[data-unitid='" + NewUnitObject.UnitID + "']").addClass("icon-Check");
            //$(this).find("i:last").removeClass("icon-Check");
        },

        //清楚所有的选择
        ClearChoices: function (notApplyOnChange) {
            for (var id in this.Units) {
                this.RemoveChoice(id, notApplyOnChange);
            }
            //清空的时候，清空缓存
            if (!this.UseDataCache) {
                //不用缓存，每次都清空
                this.UserData = {
                    //部门
                    OrgUnitItems: {
                    },
                    //标签
                    //OrgTagItems: [],
                    //部门用户:{部门ID:[]}
                    DepUserItems: {
                    },
                    //用户
                    UserItems: {},
                };
                if (this.DepsDataPanel) {
                    this.DepsDataPanel.data("IsLoad", false);
                    this.UsersDataPanel.data("IsLoad", false);
                    this.SelectorTabs.find("li.active").removeClass("active");
                }
            }
        },

        //移除选择
        RemoveChoice: function (id, notApplyOnChange) {
            if (!id) return;
            if (this.Units[id]) {
                if (this.Editable) {
                    $(this.Element).find("#" + this.Units[id].ChoiceID).remove();
                }
                else {
                    this.$Input.text("");
                }
                var typeStr = this.Units[id].Type || this.Units[id].UnitType;
                $(this.$UserPanel).find("i[data-unitid='" + id + "']").removeClass("icon-Check").parent().data("Exist", false);
                delete this.Units[id];
            }
            this.Validate();
            if (!notApplyOnChange)
                this.OnChange(this.Units[id]);
        },

        //判断是存在选项
        ExistChoice: function (UnitID) {
            if (this.Units[UnitID])
                return true;
            else
                return false;
        },

        //加载类型
        LoadOrgByTabType: function (tabType) {
            switch (tabType) {
                case "tab_Deps":
                    this.LoadDepsData();
                    break;
                case "tab_Users":
                    this.LoadUsersData();
                    break;
                case 'tab_RoleUsers':
                    this.SearchOrg();
                    break;
                // 2018-11-19 add by zyy
                case 'tab_owerDep':
                    this.SearchOrg();
                    break;

            }
        },

        //加载组织机构树
        LoadDepsData: function ($el, UnitID) {
            if (this.DepsDataPanel.data("IsLoad")) return;
            this.DepsDataPanel.data("IsLoad", true)
            this.DepsDataPanel.html("");
            this.LoadUnitsTree(this.DepsDataPanel, "tab_Deps");
        },

        //加载部门树
        LoadUnitsTree: function ($panel, tabType) {
            var that = this;
            var isDeps = false;
            //是部门页签，可以选择部门
            if (tabType && tabType == "tab_Deps") {
                isDeps = true;
            }

            if (!$.isEmptyObject(that.UserData.OrgUnitItems)) {
                var $ul = $("<ul class='nav'>");//.addClass("nav");
                var root = that.GetUnitsByParentId(that.UserData.OrgUnitItems[0].ParentId);
                //$ul.append(that.CreateUnitsItem(root[0], isDeps));
                for (var i = 0; i < root.length; i++) {
                    $ul.append(that.CreateUnitsItem(root[i], isDeps));
                }
                $panel.append($ul);
                //设置树的展开关闭
                if ($ul.metisMenu)
                    $ul.metisMenu();
                $ul.find("a:first,a:first>span.icon-xiangyou").data("IsSystem", true).click();
            }
            else {
                var actionCommand = "LoadUnit";
                if (that.UnitSelectionRange) {
                    //如果设置了选人范围则调用下面
                    actionCommand = "LoadOwnAndChildUnit";//如果设置了选人范围则加载制定组织和其下级
                }

                //更新选人范围
                that.UpdateUnitSelectionRange.apply(that);

                var params = { pid: '0' };
                this.Ajax(
                    '/ctg-workflow/organ/childList',
                    "POST",
                    params,
                    function (data) {
                        that.UserData.OrgUnitItems = data.page.result;
                        if (data.page.result.length == 0) {
                            return;
                        }
                        that.LoadUnitsTree($panel, tabType);
                    });
                // setTimeout(()=>{
                //     console.log(11111111111111)
                //  var data ={"Successful":true,"ErrorMessage":null,"Logined":true,"ReturnData":{"UnitItems":[{"ParentId":"","Type":1,"Icon":"glyphicon-folder-close","UnitID":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Code":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","DisplayName":"mq项目组","DeptId":0,"HasChild":false}]}}
                //  that.UserData.OrgUnitItems = data.ReturnData.UnitItems;
                //         if (data.ReturnData.UnitItems.length == 0) {
                //             return;
                //         }
                //         that.LoadUnitsTree($panel, tabType);
                // },1000)

            }
        },

        //校验
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            if ($.isEmptyObject(val)) {
                //为空时添加
                if (this.IsQueryControl && this.UnitsElement.find(".sp_placeholder").length == 0) {
                    this.UnitsElement.append(this.$tipDiv);
                }
                if (this.Required) {
                    this.AddInvalidText(this.UnitsElement, "必填");
                    return false;
                }
            }

            this.RemoveInvalidText(this.UnitsElement);

            if (this.IsQueryControl) {
                this.UnitsElement.removeClass("icon-arrow-down-full").css("border", "1px dashed #D7D5D5");
            }
            return true;
        },

        //创建部门的<li>对象
        CreateUnitsItem: function (UnitItem, isDeps) {
            var that = this;
            var $li = $("<li>");
            var $a = $("<a>");
            if (UnitItem.HasChild) {
                $a.append("<span class='fa icon-xiangyou sheet-angel'></span>");
            }
            else {
                $a.append("<span class='fa icon-xiangyou sheet-angel no-child'></span>");
            }
            var icon = "fa icon-xiashuguanli";
            if (UnitItem.Type == 1) {
                //公司
                icon = "fa icon-gongsi";
            } else if (UnitItem.Type == 8) {
                if (isDeps) {
                    //如果是角色，且是“部门”面板，则不添加项
                    return;
                }
                //角色
                icon = "fa icon-man";
            } else {
                icon = "fa icon-xiashuguanli";
            }
            $a.append("<i class='" + icon + "'></i>").append(UnitItem.name).data("UnitItem", UnitItem);
            if (isDeps) {
                $li.addClass("SheetUser-LiItem");

                //如果是部门tab的话，炫耀可选
                var $stateIcon = $("<i class='glyphicon'></i>").attr({ "data-UnitID": UnitItem.id, "data-Type": UnitItem.Type });
                $a.append($stateIcon);
                $a.click(function (e) {
                    if (e.target.tagName.toLowerCase() == "span") return;
                    if ($(this).data("IsSystem")) {
                        $(this).data("IsSystem", false)
                        return;
                    }
                    var UnitObject = $(this).data("UnitItem");
                    if ($(this).data("Exist")) {
                        that.RemoveChoice.apply(that, [UnitObject.id]);
                        $(this).find("i:last").removeClass("icon-Check");
                        $(this).data("Exist", false);
                    }
                    else {

                        $(this).find("i:last").addClass("icon-Check");
                        $(this).data("Exist", true);
                        that.AddChoice.apply(that, [UnitObject]);
                    }
                    ////
                    that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                });
            }
            else {
                $a.click(function (e) {
                    //if (e.target.tagName.toLowerCase() == "span") return;
                    var UnitObject = $(this).data("UnitItem");
                    that.LoadUsersByParenID.apply(that, [UnitObject.id], that.ShowUnActive);
                });
            }

            $li.append($a);
            if (UnitItem.HasChild) {
                $a.children(".sheet-angel").click(function (e) {
                    var pthat = this;
                    if ($(this).closest("li").hasClass("active")) {
                        $(this).removeClass("icon-chevron-down-fill").addClass("icon-xiangyou");
                        $(this).closest("li").removeClass("");
                        $(this).closest("li").find("ul").hide();
                    }
                    else {
                        $(this).closest("li").find("ul").remove();


                        var children = that.GetUnitsByParentId(UnitItem.id);
                        if (children.length > 0) {
                            var $ul = $("<ul>").addClass("nav").addClass("SheetUser_SubTreePanel");
                            for (var i = 0; i < children.length; i++) {
                                $ul.append(that.CreateUnitsItem(children[i], isDeps));
                            }
                            $(this).closest("li").append($ul);
                            if ($ul.metisMenu)
                                $ul.metisMenu();
                        }

                        setTimeout(function () {
                            if ($(pthat).closest("li").hasClass("active")) {
                                $(pthat).removeClass("icon-xiangyou").addClass("icon-chevron-down-fill");
                            } else {
                                $(pthat).removeClass("icon-chevron-down-fill").addClass("icon-xiangyou");
                            }
                        }, 100);
                    }
                });
            }

            return $li;
        },

        //根据父ID获取子部门
        GetUnitsByParentId: function (parentId) {
            var that = this;
            var units = [];
            for (var i = 0; i < that.UserData.OrgUnitItems.length; i++) {
                if (that.UserData.OrgUnitItems[i].ParentId == parentId) {
                    units.push(that.UserData.OrgUnitItems[i]);
                }
            }
            // 从后台读取下级部门
            if (units.length == 0) {
                // var actionCommand = "LoadUnit";
                //if (that.UnitSelectionRange) {
                //    //如果设置了选人范围则调用下面
                //    actionCommand = "LoadOwnAndChildUnit";//如果设置了选人范围则加载制定组织和其下级
                //}
                var params = {
                    pid: parentId
                }
                this.Ajax(
                    '/ctg-workflow/organ/childList',
                    "POST",
                    params,
                    function (data) {
                        if (data.page.result.length > 0) {
                            for (var i = 0; i < data.page.result.length; i++) {
                                // var parm ={}
                                // parm.id=data.page.result[i].UnitID
                                // parm.name=data.page.result[i].DisplayName
                                // parm.parId=data.page.result[i].ParentId
                                // parm.Type=data.page.result[i].Type
                                // parm.HasChild=data.page.result[i].HasChild
                                // parm.DisplayName =data.page.result[i].DisplayName


                                that.UserData.OrgUnitItems.push(data.page.result[i]);
                                units.push(data.page.result[i]);
                            }
                        }
                    }, false);
            }
            return units;
        },

        //加载用户数据
        LoadUsersData: function () {
            var that = this;
            if (that.UsersDataPanel.data("IsLoad")) return;
            that.UsersDataPanel.data("IsLoad", true).css("overflow", "hidden");
            var leftPanel = $("<div>").addClass("SheetUser_TreePanel").addClass("col-sm-7").addClass("col-xs-7").height("100%");
            that.UserListPanel = $("<div>").addClass("col-sm-5").addClass("col-xs-5").height("100%").css("overflow", "auto");

            that.UsersDataPanel.html("");
            that.UsersDataPanel.append(leftPanel);
            that.UsersDataPanel.append(that.UserListPanel);
            that.LoadUnitsTree(leftPanel);
        },
        // 人员单选
        LoadUsersByParenID: function (ParentId) {
            var that = this;
            if (!that.UserData.DepUserItems[ParentId]) {
                var showUnActive = this.ShowUnActive;//是否显示离职人员
                var params = {
                    unitSelectionRange: this.UnitSelectionRange,
                    organId: ParentId,
                    pageSize: 10000000
                };
                this.Ajax(
                    '/ctg-workflow/user/pageList',
                    "POST",
                    params,
                    function (data) {
                        that.UserData.DepUserItems[ParentId] = data.page.result;
                        that.LoadUsersByParenID.apply(that, [ParentId]);

                        //异步添加用户数据
                        setTimeout(function () {
                            that.AddUserData(data.page.result);
                        }, 0);
                    });
                // setTimeout(()=> {
                //   var data = {"Successful":true,"ErrorMessage":null,"Logined":true,"ReturnData":{"UnitItems":[{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"05e12f8e-5391-40ca-b78c-b8ffd8409a1f","Code":"$:LWCP_v1:$J3ODyEtMZXgIrlyj2Niphw==","DisplayName":"linq","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"6d20fec6-5ab8-4522-85f2-0efa9a0572d5","Code":"$:LWCP_v1:$a3xXAHQLqj+2YHDEnQg9og==","DisplayName":"陈志亮","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"022e56cc-5274-4468-b050-3d66dca6d336","Code":"$:LWCP_v1:$B10BgL6Ndj6Gh+YxIU+hyA==","DisplayName":"梁伟林","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"d7b6f5da-3ccd-4a73-87d7-62096e46a997","Code":"$:LWCP_v1:$h+hEuPxiaZNWNbjrLRZdmg==","DisplayName":"卢","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"c6885ff8-1cab-46d5-8364-b40a678683e5","Code":"$:LWCP_v1:$/RszIoHurHQ2XF/T0Z3jZg==","DisplayName":"梦达","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"23cf2763-939d-414e-a405-5f68f412ad90","Code":"$:LWCP_v1:$/bHs7txT0gOQXIfp5ECQRQ==","DisplayName":"肖庆云","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"ec8707ef-00c5-4be5-9870-2293986f010f","Code":"$:LWCP_v1:$xNTYyVf++SK7NOd/yPyvnA==","DisplayName":"许万超","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"396242db-3f89-4fb9-9534-42327ad2fea7","Code":"$:LWCP_v1:$YnmulHHUfzR3t+c1pEt35w==","DisplayName":"勇哥","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","id":"ad8116e6-cc54-49ba-bb4c-f600c6ffc2f4","Code":"$:LWCP_v1:$FFgieofhGbps6DTbsoFS+g==","DisplayName":"邹兵兵","DeptId":0,"HasChild":false}]}};
                //   that.UserData.DepUserItems[ParentId] = data.ReturnData.UnitItems;
                //   that.LoadUsersByParenID.apply(that, [ParentId]);
                //   that.AddUserData(data.ReturnData.UnitItems);
                //   //异步添加用户数据
                //   // setTimeout(function () {
                //   //     that.AddUserData(data.ReturnData.UnitItems);
                //   // }, 0);

                // }, 1000);


            }
            else {
                var $ul = $("<ul>").addClass("nav");
                for (var i = 0; i < that.UserData.DepUserItems[ParentId].length; i++) {
                    var UnitItem = that.UserData.DepUserItems[ParentId][i];
                    var $li = $("<li>").addClass("SheetUser-LiItem");
                    var $a = $("<a>").append("<i class='ivu-icon ivu-icon-people'></i>").data("UnitItem", UnitItem);
                    var checkboxID = $.IGuid();
                    //var $label = $("<label>").text(UnitItem.DisplayName);
                    var $stateIcon = $("<i class='glyphicon'></i>").attr("data-UnitID", UnitItem.id).attr("data-Type", UnitItem.Type);
                    //$a.append($label);
                    $a.append(UnitItem.userName);
                    $a.append($stateIcon);
                    if (that.ExistChoice(UnitItem.id)) {
                        $stateIcon.addClass("icon-Check");
                        $a.data("Exist", true);
                    }

                    $a.click(function () {
                        var UnitObject = $(this).data("UnitItem");
                        if ($(this).data("Exist")) {
                            that.RemoveChoice.apply(that, [UnitObject.id]);
                            $(this).find("i:last").removeClass("icon-Check");
                            $(this).data("Exist", false);
                        }
                        else {
                            $(this).find("i:last").addClass("icon-Check");
                            that.AddChoice.apply(that, [UnitObject]);;
                            $(this).data("Exist", true);
                        }
                        ////
                        that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                    });

                    $li.append($a);
                    $ul.append($li);
                }
                that.UserListPanel.html("").append($ul);
            }
        },
        ScrollLoad: function () {
            return;
            var that = this;
            if (that.IsPosting)
                return;
            //var searchkey = $(that.$Input).val().trim();
            var searchkey = $(that.$SearchInput).val().trim();
            that.IsPosting = true;
            var params =
                {
                    ActionName: "SheetUserAction",
                    Command: 'SearchOrg',
                    SearchKey: searchkey,
                    OrgUnitVisible: that.OrgUnitVisible,
                    UserVisible: that.UserVisible,
                    ShowUnActive: that.ShowUnActive,
                    UnitSelectionRange: that.UnitSelectionRange,
                    FromNum: that.FromNum,
                    ToNum: that.ToNum
                }
            that.Ajax(
                that.FormUserHandler,
                'POST', { PostData: JSON.stringify(params) }, function (data) {
                    if (data != null && data.ReturnData.UnitItems.length > 0) {
                        that.FromNum = that.ReturnData.UnitItems.ToNum;
                        that.ToNum += data.ReturnData.UnitItems.length;
                        var $ul = that.$SearchPanel.find('ul');
                        for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                            var UnitItem = data.ReturnData.UnitItems[i];
                            var $li = $("<li>");
                            var icon = UnitItem.Type == 1 ? "icon-gongsi" : (UnitItem.Type == 2 ? "icon-xiashuguanli" : UnitItem.Icon);
                            var displayName = UnitItem.DisplayName;
                            if (UnitItem.Type == 4) {
                                displayName += "-" + UnitItem.DepartmentName;
                            }
                            var $a = $("<a>").append("<i class='glyphicon " + (icon == "glyphicon-user" ? "icon-people" : icon) + "'></i>").append(displayName).data("UnitItem", UnitItem);
                            $a.click(function (e) {
                                var UnitObject = $(this).data("UnitItem");
                                that.AddChoice.apply(that, [UnitObject]);
                                that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                            });
                            $ul.append($li.append($a));
                        }
                    }
                    that.IsPosting = false;
                });
        },
        convertUser(data) {
            var arrayUnit = [];
            data.userList.forEach(user => {
                arrayUnit.push({
                    "id": user.id,
                    "Code": null,
                    "DisplayName": user.userName,
                    "name": user.userName,
                    "ParentId": null,
                    "Type": 4, // 屏蔽
                    "Icon": null,
                    "DepartmentName": user.organName
                });
            });
            return arrayUnit;
        },
        convertOrgan(data) {
            var arrayUnit = [];
            data.organList.forEach(organ => {
                arrayUnit.push({
                    "id": organ.id,
                    "Code": null,
                    "DisplayName": organ.name,
                    "name": organ.name,
                    "ParentId": null,
                    "Type": 4, // 屏蔽
                    "Icon": null,
                    "DepartmentName": organ.parentName
                });
            });
            return arrayUnit;
        },
        //搜索用户
        SearchOrg: function () {
            this.FromNum = 0;
            this.ToNum = 10;
            this.$SearchPanel.html("");
            if (this.CpLock)
                return;
            //var searchkey = $(this.$Input).val().trim();
            var searchkey = $(this.$SearchInput).val().trim();
            // edit by zyy
            if (!this.isOwerDep && !this.UnitSelectionRange && searchkey == "") {
                this.SelectorPanel.show();
                this.$SearchPanel.hide();
                return;
            }
            this.SelectorPanel.hide();
            this.$SearchPanel.show();
            //this.$SearchPanel.html("");
            var that = this;
            that.IsPosting = false;
            /*var params = {
                ActionName: "SheetUserAction", Command: "SearchOrg",
                SearchKey: searchkey, OrgUnitVisible: this.OrgUnitVisible,
                UserVisible: this.UserVisible, ShowUnActive: this.ShowUnActive,
                UnitSelectionRange: this.UnitSelectionRange,
                FromNum: this.FromNum, ToNum: this.ToNum
            };*/
            var params;
            var requestPromise;
            var searchPanelMessage = this.IsUser ? "没搜索到用户" : "没搜索到部门";
            // 查询部门
            if (this.IsUser) {
                params = {
                    userName: searchkey,
                    unitSelectionRange: this.UnitSelectionRange
                };
                requestPromise = userApi.searchUserByName(params);
            } else if (this.isOwerDep) {
                requestPromise = organApi.searchOrganByUserId();
            } else {
                params = {
                    organName: searchkey
                };
                requestPromise = organApi.searchOrganByName(params);
            }
            requestPromise.then(function (data) {
                //this.$SearchPanel.html("");
                data.ReturnData = {};
                data.ReturnData.UnitItems = that.IsUser ? that.convertUser(data) : that.convertOrgan(data);
                that.$SearchPanel.html("");
                if (data != null && data.ReturnData.UnitItems.length > 0) {
                    that.FromNum = that.ToNum + 1;
                    that.ToNum += data.ReturnData.UnitItems.length;
                    var $ul = $("<ul>").addClass("nav").addClass("SheetUser_SubTreePanel");
                    for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                        var UnitItem = data.ReturnData.UnitItems[i];
                        var $li = $("<li>");
                        var icon = UnitItem.Type == 1 ? "fa icon-gongsi" : (UnitItem.Type == 2 ? "fa icon-xiashuguanli" : (UnitItem.Icon == "glyphicon-user" ? "icon-people" : UnitItem.Icon));
                        var displayName = UnitItem.DisplayName;
                        if (UnitItem.Type == 4 && that.IsUser) {
                            displayName += "-" + UnitItem.DepartmentName;
                        }
                        var $a = $("<a>").append("<i class='glyphicon " + icon + "'></i>").append(displayName).data("UnitItem", UnitItem);
                        $a.click(function (e) {
                            var UnitObject = $(this).data("UnitItem");
                            that.AddChoice.apply(that, [UnitObject]);
                            that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                        });
                        $ul.append($li.append($a));
                    }
                    that.$SearchPanel.append($ul);
                    //滚动加载
                    $($ul).scroll(function () {
                        //底部基本距离+滚动高度>=文档高度-窗体高度
                        var h_ul = $(this).height();//窗口高度
                        var h_scrollTop = $(this).scrollTop();//滚动条顶部
                        if (50 + h_scrollTop >= $(this)[0].scrollHeight - h_ul) {
                            that.ScrollLoad();
                        }
                    });
                }
                else {
                    that.$SearchPanel.html(searchPanelMessage);
                }
            });
        },
        ClearMapping: function () {
            for (var property in this.MappingControls) {
                var targetFiled = this.MappingControls[property];
                var mapValue = '';
                $.ControlManager.SetControlValue(targetFiled, mapValue, this.ObjectId);
            }
        },
        //处理映射关系
        MappingControlsHandler: function (UnitObject) {
            if ($.isEmptyObject(UnitObject)) return;
            if ($.isEmptyObject(this.MappingControls)) return;
            if (this.IsMultiple) return;

            for (var property in this.MappingControls) {
                if (this.MappingControls.hasOwnProperty(property)) {
                    var targetFiled = this.MappingControls[property];
                    if (property.toLocaleLowerCase() == "parentid") {
                        property = "ParentId";
                    }
                    var MapValue = UnitObject[property] == void 0 ? "" : UnitObject[property];
                    if (property.toLowerCase() == 'gender' && !isNaN(MapValue)) {
                        MapValue = MapValue == 0 ? "未知" : (MapValue == 1 ? "男" : "女");
                    }

                    // 由于Mvc的JsonResult的Date Format为 "\/Date()\/"
                    if ((MapValue + '').indexOf("/Date(") > -1) {
                        MapValue = new Date(parseInt((MapValue + '').replace("/Date(", "").replace(")/", ""), 10));
                        MapValue = MapValue.toLocaleDateString();
                    }
                    $.ControlManager.SetControlValue(targetFiled, MapValue, this.ObjectId);
                }
            }
        },
        SetReadonly: function (v) {
            if (v) {
                this.$InputBody.attr("disabled", "disabled");
            } else {
                this.$InputBody.removeAttr("disabled");
            }
        },

        //更新选人范围
        UpdateUnitSelectionRange: function () {
            this.UnitSelectionRange = $(this.Element).attr("data-unitselectionrange");
            //计算控件中的选人范围
            var that = this;
            if (that.UnitSelectionRange && that.UnitSelectionRange.length > 0) {
                var SelectionRange = that.UnitSelectionRange + ";"; //可能UnitSelectionRange不是以";"结尾
                var selects = that.UnitSelectionRange.split(";");
                if (selects.length > 0) {
                    for (var i = 0; i < selects.length; i++) {
                        try {
                            var control = $("div[data-datafield=" + selects[i] + "]");
                            if (control.length > 0) {
                                var controlManager = control.JControl();
                                //列表筛选时取不到值
                                if (!controlManager) { continue; }
                                SelectionRange = SelectionRange.replace(selects[i] + ";", "");
                                //添加change事件，控件值改变时，当前控件需要
                                //绑定改变值事件
                                var changeKey = "SelectionChange." + that.DataField;
                                if (!controlManager.ChangeEvents[changeKey]) {
                                    controlManager.BindChange(changeKey, function () {
                                        that.SetValue("");
                                        //清空控件缓存
                                        that.UsersDataPanel.data("IsLoad", false);
                                        that.DepsDataPanel.data("IsLoad", false);
                                        that.UserData = {
                                            //部门
                                            OrgUnitItems: {},
                                            //标签
                                            //OrgTagItems: [],
                                            //部门用户:{部门ID:[]}
                                            DepUserItems: {},
                                            //用户
                                            UserItems: {},
                                        };
                                        that.Units = {};

                                        that.UnitSelectionRange = $(that.Element).attr("data-unitselectionrange");

                                        //重新渲染组织机构
                                        that.LoadOrgByTabType("tab_Users");
                                        that.LoadOrgByTabType("tab_Deps");
                                    });
                                }

                                var items = controlManager.GetValue();
                                if (items) {
                                    for (var id in items) {
                                        SelectionRange += items[id].UnitID + ";";
                                    }
                                }
                            }
                        } catch (error) {

                        }
                    }
                }

                that.UnitSelectionRange = SelectionRange;
            }
        }
    });
})(jQuery);;
//选人控件
(function ($) {
    // 控件执行
    // 参数{AutoTrim:true,DefaultValue:datavalue,OnChange:""}
    //可以通过  $("#id").SheetTextBox(参数)  来渲染控件和获取控件对象
    $.fn.FormMultiUser = function (opt) {
        return $.ControlManager.Run.call(this, "FormMultiUser", arguments);
    };

    //选人控件数据,单个页面所有数据库共用
    //该缓存用this.MultiUserData替代，原因是选人控件可能设置了选人范围,选人数据由单个控件自己维护
    //$.FormMultiUserData = {
    //    //部门
    //    OrgUnitItems: {},
    //    //标签
    //    //OrgTagItems: [],
    //    //部门用户:{部门ID:[]}
    //    DepUserItems: {},
    //    //用户
    //    UserItems: {},
    //};

    // 构造函数
    $.Controls.FormMultiUser = function (element, ptions, sheetInfo) {
        //选人缓存
        this.MultiUserData = {
            //部门
            OrgUnitItems: {},
            //标签
            //OrgTagItems: [],
            //部门用户:{部门ID:[]}
            DepUserItems: {},
            //用户
            UserItems: {},
        };
        //选择数据集合
        this.Units = {};
        //所有选择的元素
        this.UnitsElement = null;
        //搜索输入框元素
        this.SearchElement = null;
        this.SearchTxtElement = null;
        //组织机构容器
        this.SelectorPanel = null;
        this.OrgTreePanel = null;
        this.OrgListPanel = null;
        this.IsOverSelectorPanel = false;
        this.FormMultiUserHandler = '/ctg-workflow/user/querylist';
        this.CpLock = false;
        this.Options = ptions;
        this.SearchOrg = debounce(this.SearchOrg, 500, this);
        $.Controls.FormMultiUser.Base.constructor.call(this, element, ptions, sheetInfo);
        this.FromNum = 0;
        this.ToNum = 10;
    };

    // 继承及控件实现
    $.Controls.FormMultiUser.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            this.CurrentDocument = $(this.Element).closest("html").length == 1 ? $(this.Element).closest("html").parent() : $(document);
            this.CurrentBody = $(this.Element).closest("body").length == 1 ? $(this.Element).closest("body") : $("body");

            //是否在子表里面子表
            this.IsInGridView = !$.isEmptyObject(this.ObjectId);

            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            //渲染界面
            this.HtmlRender();
            //绑定事件
            this.BindEnvens();

            //初始化默认值
            this.InitValue();
        },

        //初始化值
        InitValue: function () {
            if (this.Value) {
                this.SetValue(this.Value);
            }
        },
        CheckUnitValidate: function (Obj) {
            //2017/6/12修改，原因是关联携带了大量数据过来校验导致超时
            return Obj;
            var newObj = Obj;
            var that = this;
            if ($.isEmptyObject(that.MultiUserData.OrgUnitItems)) {
                if ($.SmartForm.ResponseContext && !$.SmartForm.ResponseContext.IsCreateMode) {
                    //如果不是创建模式则不执行check，因为非创建模式的数据已经check过
                    return newObj;
                }
                var UnitIds = [];
                if (Obj.constructor == Object) {
                    UnitIds.push(Obj.UnitId);
                } else if (Obj.constructor == Array) {
                    for (var i = 0; i < Obj.length; i++) {
                        if (Obj[i].constructor == Object) {
                            UnitIds.push(Obj[i].UnitId);
                        }
                        else if (Obj[i].constructor == String) {
                            UnitIds.push(Obj[i]);
                        }
                    }
                } else if (Obj.constructor == String) {
                    UnitIds.push(Obj);
                }
                //请求后台，判断Obj是否在给定范围内，如果在给定范围内则返回Unit对象，后续调用AddChoice
                var unitTemp = '';
                for (var i = 0; i < UnitIds.length; i++) {
                    unitTemp += UnitIds[i] + ';';
                }
                var params = {
                    ActionName: "SheetUserAction",
                    Command: "CheckUnitValidate",
                    UnitSelectionRange: that.UnitSelectionRange,
                    UnitIds: unitTemp
                }
                this.Ajax(
                    that.FormMultiUserHandler,
                    "POST",
                    {
                        PostData: JSON.stringify(params)
                    },
                    function (data) {
                        newObj = data.ReturnData.UnitItems;
                    }, false);
            }
            return newObj;
        },
        //设置值
        SetValue: function (Obj, isUser) {
            var that = this;
            //针对设置了默认只的情况
            if (Obj == void 0 || Obj == null || Obj == "" || Obj.length == 0) {
                this.ClearChoices();
                return;
            }
            if (this.UnitSelectionRange) {
                //有设置选人范围
                if ($.SmartForm && $.SmartForm.ResponseContext && $.SmartForm.ResponseContext.IsCreateMode) {
                    //创建模式
                    Obj = that.CheckUnitValidate(Obj);
                } else {
                    //修改模式
                    if (this.Editable && (Obj == void 0 || Obj == null || Obj == "" || Obj.length == 0)) {
                        //可编辑
                        Obj = that.CheckUnitValidate(Obj);
                    }
                }
            }
            //if (this.UnitSelectionRange)
            //    Obj = that.CheckUnitValidate(Obj);

            if (!Obj) { return; } //checkUnitValidate可能返回空

            if (Obj.constructor == Object) {
                this.AddChoice(Obj);
            }
            else if (Obj.constructor == Array) {
                for (var i = 0; i < Obj.length; i++) {
                    if (Obj[i].constructor == Object) {
                        this.AddChoice(Obj[i]);
                    }
                    else if (Obj[i].constructor == String) {
                        this.AddUserID(Obj, isUser);
                        break;
                    }
                }
            }
            else if (Obj.constructor == String) {
                this.AddUserID(Obj, isUser);
            }
            //this.FormMultiUserChange();
            this.OnChange(Obj);
        },

        //FormMultiUserChange: function (value) {
        //    var that = this;
        //    this.FormMultiUserTimeout && clearTimeout(this.FormMultiUserTimeout);
        //    this.FormMultiUserTimeout = null;

        //    this.FormMultiUserTimeout = setTimeout(function () {
        //        that.OnChange(value);
        //        that.FormMultiUserTimeout = null;
        //    }, 600);
        //},
        //返回 {UnitID1:{UnitID: , Code:, DisplayName:Type, Icon ,ParentId},UnitID1:{UnitID: , Code:, DisplayName: }}对象
        GetValue: function () {
            return $.IClone(this.Units);
        },

        //读取选中的UnitID
        GetUnitIDs: function () {
            var ValObjs = this.GetValue();
            var UintIDs = new Array();
            for (var key in ValObjs) {
                UintIDs.push(key);
            }

            return UintIDs;
        },

        //获取显示
        GetText: function () {
            var userNames;
            for (var ObjectId in this.Units) {
                if (this.IsMultiple) {
                    if (userNames == void 0) userNames = new Array();
                    userNames.push(this.Units[ObjectId].DisplayName);
                }
                else {
                    userNames = this.Units[ObjectId].DisplayName;
                }
            }
            return userNames == void 0 ? "" : userNames.toString();
        },

        //保存数据
        SaveDataField: function () {
            var result = {
            };
            if (!this.Visible) return result;
            var oldresult = this.DataItem;
            if (!oldresult) {
                return {
                };
            }

            var UnitIDs = this.GetUnitIDs();
            if (oldresult.Value != UnitIDs) {
                result[this.DataField] = UnitIDs;
                return result;
            }
            result[this.DataField] = [];
            return result;
        },

        //根据ChoiceID，获取已经选择的组织
        GetSelectUnitByChoiceID: function (choiceID) {
            if (this.Units == null || this.Units.length == 0) return null;
            for (var key in this.Units) {
                if (this.Units[key].ChoiceID == choiceID) {
                    return this.Units[key];
                }
            }
            return null;
        },

        //渲染样式
        HtmlRender: function () {
            $(this.Element).addClass("SheetUser");
            if (!this.IsInGridView) {
                //不在子表里面
                $(this.Element).css("position", "relative");
            }
            if (!this.Editable) {
                this.$Input = $("<pre style='border:none;'>");
                this.$InputBody.append(this.$Input);
                return;
            }
            //设置当前控件的ID
            this.ID = $.IGuid();

            //this.$InputBody.attr("ID", this.ID);

            //this.UnitsElement = $("<div data-targetid='" + this.ID + "' name='" + this.DataField + "' class='form-control form-user-add icon-arrow-down-full' style='height:auto;overflow:auto;width:100%;height:auto;max-height:100px;'>");
            this.UnitsElement = $("<div data-targetid='" + this.ID + "' name='" + this.DataField + "' class='form-control form-user-add icon-arrow-down-full' style='height:auto;overflow:auto;width:100%;height:auto;max-height:100px;'>");

            this.$Input = $("<input class='SheetUser-Input' style='width:1px;display:none;'>");
            var that = this;
            this.$Input.on("compositionstart", function () {
                that.CpLock = true;
            });
            this.$Input.on("compositionend", function () {
                that.CpLock = false;
            });
            this.UnitsElement.append(this.$Input);
            this.$InputBody.attr("ID", this.ID).css({ "min-width": "100px" }).append(this.UnitsElement);

            //作为筛选条件时显示样式
            var placeHolder = "点击选择";

            if (this.IsQueryControl) {
                placeHolder += this.DisplayName.replace(/^\s+|\s+$/g, '');
            } else {
                if (this.OrgUnitVisible && this.UserVisible) {
                    placeHolder += "人员/部门";
                } else if (this.OrgUnitVisible && !this.UserVisible) {
                    placeHolder += "部门";
                } else if (!this.OrgUnitVisible && this.UserVisible) {
                    placeHolder += "人员";
                }
            }
            this.UnitsElement.removeClass("icon-arrow-down-full");
            this.UnitsElement.removeClass("icon-arrow-down-full").css("border", "1px dashed #cccccc");
            this.$tipDiv = $("<div style='width:98%;height:30px;float:right;text-align:center;'><div><span class='sp_placeholder'>" + placeHolder + "</span></div></div>")
            this.UnitsElement.append(this.$tipDiv);
        },

        //绑定事件
        BindEnvens: function () {
            //不可用
            if (!this.Editable) {
                return;
            }
            var that = this;

            //点击选人控件再渲染
            $(this.$InputBody).one("click.UserOnce", function () {
                that.RenderNext.apply(that);
                that.FocusInput();
            });
            //获取焦点选人控件再渲染
            $(this.$InputBody).find("input").on("focus.UserOnce", function (e) {
                if (!that.$UserPanel) {
                    that.RenderNext.apply(that);
                }
                that.FocusInput();
                $(that.$InputBody).unbind("click.UserOnce");
            });
        },

        RenderNext: function () {
            var that = this;
            that.$SearchDiv = $("<div data-targetid='" + that.ID + "' data-formmultiuserpanel='searchdiv' class='searchdiv'><input class='searchinput' type='text' ></input></div>");

            that.$SearchInput = that.$SearchDiv.find("input").eq(0); //搜索输入框
            that.Placeholder = "输入" + that.DisplayName + "查找";
            that.$SearchInput.attr("placeholder", that.Placeholder);

            //搜索面板
            //that.$SearchPanel = $("<div>").attr("data-targetid", that.ID).addClass("SheetUser-SelectorPanel").attr("data-FormMultiUserPanel", "SearchPanel");
            that.$SearchPanel = $("<div data-targetid='" + that.ID + "' class='SheetUser-SelectorPanel' data-FormMultiUserPanel='SearchPanel' style='overflow-y: auto;'>");

            //组织机构选择面板
            //that.SelectorPanel = $("<div>").attr("data-targetid", that.ID).addClass("SheetUser-SelectorPanel").attr("data-FormMultiUserPanel", "SelectorPanel");//.width(this.Width);
            that.SelectorPanel = $("<div data-targetid='" + that.ID + "' class='SheetUser-SelectorPanel' data-FormMultiUserPanel='SelectorPanel'>");
            //that.SelectorPanel.append(that.$SearchDiv);
            //组织标签
            //that.SelectorTabs = $("<ul>").addClass("nav").addClass("nav-tabs user-tabs");
            that.SelectorTabs = $("<ul class='nav nav-tabs user-tabs'>");
            if (that.UnitSelectionRange) {
                that.SelectorTabs.append($("<li data-tabtype='tab_RoleUsers' style='cursor:pointer;'><a>用户</a></li>"));
                that.UserVisible = false;
                that.OrgUnitVisible = false;
            }
            if (that.UserVisible) {
                //that.SelectorTabs.append($("<li>").append("<a>用户</a>").attr("data-tabtype", "tab_Users").css("cursor", "pointer"));
                that.SelectorTabs.append($("<li data-tabtype='tab_Users' style='cursor:pointer;'><a>用户</a></li>"));
            }
            if (that.OrgUnitVisible) {
                //that.SelectorTabs.append($("<li>").append("<a>部门</a>").attr("data-tabtype", "tab_Deps").css("cursor", "pointer"));
                that.SelectorTabs.append($("<li data-tabtype='tab_Deps' style='cursor:pointer;'><a>部门</a></li>"));
            }

            that.SelectorPanel.append(that.SelectorTabs);

            //用户面板
            //that.UsersDataPanel = $("<div>").addClass("SheetUser_DataPanel").addClass("row").addClass("SheetUser_tab_Users");
            that.UsersDataPanel = $("<div class='SheetUser_DataPanel row SheetUser_tab_Users'>");
            //部门面板
            //that.DepsDataPanel = $("<div>").addClass("SheetUser_DataPanel").addClass("row").addClass("SheetUser_tab_Deps");
            that.DepsDataPanel = $("<div class='SheetUser_DataPanel row SheetUser_tab_Deps'>");
            //标签面板

            that.SelectorPanel.append(that.DepsDataPanel);
            that.SelectorPanel.append(that.UsersDataPanel);

            that.$UserPanel = $("<div class='userpanel'  style='position:absolute;'>");
            that.$UserPanel.append(that.$SearchDiv).append(that.SelectorPanel).append(that.$SearchPanel);
            //that.$UserPanel.appendTo("body");
            that.$UserPanel.appendTo(that.CurrentBody);
            //--------------------------------------

            //页签切换
            that.SelectorTabs.find("li").unbind("click.SelectorTabs").bind("click.SelectorTabs", that, function (e) {
                if ($(this).hasClass("active")) return;
                var that = e.data;
                var $parent = $(this).parent();
                $parent.find("li").removeClass("active");
                $(this).addClass("active");

                var tabType = $(this).attr("data-tabtype");
                that.SelectorPanel.find(".SheetUser_DataPanel").hide();
                that.SelectorPanel.find(".SheetUser_" + tabType).show();
                that.LoadOrgByTabType(tabType);

                setTimeout(function () {
                    e.data.$SearchInput[0].focus();
                }, 50)
            });

            //点击到当前元素，设置input焦点
            $(that.$InputBody).children("div").unbind("click.FormMultiUser").bind("click.FormMultiUser", that, function (e) {
                var $target = $(e.target);
                if (!$target.closest("li").hasClass("SheetUser-LiItem")) {
                    e.data.FocusInput.apply(e.data);

                    setTimeout(function () {
                        e.data.$SearchInput[0].focus();
                    }, 50)
                    //e.data.$SearchInput[0].focus(); //弹出对话框后手动获取搜索框焦点,不执行绑定的focusin事件
                    //首页
                    if (typeof AppTree != 'undefined') {
                        AppTree.destroyTree();
                    }
                    //下拉框隐藏
                    $("ul.drop-list.drop-list_s").hide();
                    //关联表单隐藏
                    $(".form-query-dropdown").hide();
                    // 停止冒泡，防止与SheetQuery冲突而添加
                    e.stopPropagation();
                }
            });

            $(that.$UserPanel).children("div").unbind("click.FormMultiUser").bind("click.FormMultiUser", that, function (e) {
                var $target = $(e.target);
                if (!$target.closest("li").hasClass("SheetUser-LiItem")) {
                    //e.data.$Input.focus();
                    //e.data.$SearchInput[0].focus();
                    // 停止冒泡，防止与SheetQuery冲突而添加
                    e.stopPropagation();
                }
            });

            //得到焦点显示
            $(that.$SearchInput).unbind("focusin.Input").bind("focusin.Input", that, function (e) {
                e.data.$SearchInput.removeAttr("placeholder");
                //e.data.FocusInput.apply(e.data);
            });

            $(that.$SearchInput).off("input propertychange").on("input propertychange", that, function (e) {
                var isIE = navigator.userAgent.indexOf("MSIE") > -1 || navigator.userAgent.indexOf("Edge") > -1
                    || (navigator.userAgent.indexOf("Trident") > -1 && navigator.userAgent.indexOf("rv") > -1);
                if (isIE) {
                    var that = e.data;
                    that.TimeOut && window.clearTimeout(that.TimeOut);
                    that.TimeOut = setTimeout(function () {
                        that.SearchOrg.apply(that, [that]);
                    }, 500);
                }
            });

            //控件输入
            $(that.$SearchInput).unbind("keyup.SearchTxtElement").bind("keyup.SearchTxtElement", that, function (e) {
                e.data.SetSearchTxtElementWidth.apply(e.data);
                //e.data.FocusInput.apply(e.data);
                //e.data.KeyTime = new Date();

                var that = e.data;
                that.TimeOut && window.clearTimeout(that.TimeOut);
                that.TimeOut = setTimeout(function () {
                    that.SearchOrg.apply(that, [that]);
                }, 500);
            });

            $(that.$SearchInput).unbind("keydown.SearchTxtElement").bind("keydown.SearchTxtElement", that, function (e) {
                if (e.keyCode == 8 && $(this).val() == "" && $(this).prev().length > 0) {
                    var unit = e.data.GetSelectUnitByChoiceID.apply(e.data, [$(this).prev().attr("id")]);
                    e.data.RemoveChoice.apply(e.data, [unit.UnitID]);
                }
            });

            //点击屏幕的其他地方 $(document)
            $(that.CurrentDocument).unbind("mousedown." + that.ID).bind("mousedown." + that.ID, that, function (e) {
                //edit by xc 特殊情况处理
                if ($(e.target).hasClass("row") && $(e.target).children(".col-md-6").children("div[data-controlkey='FormUser']").length > 0) {
                    return false;
                }
                else if ($(e.target).closest("div[data-targetid='" + e.data.ID + "']").length == 0) {
                    e.data.FocusOutput.apply(e.data);
                    e.stopPropagation();
                }
            });
        },

        //设置输入框的宽度
        SetSearchTxtElementWidth: function () {
            //var w = "1px";
            //var length = this.$Input.val().length;
            //if (length > 0) {
            //    w = length * 15 + "px";
            //    this.$Input.removeAttr("PlaceHolder", this.PlaceHolder);
            //}
            ////else if ($.isEmptyObject(this.Units)) {
            ////    w = "100%";
            ////    this.$Input.attr("PlaceHolder", this.PlaceHolder);
            ////}
            ////else {
            ////    this.$Input.removeAttr("PlaceHolder", this.PlaceHolder);
            ////}
            //$(this.$Input).width(w);
        },

        //获取焦点焦点
        FocusInput: function () {
            //this.$SearchInput.removeAttr("placeholder");
            var position = this.$InputBody.offset();
            //var WindowW = $(window).outerWidth();
            var WindowW = $(this.CurrentDocument).outerWidth();
            var padding = this.$InputBody.css("padding-left");
            padding = padding ? parseInt(padding) : 0;
            if (this.IsInGridView) {
                if (WindowW - position.left < 500) {
                    this.$UserPanel.css("right", WindowW - position.left - this.$InputBody.outerWidth());
                    //this.$SearchDiv.css("right", WindowW - position.left - this.$InputBody.outerWidth());
                    //this.SelectorPanel.css("right", WindowW - position.left - this.$InputBody.outerWidth());
                    //this.$SearchPanel.css("right", WindowW - position.left - this.$InputBody.outerWidth());
                } else {
                    this.$UserPanel.css("left", position.left);
                    //this.$SearchDiv.css("left", position.left);
                    //this.SelectorPanel.css("left", position.left);
                    //this.$SearchPanel.css("left", position.left);
                }
                //this.SelectorPanel.css("top", position.top + this.$InputBody.height());
                //this.SelectorPanel.width(this.UnitsElement.width());
            }
            else {
                if (WindowW - position.left < 500) {
                    this.$UserPanel.css("right", padding);
                    //this.$SearchDiv.css("right", padding);
                    //this.SelectorPanel.css("right", padding);
                    //this.$SearchPanel.css("right", padding);
                } else {
                    this.$UserPanel.css("left", position.left + padding);
                    //this.$SearchDiv.css("left", position.left + padding);
                    //this.SelectorPanel.css("left", position.left + padding);
                    //this.$SearchPanel.css("left", position.left + padding);
                }
            }

            //var bottom = $(window).height() - position.top - this.$InputBody.height() + $(window).scrollTop();
            //var userPanelHeight = $(this.$UserPanel).height();
            //if (bottom > userPanelHeight) {
            //    this.$UserPanel.css("top", position.top + this.$InputBody.height());
            //} else {
            //    this.$UserPanel.css("top", position.top - userPanelHeight);
            //}

            this.$UserPanel.css("top", position.top + this.$InputBody.height());



            //this.$SearchDiv.css("top", position.top + this.$InputBody.height());
            //this.SelectorPanel.css("top", position.top + this.$InputBody.height() + this.$SearchDiv.height());
            //this.$SearchPanel.css("top", position.top + this.$InputBody.height() + this.$SearchDiv.height());

            //绑定元素父元素的滚动事件，重新赋值$UserPanel的高度和left
            var that = this;
            $.each($(this.Element).parents(), function (index, obj) {
                $(obj).scroll(function () {
                    that.$UserPanel.css("top", that.$InputBody.height() + that.$InputBody.offset().top);

                });
            });


            if (this.SelectorPanel.is(":visible")) return;

            //to do by xiechang 增加位置判断，防止浏览器遮罩

            //其他的选人控件都隐藏(包括单人和多人 edit by xc)
            $("div[data-FormMultiUserPanel='SelectorPanel'],div[data-FormUserPanel='SelectorPanel'],div[data-formmultiuserpanel='searchdiv']").hide();

            if (this.SelectorTabs.find("li.active").length == 0) {
                this.SelectorTabs.find("li:first").click();
            }
            this.$UserPanel.show();
            var searchkey = $(this.$SearchInput).val().trim();
            if (!this.UnitSelectionRange && !searchkey) {
                this.SelectorPanel.show();
                this.$SearchPanel.hide();
                this.$SearchDiv.show();
            } else {
                //有搜索关键字时，点击搜索结果div
                this.$SearchDiv.show();
                this.$SearchPanel.show();
            }

            //var bottom = $(window).height() - position.top - this.$InputBody.height() + $(window).scrollTop();
            //var userPanelHeight = $(this.$UserPanel).height();
            //if (bottom < userPanelHeight) {
            //    if (this.$InputBody.parents(".modal-dialog").length == 1) {
            //        this.SelectorPanel.css("height", bottom - 50);
            //    } else {
            //        setTimeout(function () {
            //            $(window).scrollTop(userPanelHeight - bottom + 30);
            //            $("body").css("overflow", "hidden");
            //        }, 300)
            //    }
            //} else {
            //    $("body").css("overflow", "hidden");
            //}
        },

        //失去焦点
        FocusOutput: function () {

            this.$SearchInput.attr("placeholder", this.Placeholder);

            if (this.SelectorPanel) {
                this.SelectorPanel.hide();
                this.$SearchPanel.hide();
                //this.$Input.val("");
                this.$SearchInput.val("");
                this.Required && (this.UnitsElement.text() != "" && this.UnitsElement.css({ "border": "1px solid #ddd", "box-shadow": "none" }));
            }
            this.$UserPanel.hide();
            $("body").css("overflow", "auto");
        },

        //添加:UserID/UserCode
        AddUserID: function (UserID, isUser) {
            var that = this;

            var ids = []
            if (UserID.constructor == Array) {
                for (var i = 0; i < UserID.length; i++) {
                    var id = UserID[i];
                    if (!that.MultiUserData.UserItems[id]) {
                        ids.push(id);
                    }
                }
            }
            else {
                if (!that.MultiUserData.UserItems[UserID]) {
                    ids.push(UserID);
                }
                else {
                    that.AddChoice(that.MultiUserData.UserItems[UserID]);
                }
            }
            if (ids.length > 0) {
                var param = {
                    ActionName: "SheetUserAction", Command: "GetUserProperty", UnitID: ids
                };
                // this.Ajax(
                //     that.FormMultiUserHandler,
                //     "POST",
                //     { PostData: JSON.stringify(param) },
                //     function (data) {
                //         if (data && data.ReturnData.UnitItems) {
                //             that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                //             for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                //                 that.AddChoice.apply(that, [data.ReturnData.UnitItems[i]]);
                //             }
                //         }
                //     },
                //     false);
                if (isUser) {
                    HTTP.getUserProperty(param).then((data) => {
                        if (data && data.ReturnData.UnitItems) {
                            that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                            for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                                that.AddChoice.apply(that, [data.ReturnData.UnitItems[i]]);
                            }
                        }
                    })
                }
                else {
                    HTTP.getOrganProperty(param).then((data) => {
                        if (data && data.ReturnData.UnitItems && data.ReturnData.UnitItems.length > 0) {
                            that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                            for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                                that.AddChoice.apply(that, [data.ReturnData.UnitItems[i]]);
                            }
                        }
                        else {
                            HTTP.getUserProperty(param).then((data) => {
                                if (data && data.ReturnData.UnitItems) {
                                    that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                                    for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                                        that.AddChoice.apply(that, [data.ReturnData.UnitItems[i]]);
                                    }
                                }
                            })
                        }
                    })
                }


                // setTimeout(()=>{
                //      var data ={"Successful":true,"ErrorMessage":null,"Logined":true,"ReturnData":{"UnitItems":[{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"05e12f8e-5391-40ca-b78c-b8ffd8409a1f","Code":"$:LWCP_v1:$J3ODyEtMZXgIrlyj2Niphw==","DisplayName":"linq","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"6d20fec6-5ab8-4522-85f2-0efa9a0572d5","Code":"$:LWCP_v1:$a3xXAHQLqj+2YHDEnQg9og==","DisplayName":"陈志亮","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"022e56cc-5274-4468-b050-3d66dca6d336","Code":"$:LWCP_v1:$B10BgL6Ndj6Gh+YxIU+hyA==","DisplayName":"梁伟林","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"d7b6f5da-3ccd-4a73-87d7-62096e46a997","Code":"$:LWCP_v1:$h+hEuPxiaZNWNbjrLRZdmg==","DisplayName":"卢","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"c6885ff8-1cab-46d5-8364-b40a678683e5","Code":"$:LWCP_v1:$/RszIoHurHQ2XF/T0Z3jZg==","DisplayName":"梦达","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"23cf2763-939d-414e-a405-5f68f412ad90","Code":"$:LWCP_v1:$/bHs7txT0gOQXIfp5ECQRQ==","DisplayName":"肖庆云","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"ec8707ef-00c5-4be5-9870-2293986f010f","Code":"$:LWCP_v1:$xNTYyVf++SK7NOd/yPyvnA==","DisplayName":"许万超","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"396242db-3f89-4fb9-9534-42327ad2fea7","Code":"$:LWCP_v1:$YnmulHHUfzR3t+c1pEt35w==","DisplayName":"勇哥","DeptId":0,"HasChild":false},{"_Gender":0,"DepartmentName":"mq项目组","Birthday":"1753/1/1","Gender":"未知","Email":null,"Mobile":null,"Avatar":null,"DingTalkAccount":null,"ParentId":"18f923a7-5a5e-426d-94ae-a55ad1a4b240","Type":4,"Icon":"glyphicon-user","UnitID":"ad8116e6-cc54-49ba-bb4c-f600c6ffc2f4","Code":"$:LWCP_v1:$FFgieofhGbps6DTbsoFS+g==","DisplayName":"邹兵兵","DeptId":0,"HasChild":false}]}};
                //      if (data && data.ReturnData.UnitItems) {
                //             that.AddUserData.apply(that, [data.ReturnData.UnitItems]);
                //             for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                //                 that.AddChoice.apply(that, [data.ReturnData.UnitItems[i]]);
                //             }
                //         }
                // },1000)

            }
            else if (UserID.constructor == Array) {
                for (var i = 0; i < UserID.length; i++) {
                    var id = UserID[i];
                    if (that.MultiUserData.UserItems[id]) {
                        that.AddChoice(that.MultiUserData.UserItems[id]);
                    }
                }
            }
        },

        //添加用户数据
        AddUserData: function (UnitItems) {
            for (var i = 0; i < UnitItems.length; i++) {
                if (UnitItems[i].UnitID)
                    this.MultiUserData.UserItems[(UnitItems[i].UnitID)] = UnitItems[i];
                else {
                    this.MultiUserData.UserItems[(UnitItems[i].id)] = UnitItems[i];
                }
            }
        },

        //添加选择
        AddChoice: function (UnitObject) {
            if (!UnitObject) return;
            if ((UnitObject.ObjectId || UnitObject.id) && !UnitObject.UnitID)
                UnitObject.UnitID = UnitObject.ObjectId || UnitObject.id;

            if ((UnitObject.Name || UnitObject.name || UnitObject.userName) && !UnitObject.DisplayName)
                UnitObject.DisplayName = UnitObject.Name || UnitObject.name || UnitObject.userName;
            if (!UnitObject.UnitID) return;
            if (this.Units[UnitObject.UnitID]) return;

            if (!this.IsMultiple) {
                this.ClearChoices();
            }
            var NewUnitObject = $.extend(true, {}, UnitObject);

            this.Units[NewUnitObject.UnitID] = NewUnitObject;

            //this.OnChange(NewUnitObject);
            //this.FormMultiUserChange(NewUnitObject);

            this.Validate();
            if (!this.Editable) {
                if (this.Visible) {
                    var text = this.$Input.text();
                    text = text ? text + ";" + NewUnitObject.DisplayName : NewUnitObject.DisplayName;
                    this.$Input.text(text);


                    //Error这一块是不是应该抽到BaseControl中去
                    ////如果控件在子表中，子表列宽要重新计算
                    //if (this.IsInGridView) {
                    //    var gridViewCtrl = $(this.Element).closest('div[data-controlkey="FormGridView"]');
                    //    if (gridViewCtrl && gridViewCtrl.length > 0) {
                    //        gridViewCtrl = gridViewCtrl.FormGridView();
                    //        gridViewCtrl && gridViewCtrl.ResizeColumn(true);
                    //    }
                    //}
                }
                return;
            }

            var choiceID = $.IGuid();
            NewUnitObject.ChoiceID = choiceID;
            var choice = $("<span class='SheetUser-Item label label-info icon-close-middle'></span>");

            var icon = "";
            switch (NewUnitObject.Type) {
                case 1:
                    icon = "fa icon-gongsi";
                    break;
                case 2:
                    icon = "fa icon-xiashuguanli";
                    break;
                case 4:
                    icon = "glyphicon icon-people";
                    break;
                //case 8:
                //    icon = "glyphicon-bookmark";
                //break;
            }
            //choice.append($("<i>").addClass(icon));
            var itemName = $("<span>").text(NewUnitObject.DisplayName);
            choice.append(itemName);
            choice.attr("id", choiceID).data("UnitID", NewUnitObject.UnitID);
            this.$Input.before(choice);
            var that = this;
            //可用
            if (this.Editable) {
                choice.unbind("click.choice").bind("click.choice", this, function (e) {
                    e.data.RemoveChoice.apply(e.data, [$(this).data("UnitID")]);
                    // //
                    //var $this = $(this).closest("div.SheetUser");
                    that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                });

                //映射关系
                if (!$.isEmptyObject(this.MappingControls)) {
                    this.MappingControlsHandler(NewUnitObject);
                }
                ////如果控件在子表中，子表列宽要重新计算
                //if (this.IsInGridView) {
                //    var gridViewCtrl = $(this.Element).closest('div[data-controlkey="FormGridView"]');
                //    if (gridViewCtrl && gridViewCtrl.length > 0) {
                //        gridViewCtrl = gridViewCtrl.FormGridView();
                //        gridViewCtrl && gridViewCtrl.ResizeColumn(true);
                //    }
                //}
            }

            if (!this.IsMultiple) {
                this.FocusOutput();
            }

            //勾选选中项
            //$(this.DepsDataPanel).find("input:checkbox[id=c_" + UnitID + "]").prop("checked", true).parent().data("Exist", true);
            //$(this.UserListPanel).find("input:checkbox[id=c_" + UnitID + "]").prop("checked", true).parent().data("Exist", true);

            //作为筛选控件时，添加元素时需要移除
            if (this.$tipDiv) {
                this.$tipDiv.remove();
            }
        },

        //清楚所有的选择
        ClearChoices: function () {
            for (var UnitID in this.Units) {
                this.RemoveChoice(UnitID);
            }
            //清空的时候，清空缓存
            if (!this.UseDataCache) {
                //不用缓存，每次都清空
                this.MultiUserData = {
                    //部门
                    OrgUnitItems: {
                    },
                    //标签
                    //OrgTagItems: [],
                    //部门用户:{部门ID:[]}
                    DepUserItems: {
                    },
                    //用户
                    UserItems: {},
                };
                if (this.DepsDataPanel) {
                    this.DepsDataPanel.data("IsLoad", false);
                    //this.TagsDataPanel.data("IsLoad", false);
                    this.UsersDataPanel.data("IsLoad", false);
                    this.SelectorTabs.find("li.active").removeClass("active");
                }
            }
        },

        //移除选择
        RemoveChoice: function (Obj) {
            if (!Obj) return;
            if (Obj.constructor == String) {
                if (this.Units[Obj]) {
                    if (this.Editable) {
                        $(this.Element).find("#" + this.Units[Obj].ChoiceID).remove();
                    }
                    else {
                        this.$Input.text("");
                    }
                    $(this.DepsDataPanel).find("input:checkbox[id='c_" + Obj + "']").prop("checked", false).parent().data("Exist", false);
                    $(this.UserListPanel).find("input:checkbox[id='c_" + Obj + "']").prop("checked", false).parent().data("Exist", false);
                    delete this.Units[Obj];
                }
            }
            else if (Obj.constructor == Array) {
                for (var i = 0; i < Obj.length; i++) {
                    if (Obj[i].constructor == String) {

                        var unitId = Obj[i];
                        if (this.Editable) {
                            $(this.Element).find("#" + this.Units[unitId].ChoiceID).remove();
                        }
                        else {
                            this.$Input.text("");
                        }
                        $(this.DepsDataPanel).find("input:checkbox[id='c_" + unitId + "']").prop("checked", false).parent().data("Exist", false);
                        $(this.UserListPanel).find("input:checkbox[id='c_" + unitId + "']").prop("checked", false).parent().data("Exist", false);
                        delete this.Units[unitId];
                    }
                }
            }
            this.Validate();
            this.OnChange(Obj);
        },

        //判断是存在选项
        ExistChoice: function (UnitID) {
            if (this.Units[UnitID])
                return true;
            else
                return false;
        },

        //加载类型
        LoadOrgByTabType: function (tabType) {
            switch (tabType) {
                case "tab_Deps":
                    this.LoadDepsData();
                    break;
                case "tab_Users":
                    this.LoadUsersData();
                    break;
                case 'tab_RoleUsers':
                    this.SearchOrg();
                    break;
            }
        },

        //加载组织机构树
        LoadDepsData: function ($el, UnitID) {
            if (this.DepsDataPanel.data("IsLoad")) return;
            this.DepsDataPanel.data("IsLoad", true)
            this.DepsDataPanel.html("");
            this.LoadUnitsTree(this.DepsDataPanel, "tab_Deps");
        },

        //加载部门树
        LoadUnitsTree: function ($panel, tabType) {

            var that = this;
            var isDeps = false;
            //是部门页签，可以选择部门
            if (tabType && tabType == "tab_Deps") {
                isDeps = true;
            }

            if (!$.isEmptyObject(that.MultiUserData.OrgUnitItems)) {
                var $ul = $("<ul class='nav'>");//.addClass("nav");
                var root = that.GetUnitsByParentId(that.MultiUserData.OrgUnitItems[0].ParentId);
                //$ul.append(that.CreateUnitsItem(root[0], isDeps));
                for (var i = 0; i < root.length; i++) {
                    $ul.append(that.CreateUnitsItem(root[i], isDeps));
                }
                $panel.append($ul);
                //设置树的展开关闭
                if ($ul.metisMenu)
                    $ul.metisMenu();
                $ul.find("a:first,a:first>span.icon-xiangyou").data("IsSystem", true).click();
            }
            else {
                var actionCommand = "LoadUnit";
                if (that.UnitSelectionRange) {
                    //如果设置了选人范围则调用
                    actionCommand = "LoadOwnAndChildUnit";
                }

                //更改选人控件范围
                that.UpdateUnitSelectionRange.apply(that);

                var params = { pid: '0' };
                this.Ajax(
                    '/ctg-workflow/organ/childList',
                    "POST",
                    params,
                    function (data) {
                        that.MultiUserData.OrgUnitItems = data.page.result;
                        if (data.page.result.length == 0) {
                            return;
                        }
                        that.LoadUnitsTree($panel, tabType);
                    });
            }
        },

        //校验
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            if ($.isEmptyObject(val)) {
                //为空时添加
                if (this.IsQueryControl && this.UnitsElement.find(".sp_placeholder").length == 0) {
                    this.UnitsElement.append(this.$tipDiv);
                    this.UnitsElement.removeClass("icon-arrow-down-full").css("border", "1px dashed #D7D5D5");

                }
                if (this.Required) {
                    this.AddInvalidText(this.UnitsElement, "必填");
                    return false;
                }
            }

            this.RemoveInvalidText(this.UnitsElement);

            if (this.IsQueryControl) {
                this.UnitsElement.removeClass("icon-arrow-down-full").css("border", "1px dashed #D7D5D5");
            }
            return true;
        },

        //创建部门的<li>对象
        CreateUnitsItem: function (UnitItem, isDeps) {
            var that = this;

            var $li = $("<li>");
            var $a = $("<a>");
            if (UnitItem.HasChild) {
                $a.append("<span class='fa icon-xiangyou sheet-angel'></span>");
            }
            else {
                $a.append("<span class='fa icon-xiangyou sheet-angel no-child'></span>");
            }
            var icon = "icon-xiashuguanli";
            if (UnitItem.Type == 1) {
                //公司
                icon = "icon-gongsi";
            } else if (UnitItem.Type == 8) {
                //角色
                if (isDeps) {
                    return;
                }
                icon = "fa icon-man";
            } else {
                //其他
                icon = "icon-xiashuguanli";
            }
            $a.append("<i class='" + icon + "'></i>").append(UnitItem.name).data("UnitItem", UnitItem);
            //.data("id", UnitItem.ID).data("Code", UnitItem.Code).data("name", UnitItem.name).attr("data-Type", UnitItem.Type);
            if (isDeps) {
                $li.addClass("SheetUser-LiItem");
                var $checkbox = $("<input type='checkbox' id='c_" + UnitItem.id + "'/>");
                var $checkboxLabel = $("<label for='c_" + UnitItem.id + "'></label>");
                //如果是部门tab的话，炫耀可选
                //var $stateIcon = $("<i class='glyphicon'></i>").attr("data-id", UnitItem.id).attr("data-Type", UnitItem.Type);
                //$a.append($stateIcon);
                $a.append($checkbox).append($checkboxLabel);

                $a.find("label,input").click(function (e) {
                    e.preventDefault();
                });

                $a.click(function (e) {

                    if (e.target.tagName.toLowerCase() == "span") return;
                    if ($(this).data("IsSystem")) {
                        $(this).data("IsSystem", false)
                        return;
                    }
                    var UnitObject = $(this).data("UnitItem");
                    if ($(this).data("Exist")) {
                        that.RemoveChoice.apply(that, [UnitObject.id]);
                        //$(this).find("i:last").removeClass("glyphicon-ok");
                        $(this).find("input:checkbox").prop("checked", false);
                        $(this).data("Exist", false);
                    }
                    else {
                        //$(this).find("i:last").addClass("glyphicon-ok");
                        $(this).find("input:checkbox").prop("checked", true);
                        $(this).data("Exist", true);
                        //that.AddChoice.apply(that, [UnitObject]);
                        that.SetValue.apply(that, [UnitObject]);
                    }
                    ////
                    //var $this = $(this).closest("div.SheetUser");
                    that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                });
            }
            else {
                $a.click(function (e) {

                    //if (e.target.tagName.toLowerCase() == "span") return;
                    var UnitObject = $(this).data("UnitItem");
                    that.LoadUsersByParenID.apply(that, [UnitObject.id], that.ShowUnActive);
                });
            }

            $li.append($a);
            if (UnitItem.HasChild) {
                $a.children(".sheet-angel").click(function (e) {
                    var pthat = this;
                    if ($(this).closest("li").hasClass("active")) {
                        $(this).removeClass("icon-chevron-down-fill").addClass("icon-xiangyou");

                        $(this).closest("li").removeClass("active");
                        $(this).closest("li").find("ul").hide();
                    }
                    else {
                        $(this).closest("li").find("ul").remove();
                        var children = that.GetUnitsByParentId(UnitItem.id);
                        if (children.length > 0) {
                            var $ul = $("<ul class='nav SheetUser_SubTreePanel'>");//.addClass("nav SheetUser_SubTreePanel");
                            for (var i = 0; i < children.length; i++) {
                                $ul.append(that.CreateUnitsItem(children[i], isDeps));
                            }
                            $(this).closest("li").append($ul);
                            if ($ul.metisMenu)
                                $ul.metisMenu();

                            setTimeout(function () {
                                if ($(pthat).closest("li").hasClass("active")) {
                                    $(pthat).removeClass("icon-xiangyou").addClass("icon-chevron-down-fill");
                                } else {
                                    $(pthat).removeClass("icon-chevron-down-fill").addClass("icon-xiangyou");
                                }
                            }, 100);

                        }
                    }
                });
            }
            return $li;
        },

        //根据父ID获取子部门
        GetUnitsByParentId: function (parentId) {
            var that = this;
            var units = [];
            for (var i = 0; i < that.MultiUserData.OrgUnitItems.length; i++) {
                if (that.MultiUserData.OrgUnitItems[i].ParentId == parentId) {
                    units.push(that.MultiUserData.OrgUnitItems[i]);
                }
            }
            // 从后台读取下级部门
            if (units.length == 0) {
                var actionCommand = "LoadUnit";
                //if (that.UnitSelectionRange) {
                //    //如果设置了选人范围则调用下面
                //    actionCommand = "LoadOwnAndChildUnit";//如果设置了选人范围则加载制定组织和其下级
                //}
                var params = {
                    // ActionName: "SheetUserAction",
                    // Command: actionCommand,
                    pid: parentId
                }
                this.Ajax(
                    '/ctg-workflow/organ/childList',
                    "POST",
                    params,
                    function (data) {
                        if (data.page.result.length > 0) {
                            for (var i = 0; i < data.page.result.length; i++) {
                                that.MultiUserData.OrgUnitItems.push(data.page.result[i]);
                                units.push(data.page.result[i]);
                            }
                        }
                    }, false);
            }
            return units;
        },

        //加载用户数据
        LoadUsersData: function () {
            var that = this;
            if (that.UsersDataPanel.data("IsLoad")) return;
            that.UsersDataPanel.data("IsLoad", true).css("overflow", "hidden");
            var leftPanel = $("<div class='SheetUser_TreePanel col-sm-7 cols-xs-7'>")/*.addClass("SheetUser_TreePanel col-sm-7")*/.height("100%");
            that.UserListPanel = $("<div class='col-sm-5  cols-xs-7'>")/*.addClass("col-sm-5")*/.height("100%").css("overflow", "auto");
            //var SplitLine = $("<div style='float:left;min-height:80px;max-height:125px;width:0px;border:1px solid #D8D8D8'></div>");
            that.UsersDataPanel.html("");
            that.UsersDataPanel.append(leftPanel);
            that.UsersDataPanel.append(that.UserListPanel);
            that.LoadUnitsTree(leftPanel);
        },
        // 人员多选
        LoadUsersByParenID: function (parentID) {
            var that = this;

            if (!that.MultiUserData.DepUserItems[parentID]) {
                var showUnActive = this.ShowUnActive;
                var params = {
                    unitSelectionRange: this.UnitSelectionRange,
                    organId: parentID,
                    pageSize: 10000000
                }
                this.Ajax(
                    '/ctg-workflow/user/pageList',
                    "POST",
                    params,
                    function (data) {
                        that.MultiUserData.DepUserItems[parentID] = data.page.result;
                        that.LoadUsersByParenID.apply(that, [parentID]);

                        //异步添加用户数据
                        setTimeout(function () {
                            that.AddUserData(data.page.result);
                        }, 0);
                    });
            }
            else {
                var $ul = $("<ul>").addClass("nav").data("ParentID", parentID);
                var Length = that.MultiUserData.DepUserItems[parentID].length;
                var SelectCount = 0;
                // todo by xiechang 增加全选框
                if (that.IsMultiple && Length > 0) {
                    var $liAll = $('<li class="SheetUser-LiItem"></li>');
                    var $aall = $("<a class='allcheck'>全选</a>");
                    var $allCheckInput = $('<input type="checkbox" id="all' + that.ID + '"/>');
                    var $allCheck = $('<label for="all' + that.ID + '" class="label-all"></label>');
                    $liAll.append($aall.append($allCheckInput).append($allCheck));
                    $allCheck.data("ParentID", parentID);
                    $allCheck.click(function (e) {
                        var ListItem = that.MultiUserData.DepUserItems[$(this).data("ParentID")];
                        var addItems = [];
                        var removeItems = [];
                        var val = !that.$UserPanel.find("#" + $(this).attr("for"))[0].checked;
                        for (var i = 0, len = ListItem.length; i < len; i++) {
                            var item = ListItem[i];
                            if (val) {
                                if (!that.ExistChoice(item.id)) {
                                    //that.AddChoice.apply(that, [item]);
                                    //that.SetValue.apply(that, [item]);
                                    addItems.push(item);
                                }
                                continue;
                            } else {
                                if (that.ExistChoice(item.id)) {
                                    //that.RemoveChoice.apply(that, [item.id]);
                                    removeItems.push(item.id);
                                }
                                continue;
                            }
                        }
                        //批量操作只需要执行一次onchange事件
                        if (addItems.length > 0) {
                            that.SetValue.apply(that, [addItems]);
                        }
                        if (removeItems.length > 0) {
                            that.RemoveChoice.apply(that, [removeItems]);
                        }

                        var $ParUl = $(this).closest("ul.nav");
                        val ? $ParUl.data("SelectCount", len) : $ParUl.data("SelectCount", 0);
                        $ParUl.find("a:not(.allcheck)").each(function () {
                            $(this).data("Exist", val);
                            val ? $(this).find("input:checkbox").prop("checked", true) : $(this).find("input:checkbox").prop("checked", false);
                        });
                        //var $this = $(this).closest("div.SheetUser");
                        that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                    });
                    $ul.append($liAll);
                }
                for (var i = 0; i < Length; i++) {
                    var UnitItem = that.MultiUserData.DepUserItems[parentID][i];
                    var $li = $("<li>").addClass("SheetUser-LiItem");
                    var $checkbox = $('<input type="checkbox" id="c_' + UnitItem.id + '"/> <label for="c_' + UnitItem.id + '"></label>');
                    var icon = UnitItem.Type == 1 ? "fa icon-gongsi" : (UnitItem.Type == 2 ? "icon-xiashuguanli" : UnitItem.Icon);
                    var $a = $("<a>").append($checkbox).append("<i class='glyphicon " + (UnitItem.Icon == "glyphicon-user" ? "icon-people" : UnitItem.Icon) + "'></i>").data("UnitItem", UnitItem);
                    //.data("id", UnitItem.ID).data("Code", UnitItem.Code).data("name", UnitItem.name);
                    var checkboxID = $.IGuid();
                    //var $label = $("<label>").text(UnitItem.name);
                    var $stateIcon = $("<i class='glyphicon'></i>").attr("data-id", UnitItem.id).attr("data-Type", UnitItem.Type);
                    //$a.append($label);
                    $a.append(UnitItem.userName);
                    $a.append($stateIcon);
                    if (that.ExistChoice(UnitItem.id)) {
                        //$stateIcon.addClass("glyphicon-ok");
                        $($checkbox).prop("checked", true);
                        $a.data("Exist", true);
                        SelectCount++;
                    }
                    $a.find("label,input").click(function (e) {
                        e.preventDefault();
                    });

                    $a.click(function (e) {
                        var UnitObject = $(this).data("UnitItem");
                        var $ParUl = $(this).closest(".nav");
                        var Count = $ParUl.data("SelectCount");
                        if ($(this).data("Exist")) {
                            that.RemoveChoice.apply(that, [UnitObject.id]);
                            $(this).find("input:checkbox").prop("checked", false);
                            //$(this).find("i:last").removeClass("glyphicon-ok");
                            $(this).data("Exist", false);
                            Count--;
                        }
                        else {
                            //$(this).find("i:last").addClass("glyphicon-ok");
                            $(this).find("input:checkbox").prop("checked", true);
                            //that.AddChoice.apply(that, [UnitObject]);
                            that.SetValue.apply(that, [UnitObject]);
                            $(this).data("Exist", true);
                            Count++;
                        }
                        if (Count === that.MultiUserData.DepUserItems[$ParUl.data("ParentID")].length && that.IsMultiple) {
                            that.$UserPanel.find("#all" + that.ID)[0].checked = true;
                        }
                        else if (that.IsMultiple) {
                            that.$UserPanel.find("#all" + that.ID)[0].checked = false;
                        }
                        $ParUl.data("SelectCount", Count);
                        //var $this = $(this).closest("div.SheetUser");
                        that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));

                    });

                    $li.append($a);
                    $ul.append($li);
                }
                $ul.data("SelectCount", SelectCount);
                if (SelectCount === Length && SelectCount > 0 && that.IsMultiple) {
                    $ul.find("#all" + that.ID)[0].checked = true;
                }
                that.UserListPanel.html("").append($ul);
            }
        },

        ScrollLoad: function () {
            return;
            var that = this;
            if (that.IsPosting) {
                return;
            }
            //var searchkey = $(that.$Input).val().trim();
            var searchkey = $(that.$SearchInput).val().trim();
            that.IsPosting = true;
            var params = {
                ActionName: "SheetUserAction",
                Command: 'SearchOrg',
                SearchKey: searchkey,
                OrgUnitVisible: that.OrgUnitVisible,
                UserVisible: that.UserVisible,
                ShowUnActive: that.ShowUnActive,
                UnitSelectionRange: that.UnitSelectionRange,
                FromNum: that.FromNum,
                ToNum: that.ToNum
            }
            that.Ajax(that.FormMultiUserHandler, 'POST', {
                PostData: JSON.stringify(params)
            }, function (data) {
                if (data != null && data.ReturnData.UnitItems.length > 0) {
                    that.FromNum = that.ToNum;
                    that.ToNum += data.ReturnData.UnitItems.length;
                    var $ul = that.$SearchPanel.find('ul');
                    for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                        var UnitItem = data.ReturnData.UnitItems[i];
                        var $li = $("<li class='SheetUser-LiItem'>");
                        var icon = UnitItem.Type == 1 ? "fa icon-gongsi" : (UnitItem.Type == 2 ? "fa icon-xiashuguanli" : (UnitItem.Icon == "glyphicon-user" ? "ivu-icon ivu-icon-people" : UnitItem.Icon));
                        var displayName = UnitItem.DisplayName;
                        if (UnitItem.Type == 4) {
                            displayName += "-" + UnitItem.DepartmentName;
                        }
                        var $checkbox = $("<input type='checkbox' id='c" + UnitItem.UnitID + "'/>");
                        var $checkboxLabel = $("<label for='c" + UnitItem.UnitID + "'></label>");
                        var $stateIcon = $("<i class='glyphicon'></i>").attr("data-UnitID", UnitItem.UnitID).attr("data-Type", UnitItem.Type);
                        var $a = $("<a>").append($checkbox).append($checkboxLabel).append("<i class='glyphicon " + icon + "'></i>").append(displayName.replace(searchkey, "<span class='searchekey'>" + searchkey + "</span>")).append($stateIcon).data("UnitItem", UnitItem);

                        $a.find("input,label").click(function (e) {
                            e.preventDefault();
                        });

                        $a.click(function (e) {
                            var UnitObject = $(this).data("UnitItem");
                            var $pcheckbox = $(this).find("input:checkbox");
                            var checked = $pcheckbox.prop("checked");
                            if (checked) {
                                that.RemoveChoice.apply(that, [UnitObject]);
                                $pcheckbox.prop("checked", false);
                            } else {
                                //that.AddChoice.apply(that, [UnitObject]);
                                that.SetValue.apply(that, [UnitObject]);
                                $pcheckbox.prop("checked", true);
                            }
                            that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                        });
                        $ul.append($li.append($a));
                    }
                }
                that.IsPosting = false;
            });
        },
        convertUser(data) {
            var arrayUnit = [];
            data.userList.forEach(user => {
                arrayUnit.push({
                    "id": user.id,
                    "Code": null,
                    "DisplayName": user.userName,
                    "name": user.userName,
                    "ParentId": null,
                    "Type": 4, // 屏蔽
                    "Icon": null,
                    "DepartmentName": user.organName
                });
            });
            return arrayUnit;
        },
        convertOrgan(data) {
            var arrayUnit = [];
            data.organList.forEach(organ => {
                arrayUnit.push({
                    "id": organ.id,
                    "Code": null,
                    "DisplayName": organ.name,
                    "name": organ.name,
                    "ParentId": null,
                    "Type": 4, // 屏蔽
                    "Icon": null,
                    "DepartmentName": organ.parentName
                });
            });
            return arrayUnit;
        },
        //搜索用户
        SearchOrg: function () {

            var that = this;

            that.IsPosting = false;
            that.$SearchPanel.html("");

            if (that.CpLock)
                return;
            //var searchkey = $(that.$Input).val().trim();
            var searchkey = $(that.$SearchInput).val().trim();
            if (!that.UnitSelectionRange && searchkey == "") {
                that.SelectorPanel.show();
                that.$SearchPanel.hide();
                return;
            }
            that.SelectorPanel.hide();
            that.$SearchPanel.show();
            that.$SearchDiv.show();
            //this.$SearchPanel.html("");

            that.IsPosting = true;
            that.FromNum = 0;
            that.ToNum = 10;

            /* var params = {
                 ActionName: "SheetUserAction",
                 Command: "SearchOrg",
                 SearchKey: searchkey,
                 OrgUnitVisible: that.OrgUnitVisible,
                 UserVisible: that.UserVisible,
                 FromNum: that.FromNum,
                 ToNum: that.ToNum,
                 ShowUnActive: false,
                 UnitSelectionRange: that.UnitSelectionRange,
             };*/
            var params;
            var requestPromise;
            var searchPanelMessage = this.IsUser ? "没搜索到用户" : "没搜索到部门";
            // 查询部门
            if (this.IsUser) {
                params = {
                    userName: searchkey,
                    unitSelectionRange: this.UnitSelectionRange
                };
                requestPromise = userApi.searchUserByName(params)
            } else {
                params = {
                    organName: searchkey
                };
                requestPromise = organApi.searchOrganByName(params)
            }
            requestPromise.then(function (data) {
                //this.$SearchPanel.html("");
                data.ReturnData = {};
                data.ReturnData.UnitItems = that.IsUser ? that.convertUser(data) : that.convertOrgan(data);
                that.$SearchPanel.html("");
                if (data != null && data.ReturnData.UnitItems.length > 0) {
                    that.FromNum = that.ToNum + 1;
                    that.ToNum += data.ReturnData.UnitItems.length;
                    var $ul = $("<ul>").addClass("nav").addClass("SheetUser_SubTreePanel");
                    for (var i = 0; i < data.ReturnData.UnitItems.length; i++) {
                        var UnitItem = data.ReturnData.UnitItems[i];
                        var $li = $("<li class='SheetUser-LiItem'>");
                        var icon = UnitItem.Type == 1 ? "ivu-icon ivu-icon-ios-briefcase" : (UnitItem.Type == 2 ? "ivu-icon ivu-icon-person-stalker" : (UnitItem.Icon == "glyphicon-user" ? "icon-people" : UnitItem.Icon));
                        var displayName = UnitItem.DisplayName;
                        if (UnitItem.Type == 4 && that.IsUser) {
                            displayName += "-" + UnitItem.DepartmentName;
                        }
                        var $checkbox = $("<input type='checkbox' id='c" + UnitItem.UnitID + "'/>");
                        var $checkboxLabel = $("<label for='c" + UnitItem.UnitID + "'></label>");
                        var $stateIcon = $("<i class='glyphicon'></i>").attr("data-UnitID", UnitItem.UnitID).attr("data-Type", UnitItem.Type);
                        var $a = $("<a>").append($checkbox).append($checkboxLabel).append("<i class='glyphicon " + icon + "'></i>").append(displayName.replace(searchkey, "<span class='searchekey'>" + searchkey + "</span>")).append($stateIcon).data("UnitItem", UnitItem);

                        $a.find("input,label").click(function (e) {
                            e.preventDefault();
                        });
                        $a.click(function (e) {
                            //if (e.target.tagName.toLowerCase() == "span") return;
                            var UnitObject = $(this).data("UnitItem");
                            var $pcheckbox = $(this).find("input:checkbox");
                            var checked = $pcheckbox.prop("checked");
                            if (checked) {
                                that.RemoveChoice.apply(that, [UnitObject.UnitID]);
                                $pcheckbox.prop("checked", false);
                            } else {
                                //that.AddChoice.apply(that, [UnitObject]);
                                that.SetValue.apply(that, [UnitObject]);
                                $pcheckbox.prop("checked", true);
                            }
                            that.Options.HideCallBack && that.Options.HideCallBack(null, that.$InputBody.parent("div").attr("data-type"));
                            //that.$Input.val("");//移除搜索关键字
                            that.$SearchInput.val("");//移除搜索关键字
                        });
                        $ul.append($li.append($a));
                    }
                    that.IsPosting = false;
                    that.$SearchPanel.append($ul);
                    //滚动加载
                    $($ul).scroll(function () {
                        //底部基本距离+滚动高度>=文档高度-窗体高度
                        var h_ul = $(this).height();//窗口高度
                        var h_scrollTop = $(this).scrollTop();//滚动条顶部
                        var h_offset = $(this).offset();
                        var h_panel = $(that.$SearchPanel).height();
                        if (50 + h_scrollTop >= $(this)[0].scrollHeight - h_ul) {
                            that.ScrollLoad();
                        }
                    });
                }
                else {
                    that.$SearchPanel.html(searchPanelMessage);
                }
            });
        },

        //处理映射关系
        MappingControlsHandler: function (UnitObject) {
            if ($.isEmptyObject(this.MappingControls)) return;
            if (this.IsMultiple) return;

            for (var property in this.MappingControls) {
                if (this.MappingControls.hasOwnProperty(property)) {
                    var targetFiled = this.MappingControls[property];
                    var MapValue = UnitObject[property] == void 0 ? "" : UnitObject[property];
                    if (property.toLowerCase() == "gender") {
                        //性别
                        MapValue = MapValue == 0 ? "未知" : (MapValue == 1 ? "男" : "女");
                    }

                    // 由于Mvc的JsonResult的Date Format为 "\/Date()\/"
                    if (MapValue.indexOf("/Date(") > -1) {
                        MapValue = new Date(parseInt(MapValue.replace("/Date(", "").replace(")/", ""), 10));
                        MapValue = MapValue.toLocaleDateString();
                    }

                    $.ControlManager.SetControlValue(targetFiled, MapValue, this.ObjectId);
                }
            }
        },
        //更新选人范围
        UpdateUnitSelectionRange: function () {
            this.UnitSelectionRange = $(this.Element).attr("data-unitselectionrange");
            //计算控件中的选人范围
            var that = this;
            if (that.UnitSelectionRange && that.UnitSelectionRange.length > 0) {
                var SelectionRange = that.UnitSelectionRange;
                var selects = that.UnitSelectionRange.split(";");
                if (selects.length > 0) {
                    for (var i = 0; i < selects.length; i++) {
                        try {
                            var control = $("div[data-datafield=" + selects[i] + "]");
                            if (control.length > 0) {
                                var controlManager = control.JControl();
                                //列表筛选时取不到值
                                if (!controlManager) { continue; }
                                SelectionRange = selects[i] == SelectionRange ? "" : SelectionRange.replace(selects[i] + ";", "");
                                //添加change事件，控件值改变时，当前控件需要
                                //绑定改变值事件
                                var changeKey = "SelectionChangeMulti." + that.DataField;
                                if (!controlManager.ChangeEvents[changeKey]) {
                                    controlManager.BindChange(changeKey, function () {
                                        that.SetValue("");
                                        //清空控件缓存
                                        that.UsersDataPanel.data("IsLoad", false);
                                        that.DepsDataPanel.data("IsLoad", false);
                                        that.MultiUserData = {
                                            //部门
                                            OrgUnitItems: {},
                                            //标签
                                            //OrgTagItems: [],
                                            //部门用户:{部门ID:[]}
                                            DepUserItems: {},
                                            //用户
                                            UserItems: {},
                                        };
                                        that.Units = {};

                                        that.UnitSelectionRange = $(that.Element).attr("data-unitselectionrange");

                                        //重新渲染组织机构
                                        that.LoadOrgByTabType("tab_Users");
                                        that.LoadOrgByTabType("tab_Deps");
                                    });
                                }

                                var items = controlManager.GetValue();
                                if (items) {
                                    for (var id in items) {
                                        SelectionRange += items[id].UnitID + ";";
                                    }
                                }
                            }
                        } catch (error) {

                        }
                    }
                }

                that.UnitSelectionRange = SelectionRange;
            }
        }
    });
})(jQuery);;
/// <reference path="../../../plugins/qrCode/jquery.qrcode.min.js" />
/// <reference path="../../../jquery-1.11.1.min.js" />
//工具栏
//构造FormToolBar，需要根据表单数据，构造需要的按钮
(function () {
    $.fn.FormToolBar = function () {
        return $.ControlManager.Run.call(this, "FormToolBar", arguments);
    };

    $.Controls.FormToolBar = function (element, args, sheetInfo) {
        this.Element = element;
        this.ResponseContext = sheetInfo;
        this.ControlManagers = {};

        //更多按钮取除关闭以外的后三个，如果加入更多按钮以后按钮个数小于7个,取出更多里面的按钮补充到7个
        //二维码按妞不放置到更多里，因为放到更多里时二维位置码显示错乱
        var moreActionNums = 0;
        if (args.DataItem.length > 7) {
            this.MoreActions = [];
            moreActionNums = args.DataItem.length - 6;
            if (moreActionNums < 2) { return; }

            for (var n = args.DataItem.length - 1; n--; n >= 0) {
                if (args.DataItem[n].Action != "Close" && args.DataItem[n].Action != "ViewQrCode") {
                    moreActionNums--;
                    this.MoreActions.push(args.DataItem[n]);
                    if (moreActionNums == 0) {
                        break;
                    }
                }
            }
            //如果更多按钮只有一个，则不显示更多
            if (this.MoreActions && this.MoreActions.length > 0 && this.MoreActions.length == 1) {
                this.MoreActions = [];
            } else {
                for (var i in args) {
                    if ($.inArray(args[i], this.MoreActions) > -1) {
                        delete args[i];
                    }
                }
            }
        }

        for (var i in args) {
            this.AddButton(args[i]);
        }
        //添加“全屏”按钮
        //this.AddButton({ Action: 'FullScreen', Icon: 'icon-save', Text: '全屏' });

        $(this.Element).find("li").hover(function () {
            $(this).addClass("active");
        }, function () {
            $(this).removeClass("active");
        });
        return this;
    };

    $.Controls.FormToolBar.prototype = {
        AddButton: function (option) {
            if (option) {
                if (option.Action == "Close" && this.MoreActions && this.MoreActions.length > 0) {
                    //在关闭按钮前添加更多按钮
                    var moreButton = { Action: "More", Text: "更多", Icon: "icon-more-big ", Options: {} };
                    //
                    this.MoreActions = this.MoreActions.reverse();
                    moreButton.Options.Buttons = this.MoreActions;
                    moreButton.Options.ControlManagers = this.ControlManagers;
                    this.AddButton(moreButton);
                }
                var key = option.Action || option.Text;
                if (key == void 0) return;
                if (this.ControlManagers[key]) return this.ControlManagers[key];
                if ($.Buttons[option.Action]) {
                    this.ControlManagers[option.Action] = new $.Buttons[option.Action](this.Element, option, this.ResponseContext);
                } else {
                    this.ControlManagers[key] = new $.Buttons.BaseButton(this.Element, option, this.ResponseContext);
                }
            }
        }
    };
})(jQuery);

//#region 按钮基类
$.Buttons = {};
$.Buttons.BaseButton = function (element, args, sheetInfo) {

    this.Action = args.Action;
    this.Icon = args.Icon;
    this.Text = args.Text;

    //设置文本样式
    this.CssClass = args.CssClass || "";

    this.Container = element;//按钮容器ul
    this.ResponseContext = sheetInfo;
    this.Element = null;//当前按钮元素 li

    //绑定的参数
    this.Options = args.Options;

    //this.PermittedActions = sheetInfo.PermittedActions;
    this.Visible = true;//this.PermittedActions[this.Action] == void 0 ? true : this.PermittedActions[this.Action];
    this.MobileVisible = true;//args.MobileVisible === void 0 ? this.Visible : args.MobileVisible;

    //自定义事件
    this.OnActionPreDo = args.OnActionPreDo;
    this.OnAction = args.OnAction;
    //this.OnActionDone = args.OnActionDone;


    //执行事件
    this.PreRender();
    this.Render();
};
$.Buttons.BaseButton.prototype = {
    PreRender: function () {
    },
    Render: function () {
        var actionKey = this.Action || this.Text;
        if (!this.Visible) {
            $(this.Container).children("li[data-action='" + actionKey + "']").hide();
            return;
        }
        this.Element = $(this.Container).children("li[data-action='" + actionKey + "']");
        if (this.Element.length == 0) {
            if (this.Action == "Submit" || this.Action == "SubmitAndAdd") {
                this.Icon = "icon-submit";
            } else if (this.Action == "Print") {
                this.Icon = "icon-popup_print";
            } else if (this.Action == "Save" || this.Action == "Modify") {
                this.Icon = "icon-baocun";
            } else if (this.Action == "ViewQrCode") {
                this.Icon = "icon-erweima";
            } else if (this.Action == "Remove") {
                this.Icon = "icon-delete2";
            }
            this.Element = this._CreateButtonElement(this.Action, this.Icon, this.Text);
            $(this.Container).append(this.Element);
        }
        this.BindClick();
    },
    BindClick: function () {
        var actionKey = this.Action || this.Text;
        this.Element.unbind("click." + actionKey).bind("click." + actionKey, this, function (e) {
            e.data.ActionClick.apply(e.data);
        });

        //鼠标移入控件时触发click事件
        if (actionKey == "ViewQrCode" || actionKey == "More") {
            this.Element.off("mouseenter.tooltip").on("mouseenter.tooltip", this, function (e) {
                e.data.ActionClick.apply(e.data);
            });
        } else {
            this.Element.off("mouseenter.tooltip").on("mouseenter.tooltip", this, function (e) {
                if ($(this).parents("ul#action_more").length == 0) {
                    $("#dvQrCode").parent().hide();
                    $("#action_more").parent().hide();
                }
            });
        }

        if (actionKey == "Print" && this.PrintActions.length) {
            this.Element.off("mouseenter.tooltip").on("mouseenter.tooltip", this, function (e) {
                e.data.ActionClick.apply(e.data);
            });
        }
    },
    _CreateButtonElement: function (action, icon, text) {
        var liElement = $("<li data-action='" + this.Action + "'></li>");
        var linkElement = $("<a href='javascript:void(0);'></a>");
        var spanElement = $("<span class='fa " + this.Icon + "'>  " + this.Text + "</span>");
        if (this.CssClass) {
            spanElement.addClass(this.CssClass);
        }

        return liElement.append(linkElement.append(spanElement));
    },
    ActionClick: function () {
        //doAction之前的事件
        var callResult = true;
        if ($.isFunction(this.OnActionPreDo)) {//javascript函数
            callResult = this.OnActionPreDo.apply(this);
        }
        else if (this.OnActionPreDo) {//javascript语句
            callResult = new Function(this.OnActionPreDo).apply(this);
        }
        //结果成功
        if (callResult == null || callResult == true) {
            //执行后台Action
            this.DoAction.apply(this);
        }

        //回调里处理
        //if (this.OnActionDone) {
        //    this.OnActionDone.apply(this);
        //}
    },
    //执行
    DoAction: function () {
        //继承的按钮，如果需要掉基类的DoAction，用 this.constructor.Base.DoAction.apply(this);
        if (this.OnAction) {
            this.OnAction.apply(this);
        } else {
            if (this.Action) {
                $.SmartForm.OnAction(this);
            }
        }
    },

    ////回调函数
    //OnActionDone: function () { },

    FetchUser: function (_Title, _IsMulti, _UserOptions, _CheckText, _Checked) {
        var that = this;
        if (!this.SheetUserInited) {
            this.SheetUserInited = true;

            //选人控件
            var DefaultOptions = {
                O: "VE",
                L: _IsMulti ? $.SmartForm.LogicType.MultiParticipant : $.SmartForm.LogicType.SingleParticipant
            };
            if (_UserOptions) {
                $.extend(DefaultOptions, _UserOptions)
            }
            var _SheetUser = $("<div>").FormUser(DefaultOptions);
            //复选框
            var chkListenConstancy = null;

            if (_CheckText) {
                var ckid = $.IGuid();
                chkListenConstancy = $("<input type='checkbox' id='" + ckid + "' />");
                //默认选中
                chkListenConstancy.prop("checked", !!_Checked);
                var labelForCheckbox = $("<label for='" + ckid + "'>" + _CheckText + "</label>")
                this.CheckText = chkListenConstancy;
            }

            if (this.ResponseContext.IsMobile) {
                this.FetchUserPanelID = $.uuid();
                //标题
                var _HeaderId = $.uuid();
                var _Header = $("<header>").attr("id", _HeaderId);
                _Header.html('<h1>' + _Title + '</h1><a class="button icon close" onclick="$.ui.goBack();"></a>')
                _Header.appendTo("#afui");

                //确定
                var _Button = $("<div>").text("确定").addClass("button").css("float", "right");
                _Button.appendTo(_Header);

                //弹出窗口
                var _SelectPanel = $("<div>").addClass("panel").attr("id", this.FetchUserPanelID).attr("data-header", _HeaderId)
                    .attr("data-transition", "slideUp")
                    .attr("data-title", _Title);
                _SelectPanel.appendTo("#content");

                $(_SheetUser.Element).appendTo(_SelectPanel);
                if (chkListenConstancy) {
                    $(_SheetUser.Element).after(chkListenConstancy);
                    labelForCheckbox.width("90%");
                    chkListenConstancy.after(labelForCheckbox);
                }

                _Button.click(function () {
                    that.Datas = [];
                    if (_SheetUser.GetValue()) {
                        that.Datas.push(_SheetUser.GetValue().toString());
                        if (chkListenConstancy) {
                            that.Datas.push(chkListenConstancy.prop("checked"));
                        }

                        $.SmartForm.OnAction(that);

                        $.ui.goBack();

                        setTimeout(function () {
                            $("#" + _HeaderId).remove();
                            $("#" + this.FetchUserPanelID).remove();
                        }, 1000)
                    }
                    else {
                        alert("请选择参与者");
                    }
                });
            }
            else {
                var body = $("<div><div>" + _Title + "</div></div>");
                body.css("min-height", 350).append(_SheetUser.Element);
                if (chkListenConstancy) {
                    $(_SheetUser.Element).after($("<div></div>").append(chkListenConstancy).append(labelForCheckbox));
                }

                this.ModalManager = new $.SheetModal(
                    _Title,
                    body,
                    [{
                        Text: "确定",
                        DoAction: function () {
                            var userid = thisFormUser.GetValue();
                            this.SheetAction.Datas = [];
                            if (userid) {
                                this.SheetAction.Datas.push(userid.toString());

                                if (this.ChecBoxOjb) {
                                    this.SheetAction.Datas.push(this.ChecBoxOjb.prop("checked"));
                                }

                                $.SmartForm.OnAction(this.SheetAction);
                                this.ModalManager.Hide();
                            }
                            else {
                                alert("请选择参与者!");
                            }
                        },
                        SheetUser: _SheetUser,
                        ChecBoxOjb: chkListenConstancy,
                        SheetAction: that
                    },
                    {
                        Text: "关闭",
                        DoAction: function () {
                            this.ModalManager.Hide();
                        }
                    }]
                );
            }
        }

        if (this.ResponseContext.IsMobile) {
            $.ui.loadContent("#" + this.FetchUserPanelID);
        }
        else {
            this.ModalManager.Show();
        }
    },
    GetMobileProxy: function (_thatAction) {
        return {
            text: _thatAction.Text,
            handler: function () {
                _thatAction.ActionClick();
            }
        }
    }
};
//#endregion

//#region 保存
$.Buttons.Save = function (element, option, sheetInfo) {
    return $.Buttons.Save.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Save.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        $.SmartForm.Save(this);
    }
});
//#endregion

//#region 修改
$.Buttons.Modify = function (element, option, sheetInfo) {
    return $.Buttons.Modify.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Modify.Inherit($.Buttons.BaseButton, {
    Render: function () {
        //if ($.SmartForm.ResponseContext.WorkItemType == $.SmartForm.WorkItemType.Fill)
        //    this.Text = "提交";
        //else if ($.SmartForm.ResponseContext.WorkItemType == $.SmartForm.WorkItemType.Approve)
        //    this.Text = "同意";
        if (!this.Visible) {
            var actionKey = this.Action || this.Text;
            $(this.Container).children("li[data-action='" + actionKey + "']").hide();
            return;
        }

        //if (this.ResponseContext.ApprovalListVisible) {
        //    this.Text = "同意";
        //}

        this.ModifyActivities = [];
        if (this.ResponseContext.ModifyActivities == null
            || this.ResponseContext.ModifyActivities == void 0
            || this.ResponseContext.ModifyActivities.length == 0) {

            //根据岗位提交
            if (this.ResponseContext.Posts) {
                for (var j = 0; j < this.ResponseContext.Posts.length; j++) {
                    this.ModifyActivities.push(
                        {
                            Action: this.Action + "&" + this.ResponseContext.Posts[j].Code,
                            Icon: this.Icon,
                            Text: this.Text + "-" + this.ResponseContext.Posts[j].Name,
                            OnAction: function () {
                                $.SmartForm.Modify(this, this.Text, "", this.Action.split("&")[1]);
                            },
                            MobileVisible: false
                        });
                }
            }
            //根据组提交
            if (this.ResponseContext.Groups) {
                for (var j = 0; j < this.ResponseContext.Groups.length; j++) {
                    this.ModifyActivities.push(
                        {
                            Action: this.Action + "&" + this.ResponseContext.Groups[j].Code,
                            Icon: this.Icon,
                            Text: this.Text + "-" + this.ResponseContext.Groups[j].Name,
                            OnAction: function () {
                                $.SmartForm.Modify(this, this.Text, "", null, this.Action.split("&")[1]);
                            },
                            MobileVisible: false
                        });
                }
            }
        }
        else {
            for (var i = 0; i < this.ResponseContext.ModifyActivities.length; ++i) {
                //直接提交
                this.ModifyActivities.push(
                    {
                        Action: this.ResponseContext.ModifyActivities[i].Code,
                        Text: this.Text + "-" + this.ResponseContext.ModifyActivities[i].Name,
                        OnAction: function () {
                            $.SmartForm.Modify(this, this.Text, this.Action);
                        },
                        MobileVisible: false
                    });
                //根据岗位提交
                if (this.ResponseContext.Posts) {
                    for (var j = 0; j < this.ResponseContext.Posts.length; j++) {
                        this.ModifyActivities.push(
                            {
                                Action: this.ResponseContext.ModifyActivities[i].Code + "&" + this.ResponseContext.Posts[j].Code,
                                Icon: this.Icon,
                                Text: this.Text + "-" + this.ResponseContext.ModifyActivities[i].Name + "-" + this.ResponseContext.Posts[j].Name,
                                OnAction: function () {
                                    $.SmartForm.Modify(this, this.Text, this.Action.split("&")[0], this.Action.split("&")[1]);
                                },
                                MobileVisible: false
                            });
                    }
                }
                //根据组提交
                if (this.ResponseContext.Groups) {
                    for (var j = 0; j < this.ResponseContext.Groups.length; j++) {
                        this.ModifyActivities.push(
                            {
                                Action: this.ResponseContext.ModifyActivities[i].Code + "&" + this.ResponseContext.Groups[j].Code,
                                Icon: this.Icon,
                                Text: this.Text + "-" + this.ResponseContext.ModifyActivities[i].Name + "-" + this.ResponseContext.Groups[j].Name,
                                OnAction: function () {
                                    $.SmartForm.Modify(this, this.Text, this.Action.split("&")[0], null, this.Action.split("&")[1]);
                                },
                                MobileVisible: false
                            });
                    }
                }
            }
        }

        if (this.ModifyActivities.length > 1) {
            this.constructor.Base.Render.apply(this);
            this.DropdownMenu = $("<ul class='dropdown-menu'></ul>");
            var Menus = this.DropdownMenu.SheetToolBar(this.ModifyActivities);

            if (this.IsMobile) {
                this.MobileActions = [];
                for (_Action in Menus.ControlManagers) {
                    var that = Menus.ControlManagers[_Action];
                    this.MobileActions.push(this.GetMobileProxy(that));
                };
            }

            $(this.Element).append(this.DropdownMenu);
            this.OnActionPreDo = null;
        }
        else if (this.ModifyActivities.length == 1) {
            this.Text = this.ModifyActivities[0].Text;
            this.constructor.Base.Render.apply(this);
        }
        else {
            this.constructor.Base.Render.apply(this);
        }
    },
    DoAction: function () {
        if (this.doingWork) {
            return;
        } else {
            this.doingWork = true;
        }

        if (this.ModifyActivities.length == 1) {
            this.ModifyActivities[0].OnAction.apply(this.ModifyActivities[0]);
            return;
        }

        if (this.DropdownMenu) {
            if (this.IsMobile) {
                $.ui.actionsheet(this.MobileActions);
            }
            else {
                if (this.DropdownMenu.is(":hidden"))
                    this.DropdownMenu.show();
                else
                    this.DropdownMenu.hide();
            }
        }
        else {
            $.SmartForm.Modify(this, this.Text);
        }
    },
    OnActionDone: function (data) {
        this.doingWork = false;
        return true;
    }
});
//#endregion

//保存并添加
$.Buttons.SubmitAndAdd = function (element, option, sheetInfo) {
    return $.Buttons.SubmitAndAdd.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.SubmitAndAdd.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        $.SmartForm.Submit(this);
    },
    OnActionDone: function (data) {
        if (data.Successful) {
            if (window.parent.$.ListView != null && $.isFunction(window.parent.$.ListView.RefreshView)) {
                window.parent.$.ListView.RefreshView();
            }
            var href = window.location.href;
            href = href.replace("&mid=", "&mid=" + Math.round(Math.random() * 100, 0));
            window.location.href = href;
        } else {
            if (data.Errors != void 0 && data.Errors.length > 0) {
                //$.IShowError('错误', );
                Message.error({
                    content: data.Errors[0],
                    duration: 3
                });
            }
            if (data.Infos != void 0 && data.Infos.length > 0) {
                //$.IShowError('提示', data.Infos[0]);
                Message.error({
                    content: data.Infos[0],
                    duration: 3
                });
            }
        }
        return false;
    }
});


//#region 流程状态
$.Buttons.ViewInstance = function (element, option, sheetInfo) {
    if (!sheetInfo.IsCreateMode)
        return $.Buttons.Reject.Base.constructor.call(this, element, option, sheetInfo);
    else {
        option.Text = "流程预览";
        return $.Buttons.ViewInstance.Base.constructor.call(this, element, option, sheetInfo);
    }
};
$.Buttons.ViewInstance.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        var url = "";
        if (!this.ResponseContext.IsCreateMode) {
            url = "/WorkFlowCenter/WorkFlowState/?BizObjectId=" + this.ResponseContext.BizObjectId + "&WorkItemID=" + this.ResponseContext.WorkItemId + "&WorkflowCode=" + this.ResponseContext.SchemaCode + "&WorkflowVersion=" + this.ResponseContext.WorkflowVersion + "&mystate=1";
            $.ISideModal.Show(url, "流程状态");
        } else {
            url = "/WorkFlowCenter/WorkFlowState/?BizObjectId=" + this.ResponseContext.BizObjectId + "&WorkItemID=" + this.ResponseContext.WorkItemId + "&WorkflowCode=" + this.ResponseContext.SchemaCode + "&WorkflowVersion=" + this.ResponseContext.WorkflowVersion + "&mystate=1";
            $.ISideModal.Show(url, "流程预览");
            //$.IModal("流程预览", url);
        }




        //window.location.href = url;
    }
});
//#endregion


//#region 取消
$.Buttons.CancelInstance = function (element, option, sheetInfo) {
    return $.Buttons.CancelInstance.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.CancelInstance.Inherit($.Buttons.BaseButton, {
    PreRender: function () {
        this.constructor.Base.PreRender();

        //this.OnActionPreDo = function () {
        //    return confirm("确定执行取消流程操作?");
        //};
    },
    DoAction: function () {
        var that = this;
        $.SmartForm.ConfirmAction("确定执行取消流程操作", function () {
            $.SmartForm.OnAction(that);
            $.SmartForm.ClosePage(this);
        });
    }
});
//#endregion

//#region 驳回
$.Buttons.Reject = function (element, option, sheetInfo) {

    return $.Buttons.Reject.Base.constructor.call(this, element, option, sheetInfo);

};
$.Buttons.Reject.Inherit($.Buttons.BaseButton, {
    Render: function () {
        if (!this.Visible) {
            var actionKey = this.Action || this.Text;
            $(this.Container).children("li[data-action='" + actionKey + "']").hide();
            return;
        }

        if (this.ResponseContext.ApprovalListVisible) {
            this.Text = "不同意";
        }

        var RejectActivities = [];
        if (this.ResponseContext.RejectActivities) {
            for (var i = 0; i < this.ResponseContext.RejectActivities.length; ++i) {
                RejectActivities.push(
                    {
                        Action: this.ResponseContext.RejectActivities[i].Code,
                        Icon: this.Icon,
                        Text: this.ResponseContext.RejectActivities[i].Name,
                        OnAction: function () {
                            $.SmartForm.Reject(this, this.Action);
                        },
                        MobileVisible: false
                    });
            }
        }
        if (RejectActivities.length > 0) {
            if (RejectActivities.length == 1) {
                //只有一个的时候
                this.Text = RejectActivities[0].Text;
                this.DestActivity = RejectActivities[0].Action;
                this.constructor.Base.Render.apply(this);
            } else {
                this.constructor.Base.Render.apply(this);
                this.DropdownMenu = $("<ul class='dropdown-menu'></ul>");
                var Menus = this.DropdownMenu.SheetToolBar(RejectActivities);
                if (this.IsMobile) {
                    this.MobileActions = [];
                    for (_Action in Menus.ControlManagers) {
                        var that = Menus.ControlManagers[_Action];
                        this.MobileActions.push(this.GetMobileProxy(that));
                    };
                }

                this.Element.append(this.DropdownMenu);
                this.OnActionPreDo = null;
            }
        }
        else {
            this.constructor.Base.Render.apply(this);
        }
    },
    DoAction: function () {
        if (this.doingWork) {
            return;
        } else {
            this.doingWork = true;
        }

        if (this.DropdownMenu) {
            if (this.DropdownMenu.is(":hidden"))
                this.DropdownMenu.show();
            else
                this.DropdownMenu.hide();
        }
        else if (this.DestActivity) {
            $.SmartForm.Reject(this, this.DestActivity);
        }
        else {
            $.SmartForm.Reject(this);
        }
    },
    OnActionDone: function (data) {
        this.doingWork = false;
        return true;
    }
});
//#endregion

//#region 提交
$.Buttons.Submit = function (element, option, sheetInfo) {

    return $.Buttons.Submit.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Submit.Inherit($.Buttons.BaseButton, {
    Render: function () {
        //if ($.SmartForm.ResponseContext.WorkItemType == $.SmartForm.WorkItemType.Fill)
        //    this.Text = "提交";
        //else if ($.SmartForm.ResponseContext.WorkItemType == $.SmartForm.WorkItemType.Approve)
        //    this.Text = "同意";
        if (!this.Visible) {
            var actionKey = this.Action || this.Text;
            $(this.Container).children("li[data-action='" + actionKey + "']").hide();
            return;
        }

        //if (this.ResponseContext.ApprovalListVisible) {
        //    this.Text = "同意";
        //}

        this.SubmitActivities = [];
        if (this.ResponseContext.SubmitActivities == null
            || this.ResponseContext.SubmitActivities == void 0
            || this.ResponseContext.SubmitActivities.length == 0) {

            //根据岗位提交
            if (this.ResponseContext.Posts) {
                for (var j = 0; j < this.ResponseContext.Posts.length; j++) {
                    this.SubmitActivities.push(
                        {
                            Action: this.Action + "&" + this.ResponseContext.Posts[j].Code,
                            Icon: this.Icon,
                            Text: this.Text + "-" + this.ResponseContext.Posts[j].Name,
                            OnAction: function () {
                                $.SmartForm.Submit(this, this.Text, "", this.Action.split("&")[1]);
                            },
                            MobileVisible: false
                        });
                }
            }
            //根据组提交
            if (this.ResponseContext.Groups) {
                for (var j = 0; j < this.ResponseContext.Groups.length; j++) {
                    this.SubmitActivities.push(
                        {
                            Action: this.Action + "&" + this.ResponseContext.Groups[j].Code,
                            Icon: this.Icon,
                            Text: this.Text + "-" + this.ResponseContext.Groups[j].Name,
                            OnAction: function () {
                                $.SmartForm.Submit(this, this.Text, "", null, this.Action.split("&")[1]);
                            },
                            MobileVisible: false
                        });
                }
            }
        }
        else {
            for (var i = 0; i < this.ResponseContext.SubmitActivities.length; ++i) {
                //直接提交
                this.SubmitActivities.push(
                    {
                        Action: this.ResponseContext.SubmitActivities[i].Code,
                        Text: this.Text + "-" + this.ResponseContext.SubmitActivities[i].Name,
                        OnAction: function () {
                            $.SmartForm.Submit(this, this.Text, this.Action);
                        },
                        MobileVisible: false
                    });
                //根据岗位提交
                if (this.ResponseContext.Posts) {
                    for (var j = 0; j < this.ResponseContext.Posts.length; j++) {
                        this.SubmitActivities.push(
                            {
                                Action: this.ResponseContext.SubmitActivities[i].Code + "&" + this.ResponseContext.Posts[j].Code,
                                Icon: this.Icon,
                                Text: this.Text + "-" + this.ResponseContext.SubmitActivities[i].Name + "-" + this.ResponseContext.Posts[j].Name,
                                OnAction: function () {
                                    $.SmartForm.Submit(this, this.Text, this.Action.split("&")[0], this.Action.split("&")[1]);
                                },
                                MobileVisible: false
                            });
                    }
                }
                //根据组提交
                if (this.ResponseContext.Groups) {
                    for (var j = 0; j < this.ResponseContext.Groups.length; j++) {
                        this.SubmitActivities.push(
                            {
                                Action: this.ResponseContext.SubmitActivities[i].Code + "&" + this.ResponseContext.Groups[j].Code,
                                Icon: this.Icon,
                                Text: this.Text + "-" + this.ResponseContext.SubmitActivities[i].Name + "-" + this.ResponseContext.Groups[j].Name,
                                OnAction: function () {
                                    $.SmartForm.Submit(this, this.Text, this.Action.split("&")[0], null, this.Action.split("&")[1]);
                                },
                                MobileVisible: false
                            });
                    }
                }
            }
        }

        if (this.SubmitActivities.length > 1) {
            this.constructor.Base.Render.apply(this);
            this.DropdownMenu = $("<ul class='dropdown-menu'></ul>");
            var Menus = this.DropdownMenu.SheetToolBar(this.SubmitActivities);

            if (this.IsMobile) {
                this.MobileActions = [];
                for (_Action in Menus.ControlManagers) {
                    var that = Menus.ControlManagers[_Action];
                    this.MobileActions.push(this.GetMobileProxy(that));
                };
            }

            $(this.Element).append(this.DropdownMenu);
            this.OnActionPreDo = null;
        }
        else if (this.SubmitActivities.length == 1) {
            this.Text = this.SubmitActivities[0].Text;
            this.constructor.Base.Render.apply(this);
        }
        else {
            this.constructor.Base.Render.apply(this);
        }
    },
    DoAction: function () {
        // if (this.doingWork) {
        //     return;
        // } else {
        //     this.doingWork = true;
        // }

        if (this.SubmitActivities.length == 1) {
            this.SubmitActivities[0].OnAction.apply(this.SubmitActivities[0]);
            return;
        }

        if (this.DropdownMenu) {
            if (this.IsMobile) {
                $.ui.actionsheet(this.MobileActions);
            }
            else {
                if (this.DropdownMenu.is(":hidden"))
                    this.DropdownMenu.show();
                else
                    this.DropdownMenu.hide();
            }
        }
        else {
            $.SmartForm.Submit(this, this.Text);
        }
    },
    OnActionDone: function (data) {
        this.doingWork = false;
        return true;
    }
});
//#endregion

//#region 编辑
$.Buttons.Edit = function (element, option, sheetInfo) {
    return $.Buttons.Edit.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Edit.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        //打开关联表单再“编辑”的时候，原来的url中已经有Mode，需要将原来的替换
        var oldUrl = window.location.href;
        var modeIndex = oldUrl.indexOf('&Mode');
        if (modeIndex > -1) {
            var p = oldUrl.indexOf('&', modeIndex + 1);
            var modeStr = oldUrl.substring(modeIndex, p);
            var newUrl = oldUrl.replace(modeStr, '&Mode=' + $.SmartForm.SmartFormMode.Edit);
            window.location = newUrl;
        } else {
            window.location = window.location + "&Mode=" + $.SmartForm.SmartFormMode.Edit;
        }
    }
});
//#endregion

//#region 结束流程
$.Buttons.FinishInstance = function (element, option, sheetInfo) {
    return $.Buttons.FinishInstance.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.FinishInstance.Inherit($.Buttons.BaseButton, {
    PreRender: function () {
        this.constructor.Base.PreRender();
        //this.OnActionPreDo = function () {
        //    return confirm("确定执行结束流程操作?");
        //}
    },
    DoAction: function () {
        $.SmartForm.ConfirmAction("确定执行结束流程操作", function () {
            $.SmartForm.FinishInstance(this);
        });
    }
});
//#endregion

//#region 关闭
$.Buttons.Close = function (element, option, sheetInfo) {
    return $.Buttons.Close.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Close.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        // View模式下，直接关闭表单
        if (this.ResponseContext.FormMode == $.SmartForm.SmartFormMode.View) {
            $.SmartForm.ClosePage(this);
        }
        else {
            var framename = window.frames.name;
            var id = name.substring(6, name.length);
            var IsChange = window.parent.$.ISideModal.CheckBodyIsChange(id);
            if (IsChange) {
                $.IConfirm("", "确定放弃保存?放弃后数据不会被保存！", function (isTrue) {
                    if (isTrue)
                        $.SmartForm.ClosePage(this);
                });
            } else {
                $.SmartForm.ClosePage(this);
            }
        }
    }
});
//#endregion

//#region 删除
$.Buttons.Remove = function (element, option, sheetInfo) {
    return $.Buttons.Remove.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Remove.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        $.SmartForm.Remove(this);
    }
});
//#endregion

//#region 打印
$.Buttons.Print = function (element, option, sheetInfo) {
    this.Printed = false;
    return $.Buttons.Print.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Print.Inherit($.Buttons.BaseButton, {
    PreRender: function () {
        var that = this;
        that.PrintActions = [];
        var SchemaCode = $.SmartForm.RequestParameters.SchemaCode;
        var paramData = {
            "ActionName": "GetPublishHeader",
            "SchemaCode": SchemaCode
        };
        // $.ajax({
        //     type: 'POST',
        //     url: '/Print/OnAction',
        //     data: { PostData: JSON.stringify(paramData) },
        //     success: function (data) {
        //         if (data.Successful) {
        //             if (data.ReturnData.Result && data.ReturnData.Result.length) {
        //                 that.PrintActions = data.ReturnData.Result;
        //             } else {
        //                 that.PrintActions = [];
        //             }
        //         }
        //     },
        //     dataType: 'json',
        //     async: false
        // });

        // setTimeout((data)=>{

        //     data={"Successful":true,"ErrorMessage":null,"Logined":true,"ReturnData":{"Result":null}}
        //     if (data.Successful) {
        //         if (data.ReturnData.Result && data.ReturnData.Result.length) {
        //             that.PrintActions = data.ReturnData.Result;
        //         } else {
        //             that.PrintActions = [];
        //         }
        //     }
        // },500)

    },
    DoAction: function (templateId) {
        // 如果有自定义打印表单URL，则转向自定义打印表单
        // 否则直接页面打印
        var defaultPrint = function () {
            if (this.ResponseContext.PrintUrl) {
                window.open(this.ResponseContext.PrintUrl);
            }
            else {
                //文本转图片
                var wordToImage = function (text) {
                    $('body').append('<canvas id="waterCanvas" width="200" height="100"></canvas>');
                    var c = document.getElementById('waterCanvas');
                    var ctx = c.getContext('2d');
                    ctx.font = '20px Verdana';
                    ctx.fillStyle = 'green';
                    ctx.fillText(text, 100, 50);
                    var image = c.toDataURL('image/png', 1);
                    $('#waterCanvas').remove();
                    return image;
                };
                //判断附件类型是否是图片
                var isImg = function (name) {
                    var fileName = name;
                    var fileType = "";
                    var imgTypeArr = ['.jpeg', '.jpg', '.png', '.gif', '.bmp'];
                    if (fileName.lastIndexOf(".") > 0) {
                        fileName = name.substring(0, name.lastIndexOf("."));
                        fileType = name.substring(name.lastIndexOf("."), name.length);
                        if (fileType)
                            fileType = fileType.toLowerCase();
                    }
                    return imgTypeArr.indexOf(fileType) > -1;//判断是否是图片
                };
                //重绘附件
                var redrawAttachment = function ($attachment) {
                    var attachments = [];
                    var $attachmentCtrl = $($attachment).FormAttachment();
                    var $attachmentValue = $attachmentCtrl.Value;
                    var attachmentCount = $attachmentValue ? $attachmentValue.length : 0;//附件数量
                    for (var j = 0; j < attachmentCount; j++) {
                        var attachmentName = $attachmentValue[j].Name;
                        var thumbnailUrl = $attachmentValue[j].ThumbnailUrl;
                        var $newAttachment = $('<div class="print-attachment"></div>');
                        if (thumbnailUrl != void 0 && thumbnailUrl != "") {
                            //是图片
                            //if (thumbnailUrl == null) {
                            //    thumbnailUrl = src = "../../../../Content/Images/ImgFailed.png";
                            //}
                            var $newImg = $('<img src="' + thumbnailUrl + '" height="100" />');
                            var indexOfPot = attachmentName.lastIndexOf('.');
                            attachmentName = attachmentName.slice(0, indexOfPot);
                            var $newImgTitle = $('<span>' + attachmentName + '</span>');
                            $newAttachment.append($newImg);
                            $newAttachment.append($newImgTitle);
                        } else {
                            var $newFile = $('<div>' + attachmentName + '</div>');
                            $newAttachment.append($newFile);
                        }
                        attachments.push($newAttachment);
                    }
                    return attachments;
                };
                //获取控件值
                var getControlValue = function (obj) {
                    var controlKey = $(obj).attr('data-controlkey');
                    var $control = $(obj).JControl();
                    if ($control == undefined && $(obj).hasClass('SerialNo')) {
                        return $(obj).text();
                    }
                    var controlVal = $control.GetValue();
                    var tempVal = controlVal;
                    switch (controlKey) {
                        case 'FormSeqNo':
                            controlVal = $control.Value;
                            break;
                        case 'FormLabel':
                            controlVal = $control.Value;
                            break;
                        case 'FormUser':
                            controlVal = '';
                            for (var key in tempVal) {
                                //controlVal += tempVal[key].Name;
                                controlVal = tempVal[key].DisplayName;
                            }
                            break;
                        case 'FormCheckbox':
                            controlVal = controlVal ? '是' : '否';
                            break;
                        case 'FormDropDownList':
                            if (!controlVal) {
                                controlVal = '';
                            }
                            break;
                        case 'FormMultiUser':
                            controlVal = '';
                            var count = 0;
                            for (var key in tempVal) {
                                //controlVal += tempVal[key].Name + ';';
                                if (count == 0) {
                                    count = 1;
                                    controlVal = tempVal[key].DisplayName;
                                } else {
                                    controlVal += ';' + tempVal[key].DisplayName;
                                }
                            }
                            break;
                        case 'FormMap':
                            controlVal = '';
                            var address = $.parseJSON(tempVal).Address;
                            controlVal = address;
                            break;
                        case 'FormQuery':
                        case 'FormMultiQuery':
                            controlVal = $control.GetText();
                            break;
                        case 'FormAreaSelect':
                            controlVal = $control.$Input ? $control.$Input.text() : "";
                            if (!controlVal) {
                                try {
                                    var val = JSON.parse($control.GetValue());
                                    controlVal = val.adname + ' ' + val.Detail;
                                } catch (e) {
                                    controlVal = $control.GetText();
                                }
                            }
                            break;
                        case 'FormAttachment':
                        case 'FormPhoto':
                            controlVal = $('<div>');
                            var $newAttachments = redrawAttachment(obj);
                            for (var mm = 0; mm < $newAttachments.length; mm++) {
                                if (controlKey === 'FormPhoto') {
                                    $newAttachments[mm].append(
                                        `<img src="${BASE_URL}${$control.Value[mm].Url}">`
                                    );
                                }
                                controlVal.append($newAttachments[mm]);
                            }
                            controlVal = $('<div>').append(controlVal);
                            controlVal = controlVal.html();
                            break;
                        //controlVal = $('<div>').append(controlVal);
                        //return $('<div>').append(controlVal).html();
                        default:
                            if (controlVal == void 0 || controlVal == null) {
                                controlVal = '';
                            }
                            break;
                    }
                    return controlVal;
                };
                //重绘子表
                var getGridViewTable = function (obj) {
                    var gridViewTable = '';
                    var columnCount = 6;//每行最多展示列数，如果超过此数则将余下列折行
                    var datafield = $(obj).attr('data-datafield');
                    //var gridViewTitle = $('[data-datafield="' + datafield + '"]>span').text();//标题
                    var gridViewTitle = $('[data-datafield="' + datafield + '"]').attr('data-displayname');//标题
                    //var $gridViewTb = $('[data-datafield="' + datafield + '"]>table');//table
                    var $gridViewTbTemp = $('[data-datafield="' + datafield + '"]').find('.table-body table');//table
                    var $newTablePanel = $('<div></div>');//newTable的容器
                    //去掉隐藏的列
                    var $gridViewTb = $($gridViewTbTemp).clone();
                    $gridViewTb.find('thead th').each(function (index, n) {
                        if ($(this).css('display') == 'none' || $(this).find("div").hasClass("SerialNo")) {
                            $(this).remove();
                        } else {
                            //判断是否有不打印的列
                            var datafield = $($(this).find('div')).attr('data-datafield');
                            if (datafield == undefined) {
                                $(this).remove();
                                return true;
                            }
                            var tdCtrl = $gridViewTb.find('tbody td').find('div[class*="sheet-control form-group"][data-datafield="' + datafield + '"]');
                            if (tdCtrl != void 0) {
                                if ($(tdCtrl).attr('data-printable') != void 0 && $(tdCtrl).attr('data-printable') == 'false') {
                                    $(this).remove();
                                }
                            }
                        }
                    });
                    var $gridViewThead = $gridViewTb.find('thead');
                    //暂存状态移除子表最后按钮列
                    $gridViewThead.find('th').each(function () {
                        if ($(this).hasClass('form-gridview-col-btn')) {
                            $(this).remove();
                        }
                    });
                    var $gridViewTh = $gridViewTb.find('thead th:not(.SerialNo_th)');//子表列标题
                    var $gridViewTr = $gridViewTb.find('tbody>tr[data-objectid]');//子表行
                    //移除子表中不显示的列
                    $gridViewTr.find('td').each(function () {
                        if ($(this).css('display') == 'none' || $(this).find("div").hasClass("SerialNo")) {
                            $(this).remove();
                        }
                        else {
                            var datafield = $($(this).find('div')).attr('data-datafield');
                            if (datafield == undefined) {
                                $(this).remove();
                                return true;
                            }
                            var tdCtrl = $(this).find('div[class*="sheet-control form-group"]');
                            if (tdCtrl != void 0) {
                                if ($(tdCtrl).attr('data-printable') != void 0 && $(tdCtrl).attr('data-printable') == 'false') {
                                    $(this).remove();
                                }
                            }
                        }
                    });
                    var gridViewColumnCount = $gridViewTh.length;//子表列数
                    var newTableCount = Math.ceil(gridViewColumnCount / columnCount);//单个子表拆分的table个数
                    for (var t = 0; t < newTableCount; t++) {
                        var $newTable = $('<table style="width:100%;background-color:#f6f6f6" class="print-childTable">');
                        //table标题行，先取到合并的列数
                        var colspan = 1;
                        if (t == newTableCount - 1) {
                            //最后一个子表
                            colspan = gridViewColumnCount % columnCount == 0 ? columnCount : gridViewColumnCount % columnCount;
                        } else {
                            //非最后一个子表，列数为columnCount
                            colspan = columnCount;
                        }
                        //标题行
                        var $newTableTitle = $('<tr><td style="border:none" colspan="' + colspan + '" class="print-childTable-title" >' + gridViewTitle + '</td></tr>');
                        $newTable.append($newTableTitle);


                        //列头
                        var $newTableTh = $('<tr></tr>');
                        var width = 100 / colspan;
                        for (var j = 0; j < colspan; j++) {
                            $newTableTh.append($('<td style="border-left:none;width:' + width + '%"></td>').append($gridViewTh.eq(j + t * columnCount).find('div').text()));
                        }
                        $newTable.append($newTableTh);
                        //单元格
                        var startTdIndex = t * columnCount;//开始单元格
                        var endTdIndex = startTdIndex + colspan;//结束单元格
                        for (var k = 0; k < $gridViewTr.length; k++) {
                            //每一行
                            var $tr = $gridViewTr.eq(k);
                            var tr_objectId = $tr.attr('data-objectid');
                            var $newTableTr = $('<tr></tr>');
                            for (var l = startTdIndex; l < endTdIndex; l++) {
                                var $newTableTd = $('<td></td>');
                                if (l == startTdIndex) {
                                    $newTableTd.css('border-left', 'none');
                                }
                                //var $tdSheetCtrl = $('tr[data-objectid="' + tr_objectId + '"]>td').eq(l).find('.sheet-control');
                                //var $tdSheetCtrl = $tr.find('td').eq(l).find('.sheet-control');
                                var $tdSheetCtrl = $tr.children('td').eq(l).find('.sheet-control');
                                if ($tdSheetCtrl.length > 0) {
                                    $newTableTd.append(getControlValue($tdSheetCtrl));
                                    $newTableTr.append($newTableTd);
                                }
                            }
                            $newTable.append($newTableTr);
                        }
                        $newTablePanel.append($newTable);
                    }
                    gridViewTable = $newTablePanel.find('table');
                    return gridViewTable;
                };
                var agree = true;
                //获取审批记录
                var water = '';
                var getComment = function (obj) {
                    var commentInfo = [];
                    var $comment = $(obj);
                    if ($comment && $comment.length > 0) {
                        //var agree = true;
                        var $newCommentTable = $('<table  style="width:100%;table-layout:fixed">');
                        $comment.each(function () {
                            var $commentCtrl = $(this).FormComment();
                            var comments = $commentCtrl.GetCommentValue();
                            $newCommentTable.append('<tr><td rowspan="' + comments.length + 1 + '" style="text-align:center;" class="col-md-2 col-sm-2 col-xs-2">审批记录</td><td class="print-table-th">审批人</td><td class="print-table-th">审批节点</td><td class="print-table-th">审批结果</td><td class="print-table-th">审批意见</td><td class="print-table-th">审批时间</td></tr>');

                            for (var i = 0; i < comments.length; i++) {
                                if (i == comments.length - 1) {
                                    agree = comments[i].Approval;
                                }
                                var $newCommentTr = $('<tr>');
                                var date = comments[i].ModifiedTime.replace(/T/g, ' ');//审批时间
                                //兼容IE
                                date = date.replace(new RegExp(/-/gm), '/');
                                var newDate = new Date(date);
                                var t = newDate.getTime();
                                newDate = new Date(t);
                                var y = newDate.getFullYear();
                                var m = newDate.getMonth() + 1;
                                var d = newDate.getDate();
                                var h = newDate.getHours();
                                var mm = newDate.getMinutes();
                                var s = newDate.getSeconds();
                                newDate = y + '-' + (m < 10 ? ('0' + m) : m) + '-' + (d < 10 ? ('0' + d) : d) + ' ' + (h < 10 ? ('0' + h) : h) + ':' + (mm < 10 ? ('0' + mm) : mm);

                                var commentTd = '';

                                commentTd += '<td style="border-left:none;padding-left:6px" class="col-md-1 col-sm-1 col-xs-2"><span>' + comments[i].UserName + '</span></td>';
                                commentTd += '<td style="border-left:none;font-weight:bold" class="col-md-1 col-sm-1 col-xs-2">' + comments[i].ActivityDisplayName + '</td>';
                                commentTd += '<td style="border-left:none" class="col-md-1 col-sm-1 col-xs-1"><span>' + (comments[i].Approval ? "同意" : "不同意") + '</span></td>';
                                commentTd += '<td style="border-left:none" class="col-md-4 col-sm-4 col-xs-4"><span>' + comments[i].Text + '</span></td>';
                                commentTd += '<td style="border-left:none" class="col-md-2 col-sm-2 col-xs-2"><span>' + newDate + '</span></td>';
                                $newCommentTr.append(commentTd);
                                $newCommentTable.append($newCommentTr);
                            }
                        });
                        var $commentPanel = $('<div>').append($newCommentTable);
                    }
                    return $commentPanel.html();
                };
                //取页面内容
                var content = $('<div>').append($(window.document.body).children().clone());
                //移除页签
                content.find('nav').remove();
                content.find('.nav').remove();
                content.find('.nav-tabs-wrap').remove();
                content.find('script').remove();
                //移除drop-list
                content.find('.drop-list').remove();
                //页面标题
                //页面table
                var $newContent = $('<div>');//新的容器
                var $contentTable = $('<table class="print-table" style="table-layout:fixed">');
                //先判断是否有页签
                var rows = [];
                var tab = content.find('#SheetContent>.tab-content')
                if (tab && tab.length) {
                    //有页签
                    rows = tab.find('.tab-pane.active>div');
                    var comments = content.find('#SheetContent >[data-datafield="Comments"]');
                    rows.push(comments);
                } else {
                    rows = content.find('#SheetContent>div');
                    if (rows == undefined || rows.length == 0) {
                        var temp = content.find('#SheetContent>root>div');
                        if (temp && temp.length > 0) {
                            rows = temp;
                        }
                    }
                }
                //后台打印配置
                var printConfig = $.SmartForm.ResponseContext.PrintConfig;
                var printCompanyName = true;
                var printComment = true;
                var printPrinter = true
                var printPrintTime = true;
                var printQrCode = true;
                if (printConfig != undefined && !$.isEmptyObject(printConfig)) {
                    printCompanyName = printConfig.PrintCompanyName;
                    printComment = printConfig.PrintComment;
                    printPrinter = printConfig.Printer;
                    printPrintTime = printConfig.PrintTime;
                    printQrCode = printConfig.PrintQrCode;
                }
                var printFormApprovalRecordTitle = '';
                var tempRows = [];
                for (var i = 0; i < rows.length; i++) {
                    // 打印屏蔽列表查询
                    if (rows[i].getAttribute('data-controlkey') === 'FormList') continue;
                    var $row = $(rows[i]);
                    // 打印时展开收起需要特殊处理
                    if ($row.hasClass('expand-layout-row')) {
                        $row.find('.expand-layout-comps')[0].childNodes.forEach(item => {
                            tempRows.push(item.childNodes[0]);
                        });
                    } else {
                        tempRows.push(rows[i]);
                    }
                }
                rows = tempRows;
                for (var i = 0; i < rows.length; i++) {
                    var $row = $(rows[i]);
                    if ($row.css('display') == 'none') {
                        continue;
                    }
                    if ($row.attr('data-printable') != void 0 && $row.attr('data-printable') == "false") {
                        continue;
                    }
                    var $contentTableTr = $('<tr>');
                    if ($row.hasClass('sheet-control')) {
                        //控件
                        var controlKey = $row.attr('data-controlkey');
                        if (controlKey == 'FormGridView') {
                            //子表
                            var $contentTableTd = $('<td colspan="4" style="padding:0;height:auto!important;border-top:none;border-bottom:1px solid #fff;background-color:#f6f6f6!important;"></td>');
                            var $gridViewTable = getGridViewTable($row);
                            $contentTableTd.append($gridViewTable);
                            $contentTableTr.append($contentTableTd);
                        } else if (controlKey == 'FormComment') {
                            //审批
                            if (!printComment)
                                continue;
                            var commentInfo = getComment($row);
                            $contentTableTr.append('<td colspan="4" style="padding:0;" >' + commentInfo + '</td>');
                        } else if (controlKey == 'FormApprovalRecord') {
                            printFormApprovalRecordTitle = $row.attr('data-displayname')
                            continue;
                        } else {
                            //主表字段
                            var controlTitle = $row.find('.ControlTitle').text();
                            var controlValue = getControlValue($row);
                            $contentTableTr.append('<td class="col-sm-2 col-xs-2">' + controlTitle + '</td><td class="col-sm-10 col-xs-10" colspan="3">' + controlValue + '</td>');
                        }
                    } else if ($row.hasClass('page-header')) {
                        //标题、描述
                        //如果后续没有printable的控件则不要显示标题(描述要显示)
                        if (!$row.hasClass('page-describle')) {
                            var printableControl = 0;//可打印控件数量
                            for (var j = i + 1; j < rows.length; j++) {
                                var laterRow = $(rows[j]);
                                if (laterRow.hasClass('sheet-control')) {
                                    if (laterRow.attr('data-controlkey') == 'FormComment')
                                        continue;
                                    if (laterRow.attr('data-printable') != void 0 && laterRow.attr('data-printable') == 'false')
                                        continue;
                                }
                                if ($(rows[j]).attr('data-printable') != void 0 && $(rows[j]).attr('data-printable') == "false") {
                                    continue;
                                }
                                printableControl++;
                            }
                            //如果后续没有要打印的控件则不打印标题
                            if (printableControl == 0) {
                                continue;
                            }
                        }
                        var controlValue = $row.find('strong');
                        var align = $row.css('text-align');
                        //$contentTableTr.append('<td colspan="4" style="font-size:10px;color:#999">' + controlValue.html() + '</td>');
                        if ($row.hasClass('page-describle')) {
                            //描述
                            $contentTableTr.append('<td colspan = "4" style="font-size:10px;color:#999;text-align:' + align + '">' + controlValue.html() + '</td>');
                        } else {
                            //标题
                            $contentTableTr.append('<td colspan = "4" style="font-size:14px;color:#999;background-color:#f6f6f6!important;text-align:' + align + '">' + controlValue.html() + '</td>');
                        }
                    } else {
                        //一行两列
                        var emptyCtrlCount = 0;//记录不可见和不打印字段数量,如果两个字段都是不可见或不打印则不显示一行两列
                        $row.find('.col-sm-6').each(function () {
                            var controlTitle = $(this).find('.ControlTitle').text();
                            var $control = $(this).find('.row.sheet-control.form-group');
                            if ($control && $control.length > 0) {
                                if ($control.css('display') == 'none' || $control.attr('visible') == 'false') {
                                    //如果一行两列内字段不可见则增加一个空的td
                                    emptyCtrlCount++;
                                    $contentTableTr.append('<td class="col-sm-6 col-xs-6" colspan="2"></td>');
                                    return true;
                                } else {
                                    if ($control.attr('data-printable') != void 0 && $control.attr('data-printable') == "false") {
                                        emptyCtrlCount++;
                                        $contentTableTr.append('<td class="col-sm-6 col-xs-6" colspan="2"></td>');
                                        return true;
                                    }
                                }
                                var controlValue = getControlValue($control);
                                $contentTableTr.append('<td class="col-sm-2 col-xs-2">' + controlTitle + '</td><td class="col-sm-4 col-xs-4">' + controlValue + '</td>');
                            } else {
                                emptyCtrlCount++;
                            }
                        });
                        if (emptyCtrlCount == 2) {
                            continue;
                        }
                    }
                    $contentTable.append($contentTableTr);
                }

                //判断是不是流程表单,增加审批水印(是否打印水印与是否打印"审批意见"一致)
                var $waterMark = '';
                //var isWorkflow = this.ResponseContext.ReturnData.WorkflowInstanceId.Value;
                var isWorkflow = null;
                if (isWorkflow && printComment) {
                    switch ($.SmartForm.ResponseContext.WorkflowState) {
                        case 0:
                            break;
                        case 1:
                            break;
                        case 2://正在运行
                            //审批中
                            $waterMark = $('<div class="print-watermark"><img src="../../../../Content/Images/approve/runing.png" width="120" height="120"></div>');
                            break;
                        case 3://正在结束
                            break;
                        case 4://已完成
                            if (!agree) {
                                //审批不通过
                                $waterMark = $('<div class="print-watermark"><img src="../../../../Content/Images/approve/disagree.png" width="120" height="120"></div>');
                            } else {
                                //审批通过
                                $waterMark = $('<div class="print-watermark"><img src="../../../../Content/Images/approve/agree.png" width="120" height="120"></div>');
                            }
                            break;
                        case 5://已取消
                            //流程取消
                            $waterMark = $('<div class="print-watermark"><img src="../../../../Content/Images/approve/cancel.png" width="120" height="120"></div>');
                            break;
                        default:

                    }
                }
                $newContent.append($waterMark);
                var printer = '';//打印人
                var companyName = '';//企业名称
                var qrCodeUrl = '';//二维码地址
                if (printCompanyName || printPrinter || printQrCode) {
                    //获取打印的相关信息，包括打印人，企业名称，打印二维码需要的数据
                    var getQueryString = function (paramName) {
                        var reg = new RegExp("(^|&)" + paramName + "=([^&]*)(&|$)");
                        var r = window.location.search.substr(1).match(reg);
                        if (r != null) {
                            return unescape(r[2]);
                        }
                        return null;
                    };
                    var schemaCode = getQueryString("SchemaCode");
                    var bizObjectId = getQueryString("BizObjectId");
                    var appCode = '';//应用编码
                    var agentId = '';
                    var corpId = '';
                    var suiteKey = '';
                    var isTest = false;//是否是测试环境
                    var scanUrl = '';//考虑用于生成二维码的短地址，暂时没有使用
                    var hostAddress = '';
                    var appId = '';
                    var appName = '';
                    var startUser = '';
                    var actResult = '';
                    var status = '';
                    //取当前用户
                    var appRunId = document.querySelector('[data-action=Print]').AppRunId;
                    $.ajax({
                        type: 'POST',
                        url: BASE_URL + '/act/app/getPrintInfo',
                        data: { appRunId },
                        success: function (data) {
                            if (data.code === '0') {
                                printer = data.returnData.printer;
                                companyName = data.returnData.companyName;
                                appCode = data.returnData.AppCode;
                                agentId = data.returnData.AgentId;
                                corpId = data.returnData.CorpId;
                                suiteKey = data.returnData.SuiteKey;
                                hostAddress = data.returnData.hostAddress;
                                appId = data.returnData.appId;
                                appName = data.returnData.name;
                                startUser = data.returnData.startUser;
                                actResult = data.returnData.actResult;
                                status = data.returnData.status;
                            }
                        },
                        dataType: 'json',
                        async: false
                    });

                    // setTimeout((data)=>{
                    //     data ={"Successful":true,"ErrorMessage":null,"Logined":true,"ReturnData":{"UserName":"梦达","CompanyName":"穿云团队","AppCode":"A0bb3eb2b000e433bb8e7d0547b22a1a3","CorpId":"dingf59c7dec662ad6b335c2f4657eb6378f","SchemaCode":"mw56nnqfvo56ntlbpu4qmle46","MessageType":"InstanceFinished","AgentId":"178551340","SuiteKey":"suitefcoyqxthbd1xwjiu","HostAddress":"https://www.h3yun.com"}};
                    //     if (data.Successful) {
                    //                     printer = data.ReturnData.UserName;
                    //                     companyName = data.ReturnData.CompanyName;
                    //                     appCode = data.ReturnData.AppCode;
                    //                     agentId = data.ReturnData.AgentId;
                    //                     corpId = data.ReturnData.CorpId;
                    //                     suiteKey = data.ReturnData.SuiteKey;
                    //                     hostAddress = data.ReturnData.HostAddress;
                    //                 }
                    // },1000)
                    var sheetUrl = hostAddress + "/Mobile/?";
                    sheetUrl += 'CorpId=' + corpId + '&sc=' + schemaCode + '&bo=' + bizObjectId + '&mt=task';
                    if (suiteKey) {
                        sheetUrl += '&IsIsv=1&sk=' + suiteKey;
                    } else {
                        sheetUrl += '&ai=' + agentId;
                    }
                    // qrCodeUrl = sheetUrl;
                    qrCodeUrl = `${hostAddress}?appId=${appId}&appRunId=${appRunId}&name=${encodeURIComponent(appName)}&isDisplayMode=true&startUser=${startUser}&actResult=${actResult}&status=${status}&isCreateMode=false&from=qrCode&refresh=true`;
                }
                if (printCompanyName) {
                    //插入企业名称
                    $newContent.append('<div class="print-schema-title">' + companyName + '</div>');
                }
                //插入表单名称
                var schemaDisplayName = $.SmartForm.ResponseContext.DisplayName;
                var $displayName = $('<div class="print-schema-title">' + schemaDisplayName + '</div>');
                $newContent.append($displayName);
                //全局水印
                if (water) {
                    var $marker = $('<div id="mymasker" style="background-image:url(' + water + ')!important;"></div>');
                }
                //插入整体表格
                $newContent.append($contentTable);

                // 打印审批记录
                if (printFormApprovalRecordTitle || $('#print-approval-record-title').length) {
                    $newContent.append($('<p class="print-sub-title">' + (printFormApprovalRecordTitle || $('#print-approval-record-title').html()) + '</p>'));
                    var theadHTML = $('#print-approval-record-table').find('thead')[0].outerHTML;
                    var tbodyHTML = $('#print-approval-record-table').find('tbody')[0].outerHTML;
                    tbodyHTML = tbodyHTML.replace(/style="border-width: 1px; border-style: solid;"/g, '');
                    var tableHTML = '<table class="print-table">' + theadHTML + tbodyHTML + '</table>';
                    $newContent.append($(tableHTML));
                }

                //插入打印信息
                //打印人/打印时间
                if (printPrinter || printPrintTime || printQrCode) {
                    var printTime = '';
                    if (printPrintTime) {
                        //取打印时间
                        printTime = new Date().Format('yyyy-MM-dd hh:mm:ss');
                    }
                    //获取等分格
                    var showCount = 3;
                    if (!printPrinter) {
                        showCount--;
                    }
                    if (!printPrintTime) {
                        showCount--;
                    }
                    if (!printQrCode) {
                        showCount--;
                    }
                    var gridCol = 12 / showCount;

                    var printInfo = $('<div class="print-info container-fluid sheet_container" style="padding-left:0;padding-right:0;"></div>');
                    var printInfoRow = $('<div class="row sheet-control form-group"></div>');
                    if (printPrinter) {
                        printInfoRow.append('<div class="col-sm-' + gridCol + ' col-xs-' + gridCol + ' col-md-' + gridCol + '">打印人:' + printer + '</div>');
                    }
                    if (printTime) {
                        printInfoRow.append('<div class="col-sm-' + gridCol + ' col-xs-' + gridCol + ' col-md-' + gridCol + '">打印时间:' + printTime + '</div>');
                    }
                    if (printQrCode) {
                        printInfoRow.append('<div class="col-sm-' + gridCol + ' col-xs-' + gridCol + ' col-md-' + gridCol + '"><div id="printQrCode"></div><div><div style="text-align:center">请使用移动端扫码</div></div></div>');
                    }
                    printInfo.append(printInfoRow);

                    //if (printPrinter && printPrintTime) {
                    //    printInfo = $('<div class="print-info container-fluid sheet_container" style="padding-left:0;padding-right:0;"><div class="row sheet-control form-group"><div class="col-sm-3 col-xs-3 col-md-3">打印人:' + printer + '</div><div class="col-sm-4 col-xs-4 col-md-4">打印时间:' + printTime + '</div><div class="col-sm-5 col-xs-5 col-md-5"><div id="printQrCode" style="text-align:right"></div><div style="text-align:right"><div style="position:absolute;right:15px;width:160px;text-align:center">请使用钉钉扫码</div></div></div></div></div>');
                    //} else if (!printPrinter) {
                    //    printInfo = $('<div class="print-info container-fluid sheet_container" style="padding-left:0;padding-right:0;"><div class="row sheet-control form-group"><div class="col-sm-3 col-xs-3 col-md-3">打印时间:' + printTime + '</div><div class="col-sm-4 col-xs-4 col-md-4"></div></div></div>');
                    //}
                    $newContent.append(printInfo);
                }

                const isInDingTalk = window.DingTalkPC && window.DingTalkPC.ua.isDesktop && window.DingTalkPC.ua.isInDingTalk;

                Spin.show({
                    render: (h) => {
                        return h('div', [
                            h('Icon', {
                                style: `
                                    animation: ani-demo-spin 1s linear infinite;
                                    @keyframes ani-demo-spin {
                                    from { transform: rotate(0deg);}
                                    50%  { transform: rotate(180deg);}
                                    to   { transform: rotate(360deg);}
                                    }
                                `,
                                props: {
                                    type: 'load-c',
                                    size: 18
                                }
                            }),
                            h('div', isInDingTalk ? '正在准备用于打印的PDF文件' : '正在准备打印数据')
                        ]);
                    }
                });

                const printFrame = document.createElement('iframe');
                printFrame.style.width = isInDingTalk ? '800px' : '100%';
                printFrame.style.position = 'fixed';
                printFrame.style.top = 0;
                printFrame.style.left = 0;
                printFrame.style.zIndex = -1;
                printFrame.style.opacity = 0;
                document.body.appendChild(printFrame);
                const printWindow = printFrame.contentWindow;

                window.onmessage = event => {
                    if (event.data && event.data.ready === 0) {
                        Spin.hide();
                        setTimeout(() => {
                            printWindow.print();
                            document.body.removeChild(printFrame);
                        }, 0);
                    } else if (event.data && event.data.ready === 1) {
                        Spin.hide();
                    }
                };

                printWindow.document.open();

                // var printWindow = window.parent.open('/Form/Print/');
                printWindow.document.write('<link href="/dist/assets/bootstrap/bootstrap.min.css" rel="stylesheet">');
                printWindow.document.write('<link href="/dist/assets/print/print.css" rel="stylesheet">');
                printWindow.document.write('<style>@page{@bottom-left:{margin:10pt 0 30pt 0;border:.25pt solid;background-color:red}}</style>');
                printWindow.document.write('<script src="/dist/assets/print/qrcode.min.js"></script>');
                printWindow.document.write($newContent.html());
                printWindow.document.write('<body  scroll="no" style="font-size:12px"></body>');
                printWindow.document.write('<div></div>');
                printWindow.document.write('<title>打印</title>');
                // printWindow.document.write('<object id="WebBrowser" width=0 height=0 classid="CLSID:8856F961-340A-11D0-A96B-00C04FD705A2"></object>');

                //如果二维码参数不对不要生成二维码？
                if (printQrCode)
                    printWindow.document.write('<script>new QRCode(document.getElementById("printQrCode"), "' + qrCodeUrl + '");</script>');

                // printWindow.document.write('<script>setTimeout(function(){window.print();WebBrowser.ExecWB(7,1)},50)</script>');

                // //printWindow.print();
                // var userAgent = navigator.userAgent;
                // if (userAgent.indexOf('Firefox') > -1) {
                //     printWindow.print();
                // }
                //关闭打印页面（不管是点击“打印”还是“取消”，点击后2s自动关闭打印页面）
                //需要注意页面关闭后打印是否继续？如果window关闭了仍然可以打印则可以将关闭页面时间缩短
                // var close = '<script>setTimeout("window.close()",100)</script>';
                // printWindow.document.write(close);

                if (isInDingTalk) {
                    printWindow.document.write('<script src="/dist/assets/print/jspdf.min.js"></script>');
                    printWindow.document.write('<script src="/dist/assets/print/html2canvas.min.js"></script>');
                    printWindow.document.write(`
                    <script>
                        function printHelper(flag) {
                            html2canvas(document.body).then(function(canvas) {
                                var pdf = new jsPDF('p', 'px', 'a4');
                                var canvasWidth = canvas.width;
                                var canvasHeight = canvas.height;
                                var pageWidth = pdf.internal.pageSize.getWidth();
                                var pageHeight = pdf.internal.pageSize.getHeight();
                                var imgWidth = pageWidth - 40;
                                var imgHeight = pageHeight - 40;
                                var tempHeight = canvasWidth * imgHeight / imgWidth;

                                var printInfoHeight = 270;
                                var mod = canvasHeight % tempHeight;
                                if (flag && mod < printInfoHeight) {
                                    document.querySelector('.print-info').style.marginTop = printInfoHeight - mod + 'px';
                                    printHelper(flag - 1);
                                    return;
                                }

                                let position = 0;
                                while (position <= canvasHeight) {
                                    var tempCanvas = document.createElement('canvas');
                                    tempCanvas.width = canvasWidth;
                                    tempCanvas.height = tempHeight;
                                    var tempCtx = tempCanvas.getContext('2d');

                                    var bodyCtx = canvas.getContext('2d');
                                    var imgData = bodyCtx.getImageData(0, position, canvasWidth, tempHeight);
                                    tempCtx.putImageData(imgData, 0, 0, 0, 0, canvasWidth, tempHeight);

                                    pdf.addImage(tempCanvas.toDataURL("image/png"), 'PNG', 20, 20, imgWidth, imgHeight);
                                    position += tempHeight;
                                    if (position <= canvasHeight) {
                                        pdf.addPage();
                                    }
                                }
                                pdf.save('${schemaDisplayName}-${new Date().Format('yyyy_MM_dd hh_mm_ss')}.pdf');
                                window.parent.postMessage({ ready: 1 }, '*');
                            });
                        }
                        window.onload = function() {
                            printHelper(1);
                        }
                    </script>
                    `);
                } else {
                    printWindow.document.write('<script>window.onload=function(){window.parent.postMessage({ready:0},"*")}</script>');
                }
                printWindow.document.close();

                return;
            }
        }

        var diyPrint = function (templateId) {
            var $that = this;
            var id = "action-print-diy";
            var printCls = "diy-action";
            if ($("#" + id).length > 0) {
                $("#" + id).show();
                return false;
            }
            var $action = this.Element;
            var $moreActionDiv = $('<div  id="' + id + '" class="action-print-tip" style="height:auto;display:none"></div>')
                .append($('<ul></ul>')).appendTo($action);

            //绑定click事件
            $moreActionDiv.off("click.action-print-diy").on("click.action-print-diy", '.' + printCls, function (e) {
                var $target = $(e.target);
                var printCode = "";
                if ($target.hasClass(printCls)) {
                    printCode = $target.data().printCode;
                } else {
                    printCode = $target.parents('li').data().printCode;
                }
                if (!printCode) {
                    //默认
                    defaultPrint.apply($that);
                } else {
                    //自定义打印
                    var paramData = {
                        "ActionName": "GetPreViewData",
                        "SchemaCode": $.SmartForm.RequestParameters.SchemaCode,
                        "PrintTemplateCode": printCode,
                        "BizObjectId": $.SmartForm.RequestParameters.BizObjectId
                    };
                    var form = $('form.print-hide-form');
                    var input = form.find('input');
                    if (!form.length) {
                        form = $("<form class='print-hide-form'>"); //定义一个form表单
                        form.attr("style", "display:none");
                        form.attr("target", "");
                        form.attr("method", "post");
                        form.attr("action", "/Print/OnAction");
                        var input = $("<input>");
                        input.attr("type", "hidden");
                        input.attr("name", "PostData");
                        input.attr("value", JSON.stringify(paramData));
                        $("body").append(form);//将表单放置在web中
                        form.append(input);
                    } else {
                        form.attr("action", "/Print/OnAction");
                        input.attr("value", JSON.stringify(paramData));
                    }
                    form.submit();
                }
            });

            $action.off("mouseleave.tooltip").on("mouseleave.tooltip", function (e) {
                $moreActionDiv.hide();
            });
            $moreActionDiv.off("mouseleave.printdiy").on("mouseleave.printdiy", function (e) {
                $moreActionDiv.hide();
                var $target = $(e.target);
                if (!$target.parents('.action-more-tip').length) {
                    $(".action-more-tip").hide();
                }
            });
            $moreActionDiv.off("mouseenter.printdiy").on("mouseenter.printdiy", function (e) {
                $moreActionDiv.show();
                $(".action-more-tip").show();
            });

            var offset = $action.offset();
            var tipDiv = $moreActionDiv;
            this.PrintActions.unshift({ PrintTemplateCode: '', DisplayName: '系统默认模板 ' }); //添加默认打印
            $.each(this.PrintActions, function (index, action) {
                var liElement = $("<li class=" + printCls + " data-print-code='" + action.PrintTemplateCode + "'></li>");
                var linkElement = $("<a href='javascript:void(0);'></a>");
                var spanElement = $("<span class='fa icon-popup_print'>&nbsp;" + action.DisplayName + "</span>");
                if (action.CssClass) {
                    spanElement.addClass(action.CssClass);
                }
                liElement.append(linkElement.append(spanElement));
                liElement.appendTo($moreActionDiv.find("ul"));
            });

            var left = 0;
            var top = 0;
            left = offset.left + ($action.outerWidth() - $moreActionDiv.outerWidth()) / 2 - $(window).scrollLeft() - 36;

            $moreActionDiv.show(); //第一次显示
            left = offset.left - $moreActionDiv.width();
            top = offset.top;
            if (top < 10) {
                top = $action.height() + 5;
                left = left + $moreActionDiv.width();
                $moreActionDiv.addClass('show-sharp');
            }
            // $moreActionDiv.css({ left: left, top: top });
            return false;
        }

        if (this.PrintActions.length) {
            diyPrint.apply(this);
        } else {
            defaultPrint.apply(this);
        }
    }
});
//#endregion

//#region 取回流程 RetrieveInstance
$.Buttons.RetrieveInstance = function (element, option, sheetInfo) {
    return $.Buttons.RetrieveInstance.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.RetrieveInstance.Inherit($.Buttons.BaseButton, {
    PreRender: function () {
        this.constructor.Base.PreRender();
        //this.OnActionPreDo = function () {
        //    return confirm("确定执行取回流程操作?");
        //}
    },
    DoAction: function () {
        $.SmartForm.ConfirmAction("确定执行撤销流程操作", function () {
            $.SmartForm.RetrieveInstance(this);
        });
    }
});
//#endregion

//#region 转发 Forward
$.Buttons.Forward = function (element, option, sheetInfo) {
    return $.Buttons.Forward.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.Forward.Inherit($.Buttons.BaseButton, {
    PreRender: function () {
        this.constructor.Base.PreRender();
    },
    DoAction: function () {
        $.SmartForm.Forward(this);
    }
});

//#region 查看二维码
$.Buttons.ViewQrCode = function (element, option, sheetInfo) {
    return $.Buttons.ViewQrCode.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.ViewQrCode.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        $.SmartForm.ViewQrCode(this);
    }
});

//#region 查看更多
$.Buttons.More = function (element, option, sheetInfo) {
    return $.Buttons.More.Base.constructor.call(this, element, option, sheetInfo);
};
$.Buttons.More.Inherit($.Buttons.BaseButton, {
    DoAction: function () {
        var that = this;
        $("#dvQrCode").parent().hide()//隐藏二维码
        if ($("#action_more").length > 0) {
            $("#action_more").parent().show();//
            return false;
        }
        var $action = that.Element;
        var $moreActionDiv = $('<div class="action-more-tip" style="height:auto;display:none"><ul id="action_more"></ul></div>').appendTo($action);

        $("body").off("click.action-more-tip").on("click.action-more-tip", function (e) {
            var $target = $(e.target);
            if ($target.hasClass("icon-more-big ") || $target.hasClass("action-more-tip") || $target.attr("id") == "action_more") {
                return false;
            }
            else {
                $moreActionDiv.hide();
            }
        })

        //鼠标移开时隐藏更多选项
        $moreActionDiv.off("mouseleave.tooltip").on("mouseleave.tooltip", function (e) {
            var $target = $(e.target);
            $moreActionDiv.hide();
        });
        $moreActionDiv.off("mouseenter.tooltip").on("mouseenter.tooltip", function (e) {
            $moreActionDiv.show();
        });

        var offset = $action.offset();
        var tipDiv = $("div.action-more-tip");
        $.each(that.Options.Buttons, function (index, action) {
            if (that.Options.ControlManagers[action.Action] || action.constructor != Object) { return; }

            var liElement = $("<li data-action='" + action.Action + "'></li>");
            var linkElement = $("<a href='javascript:void(0);'></a>");
            var spanElement = $("<span class='fa " + action.Icon + "'>  " + action.Text + "</span>");
            if (action.CssClass) {
                spanElement.addClass(action.CssClass);
            }
            liElement.append(linkElement.append(spanElement));
            var Container = $moreActionDiv.find("#action_more");

            if ($.Buttons[action.Action]) {
                that.Options.ControlManagers[action.Action] = new $.Buttons[action.Action](Container, action, that.ResponseContext);
            } else {
                that.Options.ControlManagers[action.Action] = new $.Buttons.BaseButton(Container, action, that.ResponseContext);
            }
            //that.Options.ControlManagers[action.Action] = new $.Buttons[action.Action](Container, action, that.ResponseContext);
        });

        //$moreActionDiv.css({ left: offset.left + ($action.outerWidth() - $moreActionDiv.outerWidth()) / 2 - $(window).scrollLeft() - 36, bottom: $(window).height() - $action.outerHeight() - tipDiv.outerHeight() - 8 });

        $moreActionDiv.show(); //第一次显示
        return false;
    }
});
//#endregion
;
//复选框
(function ($) {
    $.fn.FormCheckboxList = function () {
        return $.ControlManager.Run.call(this, "FormCheckboxList", arguments);
    };

    // 构造函数
    $.Controls.FormCheckboxList = function (element, ptions, sheetInfo) {
        $.Controls.FormCheckboxList.Base.constructor.call(this, element, ptions, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormCheckboxList.Inherit($.Controls.BaseControl, {
        Render: function () {
            if (!this.Visible) {
                $(this.Element).hide();
                return;
            }

            this.OptionValues = {};

            //渲染前端
            this.HtmlRender();
            //绑定事件
            this.BindEvent();
            //初始化默认值
            this.InitValue();
        },

        //获取值
        GetValue: function () {
            if (!this.Editable) {
                if (this.$Input) {
                    return this.$Input.html();
                } else {
                    return "";
                }
            }

            if (this.isCheckbox) { // 单选框
                return $(this.Element).find("input").prop("checked");
            } else { // 多选框
                var value = "";
                $(this.Element).find("input").each(function () {
                    if (this.checked) {
                        if (value == "") {
                            value += $(this).val()
                        }
                        else {
                            value += ";" + $(this).val();
                        }
                    }
                });
                return value;
            }
        },

        //设置控件的值
        SetValue: function (value) {
            if (value == void 0/* || value == ""*/) {
                return;
            }
            var displaytext = "";
            if (!this.Editable) {
                if (this.Visible) {
                    var items = value;
                    if (!$.isArray(items)) {
                        try { items = (value + "").split(';'); }
                        catch (e) {
                            alert(e)
                        }
                    }
                    if (items != void 0) {
                        for (var i = 0; i < items.length; i++) {

                            if (this.OptionValues[items[i]]) {
                                displaytext += this.OptionValues[items[i]] + ";";
                            }
                            else {
                                displaytext += items[i] + ";";
                            }

                        }
                    }
                }
                if (displaytext != "") {
                    displaytext = displaytext.slice(0, displaytext.length - 1);
                }
                if (this.$Input != undefined)
                    this.$Input.html(displaytext);

                return;
            }
            //先清除所有勾选
            $(this.Element).find("input").prop("checked", false);

            if (this.isCheckbox) {
                $(this.Element).find("input").prop("checked", value);
            } else {
                var items = value;
                if (!$.isArray(items)) {
                    try { items = (value + "").split(';'); }
                    catch (e) {
                        alert(e)
                    }

                }
                if (items != void 0) {
                    for (var i = 0; i < items.length; i++) {
                        $(this.Element).find("input").each(function () {
                            if (this.value == items[i])
                                $(this).prop("checked", true);
                        });
                    }
                }
            }
            this.OnChange();
        },

        GetText: function () {
            var text = "";
            if (this.Editable) {
                $(this.Element).find("input").each(function () {
                    if (this.checked)
                        text += $(this).text() + ";";
                });
            } else {
                text = this.$Input.html();
            }
            return text;
        },

        SetReadonly: function (flag) {
            if (flag) {
                $(this.Element).find("input").attr("readonly", "readonly").attr("disabled", "disabled");
            } else {
                $(this.Element).find("input").removeAttr("readonly").removeAttr("disabled");
            }
        },

        InitValue: function () {
            //设置默认值
            if ((this.Value === true || this.Value === false)) {
                this.SetValue(this.Value);
                return;
            }
            var items = this.Value || this.DefaultValue;
            if (this.Value == void 0 && $.SmartForm.ResponseContext.IsCreateMode) {
                items = this.DefaultValue;
            } else {
                items = this.Value;
            }
            if (this.isCheckbox) {
                if (items) {
                    this.SetValue(true);
                } else {
                    this.SetValue(false);
                }
            } else {
                this.SetValue(items);
            }
        },

        HtmlRender: function () {
            var that = this;

            if (that.Editable) {
                //组标示
                $(this.Element).addClass("SheetCheckBoxList");
                this.GropName = this.DataField + $.IGuid();

                // 绑定数据字典
                this.$ListWrap = $("<div class='radiolistwrap'>");
                if (this.DataDictItemName) {
                    if (this.DataDictItemValue && $.isArray(this.DataDictItemValue)) {
                        var options = this.DataDictItemValue;
                        for (var i = 0, len = options.length; i < len; i++) {
                            that.AddItem.apply(that, [options[i], options[i]]);
                        }
                    }
                } else {
                    if (this.DefaultItems) {
                        for (var i = 0, len = this.DefaultItems.length; i < len; i++) {
                            that.AddItem.apply(that, [this.DefaultItems[i], this.DefaultItems[i]]);
                        }
                    }
                }
                this.$ListWrap.appendTo(this.$InputBody)
            } else {
                this.$Input = $("<pre style='border:none'>");
                this.$InputBody.append(this.$Input);
            }
        },

        //绑定事件
        BindEvent: function () {
            this.$InputBody.off("change.FormCheckboxList").on("change.FormCheckboxList", "input", this, function (e) {
                var that = e.data;
                that.Validate.apply(that);
                that.OnChange.apply(that);
                that.Required && ($(this).prop("checked") && that.$ListWrap.removeAttr("style"));
            });
        },

        //处理必填红色*号
        Validate: function () {
            // 单选模式不验证必填
            if (this.isCheckbox) {
                return true;
            }

            var check = true;
            if (this.Editable && this.Required) {
                check = false;
                var inputs = $(this.$InputBody).find("input");
                for (var i = 0; i < inputs.length; i++) {
                    if ($(inputs[i]).is(":checked")) {
                        check = true;
                        break;
                    }
                }
                if (check) {
                    this.RemoveInvalidText(this.$InputBody.find("label:last"), "必填");
                } else {
                    this.AddInvalidText(this.$InputBody.find("label:last"), "必填");
                    return false;
                }
            }
            //勾选项总长度不能超过200
            var $inputs = $(this.$InputBody).find("input:checked");
            var checkedItemLength = 0;
            for (var i = 0; i < $inputs.length; i++) {
                var itemValue = $($inputs[i]).val();
                checkedItemLength += itemValue.length + 1;
                if (checkedItemLength > 200) {
                    break;
                }
            }
            if (checkedItemLength > 200) {
                this.AddInvalidText(this.$InputBody.find("label:last"), "勾选项总字数超200过限制，无法提交，请联系管理员处理");
                return false;
            } else {
                this.RemoveInvalidText(this.$InputBody.find("label:last"), "勾选项总字数超过200限制，无法提交，请联系管理员处理");
                return true;
            }

            return check;
        },

        AddItem: function (value, text) {
            if (!this.Editable) {

                var txt = "";
                if (text) {
                    txt = text;
                } else {
                    txt = value;
                }
                this.OptionValues[value] = txt;
            } else {
                if (text || value) {
                    var id = $.IGuid();
                    var option = "<div style='float:left;' GropName='" + this.GropName + "'>";
                    option += "<input type='checkbox' name='" + this.GropName + "' id='" + id + "' value='" + value + "' ";
                    if (!this.Editable) {//不可用
                        option += " disabled='disabled' ";
                    }
                    option += " />";
                    option += " <label for='" + id + "'>" + (text || value) + "</label>";
                    option += " </div> ";
                    this.$ListWrap.append(option);
                }
            }
        },

        ClearItems: function () {
            this.$ListWrap.empty();

        },

        SaveDataField: function () {
            //如果是权限设置的Visible是false，如果是规则设置的Visible可能仍然是true
            var result = {};
            if (!this.Visible) return result;

            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldresult) {
                return {};
            }
            if (oldresult.Value != this.GetValue()) {
                result[this.DataField] = this.GetValue();
                return result;
            }
            // return {}; // fix: 复选框默认选中提交无数据
            result[this.DataField] = oldresult.Value;
            return result;
        }
    });
})(jQuery);;
//复选框

(function ($) {
    $.fn.FormCheckbox = function () {
        return $.ControlManager.Run.call(this, "FormCheckbox", arguments);
    };

    // 构造函数
    $.Controls.FormCheckbox = function (element, ptions, sheetInfo) {
        $.Controls.FormCheckbox.Base.constructor.call(this, element, ptions, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormCheckbox.Inherit($.Controls.BaseControl, {
        Render: function () {
            if (!this.Visible) {
                $(this.Element).hide();
                return;
            }
            //是否在子表里面子表
            this.IsInGridView = !$.isEmptyObject(this.ObjectId);

            //渲染前端
            this.HtmlRender();
            //绑定事件
            this.BindEvent();
            //初始化默认值
            this.InitValue();
        },

        //获取值
        GetValue: function () {
            if (!this.Editable) {
                var val = $(this.Element).find('pre').text()
                return val == '是' ? true : false;
            }
            return $(this.Element).find("input").prop("checked");
        },

        //设置控件的值
        SetValue: function (value) {
            if (!this.Editable) {
                this.$Input.text(value ? "是" : "否");
                return;
            } else {
                $(this.Element).find("input").prop("checked", value);
                this.OnChange();
            }
        },

        GetText: function () {
            var text = "";
            $(this.Element).find("input").each(function () {
                if (this.checked)
                    text += $(this).text() + ";";
            });
            return text;
        },

        SetReadonly: function (flag) {
            if (flag) {
                $(this.Element).find("input").attr("readonly", "readonly").attr("disabled", "disabled");
            } else {
                $(this.Element).find("input").removeAttr("readonly").removeAttr("disabled");
            }
        },

        InitValue: function () {
            //设置默认值
            var valueLocal;//= this.Value == null ? this.DefaultValue : this.Value;
            if (this.Value == void 0 && $.SmartForm.ResponseContext.IsCreateMode) {
                valueLocal = this.DefaultValue;
            } else {
                valueLocal = this.Value;
            }
            if (!this.Editable) {
                if (valueLocal) {
                    this.$Input.text(valueLocal.indexOf("true") >= 0 ? "是" : "否");
                }
                else {
                    this.$Input.text('');
                }

                return;
            }
            $(this.$InputBody).find("input").each(function () {
                if (valueLocal) {
                    if (valueLocal.indexOf("true") >= 0)
                        $(this).attr('checked', true)
                    else
                        $(this).attr('checked', false)
                }
            });
        },

        HtmlRender: function () {
            var that = this;
            if (!this.Editable) {
                this.$Input = $("<pre style='border:none;'>");
                $(this.$InputBody).append(this.$Input);
            } else {

                $(this.Element).find(".ControlTitle").text("");
                //组标示
                $(this.Element).addClass("SheetCheckBoxList");
                this.GropName = this.DataField + $.IGuid();

                // 绑定数据字典
                if (this.DataDictItemName) {
                    if (this.DataDictItemValue && $.isArray(this.DataDictItemValue)) {
                        var options = this.DataDictItemValue;
                        for (var i = 0, len = options.length; i < len; i++) {
                            that.AddCheckboxItem.apply(that, [options[i], options[i]]);
                        }
                    }
                } else {
                    if (this.DefaultItems) {
                        for (var i = 0; i < this.DefaultItems.length; i++) {
                            that.AddCheckboxItem.apply(that, [this.DefaultItems[i], this.DefaultItems[i]]);
                        }
                    }
                }
                if (that.IsInGridView) {
                    $(that.Element).find("label").text("").css({ left: "50%", marginLeft: "-10px" });
                }
            }
        },
        //绑定事件
        BindEvent: function () {
            this.$InputBody.off("change.FormCheckbox").on("change.FormCheckbox", "input", this, function (e) {
                var that = e.data;
                that.OnChange.apply(that);
            });
        },

        AddCheckboxItem: function (value, text) {
            if (text || value) {
                var id = $.IGuid();
                var option = "<div GropName='" + this.GropName + "'>";
                option += "<input type='checkbox' name='" + this.GropName + "' id='" + id + "' value='" + value + "' ";
                if (!this.Editable) {//不可用
                    checkbox.prop("disabled", "disabled")
                    option += " disabled='disabled' ";
                }
                option += " /> ";
                option += " <label for='" + id + "'>" + (text || value) + "</label> ";
                option += " </div> ";
                this.$InputBody.append(option);
            }
        },
        Empty: function () {
            this.$InputBody.empty();
        },

        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;

            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldresult) {
                return {};
            }
            if (oldresult.Value != this.GetValue()) {
                result[this.DataField] = this.GetValue();
                return result;
            }
            return {};
        },
    });
})(jQuery);;
// RadioButtonList控件
; (function ($) {
    //控件执行
    $.fn.FormRadioButtonList = function () {
        return $.ControlManager.Run.call(this, "FormRadioButtonList", arguments);
    };

    // 构造函数
    $.Controls.FormRadioButtonList = function (element, ptions, sheetInfo) {
        $.Controls.FormRadioButtonList.Base.constructor.call(this, element, ptions, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormRadioButtonList.Inherit($.Controls.BaseControl, {
        Render: function () {
            //不可见返回
            if (!this.Visible) {
                $(this.Element).hide();
                return;
            }

            //渲染前端
            this.HtmlRender();

            this.BindEvent();

            //初始化默认值
            this.InitValue();
        },

        GetValue: function () {
            var value = "";
            if (!this.Editable) {
                //value = this.$Input.html();
                if (this.$Input) {
                    value = this.$Input.html();
                }
            }
            else {
                $(this.Element).find("input").each(function () {
                    if (this.checked)
                        value = $(this).val();
                });
            }
            return value;
        },

        //设置控件的值
        SetValue: function (value) {
            if (value == void 0) {
                return;
            }

            if (!this.Editable) {
                this.$Input.html(value);
                return;
            }
            //先清除所有勾选
            $(this.Element).find("input").prop("checked", false);

            var items = value;
            if (!$.isArray(items)) {
                items = value.split(';');
            }
            //var items = value.split(';');
            if (items != void 0) {
                for (var i = 0; i < items.length; i++) {
                    $(this.Element).find("input").each(function () {
                        if (this.value == items[i])
                            //$(this).attr("checked", "checked");
                            $(this).prop("checked", true);
                    });
                }
            }
            this.OnChange();
        },

        GetText: function () {
            return $(this.Element).find("input:checked").text();
        },

        SetReadonly: function (flag) {
            if (flag) {
                $(this.Element).find("input").prop("disabled", true);
            }
            else {
                $(this.Element).find("input").removeAttr("disabled");
            }
        },

        //设置一行显示数目
        SetColumns: function () {
            if (this.RepeatColumns && /^([1-9]\d*)$/.test(this.RepeatColumns)) {
                var width = (100 / this.RepeatColumns) + "%";
                var divs = $(this.Element).find("div"),
                    i;
                for (i = 0; i < divs.length; i++) {
                    $(divs[i]).css({ "width": width });
                }
            }
        },

        //返回数据值
        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;
            var oldresult = this.ResponseContext.ReturnData[this.DataField];
            if (!oldresult) {
                return {};
            }

            if (oldresult.Value != this.GetValue()) {
                result[this.DataField] = this.GetValue();
                return result;
            }
            // return {}; //  // fix: 单选框默认选中提交无数据
            result[this.DataField] = oldresult.Value;
            return result;
        },

        //设置默认值
        InitValue: function () {
            var item = "";
            //只有在新建表单时候设置DefaultValue
            if (this.Value == void 0 && $.SmartForm.ResponseContext.IsCreateMode) {
                item = this.DefaultValue;
            } else {
                item = this.Value
            }
            //var item = this.Value || this.DefaultValue;
            if (item != void 0) {
                item += '';
                this.SetValue(item);
            }
        },

        HtmlRender: function () {
            if (this.Editable) {
                $(this.Element).addClass("SheetRadioButtonList");
                //组标示
                this.GropName = this.DataField + $.IGuid();//设置统一的name

                this.$ListWrap = $("<div class='radiolistwrap'>");
                if (this.DataDictItemName) {
                    if (this.DataDictItemValue && $.isArray(this.DataDictItemValue)) {
                        var options = this.DataDictItemValue;
                        for (var i = 0, len = options.length; i < len; i++) {
                            this.AddItem.apply(this, [options[i], options[i]]);
                        }
                    }
                }
                else {
                    if (!$.isEmptyObject(this.DefaultItems)) {
                        for (var i = 0, len = this.DefaultItems.length; i < len; i++) {
                            this.AddItem.apply(this, [this.DefaultItems[i], this.DefaultItems[i]]);
                        }
                    }
                }
                this.$ListWrap.appendTo(this.$InputBody);
            }
            else {
                this.$Input = $("<pre>").css("border", "none");
                this.$InputBody.append(this.$Input);
            }
        },

        //绑定事件
        BindEvent: function () {
            this.$InputBody.off("change.FormRadioButtonList").on("change.FormRadioButtonList", "input", this, function (e) {
                var that = e.data;
                that.OnChange.apply(that);
                that.Validate.apply(that);
                that.Required && ($(this).prop("checked") && that.$ListWrap.removeAttr("style"));
            });
        },

        //处理必填红色*号
        Validate: function () {
            var check = true;
            if (this.Editable && this.Required) {
                check = false;
                var inputs = $(this.$InputBody).find("input");
                for (var i = 0; i < inputs.length; i++) {
                    if ($(inputs[i]).is(":checked")) {
                        check = true;
                        break;
                    }
                }
                if (check) {
                    this.RemoveInvalidText(this.$InputBody.find("label:last"), "必填");
                }
                else {
                    this.AddInvalidText(this.$InputBody.find("label:last"), "必填");
                }
            }

            return check;
        },

        AddItem: function (value, text) {
            if (!this.Editable) {
                return;
            }
            if (text || value) {
                var option = "<div style='float:left;' GropName='" + this.GropName + "'>";
                var id = $.IGuid();
                option += "<input type='radio' name='" + this.GropName + "' id='" + id + "' value='" + value + "' ";
                if (!this.Editable) {//不可用
                    option += " disabled='disabled' ";
                }
                option += "/>";
                option += "<label for='" + id + "'>" + (text || value) + "</label>";
                option += "</div>";
                this.$ListWrap.append(option);
            }
        },
        ClearItems: function () {
            if (!this.Editable) {
                this.$InputBody.empty();
            } else {
                this.$ListWrap.empty();
            }

        }
    });
})(jQuery);;
// FormDropDownList控件
; (function ($) {
    //控件执行
    $.fn.FormDropDownList = function () {
        return $.ControlManager.Run.call(this, "FormDropDownList", arguments);
    };

    // 构造函数
    $.Controls.FormDropDownList = function (element, options, sheetInfo) {
        $.Controls.FormDropDownList.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormDropDownList.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            //是否在子表里面子表
            this.IsInGridView = !$.isEmptyObject(this.ObjectId);
            //所在子表的EditTablezIndex值
            this.TableEditZIndex = this.IsInGridView && $(this.Element).closest("div.table-edit").css("z-index");

            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }

            this.OptionValues = {};

            //渲染前端
            this.HtmlRender();

            //绑定事件
            this.BindEvent();

            //初始化默认值
            this.InitValue();

            //不可用
            if (!this.Editable) {
                this.SetReadonly(true);
            };
        },

        //渲染前端
        HtmlRender: function () {
            if (!this.Editable) {
                this.$Input = $("<pre style='border:none;'>");
                $(this.$InputBody).append(this.$Input);
            } else {
                $(this.Element).addClass('SheetDropDownList');
                this.$Input = $("<select class='form-control form-group-margin'><option  value=''>--请选择--</option></select>");
                this.$InputText = $('<span type="text" data-propertyname="' + this.DataField
                    + '" class="form-control myform-control mytext comboboxtext" style="min-width:100px;border:1px solid #eee;margin-top:10px;" />')
                if (this.DataDictItemName) {
                    if (this.DataDictItemValue && $.isArray(this.DataDictItemValue)) {
                        var options = this.DataDictItemValue;
                        if (this.DataDictItemValue.indexOf(this.Value) == -1) {
                            this.Value = '';
                        }
                        for (var i = 0, len = options.length; i < len; i++) {
                            this.AddItem(options[i])
                        }
                    }
                    //$(this.$InputBody).addClass("icon-arrow-down-full").append(this.$InputText).append(this.$Input);
                }
                //关联表单时
                else if (this.BOSchemaCode && this.MappingField) {
                    this.RenderAssociation();
                }
                // 外部接口数据源
                else if (this.DataSource === 'Interface') {
                    const interfaceOptions = $(this.Element).attr('data-interfaceoptions')
                    let interfaceObj = {}
                    if (interfaceOptions && interfaceOptions.length > 0) {
                        interfaceObj = JSON.parse(interfaceOptions)
                        this.loadFormDropDownList(interfaceObj, () => {
                            //初始化默认值
                            this.InitValue();
                        })
                    }
                } else {
                    if (!$.isEmptyObject(this.DefaultItems)) {
                        if (this.DefaultItems.indexOf(this.Value) == -1) {
                            this.Value = '';
                        }
                        for (var i = 0; i < this.DefaultItems.length; i++) {
                            if (this.DefaultItems[i]) {
                                this.AddItem(this.DefaultItems[i])
                            }
                        }
                    }
                }
                $(this.$InputBody).append(this.$InputText).append(this.$Input);
            }
        },
        // 加载FormDropDownList控件
        async loadFormDropDownList(interfaceObj, callback) {
            if (interfaceObj.id) {
                try {
                    const result = await HTTP_INTERFACE.getInterfaceData({
                        appId: this.SchemaCode,
                        controlId: this.DataField
                    })
                    if (+result.code === 0 && result.datas) {
                        let datas = JSON.parse(result.datas)
                        datas = datas.slice(0, 50);
                        datas.forEach(item => {
                            this.AddItem(item)
                        })
                        if (typeof callback === 'function') {
                            callback();
                        }
                    } else {
                        Message.error({
                            content: result.msg,
                            duration: 3
                        });
                    }
                } catch (error) {
                    Message.error({
                        content: '下拉框请求外部数据失败',
                        duration: 3
                    });
                }
            }
        },
        //非关联表单渲染DropDown
        RenderSelect: function (resetOptions, notShow) {
            var that = this;
            var position = this.$InputBody.offset();
            var scrollTop = $(document).scrollTop(),
                top = position.top + this.$InputBody.height() - scrollTop,
                bodyHeight = $(document).height() - scrollTop,
                errorRangeHeight = 10;
            if (!this.$DropList) {
                this.$ListContainer = $('<div class="list list-container" style="position: fixed;z-index: 99999;"></div>');
                this.$DropList = $('<ul class="drop-list form-query-dropdown"></ul>');
                //添加搜索框
                this.$SearchInput = $('<input type="text" class="dropdownlist_search" style="width:100%;height:32px;padding-left:12px;" placeholder="搜索"></input> ');
                // 开启远程搜索功能
                const showMode = $(this.Element).attr('data-showmode')
                if (this.DataSource === 'Interface' && +showMode === 1) {
                    this.$SearchInput = $('<input type="text" class="dropdownlist_search" style="width:100%;height:32px;padding-left:12px;" placeholder="请输入两个字符以上进行搜索"></input> ');
                }
                this.$SearchLi = $("<li data-type='search' style='border-bottom:1px solid #d7d5d5'></li>").append(this.$SearchInput);
                this.$DropListDetail = $('<ul class="drop-combox droplistdetail" style="list-style:none;left:0;padding-left:0;max-height:200px;overflow:auto;"></ul>');
                var $li = $("<li></li>").append(this.$DropListDetail);
                this.$DropList.append(this.$SearchLi).append($li);

                if (this.BOSchemaCode && this.MappingField) {
                    //关联
                    that.LoadAssociationData();
                } else {
                    var options = this.$Input.children();
                    for (var i = 0, len = options.length; i < len; i++) {
                        var o = options[i];
                        $li = $("<li></li>")
                            .append($('<a tabindex="' + i + '"><label title="' + o.text + '" class=" form-query-item-label drop-item-btn" data-val="' + o.value + '">' + o.text + '</label></a>'));
                        this.$DropListDetail.append($li);
                    }
                }
                this.$InputBody.append(this.$ListContainer.append(this.$DropList));
            } else if (resetOptions) {
                //联动重绘下拉选项
                var options = this.$Input.children();
                this.$DropListDetail.empty();
                for (var i = 0, len = options.length; i < len; i++) {
                    var o = options[i];
                    $li = $("<li></li>")
                        .append($('<a tabindex="' + i + '"><label class=" form-query-item-label drop-item-btn" data-val="' + o.value + '">' + o.text + '</label></a>'));
                    this.$DropListDetail.append($li);
                }
                return;
            }

            if ((bodyHeight - top - errorRangeHeight) < this.$DropList.height()) {
                top = top - this.$DropList.height() - this.$InputBody.height();
            }

            var left = position.left + 15,
                width = this.$InputText.width() + 15;
            if (this.IsInGridView) { //子表位置调整
                left = left - 15;
                var GridViewWrap = this.$InputBody.closest(".GridViewWrap");
                var l = GridViewWrap.offset().left + GridViewWrap.width();
                if (position.left + width > l) {
                    left = l - width - 15;
                }
            }

            this.$ListContainer.css("left", left);
            this.$ListContainer.css("top", top);
            // this.$ListContainer.width(width);
            //this.$DropList.show();
            setTimeout(function () {
                if (!notShow) {
                    that.$DropList.show();
                    that.$SearchInput.focus();
                }
                //点击DropDown以外区域隐藏,需要排除搜索框
                var eventName = "click.DropdownList" + (that.DataField || $(that.Element).attr("id"));
                //关闭
                $(document).off(eventName).on(eventName, that, function (e) {
                    var target = e.target;
                    var ctrl = e.data;
                    if (ctrl.$InputText[0] != target && ctrl.$InputBody.find($(target)).length == 0
                        && !$(target).hasClass("dropdownlist_search")) {
                        ctrl.$DropList.hide();
                        $(document).off(eventName);
                        $(document).off("scroll.FormDropDownList");

                        //还原tableedit-index
                        if (that.IsInGridView) {
                            var _index = parseInt(that.TableEditZIndex);
                            $(that.Element).closest("div.table-edit").css("z-index", _index);
                        }
                    }
                });
                //滚动
                $(document).off("scroll.FormDropDownList").on("scroll.FormDropDownList", function () {
                    var position = that.$InputBody.offset(),
                        scrollTop = $(document).scrollTop(),
                        top = position.top + that.$InputBody.height() - scrollTop,
                        bodyHeight = $(document).height() - scrollTop;
                    if ((bodyHeight - top - errorRangeHeight) < that.$DropList.height()) {
                        top = top - that.$DropList.height() - that.$InputBody.height();
                    }
                    that.$ListContainer.css("top", top);
                });
                //搜索
                that.$SearchInput.off("input.search").on("input.search", async function () {
                    const showMode = $(that.Element).attr('data-showmode')
                    // 开启远程搜索功能
                    if (that.DataSource === 'Interface' && +showMode === 1) {
                        const searchKey = this.value || "";
                        if (searchKey.length > 1 || searchKey.length < 1) {
                            that.ClearItems()
                            try {
                                const result = await HTTP_INTERFACE.getInterfaceData({
                                    appId: that.SchemaCode,
                                    controlId: that.DataField,
                                    query: searchKey
                                })
                                if (+result.code === 0 && result.datas) {
                                    let datas = JSON.parse(result.datas)
                                    datas = datas.slice(0, 50);
                                    datas.forEach(item => {
                                        that.AddItem(item)
                                    })
                                } else {
                                    Message.error({
                                        content: result.msg,
                                        duration: 3
                                    });
                                }
                            } catch (error) {
                                Message.error({
                                    content: '下拉框请求外部数据失败',
                                    duration: 3
                                });
                            }
                        }
                    } else {
                        var options = that.$DropListDetail.find("label")
                        var searchKey = this.value || "";
                        for (var i = 1, len = options.length; i < len; i++) {
                            var o = options[i];
                            if (searchKey == "") {
                                $(o).show();
                            } else if ($(o).text().indexOf(searchKey) == -1) {
                                $(o).hide();
                            } else {
                                $(o).show();
                            }
                        }
                        //重新计算top
                        var position = that.$InputBody.offset(),
                            scrollTop = $(document).scrollTop(),
                            top = position.top + that.$InputBody.height() - scrollTop,
                            bodyHeight = $(document).height() - scrollTop;
                        if ((bodyHeight - top - errorRangeHeight) < that.$DropList.height()) {
                            top = top - that.$DropList.height() - that.$InputBody.height();
                        }
                        that.$ListContainer.css("top", top);
                    }
                });
                //选中
                that.$ListContainer.off('click.select').on("click.select", "label", function (e) {
                    that.$SearchInput.val("");//清空搜索
                    var v = $(this).data().val;
                    var t = $(this).text();
                    that.$DropList.hide();
                    that.$InputText.text(t);
                    that.SetValue(v);
                    if (that.IsInGridView) {
                        var _index = parseInt(that.TableEditZIndex);
                        $(that.Element).closest("div.table-edit").css("z-index", _index);
                    }
                    that.$Input.trigger("change");
                    e.stopPropagation();
                });
            }, 0);
        },

        //绑定事件
        BindEvent: function () {
            this.$Input.off("change.FormDropDownList").on("change.FormDropDownList", this, function (e) {
                var that = e.data;
                that.OnChange.apply(that);
                that.Validate.apply(that);
                that.Required && (this.value && $(this).removeAttr("style").siblings(".dropdownlist").css({ "outline": "none", "box-shadow": "none" }));
            });

            $(this.$InputBody).off("click").on("click", this, function (e) {
                var that = e.data;
                if (that.BOSchemaCode && that.MappingField) {
                    return;
                };
                that.RenderSelect();
                if (that.IsInGridView) {
                    var _index = parseInt(that.TableEditZIndex);
                    _index++;
                    $(that.Element).closest("div.table-edit").css("z-index", _index);
                }
                e.stopPropagation();
            });
        },

        //设置默认值
        InitValue: function () {
            var item = "";
            if (this.Value == void 0 && $.SmartForm.ResponseContext.IsCreateMode && this.DataSource !== 'Interface') {
                item = this.DefaultValue;
            } else {
                item = this.Value;
            }
            if (item != void 0) {
                if (!this.Editable) {
                    this.$Input.text(item);
                } else {
                    this.$Input.val(item);
                    if (this.$InputText && item != "") {
                        this.$InputText.text(item);
                    } else {
                        this.$InputText.text("--请选择--");
                    }
                }
            } else {
                if (!this.Editable) {
                    this.$Input.text(item);
                }
                else {
                    this.$InputText.text("--请选择--");
                }

            }
        },

        //校验
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;
            var val = this.GetValue();

            // 修改判空条件，val是字符串，不是对象 by lizijie
            // if (this.Required && $.isEmptyObject(val)) {
            if (this.Required && val == '') {
                this.AddInvalidText(this.$Input, "必填");
                return false;
            }

            this.RemoveInvalidText(this.$Input);
            return true;
        },

        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;
            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldresult) {
                return {};
            }
            if (oldresult.Value != this.GetValue() || oldresult.Value) {
                result[this.DataField] = this.GetValue();
                return result;
            }
            return {};
        },

        GetValue: function () {
            var val = "";
            if (!this.Editable) {
                if (this.$Input) {
                    val = this.$Input.text();
                }
            } else {
                if (this.$Input) {
                    val = this.$Input.val();
                }
                if (!val && this.Value) {
                    val = this.Value;
                }
            }
            return val;
        },

        GetText: function () {
            if (!this.Editable) {
                return this.$Input.text();
            } else {
                return this.$Input.find(":checked").text();
            }
        },

        SetValue: function (value) {
            if (value == void 0) {
                if (!this.Editable) {
                    this.$Input.text('');
                } else {
                    this.$Input.val('');
                }
                return;
            }
            this.Value = value;
            if (!this.Editable) {
                if (this.Visible) {
                    if (this.OptionValues[value]) {
                        this.$Input.text(this.OptionValues[value]);
                    } else {
                        this.$Input.text(value);
                    }
                }
            } else {
                this.$Input.val(value);
                var text = this.OptionValues[value] || value;
                this.$InputText.text(text);
            }
            this.OnChange();
        },

        SetReadonly: function (flag) {
            var that = this;
            if (flag) {
                //this.$Input.prop("disabled", "disabled");
                if (this.BOSchemaCode && this.MappingField) {
                    setTimeout(function () {
                        that.$InputText && that.$InputText.off("mousedown.dropdownAsscaition")
                    }, 0);
                } else {
                    this.$InputBody.off("click");
                }
            } else {
                //this.$Input.removeProp("disabled");
                if (this.BOSchemaCode && this.MappingField) {
                    that.RenderAssociation();
                } else {
                    this.BindEvent();
                }
            }
        },

        ClearItems: function () {
            this.OptionValues = {};
            if (!this.Editable) {
                this.$DropListDetail && this.$DropListDetail.empty();
                this.$Input && this.$Input.val("");
                this.$Input && this.$Input.text("");
            } else {
                this.$DropListDetail && this.$DropListDetail.empty();
                this.$InputText.text("--请选择--");
                if (this.FromRowNum) { this.FromRowNum = 0; }
                return this.$Input.empty();
            }
        },

        AddItem: function (value, text) {
            if (value == null && text == null) return;

            var txt = "";
            if (text) {
                txt = text;
            } else {
                txt = value;
            }
            this.OptionValues[value] = txt;

            if (this.Editable) {
                if (this.IsAssociation) {
                    //查询空值
                    if (this.FromRowNum == 0) {
                        this.$DropListDetail.append($('<li><a tabindex="-1"><label class="form-query-item-label drop-item-btn" data-val="" >' + "--请选择--" + '</label></a></li>'));
                    }
                    if (this.$DropListDetail.find("label[data-val='" + (value ? value : "--") + "']").length == 0) {
                        this.$DropListDetail.append($('<li><a tabindex="' + this.FromRowNum + '"><label class=" form-query-item-label drop-item-btn"  data-val="' + (value ? value : "--") + '">' + (txt ? txt : "--") + '</label></a></li>'));
                        this.FromRowNum = this.FromRowNum + 1;
                    }
                } else {
                    this.$Input.append($("<option value='" + value + "'>" + txt + "</option>"));
                    var jControl = $(this.Element).data("JControl");
                    if (!$.isEmptyObject(jControl)) {
                        this.RenderSelect(true, true);
                    }
                }
            }
        },
        AddSelectedValue: function (v, text) {
            this.IsSearchMode = false;
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.Visible)
                    this.$Input.html(this.Value);
            } else {
                //var val = this.$Input.val();
                //var index = val.lastIndexOf(",") > val.lastIndexOf("，") ? val.lastIndexOf(",") : val.lastIndexOf("，");
                //if (index > 0) {
                //    val = val.substring(0, index + 1) + v;
                //}
                //else {
                //    val = v;
                //}
                var val = v;
                this.$Input.val(val);
                this.$InputText.text(text);
                this.Value = val;
            }
        },
        RenderAssociation: function () {
            var that = this;
            this.IsAssociation = true;
            this.FromRowNum = 0;
            this.PageSize = 10;
            this.LoadMore = true;
            this.IsFirstLoad = true;
            //this.AssociationItems = [];
            if (!this.$DropList) {
                this.$Input = $('<input type="text" data-propertyname="' + this.DataField + '" style="display:none" />');
                this.$InputText = $('<span type="text" data-propertyname="' + this.DataField + '" class="form-control myform-control mytext comboboxtext" style="width:100 %;" />')
                this.$DropList = $('<ul class="drop-list drop-combox formdropdownlist form-query-dropdown" style="left:0;overflow:hidden;"></ul>');
                //添加搜索框
                this.$SearchInput = $('<input type="text" class="dropdownlist_search" style="width:100%;height:32px;padding-left:12px;" placeholder="搜索"></input> ');
                this.$SearchLi = $("<li data-type='search' style='border-bottom:1px solid #d7d5d5'></li>").append(this.$SearchInput);

                this.$DropListDetail = $('<ul class="drop-combox droplistdetail" style="list-style:none;left:0;padding-left:0;max-height:200px;overflow:auto;"></ul>');
                var $li = $("<li></li>").append(this.$DropListDetail);
                this.$DropList.append(this.$SearchLi).append($li);

                this.$InputBody.append(this.$InputText).append(this.$Input);
                this.$DropList.appendTo($("body"));
            }

            setTimeout(function () {
                $(that.Element).off("mousedown.dropdownAsscaition").on("mousedown.dropdownAsscaition", function () {
                    var position = that.$InputText.offset();
                    that.$DropList.css({
                        'position': 'absolute',
                        'left': position.left,
                        'top': position.top + that.$InputText.outerHeight(),
                        'z-index': 9000,
                        'width': that.$InputText.outerWidth()
                    });

                    if (that.IsFirstLoad) {
                        that.LoadAssociationData();
                    }
                    that.$DropList.show();

                    setTimeout(function () { that.$SearchInput.focus(); }, 50);

                    if (that.IsInGridView) {
                        var _index = parseInt(that.TableEditZIndex);
                        _index++;
                        $(that.Element).closest("div.table-edit").css("z-index", _index);
                    }
                });
                //点击DropDown以外区域隐藏,需要排除搜索框
                var eventName = "click.DropdownList" + (that.DataField || $(that.Element).attr("id"));
                $("body").off(eventName).on(eventName, that, function (e) {
                    var target = e.target;
                    var ctrl = e.data;

                    if (ctrl.$InputText[0] != target && ctrl.$InputBody.find($(target)).length == 0
                        && !$(target).hasClass("dropdownlist_search") && !$(target).hasClass("icon-arrow-down-full")) {
                        ctrl.$DropList.hide();
                    }
                });

                that.$DropList.off("mousedown.dropdownAsscaition").on("mousedown.dropdownAsscaition", ".drop-item-btn", function (e) {
                    var val = this.getAttribute("data-val");
                    //如果值没有改变不需要重新赋值
                    if (that.Value == val) { return; }

                    if (val == "") {
                        that.AddSelectedValue.call(that, val, val);
                    } else {
                        that.AddSelectedValue.call(that, val, $(this).text());
                    }
                    that.OnChange();
                    that.Validate.apply(that);
                    that.$DropList.hide();

                    //还原z-index值
                    if (that.IsInGridView) {
                        var _index = parseInt(that.TableEditZIndex);
                        $(that.Element).closest("div.table-edit").css("z-index", _index);
                    }
                });

                //滚动刷新
                that.$DropListDetail.scroll(function () {
                    var scrollTop = this.scrollTop,
                        scrollHeight = this.scrollHeight,
                        clientHeight = this.clientHeight;
                    //还有返回值的情况下才加载数据
                    if (scrollTop + clientHeight >= scrollHeight && that.LoadMore) {
                        var searchvalues = that.$SearchInput.val().split(/,|，/);
                        var key = (searchvalues != null && searchvalues.length > 0) ? searchvalues[searchvalues.length - 1] : "";
                        that.LoadAssociationData();
                    }
                });

                //搜索
                var timeout;
                $(that.$SearchInput).off("input propertychange").on("input propertychange", that, function (e) {
                    var $that = e.data;
                    $that.IsSearchMode = true;
                    var searchvalues = $(this).val().split(/,|，/);
                    var key = (searchvalues != null && searchvalues.length > 0) ? searchvalues[searchvalues.length - 1] : "";
                    timeout && (clearTimeout(timeout), timeout = null);
                    timeout = setTimeout(function () { $that.ReloadAssciationData(true); }, 400);
                });

                //
                $(that.$Input).off("change").on("change", function () {
                    $(that.$InputText).text($(this).val());
                });
            }, 0);
        },
        LoadAssociationData: function () {
            var that = this;
            var schemaCode = this.BOSchemaCode;
            var mappingField = this.MappingField;

            var filter = this.AssociationFilter;
            var ajaxUrl = "/App/OnAction";
            var params = {};
            params.ActionName = "LoadSchemaPropertyValues";
            params.SchemaCode = schemaCode;
            params.PropertyName = mappingField;
            params.SearchKey = this.IsSearchMode ? this.$SearchInput.val() : "";
            params.FromRowNum = this.FromRowNum;
            params.ToRowNum = this.FromRowNum + this.PageSize;
            params.scopeType = "4";

            //计算过滤条件
            this.LoadAssciationFilter();
            if ((this.FilterFields && this.FilterFields.length > 0) || (this.AssociationFilter && this.AssociationFilter.Rule)) {
                this.GetAssociationFilterData();
                //过滤规则解析时使用
                params.SheetData = JSON.stringify(this.SheetData);
                //当前表单schemaCode
                params.SheetCode = this.SchemaCode;
                params.AssociationFilter = this.AssociationFilter.Rule;
            }
            var postData = { PostData: JSON.stringify(params) };
            this.Ajax(ajaxUrl, "POST", postData, function (data) {
                that.IsFirstLoad = false;
                if (!data.ErrorMessage && data.ReturnData && data.ReturnData.list) {

                    var dataLength = data.ReturnData.list.length;
                    if (dataLength < that.PageSize) { that.LoadMore = false; }
                    for (var i = 0; i < dataLength; i++) {
                        that.AddItem(data.ReturnData.list[i], data.ReturnData.list[i])
                    }
                }

            }, true,
                function (error) {

                })
        },
        //重新加载关联数据
        ReloadAssciationData: function () {
            var that = this;
            this.IsFirstLoad = true;
            this.$DropListDetail.empty();
            this.FromRowNum = 0;
            if (that.Timeout) { clearTimeout(that.Timeout); }
            that.Timeout = setTimeout(function () {
                that.LoadAssociationData();
            }, 50);
        },
        //计算本表单关联控件
        LoadAssciationFilter: function () {
            var that = this;
            if (this.AssociationFilter && this.AssociationFilter.Rule) {
                var filterRule = this.AssociationFilter.Rule;
                this.FilterFields = [];
                var startIndex = 0;
                while (true) {
                    var index = filterRule.indexOf("{", startIndex)
                    var index2 = filterRule.indexOf("{", startIndex + 1);
                    var index3 = filterRule.indexOf("}", startIndex + 1);
                    if (index3 < index2 || index2 < 0) {
                        var field = filterRule.substring(startIndex + 1, index3);
                        if ($("[data-datafield='" + field + "']").length > 0) {
                            this.FilterFields.push(field)
                        }
                    }
                    startIndex = filterRule.indexOf("{", index3);
                    //已经到结束位置或找不到 {
                    if (startIndex >= filterRule.length || startIndex < 0) {
                        break;
                    }
                }
            }
            //绑定相关控件的change事件, todo 需要判断子表情况
            if (this.FilterFields && this.FilterFields.length > 0) {
                //绑定关联事件
                for (var i = 0; i < this.FilterFields.length; i++) {
                    var field = this.FilterFields[i];
                    var control = [];
                    if (field.indexOf(".") > -1) {
                        var $tr = $(this.Element).closest("tr[data-objectid]");
                        if (!$tr) { continue; }
                        control = $tr.find("[data-datafield='" + field + "']:not(.table_th)");
                    } else {
                        control = $("[data-datafield='" + field + "']:not(.table_th)");
                    }

                    if (control.length > 0) {
                        var controlManager = control.JControl();
                        var changeKey = "changeCasCading." + that.DataField;
                        if (!controlManager.ChangeEvents[changeKey]) {
                            controlManager.BindChange(changeKey, function () {
                                //下拉框重新赋值
                                that.SetValue("");
                                that.ReloadAssciationData();
                            });
                        }
                    }
                }
            }
        },
        //获取关联表单过滤条件中控件的值,过滤条件使用
        GetAssociationFilterData: function () {
            //判断关联查询是否配置了过滤规则
            //如果配置了过滤规则且规则中有当前主表单的字段
            //则要取主表单中的字段
            var that = this;
            this.SheetData = {};
            if (that.DataField == void 0) {
                return;
            }
            if (that.AssociationFilter) {
                var rule = that.AssociationFilter.Rule;
                if (rule && rule.length > 0) {
                    var controls = $.ControlManager.Controls;
                    var hasCreatedByCtrl = false;//是否有创建者控件
                    var hasOwnerCtrl = false;//是否有拥有者控件
                    var hasOwnerDeptCtrl = false;//是否有所属部门控件
                    for (var control in controls) {
                        var ctrl = controls[control];
                        var controlDataField = ctrl.DataField;
                        if (controlDataField == 'CreatedBy.FullName') {
                            controlDataField = controlDataField.split('.')[0];
                            hasCreatedByCtrl = true;
                        }
                        if (controlDataField == 'OwnerId') {
                            hasOwnerCtrl = true;
                        }
                        if (controlDataField == 'OwnerDeptId') {
                            hasOwnerDeptCtrl = true;
                        }
                        //判断是否为关联本表单的数据项
                        //如果rule中包含controlDataField，则应该是以如下形式存在
                        //{xx}或者{xxx.xx}形式，主表中的字段是{controlDataField}，子表中字段是{xxx.controlDataField}
                        if (that.FilterFields == undefined || that.FilterFields.length == 0 || $.inArray(controlDataField, that.FilterFields) < 0) {
                            continue;
                        }
                        //字表中的control不调用SaveDataField，由子表自己调用SaveDataField保存值
                        var controlValue = '';
                        if (controlDataField == 'CreatedBy') {
                            controlValue = $.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].UnitId;
                        } else {
                            if (ctrl.DataField == void 0 || controlDataField == "Comments") continue;
                            //判断关联查询控件是否在子表中
                            if (controlDataField.indexOf('.') > 0 && ctrl.Type != 26 && ctrl.Type != 27) {
                                //规则中的字段在子表中
                                if (that.DataField.indexOf('.') > 0) {
                                    //获取与关联查询控件同一行的子表控件
                                    var $tr = $(that.Element).closest('tr');
                                    var thisRowCtrl = $tr.find('div[data-datafield="' + controlDataField + '"]');
                                    if (thisRowCtrl.length > 0) {
                                        controlValue = $(thisRowCtrl[0]).JControl().GetValue();
                                    }
                                } else {
                                    var $ctrl = $('div[data-datafield="' + controlDataField + '"]').not('.table_th');
                                    if ($ctrl != undefined) {
                                        controlValue = [];
                                        for (var i = 0; i < $ctrl.length; i++) {
                                            controlValue.push($($ctrl[i]).JControl().GetValue());
                                        }
                                    }
                                }
                            } else {
                                if (ctrl.Type == 26 || ctrl.Type == 27) {
                                    //单人
                                    controlValue = ctrl.GetUnitIDs();
                                } else if (ctrl.Type == 7) {
                                    controlValue = ctrl.GetNum();
                                } else {
                                    controlValue = ctrl.GetValue();
                                }
                            }
                        }
                        that.SheetData[controlDataField] = controlValue;
                    }
                    if (!hasCreatedByCtrl) {
                        that.SheetData["CreatedBy"] = $.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].UnitId;
                    }
                    if (!hasOwnerCtrl) {
                        that.SheetData["OwnerId"] = $.SmartForm.ResponseContext.ReturnData.OwnerId.Value[0].UnitId;
                    }
                    if (!hasOwnerDeptCtrl) {
                        that.SheetData["OwnerDeptId"] = $.SmartForm.ResponseContext.ReturnData.OwnerDeptId ? ($.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0] != undefined ? $.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0].UnitId : null) : null;
                    }
                    that.SheetData["CreatedTime"] = $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value;
                }
            }
        },
    });
})(jQuery);;
//日期控件
(function ($) {
    //控件执行
    $.fn.FormDateTime = function () {
        return $.ControlManager.Run.call(this, "FormDateTime", arguments);
    };


    $.Controls.FormDateTime = function (element, options, sheetInfo) {
        $.Controls.FormDateTime.Base.constructor.call(this, element, options, sheetInfo);
    };

    $.Controls.FormDateTime.Inherit($.Controls.BaseControl, {
        Render: function () {
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }

            this.HtmlRender();

            // 不可编辑
            if (!this.Editable) {
                this.SetReadonly(true);
                return;
            }

            //绑定事件
            this.BindEvent();
        },

        getFormat: function () {
            var format = "yyyy-MM-dd";
            if (this.DateTimeMode == "yyyy-mm-dd hh:ii") {
                format = "yyyy-MM-dd hh:mm";
            }
            if (this.DateTimeMode == "hh:ii") {
                format = "hh:mm";
            }
            //增加年月
            if (this.DateTimeMode == "yyyy-mm") {
                format = "yyyy-MM";
            }
            return format;
        },

        //渲染Html页面
        HtmlRender: function () {
            debugger
            var format = this.getFormat();
            if (!this.Editable) {
                this.$Input = $("<pre style='border:none'>");//.css("border", "none");
                if (this.Value && !$.isEmptyObject(this.Value)) {
                    if (format != 'hh:mm') {
                        this.$Input.text(new Date(this.Value.replace(/-/g, "/")).Format(format));

                    }
                    else {
                        this.$Input.text(this.Value);
                    }
                }
                this.$InputBody.append(this.$Input);
            } else {
                var placeHolder = "";
                this.$Input = $("<input type='text' name='" + this.DataField + "' autocomplete='off' class='form-control' style='height:32px;outline:none;'>");//.addClass("");
                if (this.Value && !$.isEmptyObject(this.Value)) {
                    if(this.DateTimeMode === "hh:ii"){
                        this.$Input.val(this.Value);
                    }
                    else{
                        this.$Input.val(new Date(this.Value.replace(/-/g, "/")).Format(format));
                    }
                }
                this.minView = 2;
                this.startView = 2;
                if (this.DateTimeMode == "yyyy-mm-dd hh:ii") {
                    this.minView = 0;
                    placeHolder = "年-月-日 时:分";
                }
                if (this.DateTimeMode == "yyyy-mm-dd") {
                    placeHolder = "年-月-日";
                }
                if (this.DateTimeMode == "hh:ii") {
                    this.startView = 0;
                    this.minView = 0;
                    placeHolder = "时:分";
                }
                if (this.DateTimeMode == "yyyy-mm") {
                    this.startView = 3;
                    this.minView = 3;
                    placeHolder = "年-月";
                }
                this.$InputBody.append(this.$Input.attr("placeholder", placeHolder));

                this.fixTop = 61;
                //判断IE浏览器,IE浏览器不需要设置fixTop
                if (!!window.ActiveXObject || "ActiveXObject" in window) {
                    this.fixTop = 0;
                }
            }
        },

        SetValue: function (value) {
            if (typeof (value) == "undefined" || value == null || value == '') {
                if (this.Editable) {
                    this.$Input.val("");
                } else {
                    if (this.Visible) {
                        this.$Input.text("");
                    }
                    this.Value = "";
                }
                return;
            }
            var temp = value + '';
            if (this.DateTimeMode != "hh:ii") {//日期
                value = temp.replace(/-/g, '/').replace(/T/g, ' ');//IE11日期格式应该是"/"分割的
                if (!(value instanceof Date)) {
                    if ((value + '').indexOf('Date') > -1) {
                        value = value.replace(/\//g, '').replace(/Date/g, '');
                        value = value.slice(1, value.length - 1);
                        value = parseInt(value);
                    }
                }
                var formatedValue = new Date(value).Format(this.getFormat());
                //验证是否是合法的日期
                if (isNaN(new Date(value).getTime())) {
                    return;
                }
                //if (new Date(value).getFullYear() != formatedValue.substring(0, 4)) {
                //    return;
                //}
                //如果时间是yyyy-mm-dd,formate是yyyy-mm-dd hh:ii会导致value的时间部分是8
                var flag = false;
                var reg = /\d{4}(\-|\/|.)\d{1,2}\1\d{1,2}/;
                if (reg.test(temp) && temp.length == 10) {
                    flag = true;
                }
                if (this.DateTimeMode == 'yyyy-mm-dd hh:ii' && flag) {
                    var t = new Date(value);
                    var y = t.getFullYear();
                    var m = t.getMonth() + 1;
                    var d = t.getDate();
                    value = y + '-' + (m < 10 ? ('0' + m) : m) + '-' + (d < 10 ? ('0' + d) : d) + ' 00:00';
                } else {
                    value = formatedValue;
                }
            } else {//时分
                if (!(value instanceof Date)) {//不是日期格式
                    if ((value + '').indexOf('Date') > -1) {
                        value = value.replace(/\//g, '').replace(/Date/g, '');
                        value = value.slice(1, value.length - 1);
                        value = parseInt(value);
                        value = new Date(value).Format(this.getFormat());
                    } else {
                        if (value.length <= 5 && value.indexOf(':') > -1) {
                            var arr = value.split(':');
                            var h = arr[0];
                            var m = arr[1];
                            if (isNaN(h) || isNaN(m)) {
                                return;
                            }
                            h = parseInt(h);
                            m = parseInt(m);
                            if (h < 0 || h > 23 || m < 0 || m > 59) {
                                return;
                            }
                            value = (h < 10 ? ('0' + h) : h) + ':' + (m < 10 ? ('0' + m) : m);
                        } else {
                            //value = new Date(value).Format(this.getFormat());

                            value = new Date(value.replace(/-/g, '/').replace(/T/g, ' '));
                            var h = value.getHours();
                            var m = value.getMinutes();
                            value = (h < 10 ? ('0' + h) : h) + ':' + (m < 10 ? ('0' + m) : m);
                        }
                    }
                } else {
                    value = value.replace(/-/g, '/').replace(/T/g, ' ');
                    value = new Date(value).Format(this.getFormat());
                }
            }
            if (this.Editable) {
                this.$Input.val(value);
            } else {
                if (this.Visible) {
                    this.$Input.text(value);
                } else {
                    this.Value = value;
                }
            }
            this.ValChange();
        },

        GetValue: function () {
            if (this.Editable) {
                var time = "";
                if (this.$Input != void 0)
                    time = this.$Input.val();
                return time;
            } else {
                var time = "";
                time = this.Visible ? this.$Input.text() : this.Value;
                return time ? time : "";
            }
        },

        GetText: function () {
            return this.GetValue();
        },

        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("disabled", "disabled");
            }
            else {
                this.$Input.removeProp("disabled");
            }
        },

        //绑定事件
        BindEvent: function () {
            var that = this;
            $(this.$Input).off("keyup.FormDateTime").on("keyup.FormDateTime", this, function (e) {
                //var that = e.data;
                //that.ValChange();
            });

            $(this.$Input).off("change.FormDateTime").on("change.FormDateTime", this, function (e) {
                var that = e.data;
                that.ValChange();

                that.Required && ($(this).val() != "" && $(this).removeAttr("style"));
            });
            $(this.$Input).one("focus", function () {
                that.$Input.datetimepicker({
                    language: 'zh-CN',
                    format: that.DateTimeMode,
                    todayBtn: true,
                    autoclose: true,
                    startView: that.startView,
                    minView: that.minView,
                    fixTop: that.fixTop
                });
                that.$Input.datetimepicker('show');
                $(that.$Input).off("click");
            });
            $(this.$Input).one("click", function () {
                that.$Input.datetimepicker({
                    language: 'zh-CN',
                    format: that.DateTimeMode,
                    todayBtn: true,
                    autoclose: true,
                    startView: that.startView,
                    minView: that.minView,
                    fixTop: that.fixTop
                });
                that.$Input.datetimepicker('show');
                $(that.$Input).off("focus");
            });
        },

        //值改变
        ValChange: function () {
            debugger
            this.Validate();
            this.OnChange();
        },

        // 数据验证
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            if (this.Required && val.trim() == "") {
                this.AddInvalidText(this.$Input, "必填");
                return false;
            }
            //只要设置了日期就要校验，防止用户输入的时期不正确导致提交后台报错
            if (val) {
                if ((isNaN(Date.parse(val.replace(/-/g, "/"))) && this.DateTimeMode != "hh:ii" && this.DateTimeMode != "yyyy-mm") /*&& this.Required*/) {
                    this.AddInvalidText(this.$Input, "日期格式不对");
                    return false;
                }
            }
            if (this.DateTimeMode != "hh:ii") {
                var time = val.split('-');
                var year = parseInt(time[0]);
                if (year > 9999) {
                    this.AddInvalidText(this.$Input, "日期格式不对");
                    return false;
                }
            }


            if (this.Expression && !this.Expression.test(val)) {
                this.AddInvalidText(this.$Input, this.ErrorAlert);
                return false;
            }

            this.RemoveInvalidText(this.$Input);
            return true;
        },

        //保存数据
        SaveDataField: function () {
            var result = {};
            if (this.ComputationRule == null && !this.Visible) return result;

            if (this.DataField) {
                var dataFieldItem = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
                if (dataFieldItem) {
                    var value = this.GetValue();
                    if (dataFieldItem.Value != value) {
                        result[this.DataField] = value;
                    }
                }
            }
            return result;
        }
    });
})(jQuery);;
// 子表控件
(function ($) {
    //控件执行
    $.fn.FormGridView = function () {
        return $.ControlManager.Run.call(this, "FormGridView", arguments);
    };

    $.Controls.FormGridView = function (element, options, sheetInfo) {
        this.ShowSerialNo = true;//显示序列号
        this.FixColNum = 1;//固定前几列
        this.rowHeight = 0;//默认行高

        this.ChildEditable = [];//子项可写
        this.ChildRequired = [];//子项必填
        this.theadRequired = {}; // 头部子项必填
        this.theadVisible = {}; // 头部子项可见
        $.Controls.FormGridView.Base.constructor.call(this, element, options, sheetInfo);
    };

    $.Controls.FormGridView.Inherit($.Controls.BaseControl, {
        PreRender: function () {
            var that = this;
            this.ColMinWidth = 80;
            this.RowCounts = 0;
            this.SelectedRow = null;
            if (this.ShowSerialNo) {
                $(this.Element).children('table').find('th:first')
                    .before($('<th class="SerialNo_th" style="min-width:auto"><div class="sheet-control table_th SerialNo" style="min-width:40px;text-align: center;">序号</div></th>'));
            }

            /*子表延迟加载执行addrow会触发change事件导致计算规则在非创建模式也会执行
            如果是非创建模式的第一次addrow不触发change事件*/
            this.FirstAddRow = true;
            that.IsFirstSetValue = true;
            this.$Element = $(this.Element).addClass("SheetGridView");
            this.$Table = this.$Element.children("table");
            this.$TableWrap = $('<div class="GridViewWrap">');
            //拖拽容器
            this.$rcHandle = $('<div class="rc-handle-container">').appendTo(this.$TableWrap);
            //子表按钮容器，直接使用事件代理来处理
            this.$TableAction = $('<div class="table-action">');
            var actions = [];
            actions.push('<a class="action active" data-type="down" title="点击全部展开或收缩" style="display: inline;"><i class="ivu-icon ivu-icon-chevron-down"></i><span>点击全部展开或收缩</span></a>');
            actions.push('<a class="action active" data-type="adapteheight" title="行高自适应" style="display: inline;"><i class="ivu-icon ivu-icon-social-buffer-outline"></i><span>行高自适应</span></a>');//行高
            if (!this.Editable) {
                actions.push('<a class="action active" data-type="adaptewidth" title="列宽自适应" style="display: inline;"><i class="ivu-icon ivu-icon-code-working"></i><span>列宽自适应</span></a>');//列宽
            }
            if (this.Editable) {
                actions.push('<a class="action" data-type="delete" title="删除行" style="display: inline;"><i class="ivu-icon ivu-icon-ios-trash"></i><span>删除行</span></a>');//删除
                actions.push('<a class="action" data-type="copy" title="复制行" style="display: inline;"><i class="ivu-icon ivu-icon-ios-photos-outline"></i><span>复制行</span></a>');//复制
                actions.push('<a class="action active" data-type="add" title="添加行" style="display: inline;"><i class="ivu-icon ivu-icon-android-add"></i><span>添加行</span></a>');//添加
            }

            this.$TableAction.append(actions.join("")).appendTo(this.$TableWrap);
            //子表标题
            this.$TableTitle = $('<div class="table-title">').appendTo(this.$TableWrap);
            this.$TableAction.appendTo(this.$TableTitle);
            //子表固定表头
            this.$TableHead = $('<div class="table-head">').appendTo(this.$TableWrap);
            this.$TableHeadBody = $('<div class="head-body">').appendTo(this.$TableHead);

            this.$TableFHeadBody = $('<div class="table-head fixed-table-head">').appendTo(this.$TableWrap);
            //解决Mac safari兼容性问题
            this.$TableContainer = $("<div></div>").append(this.$Table);
            //注：table-body 在子表隐藏和打印时有用到，修改时要同时修改
            this.$TableConBody = $('<div class="table-body" style="overflow:auto;">').append(this.$TableContainer);
            this.$TableCon = $('<div class="table-content" style="max-height:' + $(window).height() * 0.6 + 'px">')
                .append(this.$TableConBody).append(this.$TableFConBody).appendTo(this.$TableWrap);
            this.$TableFCon = $('<div class="table-content fixed-table-content" style="max-height:' + $(window).height() * 0.6 + 'px">')
                .appendTo(this.$TableWrap);

            this.$TableScrollWrap = $('<div class="table-scroll-wrap"></div>').appendTo(this.$TableWrap);
            this.$TableScroll = $('<div class="table-scroll">').appendTo(that.$TableScrollWrap);
            this.$TableScrollbar = $('<div class="table-scroll-bar">').appendTo(this.$TableScroll);
            this.$TableWrap.appendTo(this.Element);
            this.$Title = $("<span class='sheetName'>");
            this.$TableTitle.append(this.$Title.html(this.DisplayName));
            if (this.Required) {
                this.$Title.append("<span style='color:red;vertical-align:middle'>*<span>");
            }

            //模板行内容
            this.$TemplateRow = this.$Table.find("tr").clone();
            this.$TemplateRow.find("th").each(function () {
                var $td = $("<td>").html($(this).html());
                $td.find("div").removeClass("table_th").html("");
                $(this).before($td);
                $(this).remove();
            });

            if (this.Editable) {
                this.$Element.addClass("editable");
                this.$TableHead.addClass("table-edit");
                this.$TableCon.addClass("table-edit");
            }

            this.TrHeight = 0;
            //表格体
            this.$TableBody = $("<tbody>");
            this.$Table.removeClass("table-hover").append(this.$TableBody);

            this.initTheadOption();
        },

        Render: function () {
            var that = this;
            if (!this.Visible) this.$Element.hide();
            //对于可见的字段，添加是否打印属性
            if (this.Visible) {
                if (this.Printable == void 0) {
                    //如果字段没有设置是否可打印则默认可打印
                    this.$Element.attr('data-printable', true);
                } else {
                    this.$Element.attr('data-printable', this.Printable);
                }
            }

            if (this.Value && this.Value.R && this.Value.R.length > 0) {
                that.$loading = $('<div class="grid-loading">[' + that.DisplayName + ']数据加载中...</div>').appendTo(that.Element);
                that.SetValue(that.Value.R);
                that.$loading.remove();
            } else if (this.ResponseContext.IsCreateMode && this.Editable) {
                this.AddRow();
            } else {
                // that.AddRow();
                that.ClearRows();
            }

            this.IsFirstSetValue = false;

            //初始化固定标题及固定列
            this.FiexHeaderCol();

            //绑定事件
            this.BindEvent();
        },
        // 初始化子项
        initTheadOption: function () {
            var controls = this.Value.T;
            var datafieldMap = {};
            for (var key in controls) {
                this.theadRequired[key] = controls[key].Required;
                this.theadVisible[key] = controls[key].Visible;
            }
        },
        //赋值
        SetValue: function (dataArray) {
            if ($.isEmptyObject(dataArray)) return;
            for (var i = 0, dataLen = dataArray.length; i < dataLen; i++) {
                if (dataArray[i][this.DataField + ".ObjectId"].Value) {
                    this.AddRow(dataArray[i][this.DataField + ".ObjectId"].Value);
                }
                else {
                    this.AddRow(dataArray[i][this.DataField + ".ObjectId"], dataArray[i]);
                }
                //行数>1将DOM卸载出来，等子表渲染完后再操作
                if (i == 0 && dataLen > 1) {
                    this.$TableConBody.detach();
                }
            }
            if (dataLen > 1) {
                this.$TableCon.append(this.$TableConBody);
            }
        },

        GetValue: function () {
            var valArray = new Array();
            var $trs = this.$TableBody.find("tr");
            for (var i = 0; i < $trs.length; i++) {
                var $tr = $($trs[i]);
                var rObjectId = $tr.attr("data-ObjectId");
                if ($.isEmptyObject(rObjectId)) continue;

                var rowVal = {
                    ObjectId: rObjectId
                };
                var isNullRow = true;
                var controlVal = "";
                $tr.find("div[data-controlkey]").each(function () {
                    var manager = $(this).JControl();
                    var datafield = manager.DataField.split(".")[1];
                    //如果是关联属性控件不要保存
                    var sourceType = $(manager.Element).attr("data-sourcetype");
                    if (sourceType != undefined) {
                        return true;
                    }
                    if (manager instanceof $.Controls.FormUser
                        || manager instanceof $.Controls.FormMultiUser) {
                        controlVal = manager.GetUnitIDs();
                    } else {
                        controlVal = manager.GetValue();
                    }

                    if (manager instanceof $.Controls.FormAttachment
                        || manager instanceof $.Controls.FormPhoto) {
                        controlVal = manager.getEditValue();
                    }

                    if (!$.isEmptyObject(controlVal) || controlVal != "" || controlVal == false) {
                        isNullRow = false;
                    }

                    rowVal[datafield] = controlVal;
                });
                if (!isNullRow) {
                    valArray.push(rowVal);
                }
            }
            return valArray;
        },
        //绑定事件
        BindEvent: function () {
            var that = this;
            //按钮
            this.$TableAction.off("click.action").on("click.action", "a.action", function (e) {
                var action = $(this).data().type;
                if (action != "down" || action != "up") {
                    var isActive = $(this).hasClass("active");
                    if (!isActive) {
                        return;
                    }
                }
                switch (action) {
                    case "down":
                    case "up":
                        tableAction.showoff.apply(this);
                        break;
                    case "add":
                        tableAction.add.apply(this);
                        break;
                    case "copy":
                        tableAction.copy.apply(this);
                        break;
                    case "delete":
                        tableAction.delete.apply(this);
                        break;
                    case "adapteheight":
                        that.AdapteHeight.apply(that);
                        break;
                    case "adaptewidth":
                        //恢复默认列宽
                        that.AdapteWidth.apply(that);
                        break;
                }
            })
            var tableAction = {
                showoff: function () {
                    if ($(this).attr("type") === "up") {
                        that.$TableAction
                            .find('a[data-type="add"],a[data-type="adapteheight"],a[data-type="adaptewidth"]')
                            .addClass("active");
                        if (that.SelectedRow) {
                            that.$TableAction
                                .find('a[data-type="copy"],a[data-type="delete"]')
                                .addClass("active");
                        }
                        $(this).attr("type", "down").removeClass("flip");
                        that.$TableWrap.children("div:not(.table-tip)").slideDown(100);
                    } else {
                        that.$TableAction.find('a').removeClass("active");
                        $(this).addClass("active flip").attr("type", "up");
                        that.$TableWrap.children("div:not(.table-title)").slideUp(100);
                    }
                },
                add: function () {
                    setTimeout(function () {
                        if (that.SelectedRow) {
                            that.AddRow(null, null, that.SelectedRow.attr("data-ObjectId"));
                        } else {
                            that.AddRow();
                        }
                        that.ResizeSerialNo();
                    }, 0);
                },
                copy: function () {
                    if (!that.SelectedRow) {
                        alert("请选择要复制的行");
                        return;
                    }
                    setTimeout(function () {
                        that.AddRow(null, null, that.SelectedRow.attr("data-ObjectId"), that.SelectedRow);
                        that.ResizeSerialNo();
                    }, 0);
                },
                delete: function () {
                    if (!that.SelectedRow) {
                        alert("请选择要删除的行");
                        return;
                    }
                    setTimeout(function () {
                        var rowNum = that.SelectedRow.attr("data-row"),
                            nextRow = that.SelectedRow.next();

                        that.OnChange.apply(that, [that.SelectedRow, 'delete']);
                        // 将行中控件的ControlManager删除，避免验证不通过
                        var controlManagers = $.ControlManager.ControlManagers;
                        that.SelectedRow.find("div[data-controlkey]").each(function () {
                            for (var sheetId in controlManagers) {
                                if (sheetId == $(this).data($.ControlManager.SheetIDKey)) {
                                    delete controlManagers[sheetId];
                                    break;
                                }
                            }
                        });
                        that.SelectedRow.detach();

                        //删除固定列
                        var fixedRow = that.$TableFCon.find("tr[data-row='" + rowNum + "']"),
                            nextFixedRow = fixedRow.next();
                        fixedRow.remove();
                        //设置选择行
                        if (nextRow.length == 0) {
                            that.SelectedRow = null;
                            that.$TableAction.find('[data-type="delete"]').removeClass("active");
                            that.$TableAction.find('[data-type="copy"]').removeClass("active");
                        } else {
                            that.SelectedRow = nextRow;
                            that.SelectedRow.attr("data-checked", true);
                            nextFixedRow.attr("data-checked", true);
                        }

                        --that.RowCounts;
                        that.ResizeSerialNo();
                        if (rowNum == "1") {
                            that.FirstRowTd = that.$TableBody.find('tr:first').find('td');
                        }
                    }, 0);
                }
            }

            //监听子表中控件输入高度变化
            that.$Table.off("focus.height").on("focus.height", "[data-controlkey='FormTextBox'] textarea,[data-controlkey='FormTextArea'] textarea",
                function (e) {
                    if ($(this).val() == "") return true;
                    var data = $(this).data();
                    var h = $(this).closest("tr").height();
                    $(this).css({ "height": (this.scrollHeight - 15) + "px" });
                    var tr = $(this).closest("tr"), rowNum = tr.attr("data-row");
                    setTimeout(function () {
                        var h = tr.outerHeight();
                        that.$TableFCon.find("tbody tr[data-row='" + rowNum + "']").height(h);
                    }, 400);
                });
            that.$Table.off("blur.height").on("blur.height", "[data-controlkey='FormTextBox'] textarea,[data-controlkey='FormTextArea'] textarea",
                function (e) {
                    if ($(this).val() == "") return true;
                    var $input = this, tr = $(this).closest("tr"), rowNum = Number(tr.attr("data-row"));
                    if (!that.$Table.hasClass("adapteheight")) {
                        var controlkey = $(this).closest("[data-controlkey]").attr("data-controlkey");
                        if (controlkey == "FormTextArea") {
                            // fix: 多行输入框 focus和blur的时候宽高度会变动
                            // $(this).css({ "height": "auto" });
                        } else {
                            var h = that.rowHeight - 25 < 30 ? 30 : that.rowHeight - 25 > 110 ? 110 : that.rowHeight - 25;
                            $(this).css({ "height": h + "px" });
                        }
                    }
                    setTimeout(function () {
                        var h = tr.outerHeight();
                        that.$TableFCon.find("tbody tr[data-row='" + rowNum + "']").css({ "height": h + "px" });
                    }, 400);
                });
            that.$Table.off("keydown.input").on("keydown.input", "[data-controlkey='FormTextBox'] textarea,[data-controlkey='FormTextArea'] textarea",
                function () {
                    var input = this, tr = $(this).closest("tr"), rowNum = tr.attr("data-row");
                    setTimeout(function () {
                        var h = tr.outerHeight();
                        that.$TableFCon.find("tbody tr[data-row='" + rowNum + "']").height(h - 1);
                    }, 400);
                });
            //td点击事件，
            that.$Table.off("click.td").on("click.td", "td", function (e) {
                var target = e.target;
                if (target.tagName === "TD") {
                    e.stopPropagation();
                    var $td = $(this);
                    var input = $td.find("textarea,input");
                    if (input.length > 0) {
                        $(input[0]).focus();
                        return true;
                    }
                    var formQuery = $td.find(".form-query-add");
                    if (formQuery.length > 0) {
                        formQuery.trigger("click");
                    }
                }
            });

            //td点击事件，
            that.$Table.off("click.tr").on("click.tr", "tr", function (e) {
                if (that.SelectedRow) {
                    var rowNum = that.SelectedRow.attr("data-row");
                    that.SelectedRow.removeAttr("data-checked");
                    that.$TableFCon.find("tr[data-row='" + rowNum + "']").removeAttr("data-checked");
                }
                var fixedRow = $(this), rowNum = fixedRow.attr("data-row");
                fixedRow.attr("data-checked", true);
                that.SelectedRow = that.$TableBody.find("tr[data-row='" + rowNum + "']").attr("data-checked", true);
                that.$TableAction.find('[data-type="delete"]').addClass("active");
                that.$TableAction.find('[data-type="copy"]').addClass("active");
                e.stopPropagation();
            });

            that.row_modified = [];
            //监听FormAttachment、FormMultiUser、FormMultiUser,FormMultiQuery输入高度变化
            that.$Table.off("DOMSubtreeModified").on("DOMSubtreeModified", "[data-controlkey='FormAttachment'],[data-controlkey='FormMultiUser'],[data-controlkey='FormMultiUser'],[data-controlkey='FormMultiQuery'],[data-controlkey] pre", function (e) {
                //防止多次执行
                var rowNum = $(this).closest("tr").attr("data-row");
                that.row_modified.push(Number(rowNum));
                that.timer && window.clearTimeout(that.timer);
                that.timer = setTimeout(function () {
                    var len = that.row_modified.length;
                    if (len > 0) {
                        var arry = {};
                        for (var i = 0; i < len; i++) {
                            var rowNum = that.row_modified[i];
                            if (!arry[rowNum]) {
                                arry[rowNum] = 1;
                                var tr = that.$TableBody.find("tr[data-row='" + rowNum + "']"),
                                    h = tr.outerHeight();
                                that.$TableFCon.find("tbody tr[data-row='" + rowNum + "']").height(h);
                            }
                        }
                        that.row_modified = [];
                    }
                    clearTimeout(that.timer);
                }, 100);
            });


            that.BeforeScroll = that.$TableScroll.scrollLeft();
            that.rate = 0;

            if (that.Editable) {
                //处理tab键、input输入导致$TableConBody scroll
                $(that.$TableConBody).off('scroll.keydowm').on('scroll.keydowm', function (e) {
                    var left = that.$TableConBody.scrollLeft();
                    if (Math.abs(that.BeforeScroll - left) > 2) {
                        if (that.BeforeScroll != left) {
                            that.$TableHeadBody.scrollLeft(left);
                            that.$TableScroll.scrollLeft(left);
                            that.BeforeScroll = left;
                        }
                    }
                });
                //选中行-点序号选中
                that.$TableFCon.off("click.select").on("click.select", "tbody tr", function (e) {
                    if (that.SelectedRow) {
                        var rowNum = that.SelectedRow.attr("data-row");
                        that.SelectedRow.removeAttr("data-checked");
                        that.$TableFCon.find("tr[data-row='" + rowNum + "']").removeAttr("data-checked");
                    }
                    var fixedRow = $(this), rowNum = fixedRow.attr("data-row");
                    fixedRow.attr("data-checked", true);
                    that.SelectedRow = that.$TableBody.find("tr[data-row='" + rowNum + "']").attr("data-checked", true);
                    that.$TableAction.find('[data-type="delete"]').addClass("active");
                    that.$TableAction.find('[data-type="copy"]').addClass("active");
                    e.stopPropagation();
                });
                //取消选中行
                $(document).on("click.cancelSelect", function (e) {
                    if (that.SelectedRow) {
                        if ($(e.target).closest(".table-action").length == 1) return;
                        var rowNum = that.SelectedRow.attr("data-row");
                        that.SelectedRow.removeAttr("data-checked");
                        that.$TableFCon.find("tr[data-row='" + rowNum + "']").removeAttr("data-checked");
                        that.SelectedRow = null;
                        that.$TableAction.find('[data-type="delete"]').removeClass("active");
                        that.$TableAction.find('[data-type="copy"]').removeClass("active");
                    }
                });
                //序号列鼠标经过效果
                that.$TableFCon.off("mouseenter.tr").on("mouseenter.tr", "tbody tr", function (e) {
                    if (!$(this).attr("data-checked")) {//为选中
                        $(this).attr("data-checked", "mouseenter");
                        $(this).off("mouseleave.tr").on("mouseleave.tr", function (e) {
                            if ($(this).attr("data-checked") == "mouseenter") {
                                $(this).removeAttr("data-checked");
                            }
                        });
                    }
                });
                //必填验证失败，行高可能会改变
                $("#SheetContent").off("ValidateFail").on("ValidateFail", function () {
                    that.AdapteHeight.apply(that);
                });
            }
            //tips
            that.$TableBody.off("mouseenter.pre").on("mouseenter.pre", "pre", function (e) {
                var height = $(this).height(),
                    width = $(this).width(),
                    parentHeight = $(this).closest("[data-controlkey]").height();

                if (height > parentHeight) {
                    var tooltipText = this.innerText;
                    if (!that.Tips) {
                        that.Tips = $('<div class="table-tip" style="display: none;word-wrap: break-word"></div>').appendTo(that.$TableWrap);
                        that.Tips.text(tooltipText);
                    }

                    var offset = $(this).closest("[data-controlkey]").offset(),
                        left = offset.left + ($(this).outerWidth() - that.Tips.outerWidth()) / 2 - $(window).scrollLeft();
                    if (left < 80) {
                        left = 80;
                    } else {
                        var right = $(document).width() - left - width;
                        if (right < 0) {
                            left += right;
                        }
                    }
                    that.Tips.text(tooltipText).css({
                        width: width,
                        left: left,
                        bottom: $(window).height() - offset.top + $(window).scrollTop()
                    }).toggle();
                    $(this).off("mouseleave.pre").on("mouseleave.pre", function () {
                        that.Tips && that.Tips.hide();
                    })
                    return false;
                }
            })

            //x轴滚动
            that.$TableCon.unbind("scroll.xtablescroll").bind("scroll.xtablescroll", function (e) {
                var top = $(this).scrollTop();
                that.$TableFCon.scrollTop(top);
            });
            //y轴滚动
            that.$TableScroll.unbind("scroll.ytablescroll").bind("scroll.ytablescroll", function (e) {
                if (that.rate <= 0) {
                    if (!that.Editable) {
                        that.rate = 1;
                    } else {
                        that.rate = (that.$Table.outerWidth() - that.$TableConBody.outerWidth()) / (that.$TableScrollbar.outerWidth() - that.$TableScroll.outerWidth());
                        that.rate = that.rate == 0 ? 1 : that.rate;
                    }
                }
                var left = $(this).scrollLeft();
                if (that.BeforeScroll != left) {
                    left = that.rate * left;
                    that.$TableHeadBody.scrollLeft(left);
                    that.$TableConBody.scrollLeft(left);
                    that.BeforeScroll = left;
                    if (!that.Editable) {
                        that.$rcHandle.scrollLeft(left);
                        that.$rcHandle.css("left", -left);
                    }
                }
            });

            that.$Element.off("DomProChange.form").on("DomProChange.form", function (e, datafield, action) {
                setTimeout(function () {
                    that.SetColumnVisible.call(that, datafield, action);
                }, 0)
            });

            //表头拉伸
            if (!that.Editable) {
                that.$rcHandle.off("mousedown.resize").on("mousedown.resize", ".rc-handle", function (e) {
                    e.preventDefault();
                    var startX = e.pageX, x = 0,
                        $that = $(this),
                        pos = $that.offset().left - that.$rcHandle.offset().left,
                        tarIndex = parseInt($that.attr("data-index")),
                        $tarTh = $(that.$Element).find("#th_" + tarIndex),
                        $tarTd = $(that.$Element).find("#td_" + tarIndex),
                        startW = $tarTd.outerWidth(),
                        minW = that.ColMinWidth - startW,
                        totalWidth = that.$TableContainer.width(),
                        $nextTh = $(that.$Element).find("#th_" + (tarIndex + 1)),
                        $nextTd = $(that.$Element).find("#td_" + (tarIndex + 1)),
                        hasNext = false, nextW = 0;
                    $nextTh.length > 0 && (hasNext = true, nextW = $nextTd.outerWidth());

                    $(document).off("mousemove.resize").on("mousemove.resize", function (e) {
                        x = e.pageX - startX;
                        if (x < minW) return;
                        $that.css("left", pos + x);
                        //to do resize table
                        $tarTd.width(startW + x);
                        $tarTh.width(startW + x);
                        if (x > 0) {
                            that.$Table.outerWidth(totalWidth + x);
                            that.$TableContainer.outerWidth(totalWidth + x);
                        } else if (hasNext) {
                            $nextTh.width(nextW - x);
                            $nextTd.width(nextW - x);
                        }
                    });

                    $(document).off("mouseup.resize").on("mouseup.resize", function (e) {
                        $(this).off("mousemove.resize").off("mouseup.resize");
                        that.ResizeColumn.call(that);
                        that.AdapteHeight.call(that);
                    });

                    that.$Element.off("mouseleave.resize").on("mouseleave.resize", function (e) {
                        $(document).off("mousemove.resize").off("mouseup.resize");
                        that.$Element.off("mouseleave.resize");
                        that.ResizeColumn.call(that);
                        return false;
                    });
                })
            }
        },
        //添加行
        //propertySchemaCode参数是用于关联属性，标记关联属性关联的是哪个表单
        AddRow: function (ObjectId, RowData, PreObjectId, $PreTr, propertySchemaCode) {
            var that = this;
            var $newTr = this.$TemplateRow.clone().hide();
            ++this.RowCounts;
            //显示行序号
            if (this.ShowSerialNo) {
                $newTr.attr("data-row", this.RowCounts);
                $newTr.find("td:first div.SerialNo").html(this.RowCounts);
            }
            if (ObjectId) {
                $newTr.attr("data-ObjectId", ObjectId);
            }

            if ($newTr.find("td").length > 0) {
                if (PreObjectId) {
                    this.$TableBody.find("tr[data-ObjectId='" + PreObjectId + "']").after($newTr);
                }
                else {
                    this.$TableBody.append($newTr);
                }
                //如果td的display是none则$newTr的td也要设置display为none
                var $td;
                if (this.RowCounts == 1) {
                    $td = this.$TableBody.find('tr:first').find('td');
                    this.FirstRowTd = $td;
                } else {
                    $td = this.FirstRowTd;
                }
                for (var i = 0, len = $td.length; i < len; i++) {
                    if ($($td[i]).css('display') == 'none') {
                        $newTr.find('td').eq(i).css('display', 'none');
                    }
                }

                var ChildEditableInit = false;
                if (that.ChildEditable.length > 0) {
                    ChildEditableInit = true;
                }
                //初始化控件
                var newRowObj = {};
                $newTr.find("div[data-controlkey]").each(function (i) {
                    var key = $(this).attr("data-controlkey") + "：";
                    $(this).attr("data-row", this.RowCounts);
                    var $Controlmanger = $(this).JControl();
                    newRowObj[$Controlmanger.DataField] = $Controlmanger;
                    if (!ChildEditableInit) { //子表项可写，必填初始化
                        that.ChildRequired.push($Controlmanger.Required);
                        that.ChildEditable.push($Controlmanger.Editable);
                    }

                    if ($(this).attr("data-ismappingproperty") != undefined &&
                        $(this).attr("data-ismappingproperty") == "true" &&
                        propertySchemaCode != null) {
                        for (var property in propertySchemaCode) {
                            if (property == $Controlmanger.DataField) {
                                $Controlmanger.BOSchemaCode = propertySchemaCode[property];
                                break;
                            }
                        }
                    }
                    //Error在BaseControl中绑定过控件的change事件，这里重复绑定了
                    $Controlmanger.BindChange($.IGuid(), function () {
                        that.OnChange.apply(that, [$Controlmanger]);
                    });

                    //绑定Click事件【文本框，数值框】
                    if ($Controlmanger.BindClickEvent) {
                        that.ClickEvent && that.ClickEvent($Controlmanger);
                        //$Controlmanger.BindClickEvent(that.ClickEvent);
                    }

                    if (RowData != null) {

                        if (RowData[$Controlmanger.DataField] != null) {
                            $Controlmanger.SetValue(RowData[$Controlmanger.DataField]);
                        }
                    } else if ($PreTr != null) {
                        var $PreManager = $PreTr.find("div[data-DataField='" + $Controlmanger.DataField + "']").JControl();
                        var controlKey = $(this).attr("data-controlkey");
                        if (controlKey == "FormUser" || controlKey == "FormMultiUser") {
                            $Controlmanger.SetValue($PreManager.GetUnitIDs());
                        } else if (controlKey == "FormQuery") {
                            $Controlmanger.SetValue({
                                "ObjectId": $PreManager.GetValue(),
                                "Name": $PreManager.GetText()
                            });
                        } else if (controlKey == "FormMultiQuery") {
                            $Controlmanger.SetValue($PreManager.GetValue());
                        } else if (controlKey != "FormAttachment" && controlKey != "FormMap") { // 不复制附件,地图
                            $Controlmanger.SetValue($PreManager.GetValue());
                        }
                    }

                    if (!$Controlmanger.Visible) {
                        var DataField = $Controlmanger.DataField;
                        //原来是不可见的直接remove了，导致主表和子表不可见字段在参加计算规则时候不一致。20161129改成hide
                        //that.$TemplateRow.find("div[data-DataField='" + DataField + "']").parent().remove();
                        //that.$Table.find("tr").find("div[data-DataField='" + DataField + "']").parent().remove();
                        //$(this).parent().remove();
                        that.$TemplateRow.find("div[data-DataField='" + DataField + "']").parent().hide();
                        that.$Table.find("tr").find("div[data-DataField='" + DataField + "']").parent().hide();
                        $(this).parent().hide();
                    }

                    // 在子表的header里添加必填标识
                    // 初始化表格头时加 by zj
                    // if ($Controlmanger.Visible && $Controlmanger.Editable && $Controlmanger.Required) {
                    //     var $header = that.$Table.find(".table_th[data-datafield='" + $Controlmanger.DataField + "']");
                    //     if ($header.find(".required").length == 0) {
                    //         $header.append("<span class='required' style='color:red;vertical-align:middle'>*<span>");
                    //     }
                    // }
                });
                //非创建模式第一次setvalue不执行onchange
                var needDoChange = !(!this.ResponseContext.IsCreateMode && this.IsFirstSetValue);
                if (needDoChange) {
                    //this.OnChange.apply(this, [$newTr, 'add']);
                    this.OnChange.apply(this, [newRowObj, 'add']);
                }
            } else {
                $(this.Element).remove();
            }

            $newTr.show();
            this.FixedColeErrorRange = 0;
            //固定列处理
            if (!this.IsFirstSetValue) {
                var h = $newTr.height(),
                    id = $newTr.attr("data-objectid"),
                    fixedTr = $("<tr style='height:" + (h) + "px;'>").attr("data-row", this.RowCounts).attr("data-objectid", (id || "")),
                    fixedTd = $("<td><div class='row-num'>" + this.RowCounts + "</div><div class='diviser'></div></td>");
                fixedTr.append(fixedTd);
                if (PreObjectId) {
                    that.$TableFCon.find("tr[data-ObjectId='" + PreObjectId + "']").after(fixedTr);
                }
                else {
                    that.$TableFCon.find("tbody").append(fixedTr);
                }
            } else if (this.rowHeight == 0) {
                var h = $newTr.height();
                this.rowHeight = h;
            }

            //Error 临时解决方案
            //问题原因：子表字段根据主表字段计算得来，暂存后新增行的数据不会计算
            //渲染完控件后统一执行一次
            if (needDoChange) {
                $newTr.find("div[data-controlkey]").each(function () {
                    var key = $(this).attr('data-controlkey');
                    if (key == 'FormAttachment' || key == 'FormPhoto') {
                        return true;

                    }
                    var $ctrlMgr = $(this).JControl();
                    var eventName = 'change.cr.' + key;
                    if ($ctrlMgr != null) {
                        if ($ctrlMgr.DataItem != undefined) {
                            if ($ctrlMgr.DataItem.ComputationRule == undefined || $ctrlMgr.DataItem.ComputationRule == null) { return true; }
                            $("#navbar").css("pointer-events","none");
                            var ruleResult = $ctrlMgr.GetComputationResult($ctrlMgr.DataItem.ComputationRule, $ctrlMgr.DataItem.ComputationRuleFields);
                            $ctrlMgr.SetValue(ruleResult);
                            $("#navbar").css("pointer-events","auto");
                        }
                        //$ctrlMgr.OnChange();
                    }
                })
            }
        },
        //
        GetCellManager: function (objectId, dataField) {
            if (objectId == null || $.isEmptyObject(dataField)) return;
            var $tr = this.$TableBody.find("tr[data-ObjectId='" + objectId + "']");
            if ($tr.length > 0) {
                return $tr.find("[data-DataField='" + dataField + "']").JControl();
            }
        },

        UpdateRow: function (objectId, rowData) {
            if (objectId == null || $.isEmptyObject(rowData)) return;
            var $tr = this.$TableBody.find("tr[data-ObjectId='" + objectId + "']");
            if ($tr.length > 0) {
                for (var key in rowData) {
                    var control = $tr.find("[data-DataField='" + key + "']").JControl();
                    if (control != null) {
                        control.SetValue(rowData[key]);
                    }
                }
            }
        },

        ClearRows: function () {
            this.RowCounts = 0;
            this.$TableBody.find("tr[data-ObjectId]").remove();
            this.$TableFCon.find("tr[data-ObjectId]").remove();
            this.OnChange.apply(this, ["ClearRows"]);
        },
        // 数据验证
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            // 子表必填时，必需填写一行数据
            if (this.Required && val.length == 0) {
                this.AddInvalidText(this.$Table, "必填");
                return false;
            }

            this.RemoveInvalidText(this.$Table);
            return true;
        },
        //
        SaveDataField: function () {
            var result = {
            };
            if (!this.Visible) return result;
            var oldresult = $.extend({
            }, this.ResponseContext.ReturnData[this.DataField]);
            if (!oldresult) {
                return {
                };
            }
            var value = this.GetValue();
            if (oldresult.Value.R != value) {
                result[this.DataField] = value;
                return result;
            }
            return {
            };
        },
        //绑定click事件，参数rowid,controlmanager,
        //设置子表中的文本框，数值框的click事件
        BindClickEvent: function (clickFn) {
            if (this.ClickEvent) return;
            var that = this;
            this.ClickEvent = clickFn;
            //对已经渲染了的行控件
            var trs = $(that.Element).find("tr[data-objectid]");
            if (trs && trs.length > 0) {
                for (var i = 0; i < trs.length; i++) {
                    //初始化控件
                    $(trs).find("div[data-controlkey]").each(function (i) {
                        var key = $(this).attr("data-controlkey") + "：";
                        var $Controlmanger = $(this).JControl();
                        if ($Controlmanger.BindClickEvent) {
                            //绑定Click事件【文本框，数值框】
                            clickFn.apply(that, [$Controlmanger]);
                        }
                    });
                }
            }
        },
        //初始化固定表头，固定序号入口
        FiexHeaderCol: function () {
            var that = this;
            //1、计算子表宽度
            that.SetTableColWidth();
            //2、初始化固定标题
            that.ResetHeader();
            //3、初始化列宽拖拽功能
            if (!that.Editable) {
                that.ResizeColumn();
            }
            //4、初始化固定列
            setTimeout(function () {
                that.ResetCol();
            }, 300)
        },
        //调整滚动条
        ResetScroll: function () {
            if (!this.Editable || true) {
                var w1 = this.$TableBody.width();
                var w2 = this.$Element.width();
                if (w1 - 5 <= w2) { //误差[-5 ,5]
                    this.$TableScroll.hide();
                } else {
                    this.$TableScroll.show();
                }
            }
        },
        //计算子表宽度
        SetTableColWidth: function () {
            var that = this,
                pre = document.createElement("pre");//用于计算标题、内容的长度
            pre = $("<pre style='display:inline;'>");
            $("body").append(pre);
            this.colWidth = [];
            var tr_first = that.$TableBody.find("tr:first");

            //获取列默认宽度-控件可写默认宽度
            this.$Table.find("th").each(function () {
                if ($(this).find('div.SerialNo').length > 0) {
                    that.colWidth.push(40);
                    $(this).children("div").css("width", "40px");
                    return true;
                }
                var controlkey = $(this).find('[data-controlkey]').attr("data-controlkey"),
                    titleText = $(this).find("div").text(),
                    titleWidth = 0,  //标题最小宽度
                    defaultColWidth = 0;  //列默认宽度
                pre.text(titleText);
                titleWidth = pre.outerWidth() + 5;
                switch (controlkey) {
                    case "FormTextBox":
                    case "FormTextArea":
                    case "FormDropDownList":
                    case "FormUser":
                    case "FormFormula":
                        defaultColWidth = 150;
                        break;
                    case "FormMultiUser":
                        defaultColWidth = 180;
                        break;
                    case "FormDateTime":
                        defaultColWidth = 200;
                        break;
                    case "FormNumber":
                        defaultColWidth = 100;
                        break;
                    case "FormRadioButtonList":
                    case "FormCheckboxList":
                        defaultColWidth = 160;
                        break;
                    case "FormCheckbox":
                        defaultColWidth = 80;
                        break;
                    case "FormAttachment":
                        defaultColWidth = 360;
                        break;
                    case "FormAreaSelect":
                        defaultColWidth = 300;
                        break;
                    case "FormQuery":
                    case "FormMultiQuery":
                        defaultColWidth = 250;
                        break;
                    default:
                        defaultColWidth = 200;
                        break;
                }
                defaultColWidth = titleWidth > defaultColWidth ? titleWidth : defaultColWidth;
                that.colWidth.push(defaultColWidth);
                $(this).children("div").css("width", defaultColWidth + "px");
            });
            this.$Table.width(eval(this.colWidth.join("+")));

            //根据内容重新获取适应宽度，同时
            var preColWidth = this.colWidth;
            if (tr_first.length > 0) {
                this.colWidth = [];
                that.colWidth.push(40);
                //获取每一列最大宽度
                that.$TableBody.find("tr:first div[data-controlkey]").each(function (index) {
                    var controlkey = $(this).attr("data-controlkey"),
                        datafield = $(this).attr("data-datafield"),
                        ctr = $(this).JControl();
                    //列所有控件
                    var td_div = that.$TableBody.find("[data-datafield='" + datafield + "']");
                    if (ctr.Editable && $(this).is(":visible")) {
                        that.colWidth.push(preColWidth[index + 1]);
                        td_div.each(function () {
                            $(this).addClass("editable");
                            if (ctr.Required) {
                                $(this).parent().addClass("required");
                            }

                            $(this).css({ "width": (that.colWidth[index + 1]) + "px" });
                            if (controlkey == "FormTextArea") {
                                var input = $(this).find(".form-control"),
                                    h = input.height();
                                input.height(h - 4);
                                input.data().oHeight = h;
                            } else if (controlkey == "FormTextBox" && that.rowHeight > 60) {
                                var input = $(this).find(".form-control"),
                                    h = that.rowHeight - 30 > 110 ? 110 : that.rowHeight - 30;
                                input.outerHeight(h);
                            }
                        })
                        return true;
                    } else if (!$(this).is(":visible")) {
                        that.colWidth.push(preColWidth[index + 1]);
                        $(this).css({ "width": (that.colWidth[index + 1]) + "px" });
                        return true;
                    }
                    // ------不可编辑且可见------
                    //循环列，判断每列的最大宽度，和控件最大最小宽度以及标题宽度比较，取合适值
                    var thisHeader = that.$Table.find("thead [data-datafield='" + datafield + "']");
                    var text = thisHeader.text().trim();
                    pre.text(text);
                    var maxwidth = 0,
                        titleWidth = pre.outerWidth() + 70;

                    td_div.each(function () {
                        text = $(this).find("pre").text();
                        pre.text(text);
                        maxwidth = maxwidth > (pre.outerWidth() + 70) ? maxwidth : pre.outerWidth() + 70;
                    });
                    switch (controlkey) {
                        case "FormTextBox":
                        case "FormTextArea":
                            if (maxwidth > 400) {
                                maxwidth = 400;
                            }
                            break;
                        case "FormDateTime":
                            if (maxwidth > 200) {
                                maxwidth = 200;
                            }
                            break;
                        case "FormNumber":
                            if (maxwidth > 300) {
                                maxwidth = 300;
                            }
                            break;
                        case "FormRadioButtonList":
                        case "FormCheckboxList":
                            if (maxwidth > 220) {
                                maxwidth = 220;
                            }
                            break;
                        case "FormCheckbox":
                            if (maxwidth > 220) {
                                maxwidth = 220;
                            }
                            break;
                        case "FormDropDownList":
                        case "FormUser":
                        case "FormMultiUser":
                        case "FormQuery":
                        case "FormFormula":
                            if (maxwidth > 300) {
                                maxwidth = 300;
                            }
                            break;
                        case "FormMultiQuery":
                            maxwidth = 300;
                            break;
                        case "FormAttachment":
                            maxwidth = 360;
                            break;
                        case "FormAreaSelect":
                            maxwidth = 300;
                            break;
                        case "FormFolder":
                            maxwidth = 200;
                            break;
                    }
                    maxwidth = maxwidth < titleWidth ? titleWidth : maxwidth;
                    that.colWidth.push(maxwidth);

                    //设置列宽
                    td_div.each(function () {
                        if (that.Editable) {
                            $(this).parent().css({ "width": (maxwidth) + "px" });
                        }
                        thisHeader.css({ "width": (maxwidth) + "px" });
                        $(this).parent().addClass("no-editable");
                        $(this).removeAttr("style").css({ "min-width": maxwidth + "px" });
                    });

                });
                that.$Table.width(eval(that.colWidth.join("+")));
                that.$TableContainer.width(eval(that.colWidth.join("+")));
            }
            pre.remove();
        },
        //初始化固定标题
        ResetHeader: function () {
            var that = this;
            that.$TableConBody.css("overflow", "hidden");
            that.$FixedHeader = $('<table class="gridFixedH" border="1"><thead>');
            var tr = $("<tr style='height:29px;'>");
            that.$Table.find("thead").show();

            //子表隐藏时下面的width计算会有问题
            var ElementHide = false;
            if ($(that.Element).css("display") == "none") {
                $(that.Element).show();
                ElementHide = true;
            }
            //-----
            var totalWidth = 0;
            var colNum = 0;
            //------
            // 必填项修改 by zj
            that.$Table.children("thead").find("th").each(function (index) {
                var datafield = $(this).children("div.table_th").attr("data-datafield");
                var html = $(this).children("div.table_th").html();
                var w = that.colWidth[index];
                var isRequired = that.theadRequired[datafield];
                if (index == 0 || that.theadVisible[datafield]) {
                    var th = $("<th  style='height:20px;line-height:20px; '>")
                        .html("<div style='width:" + (w - 0) + "px;'>" + html + `${isRequired ? '<span style="color:red;vertical-align:middle;">*<span></span></span>' : ''}` + "</div>");

                    //----
                    if (!$(this).is(":visible")) {
                        th.hide();
                    } else {
                        totalWidth += w;
                    }
                    th.attr('data-datafield', datafield);
                    tr.append(th);
                }
            });
            that.$FixedHeader.find("thead").append(tr);
            that.$TableHeadBody.append(that.$FixedHeader);

            that.$Table.width(totalWidth);
            that.$TableScrollbar.width(totalWidth);
            that.ResetScroll();
            //模板宽度计算
            that.ResizeTemplateRow(that.colWidth);
            if (ElementHide) {
                $(that.Element).hide();
            }
        },
        //初始化固定列
        ResetCol: function () {
            var that = this;
            var header = this.$FixedHeader.clone();
            header.removeAttr("border").css({ "width": "40px" }).find("th").remove();
            header.find("tr").css({ "width": "40px" }).append($("<th style='height: 27px; line-height: 27px;'>序号</th>"));
            this.$TableFHeadBody.append(header);
            that.$TableFCon.append($("<table><tbody></tbody></table>"));
            this.$TableBody.find("tr[data-row]").each(function (index) {
                var h = $(this).height();
                var fixedTr = $("<tr style='height:" + h + "px;'>").attr("data-row", (index + 1)).attr("data-objectid", $(this).attr("data-objectid")),
                    fixedTd = $("<td><div class='row-num'>" + (index + 1) + "</div><div class='diviser'></div></td>");
                fixedTr.append(fixedTd);
                that.$TableFCon.find("tbody").append(fixedTr);
            });
        },
        //固定表头重计算
        ResizeColumn: function (colWidth) {
            var that = this, totalWidth = 0, trindex = 1, maxH = $(window).height() * 0.6 + 34,
                $firstTr = that.$Table.children("thead").children("tr").eq(0);
            that.$rcHandle.html("");
            if (that.$FixedHeader == undefined) {
                return;
            }
            if (this.ShowSerialNo) {
                totalWidth = 40;
            }
            var header = that.$Table.find("thead th");
            //重新计算表头的宽度
            that.$FixedHeader.find("th").each(function (index) {
                var $that = $(this);
                if ($that.is(":visible")) {
                    $that.attr("data-tar", "#rc_" + trindex).children("div").attr("id", "th_" + trindex);
                    var datafield = $that.attr("data-datafield");
                    if (datafield) {
                        var td = $($firstTr.find("th")[index]).attr("id", "td_" + trindex);;
                        if (td.length > 0) {
                            var w = colWidth ? colWidth[index] : td.outerWidth();
                            w = td.outerWidth();
                            totalWidth += w;
                            if (that.Editable) {
                                $that.children("div").width(w - 1);
                            } else {
                                $that.children("div").width(w - 1);
                            }
                        }
                        if (!that.Editable) {
                            that.$rcHandle.append('<div id="rc_' + trindex + '" class="rc-handle" data-index="' + trindex + '" style="left:' + (totalWidth - 3) + 'px;height:' + maxH + 'px;">');
                        }
                    }
                    trindex++;
                }
            });
            this.$FixedHeader.width(totalWidth);
            this.$TableContainer.width(totalWidth);
            this.$TableScrollbar.width(totalWidth);
            that.ResetScroll();
        },
        //模板宽度计算
        ResizeTemplateRow: function (colWidth) {
            var that = this;
            //更新第一列
            this.$TableBody.find("tr:first>td").each(function (index) {
                var width = colWidth[index];
                if (that.Editable) {
                    $(this).css({ "min-width": "auto", "padding": 0 });
                    $(this).children("div.sheet-control").css({ "min-width": width + "px" });
                }
            });
            //更新模板
            $(this.$TemplateRow[0]).find("td").each(function (index) {
                if (that.Editable) {
                    var width = colWidth[index] ? colWidth[index] : 200;
                    $(this).css({ "min-width": "auto", "padding": 0 });
                    $(this).children("div.sheet-control").css("width", (width) + "px");
                }
                if (that.ChildEditable && index > 0) {
                    var editable = that.ChildEditable[index - 1];
                    if (!editable) {
                        $(this).addClass("no-editable");
                    }
                }
            });
        },
        //重置行号
        ResizeSerialNo: function () {
            var that = this;
            var fixedTd = this.$TableFCon.find("td");
            this.$TableBody.find("tr[data-row]").each(function (index) {
                $(this).attr("data-row", index + 1);
                $(this).find("td>div.row-num").html(index + 1);
                $(fixedTd[index]).find(".row-num").html(index + 1).closest("tr").attr("data-row", index + 1);
            });
        },
        //自适应高度
        AdapteHeight: function (reset) {
            var that = this;
            var setAdapte = true;//设置自适应高度？
            if (reset) {
                setAdapte = false;
            }
            else {
                if (that.$Table.hasClass("adapteheight")) {
                    that.$Table.removeClass("adapteheight");
                    setAdapte = false;
                } else {
                    that.$Table.addClass("adapteheight");
                }
            }
            if (that.Editable) {
                //1、遍历子表中的单行，多行文本与当前高度比较（单选,多选，多人，关联多选，附件后期根据需要考虑）
                var fixedTr = that.$TableFCon.find("tr");
                that.$TableBody.find("tr[data-row]").each(
                    function (trindex) {
                        var height = [];
                        var StandardHeight = 32;
                        $(this).find("[data-controlkey]").each(function () {
                            var controlkey = $(this).attr("data-controlkey"),
                                control = $(this).JControl();
                            if (control.Editable) {
                                switch (controlkey) {
                                    case "FormTextBox":
                                        //标准高度32px
                                        if (!setAdapte) {
                                            var c = $(this).JControl(),
                                                h = that.rowHeight - 25 < StandardHeight ? StandardHeight : that.rowHeight - 25 > 110 ? 110 : that.rowHeight - 25;
                                            c.$Input.css({ "height": h + "px" });
                                        } else {
                                            var c = $(this).JControl(),
                                                h = c.$Input[0].scrollHeight,
                                                h = h < StandardHeight ? StandardHeight : h;
                                            height.push(h);
                                            c.$Input.css({ "height": (h - 5 < StandardHeight ? StandardHeight : h - 5) + "px" });
                                        }
                                        break;
                                    case "FormTextArea":
                                        if (!setAdapte) {
                                            var c = $(this).JControl();
                                            c.$Input.css({ "height": "auto" });
                                        } else {
                                            var c = $(this).JControl(),
                                                h = c.$Input[0].scrollHeight;
                                            height.push(h);
                                            c.$Input.css({ "height": h + "px" });
                                        }
                                        break;
                                }
                            } else {
                                height.push($(this).find("pre").height() + 25);
                            }
                        });
                        if (setAdapte) {
                            if (height.length > 0) {
                                var maxHeight = Math.max.apply({}, height);
                                $(this).height(maxHeight);
                            }
                        } else {
                            $(this).height(0);
                        }
                        var this_tr = this;
                        setTimeout(function () {
                            var h = $(this_tr).height();
                            $(fixedTr[trindex]).css({ "height": h + "px" });
                        }, 310);
                    })
            }
            else {
                var fixedTr = that.$TableFCon.find("tr");
                that.$TableBody.find("tr[data-row]").each(function (index) {
                    var h = $(this).height();
                    if (index == 0) h -= 1;
                    $(fixedTr[index]).css({ "height": h + "px" })
                });
            }
            if (that.timer) {
                clearInterval(that.timer);
            }
            var timesSum = 0;
            that.timer = window.setInterval(function () {
                timesSum++;
                //修正高度变化导致固定序号和子表行不一致
                var top = that.$TableCon.scrollTop();
                that.$TableFCon.scrollTop(top);
                if (timesSum > 10) {
                    window.clearInterval(that.timer);
                }
            }, 200);
        },
        //重置宽度
        AdapteWidth: function () {
            var that = this, col = 0;
            that.$Table.find("thead").find("tr th").each(function (index) {
                var width = that.colWidth[index];
                $(this).css({ "width": width + "px" });
                if ($(this).is(":visible")) {
                    col += width;
                }
            });
            that.$Table.width(col);
            that.ResizeColumn();
            that.AdapteHeight(true);
        },
        //action:hide隐藏，否则显示
        SetColumnVisible: function (datafield, action) {
            var that = this;
            that.rate = 0;
            if (that.$FixedHeader) {
                var $fixedTh = that.$FixedHeader.find("th[data-datafield='" + datafield + "']");
                var $th = that.$Table.find("th div[data-datafield='" + datafield + "']").parent("th");
                if ($fixedTh.length > 0 && $th.length > 0) {
                    if (action === "hide") {
                        if ($fixedTh.css("display") != "none") {
                            var width = that.$FixedHeader.width() - $fixedTh.outerWidth();
                            $fixedTh.hide();
                            that.$Table.find("tr td [data-datafield='" + datafield + "']").parent().hide();
                            $th.hide();
                            that.$FixedHeader.width(width);
                            that.$Table.width(width);
                            that.$TableContainer.width(width);
                            //width = that.$Table.width();
                            that.$TableScrollbar.width(width);
                        }
                    } else {
                        if ($fixedTh.css("display") == "none") {
                            $fixedTh.show();
                            var width = that.$FixedHeader.width();
                            that.$FixedHeader.width(width);
                            that.$Table.width(width);
                            that.$TableContainer.width(width);
                            that.$TableScrollbar.width(width);
                        }
                        that.$Table.find("tr td [data-datafield='" + datafield + "']").parent().show();
                        $th.show();
                    }
                }
            }
            else {
                var $th = that.$Table.find("thead").find("th[data-datafield='" + datafield + "']");
                action === "hide" ? $th.hide() : $th.show();
                var w = that.$Table.width();
                that.$TableScrollbar.width(w);
                that.ResetScroll();
            }
            that.timer && window.clearTimeout(that.timer);
            that.timer = setTimeout(function () {
                that.ResetScroll();
                that.AdapteHeight(true);
            }, 100);
        }
    });
})(jQuery);

//城市选择
(function ($) {

    $.fn.FormCitySelect = function () {
        return $.ControlManager.Run.call(this, "FormCitySelect", arguments);
    };

    // 构造函数
    $.Controls.FormCitySelect = function (element, ptions, sheetInfo) {



        // 添加的城市
        this.saveVal = [];

        this.SchemaCode = "";

        $.Controls.FormCitySelect.Base.constructor.call(this, element, ptions, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormCitySelect.Inherit($.Controls.BaseControl, {
        Render: function () {
            if (!this.Visible) { $(this.Element).hide(); return; }


            if (this.ResponseContext && this.ResponseContext.IsCreateMode) {
                if (this.ResponseContext.IsDraft) {
                    this.getCityValue();
                }
            }
            else {

                this.getCityValue();

            }
            this.HtmlRender();
            if (this.Value) {
                this.SetValue(this.Value)
            }

            //不可用
            if (!this.Editable) {
                this.SetReadonly(true);
            }



        },

        getCityValue() {
            if (this.Value && this.Value.length > 0) {
                var param = [];
                for (var i = 0; i < this.Value.length; i++) {
                    this.saveVal.push({
                        id: this.Value[i].Code,
                        crumbs: this.Value[i].Url,
                        name: this.Value[i].Name

                    })
                }
            }

        },

        SetValue: function (v) {
            if (v == null) return;
            //if (this.GetValue() != "" && this.GetValue() == v) return;



            if (!this.Editable) {
                if (!this.Visible) {
                    this.Value = v;
                    return;
                }
                this.$Input.html(this.Value);
                $(this.$Input).val(v);
            }
            else {
                this.Value = v;
                $(this.$Input).val(v);
            }
            // this.ValChange();    
        },
        validateCity() {

        },

        ClearValue: function () {
            this.Value = null
        },


        SaveDataField: function () {
            var result = {};
            // if (!this.Visible) return result;
            result[this.DataField] = this.GetValue();
            return result;
        },

        GetValue: function () {
            if (!this.Editable) {
                var v = this.Value;
                return v == null ? "" : v;
            }
            else {
                if (this.$Input != void 0) {
                    return this.$Input.val().trim();
                } else {
                    return this.Value || '';
                }
            }

        },


        HtmlRender: function () {
            //设置宽度

            var that = this;
            $(this.Element).addClass('SheetQuery');
            if (!this.Editable) {
                this.$Input = $('<pre style="border:none;white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;word-break:break-all">');
                this.$InputBody.append(this.$Input)
            } else {
                this.ID = "FormQuery_" + $.IGuid();
                //this.$addModel = $("<a class='form-query-addModel icon-newsvg'></a>");
                this.$Input = $("<input  id='CitySelect' class='form-control form-query-add' autocomplete='off' placeholder='点击选择城市'>");
                this.$Input.kuCity(this);
                this.$InputBody.css({ 'position': 'relative', 'min-width': '210px' });
                this.$InputBody.append(this.$Input)
                //控件渲染改到点击时处理
                //setTimeout(that._renderDropDown(that), 0);//渲染下拉
                //setTimeout(that._renderModal(that), 0);//渲染模态框
            }

        },


        BindEvent: function () {
            var that = this;
            // this.$Input.one("click", function (e) {
            //     that._renderModal(that);
            //     that.$Input.trigger("click");
            // });
            // // this.$Input.one("click", function (e) {
            //     that._renderDropDown(that);
            //     that.$Input.trigger("click");
            // });
        },

        getCurrentValue: function () {
            var _this = this;
            // var savedVal = $('#field-dept').val().split(';');
            var filterJson = [];
            // for(var i=0; i<savedVal.length; i++) {
            //     (function(i){
            //         filterDataList.forEach(function(item, index){
            //             if(item.id == savedVal[i]) {
            //                 return filterJson.push(item);
            //             };
            //         });
            //     })(i);
            // };

            var saveVal = filterJson;
            //_this.renderOut(saveVal);
            return saveVal;
        },
        selectCity(value) {
            var that = this;
            if (true) {//选中

                var link = '<a href="javascript:;" class="label label-info" style="background-color:#e2f0ff; color:#38ADFF;padding:0 6px 0 6px;position:relative;" title="' + value + '">' + value + '<i class="fa icon-close-middle" style="margin-left:5px;">x</i></a>';

                //添加时清空空的链接
                if ($.trim(that.$Input.text().length > 0)) {
                    that.$Input.text("").append(link);
                } else {
                    that.$Input.append(link);
                }


            } else {//取消选中

            }
            that.SetValue(value);

            //that.$Input.data('ObjectId', objectIds);
            that.$Input.find('i').on('click', function () {
                var $this = $(this);
                $this.closest('a').remove();

                that.SetValue("");
            });
        },
        inArray: function (id) {
            var ret = false;
            var obj = this.AddAttachments
            for (var key in obj) {
                //只遍历对象自身的属性，而不包含继承于原型链上的属性。  
                if (obj.hasOwnProperty(key) === true) {
                    if (obj[key].file.id == id) {
                        ret = true
                        continue
                    }

                }
            }

            return ret;
        },
        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("readonly", "readonly");
            }
            else {
                this.$Input.removeProp("readonly");
            }
        },

    });
})(jQuery);;
;

//文档库
(function ($) {

    $.fn.FormFolder = function () {
        return $.ControlManager.Run.call(this, "FormFolder", arguments);
    };

    // 构造函数
    $.Controls.FormFolder = function (element, ptions, sheetInfo) {

        this.SheetAttachmentHandler = axios.defaults.baseURL + "/Form/SheetAttachmentAction/";
        //上传控件
        this.FolderFile = $("<input type='file' data-attachment='true' multiple='multiple' style='display:none;'/>");
        //文件数
        this.Files = 0;
        // 添加的文件
        this.saveVal = [];
        //新添加的
        this.AddAttachments = {};
        //删除数据库的
        this.RomveAttachments = [];
        //异步数据
        this.XHRJson = {};
        //数据模型编码
        this.SchemaCode = "";

        $.Controls.FormFolder.Base.constructor.call(this, element, ptions, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormFolder.Inherit($.Controls.BaseControl, {
        Render: function () {
            if (!this.Visible) { $(this.Element).hide(); return; }
            //图片类后缀
            this.ImageFileExtension = ['.jpeg', '.jpg', '.png', '.gif', '.bmp'];
            //文档
            this.DocFileExtension = ['.doc', '.docx', '.ppt', '.pptx', '.xls', '.xlsx', '.pdf', '.txt'];
            if (this.MaxUploadSize == 0) {
                this.MaxUploadSize = 10;
            }

            var sharingKey = $.IQuery("SharingKey");
            var engineCode = $.IQuery("EngineCode");
            this.$body = '';
            this.filterDataList = [];
            this.saveVal = [];
            this.allLoadData = [];
            this.orgZTree;
            this.allJson = '';

            if (this.ResponseContext && this.ResponseContext.IsCreateMode) {
                if (this.ResponseContext.IsDraft) {
                    this.getFileValue();
                }
            }
            else {

                this.getFileValue();

            }
            
            HTTP.subFiles(this.FolderName?this.FolderName:"-1").then((data) => {
                if (data.code == 0) {
                    this.allJson = data
                    this.SheetAttachmentHandler += "?SchemaCode=" + encodeURI(this.SchemaCode) + "&SharingKey=" + sharingKey + "&EngineCode=" + engineCode + "&MaxSize=" + this.MaxUploadSize + "&BizObjectId=" + $.SmartForm.ResponseContext.BizObjectId + "&FileID=";
                    this.HtmlRender();
                    //初始化数据
                    this.InitValue();
                }
                else {
                    Message.error({
                        content: "获取文件库失败",
                        duration: 3
                    });
                }
            })


        },

        getFileValue() {
            if (this.Value && this.Value.length > 0) {
                var param = [];
                for (var i = 0; i < this.Value.length; i++) {
                    this.saveVal.push({
                        id: this.Value[i].Code,
                        crumbs: this.Value[i].Url,
                        name: this.Value[i].Name

                    })
                }
            }

        },

        SetValue: function () {
            //$.IShowError("附件不支持SetValue");
            Message.error({
                content: "附件不支持SetValue",
                duration: 3
            });
        },

        ClearValue: function () {
            this.ClearFiles();
        },

        //初始化已上传文件
        InitValue: function () {
            if (this.Value) {
                //子表编辑时
                if (this.BizObjectId == void 0) {
                    this.BizObjectId = this.ResponseContext.BizObjectId;
                }
                try {
                    var tmp = this.Value
                    this.Value = JSON.parse(this.Value);
                }
                catch (e) {
                    this.Value = tmp;
                }

                for (var i = 0; i < this.Value.length; ++i) {
                    this.CreateFileElement2(this.Value[i].Code, this.Value[i].Name, this.Value[i].Size, axios.defaults.baseURL + this.Value[i].Url, this.Value[i].ThumbnailUrl, this.Value[i].Description);
                }
            }
        },
        // 数据验证
        Validate: function (actionName) {
            if (!this.Editable) return true;
            // 修改
            // if (actionName != $.SmartForm.Action_Save && actionName == $.SmartForm.Action_Modify && this.Required && this.Files < 1) {
            // 必填项判断 by zj 
            if (actionName != $.SmartForm.Action_Save && this.Required && this.saveVal.length < 1) {
                this.AddInvalidText(this.$ActionPanel, "必填");
                return false;
            }

            //如果是支持Html5的话，得判断是否已经上传完整，需要等待
            for (var key in this.AddAttachments) {
                if (this.AddAttachments[key].state == 0) {
                    this.AddInvalidText(this.$ActionPanel, "未上传完!");
                    return false;
                }
            }

            this.RemoveInvalidText(this.$ActionPanel);
            return true;
        },

        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;
            result[this.DataField] = this.GetValue();
            return result;
        },

        GetValue: function () {
            // 
            var AttachmentIds = "";
            var result = '';
            if (this.ResponseContext && this.ResponseContext.IsCreateMode) {
                for (var key in this.AddAttachments) {
                    if (this.AddAttachments[key].state == 1 && this.AddAttachments[key].file.id) {
                        result += this.AddAttachments[key].file.id + ';'
                    }
                }
            }
            else {
                for (var key in this.Value) {
                    if (this.Value[key].Code) {
                        result += this.Value[key].Code + ';'
                    }
                    else if (this.Value[key].id) {
                        result += this.Value[key].id + ';'
                    }
                }

            }


            // var DelAttachmentIds = "";
            // for (var i = 0; i < this.RomveAttachments.length; ++i) {
            //     DelAttachmentIds += this.RomveAttachments[i] + ";";
            // }
            // var result = {
            //     AttachmentIds: AttachmentIds,
            //     DelAttachmentIds: DelAttachmentIds
            // };
            return result;
        },

        getEditValue: function () {
            let result = [...this.Value];
            let addValue = this.GetValue();
            this.RomveAttachments.forEach(fileId => {
                result.some((item, index) => {
                    if (item.Code === fileId) {
                        result.splice(index, 1);
                        return true
                    }
                    return false;
                })
            })
            return [...result, ...addValue];
        },

        GetText: function () {
            return this.Files;
        },

        ClearFiles: function () {
            var that = this;
            this.UploadList.find("tr").each(function () {
                that.RemoveFile($(this).attr("id"));
            });
        },

        HtmlRender: function () {
            //设置宽度

            var that = this;
            this.$Element = $(this.Element).addClass("SheetAttachment");
            var $broad = $('<div style="border: 1px solid #d7d5d5; "></div>')

            //添加附件展示列表和按钮
            this.UploadList = $("<table class='table table-striped form-attachment-container' style='margin:0;min-height:0;width:100%;'></table>");

            $broad.append(this.UploadList)
            if (!this.Editable) {
                this.$InputBody.append($broad);
                return;
            }
            this.$ActionPanel = $("<div class='btn btn-outline btn-lg ' style='width:100%;'><i class='attach-plus'></i>点击选择文件</div>");
            $broad.append(this.$ActionPanel)

            this.$InputBody.append($broad);
            //添加上传控件
            this.filterDataList = this.filterDataSloveList(this.allJson.info);
            // 页面进入渲染
            this.getCurrentValue();

            if (true) {
                //全部开启
                this.allLoadData = this.dataSolve(this.allJson.info);  //进行数据处理
            };

            this.$ActionPanel.off("click.FormFolder").on("click.FormFolder", this, function (e) {
                $.extend(this, e.data);
                if (this.$Element.data($.ControlManager.DataFieldKey.toLowerCase()) != this.DataField) return;
                //this.FolderFile.click();

                that._renderFolderModal.apply(that);
                that.$ActionPanel.trigger("click");
            });


            this.FolderFile.off("change.FolderFile").on("change.FolderFile", this, function (e) {

                that._renderFolderModal.apply(this);
                this.$ActionPanel.trigger("click");

            });

        },


        filterDataSloveList: function (data) {

            var _this = this;

            var treeNode = _this.dataSolve(data);
            var filterResult = [];
            function filterTree(fNode, dataNode) {
                dataNode.forEach(function (aDate) {
                    fNode.push({
                        id: aDate.id,
                        name: aDate.name,
                        crumbs: aDate.crumbs
                    });
                    if (aDate.children) {
                        filterTree(fNode, aDate.children)
                    }
                });
            };
            filterTree(filterResult, treeNode);
            function unique(arr) {
                var ret = [];
                for (var i = 0, j = arr.length; i < j; i++) {
                    if (ret.indexOf(arr[i].id) === -1) {
                        ret.push(arr[i]);
                    };
                };
                return ret;
            }
            var nodeResult = unique(filterResult);

            return nodeResult;
        },
        loadAll: function (ele, data) {

            var _this = this;
            var $ele = $(ele);
            _this.orgZTree = $.fn.zTree.init($ele, {
                view: {
                    dblClickExpand: false,
                    selectedMulti: false,
                    showLine: false,
                    addHoverDom: addHoverDom,
                    removeHoverDom: removeHoverDom,
                    addDiyDom: addDiyDom
                },
                data: {
                    key: {
                        isParent: "isParent"
                    }
                },
                callback: {
                    onExpand: function (event, treeId, treeNode) {
                        var param = { parFileId: treeNode.id, key: true };
                        var parentZNode = _this.orgZTree.getNodeByParam("id", treeNode.id, null);//获取指定父节点
                        var childNodes = _this.orgZTree.transformToArray(treeNode);//获取子节点集合
                        //因为子节点还包括组织，所以这里需要筛选一下
                        // console.log(childNodes);
                        var key = false;
                        if (parentZNode.children.length > 0) {//如果当前组织有终端 就不再加载
                            key = true;
                        }
                        if (!key) {//如果不存在  就加载(第一次加载)
                            HTTP.subFiles(treeNode.id).then((tmp) => {
                                var data = tmp.info || []
                                var zNode = [];

                                data.forEach(function (aDate) {
                                    var thisNode = {
                                        id: aDate.fileId,
                                        name: aDate.fileName,
                                        parentId: aDate.parFileId,
                                        crumbs: aDate.path,
                                        type: aDate.type,
                                        isParent: true,
                                        children: []
                                    };
                                    var noChildNode = {
                                        id: aDate.fileId,
                                        name: aDate.fileName,
                                        parentId: aDate.parFileId,
                                        type: aDate.type,
                                        isParent: false,
                                        crumbs: aDate.path,
                                    };
                                    if (aDate.type == 1) {
                                        zNode.unshift(thisNode);
                                    } else {
                                        zNode.push(noChildNode);
                                    };
                                })

                                _this.orgZTree.addNodes(parentZNode, zNode, false);    //添加节点              
                            })
                        }


                    },
                    onClick: function (event, treeId, treeNode, clickFlag) {
                        // 
                        //文件夹不让选择
                        if (treeNode.type == 1) {
                            return false
                        }

                        //获取对应的id或者name值，只需treeNode.id 或者 treeNode.name 即可
                        //myZTree.expandNode(treeNode);
                        //myZTree.cancelSelectedNode(treeNode);
                        var curId = treeNode.id;
                        var curName = treeNode.name;
                        var curCrumbs = treeNode.crumbs;
                        var repIndex;  //获取重复数组的索引


                        var aObj = $("#" + treeNode.tId + "_a");
                        var checkIcon = aObj.find('.jstree-custom-checked');

                        var flag = true;
                        for (var index in checkIcon) {
                            if (checkIcon[index].className && checkIcon[index].className.indexOf('selected') < 0) {
                                flag = false;
                                break;
                            }
                        }

                        if (flag) {
                            checkIcon.removeClass('selected');
                        } else {
                            checkIcon.addClass('selected');
                        };


                        if (_this.saveVal.length > 0) {
                            for (var i = 0; i < _this.saveVal.length; i++) {
                                if (_this.saveVal[i].id == curId) {
                                    repIndex = i;
                                };
                            };
                        };
                        if (repIndex) {
                            //点击之后 当前项与已选择文件 有重复  
                            _this.saveVal.splice(repIndex, 1);
                        } else {
                            if (repIndex == 0) {
                                //因为 splice从1开始， 而索引是从0开始,所以第一个元素特殊处理
                                _this.saveVal.splice(repIndex, 1);
                            } else {
                                _this.saveVal.push({
                                    id: curId,
                                    name: curName,
                                    crumbs: curCrumbs
                                });
                            };
                        };

                        //以数组形式返回选种值 
                        _this.renderNode(_this.saveVal);
                        _this.deleteNode(_this.saveVal);

                    }
                }

            }, data);



            //ztree 鼠标经过添加&删除 效果
            function addHoverDom(treeId, treeNode) {
                var pObj = $('#' + treeNode.tId);
                pObj.children('.jstree-wholerow').addClass('jstree-wholerow-hover');
            };
            function removeHoverDom(treeId, treeNode) {
                $('.ztree .jstree-wholerow').removeClass('jstree-wholerow-hover');
            };

            //添加自定义div
            function addDiyDom(treeId, treeNode) {

                setTimeout(() => {
                    var aObj = $('#' + treeNode.tId + '_a');
                    if ($('#diyBtn_' + treeNode.id).length > 0) return;

                    // while(aObj.length==0){
                    //     aObj = $('#' + treeNode.tId + '_a');
                    // }


                    var selectedStr = '<div class="jstree-custom-checked"></div>';
                    var hoverStr = '<div class="jstree-wholerow"></div>';

                    var pObj = $('#' + treeNode.tId);
                    pObj.prepend(hoverStr);
                    aObj.append(selectedStr);

                    pObj.find('.jstree-wholerow').eq(0).bind('click', function () {

                        //获取对应的id或者name值，只需treeNode.id 或者 treeNode.name 即可
                        if (treeNode.type == 1) {
                            return;
                        }
                        var curId = treeNode.id;
                        var curName = treeNode.name;
                        var curCrumbs = treeNode.crumbs;
                        var repIndex;  //获取重复数组的索引

                        var aObj = $("#" + treeNode.tId + "_a");
                        var checkIcon = aObj.find('.jstree-custom-checked');
                        if (checkIcon.hasClass('selected')) {
                            checkIcon.removeClass('selected');
                        } else {
                            checkIcon.addClass('selected');
                        };

                        if (_this.saveVal.length > 0) {
                            for (var i = 0; i < _this.saveVal.length; i++) {
                                if (_this.saveVal[i].id == curId) {
                                    repIndex = i;
                                };
                            };
                        };

                        if (repIndex) {
                            _this.saveVal.splice(repIndex, 1);
                        } else {
                            if (repIndex == 0) {
                                _this.saveVal.splice(repIndex, 1);
                            } else {
                                _this.saveVal.push({
                                    id: curId,
                                    name: curName,
                                    crumbs: curCrumbs
                                });
                            };
                        };

                        //以数组形式返回选种值    
                        _this.renderNode(_this.saveVal);
                        _this.deleteNode(_this.saveVal);

                    });

                    for (var i = 0; i < _this.saveVal.length; i++) {
                        if (treeNode.id == _this.saveVal[i].id) {
                            aObj.find('.jstree-custom-checked').addClass('selected');
                        }
                    };




                }, 1000)






            };

            //渲染已选中文件
            if (_this.saveVal && _this.saveVal.length > 0) {
                _this.renderNode(_this.saveVal);
                _this.deleteNode(_this.saveVal);
            };

        },

        dataSolve: function (data) {
            if (!data) {
                return
            }
            var memberData = data;
            var zTreeNode = [];
            function fillNode(zNode, dataNode, presentName) {
                dataNode.forEach(function (aDate) {
                    var thisNode = {
                        id: aDate.fileId,
                        name: aDate.fileName,
                        parentId: aDate.parFileId,
                        crumbs: aDate.path,
                        type: aDate.type,
                        isParent: true,
                        children: []
                    };
                    var noChildNode = {
                        id: aDate.fileId,
                        name: aDate.fileName,
                        parentId: aDate.parFileId,
                        type: aDate.type,
                        isParent: false,
                        crumbs: aDate.path,
                    };
                    if (aDate.type == 1) {
                        zNode.unshift(thisNode);
                    } else {
                        zNode.push(noChildNode);
                    };
                    //fillNode(thisNode.children, aDate.children, thisNode.crumbs);
                });
            };
            fillNode(zTreeNode, memberData, '');

            return zTreeNode;

        },
        getCurrentValue: function () {
            var _this = this;
            // var savedVal = $('#field-dept').val().split(';');
            var filterJson = [];
            // for(var i=0; i<savedVal.length; i++) {
            //     (function(i){
            //         filterDataList.forEach(function(item, index){
            //             if(item.id == savedVal[i]) {
            //                 return filterJson.push(item);
            //             };
            //         });
            //     })(i);
            // };

            var saveVal = filterJson;
            //_this.renderOut(saveVal);
            return saveVal;
        },
        outRepair: function () {
            var _this = this;
            $(document).on('click', '.js_disselect_party', function () {
                $(this).parent().remove();
                this.saveVal = _this.savedJson();
                if (this.saveVal.length > 0) {
                    $('.js_show_party_selector').html('修改');
                } else {
                    $('.js_show_party_selector').html('添加');
                };

                //处理ztree数 的选中图标
                // var curId = $(this).siblings('.parydata').attr('data-id');
                // var selectedTreeNode = orgZTree.getNodeByParam('id', curId); 

                // var aObj = $('#' + selectedTreeNode.tId + "_a");
                // var checkIcon = aObj.find('.jstree-custom-checked');
                // checkIcon.removeClass('selected');

            });
        },
        savedJson: function () {
            var itemList = $('.js_party_select_result_list').children('div');
            var saveLength = itemList.length;
            var jsonList = [];
            var outInputVal = '';

            if (saveLength > 0) {
                itemList.each(function (index, ele) {
                    jsonList.push({
                        name: $(ele).find('.parydata').attr('data-name'),
                        id: $(ele).find('.parydata').attr('data-id'),
                        crumbs: $(ele).find('.parydata').attr('data-crumbs')
                    });
                    outInputVal += $(ele).find('.parydata').attr('data-id') + ';';
                });
            };
            //渲染外部input的值
            $('#field-dept').val(outInputVal);
            //console.log($('#field-dept').val());
            return jsonList;
        },
        renderOut: function (arr) {
            $('.js_party_select_result_list').html('');
            var wrap = '';
            var perVal = '';
            if (arr.length > 0) {
                arr.map(function (ele, index) {
                    perVal += ele.id + ';';
                    wrap += '<div class="ww_groupSelBtn_item">'
                        + '<span class="ww_commonImg ww_commonImg_TreeMenuThumb"></span>'
                        + '<span class="ww_groupSelBtn_item_text">'
                        + ele.name
                        + '</span>'
                        + '<span class="ww_commonImg ww_commonImg_GroupDelSel js_disselect_party">x</span>'
                        + '<input type="hidden" class="parydata" name="partyid" data-name="'
                        + ele.name
                        + '" data-id="'
                        + ele.id
                        + '" data-crumbs="'
                        + ele.crumbs
                        + '" value="'
                        + ele.id
                        + '">'
                        + '</div>';
                });
                $('.js_show_party_selector').html('修改');
            } else {
                $('.js_show_party_selector').html('添加');
            };
            $('.js_party_select_result_list').append(wrap);
            //渲染外部input的值
            $('#field-dept').val(perVal);
            //console.log($('#field-dept').val())
        },
        renderNode: function (arr) {
            var _this = this;
            var liHtml = '';
            var context = this.$body.find('#saveNode')
            context.html('');
            if (arr.length > 0) {
                $('.multiPickerDlg_right_no_result').hide();
            } else {
                $('.multiPickerDlg_right_no_result').show();
            }
            arr.map(function (item, index) {
                liHtml = '<li title=' + item.crumbs + ' data-name=' + item.name + ' data-id=' + item.id + ' class="ww_menuDialog_DualCols_colRight_cnt_item token-input-token js_list_item">'
                    + '<span class="ww_commonImg icon icon_folder_blue"></span>'
                    + '<span class="ww_treeMenu_item_text" title=' + item.crumbs + '>' + item.name + '</span>'
                    + '<a href="javascript:" class="ww_menuDialog_DualCols_colRight_cnt_item_delete"><span class="ww_commonImg ww_commonImg_DeleteItem js_delete"></span></a>'
                    + '</li>';
                context.append(liHtml);
            });
        },
        translateId(id) {

            for (var index in this.AddAttachments) {

                if (this.AddAttachments[index].file.id == id) {
                    return index;
                }
            }
            return id;
        },
        deleteNode: function (arr) {

            var _this = this;
            var arrNode = arr;
            _this.$body.find('.js_list_item').on('click', function () {
                var curId = $(this).attr('data-id');  //获取当前ID

                for (var i = 0; i < arrNode.length; i++) {
                    if (arrNode[i].id == curId) {
                        arrNode.splice(i, 1);
                    };
                };

                //删除选中树节点的选中图标
                var selectedTreeNode = _this.orgZTree.getNodeByParam("id", curId);
                if (selectedTreeNode) {
                    var aObj = $("#" + selectedTreeNode.tId + "_a");
                    var checkIcon = aObj.find('.jstree-custom-checked');
                    checkIcon.removeClass('selected');
                }


                //操作接下来的逻辑
                $(this).remove();
                this.saveVal = arrNode;
                if (this.saveVal.length > 0) {
                    $('.multiPickerDlg_right_no_result').hide();
                } else {
                    $('.multiPickerDlg_right_no_result').show();
                };
                return this.saveVal;
            });
        },
        //渲染 FormMultiQuery的Modal
        _renderFolderModal: function () {
            var that = this;
            if (this.ResponseContext && this.ResponseContext.IsCreateMode) {
                //that.saveVal=[]
            }
            that.ID = "FormMultiQuery_" + $.IGuid();
            var dom = $('div').find('.multiPickerDlg');
            if (dom && dom.length > 0) {
                dom.remove();
            }
            that.$modal = $("<div id='" + that.ID + "' class='modal fade modal-formquery' style='z-index:1000;' data-backdrop='false' role='dialog'>" +
                "<div class='modal-dialog modal-lg modal-dialog-form'>" +
                "<div class='modal-content'>" +
                "<div class='modal-header modal-header-form'><div class='close' style='margin- top:-2px;' data-dismiss='modal'><span aria-hidden='true' class='fa' style='font-size:16px;'><i class='ivu-icon ivu-icon-close' :color='white'></i></span></div><h4 class='modal-title modal-title-form'>选择" + that.DisplayName + "</h4></div>" +
                "</div>" +
                "</div>" +
                "</div>");

            var $modalBody = $("<div class='modal-body file-modal'></div>");
            var $contentsHTML = $('<div class="multiPickerDlg clearfix"><div class="multiPickerDlg_left"><div class="multiPickerDlg_left_cnt"><!--loading--><div style="display:none" class="ww_loading loading_left_wrap js_search_loading"><span class="ww_loadingIconSmall"></span><span class="ww_loading_text">正在搜索，请稍候…</span></div><!--jstree--><div id="partyTree" class="multiPickerDlg_left_cnt_list"><div  class="ww_loading js_search_loading" style="display:none"><span class="ww_loadingIconSmall"></span><span class="ww_loading_text">正在搜索，请稍候…</span></div><div class="ztree_wrapper"><ul id="ztreeArea" class="ztree"></ul></div></div><div class="multiPickerDlg_left_mask js_left_mask"></div></div></div><div class="multiPickerDlg_right"><div class="multiPickerDlg_right_title">已选择的文件</div><div class="multiPickerDlg_right_cnt"><div class="js_right_col"><ul id="saveNode"></ul></div><div class="multiPickerDlg_right_no_result"><i></i>未选择文件</div></div></div></div>');
            this.$body = $modalBody
            $modalBody.append($contentsHTML);


            $('.ww_loading').css('display', 'none');

            var $leftWrap = $('.multiPickerDlg_left_cnt');
            var $treeWrapper = $modalBody.find('.multiPickerDlg_left_cnt_list');
            var $zTreeWrap = $treeWrapper.find('#ztreeArea');



            if (true) {
                //全部开启
                this.loadAll($zTreeWrap, this.allLoadData);
            };

            //判断搜索是否开启
            if (true) {
                this.searchFuc(this.filterDataList, $modalBody);
            };

            //AppTreeObj = $.fn.zTree.init( $modalBody, setting, nodes);

            // 查询条件
            // that.$searchForm = $("<div class='form-horizontal searchform myform-horizontal backgroundcolor'></div>");
            // $modalBody.append(that.$searchForm);

            var $modalFooter = $("<div  class='modal-footer modal-footer-form'></div>");

            // 按钮
            that.$toolbar = $("<div class='toolbar text-left' style='margin-top:10px;'><div class='btn-group btn-group-sm' role='group'><button class='btn btn-ok btn-search btnSearch hide '><i class='fa fa-search'></i>查询</button><button class='btn btn-create btnAdd hide'><i class='fa icon-increase'></i>新增</button></div></div>");
            $modalBody.append(that.$toolbar);


            var buttonStr = '<div class="btn-group btn-group-sm"  role="group"  style="width:30%;margin:0 auto"><button style="float:left!important" class="btn btn-ok fileOK">确定</button><button  style="float:left!important" class="btn btn-cancel toManager">管理文档库</button></div>';
            //如果关联查询控件在子表中则允许批量选择，增加确定按钮
            //新增的时候出现按钮
            $modalFooter.append(buttonStr);



            $modalFooter.find('.toManager').off("click").on("click", function () {
                that.$modal.modal("hide");
                window.location.href = "/#/flow-page/document-lib";
            });

            $modalFooter.find('.fileOK').off("click").on("click", function () {

                for (var index in that.AddAttachments) {

                    var deleteId = that.translateId.call(that, that.AddAttachments[index].file.id);
                    that.RemoveFile.call(that, deleteId);

                }
                for (var index in that.Value) {

                    var deleteId = that.translateId.call(that, that.Value[index].Code);
                    that.RemoveFile.call(that, deleteId);

                }
                if (that.ResponseContext && !that.ResponseContext.IsCreateMode) {
                    that.Value = that.saveVal
                }

                that.AddFiles.apply(that, [that.saveVal]);
                that.$modal.modal("hide");
                // 确定时验证判断，去除红框
                that.Validate();
            });


            that.$modal.find(".modal-content").append($modalBody).append($modalFooter);
            $(that.CurrentBody).append(that.$modal);
            that.SheetData = {};
            that.TableNeedRefresh = false;//为true的情况：关联查询过滤规则中配置了主表单的字段
            this.$ActionPanel.off("click").on("click", function () {
                that.$dropdown && that.$dropdown.hide();
                that.$modal.modal("show");
            });

            that.SearchInitialized = false; // 查询条件是否已初始化
            that.TableInitialized = false; // 表格是否已初始化
            that.CheckedRows = [];//点击“确定”按钮或者“查询”按钮将勾选的行存入CheckedRows
            // modal的show事件
            that.$modal.on("show.bs.modal", function (e) {
                $.MsgFilter.show();
            });
            that.$modal.on("hidden.bs.modal", function (e) {
                $.MsgFilter.remove();
            });
            var $btnAdd = that.$toolbar.find(".btnAdd");
            // 只有表单中的关联查询允许新增关联对象


            //以数组形式返回选种值    
            that.renderNode(that.saveVal);
            that.deleteNode(that.saveVal);

        },

        searchFuc: function (data, dom) {

            var _this = this;
            var $multiPickerDlg = dom.find('.multiPickerDlg');
            $multiPickerDlg.addClass('multiPickerDlg_WithSearch');

            var sdom = '<div class="multiPickerDlg_search_wrapper">'
                + '<div class="multiPickerDlg_search">'
                + '<span class="ww_searchInput">'
                + '<span class="ww_commonImg ww_commonImg_Search ww_searchInput_icon"href="javascript:;"></span>'
                + '<span class="ww_commonImg ww_commonImg_ClearText ww_searchInput_delete" id="clearMemberSearchInput"></span>'
                + '<input type="text"id="memberSearchInput"class="qui_inputText ww_inputText ww_searchInput_text" placeholder="搜索文件"></span>'
                + '</div>'
                + '<div id="searchResult"class="ww_searchResult"style="display: none">'
                + '<div id="search_member_list_title"class="ww_searchResult_title ww_searchResult_title_First">搜索结果</div>'
                + '<div class="search_member_none">无搜索结果...</div>'
                + '<ul id="search_member_list"></ul>'
                + '</div>'
                + '</div>';
            dom.find('.multiPickerDlg_left_cnt').prepend(sdom);

            var $input = dom.find('#memberSearchInput');

            //聚焦失焦样式
            $input.focus(function () {
                $(this).addClass('onfocus');
            }).blur(function () {
                $(this).removeClass('onfocus');
            });

            $input.on('keydown', function (event) {

                event.stopPropagation();

            }).on('keyup', function (event) {

                var inputValue = $(this).val();
                inputValue = inputValue.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&");
                var matcher = new RegExp(inputValue, "i");
                var filterTxt = $.grep(data, function (value) {
                    return matcher.test(value.name);
                });

                if (inputValue) {

                    dom.find('#clearMemberSearchInput').show();
                    dom.find('#searchResult').show();
                    dom.find('#partyTree').hide();
                    dom.find('#search_member_list').empty();

                    var resultList = '';
                    filterTxt.forEach(function (data) {
                        resultList += '<li data-id="' + data.id + '" data-name="' + data.name + '" title="' + data.crumbs + '"><i class="ww_commonImg ww_commonImg_TreeMenuThumb"></i>' + data.name + '</li>'
                    });
                    //判断筛选之后有没有值
                    if (resultList) {
                        dom.find('.search_member_none').hide();
                    } else {
                        dom.find('.search_member_none').show();
                    }
                    dom.find('#search_member_list').append(resultList);

                    //清空
                    dom.find('.ww_searchInput_delete').show();
                    dom.find('.ww_searchInput_delete').on('click', function () {
                        dom.find('#memberSearchInput').val(null);
                        dom.find('#searchResult').hide();
                        dom.find('#partyTree').show();
                        dom.find('#search_member_list').empty();
                        dom.find('.search_member_none').show();
                        dom.find(this).hide();
                    });


                    dom.find('#search_member_list li').on('click', function () {

                        var selectId = $(this).attr('data-id');
                        var selectName = $(this).attr('data-name');
                        var selectCrumbs = $(this).attr('title');
                        var repInx;  //获取重复数组的索引

                        if (this.saveVal && this.saveVal.length > 0) {
                            for (var i = 0; i < this.saveVal.length; i++) {
                                if (this.saveVal[i].name == selectName) {
                                    repInx = i;
                                };
                            };
                        };
                        if (repInx) {
                            this.saveVal.splice(repInx, 1);
                        } else {
                            if (repInx == 0) {
                                this.saveVal.splice(repInx, 1);
                            } else {
                                this.saveVal = []
                                this.saveVal.push({
                                    id: selectId,
                                    name: selectName,
                                    crumbs: selectCrumbs
                                });
                            };
                        };

                        dom.find('#searchResult').hide();
                        dom.find('#partyTree').show();
                        dom.find('#search_member_list').empty();
                        dom.find('#memberSearchInput').val(null);
                        dom.find('#clearMemberSearchInput').hide();

                        if (this.saveVal.length > 0) {
                            dom.find('.multiPickerDlg_right_no_result').hide();
                        } else {
                            dom.find('.multiPickerDlg_right_no_result').show();
                        };
                        //以数组形式返回选种值    
                        _this.renderNode(this.saveVal);
                        _this.deleteNode(this.saveVal);

                        //ztree进行操作，点击li之后 展开树
                        var selectedTreeNode = _this.orgZTree.getNodeByParam("id", selectId);

                        //处理ztree数 的选中图标
                        var aObj = dom.find("#" + selectedTreeNode.tId + "_a");
                        var checkIcon = aObj.find('.jstree-custom-checked');
                        if (checkIcon.hasClass('selected')) {
                            checkIcon.removeClass('selected');
                        } else {
                            checkIcon.addClass('selected');
                        };

                        _this.orgZTree.selectNode(selectedTreeNode, true);//指定选中ID的节点  
                        _this.orgZTree.expandNode(selectedTreeNode, true, false);//指定选中ID节点展开  
                        //orgZTree.cancelSelectedNode();  ztree取消选中



                    });

                } else {

                    dom.find('#searchResult').hide();
                    dom.find('#partyTree').show();
                    dom.find('#search_member_list').empty();
                    dom.find('#clearMemberSearchInput').hide();
                    dom.find('.search_member_none').show();
                };

            });


        },
        inArray: function (id) {
            var ret = false;
            var obj = this.AddAttachments
            for (var key in obj) {
                //只遍历对象自身的属性，而不包含继承于原型链上的属性。  
                if (obj.hasOwnProperty(key) === true) {
                    if (obj[key].file.id == id) {
                        ret = true
                        continue
                    }

                }
            }

            return ret;
        },
        //添加文件
        AddFiles: function (files) {
            this.OnChange.apply(this, [files]);

            for (var i = 0; i < files.length; i++) {
                var fileid = $.IGuid();
                if (this.inArray(files[i].id)) {
                    continue;
                }
                if (this.CreateFileElement2(fileid, files[i].name, files[i].size)) {
                    //需要添加的附件
                    this.AddAttachments[fileid] = {
                        fileid: fileid,
                        file: files[i],
                        xhr: new XMLHttpRequest(),
                        state: 1//0:未上传完，1:已上传完,100:失败
                    };
                    //this.UploadFile(fileid);
                }
            }
        },
        changeID(id) {
            for (var index in this.AddAttachments) {
                if (index == id) {
                    return this.AddAttachments[index].file.id
                }
            }
            return id;
        },
        //生成已存在的文件
        CreateFileElement2: function (fileid, name, size, url, thumb, description) {
            if (description == null || description == void 0) {
                description = '';
            }
            //获取文件后缀名
            var fileName = name;
            var fileType = "";
            if (fileName.lastIndexOf(".") > 0) {
                fileName = name.substring(0, name.lastIndexOf("."));
                fileType = name.substring(name.lastIndexOf("."), name.length);
                if (fileType) {
                    fileType = fileType.toLowerCase();
                }
            }
            //判断文件是否大小超限
            if (url == void 0) {
                var mbSize = Math.round(size * 100 / (1024 * 1024)) / 100;
                if (size == 0) {
                    //$.IShowWarn('提示', '文件大小不能为0');
                    Message.warning({
                        content: '文件大小不能为0',
                        duration: 3
                    });

                    return;
                } else if (size > 1024 * 1024) {
                    if (mbSize > this.MaxUploadSize || size > this.MaxUploadSize * 1024 * 1024) {
                        //$.IShowWarn('提示', '超出限制文件上传的大小');
                        Message.warning({
                            content: '超出限制文件上传的大小',
                            duration: 3
                        });
                        return;
                    }
                }
            }
            var fileSizeStr = 0;
            if (size > 1024 * 1024)
                fileSizeStr = (Math.round(size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
            else
                fileSizeStr = (Math.round(size * 100 / 1024) / 100).toString() + 'KB';
            //var fileSize = $("<td  data-filesize='" + fileid + "'><span data-filerate='" + fileid + "'>上传中,请稍候...</span> (" + fileSizeStr + ")</td>").addClass("text-info");

            var actionTd = $("<td  data-action='" + fileid + "' class=\"printHidden\"></td>");

            var actionStr = $("<a href='javascript:void(0);' class='icon-delete'>删除</a>");
            if (this.Editable) {
                actionStr.off("click.fileDeleteBtn").on("click.fileDeleteBtn", this, function (e) {
                    // if (confirm("确定删除?")) {

                    //this.deleteNode($(this).closest("tr").attr("id"));

                    console.log($(this).closest("tr"))

                    var id = $(this).closest("tr").attr("id");  //获取当前ID
                    var curId = e.data.changeID(id)
                    if (e.data.saveVal.length > 0) {
                        for (var i = 0; i < e.data.saveVal.length; i++) {
                            if (e.data.saveVal[i].id == curId) {
                                e.data.saveVal.splice(i, 1);
                            };
                        };
                    };
                    // for(var i=0; i<arrNode.length; i++){
                    //     if(arrNode[i].id == curId){
                    //         arrNode.splice(i, 1);
                    //     };
                    // };

                    //删除选中树节点的选中图标
                    if (e.data.orgZTree) {
                        var selectedTreeNode = e.data.orgZTree.getNodeByParam("id", curId);
                        if (selectedTreeNode) {
                            var aObj = e.data.$body.find("#" + selectedTreeNode.tId + "_a");
                            var checkIcon = aObj.find('.jstree-custom-checked');
                            checkIcon.removeClass('selected');
                        }
                        var list = e.data.$body.find(".js_list_item");

                        for (var i = 0; i < list.length; i++) {
                            var index = list[i]
                            if (list[i].dataset.id == curId) {
                                list[i].remove();
                            }

                        }
                        //操作接下来的逻辑
                        if (e.data.saveVal.length > 0) {
                            $('.multiPickerDlg_right_no_result').hide();
                        } else {
                            $('.multiPickerDlg_right_no_result').show();
                        };
                    }
                    if (e.data.ResponseContext && (!e.data.ResponseContext.IsCreateMode)) {
                        e.data.Value = e.data.saveVal;
                    }

                    e.data.OnChange.apply(e.data, [$(this).closest("tr").attr("id")]);
                    e.data.RemoveFile.apply(e.data, [$(this).closest("tr").attr("id")]);


                    // }
                });
            }
            else {
                actionStr.hide();
            }

            //标志是否能上传
            var flag = true;
            const isInDingTalk = window.DingTalkPC && window.DingTalkPC.ua.isDesktop && window.DingTalkPC.ua.isInDingTalk;
            var isImg = $.inArray(fileType, this.ImageFileExtension) > -1;// imgTypeArr.indexOf(fileType) > -1;//判断是否是图片
            var isDoc = $.inArray(fileType, this.DocFileExtension) > -1;//判断是否是文档
            if (url == void 0) {
                //判断文件大小
                var mbSize = Math.round(size * 100 / (1024 * 1024)) / 100;
                if (size > 1024 * 1024 && mbSize > this.MaxUploadSize) {
                    flag = false;
                    //fileSize = $("<td data-filesize='" + fileid + "'><span data-filerate='" + fileid + "'  style='color:red;'>超出限制文件上传的大小</span> (" + fileSizeStr + ")</td>").addClass("text-info");
                }
            } else if (!$.SmartForm.ResponseContext.IsCreateMode) {
                var dist = 'ctg-workflow/fileManage/download?';
                dist += 'fileId=' + fileid;
                if (isInDingTalk) {
                    dist = "/ctg-workflow/fileManage/downloadForDing/" + fileid
                    dist = changeToDingDingUrl(dist)
                }
                actionTd.append("<a href='" + dist + "' class='fa fa-download file-down' target='_blank' UC=true>下载</a>");
                actionTd.append("&nbsp;&nbsp;");



                // if (isImg || isDoc)
                // actionTd/*.append("<a href='/Form/Preview/?attachmentId=" + fileid + "' class='fa fa-eye' target='_blank' UC=true>查看</a>")*/.append("<a href='/Form/DoPreview/?attachmentId=" + fileid + "' class='fa fa-eye' target='_blank' UC=true>预览</a>");
                //fileSize = $("<td data-filesize='" + fileid + "' class='text-info'>" + fileSizeStr + "</td>");//.addClass("text-info");
            }


            var trRow_description = $("<tr data-targetid='" + fileid + "'></tr>");//.attr("data-targetid", fileid);
            var trRow = $("<tr id='" + fileid + "'></tr>");//.attr("id", fileid);
            if (url == void 0) {
                if (description == null || description == void 0 || $.trim(description).length == 0) {
                    trRow.append("<td style='padding-left:10px !important;'><div class='LongWord' title='" + name + "' id='" + fileid + "'>" + name + "</div></td>");
                    trRow_description.append("<td colspan='2'style='padding:8px 10px !important' ><input   class='form-control description-file' id='" + fileid + "' placeholder='请输入附件描述' type='text' maxlength='200' value=''/></td><td style='text-align:center;padding:12px 10px !important;'><a   class='icon-save saveDec disabled'>保存</a><a  class='icon-bianji editDec'>编辑</a></td>");
                } else {
                    trRow.append("<td style='padding-left:10px !important;' ><div class='LongWord' title='" + name + "' id='" + fileid + "'>" + name + "</div></td>");
                    trRow_description.append("<td colspan='2'style='padding:8px 10px !important' ><input disabled='disabled'  class='form-control description-file' id='" + fileid + "' placeholder='请输入附件描述' type='text' maxlength='200' value='" + description + "'/></td><td style='text-align:center;padding:12px 10px !important'><a   class='icon-save saveDec disabled'>保存</a><a class='icon-bianji editDec'>编辑</a></td>");
                }
            }
            if (url != void 0) {
                trRow.append("<td style='padding-left:10px !important;'><div class='LongWord'>" + name + "</div></a></td>");
                trRow_description.append("<td colspan='2' ><div class='description'>" + description + "</div></td><td></td>");
                if (isImg && !this.Editable) { //如果是图片则展示缩略图
                    var td_thumb = trRow.find('a');
                    $.Ipreview($(td_thumb));
                }
            }
            //trRow.append(fileSize.css("text-align", "right"));
            trRow.append(actionTd.append(actionStr).css("text-align", "center"));
            this.UploadList.append(trRow);
            //if (description != null && $.trim(description).length > 0) {

            //this.UploadList.append(trRow_description);
            //}
            if (isImg && !this.Editable) { //如果是图片则展示缩略图
                $(function () { $.Ipreview($("div[id=" + fileid + "]")); });
            }

            if (flag) {
                this.Files++;
            }

            if (this.$InputBody.hasClass("col-sm-10")) {
                trRow.find(".LongWord").css({ "max-width": "400px" });
            }
            else {
                trRow.find(".LongWord").css({ "max-width": "130px" });
            }
            if (!this.Editable) {
                trRow_description.find('a.saveDec').remove();
                trRow_description.find('input').attr('readonly', 'readonly').css({ 'border': 'none', 'outline': 'none' });
                //不可编辑+子表   description=="" 隐藏
                if (this.$InputBody.parent().parent()[0] && this.$InputBody.parent().parent()[0].tagName == "TD") {
                    if (description == '') {
                        trRow_description.hide();
                    }
                }
            } else {
            }
            //关联附件保存描述
            $("a.saveDec").off("click").on("click", function () {
                if ($(this).attr("disabled")) {
                    return;
                }
                $(this).hide();
                var $input = $(this).parent().parent().find("input");
                var FileDec = $input.val();
                if (FileDec.length > 200) { //$.IShowError('描述长度不能超过200个字符!');
                    Message.error({
                        content: "描述长度不能超过200个字符",
                        duration: 3
                    }); return;
                }
                if (FileDec.indexOf('<') > -1 && FileDec.indexOf('>') > -1) {
                    FileDec = FileDec.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                }
                if (FileDec == "") { //$.IShowWarn("请输入描述");
                    Message.warning({
                        content: '请输入描述',
                        duration: 3
                    });
                    $(this).show(); return;
                }
                var attachmentId = $(this).parent().parent().children(':first').find('div').attr('data-attachementid');
                if (attachmentId == void 0) {
                    attachmentId = $(this).parent().parent().children(':first').find('input').attr('id');
                }
                var params = {
                    id: attachmentId,
                    fileDesc: FileDec
                };
                $btn_saveDec = $(this);
                $.get(axios.defaults.baseURL + "/Form/updateDesc", params, function (data) {
                    if (data.code == 0) {
                        //$.IShowSuccess("保存附件描述成功");
                        Message.success({
                            content: '保存附件描述成功',
                            duration: 3
                        });
                        $input.css({ 'border': 'none', 'color': '#333' }).attr('disabled', 'disabled');
                        $btn_saveDec.next().show();
                    } else {
                        $btn_saveDec.show();
                        //$.IShowError("保存附件描述失败");
                        Message.error({
                            content: "保存附件描述失败",
                            duration: 3
                        });
                    }
                })
            });
            $('a.editDec').off('click').on('click', function () {
                var $input = $(this).parent().parent().find('input');
                $input.removeAttr('disabled').css({ 'border': '1px solid #d7d5d5' });
                $(this).hide();
                $(this).prev().show();
            });
            return flag;
        },



        RemoveFile: function (fileID) {
            $("#" + fileID).remove();
            $("[data-targetid='" + fileID + "']").remove();

            this.Files--;
            let param = {
                appRunId: window.appRunId_ || window.currentCode,
                controlId: this.DataField,
                attachmentId: fileID
            };
            if (this.AddAttachments[fileID]) {
                if (this.AddAttachments[fileID].xhr) {
                    this.AddAttachments[fileID].xhr.abort();
                }
                delete this.AddAttachments[fileID];
            } else {
                this.RomveAttachments.push(fileID);
            };
            axios.post('/Form/delFile', param).catch(err => {
                console.log(err)
            });
            this.Validate();
            this.OnChange(this, []);
        },

        // 关联查询附加附件
        AppendFile: function (fileId, attachmentId, fileName, fileSize, thumb, description, url) {
            this.AddAttachments[fileId] = {
                fileid: fileId,
                state: 1,
                AttachmentId: attachmentId
            };
            this.CreateFileElement2(fileId, fileName, fileSize, url, thumb, description);
            $("span[data-filerate='" + fileId + "']").html("100%");
        },
        SetReadonly: function (v) {
            if (v) {
                this.$ActionPanel.attr("disabled", "disabled");
            } else {
                this.$ActionPanel.removeAttr("disabled");
            }
        }
    });
})(jQuery);;
;
//附件控件
(function ($) {

    $.fn.FormAttachment = function () {
        return $.ControlManager.Run.call(this, "FormAttachment", arguments);
    };

    // 构造函数
    $.Controls.FormAttachment = function (element, ptions, sheetInfo) {

        this.SheetAttachmentHandler = axios.defaults.baseURL + "/Form/SheetAttachmentAction/";
        //上传控件
        this.FileUpload = $("<input type='file' data-attachment='true' multiple='multiple' style='display:none;'/>");
        //文件数
        this.Files = 0;
        //新添加的
        this.AddAttachments = {};
        //删除数据库的
        this.RomveAttachments = [];
        //异步数据
        this.XHRJson = {};
        //数据模型编码
        this.SchemaCode = "";

        $.Controls.FormAttachment.Base.constructor.call(this, element, ptions, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormAttachment.Inherit($.Controls.BaseControl, {
        Render: function () {
            if (!this.Visible) { $(this.Element).hide(); return; }
            //图片类后缀
            this.ImageFileExtension = ['.jpeg', '.jpg', '.png', '.gif', '.bmp'];
            //文档
            this.DocFileExtension = ['.doc', '.docx', '.ppt', '.pptx', '.xls', '.xlsx', '.pdf', '.txt'];
            if (this.MaxUploadSize == 0) {
                this.MaxUploadSize = 10;
            }

            var sharingKey = $.IQuery("SharingKey");
            var engineCode = $.IQuery("EngineCode");

            this.SheetAttachmentHandler += "?SchemaCode=" + encodeURI(this.SchemaCode) + "&SharingKey=" + sharingKey + "&EngineCode=" + engineCode + "&MaxSize=" + this.MaxUploadSize + "&BizObjectId=" + $.SmartForm.ResponseContext.BizObjectId + "&FileID=";
            this.HtmlRender();
            //初始化数据
            this.InitValue();
        },

        SetValue: function () {
            //$.IShowError("附件不支持SetValue");
            Message.error({
                content: "附件不支持SetValue",
                duration: 3
            });
        },

        ClearValue: function () {
            this.ClearFiles();
        },

        //初始化已上传文件
        InitValue: function () {
            if (this.Value) {
                //子表编辑时
                if (this.BizObjectId == void 0) {
                    this.BizObjectId = this.ResponseContext.BizObjectId;
                }
                this.Value = JSON.parse(this.Value);
                for (var i = 0; i < this.Value.length; ++i) {
                    this.CreateFileElement2(this.Value[i].Code, this.Value[i].Name, this.Value[i].Size, axios.defaults.baseURL + this.Value[i].Url, this.Value[i].ThumbnailUrl, this.Value[i].Description);
                }
            }
        },
        // 数据验证
        Validate: function (actionName) {
            if (!this.Editable) return true;

            // 修改
            // if (actionName != $.SmartForm.Action_Save && actionName == $.SmartForm.Action_Modify && this.Required && this.Files < 1) {
            // 必填项判断 by lizijie
            if (actionName != $.SmartForm.Action_Save && this.Required && this.Files < 1) {
                this.AddInvalidText(this.$ActionPanel, "必填");
                return false;
            }

            //如果是支持Html5的话，得判断是否已经上传完整，需要等待
            for (var key in this.AddAttachments) {
                if (this.AddAttachments[key].state == 0) {
                    this.AddInvalidText(this.$ActionPanel, "未上传完!");
                    return false;
                }
            }

            this.RemoveInvalidText(this.$ActionPanel);
            return true;
        },

        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;
            result[this.DataField] = this.getEditValue();
            return result;
        },

        GetValue: function () {
            var AttachmentIds = "";
            console.log(this.AddAttachments);
            var result = [];
            for (var key in this.AddAttachments) {
                if (this.AddAttachments[key].state == 1 && this.AddAttachments[key].AttachmentId) {
                    AttachmentIds += this.AddAttachments[key].AttachmentId + ";";
                    //改造内容
                    result.push({
                        Code: this.AddAttachments[key].AttachmentId,
                        Name: this.AddAttachments[key].file.name,
                        Size: this.AddAttachments[key].file.size,
                        Url: this.AddAttachments[key].Url,
                        Description: this.AddAttachments[key].FileDec
                    })
                }
            }

            var DelAttachmentIds = "";
            for (var i = 0; i < this.RomveAttachments.length; ++i) {
                DelAttachmentIds += this.RomveAttachments[i] + ";";
            }
            // var result = {
            //     AttachmentIds: AttachmentIds,
            //     DelAttachmentIds: DelAttachmentIds
            // };
            return result;
        },

        getEditValue: function () {
            let result = this.Value ? [...this.Value] : [];
            let addValue = this.GetValue();
            this.RomveAttachments.forEach(fileId => {
                result.some((item, index) => {
                    if (item.Code === fileId) {
                        result.splice(index, 1);
                        return true
                    }
                    return false;
                })
            })
            return [...result, ...addValue];
        },

        GetText: function () {
            return this.Files;
        },

        ClearFiles: function () {
            var that = this;
            this.UploadList.find("tr").each(function () {
                that.RemoveFile($(this).attr("id"));
            });
        },

        HtmlRender: function () {
            //设置宽度
            this.$Element = $(this.Element).addClass("SheetAttachment");

            //添加附件展示列表和按钮
            this.UploadList = $("<table class='table table-striped form-attachment-container' style='margin:0;min-height:0;width:100%;'></table>");
            this.$InputBody.append(this.UploadList);

            if (!this.Editable) return;
            this.$ActionPanel = $("<div class='btn btn-outline btn-lg' style='width:100%;'><i class='attach-plus'></i>点击或拖拽文件上传</div>");
            this.$InputBody.append(this.$ActionPanel);

            //添加上传控件
            this.$Element.append(this.FileUpload);
            this.$ActionPanel.off("click.FormAttachment").on("click.FormAttachment", this, function (e) {
                $.extend(this, e.data);
                if (this.$Element.data($.ControlManager.DataFieldKey.toLowerCase()) != this.DataField) return;
                this.FileUpload.click();
            });

            this.FileUpload.off("change.FileUpload").on("change.FileUpload", this, function (e) {
                e.data.AddFiles.apply(e.data, [this.files]);
                $(this).val("");
                var that = e.data;
                that.Required && that.$ActionPanel.css("box-shadow", "none");
                that.Required && that.RemoveInvalidText(that.$ActionPanel);
            });

            this.BindDrag();
        },

        //绑定拖拽上传事件
        BindDrag: function () {
            this.$ActionPanel.on({
                dragenter: function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                },
                dragleave: function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                },
                dragover: function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                }
            });

            var that = this;
            this.$ActionPanel[0].addEventListener("drop", function (e) {
                e.stopPropagation();
                e.preventDefault();//取消默认浏览器拖拽效果
                var files = e.dataTransfer.files;
                that.AddFiles.apply(that, [files]);
            }, false);
        },


        //添加文件
        AddFiles: function (files) {
            this.OnChange.apply(this, [files]);

            for (var i = 0; i < files.length; i++) {
                var fileid = $.IGuid();
                if (this.CreateFileElement2(fileid, files[i].name, files[i].size)) {
                    //需要添加的附件
                    this.AddAttachments[fileid] = {
                        fileid: fileid,
                        file: files[i],
                        xhr: new XMLHttpRequest(),
                        state: 0//0:未上传完，1:已上传完,100:失败
                    };
                    this.UploadFile(fileid);
                }
            }
        },

        CreateFileElement2: function (fileid, name, size, url, thumb, description) {
            if (description == null || description == void 0) {
                description = '';
            }
            //获取文件后缀名
            var fileName = name;
            var fileType = "";
            if (fileName.lastIndexOf(".") > 0) {
                fileName = name.substring(0, name.lastIndexOf("."));
                fileType = name.substring(name.lastIndexOf("."), name.length);
                if (fileType) {
                    fileType = fileType.toLowerCase();
                }
            }
            //判断文件是否大小超限
            if (url == void 0) {
                var mbSize = Math.round(size * 100 / (1024 * 1024)) / 100;
                if (size == 0) {
                    //$.IShowWarn('提示', '文件大小不能为0');
                    Message.warning({
                        content: '文件大小不能为0',
                        duration: 3
                    });

                    return;
                } else if (size > 1024 * 1024) {
                    if (mbSize > this.MaxUploadSize || size > this.MaxUploadSize * 1024 * 1024) {
                        //$.IShowWarn('提示', '超出限制文件上传的大小');
                        Message.warning({
                            content: '超出限制文件上传的大小',
                            duration: 3
                        });
                        return;
                    }
                }
            }
            var fileSizeStr = 0;
            if (size > 1024 * 1024)
                fileSizeStr = (Math.round(size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
            else
                fileSizeStr = (Math.round(size * 100 / 1024) / 100).toString() + 'KB';
            var fileSize = $("<td  data-filesize='" + fileid + "'><span data-filerate='" + fileid + "'>上传中,请稍候...</span> (" + fileSizeStr + ")</td>").addClass("text-info");

            var actionTd = $("<td  data-action='" + fileid + "' class=\"printHidden\"></td>");

            var actionStr = $("<a href='javascript:void(0);' class='icon-delete'>删除</a>");
            if (this.Editable) {
                actionStr.off("click.fileDeleteBtn").on("click.fileDeleteBtn", this, function (e) {
                    // if (confirm("确定删除?")) {
                    e.data.OnChange.apply(e.data, [$(this).closest("tr").attr("id")]);
                    e.data.RemoveFile.apply(e.data, [$(this).closest("tr").attr("id")]);
                    // }
                });
            }
            else {
                actionStr.hide();
            }

            //标志是否能上传
            var flag = true;
            const isInDingTalk = window.DingTalkPC && window.DingTalkPC.ua.isDesktop && window.DingTalkPC.ua.isInDingTalk;
            var isImg = $.inArray(fileType, this.ImageFileExtension) > -1;// imgTypeArr.indexOf(fileType) > -1;//判断是否是图片
            var isDoc = $.inArray(fileType, this.DocFileExtension) > -1;//判断是否是文档
            if (url == void 0) {
                //判断文件大小
                var mbSize = Math.round(size * 100 / (1024 * 1024)) / 100;
                if (size > 1024 * 1024 && mbSize > this.MaxUploadSize) {
                    flag = false;
                    fileSize = $("<td data-filesize='" + fileid + "'><span data-filerate='" + fileid + "'  style='color:red;'>超出限制文件上传的大小</span> (" + fileSizeStr + ")</td>").addClass("text-info");
                }
            } else if (!$.SmartForm.ResponseContext.IsCreateMode) {
                if (isInDingTalk) {
                    url = changeToDingDingUrl(url)
                }
                actionTd.append("<a href='" + url + "' class='fa fa-download' target='_blank' UC=true>下载</a>");
                actionTd.append("&nbsp;&nbsp;");
                // if (isImg || isDoc)
                // actionTd/*.append("<a href='/Form/Preview/?attachmentId=" + fileid + "' class='fa fa-eye' target='_blank' UC=true>查看</a>")*/.append("<a href='/Form/DoPreview/?attachmentId=" + fileid + "' class='fa fa-eye' target='_blank' UC=true>预览</a>");
                fileSize = $("<td data-filesize='" + fileid + "' class='text-info'>" + fileSizeStr + "</td>");//.addClass("text-info");
            }

            var trRow_description = $("<tr data-targetid='" + fileid + "'></tr>");//.attr("data-targetid", fileid);
            var trRow = $("<tr id='" + fileid + "'></tr>");//.attr("id", fileid);
            if (url == void 0) {
                if (description == null || description == void 0 || $.trim(description).length == 0) {
                    trRow.append("<td style='padding-left:10px !important;'><div class='LongWord' title='" + name + "' id='" + fileid + "'>" + name + "</div></td>");
                    trRow_description.append("<td colspan='2'style='padding:8px 10px !important' ><input disabled='disabled'  class='form-control description-file' id='" + fileid + "' placeholder='请输入附件描述' type='text' maxlength='200' value=''/></td><td style='text-align:center;padding:12px 10px !important;'><a   class='icon-save saveDec disabled'>保存</a><a  class='icon-bianji editDec'>编辑</a></td>");
                } else {
                    trRow.append("<td style='padding-left:10px !important;' ><div class='LongWord' title='" + name + "' id='" + fileid + "'>" + name + "</div></td>");
                    trRow_description.append("<td colspan='2'style='padding:8px 10px !important' ><input disabled='disabled'  class='form-control description-file' id='" + fileid + "' placeholder='请输入附件描述' type='text' maxlength='200' value='" + description + "'/></td><td style='text-align:center;padding:12px 10px !important'><a   class='icon-save saveDec disabled'>保存</a><a class='icon-bianji editDec'>编辑</a></td>");
                }
            }
            if (url != void 0) {
                if (isInDingTalk) {
                    url = changeToDingDingUrl(url)
                }
                trRow.append("<td style='padding-left:10px !important;'><a href='" + url + "' data-imgurl='" + url + "' target='_blank' UC=true><div class='LongWord'>" + name + "</div></a></td>");
                trRow_description.append("<td colspan='2' ><div class='description'>" + description + "</div></td><td></td>");
                if (isImg && !this.Editable) { //如果是图片则展示缩略图
                    var td_thumb = trRow.find('a');
                    $.Ipreview($(td_thumb));
                }
            }
            trRow.append(fileSize.css("text-align", "right"));
            trRow.append(actionTd.append(actionStr).css("text-align", "center"));
            this.UploadList.append(trRow);
            //if (description != null && $.trim(description).length > 0) {
            this.UploadList.append(trRow_description);
            //}
            if (isImg && !this.Editable) { //如果是图片则展示缩略图
                $(function () { $.Ipreview($("div[id=" + fileid + "]")); });
            }

            if (flag) {
                this.Files++;
            }

            if (this.$InputBody.hasClass("col-sm-10")) {
                trRow.find(".LongWord").css({ "max-width": "400px" });
            }
            else {
                trRow.find(".LongWord").css({ "max-width": "130px" });
            }
            if (!this.Editable) {
                trRow_description.find('a.saveDec').remove();
                trRow_description.find('input').attr('readonly', 'readonly').css({ 'border': 'none', 'outline': 'none' });
                //不可编辑+子表   description=="" 隐藏
                if (this.$InputBody.parent().parent()[0] && this.$InputBody.parent().parent()[0].tagName == "TD") {
                    if (description == '') {
                        trRow_description.hide();
                    }
                }
            } else {
            }
            //关联附件保存描述
            $("a.saveDec").off("click").on("click", function () {
                if ($(this).attr("disabled")) {
                    return;
                }
                $(this).hide();
                var $input = $(this).parent().parent().find("input");
                var FileDec = $input.val();
                if (FileDec.length > 200) { //$.IShowError('描述长度不能超过200个字符!');
                    Message.error({
                        content: "描述长度不能超过200个字符",
                        duration: 3
                    }); return;
                }
                if (FileDec.indexOf('<') > -1 && FileDec.indexOf('>') > -1) {
                    FileDec = FileDec.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                }
                if (FileDec == "") { //$.IShowWarn("请输入描述");
                    Message.warning({
                        content: '请输入描述',
                        duration: 3
                    });
                    $(this).show(); return;
                }
                var attachmentId = $(this).parent().parent().children(':first').find('div').attr('data-attachementid');
                if (attachmentId == void 0) {
                    attachmentId = $(this).parent().parent().children(':first').find('input').attr('id');
                }
                var params = {
                    id: attachmentId,
                    fileDesc: FileDec
                };
                $btn_saveDec = $(this);
                $.get(axios.defaults.baseURL + "/Form/updateDesc", params, function (data) {
                    if (data.code == 0) {
                        //$.IShowSuccess("保存附件描述成功");
                        Message.success({
                            content: '保存附件描述成功',
                            duration: 3
                        });
                        $input.css({ 'border': 'none', 'color': '#333' }).attr('disabled', 'disabled');
                        $btn_saveDec.next().show();
                    } else {
                        $btn_saveDec.show();
                        //$.IShowError("保存附件描述失败");
                        Message.error({
                            content: "保存附件描述失败",
                            duration: 3
                        });
                    }
                })
            });
            $('a.editDec').off('click').on('click', function () {
                var $input = $(this).parent().parent().find('input');
                $input.removeAttr('disabled').css({ 'border': '1px solid #d7d5d5' });
                $(this).hide();
                $(this).prev().show();
            });
            return flag;
        },
        /*
        创建上传元素
        有url就是已经上传的控件，不需要判断size 大小
        */
        CreateFileElement: function (fileid, name, size, url, thumb, description) {
            if (description == null || description == void 0) {
                description = '';
            }
            var fileName = name;
            var fileType = "";
            if (fileName.lastIndexOf(".") > 0) {
                fileName = name.substring(0, name.lastIndexOf("."));
                fileType = name.substring(name.lastIndexOf("."), name.length);
                if (fileType) {
                    fileType = fileType.toLowerCase();
                }
            }
            if (url == void 0) {
                var mbSize = Math.round(size * 100 / (1024 * 1024)) / 100;
                if (size == 0) {
                    //$.IShowWarn('提示', '文件大小不能为0');
                    Message.warning({
                        content: '文件大小不能为0',
                        duration: 3
                    });
                    return;
                } else if (size > 1024 * 1024) {
                    if (mbSize > this.MaxUploadSize) {
                        //$.IShowWarn('提示', '超出限制文件上传的大小');
                        Message.warning({
                            content: '超出限制文件上传的大小',
                            duration: 3
                        });
                        return;
                    }
                }
            }

            var fileSizeStr = 0;
            if (size > 1024 * 1024)
                fileSizeStr = (Math.round(size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
            else
                fileSizeStr = (Math.round(size * 100 / 1024) / 100).toString() + 'KB';
            var fileSize = $("<td data-filesize='" + fileid + "'><span data-filerate='" + fileid + "'>上传中,请稍候...</span> (" + fileSizeStr + ")</td>").addClass("text-info");

            var actionTd = $("<td data-action='" + fileid + "' class=\"printHidden\"></td>");

            var actionStr = $("<a href='javascript:void(0);' class='fa fa-minus'>删除</a>");
            if (this.Editable) {
                actionStr.off("click.fileDeleteBtn").on("click.fileDeleteBtn", this, function (e) {
                    // if (confirm("确定删除?")) {
                    e.data.OnChange.apply(e.data, [$(this).closest("tr").attr("id")]);
                    e.data.RemoveFile.apply(e.data, [$(this).closest("tr").attr("id")]);
                    // }
                });
            } else {
                actionStr.hide();
            }


            //标志是否能上传
            var flag = true;
            const isInDingTalk = window.DingTalkPC && window.DingTalkPC.ua.isDesktop && window.DingTalkPC.ua.isInDingTalk;
            var isImg = $.inArray(fileType, this.ImageFileExtension);//imgTypeArr.indexOf(fileType) > -1;//判断是否是图片
            if (url == void 0) {
                //判断文件大小
                var mbSize = Math.round(size * 100 / (1024 * 1024)) / 100;
                if (size > 1024 * 1024 && mbSize > this.MaxUploadSize) {
                    flag = false;
                    fileSize = $("<td data-filesize='" + fileid + "'><span data-filerate='" + fileid + "'  style='color:red;'>超出限制文件上传的大小</span> (" + fileSizeStr + ")</td>").addClass("text-info");
                }
            } else {
                if (isInDingTalk) {
                    url = changeToDingDingUrl(url)
                }
                actionTd.append($("<a href='" + url + "' class='fa fa-download' target='_blank' UC=true>下载</a>"));
                actionTd.append("&nbsp;&nbsp;");
                fileSize = $("<td data-filesize='" + fileid + "' class='text-info'>" + fileSizeStr + "</td>");//.addClass("text-info");
            }
            var trRow = $("<tr id='" + fileid + "'></tr>");//.attr("id", fileid);
            if (url == void 0) {
                if (description == null || description == void 0 || $.trim(description).length == 0) {
                    trRow.append("<td style='padding-left:10px !important;'><div class='LongWord' title='" + name + "' id='" + fileid + "'>" + name + "</div></td><td><input style='border:1px solid #d7d5d5;border-radius:3px;outline:none;' class='form-control' id='" + fileid + "' placeholder='请输入附件描述' type='text' maxlength='200' value=''/></td><td><a class='icon-save saveDec'>保存</a><a class='icon-bianji editDec'>编辑</a></td>");
                } else {
                    trRow.append("<td style='padding-left:10px !important;'><div class='LongWord' title='" + name + "' id='" + fileid + "'>" + name + "</div></td><td><input style='border:1px solid #d7d5d5;border-radius:3px;outline:none;' class='form-control' id='" + fileid + "' placeholder='请输入附件描述' type='text' maxlength='200' value='" + description + "'/></td><td><a class='icon-save saveDec'>保存</a><a class='icon-bianji editDec'>编辑</a></td>");
                }
            }
            if (url != void 0) {
                trRow.append("<td style='padding-left:10px !important;'><a href='" + url + "' data-imgurl='" + thumb + "' target='_blank' UC=true><div class='LongWord'>" + name + "</div></a></td><td><div>" + description + "</div></td>");
                if (isImg && !this.Editable) { //如果是图片则展示缩略图
                    var td_thumb = trRow.find('a');
                    $.Ipreview($(td_thumb));
                }
            }
            trRow.append(fileSize.css("text-align", "right"));
            trRow.append(actionTd.append(actionStr).css("text-align", "center"));
            this.UploadList.append(trRow);
            if (isImg && !this.Editable) { //如果是图片则展示缩略图
                $(function () { $.Ipreview($("div[id=" + fileid + "]")); });
            }

            if (flag) {
                this.Files++;
            }

            if (this.$InputBody.hasClass("col-sm-10")) {
                trRow.find(".LongWord").css({ "max-width": "400px" });
            } else {
                trRow.find(".LongWord").css({ "max-width": "130px" });
            }
            if (!this.Editable) {
                //非编辑模式按照以下比例设置宽度
                var cell = trRow.find('td');
                for (var i = 0; i < cell.length; i++) {
                    if (i == 0) $(cell).eq(0).css('width', '30%');
                    if (i == 1) $(cell).eq(1).css('width', '40%');
                    if (i == 2) $(cell).eq(2).css('width', '20%');
                    if (i == 3) $(cell).eq(3).css('width', '10%');
                }
            } else {
                //编辑模式附件名列宽度
                var cell = trRow.find('td');
                cell.eq(0).css('width', '200px');
                cell.eq(2).css('width', '100px');
                cell.eq(4).css('width', '100px');
            }
            //关联附件保存描述
            $("a.saveDec").off("click").on("click", function () {
                $(this).hide();
                var $input = $(this).parent().parent().find("input");
                var FileDec = $input.val();
                if (FileDec.length > 200) { //$.IShowError('描述长度不能超过200个字符!');
                    Message.error({
                        content: "'描述长度不能超过200个字符!",
                        duration: 3
                    }); return;
                }
                if (FileDec.indexOf('<') > -1 && FileDec.indexOf('>') > -1) {
                    //FileDec=FileDec.replace()
                    FileDec = FileDec.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                }
                if (FileDec == "") { //$.IShowWarn("请输入描述");
                    Message.warning({
                        content: '请输入描述',
                        duration: 3
                    });
                    $(this).show(); return;
                }
                var attachmentId = $(this).parent().parent().children(':first').find('div').attr('data-attachementid');
                if (attachmentId == void 0) {
                    attachmentId = $(this).parent().parent().children(':first').find('div').attr('id');
                }
                var params = {
                    id: attachmentId,
                    fileDesc: FileDec
                };
                var $btn_saveDec = $(this);
                $.get(axios.defaults.baseURL + "/Form/updateDesc", params, function (data) {
                    if (data.code == 0) {
                        //$.IShowSuccess("保存附件描述成功");
                        Message.success({
                            content: '保存附件描述成功',
                            duration: 3
                        });
                        $input.css({ 'border': 'none', 'color': '#333' }).attr('disabled', 'disabled');
                        $btn_saveDec.next().show();
                    } else {
                        $btn_saveDec.show();
                        //$.IShowError("保存附件描述失败");
                        Message.error({
                            content: "保存附件描述失败!",
                            duration: 3
                        });
                    }
                })
            });
            $('a.editDec').off('click').on('click', function () {
                var $input = $(this).parent().parent().find('input');
                $input.removeAttr('disabled').css({ 'border': '1px solid #d7d5d5' });
                $(this).hide();
                $(this).prev().show();
            });
            return flag;
        },

        //上传
        UploadFile: function (fileid) {
            if (this.AddAttachments[fileid] == null && this.AddAttachments[fileid].state != 0) return;
            var fd = new FormData();
            fd.append('fileToUpload', this.AddAttachments[fileid].file);
            var xhr = this.AddAttachments[fileid].xhr;

            xhr.context = this;
            xhr.upload.fileid = fileid;
            xhr.abort.fileid = fileid;
            xhr.upload.addEventListener('progress', this.UploadProgress, false);
            xhr.fileid = fileid;
            xhr.addEventListener('load', this.UploadComplete, false);
            xhr.addEventListener('error', this.UploadFailed, false);
            xhr.addEventListener('abort', this.UploadCanceled, false);
            xhr.open('POST', this.SheetAttachmentHandler + fileid);
            xhr.send(fd);
        },

        UploadProgress: function (evt) {
            if (evt.lengthComputable) {
                var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                /*
                 * 在上传大文件的时候，在后台处理的时间会比较久
                 * 先只将上传进度显示为99%，在UploadComplete里改为100%
                 */
                percentComplete = percentComplete === 100 ? 99 : percentComplete;
                $("span[data-filerate='" + evt.currentTarget.fileid + "']").html(percentComplete + "%");
            }
            else {
                this.context.AddAttachments[evt.currentTarget.fileid].state = 100;
                $("span[data-filerate='" + evt.currentTarget.fileid + "']").css("color", "red").html('上传失败');
            }
        },

        UploadComplete: function (evt) {
            if (evt.target.status == 200) {
                var resultObj = eval('(' + evt.target.responseText + ')');
                var fileid = resultObj.FileId;
                if (resultObj.State == 4) {
                    $("tr[id=" + fileid + "]").remove();
                    $("tr[data-targetid=" + fileid + "]").remove();
                    //$.IShowWarn(resultObj.ResultStr);
                    Message.warning({
                        content: resultObj.ResultStr,
                        duration: 3
                    });
                    return;
                }
                var fileid = resultObj.FileId;
                $("#describle").val("");
                this.context.AddAttachments[fileid].state = 1;
                this.context.AddAttachments[fileid].AttachmentId = resultObj.AttachmentId;
                this.context.AddAttachments[fileid].Url = resultObj.ThumbnailUrl;
                $("div[id=" + fileid + "]").attr({ "data-imgurl": resultObj.ThumbnailUrl, 'data-attachementId': resultObj.AttachmentId });
                $("td[data-action='" + fileid + "']").prepend("&nbsp;&nbsp;");
                /*
                 *在Complete事件里将上传进度赋值为100%
                 */
                $("span[data-filerate='" + fileid + "']").html("100%");
                $("input.description-file").removeAttr("disabled");
                $("a.saveDec.disabled").removeClass("disabled");
                var that = this.context.AddAttachments[fileid];
                $("a.saveDec").off("click").on("click", function () {
                    $(this).hide();
                    var $input = $(this).parent().parent().find("input");
                    var FileDec = $input.val();
                    console.log(that);
                    that.FileDec = FileDec;
                    if (FileDec.length > 200) { //$.IShowError('描述长度不能超过200个字符!');
                        Message.error({
                            content: "描述长度不能超过200个字符!",
                            duration: 3
                        }); return;
                    }
                    if (FileDec.indexOf('<') > -1 && FileDec.indexOf('>') > -1) {
                        FileDec = FileDec.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    }
                    if (FileDec == "") { //$.IShowWarn("请输入描述");
                        Message.warning({
                            content: "请输入描述",
                            duration: 3
                        });
                        $(this).show(); return;
                    }
                    //var attachmentId = $(this).parent().parent().children(':first').find('div').attr('data-attachementid');
                    var attachmentId = $(this).parent().parent().prev().find('div').attr('data-attachementid');
                    var params = {
                        id: attachmentId,
                        fileDesc: FileDec
                    };
                    var $btn_saveDec = $(this);
                    $.get(axios.defaults.baseURL + "/Form/updateDesc", params, function (data) {
                        if (data.code == 0) {
                            //$.IShowSuccess("保存附件描述成功");
                            Message.success({
                                content: '保存附件描述成功',
                                duration: 3
                            });
                            $input.css({ 'border': 'none', 'color': '#333' }).attr('disabled', 'disabled');
                            $btn_saveDec.next().show();
                        } else {
                            $btn_saveDec.show();
                            //$.IShowError("更新文件描述失败");
                            Message.error({
                                content: "更新文件描述失败",
                                duration: 3
                            });
                        }
                    })
                });
                $('a.editDec').off('click').on('click', function () {
                    var $input = $(this).parent().parent().find('input');
                    $input.removeAttr('disabled').css({ 'border': '1px solid #d7d5d5' });
                    $(this).hide();
                    $(this).prev().show();
                });
            }
            else {
                this.context.UploadFailed(evt);
            }
            this.context.OnChange.apply(this.context, []);
        },

        UploadFailed: function (evt) {
            this.AddAttachments[evt.currentTarget.fileid].state = 100;
            $("span[data-filerate='" + evt.currentTarget.fileid + "']").html('上传失败');
        },

        UploadCanceled: function () {
        },

        // RemoveFile: function (fileID) {
        //     $("#" + fileID).remove();
        //     $("[data-targetid='" + fileID + "']").remove();

        //     this.Files--;
        //     if (this.AddAttachments[fileID]) {
        //         if (this.AddAttachments[fileID].xhr) {
        //             this.AddAttachments[fileID].xhr.abort();
        //         }
        //         delete this.AddAttachments[fileID];
        //     }
        //     else {
        //         this.RomveAttachments.push(fileID);
        //     }
        //     this.Validate();
        //     this.OnChange(this, []);
        // },

        RemoveFile: function (fileID) {
            $("#" + fileID).remove();
            $("[data-targetid='" + fileID + "']").remove();

            this.Files--;
            let param = {
                appRunId: window.appRunId_ || window.currentCode,
                controlId: this.DataField,
                attachmentId: fileID
            };
            if (this.AddAttachments[fileID]) {
                if (this.AddAttachments[fileID].xhr) {
                    this.AddAttachments[fileID].xhr.abort();
                }
                delete this.AddAttachments[fileID];
            } else {
                this.RomveAttachments.push(fileID);
            };
            axios.post('/Form/delFile', param).catch(err => {
                console.log(err)
            });
            this.Validate();
            this.OnChange(this, []);
        },

        // 关联查询附加附件
        AppendFile: function (fileId, attachmentId, fileName, fileSize, thumb, description, url) {
            this.AddAttachments[fileId] = {
                fileid: fileId,
                state: 1,
                AttachmentId: attachmentId
            };
            this.CreateFileElement2(fileId, fileName, fileSize, url, thumb, description);
            $("span[data-filerate='" + fileId + "']").html("100%");
        },
        SetReadonly: function (v) {
            if (v) {
                this.$ActionPanel.attr("disabled", "disabled");
            } else {
                this.$ActionPanel.removeAttr("disabled");
            }
        }
    });
})(jQuery);;
//图片(FormPhoto)
(function ($) {
    $.fn.FormPhoto = function () {
        return $.ControlManager.Run.call(this, "FormPhoto", arguments);
    };

    // 构造函数
    $.Controls.FormPhoto = function (element, options, sheetInfo) {
        this.SheetAttachmentHandler = axios.defaults.baseURL + "/Form/SheetAttachmentAction/";
        //上传控件
        this.FileUpload = $("<input type='file' accept='image/jpeg,image/jpg,image/png,image/gif' data-attachment='true' style='display:none;'/>");
        //文件数
        this.Files = 0;
        //新添加的
        this.AddAttachments = {};
        //删除数据库的
        this.RomveAttachments = [];
        //异步数据
        this.XHRJson = {};
        //数据模型编码
        this.SchemaCode = "";
        $.Controls.FormPhoto.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormPhoto.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            if (!this.Visible) { $(this.Element).hide(); return; }

            if (this.MaxUploadSize == 0) {
                this.MaxUploadSize = 10;
            }

            var sharingKey = $.IQuery("SharingKey");
            var engineCode = $.IQuery("EngineCode");

            this.SheetAttachmentHandler += "?SchemaCode=" + encodeURI(this.SchemaCode) + "&SharingKey=" + sharingKey + "&EngineCode=" + engineCode + "&MaxSize=" + this.MaxUploadSize + "&BizObjectId=" + $.SmartForm.ResponseContext.BizObjectId + "&FileID=";
            this.HtmlRender();
            //初始化数据
            this.InitValue();
        },

        //初始化已上传文件
        InitValue: function () {
            if (this.Value) {
                this.Value = JSON.parse(this.Value);
                if (this.Value.length == 0 && !this.Editable) {
                    this.$InputBody.hide();
                } else {
                    var url = '';
                    for (var i = 0; i < this.Value.length; ++i) {
                        url = axios.defaults.baseURL + this.Value[i].Url;
                        // 暂时不支持缩略图支持
                        this.CreateFileElement(this.Value[i].Code, this.Value[i].Name, this.Value[i].Size, url, url, this.Value[i].Description);
                    }
                }

            }
        },

        //渲染html内容
        HtmlRender: function () {
            //设置宽度
            this.$Element = $(this.Element).addClass("SheetAttachment SheetPhoto");

            this.$ActionPanel = $("<div class='btn-outline btn-lg' style='width:100%;min-height:85px;display: table;'></div>");
            this.$AddPicWrap = $("<ul class='pic-wrap'></ul>");
            this.$AddPicPanel = $("<li class='add-pic' style='width: 67px;height: 67px;cursor: pointer;background-image: url(./dist/icon-pictureupload.svg);'></li>");
            this.$ActionPanel.append(this.$AddPicWrap.append(this.$AddPicPanel));
            this.$InputBody.append(this.$ActionPanel);

            if ($.SmartForm.ResponseContext.IsCreateMode) {
                //创建模式只允许拍照
                if (this.Editable && this.CameraOnly) {
                    var $info = $("<div>启用了[仅允许拍照上传]功能，该功能只支持移动端</div>");
                    this.$ActionPanel.empty().append($info).removeAttr("style").css({ "border": "none", "background-color": "#fff" });
                    return;
                }
            } else {
                //非创建模式
                if (this.Editable && this.CameraOnly) {
                    this.$AddPicPanel.hide();
                    var $info = $("<li>启用了[仅允许拍照上传]功能，该功能只支持移动端</li>");
                    this.$AddPicWrap.append($info);
                }
            }

            if (!this.Editable) {
                this.$AddPicPanel.hide();
                return;
            }

            //添加上传控件
            this.$Element.append(this.FileUpload);
            this.$AddPicPanel.off("click.FormPhoto").on("click.FormPhoto", this, function (e) {
                e.stopPropagation();
                $.extend(this, e.data);
                if (this.$Element.data($.ControlManager.DataFieldKey.toLowerCase()) != this.DataField) return;
                this.FileUpload.click();
            });
            this.FileUpload.off("change.FileUpload").on("change.FileUpload", this, function (e) {
                e.data.AddFiles.apply(e.data, [this.files]);
                //$(this).val("");
                var that = e.data;
                that.Required && that.$ActionPanel.css("box-shadow", "none");
                that.Required && that.RemoveInvalidText(that.$ActionPanel);
            });
        },

        // 数据验证
        Validate: function (actionName) {
            if (!this.Editable) return true;

            if (actionName != $.SmartForm.Action_Save && this.Required && this.Files < 1) {
                this.AddInvalidText(this.$ActionPanel, "必填");
                return false;
            }

            //如果是支持Html5的话，得判断是否已经上传完整，需要等待
            for (var key in this.AddAttachments) {
                if (this.AddAttachments[key].state == 0) {
                    this.AddInvalidText(this.$ActionPanel, "未上传完!");
                    return false;
                }
            }

            this.RemoveInvalidText(this.$ActionPanel);
            return true;
        },

        //添加文件
        AddFiles: function (files) {
            if (!this.UpLoadMultiple && this.Files > 0) {
                //$.IShowWarn("提示", "只能上传一张图片");
                Message.warning({
                    content: "只能上传一张图片",
                    duration: 3
                });
                return;
            }
            if (!this.UpLoadMultiple) {
                this.$AddPicPanel.hide();
            }

            this.OnChange.apply(this, [files]);

            for (var i = 0; i < files.length; i++) {
                var fileid = $.IGuid();
                this.temporaryFile = files[i];//临时变量
                if (this.CreateFileElement(fileid, files[i].name, files[i].size)) {
                    //需要添加的附件
                    this.AddAttachments[fileid] = {
                        fileid: fileid,
                        file: files[i],
                        xhr: new XMLHttpRequest(),
                        state: 0//0:未上传完，1:已上传完,100:失败
                    };
                    this.UploadFile(fileid);
                }
            }
            this.FileUpload.val("");
        },

        CreateFileElement: function (fileid, name, size, url, thumb, description) {
            var that = this;
            if (description == null || description == void 0) {
                description = '';
            }
            if (typeof (name) != "string") return;

            //获取文件后缀名
            var fileName = name;
            var fileType = "";
            if (fileName.lastIndexOf(".") > 0) {
                fileName = name.substring(0, name.lastIndexOf("."));
                fileType = name.substring(name.lastIndexOf("."), name.length);
                if (fileType) {
                    fileType = fileType.toLowerCase();
                }
            }
            //判断文件是否大小超限
            if (url == void 0) {
                var mbSize = Math.round(size * 100 / (1024 * 1024)) / 100;
                if (size == 0) {
                    //$.IShowWarn('提示', '文件大小不能为0');
                    Message.warning({
                        content: "文件大小不能为0",
                        duration: 3
                    });
                    return;
                } else if (size > 1024 * 1024) {
                    if (mbSize > this.MaxUploadSize) {
                        //$.IShowWarn('提示', '超出限制文件上传的大小');
                        Message.warning({
                            content: "超出限制文件上传的大小",
                            duration: 3
                        });
                        return;
                    }
                }
            }
            //标志是否能上传
            var flag = true;

            //url:下载地址     thumb：预览地址
            var PicTemplate;
            const isInDingTalk = window.DingTalkPC && window.DingTalkPC.ua.isDesktop && window.DingTalkPC.ua.isInDingTalk;
            if (url == void 0) {
                //刚上传的图片，路径待处理

                var src = "";
                try {
                    var reader = new FileReader();
                    if (!/image\/\w+/.test(this.temporaryFile.type)) {

                    } else {
                        reader.onload = function (e) {
                            src = e.target.result;

                            PicTemplate = $('<li class="pic" id="' + fileid + '">' +
                                '<i class="ivu-icon ivu-icon-close-circled" style="color:red"></i>' +
                                '<div class="btn-action onlyoneaction">' +
                                // '<i class="ivu-icon ivu-icon-eye"></i>' +
                                '</div>' +
                                '<img data-original="' + src + '" src="' + src + '"  alt="' + name + '" class="viewer-toggle" style="width: 85px;"></li>');
                            $(PicTemplate).insertBefore(that.$AddPicPanel);
                            that.EventsBind(PicTemplate);
                        }
                        reader.readAsDataURL(this.temporaryFile);
                    }
                }
                catch (e) {
                    PicTemplate = $('<li class="pic" id="' + fileid + '">' +
                        '<i class="ivu-icon ivu-icon-close-circled">' +
                        '<div class="btn-action onlyoneaction">' +
                        // '</i><i class="ivu-icon ivu-icon-eye"></i>' +
                        '</div>' +
                        '<img data-original="/Content/images/pic-loadfail.png" src="/Content/images/pic-loadfail.png" alt="' + name + '" class="viewer-toggle"></li>');
                    $(PicTemplate).insertBefore(this.$AddPicPanel);
                    that.EventsBind(PicTemplate);
                }
            } else {

                if (typeof (thumb) != 'string') {
                    thumb = "/Content/images/pic-loadfail.png";
                }
                PicTemplate = '<li class="pic" id="' + fileid + '">';
                if (this.Editable) {
                    PicTemplate += '<i class="ivu-icon ivu-icon-close-circled" style="color:red"></i>';
                }
                PicTemplate += '<div class="btn-action">' +
                    '<i class="icon i-download"></i>' +
                    // '<i class="ivu-icon ivu-icon-eye"></i>' +
                    '</div>' +
                    '<img data-original="' + url + '" src="' + thumb + '"  alt="' + name + '" class="viewer-toggle"></li>';

                if (isInDingTalk) {
                    url = changeToDingDingUrl(url)
                }

                PicTemplate = $(PicTemplate);
                $(PicTemplate).insertBefore(this.$AddPicPanel);
                that.EventsBind(PicTemplate, url);
            }

            if (flag) {
                this.Files++;
            }
            this.temporaryFile = null;//临时变量回收
            return flag;
        },

        //绑定事件
        EventsBind: function (PicTemplate, url) {
            //删除、下载、预览
            PicTemplate.find(".ivu-icon-close-circled").unbind("click.delete").bind("click.delete", this, function (e) {
                // if (confirm("确定删除?")) {
                e.data.OnChange.apply(e.data, [$(this).closest("li").attr("id")]);
                e.data.RemoveFile.apply(e.data, [$(this).closest("li").attr("id")]);
                // }
            })
            PicTemplate.find(".i-download").unbind("click.download").bind("click.download", [this], function (e) {
                const isInDingTalk = window.DingTalkPC && window.DingTalkPC.ua.isDesktop && window.DingTalkPC.ua.isInDingTalk;
                if (isInDingTalk) {
                    console.log(url);
                    window.DingTalkPC.biz.util.openSlidePanel({
                        url: url, //打开侧边栏的url
                        title: '下载', //侧边栏顶部标题
                        onSuccess: function (result) {
                            /*
                                调用biz.navigation.quit接口进入onSuccess, result为调用biz.navigation.quit传入的数值
                            */
                        },
                        onFail: function () {
                            /*
                                tips:点击右上角上角关闭按钮会进入onFail
                                */
                        }
                    })
                }
                else {
                    window.open(url, '_blank')
                }


                //window.open(url);
            })
            PicTemplate.find(".ivu-icon-eye").unbind("click.preview").bind("click.preview", [this], function (e) {
                $(this).parents("li").find('img').click();
            })

            try {
                this.$AddPicWrap.viewer("destroy");
                this.ViewerInit();
            } catch (e) {
            }
        },

        //上传
        UploadFile: function (fileid) {
            if (this.AddAttachments[fileid] == null && this.AddAttachments[fileid].state != 0) return;
            var fd = new FormData();
            fd.append('fileToUpload', this.AddAttachments[fileid].file);
            var xhr = this.AddAttachments[fileid].xhr;

            xhr.context = this;
            xhr.upload.fileid = fileid;
            xhr.abort.fileid = fileid;
            xhr.upload.addEventListener('progress', this.UploadProgress, false);
            xhr.fileid = fileid;
            xhr.addEventListener('load', this.UploadComplete, false);
            xhr.addEventListener('error', this.UploadFailed, false);
            xhr.addEventListener('abort', this.UploadCanceled, false);
            xhr.open('POST', this.SheetAttachmentHandler + fileid);
            xhr.send(fd);
        },

        UploadProgress: function (evt) {
            if (evt.lengthComputable) {
                var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                /*
                 * 在上传大文件的时候，在后台处理的时间会比较久
                 * 先只将上传进度显示为99%，在UploadComplete里改为100%
                 */
                percentComplete = percentComplete === 100 ? 99 : percentComplete;
                $("span[data-filerate='" + evt.currentTarget.fileid + "']").html(percentComplete + "%");
            }
            else {
                this.context.AddAttachments[evt.currentTarget.fileid].state = 100;
                $("span[data-filerate='" + evt.currentTarget.fileid + "']").css("color", "red").html('上传失败');
            }
        },

        UploadComplete: function (evt) {
            if (evt.target.status == 200) {
                var resultObj = eval('(' + evt.target.responseText + ')');
                var fileid = resultObj.FileId;
                $("#describle").val("");
                this.context.AddAttachments[fileid].state = 1;
                this.context.AddAttachments[fileid].AttachmentId = resultObj.AttachmentId;
                this.context.AddAttachments[fileid].Url = resultObj.ThumbnailUrl;
                $("div[id=" + fileid + "]").attr({ "data-imgurl": resultObj.ThumbnailUrl, 'data-attachementId': resultObj.AttachmentId });
                $("td[data-action='" + fileid + "']").prepend("&nbsp;&nbsp;");
                /*
                 *在Complete事件里将上传进度赋值为100%
                 */
                $("span[data-filerate='" + fileid + "']").html("100%");
            }
            else {
                this.context.UploadFailed(evt);
            }
            this.context.OnChange.apply(this.context, []);
        },

        UploadFailed: function (evt) {
            this.AddAttachments[evt.currentTarget.fileid].state = 100;
            $("span[data-filerate='" + evt.currentTarget.fileid + "']").html('上传失败');
        },

        UploadCanceled: function () {
        },

        RemoveFile: function (fileID) {
            $("#" + fileID).remove();
            $("[data-targetid='" + fileID + "']").remove();

            this.Files--;
            if (this.AddAttachments[fileID]) {
                if (this.AddAttachments[fileID].xhr) {
                    this.AddAttachments[fileID].xhr.abort();
                }
                delete this.AddAttachments[fileID];
            }
            else {
                this.RomveAttachments.push(fileID);
            }
            if (!this.UpLoadMultiple) {
                this.$AddPicPanel.show();
            }
            let param = {
                appRunId: window.appRunId_ || window.currentCode, // appRunId 审批时候
                controlId: this.DataField,
                attachmentId: fileID
            };
            console.log(param)
            axios.post('/Form/delFile', param).catch(err => {
                console.log(err)
            });
            this.Validate();
            this.OnChange(this, []);

            if (this.Files == 0 && this.CameraOnly) {
                var $info = $("<div>启用了[仅允许拍照上传]功能，该功能只支持移动端</div>");
                this.$ActionPanel.empty().append($info).removeAttr("style").css({ "border": "none", "background-color": "#fff" });
            }
        },

        GetValue: function () {
            var AttachmentIds = "";
            var result = [];
            console.info(this.AddAttachments)
            for (var key in this.AddAttachments) {
                if (this.AddAttachments[key].state == 1 && this.AddAttachments[key].AttachmentId) {
                    // AttachmentIds += this.AddAttachments[key].AttachmentId + ";";
                    //改造内容
                    result.push({
                        Code: this.AddAttachments[key].AttachmentId,
                        Name: this.AddAttachments[key].file.name,
                        Size: this.AddAttachments[key].file.size,
                        Url: this.AddAttachments[key].Url,
                        Description: this.AddAttachments[key].FileDec
                    })
                }
            }
            /*
                var DelAttachmentIds = "";
                for (var i = 0; i < this.RomveAttachments.length; ++i) {
                    DelAttachmentIds += this.RomveAttachments[i] + ";";
                }
            */
            /* var result = {
                AttachmentIds: AttachmentIds,
                DelAttachmentIds: DelAttachmentIds
            }; */
            return result;
        },

        getEditValue: function () {
            let result = this.Value ? [...this.Value] : [];
            let addValue = this.GetValue();
            this.RomveAttachments.forEach(fileId => {
                result.some((item, index) => {
                    if (item.Code === fileId) {
                        result.splice(index, 1);
                        return true
                    }
                    return false;
                })
            })
            return [...result, ...addValue];
        },

        GetText: function () {
            return this.Files;
        },

        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;
            result[this.DataField] = this.getEditValue();
            return result;
        },

        SetReadonly: function (v) {
            if (v) {
                this.$ActionPanel.attr("disabled", "disabled");
            } else {
                this.$ActionPanel.removeAttr("disabled");
            }
        },
        //预览初始化
        ViewerInit: function () {
            this.ViewerOptins = {
                url: 'data-original',
                build: handler,
                built: handler,
                show: handler,
                shown: handler,
                hide: handler,
                hidden: handler
            };
            var handler = function (e) {

            };
            var $images = this.$AddPicWrap;
            $images.on({
                'build.viewer': handler,
                'built.viewer': handler,
                'show.viewer': handler,
                'shown.viewer': handler,
                'hide.viewer': handler,
                'hidden.viewer': handler
            }).viewer(this.ViewerOptins);
        },
    });
})(jQuery);;
// SheetComment控件
(function ($) {
    //控件执行
    $.fn.FormComment = function () {
        return $.ControlManager.Run.call(this, "FormComment", arguments);
    };

    $.Controls.FormComment = function (element, options, sheetInfo) {
        $.Controls.FormComment.Base.constructor.call(this, element, options, sheetInfo);
    };

    $.Controls.FormComment.Inherit($.Controls.BaseControl, {
        Render: function () {
            this.Value = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            this.CommentValue = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            //非结束状态
            this.Editable = this.ResponseContext.WorkItemType == 2 && this.ResponseContext.FormMode == 0;
            //if(this.ResponseContext.WorkItemId)
            if (this.ResponseContext.WorkItems && this.ResponseContext.WorkItemId) {
                var id = this.ResponseContext.WorkItemId;
                var workitem = this.ResponseContext.WorkItems.filter(function (item) { return item.WorkItemId == id; });
                if (workitem && workitem.length > 0) {
                    this.WorkItem = workitem[0];
                    this.Editable = (workitem[0].State == 0 || workitem[0].State == 1);

                }
            }
            $(this.Element).addClass("SheetComment form-comment");
            // 设置固定标题栏
            this.$Title.html("<div style='border-bottom:1px solid #e3e7e9;'>审批记录</div>");
            //历史评论
            this.InitHistoryComment();
            //评论输入
            this.InitCommentInput();
        },

        // 数据验证
        Validate: function (effective, initValid) {
            return true;
        },

        GetValue: function () {
            return $(this.CommentInput).val() == null ? "" : $(this.CommentInput).val();
        },
        //返回原始的comment数据
        GetCommentValue: function () {
            return this.CommentValue;
        },
        //返回数据值
        SaveDataField: function () {
            var result = {};
            var oldResult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldResult) {
                return {};
            }

            var IsNewComment = false;
            if (this.MyComment == void 0) {
                if (this.GetValue() == null || this.GetValue().trim().length == 0)//解决每次点击暂存/同意/不同意时候审批意见闪现的"不同意"
                    return {};
                this.MyComment = {
                    CommentId: $.IGuid(),
                    UserName: "我的意见",
                    DateStr: new Date().toString(),
                    Text: this.GetValue(),
                    Avatar: "/Content/img/a0.jpg"
                };
                IsNewComment = true;
            } else if (this.MyComment.Text == this.GetValue()) {
                return {};
            } else {
                $("#" + this.MyComment.CommentId).find("div.comment-text").html(this.GetValue());
            }

            //添加校验，如果值没变，就不会需要提交
            result = {
                CommentId: this.MyComment.CommentId,
                Text: this.GetValue(),
                IsNewComment: IsNewComment
            };
            return result;
        },

        //历史评论
        InitHistoryComment: function () {
            if (this.Value != null && this.Value != null) {
                for (var i = 0; i < this.Value.length; i++) {
                    if (this.LastestCommentOnly && i < this.Value.length - 1) continue;
                    var commentObject = this.Value[i];
                    if (commentObject.IsMyComment) {
                        this.MyComment = commentObject;
                        this.MyComment.UserName = "我的评论";
                    }
                    if (commentObject != void 0)
                        this.AddCommentItem(commentObject);
                }
            } else if (!this.Editable) {
                $(this.Element).hide();
            }
        },

        //添加评论
        AddCommentItem: function (commentObject) {
            if (this.PanelBody == void 0) {
                var CommentsPanel = $("<div class='widget-comments bordered'></div>");
                this.PanelBody = $("<div class='panel-body' style='padding:5px 5px;'></div>");
                CommentsPanel.append(this.PanelBody);//历史审批容器
                $(this.$InputBody).prepend(CommentsPanel);
            }
            var commentItem = $("<div class='comment' style='display:flex;align-items:flex-start;' id='" + commentObject.CommentId + "'></div>");
            //TODO 替换图标
            var avatar = null;
            if (commentObject.Approval) {
                //avatar = $("<img src='/Content/Images/approve.png' class='img-circle'></img>");
                avatar = $("<span class='approve'>通过</span>");
            }
            else {
                if (this.WorkItem && this.Editable) {
                    if (this.WorkItem.TokenId == commentObject.TokenId && this.WorkItem.Participant == commentObject.UserID) {
                        avatar = $("<span class='disapprove'>暂存</span>");
                    } else {
                        avatar = $("<span class='disapprove'>不通过</span>");
                    }
                } else {
                    avatar = $("<span class='disapprove'>不通过</span>");
                }
                //avatar = $("<img src='/Content/Images/disapprove.png' class='img-circle'></img>");

            }
            var commentBody = $("<div class='comment-body'></div>")
            var userName = commentObject.UserName;
            if (this.OUNameVisible && commentObject.UserParentName != void 0) {
                userName = commentObject.OUName + "." + userName;
            }

            if (commentObject.DelegantName) {
                userName += "(委托" + commentObject.DelegantName + ")";
            }
            var commenby = $("<div class='comment-by'><a href='javascript:void(0)'>" + userName + "</a> </div>")
            if (commentObject.Activity) {
                commenby.append("[<a href='javascript:void(0)'>" + commentObject.ActivityDisplayName + "</a>]");
            }
            var commenttext = $("<div class='comment-text'></div>");
            var text = commentObject.Text || "";
            if (text == "") {
                text = commentObject.Approval ? "同意" : "不同意";
            }
            commenttext.append(text);

            //审批时间
            var dateStr = "";
            var modifiedTime = commentObject.ModifiedTime.replace('T', ' ');

            var modifyData = modifiedTime.indexOf("/Date(") > -1 ? eval("new " + modifiedTime.replace(/\//g, "")) : new Date(modifiedTime);
            var today = new Date();
            if (modifyData.getYear() == today.getYear()
                && modifyData.getMonth() == today.getMonth()
                && modifyData.getDate() == today.getDate()) {
                dateStr = "今天 " + this.formatDate(modifyData.getHours()) + ":" + this.formatDate(modifyData.getMinutes());
            }
            else {
                dateStr = modifiedTime;
            }
            commenby.append("<span style='padding-left:20px;'>" + dateStr + "</span>");

            commentBody.append(commenby);
            commentBody.append(commenttext);
            commentItem.append(avatar);
            commentItem.append(commentBody);
            commentItem.append("<div class='clear'>");

            this.PanelBody.append(commentItem);
        },
        formatDate: function (v) {
            return v < 10 ? "0" + v : v;
        },

        //评论输入
        InitCommentInput: function () {
            if (!this.Editable) return;
            if ($.SmartForm.ResponseContext.WorkItemType != 2) return;
            var InputPanel = $("<div></div>");
            this.CommentInput = $("<textarea/ style='width: 100%; padding:6px'></textarea>");
            if (this.MyComment) {
                this.CommentInput.val("");
            } else {//默认评论
                this.CommentInput.val(this.DefaultComment);
            }
            InputPanel.append(this.CommentInput);
            $(this.$InputBody).append(InputPanel);

            //值改变事件
            $(this.CommentInput).off("change.CommentInput").on("change.CommentInput", this, function (e) {
                e.data.Validate.apply(e.data);
            });
        }
    });
})(jQuery);;
(function ($) {
    $.fn.FormNumber = function () {
        return $.ControlManager.Run.call(this, "FormNumber", arguments);
    };

    // 构造函数
    $.Controls.FormNumber = function (element, options, sheetInfo) {
        $.Controls.FormNumber.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormNumber.Inherit($.Controls.BaseControl, {
        NumberMode: {
            Normal: 0,
            Kbit: 1
        },
        //控件渲染函数
        Render: function () {
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }

            //是否在子表里面
            this.IsInGridView = !$.isEmptyObject(this.ObjectId);

            //整数最大长度，超过21位的话，就会变成科学计数法
            this.IntegerMaxLength = 15;
            //小数最大长度，超过5位的话，就会变成科学计数法
            this.DecimalMaxLength = 5;

            //渲染Html页面
            this.HtmlRender();
            //渲染校验模式
            this.ModeRender();
            //绑定事件
            this.BindEvent();

            if ($.isNumeric(this.Value)) {
                this.SetValue(this.Value);
            }
            //设置placeholder
            if (this.PlaceHolder) {
                this.SetPlaceHolder(this.PlaceHolder);
            }
            // 不可编辑
            if (!this.Editable) {
                this.SetReadonly(true);
                return;
            }
        },

        //渲染html内容
        HtmlRender: function () {
            if (!this.Editable) {
                this.$Input = $("<pre style='border:none;'>");
            }
            else {
                var placeHolder = 0;
                placeHolder = placeHolder.toFixed(this.DecimalPlaces) + '';
                this.$Input = $("<input type='text' name = '" + this.DataField + "' class='form-control' placeholder='" + placeHolder + "' autocomplete='off'>");
            }
            if (this.IsInGridView) {
                //子表中为了防止显示不全，往左偏移一点
                //this.$Input.css("margin-right", "-4px");
                this.$Input.css("padding-right", "4px");
            }
            this.$InputBody.append(this.$Input);
        },

        ModeRender: function () {
            this.Expression = /^-{0,1}[0-9]+\.{0,1}[0-9]*$/;
            this.ErrorAlert = "请输入数字!";
        },

        //绑定事件
        BindEvent: function () {
            //$(this.$Input).unbind("keypress.FormNumber").bind("keypress.FormNumber", this, function (event) {
            //    //var that = event.data;
            //    //var eventObj = event || e;
            //    //var keyCode = eventObj.keyCode || eventObj.which;
            //    //return keyCode >= 48 && keyCode <= 57 || keyCode == 46;
            //});

            this.$Input.off("change.FormNumber").on("change.FormNumber", this, function (event) {
                var $this = $(this);
                var that = event.data;
                that.ValChange.apply(that);
                that.Required && ($this.val() != "" && $this.removeAttr("style"));
            });
            //值改变的时候触发事件，快速响应change事件。主要在有计算情况下
            this.$Input.off("input.SheetTextBox propertyChange.SheetTextBox").on("input.SheetTextBox propertyChange.SheetTextBox", this, function (event) {
                var that = event.data;
                //that.ValChange.apply(that);
                that.OnChange();
                //that.Validate();
            });
        },

        //值改变
        ValChange: function () {
            var vStr = this.GetValue();
            if ($.isNumeric(vStr)) {
                vStr += '';
                if (vStr.indexOf(".") > -1) {
                    if (vStr.split('.')[0].length > this.IntegerMaxLength) {
                        vStr = vStr.split('.')[0].substring(0, this.IntegerMaxLength) + "." + vStr.split('.')[1];
                    }
                }
                else if (vStr.length > this.IntegerMaxLength) {
                    vStr = vStr.substring(0, this.IntegerMaxLength);
                }

                if ($.isNumeric(this.DecimalPlaces)) {
                    //直接用tofixed会出现四舍五入的情况
                    if (vStr.indexOf(".") > -1) {
                        var decimalLength = vStr.split(".")[1].length;
                        var v = parseFloat(vStr).toFixed(this.DecimalPlaces);
                        vStr = v + "";

                        if (decimalLength <= this.DecimalPlaces)
                            v = parseFloat(vStr).toFixed(this.DecimalPlaces);
                        else {
                            var integer = vStr.split(".")[0];
                            var decimal = vStr.split(".")[1] || "";

                            decimal = decimal.substring(0, this.DecimalPlaces);
                            if (decimal == '') {
                                v = integer;
                            } else {
                                v = integer + "." + decimal;
                            }
                        }
                    } else {
                        v = parseFloat(vStr).toFixed(this.DecimalPlaces);
                    }
                } else {
                    //如果小数位数不正确，则设置为默认0
                    v = parseFloat(vStr).toFixed(0);
                }
                if (this.ShowMode == this.NumberMode.Kbit) {
                    v = $.IToKbit(v);
                }
                this.$Input.val(v);
            }
            else {
                this.$Input.val("");
            }
            this.OnChange();
            this.Validate();
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (v === "" && this.GetValue() === "") return;
            if (this.GetValue() != "" && this.GetValue() == v) return;
            if (!$.isNumeric(v)) {
                v = "";
            }

            if (!this.Visible) {
                this.Value = v;
                return;
            }

            if (!this.Editable) {
                if (v != "") {
                    if ($.isNumeric(this.DecimalPlaces)) {
                        v = parseFloat(v).toFixed(this.DecimalPlaces);
                    } else {
                        v = parseFloat(v).toFixed(0);
                    }
                    if (this.ShowMode == this.NumberMode.Kbit) {
                        v = $.IToKbit(v);
                    }
                }
                this.$Input.text(v);
            }
            else {
                if (this.ShowMode == this.NumberMode.Kbit)
                    v = $.IToKbit(v);
                $(this.$Input).val(v);
            }
            this.ValChange();
        },

        //设置placeholder add:20160408
        SetPlaceHolder: function (ph) {
            if (this.Editable && this.ResponseContext.IsCreateMode) {
                this.PlaceHolder = ph.toString();//.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                this.$Input.attr("placeholder", this.PlaceHolder);
            }
        },

        GetText: function () {
            return this.GetValue() + "";
        },

        GetValue: function () {
            if (!this.Visible) {
                if (this.Value == null/* || isNaN(this.Value)*/) {
                    return "";
                } else if (isNaN(this.Value)) {
                    if (this.ShowMode == 0) {
                        var val = this.Value.replace(/,/gi, '');
                        if (isNaN(val))
                            return "";
                        else
                            return val;
                    }
                    return "";
                }
                return this.Value;
            }
            if (!this.Editable) {
                //预防显示规则冲突
                if (this.$Input != null) {
                    var val = this.$Input.text();
                    if (this.ShowMode == this.NumberMode.Kbit)
                        val = val.replace(/,/gi, '');
                    return val;
                }
                return "";
            }
            else {
                if (this.$Input != null) {
                    var val = this.$Input.val();
                    if (this.ShowMode == this.NumberMode.Kbit)
                        val = val.replace(/,/gi, '');
                    return val;
                }
                return "";
            }
        },

        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("readonly", "readonly");
            }

            else {
                this.$Input.removeProp("readonly");
            }
        },

        // 数据验证
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            if (this.Required && val.trim() == "") {
                this.AddInvalidText(this.$Input, "必填");
                return false;
            }
            val += '';
            if (val.trim() != "" && this.Expression && !this.Expression.test(val)) {
                this.AddInvalidText(this.$Input, this.ErrorAlert);
                return false;
            }
            if (val.indexOf(".") == -1) {
                if(val.length>10||parseInt(val)>2147483647||parseInt(val)<-2147483648){
                    this.AddInvalidText(this.$Input, "整数范围是-2147483648至2147483647");
                    return false
                }
               
            }


            this.RemoveInvalidText(this.$Input);
            return true;
        },

        //返回数据值
        SaveDataField: function () {
            var result = {
            };
            if (this.ComputationRule == null && !this.Visible) return result;
            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldresult) {
                return {
                };
            }

            if (("" + oldresult.Value) != this.GetValue()) {
                if (this.GetValue() == null) {
                    result[this.DataField] = "";
                } else {
                    var getValueResult = this.GetValue() + "";
                    result[this.DataField] = getValueResult.trim();
                }
                return result;
            }

            return {
            };
        },

        GetNum: function () {
            var v = this.GetValue();
            if ($.isNumeric(v)) {
                return parseFloat(v);
            }
            else {
                return 0.0;
            }
        },
        //文本框点击事件
        BindClickEvent: function (clickfun) {
            var that = this;
            if (this.ClickEvent) return;
            //显示图标并标识
            this.HasBindClick = true;

            if (clickfun == null) return;
            if ($.isEmptyObject(clickfun)) return;

            this.ClickEvent = clickfun;

            //RenderClickMode样式
            $(this.$InputBody).css("position", "relative");
            var marginRight = 20;
            if (this.IsInGridView) { marginRight = 6; }
            var $span = $("<span class='icon-nav_search textclickspan' style='float:right;position: absolute;right: 0;top: 8px;margin-right: " + marginRight + "px'></span>")
            $(this.$Input).before($span);
            if (!this.Editable) {
                $span.next().css("padding-right", "18px")
            }
            $span.off("click." + this.DataField).on("click." + this.DataField, function () {
                if (clickfun && clickfun.constructor.name == "Function") {
                    clickfun.apply(that, [that, that.ObjectId]);
                }
            })
        },
        UnBindClickEvent: function () {

        }
    });

})(jQuery);;
// Label控件
(function ($) {

    // 控件实例执行方式
    $.fn.FormLabel = function () {
        return $.ControlManager.Run.call(this, "FormLabel", arguments);
    };

    // 控件定义
    $.Controls.FormLabel = function (element, options, sheetInfo) {
        $.Controls.FormLabel.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承事件
    $.Controls.FormLabel.Inherit($.Controls.BaseControl, {
        Render: function () {
            if (!this.Visible) {
                $(this.Element).hide(); return;
            }

            if (!this.Value) {
                this.Value = "--";
            }
            this.$Input = $("<Label name='" + this.DataField + "'>");
            if (this.Value) {
                //修改时间，在新增模式下 显示"系统自动生成"字样
                if (this.ResponseContext.IsCreateMode && this.DataField == "ModifiedTime") {
                    this.$Input.text("系统自动生成");
                    this.$Input.css({ "color": "#333333", "font-size": "14px" });
                } else {
                    if (this.Value.indexOf("/Date(") > -1) {
                        this.$Input.text(new Date(this.Value.replace(/-/g, "/")).Format("yyyy-mm-dd hh:ii"));
                    } else {
                        this.$Input.text(this.Value);
                    }
                }
            }
            this.$InputBody.append(this.$Input);
        }
    });
})(jQuery);;
//组合框(FormComboBox)
//该控件在表单中不使用，现在只用在过滤时候
(function ($) {
    $.fn.FormComboBox = function (opt) {
        return $.ControlManager.Run.call(this, "FormComboBox", arguments);
    };

    // 构造函数
    $.Controls.FormComboBox = function (element, options, sheetInfo) {
        this.FormComboBoxHandler = "/App/OnAction";
        $.Controls.FormComboBox.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormComboBox.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            //是否可见
            if (!this.Visible) {
                $(this.Element).hide(); return;
            }

            this.PerNum = 10;

            //渲染Html页面
            this.HtmlRender();

            //绑定事件
            this.BindEvent();

            //Error:新建的话，可以制作默认值 ，非新建设置值加载的值
            if (this.Value) {
                this.SetValue(this.Value);
                this.SelectedValue = this.Vaule.split(',');
            } else {
                this.SelectedValue = [];
            }

            //设置placeholder
            if (this.PlaceHolder) {
                this.SetPlaceHolder(this.PlaceHolder);
            }
            // 不可编辑
            if (!this.Editable) {
                this.SetReadonly(true);
                return;
            }
        },

        //渲染html内容
        HtmlRender: function () {
            if (!this.Editable) {
                this.$Input = $('<pre style="border:none;white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;overflow:auto;word-break:break-all">');
                this.$InputBody.append(this.$Input);
            } else {
                if (this.$InputBody.children("input").length == 0) {
                    if (this.DefaultValue) {
                        this.$Input = $("<input type='text'  id='" + this.DataField + "'  data-propertyname='" + this.DataField + "'    value='" + this.DefaultValue + "' class='form-control myform-control mytext comboboxtext' style='width: 100%; padding-right:22px;'>").attr("name", this.DataField).addClass("form-control");//.attr("maxlength", 200).width(this.Width)
                    } else {
                        this.$Input = $("<input type='text'  id='" + this.DataField + "'  data-propertyname='" + this.DataField + "'     class='form-control myform-control mytext comboboxtext' style='width: 100%; padding-right:22px;'>").attr("name", this.DataField).addClass("form-control");//.attr("maxlength", 200).width(this.Width)
                    }
                }
                this.$DropList = $('<ul class="drop-list drop-combox"></ul>');
                var blankID = $.IGuid();
                var blank = $('<li class="dropdownlist-item" "><label for="' + blankID + '" data-val="--" class="drop-item-btn">--(空值)</label></li>');
                this.$DropList.append(blank);
                this.$InputBody.append(this.$Input).append(this.$DropList);
            }
        },

        //绑定事件
        BindEvent: function () {
            var that = this;
            $(this.$Input).off("blur.FormComboBox").on("blur.FormComboBox", this, function (e) {
                var $this = $(this);
                that.ValChange();
                that.Required && ($this.val() != "" && $this.removeAttr("style"));
                that.$DropList.hide();
            });

            $(this.$Input).on("keyup", this, function (e) {
                var searchvalues = $(this).val().split(/,|，/);
                var key = (searchvalues != null && searchvalues.length > 0) ? searchvalues[searchvalues.length - 1] : "";
                that.TimeOut && (clearTimeout(that.TimeOut), that.TimeOut = null);
                that.TimeOut = setTimeout(function () {
                    that.LoadData(that.SchemaCode, that.DataField, key);
                }, 400);
            });

            $(this.$Input).on("focus", this, function (e) {
                var searchvalues = that.$Input.val().split(/,|，/);
                var key = (searchvalues != null && searchvalues.length > 0) ? searchvalues[searchvalues.length - 1] : "";
                that.LoadData(that.SchemaCode, that.DataField, key);
                that.$DropList.show();
            });

            that.$DropList.off("mousedown.formcombox").on("mousedown.formcombox", ".drop-item-btn", function (e) {
                that.AddSelectedValue.call(that, this.getAttribute("data-val"));
                if (!that.$Input.is(":focus")) {
                    that.ValChange();
                }
            });

            that.$DropList.off("click.formcombox").on("click.formcombox", ".drop-item-btn", function (e) {
                that.$DropList.hide();
                return false;
            });

            that.$DropList.scroll(function () {
                var scrollTop = this.scrollTop,
                    scrollHeight = this.scrollHeight,
                    clientHeight = this.clientHeight;
                if (scrollTop + clientHeight >= scrollHeight - 60 && that.HasMore) {
                    var searchvalues = that.$Input.val().split(/,|，/);
                    var key = (searchvalues != null && searchvalues.length > 0) ? searchvalues[searchvalues.length - 1] : "";
                    that.LoadData(that.SchemaCode, that.DataField, key, that.StopIndex, that.StopIndex + that.PerNum);
                }
            });

            $(this.$Input).off("keydown.combox").on("keydown.combox", function (event) {
                var e = event || window.event || arguments.cllee.caller.agrguments[0];
                if (e && e.keyCode == 38) {
                    if (!that.$DropList.is(":hidden")) {
                        var $li = that.$DropList.children("li.active").removeClass("active");
                        var $prevli = $li.prev();
                        $prevli.addClass("active");
                        that.AddSelectedValue.call(that, $prevli.children("label").attr("data-val"));
                        that.ValChange();

                    }
                }
                if (e && e.keyCode == 40) {
                    if (!that.$DropList.is(":hidden")) {
                        if (that.$DropList.children("li.active").length > 0) {
                            var $li = that.$DropList.children("li.active").removeClass("active");
                            var $nextli = $li.next();
                            $nextli.addClass("active");
                            that.AddSelectedValue.call(that, $nextli.children("label").attr("data-val"));
                            that.ValChange();
                        } else {
                            that.$DropList.children("li:first").addClass("active");
                            that.AddSelectedValue.call(that, that.$DropList.children("li:first").children("label").attr("data-val"));
                            that.ValChange();
                        }

                    }
                }
            });
        },

        //值改变
        ValChange: function () {
            this.OnChange();
            this.Validate();
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.Visible)
                    this.$Input.html(this.Value);
            } else {
                this.$Input.val(v);
                this.Value = v;
            }
            this.ValChange();
        },

        AddSelectedValue: function (v) {
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.Visible)
                    this.$Input.html(this.Value);
            } else {
                var val = this.$Input.val();
                var index = val.lastIndexOf(",") > val.lastIndexOf("，") ? val.lastIndexOf(",") : val.lastIndexOf("，");
                if (index > 0) {
                    val = val.substring(0, index + 1) + v;
                } else {
                    val = v;
                }
                this.$Input.val(val);
                this.Value = val;
            }
        },

        //设置placeholder Add:20160408
        SetPlaceHolder: function (ph) {
            if (this.Editable && this.ResponseContext.IsCreateMode) {
                this.PlaceHolder = ph.toString();
                this.$Input.attr("placeholder", this.PlaceHolder);
            }
        },

        GetValue: function () {
            if (!this.Editable) {
                var v = this.Value;
                return v == null ? "" : v;
            } else {
                return this.$Input.val().trim();
            }
        },

        GetText: function () {
            return this.GetValue();
        },

        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("readonly", "readonly");
            } else {
                this.$Input.removeProp("readonly");
            }
        },

        // 数据验证
        Validate: function () {
            var val = this.GetValue();

            if (this.Required && val != null && val.trim() == "") {
                this.AddInvalidText(this.$Input, "必填");
                return false;
            }
            if (!$.isEmptyObject(val)) {
                if (!this.IsMultiple) {
                    //200字符长度
                    if (val.trim().length > 200) {
                        this.AddInvalidText(this.$Input, '字符长度超出限制200个字');
                        return false;
                    }
                } else {
                    if (val.trim().length > 2000) {
                        this.AddInvalidText(this.$Input, '字符长度超出限制2000个字');
                        return false;
                    }
                }
            }

            this.RemoveInvalidText(this.$Input);
            return true;
        },

        //返回数据值
        SaveDataField: function () {
            var result = {
            };
            var oldResult = {
            };
            if (this.ComputationRule == null && !this.Visible) return result;
            oldResult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldResult) {
                return {};
            }

            if (("" + oldResult.Value) != this.GetValue()) {
                result[this.DataField] = this.GetValue().trim();
                return result;
            }

            return {
            };
        },

        LoadData: function (schemacode, propertyname, value, from, to) {
            var that = this;
            if (value == "") {
                that.$DropList.children("li:not(:first)").remove();
                return;
            }
            to = to || that.PerNum;
            that.HasMore = false;
            var scopetype = 3; //过滤权限
            that.$loadMore && that.$loadMore.hide();
            var param = JSON.stringify({
                SchemaCode: schemacode,
                PropertyName: propertyname,
                SearchKey: value,
                FromRowNum: from || 0,
                ToRowNum: to,
                scopeType: scopetype,
                ActionName: "LoadSchemaPropertyValues"
            });
            param = { "PostData": param };
            this.Ajax(that.FormComboBoxHandler, "POST", param, function (data) {
                data = data.ReturnData.list;
                that.StopIndex = to;
                if (to == that.PerNum) {
                    that.$DropList.children("li:not(:first)").remove();
                    if (!data) { return; }
                    for (var i = 0; i < data.length; i++) {
                        var ID = $.IGuid();
                        var v = data[i], checked = that.SelectedValue.indexOf(v) > -1 ? true : false;
                        if (that.$DropList.find("label[data-val='" + (v || "--") + "']") > 0) {
                            continue;
                        }
                        if (v != "") {
                            if ($.isJsonLike(v)) {
                                var vv = JSON.parse(v);
                                var displayname = vv["Province"] + " " + vv["City"] + " " + vv["Town"] + " " + vv["Detail"];
                                var item = $('<li class="dropdownlist-item" ><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn">' + (displayname || "--(空值)") + '</label></li>');
                            } else {
                                var item = $('<li class="dropdownlist-item" ><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn">' + (v || "--(空值)") + '</label></li>');
                            }

                            that.$DropList.append(item);
                        }
                    }
                    if (data.length === that.PerNum) {
                        that.HasMore = true;
                        that.$loadMore = $('<li style="width:100%; height:20px; line-height:20px; text-align:center;">加载更多......</li>').appendTo(that.$DropList);
                    }
                } else {
                    var htmls = "";
                    for (var i = 0; i < data.length; i++) {
                        var ID = $.IGuid();
                        var v = data[i], checked = that.SelectedValue.indexOf(v) > -1 ? true : false;
                        if (that.$DropList.find("label[data-val='" + (v || "--") + "']") > 0) {
                            continue;
                        }
                        if (v != "") {
                            if ($.isJsonLike(v)) {
                                continue;
                                var vv = JSON.parse(v);
                                var displayname = vv["Province"] + " " + vv["City"] + " " + vv["Town"] + " " + vv["Detail"];
                                htmls += '<li class="dropdownlist-item" ><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn">' + (displayname || "--(空值)") + '</label></li>';
                            } else {
                                htmls += '<li class="dropdownlist-item" ><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn">' + (v || "--(空值)") + '</label></li>';
                            }

                        }
                    }
                    that.$loadMore.before(htmls);
                    if (data.length === that.PerNum) {
                        that.HasMore = true;
                        that.$loadMore.show();
                    }
                }
            }, true);
        }
    });
})(jQuery);;
//组合框多选(FormComboBoxList)
(function ($) {
    $.fn.FormComboBoxList = function (opt) {
        return $.ControlManager.Run.call(this, "FormComboBoxList", arguments);
    };

    // 构造函数
    $.Controls.FormComboBoxList = function (element, options, sheetInfo) {
        this.FormComboBoxListHandler = "/App/OnAction";
        $.Controls.FormComboBoxList.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormComboBoxList.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            //schemacode赋值
            this.SchemaCode = this.SchemaCode || $(this.Element).attr("data-schemacode") || $(this.Element).attr("data-schemaCode");

            if (!$(this.Element).hasClass("icon-arrow-down-full")) {
                $(this.Element).addClass("icon-arrow-down-full");
            }
            if (!$(this.Element).hasClass("mycomboboxlist")) {
                $(this.Element).addClass("mycomboboxlist");
            }
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            this.PerNum = 10;
            this.HasMore = true;
            this.Value = this.Value || this.DefaultValue;
            this.IsLoaded = false;

            //新建的话，可以制作默认值 ，非新建设置值加载的值
            if (this.Value) {
                this.SelectedValue = this.Value.split(';');
            } else {
                this.SelectedValue = [];
            }

            //渲染Html页面
            this.HtmlRender();

            //绑定事件
            this.BindEvent();

            //initValue
            this.SetValue(this.Value);

            //设置placeholder
            if (this.PlaceHolder) {
                this.SetPlaceHolder(this.PlaceHolder);
            }
            // 不可编辑
            if (!this.Editable) {
                this.SetReadonly(true);
                return;
            }
        },

        //渲染html内容
        HtmlRender: function () {
            if (!this.Editable) {
                this.$Input = $('<pre style="border:none;white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word;overflow:auto;word-break:break-all">');
                this.$InputBody.append(this.$Input);
            }
            else {
                if (this.$InputBody.children("input").length == 0) {
                    if (this.DefaultValue) {
                        this.$Input = $("<input type='text'  id='" + this.DataField + "'  data-propertyname='" + this.DataField + "'    value='" + this.DefaultValue + "' class='form-control myform-control mytext comboboxtextlist' style='width: 100%; padding-right:22px;'>").attr("name", this.DataField).addClass("form-control");
                    }
                    else {
                        this.$Input = $("<input type='text'  id='" + this.DataField + "'  data-propertyname='" + this.DataField + "'     class='form-control myform-control mytext comboboxtextlist' style='width: 100%; padding-right:22px;'>").attr("name", this.DataField).addClass("form-control");
                    }
                }
                this.$Input.attr("readonly", "readonly");
                this.$Input.css("cursor", "default").css("background-color", "#ffffff");//只读
                this.$DropList = $('<ul class="drop-list drop-combox drop-comboxlist"></ul>');
                //添加搜索框
                this.$SearchInput = $('<input type="text" class="comboxlist_search" style="width:100%;height:32px;padding-left:12px;" placeholder="搜索"></input> ');
                this.$SearchLi = $("<li data-type='search' style='border-bottom:1px solid #d7d5d5'></li>").append(this.$SearchInput);
                this.$DropListDetail = $('<ul class=" drop-combox drop-comboxlist-detail" style="list-style:none;left:0;padding-left:0;max-height:200px;overflow-y:auto;overflow-x:hidden;"></ul>');
                this.$DropList.append(this.$SearchLi).append(this.$DropListDetail);
                var blankID = $.IGuid();
                //var clearitem = $('<li class="dropdownlist-item fix"><label  data-val="" class="drop-item-btn form-query-item-label" style="margin-left: 15px;width:100%;" > --请选择--</label ></li > ');
                var blank = $('<li class="dropdownlist-item fix"><input id="' + blankID + '" type="checkbox" style="display:none"/><label for="' + blankID + '" data-val="--" class="drop-item-btn form-query-item-label" style="margin-left: 15px;width:100%;" > --(空值)</label ></li > ');
                if ($.inArray("--", this.SelectedValue) > -1) {
                    blank.find("input:checkbox").prop("checked", true);
                }
                this.$DropListDetail.append(blank);
                this.$InputBody.append(this.$Input).append(this.$DropList);
            }

        },

        //渲染模式：邮件、电话、身份证
        ModeRender: function () {
            switch (this.Mode) {
                case "Email":
                    this.Expression = /^\w+([-+.]\w+)*@\w+([-+.]\w+)*\.\w+([-.]\w+)*$/;
                    this.ErrorAlert = "错误的邮箱格式!";
                    break;
                case "Mobile":
                    this.Expression = /^1[3-8]\d{9}$/;
                    this.ErrorAlert = "错误的手机格式!";
                    break;
                case "Telephone":
                    this.Expression = /^(0\d{2,3}-)?\d{7,8}(-\d{1,4})?$/;
                    this.ErrorAlert = "错误的电话格式!";
                    break;
                case "Card":
                    this.Expression = /^\d{15}(\d{2}[A-Za-z0-9])?$/
                    this.ErrorAlert = "错误的身份证格式!";
                    break;
            }

        },

        //绑定事件
        BindEvent: function () {
            //$(this.$Input).off("blur.FormComboBoxList").on("blur.FormComboBoxList", this, function (e) {
            //    //var $this = $(this);
            //    //var that = e.data;
            //    //that.ValChange();
            //    //that.Required && ($this.val() != "" && $this.removeAttr("style"));
            //    //that.$DropList.hide();
            //});

            //点击DropDown以外区域隐藏,需要排除搜索框
            var eventName = "click.DropdownList." + (this.DataField || $(this.Element).attr("id"));
            $("body").off(eventName).on(eventName, this, function (e) {
                var target = e.target;
                var ctrl = e.data;

                if ($(target).closest("div.drop-combox").length == 0
                    && !$(target).hasClass("comboxlist_search")
                    && !$(target).hasClass("comboboxtextlist")
                    && !$(target).hasClass("icon-arrow-down-full")) {
                    ctrl.$DropList.hide();
                }
            });

            var timeout;
            //input.comboxlist propertychange
            $(this.$SearchInput).on("keyup", this, function (e) {
                var that = e.data;
                var searchvalues = $(this).val().split(/;|；/);
                var key = (searchvalues != null && searchvalues.length > 0) ? searchvalues[searchvalues.length - 1] : "";
                timeout && (clearTimeout(timeout), timeout = null);
                timeout = setTimeout(function () { that.LoadData(that.SchemaCode, that.DataField, key); }, 400);

            });


            var that = this;

            $(this.Element).off("click.formcomboxlist").on("click.formcomboxlist", this, function (e) {
                if (!that.IsLoaded) {
                    that.LoadData(that.SchemaCode, that.DataField, "");
                }
                that.$DropList.show();
                setTimeout(function () { that.$SearchInput.focus(); }, 50);
            });

            that.$DropList.off("mousedown.formcomboxlist").on("mousedown.formcomboxlist", ".drop-item-btn", function (e) {
                var v = this.getAttribute("data-val");
                if (v == "") {
                    that.ClearItem();
                    that.$DropList.hide();
                    return;
                }
                var checkbox = $(this).prev();
                var checked = checkbox.prop("checked");
                checkbox.prop("checked", !checked);
                if (checked) {
                    that.RemoveSelectValue.call(that, v);
                } else {
                    that.AddSelectedValue.call(that, v);
                }

                if (!that.$Input.is(":focus")) {
                    that.ValChange();
                }
            });

            that.$DropList.off("click.formcomboxlist").on("click.formcomboxlist", ".drop-item-btn", function (e) {
                //that.$DropList.hide();
                return false;
            });

            that.$DropListDetail.scroll(function () {
                var scrollTop = this.scrollTop,
                    scrollHeight = this.scrollHeight,
                    clientHeight = this.clientHeight;
                if (scrollTop + clientHeight >= scrollHeight && that.HasMore) {
                    var searchvalues = that.$SearchInput.val().split(/;|；/);
                    var key = (searchvalues != null && searchvalues.length > 0) ? searchvalues[searchvalues.length - 1] : "";
                    that.LoadData(that.SchemaCode, that.DataField, key, that.StopIndex, that.StopIndex + that.PerNum);
                }
            });

            $(this.$SearchInput).off("keydown.combox").on("keydown.combox", function (event) {
                var e = event || window.event || arguments.cllee.caller.agrguments[0];
                if (e && e.keyCode == 38) {
                    if (!that.$DropList.is(":hidden")) {
                        var $li = that.$DropListDetail.children("li.active").removeClass("active");
                        var $prevli = $li.prev();
                        $prevli.addClass("active");
                        that.AddSelectedValue.call(that, $prevli.children("label").attr("data-val"));
                        that.ValChange();
                    }
                }
                if (e && e.keyCode == 40) {
                    if (!that.$DropList.is(":hidden")) {
                        if (that.$DropListDetail.children("li.active").length > 0) {
                            var $li = that.$DropList.children("li.active").removeClass("active");
                            var $nextli = $li.next();
                            $nextli.addClass("active");
                            that.AddSelectedValue.call(that, $nextli.children("label").attr("data-val"));
                            that.ValChange();
                        }
                        else {
                            that.$DropListDetail.children("li:first").addClass("active");
                            that.AddSelectedValue.call(that, that.$DropList.children("li:first").children("label").attr("data-val"));
                            that.ValChange();
                        }

                    }
                }
            });
        },

        //值改变
        ValChange: function () {
            this.OnChange();
            this.Validate();
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.Visible)
                    this.$Input.html(this.Value);
            }
            else {
                this.$Input.val(v);
                this.Value = v;
                var sv = v.split(";");
                if (sv && sv.length > 0) {
                    this.SelectedValue = sv;
                }
            }
            this.ValChange();
        },

        AddSelectedValue: function (v) {
            if (v == null) return;
            if (!this.Editable) {
                this.Value = (v + "").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                if (this.Visible)
                    this.$Input.html(this.Value);
            } else {
                var val = "";
                this.SelectedValue.push(v);
                if (this.SelectedValue.length > 0) {
                    val = this.SelectedValue.join(";").replace(";", "");//报表要求使用分号分隔
                }
                this.$Input.val(val);
                this.Value = val;
            }
        },
        RemoveSelectValue: function (v) {
            if (v == null) return;
            if (!this.Editable) {
                return;
            } else {
                var val = ""
                this.SelectedValue.splice($.inArray(v, this.SelectedValue), 1);
                if (this.SelectedValue.length > 0) {
                    val = this.SelectedValue.join(";").replace(";", "");//去掉最前面的;
                }
                this.$Input.val(val);
                this.Value = val;
            }
        },
        SetPlaceHolder: function (ph) {
            if (this.Editable && this.ResponseContext.IsCreateMode) {
                this.PlaceHolder = ph.toString();//.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                this.$Input.attr("placeholder", this.PlaceHolder);
            }
        },

        GetValue: function () {
            if (!this.Editable) {
                var v = this.Value;
                return v == null ? "" : v;
            }
            else {
                return this.$Input.val();
            }
        },

        GetText: function () {
            return this.GetValue();
        },
        ClearItem: function () {
            this.SelectedValue = [];
            this.$DropListDetail.find("input:checkbox").prop("checked", false);
            this.SetValue("");
        },
        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("readonly", "readonly");
            }
            else {
                this.$Input.removeProp("readonly");
            }
        },

        // 数据验证
        Validate: function () {
            //不可编辑，不可编辑状态为什么还要校验？
            //if (!this.Editable) return true;

            var val = this.GetValue();

            if (this.Required && val != null && val.trim() == "") {

                this.AddInvalidText(this.$Input, "必填");
                return false;
            }
            if (!$.isEmptyObject(val)) {
                if (!this.IsMultiple) {
                    //200字符长度
                    if (val.trim().length > 200) {
                        this.AddInvalidText(this.$Input, '字符长度超出限制200个字');
                        return false;
                    }
                } else {
                    if (val.trim().length > 2000) {
                        this.AddInvalidText(this.$Input, '字符长度超出限制2000个字');
                        return false;
                    }
                }
            }
            //格式验证
            if (!$.isEmptyObject(val) && this.Mode) {
                var exp1 = '';
                var exp2 = '';
                var err = '';
                switch (this.Mode) {
                    case "Email":
                        exp1 = /^\w+([-+.]\w+)*@\w+([-+.]\w+)*\.\w+([-.]\w+)*$/;
                        err = "错误的邮箱格式!";
                        break;
                    case "Mobile":
                    case "Telephone":
                        exp1 = /^1[3-8]\d{9}$/;
                        exp2 = /^(0\d{2,3}-)?\d{7,8}(-\d{1,4})?$/;
                        //exp2 = /^[0-9-()（）]{7,18}$/;
                        err = "错误的电话或手机号码格式!";
                        break;
                    case "Card":
                        exp1 = /^\d{15}(\d{2}[X0-9])?$/
                        err = "错误的身份证格式!";
                        break;
                    default:
                }
                var isValid1 = true;
                var isValid2 = true;
                if (exp1) {
                    isValid1 = exp1.test(val);
                }
                if (exp2) {
                    isValid2 = exp2.test(val);
                }
                if (this.Mode == "Mobile" || this.Mode == "Telephone") {
                    if (!isValid1 && !isValid2) {
                        if (this.invalidText != err)
                            this.AddInvalidText(this.$Input, err);
                        return false;
                    }
                } else {
                    if (!isValid1) {
                        if (this.invalidText != err)
                            this.AddInvalidText(this.$Input, err);
                        return false;
                    }
                }
            }

            this.RemoveInvalidText(this.$Input);
            return true;
        },

        //返回数据值
        SaveDataField: function () {
            var result = {
            };
            var oldResult = {
            };
            if (this.ComputationRule == null && !this.Visible) return result;
            oldResult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldResult) {
                return {};
            }

            if (("" + oldResult.Value) != this.GetValue()) {
                result[this.DataField] = this.GetValue().trim();
                return result;
            }

            return {
            };
        },

        LoadData: function (schemacode, propertyname, value, from, to) {
            var that = this;
            to = to || that.PerNum;
            that.HasMore = false;
            var scopetype = 3; //过滤权限
            that.$loadMore && that.$loadMore.hide();
            var param = JSON.stringify({
                SchemaCode: schemacode, PropertyName: propertyname, SearchKey: value, FromRowNum: from || 0, ToRowNum: to, scopeType: scopetype, ActionName: "LoadSchemaPropertyValues"
            });
            param = { "PostData": param };
            this.Ajax(that.FormComboBoxListHandler, "POST", param, function (data) {
                data = data.ReturnData.list;

                that.StopIndex = to;
                that.IsLoaded = true;
                if (to == that.PerNum) {
                    that.$DropListDetail.children("li:not(.fix)").remove();
                    for (var i = 0; i < data.length; i++) {
                        var ID = $.IGuid();
                        var v = data[i], checked = that.SelectedValue.indexOf(v) > -1 ? true : false;
                        if (v != "") {
                            var item;
                            if ($.isJsonLike(v)) {
                                var vv = JSON.parse(v);
                                var displayname = vv["Province"] + " " + vv["City"] + " " + vv["Town"] + " " + vv["Detail"];
                                item = $('<li class="dropdownlist-item"><input id="' + ID + '" type="checkbox" style="display:none"/><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn form-query-item-label" style="margin-left: 15px;width:100%;">' + (displayname || "--(空值)") + '</label></li>');
                            }
                            else {
                                if (that.IsQueryControl) {
                                    v = $.trim(v);
                                }

                                item = $('<li class="dropdownlist-item"><input id="' + ID + '" type="checkbox" style="display:none"/><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn form-query-item-label" style="margin-left: 15px;width:100%;">' + (v || "--(空值)") + '</label></li>');
                            }
                            item.find("input:checkbox").prop("checked", checked);
                            that.$DropListDetail.append(item);
                        }
                    }
                    //if (data.length === that.PerNum) {
                    that.HasMore = true;
                    that.$loadMore = $('<li style="width:100%; height:20px; line-height:20px; text-align:center;">滚动加载更多......</li>').appendTo(that.$DropListDetail);
                    //}
                } else {
                    var htmls = "";
                    for (var i = 0; i < data.length; i++) {
                        var ID = $.IGuid();
                        var v = data[i], checked = that.SelectedValue.indexOf(v) > -1 ? true : false;
                        if (v != "") {
                            if ($.isJsonLike(v)) {
                                continue;
                                var vv = JSON.parse(v);
                                var displayname = vv["Province"] + " " + vv["City"] + " " + vv["Town"] + " " + vv["Detail"];
                                htmls += '<li class="dropdownlist-item" ><input id="' + ID + '" type="checkbox" style="display:none"/><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn form-query-item-label" style="margin-left: 15px;width:100%;">' + (displayname || "--(空值)") + '</label></li>';
                            }
                            else {
                                if (that.IsQueryControl) {
                                    v = $.trim(v);
                                }
                                htmls += '<li class="dropdownlist-item" ><input id="' + ID + '" type="checkbox"  style="display:none"/><label for="' + ID + '" data-val="' + (v || "--") + '" class="drop-item-btn form-query-item-label" style="margin-left: 15px;width:100%;">' + (v || "--(空值)") + '</label></li>';
                            }

                        }
                    }
                    that.$loadMore.before(htmls);
                    //if (data.length === that.PerNum) {
                    //    that.HasMore = true;
                    //    that.$loadMore.show();
                    //}
                    if (data != void 0 && data.length > 0) {
                        that.HasMore = true;
                        that.$loadMore.show();
                    }
                }
            }, true);
        },
    });
})(jQuery);;
// FormQuery控件
; (function ($) {
    // 控件实例执行方式
    $.fn.FormQuery = function () {
        return $.ControlManager.Run.call(this, "FormQuery", arguments);
    };

    $.FormQueryData = {
        PropertyQueryItems: {},
        PropertyQueryColumns: {},
        SchemaCodeAcl: {},
        PropertyQueryDefaultValues: {}
    };

    // 构造函数
    $.Controls.FormQuery = function (element, options, sheetInfo) {
        $.Controls.FormQuery.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormQuery.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            var that = this;
            that.FirstLoad = true;

            //用于模糊查询的关联属性
            that.FilterProperties = undefined;

            that.isFirstSetValue = true;
            that.CurrentDocument = $(that.Element).closest("html").parent().length == 0 ? $(document) : $(that.Element).closest("html").parent();
            that.CurrentBody = $(that.Element).closest("body").length == 0 ? $("body") : $(that.Element).closest("body");
            // that.CurrentBody = $(that.Element);


            that.SheetData = {};//关联表单过滤用到的数据
            //that.IsQueryControl = false;//标识该控件是表单中还是列表过滤
            that.LoadData = [];//关联表单的数据，表示加载出来的当前表单对应的关联的数据
            if ($.FormQueryData[that.BOSchemaCode]) {
                that.IsRunnable = $.FormQueryData[that.BOSchemaCode].IsRunnable;
                that.CanCreate = $.FormQueryData[that.BOSchemaCode].CanCreate;
                that._Render();
            }
            else {
                // var postData = { PostData: JSON.stringify({ ActionName: "LoadSchemaAcl", SchemaCode: that.BOSchemaCode }) }
                // that.Ajax("/Form/OnAction", "GET", postData, function (data) {
                //     $.FormQueryData[that.BOSchemaCode] = data.ReturnData;
                //     that.IsRunnable = data.ReturnData.IsRunnable;
                //     that.CanCreate = data.ReturnData.CanCreate;
                //     that._Render();
                // }, false);
                setTimeout(() => {
                    $.FormQueryData[that.BOSchemaCode] = { "CanCreate": true, "IsRunnable": true };
                    that.IsRunnable = true;
                    that.CanCreate = true;
                    that._Render();
                }, 400)

            }

        },

        _Render: function () {
            var passedBoObjectId = $.IQuery(this.BOSchemaCode);
            var passedBoName = $.IQuery(this.BOSchemaCode + "_Name");
            if (passedBoObjectId && !passedBoName) {
                this.Editable = false;
            }

            //渲染前端
            this.HtmlRender();

            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            if ($.SmartForm != null && $.SmartForm.ResponseContext != null) {
                // 新增时，赋值需要处理改变事件，如携带之类的
                if ($.SmartForm.ResponseContext.IsCreateMode) {
                    this.BindChange("FormQueryChange", this.Change);
                    //初始化默认值
                    this.InitValue();
                } else {
                    // 编辑时，赋值不需要携带，所有的值都是从已经存的结果读取
                    //初始化默认值
                    this.InitValue();
                    this.BindChange("FormQueryChange", this.Change);
                }
            } else {
                this.BindChange("FormQueryChange", this.Change);
                //初始化默认值
                this.InitValue();
            }

            this._toDetailLink();

            //不可用
            if (!this.Editable) {
                this.SetReadonly(true);
                //子表中去掉title
                if (!$.isEmptyObject(this.ObjectId)) {
                    this.$Input.find("a").removeAttr("title");
                }
            } else {
                this.BindEvent();
            }

            this.InitMappingProperty();
        },
        //初始化关联属性控件值
        InitMappingProperty: function () {
            //给关联属性控件赋值
            var that = this;
            //如果当前控件是"关联属性"则不要设置关联携带
            if ($(that.Element).attr("data-ismappingproperty") != undefined) {
                return;
            }
            var mappingProperties = that.MappingProperties;
            if (that.Value != undefined && mappingProperties != undefined && !$.isEmptyObject(mappingProperties) && mappingProperties != "") {
                //有关联属性
                // var params = {
                //     ActionName: "GetFormatBizObject",
                //     SchemaCode: this.BOSchemaCode,
                //     ObjectId: that.Value
                // }

                var param = {
                    SchemaCode: this.BOSchemaCode,
                    ObjectId: this.Value
                }
                HTTP.getFormatBizObject(param).then((data) => {
                    if (data.code == 0 && data.datas.length > 0) {
                        that.SetMappingValue(data.datas[0], that.MappingProperties);
                    }
                })
                // this.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                //     if (data.ReturnData.ListViewData && data.ReturnData.ListViewData.length > 0) {
                //         that.SetMappingValue(data.ReturnData.ListViewData[0], that.MappingProperties);
                //     }
                // });
            }
        },
        //渲染前端
        HtmlRender: function () {
            var that = this;
            $(this.Element).addClass('SheetQuery');
            if (!this.Editable) {
                this.$Input = $("<pre>");
                this.$InputBody.append(this.$Input);
            } else {
                this.ID = "FormQuery_" + $.IGuid();
                this.$addModel = $("<a class='form-query-addModel icon-newsvg'></a>");
                this.$Input = $("<div class='form-control form-query-add' placeholder='点击选择已有表单的数据'></div");
                this.$InputBody.css({ 'position': 'relative', 'min-width': '210px' });
                this.$InputBody.append(this.$Input).append(this.$addModel);
                //控件渲染改到点击时处理
                //setTimeout(that._renderDropDown(that), 0);//渲染下拉
                //setTimeout(that._renderModal(that), 0);//渲染模态框
            }
        },

        BindEvent: function () {
            var that = this;
            this.$addModel.one("click", function (e) {
                that._renderModal(that);
                that.$addModel.trigger("click");
            });
            this.$Input.one("click", function (e) {
                that._renderDropDown(that);
                that.$Input.trigger("click");
            });
        },
        // 获取元素相对屏幕的绝对位置
        _getAbsPosition: function (element) {
            var that = this;
            var left = 0;

            var abs = {
                x: 0, y: 0
            };

            //火狐浏览器下拉框位置问题
            var inputOffset = $(element).offset();
            abs.x = inputOffset.left;
            abs.y = inputOffset.top;
            //if (document.documentElement.getBoundingClientRect) {
            //    abs.x = element.getBoundingClientRect().left;
            //    abs.y = element.getBoundingClientRect().top;
            //    abs.y += document.body.scrollTop | document.documentElement.scrollTop + document.documentElement.scrollTop - document.documentElement.clientTop;
            //} else {
            //    abs.x = $(element).offset().left;
            //    abs.y = $(element).offset().top + $(element).outerHeight;
            //}
            return abs;
        },
        //加载下拉框数据
        _loadDropDownData: function (needClear) {
            var that = this;
            if (that.FilterProperties == undefined && that.MappingProperties != undefined) {
                that.FilterProperties = [];
                //主表和子表情况
                var $container = $(that.Element).closest("#SheetContent");
                var isInChild = that.DataField.indexOf(".") > -1;
                for (var field in that.MappingProperties) {
                    var mappingProperty = $container.find("div[data-datafield='" + field + "']");
                    if (mappingProperty.length > 0) {
                        var asFilter = mappingProperty.attr("data-asfilter");
                        var controlKey = mappingProperty.attr("data-controlkey");
                        //关联多选/关联表单/选人不做过滤条件
                        if (asFilter != undefined &&
                            asFilter == "true" &&
                            controlKey.toLowerCase() != "formquery" &&
                            controlKey.toLowerCase() != "formmultiquery" &&
                            controlKey.toLowerCase() != "formuser" &&
                            controlKey.toLowerCase() != "formmultiquery") {
                            that.FilterProperties.push(that.MappingProperties[field]);
                        }
                    }
                }
            }
            if (!that.IsQueryControl) {
                that._getAssociationFilterData();
            }
            if (needClear) {
                that.offset = 0;
            }
            var defaultParams = {
                ActionName: "DoAction",
                Command: 'Load',
                QueryCode: that.BOSchemaCode,
                Status: 1,
                SheetQuery: 1,
                //isFormControl: true,
                ListScene: 2,
                SheetCode: that.SchemaCode,
                DataField: that.DataField,
                SheetData: JSON.stringify(that.SheetData),
                scopeType: 3,
                offset: that.offset,
                IsSheetQueryDropDown: true
            };
            var searchName = that.$dropDownInput.val().trim();
            var searchParams = {};

            //把Name和关联属性放在一起
            var params = {};
            if (searchName) {

                if (that.associateChildSchema) {
                    params[that.BOSchemaCode + ".Name"] = searchName;
                } else {
                    params["Name"] = searchName;
                }
                if (that.FilterProperties != undefined && that.FilterProperties.length > 0) {
                    for (var i = 0; i < that.FilterProperties.length; i++) {
                        params[that.FilterProperties[i]] = searchName;
                    }
                }
            }
            searchParams['FilterProperty'] = JSON.stringify(params);

            $.extend(defaultParams, searchParams);
            //初始渲染时候不要执行，只有在点击过关联表单控件后才能执行以下请求。
            //原因是在子表中打开时候会很慢
            if (!that.FirstLoad) {
                var param = {}
                param.QueryCode = that.BOSchemaCode;
                param.SheetData = JSON.stringify(that.SheetData);
                param.DataField = that.DataField;
                param.SheetCode = that.SchemaCode;
                param.isAssociateForm = 1
                if (!needClear) {
                    param.pageNum = Math.ceil(that.offset / 10) + 1;
                }
                if (searchName) {
                    param["nameSchema"] = searchName;
                }

                HTTP.appRunPage(param).then((data) => {
                    if (data.Code == 0) {
                        that.LoadData = data.Result.ReturnData;
                        that._bindDataToDropDown(needClear, that.LoadData);
                    }
                })
                // that.Ajax('/App/OnAction', 'GET', { PostData: JSON.stringify(defaultParams) }, function (data) {
                //     if (data.Successful) {
                //         that.LoadData = data.ReturnData.Response.ReturnData;
                //         that._bindDataToDropDown(needClear, data.ReturnData.Response.ReturnData);
                //     }
                // }, true);
            }
        },
        //绑定过滤的数据到下拉框
        _bindDataToDropDown: function (needClear, data) {
            var that = this;
            that.$dropDownItemContainer.hide();
            if (needClear) {
                that.$dropDownItemContainer.empty();
            }
            if (data && data.length > 0) {
                that.offset += data.length;
                //判断是关联主表还是子表
                //表单中的控件直接通过BOSchemaInfo判断关联的是否是子表；列表过滤条件要根据返回值判断
                if (that.associateChildSchema == undefined) {
                    that.associateChildSchema = false;
                    for (var key in data[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            that.associateChildSchema = true;
                            break;
                        }
                    }
                }

                //如果是过滤条件则需要提供用户一个空项让用户匹配未填写关联表单的记录
                if (needClear && that.IsQueryControl) {
                    var arr = [];
                    if (that.associateChildSchema) {
                        var noSelectValue = {
                        };
                        var objectId = that.BOSchemaCode + '.ObjectId';
                        var name = that.BOSchemaCode + '.Name';
                        noSelectValue[objectId] = "--";
                        noSelectValue[name] = '--(空)';
                        arr.push(noSelectValue);
                    } else {
                        arr = [{
                            ObjectId: "--", Name: '--(空)'
                        }];
                    }
                    data = arr.concat(data);
                }
                var existObjectIds = that.$Input.data('ObjectId');
                if (existObjectIds) {
                    existObjectIds = existObjectIds.split(';');
                }
                if (!existObjectIds) {
                    existObjectIds = [];
                }
                for (var i = 0, len = data.length; i < len; i++) {
                    var id = $.IGuid();
                    var itemId = data[i].ObjectId;
                    var itemName = data[i].Name;
                    if (that.associateChildSchema) {
                        itemId = data[i][that.BOSchemaCode + '.ObjectId'];
                        itemName = data[i][that.BOSchemaCode + '.Name'];
                    }
                    itemName = (itemName == null || itemName == void 0) ? '--' : ($.trim(itemName) == '' ? '--' : itemName);
                    var $dropDownItemRow = $('<div class="row form-query-itemrow"></div>');
                    $dropDownItemRow.hover(function () {
                        $(this).find('label.form-query-item-label').css({
                            'background-color': '#eff7fd',
                            'color': '#38adff'
                        });
                    }, function () {
                        $(this).find('label.form-query-item-label').css({
                            'background-color': '#fff',
                            'color': '#818181'
                        })
                    });
                    var $dropDownItem = $('<input type="checkbox" data-itemid = "' + itemId + '"  id="' + id + '"  value="' + itemName + '" style="display:none;" />');
                    var $dropDownItemLabel = $('<label class="form-query-item-label" for= "' + id + '" data-itemid="' + itemId + '" title="' + itemName + '">' + itemName + '</label>');
                    if (that.IsQueryControl) {
                        $dropDownItemLabel.css('margin-left', '15px');
                        $dropDownItemRow.append($dropDownItem).append($dropDownItemLabel);
                        //对于搜索出来的数据，如果之前已经选过则要勾中
                        if ($.inArray(itemId, existObjectIds) > -1) {
                            $dropDownItem.prop('checked', true);
                        } else if (itemId == undefined) {//undefined情况要处理下
                            if ($.inArray('undefined', existObjectIds) > -1) {
                                $dropDownItem.prop('checked', true);
                            }
                        }
                    } else {
                        $dropDownItemRow.append($dropDownItemLabel);
                    }
                    that.$dropDownItemContainer.append($dropDownItemRow);
                    var eventName = 'click.';
                    if (that.DataField) {
                        eventName += that.DataField;
                    } else if (that.ID) {
                        eventName += that.ID;
                    }
                    $dropDownItem.off(eventName).on(eventName, function (e) {
                        // 
                        //这里不能清空Input
                        var $links = '';
                        var objectIds = '';
                        var checkState = $(this).is(':checked');
                        var decodedVal;
                        if (checkState) {//选中
                            var objectId = $(this).data('itemid');
                            decodedVal = decodeURIComponent($(this).val());
                            objectIds = that.$Input.data('ObjectId') || '';
                            if (objectIds.indexOf(objectId) > -1) {
                                return;
                            }
                            var link = '<a href="javascript:;" class="label label-info" style="background-color:#e2f0ff; color:#38ADFF;padding:0 6px 0 6px;position:relative;" title="' + decodedVal + '">' + decodedVal + '<i class="fa icon-close-middle" style="margin-left:5px;" data-objectId="' + objectId + '"></i></a>';

                            //添加时清空空的链接
                            if ($.trim(that.$Input.text().length > 0)) {
                                that.$Input.text("").append(link);
                            } else {
                                that.$Input.append(link);
                            }

                            //objectIds = that.$Input.data('ObjectId') || '';
                            if (objectIds != '' && objectIds.charAt(objectIds.length - 1) != ';') {
                                objectIds += ';';
                            }
                            objectIds += (objectId + ';');
                            that.$Input.data('ObjectId', objectIds);
                        } else {//取消选中
                            var objectId = $(this).data('itemid');
                            that.$Input.find()
                            objectIds = that.$Input.data('ObjectId');
                            objectIds = objectIds.replace(objectId + ';', '');
                            that.$Input.data('ObjectId', objectIds);
                            that.$Input.find('i[data-objectId="' + objectId + '"]').parent().remove();
                        }
                        that.isFirstSetValue = false;
                        //that.$Input.data('ObjectId', objectIds);
                        that.$Input.find('i').on('click', function () {
                            var $this = $(this);
                            $this.closest('a').remove();
                            var objectIds = that.$Input.data('ObjectId');
                            var thisObjectId = $this.attr('data-ObjectId');
                            objectIds = objectIds.replace(thisObjectId + ';', '');
                            that.$Input.data('ObjectId', objectIds);
                            that.OnChange();
                            that.$dropDownItemContainer.find('input[type="checkbox"][data-itemid="' + thisObjectId + '"]').prop('checked', false);
                        });
                        that.OnChange();
                    });
                    $dropDownItemLabel.off(eventName).on(eventName, function (e) {
                        if (that.IsQueryControl) {
                            //过滤条件
                        } else {
                            //表单控件
                            var objectId = $(this).data('itemid');
                            var name = $(this).text();
                            that.$Input && that.$Input.data("ObjectId", objectId).text(name);
                            that.OnChange.apply(that, [{
                                ObjectId: objectId, Name: name
                            }]);
                            that._toDetailLink();
                            that.$dropdown.hide();

                            //if ($.fn.FormGridView) {
                            //    var gridView = that.$Input.closest("[data-controlkey='FormGridView']");
                            //    var fGridView = $(gridView).FormGridView();
                            //    fGridView && fGridView.ResizeColumn(true);
                            //}
                        }
                        e.stopPropagation();
                    });
                }
            }
            that.$dropDownItemContainer.show();
        },
        //渲染FormQuery的下拉
        _renderDropDown: function (target) {
            this.offset = 0;
            var that = target;
            var h = that.$Input.outerHeight();
            if (h > 32) {
                //IE11中点击时候h会很大
                that.$Input.height(32);
                h = 32;
            }
            var w = that.$Input.outerWidth();
            var pos = that.$Input.position();
            // var position = that._getAbsPosition(that.$Input[0]);
            that.$dropdown = $('<div class="form-query-dropdown">').css({
                'left': pos.left,
                'top': h,
                'width': w
            });
            //绑定元素父元素的滚动事件，重新赋值$dropdown的高度和left
            //TODO  $(this.CurrentBody).find("div")范围 ,影响性能
            $.each($(this.CurrentBody).find("div"), function (index, obj) {
                $(obj).scroll(function () {
                    that.$dropdown.css("top", that.$Input.offset().top + that.$Input.outerHeight());
                });
            });

            // $(this.CurrentBody).on("scroll", function () {
            //     that.$dropdown.css("top", that.$Input.offset().top + that.$Input.outerHeight());
            // })

            var $dropDownInputRow = $('<div class="row" style="margin-left:0;margin-right:0;"></div>');

            that.$dropDownInput = $('<input type="text" class="form-control form-input search-input-dropdown" placeholder="输入表单名称查找"  />');
            that.$dropDownInput.off('keyup').on('keyup', function (event) {
                that.TimeOut && window.clearTimeout(that.TimeOut);
                that.TimeOut = setTimeout(function () { that._loadDropDownData(true) }, 1000);
                event.stopPropagation();
            });

            $dropDownInputRow.append(that.$dropDownInput);
            that.$dropDownItemContainer = $('<div class="form-query-container">')
            that.$dropdown.append($dropDownInputRow).append(that.$dropDownItemContainer);

            //绑定滚动事件
            that.$dropDownItemContainer.scroll(function () {
                var h_container = $(this).height();//窗口高度
                var h_scrollTop = $(this).scrollTop();//滚动条顶部
                if (0 + h_scrollTop >= $(this)[0].scrollHeight - h_container) {
                    that._loadDropDownData(false);
                }
            });
            //初始时候请求数据
            //that._loadDropDownData(true);
            //$('body').append(that.$dropdown);
            //Error：报表过滤情况CurrentBody是空的，
            //原因是在初始化控件的时候没有把元素append到DOM中，
            //所以在下面的点击事件中加了判断，如果不存在要先append到DOM中
            // $('.sheet-control.form-group.SheetQuery').append(that.$dropdown);
            $(that.CurrentBody).append(that.$dropdown);
            //点击文本框显示
            that.$Input.on('click.addModel', function () {
                //判断dom中是否有dropdown，如果没有就append进去
                //这种情况出现在render时候
                if ($(that.Element).css("visibility") == "hidden") {
                    return;
                }
                that.FirstLoad = false;
                var $body = $($(that.Element).closest("body"));
                if ($body.find('div.form-query-dropdown').length == 0) {
                    $body.append(that.$dropdown);
                }
                var searchText = that.$dropDownInput.val().trim();
                //如果有搜索记录则清空
                if (searchText != '') {
                    that.$dropDownInput.val('');

                }
                if (!that.IsQueryControl)
                    that._getAssociationFilterData();
                //每次打开下拉框都要重新加载数据
                //if (!$.isEmptyObject(that.SheetData))
                that._loadDropDownData(true);

                $('.form-query-dropdown').hide();
                var hh = '300px';
                if (that.IsQueryControl) {
                    hh = '200px';
                    that.$dropDownItemContainer.css('max-height', '150px');
                }
                //如果是列表过滤控件要重新获取坐标
                var h = that.$Input.outerHeight();
                var w = that.$Input.outerWidth();
                var wrapH = that.$Input.parent().outerHeight();
                var inputPos = that.$Input.position();
                var wrapPos = that.$Input.parent().position();
                var $tableContent = that.$Input.parents('div.table-content.table-edit');
                var position = that._getAbsPosition(that.$Input[0]);
                that.$dropdown.css({
                    'position': 'absolute',
                    'left': position.x,
                    'top': position.y + h,
                    'width': w
                    /*'height': hh*/
                });
                that.$dropdown.toggle();

                if (that.$dropdown.is(':hidden'))
                    return;

                //自动获取焦点
                that.$dropdown.find('input.search-input-dropdown').focus();
                //获取已经选中的item，在dropdown中设置勾中
                var selectedObjectIds = $(this).data('ObjectId');
                if (selectedObjectIds) {
                    var newSelectedObjectIds = [];
                    selectedObjectIds = selectedObjectIds.split(';');
                    for (var i = 0; i < selectedObjectIds.length; i++) {
                        if (selectedObjectIds[i] == 'undefined' || selectedObjectIds[i] == '') {
                            continue;
                        }
                        newSelectedObjectIds.push(selectedObjectIds[i]);
                    }
                    selectedObjectIds = newSelectedObjectIds;
                }
                if (selectedObjectIds && selectedObjectIds.length > 0) {
                    var checkboxItems = that.$dropDownItemContainer.find('input[type="checkbox"]');
                    for (var i = 0; i < checkboxItems.length; i++) {
                        $(checkboxItems[i]).prop('checked', false);
                        var itemObjectId = $(checkboxItems[i]).attr('data-itemid');
                        if ($.inArray(itemObjectId, selectedObjectIds) > -1) {
                            $(checkboxItems[i]).prop('checked', true);
                        }
                    }
                }
                //return false;
            });
            var $body = $(that.CurrentBody);
            var eventName = 'click.';
            if (that.DataField) {
                if (that.DataField.indexOf('.') > 0) {
                    //在子表
                    var trObjectId = $(that.Element).closest('tr').attr('data-objectid');
                    eventName += trObjectId + '.' + that.DataField;
                } else {
                    eventName += that.DataField;
                }
            } else if (that.ID) {
                eventName += that.ID;
            }
            //点击DropDown以外区域隐藏
            //后续要改进，不要每个控件绑定document的click事件，能不能在一个click里面隐藏所有的。需要考虑到主表，子表，列表过滤，报表过滤，列表默认值等地方
            $body.off(eventName).on(eventName, that, function (e) {
                var target = e.target;
                var ctrl = e.data;

                if (ctrl.$Input[0] != target && ctrl.$dropdown.find($(target)).length == 0) {
                    ctrl.$dropdown.hide();
                }
                //oEvent = oEvent || window.event;
                //oEvent.target
                //var position = that._getAbsPosition(that.$Input[0]);
                //var w = that.$dropdown.outerWidth(false);
                //var h = that.$dropdown.outerHeight(false) + that.$Input.outerHeight(false);
                //var mouseLeft = oEvent.pageX || window.event.pageX;
                //var mouseTop = oEvent.pageY || window.event.pageY;
                //if (mouseLeft < position.x || mouseLeft > position.x + w || mouseTop < position.y || mouseTop > position.y + h) {
                //    that.$dropdown.hide();
                //}
            });
        },
        //渲染 FormQuery的Modal
        _renderModal: function (target) {
            var that = target;
            that.ID = "FormQuery_" + $.IGuid();
            that.$modal = $("<div id='" + that.ID + "' class='modal fade modal-formquery' style='z-index:1000;'  data-backdrop='false' role='dialog'>" +
                "<div class='modal-dialog modal-lg modal-dialog-form'>" +
                "<div class='modal-content'>" +
                "<div class='modal-header modal-header-form'><div class='close' style='margin-top:-2px;' data-dismiss='modal'><span aria-hidden='true'  style='font-size:16px;'><i class='ivu-icon ivu-icon-close' :color='white'></i></span></div><h4 class='modal-title modal-title-form'>选择" + that.DisplayName + "</h4></div>" +
                "</div>" +
                "</div>" +
                "</div>");

            var $modalBody = $("<div class='modal-body'></div>");

            // 查询条件
            that.$searchForm = $("<div class='form-horizontal searchform myform-horizontal backgroundcolor'></div>");
            // 没有搜索框，暂时隐藏
            $modalBody.append(that.$searchForm);
            //that.$searchForm.hide()

            //查询条件按钮分割线
            that.$partingLine = $("<div style='border-bottom:1px solid #E3E7E9;text-align:center;'><i class='fa icon-arrow-up-double-b btn-up btnToggle' style='color:#e5e6e6;'></i></div>")
            // 没有搜索框，暂时隐藏
            $modalBody.append(that.$partingLine);
            //that.$partingLine.hide()

            var $modalFooter = $("<div class='modal-footer modal-footer-form'></div>");

            // 按钮
            that.$toolbar = $("<div class='toolbar text-left' style='margin-top:10px;'><div class='btn-group btn-group-sm' role='group'><button class='btn btn-ok btn-search btnSearch hide '><i class='fa fa-search'></i>查询</button><button class='btn btn-create btnAdd hide'><i class='fa icon-increase'></i>新增</button></div></div>");
            $modalBody.append(that.$toolbar);

            // 渲染加载
            that.$loading = $('<div class="ivu-spin ivu-spin-large" style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);"><div class="ivu-spin-main"><span class="ivu-spin-dot"></span> <div class="ivu-spin-text"></div></div></div>')
            $modalBody.append(that.$loading)
            /*
            <div class="loading-spin ivu-spin ivu-spin-large" style="display: none;"><div class="ivu-spin-main"><span class="ivu-spin-dot"></span> <div class="ivu-spin-text"></div></div></div>
            */
            // 表格
            that.Table_ID = "FormTable_" + $.IGuid();
            that.$table = $("<table id='" + that.Table_ID + "' ></table>");

            var pagerStr = '<div class="table-page" id="bar-' + that.Table_ID + '">' +
                '<div class="page-index">' +
                '<input type="text" value="1" class="Page_Index" />/<label class="Page_Count">1</label>' +
                '</div>' +
                '<div class="btn-group table-page_ButtonGroup" style="width: 160px;">' +
                '<button class="btn Page_Num_Pre">上一页</button>' +
                '<button class="btn Page_Num_Next">下一页</button>' +
                '</div>' +
                '<div class="page-size dropup">' +
                '<button class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                '<span class="Page_Per_Size">' + 10 + '</span>' +
                '<i class="fa fa-angle-down"></i>' +
                '</button>' +
                '<ul class="dropdown-menu">' +
                '<li><a>5</a></li>' +
                '<li><a>10</a></li>' +
                '<li><a>20</a></li>' +
                '<li><a>50</a></li>' +
                '</ul>' +
                '</div>' +
                '<div class="page-total">共0条</div>' +
                '</div>';
            var buttonStr = '<div class="btn-group btn-group-sm" role="group" style="width:100%;"><button class="btn btn-ok btnMultiSelect">确定</button></div>';
            $modalBody.append(that.$table).append(pagerStr);
            //如果关联查询控件在子表中则允许批量选择，增加确定按钮
            //新增的时候出现按钮
            //$modalBody.append('<div class="btn-group btn-group-sm" role="group" style="width:100%;"><button class="btn btn-default btn-sm btnMultiSelect" style="float:right;">确定</button></div>')
            $modalFooter.append(buttonStr);
            that.$modal.find(".modal-content").append($modalBody).append($modalFooter);
            //$("body").append(that.$modal
            $(that.CurrentBody).append(that.$modal);

            //that.$Input = $("<div class='form-control form-query-add' style='height:32px;'></div");
            //that.$InputBody.append(that.$Input);
            that.SheetData = {
            };
            that.TableNeedRefresh = false;//为true的情况：关联查询过滤规则中配置了主表单的字段
            that.$addModel.off("click").on("click", function () {
                that.$dropdown && that.$dropdown.hide();
                //关联表单信息
                var associationSchemaInfo = $(that.Element).attr('data-boSchemaInfo');
                if (associationSchemaInfo != void 0 && associationSchemaInfo != '') {
                    var infoJson = $.parseJSON(associationSchemaInfo);
                    that.associateChildSchema = infoJson.IsChildSchema;
                } else {
                    that.associateChildSchema = undefined;
                }

                that._getAssociationFilterData();
                that.$modal.modal("show");
            });

            that.SearchInitialized = false; // 查询条件是否已初始化
            that.TableInitialized = false; // 表格是否已初始化
            that.CheckedRows = [];//点击“确定”按钮或者“查询”按钮将勾选的行存入CheckedRows
            // modal的show事件
            that.$modal.on("show.bs.modal", function (e) {
                $.MsgFilter.show();
                if (that.IsQueryControl) {
                    that.SelectedItems = [];
                    var items = that.$Input.find('i');
                    for (var i = 0; i < items.length; i++) {
                        var $item = $(items[i]);
                        var objectId = $item.attr('data-objectid');
                        if (objectId == 'undefined') {
                            continue;
                        }
                        var name = $item.closest('a').text();
                        //Error 列表过滤部分只显示一个Item，但是ObjectId可能是多个
                        var arr = objectId.split(";");
                        for (var j = 0; j < arr.length; j++) {
                            if (arr[j] == "" || arr[j] == undefined) {
                                continue;
                            }
                            that.SelectedItems.push({
                                ObjectId: arr[j], Name: name
                            });
                        }
                    }
                }

                that.$table.bootstrapTable('uncheckAll');
                var currModal = this;
                if (!$.FormQueryData.PropertyQueryItems[that.BOSchemaCode] || !$.FormQueryData.PropertyQueryColumns[that.BOSchemaCode]) {

                    var param = {}
                    param.appId = that.BOSchemaCode;
                    // param.SheetData=JSON.stringify(that.SheetData);
                    // param.DataField=that.DataField;
                    // param.SheetCode= that.SchemaCode;
                    // param.isAssociateForm=1
                    that.$loading.show()
                    HTTP.getListSetting(param).then((data) => {
                        if (data.Code != 0) {
                            Message.error({
                                content: "没有设置可用列！",
                                duration: 3
                            });
                            return;
                        }
                        var ret = [];
                        ret.push(
                            {
                                "Align": null,
                                "CanBeQueryItem": true,
                                "ChildColumns": null,
                                "Code": "Name",
                                "DisplayName": "数据标题",
                                "IsChild": null,
                                "IsLabel": null,
                                "IsQueryItem": false,
                                "OptionValue": null,
                                "PropertyName": null,
                                "ShowMode": null,
                                "Sortable": false,
                                "Type": null,
                                "UnitType": null,
                                "Url": null,
                                "Visible": true
                            }
                        )
                        for (var index = 0; index < data.Data.ListViewData.length; index++) {
                            ret.push(data.Data.ListViewData[index])
                        }
                        //data ={"Successful":true,"ErrorMessage":null,"Logined":true,"ReturnData":{"Response":{"SchemaCode":"jrteesk4q79jt1kilmtmzw9w4","DisplayName":"待关联表单","Axis":"","AxisSortDirection":1,"SortBy":"CreatedTime","SortDirection":1,"DisplayMode":0,"Selectable":false,"Javascript":null,"QueryItems":null,"Actions":{"Create":{"Action":"Create","Icon":"fa-plus","Text":"新增"},"Import":{"Action":"Import","Icon":" fa-download","Text":"导入"},"Export":{"Action":"Export","Icon":" fa-upload","Text":"导出"},"Remove":{"Action":"Remove","Icon":" fa-times","Text":"删除"},"PrintQrCode":{"Action":"PrintQrCode","Icon":" fa-qrcode","Text":"打印二维码"}},"Columns":{"Name":{"Code":"Name","DisplayName":"数据标题","Visible":true,"Sortable":false,"Url":"/Form/DefaultSheet/jrteesk4q79jt1kilmtmzw9w4?SchemaCode=jrteesk4q79jt1kilmtmzw9w4\u0026BizObjectId={ObjectId}","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"CreatedBy":{"Code":"CreatedBy","DisplayName":"创建人ID","Visible":false,"Sortable":false,"Url":"/Account/Setting/{CreatedBy}","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"CreatedBy_Name":{"Code":"CreatedBy_Name","DisplayName":"创建人","Visible":false,"Sortable":false,"Url":"/Account/Setting/{CreatedBy}","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"OwnerId":{"Code":"OwnerId","DisplayName":"拥有者ID","Visible":false,"Sortable":false,"Url":"/Account/Setting/{OwnerId}","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"OwnerId_Name":{"Code":"OwnerId_Name","DisplayName":"拥有者","Visible":false,"Sortable":false,"Url":"/Account/Setting/{OwnerId}","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"OwnerDeptId":{"Code":"OwnerDeptId","DisplayName":"所属部门ID","Visible":false,"Sortable":false,"Url":"/Account/Setting/{OwnerDeptId}","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"OwnerDeptId_Name":{"Code":"OwnerDeptId_Name","DisplayName":"所属部门","Visible":false,"Sortable":false,"Url":"/Account/Setting/{OwnerDeptId}","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"CreatedTime":{"Code":"CreatedTime","DisplayName":"创建时间","Visible":false,"Sortable":true,"Url":"","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"ModifiedTime":{"Code":"ModifiedTime","DisplayName":"修改时间","Visible":false,"Sortable":true,"Url":"","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"F0000001":{"Code":"F0000001","DisplayName":"名字-单","Visible":true,"Sortable":true,"Url":"","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"F0000002":{"Code":"F0000002","DisplayName":"描述-多","Visible":true,"Sortable":false,"Url":"","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"F0000003":{"Code":"F0000003","DisplayName":"日期","Visible":true,"Sortable":true,"Url":"","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"F0000004":{"Code":"F0000004","DisplayName":"数字","Visible":true,"Sortable":true,"Url":"","Align":"right","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"F0000005":{"Code":"F0000005","DisplayName":"下拉框","Visible":true,"Sortable":true,"Url":"","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0},"F0000006":{"Code":"F0000006","DisplayName":"复选框","Visible":true,"Sortable":true,"Url":"","Align":"left","IsChild":false,"IsLabel":false,"ChildColumns":null,"ShowMode":0}},"ReturnData":[],"DataCount":0,"StartTimePropertyName":null,"WorkflowState":{},"IconProperty":"","ListScopeType":3,"ChildSchemaCode":"","PagedByParent":true,"RequireAssociatedBoHeaders":true,"TimeLineAxisDisplayFormat":null,"Successful":true,"IsMobile":false,"Message":"","Infos":[],"IsExternalForm":false,"ExternalFormUrl":null,"RecentChange":null,"Errors":[],"DebugTrack":null,"ChangeSet":null}}};
                        $.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = ret;
                        //$.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = data.ReturnData.SortedColumns;
                        //调整initSearchParams位置为initTable之前，原因是在关联列表中初始时候searchform是空
                        $.FormQueryData.PropertyQueryItems[that.BOSchemaCode] = [];
                        $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode] = {};

                        var qry = [];
                        qry.push({
                            "PropertyName": "Name",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "数据标题",
                            "DataType": 14,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })

                        qry.push({
                            "PropertyName": "CreatedTime",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "创建时间",
                            "DataType": 5,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })


                        that._initSearchParams(qry, {});




                        if (!that.TableInitialized || that.TableNeedRefresh) {
                            that._initTable($.FormQueryData.PropertyQueryColumns[that.BOSchemaCode]);//合并表头
                        } else {
                            that._setRowChecked();
                        }
                        that.afterTableInit();
                    }).finally(() => {
                        that.$loading.hide()
                    })



                    // that.Ajax("/App/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                    //     if (data.ReturnData.Response.Columns.length == 0 && data.ReturnData.QueryItems.length == 0) {
                    //         $(currModal).modal("hide");
                    //         //$.IShowError("没有设置可用列！");
                    //         Message.error({
                    //             content:"没有设置可用列！",
                    //             duration: 3
                    //         });
                    //         return;
                    //     }
                    //     //$.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = data.ReturnData.Response.Columns;
                    //     $.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = data.ReturnData.SortedColumns;
                    //     //调整initSearchParams位置为initTable之前，原因是在关联列表中初始时候searchform是空
                    //     $.FormQueryData.PropertyQueryItems[that.BOSchemaCode] = data.ReturnData.QueryItems;
                    //     $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode] = JSON.parse(data.ReturnData.QueryDefaultValues);
                    //     if (!that.SearchInitialized) {
                    //         that._initSearchParams(data.ReturnData.QueryItems, $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode]);
                    //     }

                    //     if (!that.TableInitialized || that.TableNeedRefresh) {
                    //         that._initTable($.FormQueryData.PropertyQueryColumns[that.BOSchemaCode]);//合并表头
                    //     } else {
                    //         that._setRowChecked();
                    //     }
                    //     that.afterTableInit();
                    // });
                }
                else {
                    var qry = [];
                    qry.push({
                        "PropertyName": "Name",
                        "DefaultValue": "",
                        "OrganizationType": 2,
                        "DisplayName": "数据标题",
                        "DataType": 14,
                        "DataDictItemName": "",
                        "OptionalValues": null,
                        "itemValues": null,
                        "IsBoReservedPropertiesOnly": true,
                        "DisplayFormat": "",
                        "AssociationSchemaCode": "",
                        "UnitSelectRange": null,
                        "SelectedValues": "",
                        "DateTimeMode": "",
                        "AllowNotNull": true,
                        "FilterValue": "",
                        "Visible": true,
                        "AssociationField": null
                    })

                    qry.push({
                        "PropertyName": "CreatedTime",
                        "DefaultValue": "",
                        "OrganizationType": 2,
                        "DisplayName": "创建时间",
                        "DataType": 5,
                        "DataDictItemName": "",
                        "OptionalValues": null,
                        "itemValues": null,
                        "IsBoReservedPropertiesOnly": true,
                        "DisplayFormat": "",
                        "AssociationSchemaCode": "",
                        "UnitSelectRange": null,
                        "SelectedValues": "",
                        "DateTimeMode": "",
                        "AllowNotNull": true,
                        "FilterValue": "",
                        "Visible": true,
                        "AssociationField": null
                    })

                    if (!that.SearchInitialized) {
                        that._initSearchParams(qry, {});
                    }

                    if (!that.TableInitialized || that.TableNeedRefresh) {
                        that._initTable($.FormQueryData.PropertyQueryColumns[that.BOSchemaCode]);
                    } else {
                        that._setRowChecked();
                    }



                }
                that.afterTableInit();
            });
            that.$modal.on("hidden.bs.modal", function (e) {
                $.MsgFilter.remove();
            });
            var $btnAdd = that.$toolbar.find(".btnAdd");
            // 只有表单中的关联查询允许新增关联对象
            if (that.IsRunnable && that.CanCreate && $(that.Element).hasClass("sheet-control")) {
                // 新增关联对象
                $btnAdd.removeClass("hide");
                var hasClick = false
                $btnAdd.off("click").on("click", function () {
                    if (hasClick) return
                    hasClick = true
                    var params = {
                        ActionName: "GetBizObjectSchemaDisplayName",
                        SchemaCode: that.BOSchemaCode,
                        flag: $.IGuid()
                    }
                    HTTP.getBizObjectSchemaDisplayName(that.BOSchemaCode).then((data) => {
                        if (data.code == 0) {
                            //var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&SheetQueryField=" + that.DataField;
                            // if (that.BizObjectId) {
                            //     url += "&SheetQueryRowId=" + that.BizObjectId;
                            // }
                            // that.$modal.modal("hide");
                            // $.ISideModal.Show(url, data.data.DisplayName);
                            let instanceNew = Modal.newInstance({
                                //scrollable:true,
                                title: data.data.DisplayName,
                                footerHide: true,
                                maskClosable: false,
                                closable: true,
                                render: (h) => {
                                    return h(addRelativeModal, {
                                        props: {
                                            code: that.BOSchemaCode
                                        },
                                        on: {
                                            close: () => {
                                                // 提交时关闭弹窗
                                                $('.add-relative-modal .fa.icon-submit')
                                                    .off('click')
                                                    .on('click', () => {
                                                        instanceNew.remove();
                                                        trigger.off('start-and-load-flow').on('start-and-load-flow', () => {
                                                            that.$table.bootstrapTable("selectPage", 1);
                                                        });
                                                    })
                                            }
                                        }
                                    })
                                }
                            })
                            var options = { showCancel: true, width: "800px" };
                            options.onRemove = function () {
                                instanceNew = null;
                            };
                            instanceNew.show(options);
                        }
                    }).finally(() => {
                        hasClick = false
                    })
                    // that.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                    //     if (data.Successful) {
                    //         var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&SheetQueryField=" + that.DataField;
                    //         if (that.BizObjectId) {
                    //             url += "&SheetQueryRowId=" + that.BizObjectId;
                    //         }
                    //         that.$modal.modal("hide");
                    //         $.ISideModal.Show(url, data.ReturnData.DisplayName);
                    //     }
                    // });
                });
            }
            else {
                $btnAdd.addClass("hide");
            }

            //子表批量选择功能
            var $btnMultiSelect = that.$modal.find('.btnMultiSelect');
            //批量选择确定
            $btnMultiSelect.off('click').on('click', function () {
                that.$modal.modal('hide');
                $('.table-tip').hide();
                if (that.IsQueryControl) {
                    if (that.associateChildSchema == undefined) {
                        that.associateChildSchema = false;
                        for (var key in that.CheckedRows[0]) {
                            if (key.toLowerCase().indexOf('.objectid') > -1) {
                                that.associateChildSchema = true;
                                break;
                            }
                        }
                    }
                    var objectIdStr = 'ObjectId';
                    var nameStr = 'Name';
                    if (that.associateChildSchema) {
                        objectIdStr = that.BOSchemaCode + '.ObjectId';
                        nameStr = that.BOSchemaCode + '.Name';
                    }
                    //用于列表过滤条件
                    that.$Input.empty();
                    that.$Input.data('ObjectId', '').empty();
                    //Error：checkedRows有重复

                    for (var i = 0; i < that.CheckedRows.length; i++) {
                        var objectId = that.CheckedRows[i][objectIdStr];
                        if (!objectId) {
                            continue;
                        }
                        var name = that.CheckedRows[i][nameStr] || "--";
                        var link = '<a href="javascript:;" class="label label-info" style="position:relative;">' + name + '<i class="fa icon-close-middle" style="margin-left:5px;" data-objectId="' + objectId + '"></i></a>';
                        that.$Input.append(link);
                        objectIds = that.$Input.data('ObjectId') || '';
                        objectIds += (objectId + ';');
                        that.$Input.data('ObjectId', objectIds);
                        //that.$dropDownItemContainer.find('input[type="checkbox"][data-itemid="' + thisObjectId + '"]').prop('checked', true);
                    }
                    that.$Input.find('i').on('click', function () {
                        var $this = $(this);
                        $this.closest('a').remove();
                        var objectIds = that.$Input.data('ObjectId');
                        var thisObjectId = $this.attr('data-ObjectId');
                        objectIds = objectIds.replace(thisObjectId + ';', '');
                        that.$Input.data('ObjectId', objectIds);
                        that.OnChange();
                        that.$dropDownItemContainer.find('input[type="checkbox"][data-itemid="' + thisObjectId + '"]').prop('checked', false);
                    });
                    that.OnChange();
                    return;
                }

                //获取check的行
                var datafield = that.DataField;
                //获取当前FormQuery所在行
                var gridView = that.$Input.closest("[data-controlkey='FormGridView']");
                var fGridView = $(gridView).FormGridView();
                var currTr = that.$Input.closest('tr');//当前行
                var nextTr = $(currTr).nextAll('tr');//后续行
                //先将当前行添加进去
                var currQuery = $(currTr).find('[data-datafield="' + datafield + '"][data-controlkey="FormQuery"]').FormQuery();
                var queryRows = [];
                queryRows.push(currQuery);
                if (nextTr.length == 0) {
                    //后续没有行，直接新增行
                    if (fGridView && fGridView.Editable) {
                        for (var i = 0; i < that.CheckedRows.length - 1; i++) {
                            fGridView.AddRow();
                            var newTr = $(currTr).nextAll('tr').last();
                            var newQuery = $(newTr).find('[data-datafield="' + datafield + '"][data-controlkey="FormQuery"]').FormQuery();
                            queryRows.push(newQuery);
                        }
                    }
                } else {
                    //后续有行，需要判断行是否为空，取空行
                    var hasAddRow = false;//标记是否新增过行，如果新增过行则不需要便利已有行了
                    for (var i = 0; i < that.CheckedRows.length - 1; i++) {
                        var pushedOldRow = false;//标识是否将已有行加入queryRows
                        while ($(currTr).next('tr').length > 0 && !hasAddRow) {
                            var nextTr = $(currTr).next('tr');
                            var nextQuery = $(nextTr).find('[data-datafield="' + datafield + '"][data-controlkey="FormQuery"]').FormQuery();
                            var oldQueryValue = nextQuery.GetValue();
                            currTr = nextTr;
                            if (oldQueryValue != '' && oldQueryValue != void 0) {
                            } else {
                                queryRows.push(nextQuery);
                                pushedOldRow = true;
                                break;
                            }
                        }
                        //添加新行
                        if (!pushedOldRow) {
                            hasAddRow = true;
                            if (fGridView.Editable) {
                                fGridView.AddRow();
                                var newTr = $(currTr).nextAll('tr').last();
                                var newQuery = $(newTr).find('[data-datafield="' + datafield + '"][data-controlkey="FormQuery"]').FormQuery();
                                queryRows.push(newQuery);
                            }
                        }
                    }
                }

                //批量赋值
                setTimeout(function () {
                    for (var i = 0; i < that.CheckedRows.length; i++) {
                        var row = that.CheckedRows[i];
                        var objectId = row['ObjectId'];
                        var name = row['Name'];
                        if (that.associateChildSchema == true) {
                            objectId = row[that.BOSchemaCode + '.ObjectId'];
                            name = row[that.BOSchemaCode + '.Name'];
                        } else if (that.associateChildSchema == undefined) {//兼容旧的
                            for (var key in row) {
                                if (key.toLowerCase().indexOf('.objectid') > -1) {
                                    objectId = row[key];
                                }
                                if (key.toLowerCase().indexOf('.name') > -1) {
                                    name = row[key];
                                }
                            }
                        }
                        if (name == null || $.trim(name) == '') {
                            name = '--';
                        }
                        if (queryRows[i] == undefined) {
                            continue;
                        }
                        queryRows[i].$Input && queryRows[i].$Input.data("ObjectId", objectId).text(name);
                        queryRows[i].OnChange.apply(queryRows[i], [row]);
                        queryRows[i]._toDetailLink();
                    }
                    ////调整子表列宽
                    //if (!$.isEmptyObject(that.ObjectId)) {
                    //    var gridViewCtrl = $(that.Element).closest('div[data-controlkey="FormGridView"]');
                    //    if (gridViewCtrl.length > 0) {
                    //        gridViewCtrl = gridViewCtrl.FormGridView();
                    //        gridViewCtrl && gridViewCtrl.ResizeColumn(true);
                    //    }
                    //}
                }, 0);
            });
        },
        afterTableInit: function () {
            var that = this;
            //如果是修改要隐藏“确定”按钮（确定按钮只有在关联查询字段在子表中且在新增时候显示）
            if (that.DataField != undefined) {
                //在表单中
                if (that.DataField.indexOf('.') == -1 || (that.$Input.find('a').attr('title') != undefined && that.$Input.find('a').attr('title') != '') || (that.DataField.indexOf(".") > -1) && !that.isFirstSetValue) {
                    //不是子表字段或者是修改值情况要隐藏checkbox和确定按钮
                    that.$modal.find('.btnMultiSelect').addClass('hide');
                    that.$table.bootstrapTable('hideColumn', 'checkcolumn');
                } else {
                    //显示
                    that.$modal.find('.btnMultiSelect').removeClass('hide');
                    that.$table.bootstrapTable('showColumn', 'checkcolumn');
                }
            } else {
                //显示
                that.$modal.find('.btnMultiSelect').removeClass('hide');
                that.$table.bootstrapTable('showColumn', 'checkcolumn');
            }
            //判断是否要合并表头
            that._setColumnColspan(that.TableAllColumns);
        },

        //获取关联表单过滤条件中控件的值
        _getAssociationFilterData: function () {
            //判断关联查询是否配置了过滤规则
            //如果配置了过滤规则且规则中有当前主表单的字段
            //则要取主表单中的字段
            //兼容旧的bofilter            // 
            var that = this;
            if (that.DataField == void 0) {
                return;
            }
            var bofilter = $(that.Element).attr('data-bofilter');
            if (that.AssociationFilter || bofilter) {
                var rule = that.AssociationFilter.Rule || $.parseJSON(bofilter).Rule;
                if (rule && rule.length > 0) {
                    var controlsList = $.ControlManager.Controls;
                    var hasCreatedByCtrl = false;//是否有创建者控件
                    var hasOwnerCtrl = false;//是否有拥有者控件
                    var hasOwnerDeptCtrl = false;//是否有所属部门控件
                    console.log(store.state.listview)
                    var controls = controlsList[that.SchemaCode + "_" + store.state.listview.currentTabIndex]
                    for (var control in controls) {
                        var ctrl = controls[control];
                        if (ctrl.IsQueryControl) {
                            continue;
                        }
                        var controlDataField = ctrl.DataField;
                        if (controlDataField == 'CreatedBy.FullName') {
                            controlDataField = controlDataField.split('.')[0];
                            hasCreatedByCtrl = true;
                        }
                        if (controlDataField == 'OwnerId') {
                            hasOwnerCtrl = true;
                        }
                        if (controlDataField == 'OwnerDeptId') {
                            hasOwnerDeptCtrl = true;
                        }
                        //rule.indexOf(controlDataField)<0这样不能判断rule中是否有controlDataField,例如rule:{D00001.helloworld}=="hi",controlDataField:hello
                        if (rule.indexOf(controlDataField + '}') < 0 || controlDataField == that.DataField) continue;
                        //如果rule中包含controlDataField，则应该是以如下形式存在
                        //{xx}或者{xxx.xx}形式，主表中的字段是{controlDataField}，子表中字段是{xxx.controlDataField}
                        var ctrlFieldIndex = rule.indexOf(controlDataField + '}');
                        var prefix = rule.slice(ctrlFieldIndex - 1, ctrlFieldIndex);
                        if (prefix != '{' && prefix != '.') {
                            continue;
                        }
                        //字表中的control不调用SaveDataField，由子表自己调用SaveDataField保存值
                        var controlValue = '';
                        if (controlDataField == 'CreatedBy') {
                            controlValue = []
                            controlValue.push($.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].id.toString());
                        } else {
                            if (ctrl.DataField == void 0 || controlDataField == "Comments") continue;
                            //判断关联查询控件是否在子表中
                            if (controlDataField.indexOf('.') > 0 && ctrl.Type != 26 && ctrl.Type != 27) {
                                //规则中的字段在子表中
                                if (that.DataField.indexOf('.') > 0) {
                                    //获取与关联查询控件同一行的子表控件
                                    var $tr = $(that.Element).closest('tr');
                                    var thisRowCtrl = $tr.find('div[data-datafield="' + controlDataField + '"]');
                                    if (thisRowCtrl.length > 0) {
                                        controlValue = $(thisRowCtrl[0]).JControl().GetValue();
                                    }
                                } else {
                                    var $ctrl = $('div[data-datafield="' + controlDataField + '"]').not('.table_th');
                                    if ($ctrl != undefined) {
                                        controlValue = [];
                                        for (var i = 0; i < $ctrl.length; i++) {
                                            controlValue.push($($ctrl[i]).JControl().GetValue());
                                        }
                                    }
                                }
                            } else {
                                if (ctrl.Type == 26 || ctrl.Type == 27) {
                                    //单人
                                    //控件没有渲染的情况
                                    if (!ctrl.Visible) {
                                        if (ctrl.Type == 26) {
                                            controlValue = ctrl.Value[0].UnitId;
                                        } else {

                                        }
                                    } else {
                                        controlValue = ctrl.GetUnitIDs();
                                    }
                                } else if (ctrl.Type == 7) {
                                    controlValue = ctrl.GetNum();
                                } else {
                                    controlValue = ctrl.GetValue();
                                }
                            }
                        }
                        that.SheetData[controlDataField] = controlValue;
                        that.TableNeedRefresh = true;
                        //if (controlValue) break;
                    }
                    // if (!hasCreatedByCtrl) {
                    //     that.SheetData["CreatedBy"] = $.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].UnitId;
                    // }
                    // if (!hasOwnerCtrl) {
                    //     that.SheetData["OwnerId"] = $.SmartForm.ResponseContext.ReturnData.OwnerId.Value[0].UnitId;
                    // }
                    // if (!hasOwnerDeptCtrl) {
                    //     that.SheetData["OwnerDeptId"] = $.SmartForm.ResponseContext.ReturnData.OwnerDeptId ? ($.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0] != undefined ? $.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0].UnitId : null) : null;
                    // }
                    // that.SheetData["CreatedTime"] = $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value;
                    // that.SheetData["ParentObjectId"] = $.SmartForm.ResponseContext.BizObjectId;
                }
            }
        },
        //判断是否要合并表头
        _setColumnColspan: function (columns) {
            if (columns == void 0 || columns.length == 0) {
                return;
            }

            var colspantr = this.$table.find('thead tr[class="tr-colspan"]');
            if (colspantr != void 0 && colspantr.length > 0) {
                return;
            }

            var columnsCounter = {}; //统计主表字段和子表字段数量

            var parentColumnCount = 0;
            var childColumnCount = 0;

            for (var i = 0; i < columns.length; i++) {
                var field = columns[i].field;
                if (!columns[i].visible || field == undefined) {
                    continue;
                }
                if (field.indexOf('.') > -1) {
                    childColumnCount++;
                    var childField = field.slice(0, field.indexOf("."));
                    if (columnsCounter[childField] != undefined) {
                        columnsCounter[childField]++;
                    } else {
                        columnsCounter[childField] = 1;
                    }
                } else {
                    parentColumnCount++;
                    columnsCounter[field] = 0;
                }
            }

            if (childColumnCount > 0) {
                if (this.$table.find('th[data-field="checkcolumn"]').length == 0 && this.DataField.indexOf('.') > 0) {
                    //checkbox不可见
                    childColumnCount++;
                    parentColumnCount--;
                }


                //var tr = $('<tr class="tr-colspan"></tr>').append('<th colspan="' + parentColumnCount + '" style="text-align:center;">主表</th>').append('<th colspan="' + childColumnCount + '" style="text-align:center;">子表</th>');
                //var thead = this.$table.find('thead');
                var oldtr = this.$table.find('thead tr');
                //$(tr).insertBefore(oldtr);
                var columnCount = childColumnCount + parentColumnCount;
                var $topTr = $("<tr class='tr-colspan' style='border-bottom:none'></tr>");
                //for (var i = 0; i < columnCount; i++) {
                //    $topTr.append("<th></th>");
                //}
                for (var key in columnsCounter) {
                    if (columnsCounter[key] == 0) {
                        var $title = oldtr.find("th[data-field='" + key + "']");
                        $topTr.append($("<th rowspan='2'>").html($title.html()).attr("data-field", $title.attr("data-field")));
                        $title.hide();
                    } else {
                        $topTr.append("<th colspan='" + columnsCounter[key] + "' style='text-align:center;border-bottom:1px solid #e2e6e8'>子表</th>")
                    }
                }
                $topTr.insertBefore(oldtr);
            }
        },
        _checkRows: function (rows) {
            var that = this;
            var childObjectId = undefined;
            //先判断是check的是单行还是多行
            var tempRows = that.CheckedRows;
            if (that.associateChildSchema == true) {
                childObjectId = that.BOSchemaCode + '.ObjectId';
            }
            if ($.isArray(rows)) {
                if (that.associateChildSchema == undefined) {
                    //兼容旧的
                    for (var key in rows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < rows.length; i++) {
                    var rowExist = false;
                    for (var j = 0; j < tempRows.length; j++) {
                        if (childObjectId != undefined) {
                            if (rows[i][childObjectId] == tempRows[j][childObjectId]) {
                                rowExist = true;
                                break;
                            }
                        } else {
                            if (rows[i]['ObjectId'] == that.CheckedRows[j]['ObjectId']) {
                                rowExist = true;
                                break;
                            }
                        }
                    }
                    if (!rowExist) {
                        that.CheckedRows.push(rows[i]);
                    }
                }
            } else {
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                var rowExist = false;
                for (var i = 0; i < tempRows.length; i++) {
                    if (childObjectId != undefined) {
                        if (tempRows[i][childObjectId] == rows[childObjectId]) {
                            rowExist = true;
                            break;
                        }
                    } else {
                        if (tempRows[i]['ObjectId'] == rows['ObjectId']) {
                            rowExist = true;
                        }
                    }
                }
                if (!rowExist) {
                    that.CheckedRows.push(rows);
                }
            }
        },
        _unCheckRows: function (rows) {
            var that = this;
            var childObjectId = undefined;
            var tempRows = that.CheckedRows;
            if (that.associateChildSchema == true) {
                childObjectId = that.BOSchemaCode + '.ObjectId';
            }
            if ($.isArray(rows)) {//多行
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < rows.length; i++) {
                    for (var j = 0; j < tempRows.length; j++) {
                        if (childObjectId != undefined) {
                            that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                                return item[childObjectId] == rows[i][childObjectId];
                            }, true);
                        } else {
                            that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                                return item['ObjectId'] == rows[i]['ObjectId'];
                            }, true);
                        }
                    }
                }
            } else {//单行
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < tempRows.length; i++) {
                    if (childObjectId != undefined) {
                        //if (tempRows[i][childObjectId] == rows[childObjectId]) {
                        //移除行
                        //that.CheckedRows.splice($.inArray(rows, that.CheckedRows), 1);
                        //}
                        that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                            return item[childObjectId] == rows[childObjectId];
                        }, true);
                    } else {
                        that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                            return item['ObjectId'] == rows['ObjectId'];
                        }, true);
                    }
                }
            }
        },
        _initSearchParams: function (queryItems, queryDefaultValues) {
            var that = this;
            if (!queryItems || queryItems.length == 0) {
                this.$searchForm.hide();
                this.$partingLine.hide();
                return;
            }

            var searchHtml = "";
            var showCount = 0;
            for (var i = 0, len = queryItems.length; i < len; i++) {
                var queryItem = queryItems[i];
                if (queryItem.Visible == false) {
                    continue;
                }
                searchHtml += (showCount % 2 == 0 ? "<div class='form-group form-group-sm myform-group mgb5' style='margin-bottom:10px;margin-left:15px!important'>" : "");
                switch (queryItem.DataType) {
                    case 1:
                        //searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><span class="mycheckbox" data-propertyname="' + queryItem.PropertyName + '"><label class="checkbox-inline"><input type="checkbox" class="myform-control" value="true" style="display:block;" /> 是</label><label class="checkbox-inline"><input type="checkbox" value="false" style="display:block;" /> 否</label></span></div>';
                        //searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><span class="mycheckbox" data-propertyname="' + queryItem.PropertyName + '"><label class="checkbox-inline"><input type="checkbox" value="true" style="display:block;" /> 是</label><label class="checkbox-inline"><input type="checkbox" value="false" style="display:block;" /> 否</label></span></div>';
                        var inputId = $.IGuid();

                        //把默认选中的值带进来
                        var yesValue = queryItem.DefaultValue == "true" ? "true" : "false";
                        var noValue = queryItem.DefaultValue == "false" ? "true" : "false";

                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName +
                            '</label><div class="col-sm-4 pdt5"><span class="mycheckbox" data-propertyname="' + queryItem.PropertyName + '">' +
                            '<input type="checkbox" id="' + inputId + 't" value="' + yesValue + '" style="display:none;" /><label for="' + inputId + 't" class="checkbox-inline" style="margin:2px 10px 0 0"> 是</label>' +
                            '<input type="checkbox" id="' + inputId + 'f" value="' + noValue + '" style="display:none;" /> <label for="' + inputId + 'f" class="checkbox-inline" style="margin:2px 10px 0 0">否</label></span></div>';

                        break;
                    case 14:
                        if (queryItem.AssociationSchemaCode) {
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><div class="mycomboboxlist" data-dataField="' + queryItem.PropertyName + '" data-schemaCode="' + this.BOSchemaCode + '" data-width="100%" data-defalutvalue="' + queryItem.DefaultValue + '"> </div></div>';
                        }
                        else if (queryItem.SelectedValues && queryItem.SelectedValues !== "") {
                            var checkItemsHtml = "";
                            var checkItems = queryItem.SelectedValues.split(";");
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5">';
                            searchHtml += "<select id='" + queryItem.PropertyName + "' multiple='multiple' class='mymultiselect'>";
                            checkItemsHtml += "<option value='--'>--(空值)</option>";
                            for (var ci = 0, clen = checkItems.length; ci < clen; ci++) {
                                checkItemsHtml += "<option value='" + checkItems[ci] + "'> " + checkItems[ci] + "</option>";
                            }
                            searchHtml += checkItemsHtml;
                            searchHtml += "</select></div>";
                        }
                        else {
                            if (queryItem.PropertyName == "SeqNo") {
                                searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><input class="form-control mytext " type="text" data-propertyname="' + queryItem.PropertyName + '" /></div>';
                            }
                            else {
                                searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5"><div class="mycombobox" data-dataField="' + queryItem.PropertyName + '" data-schemaCode="' + this.BOSchemaCode + '" data-width="100%" data-defalutvalue="' + queryItem.DefaultValue + '"> </div></div>';
                            }
                        }
                        break;

                    case 13:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><input class="form-control mytext " type="text" data-propertyname="' + queryItem.PropertyName + '" /></div>';
                        break;
                    case 7:
                    case 9:
                    case 11:
                    case 35:

                        if (queryItem.DisplayName == "Status") {
                            //关联查询中的的筛选,隐藏流程状态
                            //add by jnyf
                            continue;
                            //流程状态
                            searchHtml += '<label class="col-sm-2 control-label">流程状态</label><div class="col-sm-4 pdt5">';
                            searchHtml += '<select id="' + queryItem.DisplayName + '" multiple="multiple" class="mymultiselect">';
                            searchHtml += '<option value="进行中">进行中</option><option value="已结束">已结束</option><option value="已取消">已取消</option>';
                            searchHtml += '</select>';
                            searchHtml += '</div>';
                        } else {
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><div class="input-group mynum" data-propertyname="' + queryItem.PropertyName + '"><div class="input-group-addon">从</div><input type="text" class="form-control" /><div class="input-group-addon" style="border-width:1px 0 1px 0">至</div><input type="text" class="form-control" /></div></div>';
                        }
                        break;
                    case 5:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="input-group mydatetime" data-propertyname="' + queryItem.PropertyName + '"><div class="input-group-addon">从</div><input type="text" data-datetimemode="' + queryItem.DateTimeMode + '" class="form-control mydatetimepicker mytimestart" /><div class="input-group-addon" style="border-width:1px 0 1px 0">至</div><input type="text" data-datetimemode="' + queryItem.DateTimeMode + '" class="form-control mydatetimepicker mytimeend" /></div></div>';
                        break;
                    case 26:
                        var tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-width="100%"></div></div>';
                        if (queryItem.PropertyName == 'OwnerId' || queryItem.PropertyName == 'CreatedBy') {
                            tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-orgunitvisible="false" data-width="100%"></div></div>';
                        } else if (queryItem.PropertyName == 'OwnerDeptId') {
                            tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-orgunitvisible="true" data-uservisible="false" data-width="100%"></div></div>';
                        }
                        searchHtml += tempHtml;
                        break;
                    case 50:
                    case 51:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 mydropdown pdt5" data-propertyname="' + queryItem.PropertyName + '" data-boschemacode="' + queryItem.AssociationSchemaCode + '"></div>';
                        break;
                }
                searchHtml += ((showCount % 2 || showCount === len - 1) != 0 ? "</div>" : "");
                showCount++;
            }
            this.$searchForm.append(searchHtml);

            this.$searchForm.find(".mycombobox").each(function () {
                var $combobox = $(this);
                var schemacode = $combobox.attr("data-schemaCode");
                var datafield = $combobox.attr("data-dataField");
                var defaultvalue = $combobox.attr("data-defalutvalue");
                var mycombobox = $combobox.FormComboBox({
                    IsQueryControl: true,
                    SchemaCode: schemacode,
                    DataField: datafield,
                    DefaultValue: defaultvalue,
                    Width: "50%",
                    OnChange: function () {
                        that._refreshTable(0);
                    },
                });
            });
            this.$searchForm.find(".mycombobox").removeClass("form-group");

            this.$searchForm.find(".mycomboboxlist").each(function () {
                var $combobox = $(this);
                var schemacode = $combobox.attr("data-schemaCode");
                var datafield = $combobox.attr("data-dataField");
                var defaultvalue = $combobox.attr("data-defalutvalue");
                var mycomboboxlist = $combobox.FormComboBoxList({
                    IsQueryControl: true,
                    Width: "50%",
                    OnChange: function () {
                        that._refreshTable(0);
                    },
                });
            });
            this.$searchForm.find(".mycomboboxlist").removeClass("form-group");


            // 统一初始化datetimepicker
            this.$searchForm.find(".mydatetimepicker").each(function () {
                var $picker = $(this);
                var minView = 2;
                var startView = 2;
                var mode = $picker.attr("data-datetimemode");
                if (!mode) {
                    mode = "yyyy-mm-dd";
                }
                if (mode == "yyyy-mm-dd hh:ii") {
                    minView = 0;
                }
                $picker.datetimepicker({
                    language: 'zh-CN',
                    format: mode,
                    todayBtn: true,
                    container: $picker.closest(".modal-dialog"),
                    autoclose: true,
                    startView: startView, // 选择器打开后首先显示的视图
                    minView: minView// 选择器能够提供的最精确的视图
                }).on("changeDate", function () {
                    that._refreshTable(0);
                });;
            });
            // 统一初始化选人控件
            var $myuserpicker = this.$searchForm.find(".myuserpicker");
            if (!$.isEmptyObject($myuserpicker)) {
                for (var r = 0; r < $myuserpicker.length; r++) {
                    var tempSheetUser = $($myuserpicker[r]).FormMultiUser({ IsQueryControl: true });
                    tempSheetUser.OnChange = function () {
                        that._refreshTable(0);
                    }
                }
            }

            this.$searchForm.find(".myuserpicker").removeClass("form-group");
            this.$searchForm.find(".mymultiselect").each(function () {
                $(this).multiselect({
                    enableFiltering: true,
                    filterPlaceholder: '搜索',
                    buttonText: function (options, select) {
                        if (options.length === 0) {
                            return "";
                        }
                        else {
                            var labels = [];
                            options.each(function () {
                                if ($(this).attr("label") !== void 0) {
                                    labels.push($(this).attr("label"));
                                }
                                else {
                                    labels.push($(this).html());
                                }
                            });
                            return labels.join(",") + "";
                        }
                    },
                    onChange: function () {
                        //that._refreshTable();
                    },
                    onDropdownShow: function () {
                        //点击时选人控件隐藏
                        $("div[data-FormMultiUserPanel='SelectorPanel'],div[data-FormUserPanel='SelectorPanel'],div[data-formmultiuserpanel='searchdiv']").hide();
                        $(".form-query-dropdown").hide();
                    },
                    selectedClass: "multiselect-selected"
                });
            });
            // 下拉搜索自动获取焦点
            $(".dropdown-toggle").on('click', function () {
                var that = this;
                setTimeout(function () {
                    $(that).next().find("input.multiselect-search").focus();
                }, 200);
            });
            // 统一初始化关联查询控件
            this.$searchForm.find(".mydropdown").each(function () {
                //筛选控件使用关联多选控件
                var myquery = $(this).FormMultiQuery({ IsQueryControl: true });
                myquery.IsQueryControl = true;
                myquery.OnChange = function () {
                    that._refreshTable(0);
                }
            });//.FormQuery();
            this.$searchForm.find(".mydropdown").removeClass("form-group");


            this.$searchForm.find("input[type='text']").blur(function () {
                //有下拉选项中在ValChange触发刷新数据
                if (!$(this).hasClass("comboboxtext")) {
                    that._refreshTable(0);
                }
            }).keydown(function (e) {
                if (e.which == 13) {
                    that._refreshTable(0);
                }
            });

            this.$searchForm.find("input[type='checkbox']").change(function () {
                that._refreshTable(0);
            });

            /***********************************关联查询默认查询 Begin***********************************/
            //格式化日期
            var formatDate = function (date) {
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                var day = date.getDate();
                return year + '-' + (month < 10 ? ('0' + month) : month) + '-' + (day < 10 ? ('0' + day) : day);
            };
            //当天
            var thisDay = function () {
                var date = new Date();
                date = formatDate(date);
                return date + ';' + date;
            };
            //本周
            var thisWeek = function () {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var day = date.getDate();
                var dayOfWeek = date.getDay();
                var start = new Date(year, month, day - dayOfWeek);
                start = formatDate(start);
                var end = new Date(year, month, day + (6 - dayOfWeek));
                end = formatDate(end);
                return start + ';' + end;
            };
            //本月
            var thisMonth = function () {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var start = new Date(year, month, 1);
                start = formatDate(start);
                var end = new Date(year, month + 1, 0);
                end = formatDate(end);
                return start + ';' + end;
            };
            //本季度
            var thisQuarter = function () {
                var startMonth = 0;
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                if (month < 3) {
                    startMonth = 0;
                } else if (month > 2 && month < 6) {
                    startMonth = 3;
                } else if (month > 5 && month < 9) {
                    startMonth = 6;
                } else if (month > 8) {
                    startMonth = 9;
                }
                var start = new Date(year, startMonth, 1);
                var end = new Date(year, startMonth + 3, 0);
                start = formatDate(start);
                end = formatDate(end);
                return start + ';' + end;
            };
            //本年度
            var thisYear = function () {
                var date = new Date();
                var year = date.getFullYear();
                var start = new Date(year, 0, 1);
                var end = new Date(year, 12, 0);
                start = formatDate(start);
                end = formatDate(end);
                return start + ';' + end;
            };
            //设置默认查询值
            //下面这段代码主要是用于关联查询中设置默认值的列表
            var searchParams = {
            };
            for (var i = 0; i < queryItems.length; i++) {
                var item = queryItems[i];
                if (item.DataType == 5) {
                    //datetime
                    var filterValue = parseInt(item.FilterValue);
                    switch (filterValue) {
                        case 1://当天
                            searchParams[item.PropertyName] = thisDay();
                            break;
                        case 2://本周
                            searchParams[item.PropertyName] = thisWeek();
                            break;
                        case 3://本月
                            searchParams[item.PropertyName] = thisMonth();
                            break;
                        case 4://本季度
                            searchParams[item.PropertyName] = thisQuarter();
                            break;
                        case 5://本年度
                            searchParams[item.PropertyName] = thisYear();
                            break;
                        default:
                            break;
                    }
                } else if (item.DataType == 26) {
                    var filterValue = parseInt(item.FilterValue);
                    var organizationType = parseInt(item.OrganizationType);
                    var defaultValue = queryDefaultValues[item.PropertyName];
                    switch (filterValue) {
                        case 1://本人
                            searchParams[item.PropertyName] = defaultValue + ";" + organizationType;
                            break;
                        case 2://本部门
                            searchParams[item.PropertyName] = defaultValue + ";" + organizationType;
                            break;
                        default:
                            break;
                    }
                }
                else {
                    //searchParams[queryItems[i].PropertyName] = queryItems[i].DefaultValue;
                    searchParams[queryItems[i].PropertyName] = queryDefaultValues[queryItems[i].PropertyName];
                }
            }
            var $divSearch = this.$searchForm;
            //单选、多选、下拉
            var myMultiSelect = $divSearch.find(".mymultiselect");
            for (var i = 0; i < myMultiSelect.length; i++) {
                var $property = $(myMultiSelect[i]);
                var propertyName = $property.attr("id");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    //$property.multiselect("select", propertyVal.split(";"));
                    $property.multiselect("select", propertyVal);
                }
            }
            // 文本
            var myText = $divSearch.find(".mytext");
            for (var i = 0; i < myText.length; i++) {
                var $property = $(myText[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    $property.val(propertyVal);
                }
            }
            // 选人
            var myUserPicker = $divSearch.find(".myuserpicker");
            for (var i = 0; i < myUserPicker.length; i++) {
                var $property = $(myUserPicker[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var arr = propertyVal.split(';');
                    var $ctrl = $property.FormMultiUser();//.SetValue(arr[0]);

                    $ctrl.SetValue(arr[0]);
                    if (parseInt(arr[1]) == 0) {
                        //人员可选
                        $($ctrl.Element).find('li[data-tabtype="tab_Deps"]').remove();
                    } else if (parseInt(arr[1]) == 1) {
                        //部门可选
                        $($ctrl.Element).find('li[data-tabtype="tab_Users"]').remove();
                    }
                }
            }
            // 数字
            var myNum = $divSearch.find(".mynum");
            for (var i = 0; i < myNum.length; i++) {
                var $property = $(myNum[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    //var defaultValue = propertyVal;
                    var valArr = propertyVal;//.split(";");
                    for (var j = 0; j < valArr.length; j++) {
                        if (!$.isNumeric(valArr[j])) {
                            continue;
                        }
                        $property.find("input:text").eq(j).val(valArr[j]);
                    }
                }
            }
            //是/否
            var myCheckBox = $divSearch.find('.mycheckbox');
            for (var i = 0; i < myCheckBox.length; i++) {
                var $property = $(myCheckBox[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal != undefined && propertyVal != null && propertyVal != "") {
                    if (propertyVal && propertyVal !== "false") {
                        $property.find("input[value='true']").prop("checked", "true");
                    }
                    else {
                        $property.find("input[value='false']").prop("checked", "true");
                    }
                }
            }
            //datetime
            var myDateTime = $divSearch.find(".mydatetime");
            for (var i = 0; i < myDateTime.length; i++) {
                var $property = $(myDateTime[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var days = propertyVal.split(';');
                    var picker = $property.find(".mydatetimepicker");
                    for (var j = 0; j < picker.length; j++) {
                        $(picker[j]).val(days[j]);
                    }
                }
            }
            // FormQuery
            var myDropDown = $divSearch.find(".mydropdown");
            for (var i = 0; i < myDropDown.length; i++) {
                var $property = $(myDropDown[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var formQuery = $property.FormMultiQuery({ IsQueryControl: true });
                    formQuery.SetValue(propertyVal);
                }
            }
            /***********************************关联查询默认查询 End***********************************/



            var $btnSearch = this.$toolbar.find(".btnSearch");
            $btnSearch.removeClass("hide");
            $btnSearch.click(function () {
                that._refreshTable();
                return false;
            });
            // 查询条件展开or收起
            var $btnToggle = this.$partingLine.find(".btnToggle");
            $btnToggle.removeClass("hide");
            $btnToggle.click(function () {
                if ($(this).hasClass("btn-up")) {
                    $(this).removeClass("btn-up").addClass("btn-down").removeClass("icon-arrow-up-double-b").addClass("icon-arrow-down-double-b");
                    //$(this).html("<i class='fa icon-arrow-down-double'></i>");
                    that.$searchForm.find("div.form-group:gt(1)").hide();
                }
                else {
                    $(this).removeClass("btn-down").addClass("btn-up").removeClass("icon-arrow-down-double-b").addClass("icon-arrow-up-double-b");

                    that.$searchForm.find("div.form-group").show();
                }
                return false;
            });

            // 查询条件多于2行时默认触发收起
            var seachRowCount = this.$searchForm.find("div.form-group").length;
            if (seachRowCount > 2) {
                $btnToggle.trigger("click");
            }
            else { // 查询条件少于3行时，隐藏收起按钮
                //$btnToggle.hide();
                this.$partingLine.hide();

                // 没有查询条件时，隐藏查询按钮
                if (seachRowCount === 0) {
                    $btnSearch.hide();
                }
            }

            this.SearchInitialized = true;
        },

        _initTable: function (queryColumns) {
            //
            var that = this;
            var columns = [];
            var childSchema = []; //子表
            if (queryColumns) {
                var tempColumnList = [];
                //for (var key in queryColumns) {
                //    if (queryColumns[key].ChildColumns) {
                //        childSchema.push(queryColumns[key]);
                //    } else {
                //        tempColumnList.push(queryColumns[key]);
                //    }
                //}

                for (var i = 0; i < queryColumns.length; i++) {
                    if (queryColumns[i].ChildColumns) {
                        //childSchema.push(queryColumns[i]);
                        var childColumns = queryColumns[i].ChildColumns;
                        for (var childKey in childColumns) {
                            if (childColumns[childKey].Code.indexOf(".") == -1) {
                                childColumns[childKey].Code = queryColumns[i].Code + "." + childColumns[childKey].Code;
                            }
                            tempColumnList.push(childColumns[childKey]);
                        }
                        //for (var j = 0; j < childColumns.length; j++) {
                        //    if (childColumns[j].Code.indexOf(".") == -1) {
                        //        childColumns[j].Code = queryColumns[i].Code + "." + childColumns[j].Code;
                        //    }
                        //    tempColumnList.push(childColumns[j]);
                        //}
                    } else {
                        tempColumnList.push(queryColumns[i]);
                    }
                }

                //添加完主表字段后再添加子表字段
                //if (childSchema.length > 0) {
                //    for (var i = 0; i < childSchema.length; i++) {
                //        var chidColumns = childSchema[i].ChildColumns;
                //        var key = childSchema[i].Code;
                //        for (var childKey in chidColumns) {
                //            if (chidColumns[childKey].Code.indexOf(".") == -1) {
                //                chidColumns[childKey].Code = key + "." + chidColumns[childKey].Code;
                //            }

                //            tempColumnList.push(chidColumns[childKey]);
                //        }
                //    }
                //}

                for (var i = 0, len = tempColumnList.length; i < len; i++) {
                    var queryColumn = tempColumnList[i];
                    columns.push({
                        field: queryColumn["Code"],
                        title: queryColumn["DisplayName"],
                        visible: queryColumn["Visible"],
                        formatter: function (value, row, index, field) {
                            if (value != null && value.constructor == Object) {
                                if (value.IsCustom != null) {
                                    value = value.Value;
                                }
                                else if (value.Color != null) {
                                    return "<span style='padding: 5px 15px 5px 15px;border-radius:4px; color:#fff;background-color:" + value.Color.toString() + ";'>" + value.Value + "</span>";
                                }
                            }
                            if (value != null && value.constructor == String && (value.indexOf("<") || value.indexOf(">"))) {
                                value = value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                            }
                            // if (field == OwnerDeptId_Name) {
                            //     return value;
                            // }
                            if (value == null || $.trim(value.toString()) == "") value = "--";
                            return value;
                        }
                    });
                }
            }
            if (/*this.DataField == undefined || this.DataField.indexOf('.') > 0*/typeof (this.DataField) != "undefined" && this.DataField.indexOf('.') > 0 || this.IsQueryControl) {
                //当前关联查询控件在子表中,在column中增加一个checkbox列
                var checkColumn = [];
                var checkColumn = {
                    field: 'checkcolumn',
                    title: '',
                    visible: true,
                    checkbox: true,
                    clickToSelect: true
                };
                var tempColumns = columns;
                columns = [];
                columns.push(checkColumn);
                columns = columns.concat(tempColumns);
            }
            that.TableAllColumns = columns;
            // 关联查询只显示审批通过的记录
            this.$table.bootstrapTable('destroy');
            var queryparams = {
                ActionName: "DoAction",
                Command: "Load",
                QueryCode: this.BOSchemaCode,
                ChildSchemaCode: childSchema.length == 0 ? "" : childSchema[0].Code,
                Status: 1,
                SheetQuery: 1,
                //isFormControl: true,
                ListScene: 2,//列表场景，1表示普通列表，2表示弹窗内列表
                SheetCode: this.SchemaCode,
                DataField: this.DataField,
                SheetData: JSON.stringify(this.SheetData),
                scopeType: 3,
                pageNum: that.pageNumber,
            }


            var bootstrapTableOptions = {
                method: "post",
                // 添加SheetQuery标识，让关联查询只以列表展现
                //这里传入scopeType为OwnAndOwnDept。如果不传入默认权限为own
                url: axios.defaults.baseURL + "/act/app/appRunPage",
                // clickToSelect:true,
                cache: false,
                striped: false,
                sidePagination: "server",
                pagination: true,
                pageSize: 10,
                contentType: "application/x-www-form-urlencoded",
                pageList: [10, 20, 50],
                columns: columns,
                idField: "ObjectId",
                sortName: "",
                sortOrder: "",
                TargetId: that.Table_ID,
                queryParams: function (params) {
                    var param = that._formatQueryParams(params, that);
                    param["QueryCode"] = that.BOSchemaCode;
                    param["SheetData"] = JSON.stringify(that.SheetData);
                    param["DataField"] = that.DataField;
                    param["SheetCode"] = that.SchemaCode;
                    param["isAssociateForm"] = 1
                    return param;

                },
                onLoadSuccess: function (data) {
                    that.LoadData = data;
                    that.$table.find("tbody > tr").css({
                        "cursor": "pointer"
                    });
                    that.$table.find("th")
                    that.TableInitialized = true;

                    //报表筛选不固定表头时需要给table指定高度，
                    if (that.FixedTableHeader == false) {
                        //高度调整到220,防止弹出框时确定按钮到屏幕之外
                        that.$table.closest('.fixed-table-body').css({ 'height': '180px', "overflow": "auto" });
                    }

                    var fixedTableHeader = that.$table.closest(".fixed-table-container").find(".fixed-table-header");
                    if (fixedTableHeader) {
                        //表头多一层主表，子表
                        if (fixedTableHeader.find("tr.tr-colspan").length > 0) {
                            that.$modal.find("div.table-page").css("margin-top", "88px");
                        }
                        fixedTableHeader.removeAttr("style");
                    }

                    //设置第一层th宽度
                    var $topTr = $("tr.tr-colspan");
                    if ($topTr.length > 0) {
                        var $titleTr = $topTr.next();
                        var $topTh = $topTr.find("th[data-field]");
                        $topTh.each(function () {
                            if ($(this).attr("rowspan") == undefined) {
                                return true;
                            } else {
                                var field = $(this).attr("data-field");
                                var $fieldTh = $titleTr.find("th[data-field='" + field + "']");
                                var fieldWidth = $fieldTh.find(".fht-cell").css("width");
                                $(this).find(".fht-cell").css("width", fieldWidth);
                            }
                        });
                    }

                    //设置选中行
                    that._setRowChecked();
                },
                onCheck: function (row, $element) {
                    that._checkRows(row);
                },
                onCheckAll: function (rows) {
                    that._checkRows(rows);
                },
                onUncheck: function (row, $element) {
                    that._unCheckRows(row);
                },
                onUncheckAll: function (rows) {
                    that._unCheckRows(rows);
                },
                onClickRow: function (row, $element) {
                    //点击行不执行操作的情况（显示勾选框情况）
                    //1.在表单中控件在子表
                    //2.列表、报表过滤
                    if ((that.DataField != void 0 && that.DataField.indexOf('.') > -1 && that.$Input.data('ObjectId') == undefined) ||
                        that.IsQueryControl ||
                        !that.$modal.find('.btnMultiSelect').hasClass('hide')) {
                        //如果关联查询控件在子表中则执行onCheck事件以批量选择，不执行ClickRow事件
                        return;
                    }
                    that.$modal.modal("hide");
                    $(".table-tip").hide();
                    //处理子表情况
                    var ObjectId = row["ObjectId"];
                    var name = row["Name"];
                    if (that.associateChildSchema == true) {
                        ObjectId = row[that.BOSchemaCode + '.ObjectId'];
                        name = row[that.BOSchemaCode + '.Name'];
                    } else if (that.associateChildSchema == undefined) {//兼容旧的
                        for (var key in row) {
                            if (key.toLowerCase().indexOf(".objectid") > -1) {
                                ObjectId = row[key];
                                if (key.toLowerCase().indexOf(".name") > -1) {
                                    name = row[key];
                                }
                            }
                        }
                    }


                    if (name == null || $.trim(name) == "") {
                        name = "--";
                    }
                    that.$Input.data("ObjectId", ObjectId).text(name);
                    that.OnChange.apply(that, [row]);
                    that._toDetailLink();
                    ////调整子表列宽
                    //if (!$.isEmptyObject(that.ObjectId)) {
                    //    var gridViewCtrl = $(that.Element).closest('div[data-controlkey="FormGridView"]');
                    //    if (gridViewCtrl.length > 0) {
                    //        gridViewCtrl = gridViewCtrl.FormGridView();
                    //        gridViewCtrl && gridViewCtrl.ResizeColumn(true);
                    //    }
                    //}
                },
                responseHandler: function (params) {
                    if (params.ReturnData === null) params.ReturnData = new Array();
                    that.RenderPage.call(this, params);
                    return {
                        rows: params.ReturnData, total: params.DataCount
                    };
                },
                onAll: function () {
                }
            };
            if (that.FixedTableHeader == undefined || that.FixedTableHeader == true) {
                bootstrapTableOptions.height = 180;
            }

            this.$table.bootstrapTable(bootstrapTableOptions);
            that._setColumnColspan(columns);

            this.$table.off("mouseenter.list").on("mouseenter.list", 'td', function () {
                var $tableTip = $(".table-tip"), $TextLabel = $(".TextLabel");
                $tableTip.length == 0 && ($tableTip = $('<div class="table-tip" style="display: none;"></div>').appendTo(that.CurrentBody)); //.appendTo($("body")));
                $TextLabel.length == 0 && ($TextLabel = $('<label class="TextLabel" style="display: none; opacity:0; position:fixed;"></label>').appendTo(that.CurrentBody));//.appendTo($("body")));
                var $that = $(this);
                $TextLabel.text($that.text());
                if ($TextLabel.width() > $that.width()) {
                    var offset = $that.offset();
                    $tableTip.text($that.text()).css({
                        left: offset.left + ($that.outerWidth() - $tableTip.outerWidth()) / 2 - $(window).scrollLeft(), bottom: $(window).height() - offset.top + 6 + $(window).scrollTop()
                    }).show();
                }
            });

            this.$table.off("mouseleave.list").on("mouseleave.list", 'td', function () {
                $(".table-tip").hide();
                return false;
            });
        },
        //设置行选中
        _setRowChecked: function () {
            //
            var that = this;
            if (that.IsQueryControl) {
                if (that.SelectedItems.length == 0) {
                    return;
                }
                //如果checkedrows中有selecteditems则不要添加
                var checkedRows = [];

                for (var i = 0; i < that.CheckedRows.length; i++) {
                    checkedRows.push(that.CheckedRows[i].ObjectId);
                }
                for (var i = 0; i < that.SelectedItems.length; i++) {
                    if ($.inArray(that.SelectedItems[i].ObjectId, checkedRows) == -1) {
                        that.CheckedRows.push(that.SelectedItems[i]);
                    }
                }


                //that.CheckedRows = that.CheckedRows.concat(that.SelectedItems);

                var data = that.$table.bootstrapTable('getData', true);
                if (that.associateChildSchema == undefined) {
                    that.associateChildSchema = false;
                    if (data && data.length > 0) {
                        for (var key in data[0]) {
                            if (key.indexOf('.ObjectId') > -1) {
                                that.associateChildSchema = true;
                                break;
                            }
                        }
                    }
                }
                var objectIdStr = 'ObjectId';
                if (that.associateChildSchema) {
                    objectIdStr = that.BOSchemaCode + '.ObjectId';
                }
                var childSchemaObjectId = undefined;
                for (var i = 0; i < data.length; i++) {
                    for (var j = 0; j < that.SelectedItems.length; j++) {
                        if (data[i][objectIdStr] == that.CheckedRows[j].ObjectId) {
                            that.$table.bootstrapTable('check', i);
                            break;
                        }
                    }
                }
            }

            //设置选中行
            if (that.CheckedRows.length == 0)
                return;
            var data = that.$table.bootstrapTable('getData', true);
            var childSchemaObjectId = undefined;
            if (data.length > 0) {
                if (that.associateChildSchema == true) {
                    childSchemaObjectId = that.BOSchemaCode + '.ObjectId';
                } else if (that.associateChildSchema == undefined) {
                    for (var key in data[0]) {
                        if (key.toLowerCase().indexOf(".objectid") > -1) {
                            childSchemaObjectId = key;
                            break;
                        }
                    }
                }
            }
            for (var i = 0; i < data.length; i++) {
                for (var j = 0; j < that.CheckedRows.length; j++) {
                    if (childSchemaObjectId != undefined) {
                        if (data[i][childSchemaObjectId] == that.CheckedRows[j][childSchemaObjectId]) {
                            that.$table.bootstrapTable('check', i);
                            break;
                        }
                    } else {
                        if (data[i].ObjectId == that.CheckedRows[j].ObjectId) {
                            that.$table.bootstrapTable('check', i);
                            break;
                        }
                    }
                }
            }
        },
        _refreshTable: function (pageNumber) {
            //重置pageNumber到第一页
            if (pageNumber != void 0 || !isNaN(pageNumber)) {
                this.$table.bootstrapTable("refreshOptions", { pageNumber: 1 });
            }
            this.$table.bootstrapTable("refresh");
        },

        // 添加查询条件
        _formatQueryParams: function (params) {
            var searchParams = {
            };
            var $divSearch = this.$searchForm;

            var myMultiSelect = $divSearch.find(".mymultiselect");
            for (var i = 0; i < myMultiSelect.length; i++) {
                var v = [];
                var $multiSelect = $(myMultiSelect[i]);
                var selectedText = $multiSelect.parent().find(".multiselect-selected-text").text();
                if (selectedText) {
                    v = selectedText.split(/,|，|;|；/); //支持中文逗号
                }
                if (v.length > 0) {
                    for (var j = 0; j < v.length; j++) {
                        v[j] = $.trim(v[j]);
                    }
                    searchParams[$multiSelect.attr("id")] = v;
                }
            }
            // 文本
            var myText = $divSearch.find(".mytext");
            for (var i = 0; i < myText.length; i++) {
                var $text = $(myText[i]);
                var v = $.trim($text.val());
                if (v !== "") {
                    if (v.indexOf(",") > -1 || v.indexOf("，") > -1) {
                        v = v.split(/,|，/);
                        if (v.length > 0) {
                            for (var j = 0; j < v.length; j++) {
                                v[j] = $.trim(v[j]);
                                if (v[j] == "--")//未填写，空白值项
                                {
                                    v[j] = "";
                                }
                            }
                            searchParams[$text.attr("data-propertyname")] = v;
                        }
                    }
                    else if (v.indexOf("；") > -1 || v.indexOf(";") > -1) {
                        v = v.split(/;|；/);
                        if (v.length > 0) {
                            for (var j = 0; j < v.length; j++) {
                                v[j] = $.trim(v[j]);
                                if (v[j] == "--")//未填写，空白值项
                                {
                                    v[j] = "";
                                }
                            }
                            searchParams[$text.attr("data-propertyname")] = v;
                        }

                    }
                    else {
                        if ($.trim(v) == "--") {
                            searchParams[$text.attr("data-propertyname")] = [""];
                        }
                        else {
                            searchParams[$text.attr("data-propertyname")] = [v];
                        }

                    }
                }
            }
            // 选人
            var myUserPicker = $divSearch.find(".myuserpicker");
            for (var i = 0; i < myUserPicker.length; i++) {
                var $picker = $(myUserPicker[i]);
                var v = $picker.FormMultiUser().GetUnitIDs();
                if (v && v.length > 0) {
                    searchParams[$picker.attr("data-propertyname")] = v;
                }
            }
            // 数字
            var myNum = $divSearch.find(".mynum");
            for (var i = 0; i < myNum.length; i++) {
                var $myNum = $(myNum[i]);
                var v = [];
                var num = $myNum.find(":text");
                for (var j = 0; j < num.length; j++) {
                    var $num = $(num[j]);
                    var val = $num.val();
                    if ($.isNumeric(val)) {
                        v.push(val);
                    } else {
                        v.push(null);
                    }
                }
                if (v.length > 0) {
                    searchParams[$myNum.attr("data-propertyname")] = v;
                }
            }
            //是/否
            var myCheckBox = $divSearch.find('.mycheckbox');
            for (var i = 0; i < myCheckBox.length; i++) {
                var $myCheckBox = $(myCheckBox[i]);
                var v = [];
                var checkedbox = $myCheckBox.find('input[type="checkbox"]:checked');
                for (var j = 0; j < checkedbox.length; j++) {
                    var val = $(checkedbox[j]).val();
                    v.push(val);
                }
                searchParams[$myCheckBox.attr('data-propertyname')] = v;
            }
            // datetime
            var myDateTime = $divSearch.find(".mydatetime");
            for (var i = 0; i < myDateTime.length; i++) {
                var $myDateTime = $(myDateTime[i]);
                var v = [];
                var myDateTimePicker = $myDateTime.find(".mydatetimepicker");
                for (var j = 0; j < myDateTimePicker.length; j++) {
                    var $myDateTimePicker = $(myDateTimePicker[j]);
                    var val = $myDateTimePicker.val();
                    if ($.trim(val) !== "") {
                        v.push(val);
                    } else {
                        v.push(null);
                    }
                }
                if (v.length > 0) {
                    searchParams[$myDateTime.attr("data-propertyname")] = v;
                }
            }

            // FormQuery
            var myDropDown = $divSearch.find(".mydropdown");
            for (var i = 0; i < myDropDown.length; i++) {
                var $mydropdown = $(myDropDown[i]);
                var v = $mydropdown.FormMultiQuery().GetValue();
                //多个关联表单中间用;隔开
                var arr = [];
                if (!$.isArray(v)) {
                    if (v && v.length > 0) {
                        v = v.split(';');
                        for (var j = 0; j < v.length; j++) {
                            if (v[j] == undefined || v[j] == 'undefined') {
                                arr.push('');
                            } else if (v[j] != '') {
                                arr.push(v[j]);
                            }
                        }
                        //searchParams[$mydropdown.attr("data-propertyname")] = arr;
                    }
                } else {
                    for (var j = 0; j < v.length; j++) {
                        if (v[j] == undefined || v[j] == 'undefined') {
                            arr.push('');
                        } else if (v[j] != '') {
                            arr.push(v[j]);
                        }
                    }
                }
                searchParams[$mydropdown.attr("data-propertyname")] = arr;
            }

            if (searchParams.Name && searchParams.Name.length > 0) {
                params["nameSchema"] = searchParams.Name[0];
            }
            if (searchParams["CreatedTime"][0]) {
                params["startTime"] = Number(new Date(searchParams["CreatedTime"][0]))
            }
            if (searchParams["CreatedTime"][1]) {
                params["endTime"] = Number(new Date(searchParams["CreatedTime"][1])) + 24 * 60 * 60 * 1000
            }

            return params;
        },

        _getQueryParams: function () {
            var queryParams = {
            };
            if (this.InputMappings) {
                for (var datafield in this.InputMappings) {
                    // 根据datafield，从页面上取值
                    var controlManager = this._getTargetElement(datafield).JControl();
                    if (controlManager) {
                        queryParams[this.InputMappings[datafield]] = controlManager.GetValue();
                    }
                }
            }
            return queryParams;
        },

        _getTargetElement: function (datafield) {
            var $targetElement;
            var dataFieldName = $.ControlManager.PreDataKey + $.ControlManager.DataFieldKey;
            // 子表字段，通过datafield在当前行中找
            if (datafield.indexOf(".") > -1) {
                $targetElement = this.$InputBody.closest("tr").find("[" + dataFieldName + "='" + datafield + "']")
            }
            else {
                $targetElement = $("[" + dataFieldName + "='" + datafield + "']");
            }
            return $targetElement;
        },

        _toDetailLink: function () {
            var that = this;
            var $link = "";
            var inputText = this.$Input.text();
            var decodedInputText;
            if ($.trim(inputText).length > 0) {
                decodedInputText = inputText;// decodeURIComponent(inputText);
                $link = $("<a href='javascript:;' title='" + decodedInputText + "' class='label label-info' style='position:relative;' >" + decodedInputText + "<i class='fa icon-close-middle' style='margin-left:5px;' data-objectId='" + this.$Input.data("ObjectId") + "'></i></a>");

                var $btnClear = $($link).find('i').on('click', function (e) {
                    that.$Input.text("").data("ObjectId", "");
                    //that.$Input.data("ObjectId", "");
                    //这里要清除下拉框的数据
                    var thisObjectId = $(this).attr('data-objectid');
                    that.$dropDownItemContainer && that.$dropDownItemContainer.find('input[type="checkbox"][data-itemid="' + thisObjectId + '"]').prop('checked', false);
                    that.OnChange.apply(that);
                    if (e.stopPropagation) {
                        e.stopPropagation();
                    } else {
                        e.cancelBubble = true;
                    }
                });
                that.isFirstSetValue = false;
            } else {
                //$link = $("<a href='javascript:;' title='" + this.$Input.text() + "' class='label label-info'>" + this.$Input.text() + "</a>");
            }

            this.$Input.text("").append($link);
            if (!that.Editable) {//不可编辑
                if ($link) {
                    $link.removeClass("label label-info").css({
                        "border": "none",
                        "white-space": "pre-wrap",
                        "white-space": "-moz-pre-wrap",
                        "white-space": "-pre-wrap",
                        "white-space": "-o-pre-wrap",
                        "word-wrap": "break-word",
                        "overflow": "auto",
                        "word-break": "break-all"
                    }).find("i").remove();
                    $link.off("click").on("click", function () {
                        var boId = that.GetValue();
                        if (boId) {
                            if (!that.BOSchemaCode) {
                                HTTP.getAppRunObjectSchemaDisplayName(boId).then((data) => {
                                    if (data.code == 0) {
                                        let instance = Modal.newInstance({
                                            //scrollable:true,
                                            okText: '关闭',
                                            title: inputText,
                                            footerHide: true,
                                            maskClosable: false,
                                            render: (h) => {
                                                return h(assoModal, {
                                                    props: {
                                                        code: boId
                                                    },
                                                    on: {

                                                    }
                                                })
                                            }
                                        })
                                        var options = { icon: "info", showCancel: false, width: "800px" };
                                        options.onRemove = function () {
                                            instance = null;
                                        };
                                        instance.show(options);

                                    }
                                })

                            }
                            else {
                                HTTP.getBizObjectSchemaDisplayName(that.BOSchemaCode).then((data) => {
                                    if (data.code == 0) {
                                        var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&BizObjectId=" + boId + "&Mode=View";
                                        // $.ISideModal.Show(url,data.data.DisplayName);
                                        let instance = Modal.newInstance({
                                            //scrollable:true,
                                            okText: '关闭',
                                            title: inputText,
                                            footerHide: true,
                                            maskClosable: false,
                                            render: (h) => {
                                                return h(assoModal, {
                                                    props: {
                                                        code: boId
                                                    },
                                                    on: {

                                                    }
                                                })
                                            }
                                        })
                                        var options = { icon: "info", showCancel: false, width: "800px" };
                                        options.onRemove = function () {
                                            instance = null;
                                        };
                                        instance.show(options);

                                    }
                                })

                            }
                        }
                    });
                }
            }
            else {
                //$link.off("click").on("click", function () {
                //    that.$modal.modal("show");
                //});
            }
        },

        RenderPage: function (data) {
            var that = this;
            var $target = $("#" + that["TargetId"]);
            if (!$target) return;
            if (that.pageNumber > 1 && data && data.Result.ReturnData.length == 0) {
                $target.bootstrapTable("refreshOptions", {
                    pageNumber: that.pageNumber - 1
                });
            }
            if (!that.$PageNext) {
                var $pageBar = $("#bar-" + that["TargetId"]);
                that.$PageNext = $pageBar.find(".Page_Num_Next");
                that.$PagePre = $pageBar.find(".Page_Num_Pre");
                that.$PageIndex = $pageBar.find(".Page_Index");
                that.$PageCount = $pageBar.find(".Page_Count");
                that.$PageTotal = $pageBar.find(".page-total");
                that.$PageSize = $pageBar.find(".Page_Per_Size");
                that.$PageNext.bind('click', function () {
                    $target.bootstrapTable("nextPage");
                });
                that.$PagePre.bind('click', function () {
                    $target.bootstrapTable("prevPage");
                });

                var PageTimeout;
                that.$PageIndex.bind("keyup", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val().replace(/[^\d]/g, '');
                    v = v == "" ? 0 : parseInt(v);
                    v = v >= that.Count ? that.Count : v;
                    if (v == 0) return;
                    $(this).val(v);
                    PageTimeout = setTimeout(function () {
                        v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                        PageTimeout = null;
                    }, 600);
                });
                that.$PageIndex.bind("blur", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val();
                    v = v == "" || v == "0" ? 1 : parseInt(v);
                    $(this).val(v);
                    v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                });
                $pageBar.on("click", "li>a", function () {
                    var size = parseInt($(this).text());
                    that.$PageSize.html(size);
                    $target.bootstrapTable("refreshOptions", {
                        pageSize: size
                    });

                })
            }
            if (!data) {
                that.$PageNext.addClass("disable").attr("disabled", true);
                that.$PagePre.addClass("disable").attr("disabled", true);
                that.$PageIndex.val(1).attr("disabled", true);
                that.$PageCount.html(1);
                that.$PageTotal.html("共0条");
            }
            else {
                that.$PageIndex.val(that.pageNumber);
                that.Count = Math.ceil(data.Result.Count / that.pageSize);
                that.$PageCount.html(that.Count);
                that.$PageTotal.html("共" + data.Result.Count + "条");
                if (that.pageNumber <= 1) {
                    that.$PagePre.addClass("disable").attr("disabled", true);
                }
                else {
                    that.$PagePre.removeClass("disable").attr("disabled", false);
                }

                if (that.pageNumber == that.Count) {
                    that.$PageNext.addClass("disable").attr("disabled", true);
                }
                else {
                    that.$PageNext.removeClass("disable").attr("disabled", false);
                }
            }
        },

        //设置值
        InitValue: function () {

            if ($.SmartForm.ResponseContext && !$.SmartForm.ResponseContext.IsCreateMode) {
                // if ($.SmartForm.ResponseContext) {
                var currentVal = this.Value;
                if ((this.Value == "" || this.Value == null || this.Value == undefined) && !this.ResponseContext.AssociatedBoNames) {
                    currentVal = this.BOSchemaCode;
                }
                if (!currentVal) return;

                if (currentVal.constructor == String) {
                    var name = "";
                    if ($.SmartForm.ResponseContext.AssociatedBoNames &&
                        $.SmartForm.ResponseContext.AssociatedBoNames[currentVal]) {
                        name = $.SmartForm.ResponseContext.AssociatedBoNames[currentVal].replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        name = name.trim("");
                        this.$Input.text(name == "" ? "--" : name);
                    }
                    this.$Input.text(name == "" ? "--" : name);
                    this.$Input.data("ObjectId", currentVal);
                } else {
                    var name = currentVal.Name || currentVal[this.BOSchemaCode + ".Name"];
                    var objectId = currentVal.ObjectId || currentVal[this.BOSchemaCode + ".ObjectId"];
                    name = name.trim("");
                    this.$Input.data("ObjectId", objectId).text(name == "" ? "--" : name);
                }
                this._toDetailLink();
                return;
            }

            var passedBoObjectId = $.IQuery(this.BOSchemaCode);
            var passedBoName = $.IQuery(this.BOSchemaCode + "_Name");
            var item = undefined;
            item = passedBoObjectId ? { ObjectId: passedBoObjectId, Name: passedBoName } : this.DefaultValue;

            if (item != void 0) {
                //2017/2/21这里setvalue取消了异步。原因是如果异步的话有可能会覆盖掉mapping的控件的值，仍然存在的缺陷是如果先渲染mapping的控件再渲染formaquery还是会覆盖掉mapping控件的值
                //this.SetValue(item, false);
                this.SetVal(item, false);
            }
            //Error关联列表新增不会携带值
            //item只有objectId和Name
        },

        //InitValue和SetValue调用的公共部分
        SetVal: function (item, asy) {
            var that = this;
            if (item == void 0 || item == null || item == "") {
                that.$Input.text("");
                that.$Input.data("ObjectId", "");
                //如果有关联配置则要清空
                if (that.MappingControls && !$.isEmptyObject(that.MappingControls)) {
                    that.ClearMappingValue();
                }
                that.OnChange({
                    ObjectId: "", Name: ""
                });
                return;
            }
            if (item.constructor == String) {
                //#Error:如果不是从后台加载的，需要支持开发者SetValue(objectId)
                var name = "";
                if ($.SmartForm.ResponseContext && $.SmartForm.ResponseContext.AssociatedBoNames &&
                    $.SmartForm.ResponseContext.AssociatedBoNames[item]) {
                    name = $.SmartForm.ResponseContext.AssociatedBoNames[item].replace(/</g, "&lt;").replace(/>/g, "&gt;");
                }
                var params = {
                    ActionName: "GetFormatBizObject",
                    SchemaCode: '123',
                    ObjectId: item
                };
                //ERROR这里有可能是空值
                if ($.trim(name) == '') {
                    HTTP.listViewData(params).then((data) => {
                        if (data.code == 0) {
                            var returnData = data.ReturnData.ListViewData;
                            if (returnData != void 0 && returnData.length > 0) {
                                name = $.trim(returnData[0].Name || returnData[0][that.BOSchemaCode + ".Name"]);
                            }
                            if ($.trim(name) == '') {
                                name = '--';
                            }
                            that.$Input.text(name);
                            that.$Input.data("ObjectId", item);
                            that.OnChange({
                                ObjectId: item, Name: name
                            });
                            that._toDetailLink();
                        }
                    })
                } else {
                    that.$Input.text(name);
                    that.$Input.data("ObjectId", item);
                    that.OnChange({
                        ObjectId: item, Name: name
                    });
                    that._toDetailLink();
                }
            } else {
                var name = item.Name;
                var objectId = item.ObjectId;
                if (objectId == undefined && item[that.BOSchemaCode + ".ObjectId"] != undefined) {
                    name = item[that.BOSchemaCode + ".Name"];
                    objectId = item[that.BOSchemaCode + ".ObjectId"];
                }
                if (name == void 0 || name == "null" || name == "undefined") {
                    var params = {
                        ActionName: "GetFormatBizObject",
                        SchemaCode: '1234',
                        ObjectId: item
                    };
                    HTTP.listViewData(params).then((data) => {
                        if (data.code == 0 && data.ReturnData.ListViewData.length > 0) {
                            var itemData = null;
                            if (data.ReturnData.ListViewData != void 0 && data.ReturnData.ListViewData.length > 0) {
                                name = $.trim(data.ReturnData.ListViewData[0].Name);
                                itemData = data.ReturnData.ListViewData[0];
                                itemData['isQuery'] = true;
                            }
                            if ($.trim(name) == '') {
                                name = '--';
                            }
                            that.$Input.text(name);
                            that.$Input.data("ObjectId", item.ObjectId);
                            //that.OnChange({ ObjectId: item.ObjectId, Name: name });
                            if (itemData != null) {
                                that.OnChange(itemData);
                            } else {
                                that.OnChange({
                                    ObjectId: item.ObjectId, Name: name
                                });
                            }
                            that._toDetailLink();
                        }
                    })
                } else {
                    that.$Input.data("ObjectId", objectId).text(name);
                    if (that.BOSchemaCode && $.IQuery(this.BOSchemaCode + "_Name"))
                        that.OnChange();
                    else
                        that.OnChange(item);
                    that._toDetailLink();
                }
            }
        },
        //设置值
        SetValue: function (item, asy) {
            var oldValue = this.GetValue();
            if (item == this.GetValue() || (item && item.ObjectId == this.GetValue())) return;
            this.SetVal(item, asy);
            this.IsFirstSetValue = false;
        },

        //校验
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            // 修改判空条件，val是字符串，不是对象 by lizijie
            // if (this.Required && $.isEmptyObject(val)) {
            if (this.Required && val == '') {
                if (this.SchemaCode != this.BOSchemaCode) {
                    this.AddInvalidText(this.$InputBody, "必填");
                    return false;
                } else {
                    //如果关联的是自己,且关联的数据是空的，则不要校验必填
                    if (this.LoadData != undefined && this.LoadData.length > 0) {
                        this.AddInvalidText(this.$InputBody, "必填");
                        return false;
                    }
                    //如果初始没有数据（this.LoadData.length==0）,在关联表单界面新增了也要校验
                    if (this.$Input.find('a').length == 0) {
                        this.AddInvalidText(this.$InputBody, "必填");
                        return false;
                    }
                }
            }
            this.RemoveInvalidText(this.$InputBody);
            return true;
        },

        SaveDataField: function () {
            var result = {
            };
            if (!this.ResponseContext.IsCreateMode && (!this.Visible)) return result;
            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldresult) {
                return {
                };
            }
            if (oldresult.Value != this.GetValue()) {
                result[this.DataField] = this.GetValue();
                return result;
            }
            return {
            };
        },

        GetValue: function () {
            if (!this.Visible) {
                if (this.Value == null) {
                    return "";
                }
                return this.Value;
            }
            if (!$(this.Element).is(":visible") && $.IQuery(this.BOSchemaCode)) {
                return $.IQuery(this.BOSchemaCode);
            }
            var value = undefined;
            if (this.$Input) {
                value = this.$Input.data("ObjectId");
            }

            return value == undefined ? "" : value;
        },

        GetText: function () {
            if (this.$Input) {
                return this.$Input.text();
            } else {
                return ""
            };
        },

        SetReadonly: function (flag) {
            if (flag) {
                this.$Input && this.$Input.prop("disabled", "disabled").off("click");
                this.$addModel && this.$addModel.off("click");
            }
            else {
                this.$Input.removeProp("disabled");
            }
        },

        Change: function (rowData) {
            //如果当前控件是"关联属性"则不要设置关联携带
            if ($(this.Element).attr("data-ismappingproperty") != undefined) {
                return;
            }
            if ((this.MappingControls && !$.isEmptyObject(this.MappingControls)) || (this.MappingProperties && !$.isEmptyObject(this.MappingProperties))) {
                //关于关联配置数据携带，关联查询“新增”的时候不能将新增的数据携带出来。原因是返回的rowData中没有新增的数据。
                //修改后每次都要请求数据
                /*if (rowData && rowData.length > 0) {
                    if ($.isArray(rowData) || rowData.length > 0) {
                        rowData = rowData[0];
                    }
                    this.SetMappingValue(rowData);
                }
                else {*/
                var that = this;
                if (rowData[0] != void 0 && rowData[0].isQuery != void 0) {
                    that.SetMappingValue(rowData[0]);
                } else {
                    var ObjectId = this.GetValue();
                    if (ObjectId) {
                        var params = {
                            SchemaCode: this.BOSchemaCode,
                            ObjectId: ObjectId
                        }
                        // this.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                        //     if (data.ReturnData.ListViewData && data.ReturnData.ListViewData.length > 0) {
                        //         that.SetMappingValue(data.ReturnData.ListViewData[0]);
                        //     }
                        // });
                        HTTP.getFormatBizObject(params).then((data) => {
                            if (data.datas && data.datas.length > 0) {
                                that.SetMappingValue(data.datas[0]);
                            }
                        })

                    } else {
                        //清空关联配置值
                        this.ClearMappingValue();
                    }
                }
                /* }*/
            }
            this.Required && this.Editable && (this.$Input.text() != "" && this.$Input.css({
                "border": "1px solid #ddd", "box-shadow": "none"
            }));
            ////如果控件在子表中，子表列宽要重新计算
            //if ($.fn.FormGridView) {
            //    var gridViewCtrl = $(this.Element).closest('div[data-controlkey="FormGridView"]');
            //    if (gridViewCtrl.length > 0) {
            //        gridViewCtrl = gridViewCtrl.FormGridView();
            //        gridViewCtrl && gridViewCtrl.ResizeColumn(true);
            //    }
            //}
        },
        //清除关联配置携带数据
        ClearMappingValue: function () {
            if ($(this.Element).attr("data-ismappingproperty") != undefined) {
                return;
            }
            var mappings = {};
            $.extend(mappings, this.MappingControls);
            $.extend(mappings, this.MappingProperties);

            //如果是主表关联主表，并且携带子表到子表，则清空整个子表
            var childSchemas = [];
            var leftMappings = {};//要排除的字段
            for (var property in mappings) {
                if (property.indexOf(".") > -1 && mappings[property].indexOf(".") > -1) {
                    var childSchema = property.split(".")[0];
                    ($.inArray(childSchema, childSchemas) == -1) && childSchemas.push(childSchema);
                } else {
                    //$.extend(leftMappings, { property: mappings[property] });
                    leftMappings[property] = mappings[property];
                }
            }
            //清空childSchemas中子表行
            if (this.DataField.indexOf(".") == -1 && this.BOSchemaCode.indexOf(".") == -1) {
                for (var i = 0; i < childSchemas.length; i++) {
                    var gridView = $("div.SheetGridView[data-datafield='" + childSchemas[i] + "']");
                    if (gridView && gridView.length > 0) {
                        var gridViewCtrl = gridView.JControl();
                        gridViewCtrl && gridViewCtrl.ClearRows();
                    }
                }
                //排除掉主表关联主表携带子表的关联配置
                mappings = leftMappings;
            }
            //清除剩下mapping控件值
            for (var targetProperty in mappings) {
                var $ctrl = null;
                if (this.ObjectId != undefined) {
                    $ctrl = $("tr[data-objectid='" + this.ObjectId + "']").find("[data-datafield='" + targetProperty + "']:not('.table_th')");
                } else {
                    $ctrl = $("[data-datafield='" + targetProperty + "']:not('.table_th')");
                }
                if ($ctrl) {
                    for (var i = 0; i < $ctrl.length; i++) {
                        var control = $($ctrl[i]).JControl();
                        control && control.ClearValue();
                    }
                }
                //$ctrl && $ctrl.JControl().ClearValue();
            }
        },
        SetMappingValue: function (rowData, mapping) {
            //1.主表关联主表
            //1.1主->主(A:B)
            //1.2主->子(A.x:B)
            //1.3子->子(A.x:B.x)
            //2.主表关联子表
            //2.1子->子(A.x:B.x)
            //2.2子->主(A:B.x)
            //3.子表关联主表
            //3.1主->主(A:A)
            //3.2主->子(A.x:B)
            //4.子表关联子表
            //4.1子->子(A.x:B.y)
            //4.2子->主(A:B.x)
            var that = this;
            if ((!that.MappingControls && !that.MappingProperties) || ($.isEmptyObject(that.MappingControls) && $.isEmptyObject(that.MappingProperties))) {
                return;
            }
            var hasError = false;
            //判断当前字段是在子表还是主表
            var thisCtrlInChild = that.DataField.indexOf(".") > -1;
            //判断关联的是子表还是主表(后来配置的时候会保存是关联主表还是子表，老的配置中没有保存，那种情况需要请求后台判断)
            var boSchemaInfo = $(that.Element).attr("data-boSchemaInfo");
            var isAssociateChild = boSchemaInfo ? JSON.parse(boSchemaInfo).IsChildSchema : undefined;
            if (isAssociateChild == undefined) {
                //同步请求后台判断关联的是子表还是主表
                var params = {
                    ActionName: "CheckChildSchema",
                    SchemaCode: that.BOSchemaCode
                }
                that.Ajax("/Form/OnAction", "POST", { PostData: JSON.stringify(params) }, function (data) {
                    if (data.Successful) {
                        isAssociateChild = data.ReturnData.IsChildSchema;
                    } else {
                        hasError = true;
                    }
                }, false);
            }
            if (hasError) {
                //$.IShowError("", "关联表单错误!");
                Message.error({
                    content: "关联表单错误!",
                    duration: 3
                });
                return;
            }
            //判断关联关系，是主表关联主表还/主表关联子表/子表关联主表/子表关联子表中哪一种
            var associationType = undefined;
            if (!thisCtrlInChild) {
                //关联表单控件在主表
                if (!isAssociateChild) {
                    //主关联主
                    associationType = 1;
                } else {
                    //主关联子
                    associationType = 2;
                }
            } else {
                if (!isAssociateChild) {
                    //子关联主
                    associationType = 3;
                } else {
                    //子关联子
                    associationType = 4;
                }
            }
            //根据不同的关联关系,处理关联配置
            switch (associationType) {
                case 1:
                    that._mainSchemaAssociateMainSchema(rowData, mapping);
                    break;
                case 2:
                    that._mainSchemaAssociateChildSchema(rowData, mapping);
                    break;
                case 3:
                    that._childSchemaAssociateMainSchema(rowData, mapping);
                    break;
                case 4:
                    that._childSchemaAssociateChildSchema(rowData, mapping);
                    break;
                default:
                    hasError = true;
                    break;
            }
            if (hasError) {
                //$.IShowError("", "获取的关联信息错误");
                Message.error({
                    content: "获取的关联信息错误",
                    duration: 3
                });
                return;
            }
        },
        _setDestControlValue: function (destControl, sourceField, rowData) {
            var that = this;
            if (destControl == undefined) return;
            switch (destControl.Type) {
                case 52:
                    //判断destControl是否关联属性控件
                    var sourceType = $(destControl.Element).attr("data-sourcetype");
                    var uniTtype = $(destControl.Element).attr("data-unittype");
                    if (sourceType != undefined) {
                        destControl.BOSchemaCode = rowData[sourceField + "_SchemaCode"];
                    }
                    if (rowData[sourceField] == void 0) {
                        destControl.ClearValue();
                    } else {
                        if (sourceType == 26 || sourceType == 27) {
                            if (uniTtype == 2) {
                                destControl.SetValue(rowData[sourceField], false)
                            }
                            else if (uniTtype == 4) {
                                destControl.SetValue(rowData[sourceField], true)
                            }
                        }
                        else {
                            destControl.SetValue(rowData[sourceField]);
                        }

                    }
                    break;
                case 50:
                    {
                        var destSchemaCode = rowData[sourceField + "_SchemaCode"];
                        //if (destSchemaCode == undefined) {
                        //    //携带过来的数据不对，清空当前数据
                        //    destControl.ClearValue();
                        //}
                        var sourceType = $(destControl.Element).attr("data-sourcetype");
                        if (sourceType != undefined) {
                            destControl.BOSchemaCode = destSchemaCode;
                        }
                        if (destSchemaCode != undefined && destSchemaCode != destControl.BOSchemaCode) {
                            //关联配置与返回的数据不一致，清空数据
                            destControl.ClearValue();
                            return;
                        }
                        //if (destControl.BOSchemaCode == destSchemaCode) {
                        if (destControl.MappingControls && !$.isEmptyObject(destControl.MappingControls)) {
                            if (rowData[sourceField] == void 0) {
                                destControl.ClearValue();
                                destControl.ClearMappingValue();
                                return;
                            }
                            //有关联配置
                            var params = {
                                ActionName: "GetFormatBizObject",
                                SchemaCode: destControl.BOSchemaCode,
                                ObjectId: rowData[sourceField]
                            };
                            (function (destControl, p) {

                                HTTP.getFormatBizObject(params).then((data) => {
                                    if (data.code == 0) {
                                        var returnData = data.datas;
                                        if (returnData && returnData.length > 0) {
                                            destControl.SetValue(returnData[0]);
                                        }
                                    }
                                })

                                // that.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(p) }, function (data) {
                                //     if (data.Successful) {
                                //         var returnData = data.ReturnData.ListViewData;
                                //         if (returnData && returnData.length > 0) {
                                //             destControl.SetValue(returnData[0]);
                                //         }
                                //     }
                                // });
                            })(destControl, params);
                        } else {
                            //无关联配置
                            var objectId = rowData[sourceField];
                            var name = rowData[sourceField + "_Name"];
                            if (sourceField.indexOf(".") > -1) {
                                if (sourceField.toLowerCase().indexOf(".objectid") > -1) {
                                    //将ObjectId携带到关联表单
                                    name = rowData[sourceField.split(".")[0] + ".Name"];
                                } else {
                                    name = rowData[sourceField + "_Name"];
                                }
                            }
                            if (objectId != void 0)
                                destControl.SetValue({ ObjectId: objectId, Name: name });
                            else
                                destControl.ClearValue();
                        }
                        //}
                    }
                    break;
                case 24://附件
                    {
                        var objectId = "ObjectId";
                        if (sourceField.indexOf(".") > -1) {
                            objectId = sourceField.split(".")[0] + ".ObjectId";
                        }
                        var params = {
                            ActionName: "GetMappingFiles",
                            SchemaCode: that.BOSchemaCode,
                            BizObjectId: rowData[objectId],
                            PropertyName: sourceField,
                            Random: Math.round(Math.random() * 10000) //IE11里面不会重复请求，加这个参数是为了兼容IE11，参数内容无任何意义
                        };
                        (function (destControl) {
                            that.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                                // 清空控件上的附件
                                destControl.ClearFiles();
                                var returnData = data.ReturnData.HandlerResult;
                                if (returnData && returnData.length > 0) {
                                    for (var i = 0, len = returnData.length; i < len; i++) {
                                        var result = returnData[i];
                                        var url = '/Form/Download?AttachmentID=' + result.AttachmentId;
                                        destControl.AppendFile(result.FileId, result.AttachmentId, result.FileName, result.Size, result.Thumb, result.Description, url);
                                    }
                                }
                            });
                        })(destControl);
                    }
                    break;
                default:
                    var val = rowData[sourceField];
                    if (destControl.Type == 1) {
                        val = val == "true" ? true : false;
                    }
                    //多选人控件时，先清空再赋值
                    if (destControl.Type == 27) {
                        destControl.ClearValue();
                    }
                    if ((destControl.Type == 26 || destControl.Type == 27)) {
                        if (destControl.IsUser == true) {
                            destControl.SetValue(val, true);
                        }
                        else {
                            destControl.SetValue(val, false);
                        }
                    }
                    else {
                        destControl.SetValue(val);
                    }

                    destControl.OnChange();
                    break;
            }
        },
        //主表关联主表
        //主->主/主->子/子->子
        _mainSchemaAssociateMainSchema: function (rowData, mapping) {
            var that = this;
            //要把关联配置分成两类。一类是主->主(子),另一类是子->子
            var mainSchemaMapping = {};//主->主(子)
            var childSchemaMapping = {};//子->子
            var mappings = {};
            if (mapping == undefined) {
                $.extend(mappings, that.MappingControls);//关联配置
                $.extend(mappings, that.MappingProperties);//关联属性
            } else {
                $.extend(mappings, mapping);
            }
            for (var destField in mappings) {
                var sourceField = mappings[destField];
                if (destField.indexOf(".") > -1 && sourceField.indexOf(".") > -1) {
                    //子->子
                    childSchemaMapping[destField] = sourceField;
                } else {
                    mainSchemaMapping[destField] = sourceField;
                }
            }
            //关联表单经办节点无法找到current-container的样式类  add by rmd 2018 10 28
            var $container = $(that.Element).closest(".sheet_container");
            for (var destField in mainSchemaMapping) {
                var sourceField = mainSchemaMapping[destField];
                if (typeof (sourceField) != "string") {
                    continue;
                }
                if (sourceField.indexOf(".") == -1) {
                    if (destField.indexOf(".") == -1) {
                        //主->主
                        //判断目标字段类型
                        var destControl = $container.find("div[data-datafield='" + destField + "']").JControl();
                        that._setDestControlValue(destControl, sourceField, rowData);
                    } else {
                        //主->子
                        var childSchemaField = destField.split('.')[0];
                        var dests = $container.find("div[data-datafield='" + destField + "']:not('.table_th')");
                        for (var i = 0; i < dests.length; i++) {
                            var destControl = $(dests[i]).JControl();
                            that._setDestControlValue(destControl, sourceField, rowData);
                        }
                    }
                } else {
                    //主表关联主表情况不支持将子表值携带到主表
                    //此场景不支持
                }
            }
            //2.子->子
            if (!$.isEmptyObject(childSchemaMapping)) {
                //获取关联配置中源子表和目标子表
                var childSchemas = {};//{destChildSchema:sourceChildSchema}
                for (var destField in childSchemaMapping) {
                    var existInChildSchemas = false;
                    var destChildSchema = destField.split(".")[0];
                    var sourceChildSchema = childSchemaMapping[destField].split(".")[0];
                    for (var key in childSchemas) {
                        if (key == destChildSchema) {
                            existInChildSchemas = true;
                            break;
                        }
                    }
                    if (!existInChildSchemas) {
                        childSchemas[destChildSchema] = sourceChildSchema;
                    }
                }
            }
            //将源子表的数据添加到目标子表
            for (var destChildSchema in childSchemas) {
                var sourceChildSchema = childSchemas[destChildSchema];
                var params = {
                    ActionName: "GetChildSchemaDataByObjectId",
                    TargetChild: destChildSchema,
                    SchemaCode: that.BOSchemaCode,
                    BizObjectId: rowData["ObjectId"],
                    PropertyName: sourceChildSchema
                };



                var listViewData = rowData[sourceChildSchema];
                if (listViewData && listViewData.length > 0) {
                    var len = $(that.Element).closest(".sheet_container").find("div[data-datafield='" + destChildSchema + "']").length
                    var gridView = $(that.Element).closest(".sheet_container").find("div[data-datafield='" + destChildSchema + "']").FormGridView();
                    if (gridView) {
                        gridView.ClearRows();
                        //var listViewData = returnData.ListViewData;
                        for (var i = 0; i < listViewData.length; i++) {
                            var newRowData = {};
                            newRowData["ObjectId"] = $.IGuid();
                            var propertySchemaCode = {};

                            for (var destField in childSchemaMapping) {
                                var sourceField = childSchemaMapping[destField];
                                var row = sourceField.split('.')[1]
                                var sourceValue = listViewData[i][row];
                                if (sourceValue == void 0) {
                                    continue;
                                } else {
                                    newRowData[destField] = sourceValue;
                                }
                                //获取关联属性的BOSchemaCode
                                if (that.MappingProperties != undefined) {
                                    //有关联配置
                                    var isMappingProperty = false;
                                    for (var key in that.MappingProperties) {
                                        if (key == destField) {
                                            isMappingProperty = true;
                                            break;
                                        }
                                    }
                                    if (isMappingProperty) {
                                        propertySchemaCode[destField] = listViewData[i][sourceField + "_SchemaCode"];
                                    }
                                }
                            }
                            gridView.AddRow($.IGuid(), newRowData, null, null, propertySchemaCode);
                        }
                    }

                }


                // that.Ajax("/Form/OnAction", "POST", { PostData: JSON.stringify(params) }, function (data) {
                //     if (data.Successful) {
                //         var returnData = data.ReturnData;
                //         if (returnData.ListViewData && returnData.ListViewData.length > 0) {
                //             var gridView = $(that.Element).closest("#SheetContent").find("div[data-datafield='" + returnData.TargetChild + "']").FormGridView();
                //             if (gridView) {
                //                 gridView.ClearRows();
                //                 var listViewData = returnData.ListViewData;
                //                 for (var i = 0; i < listViewData.length; i++) {
                //                     var newRowData = {};
                //                     newRowData["ObjectId"] = $.IGuid();
                //                     var propertySchemaCode = {};

                //                     for (var destField in childSchemaMapping) {
                //                         var sourceField = childSchemaMapping[destField];
                //                         var sourceValue = listViewData[i][sourceField];
                //                         if (sourceValue == void 0) {
                //                             continue;
                //                         } else {
                //                             newRowData[destField] = sourceValue;
                //                         }
                //                         //获取关联属性的BOSchemaCode
                //                         if (that.MappingProperties != undefined) {
                //                             //有关联配置
                //                             var isMappingProperty = false;
                //                             for (var key in that.MappingProperties) {
                //                                 if (key == destField) {
                //                                     isMappingProperty = true;
                //                                     break;
                //                                 }
                //                             }
                //                             if (isMappingProperty) {
                //                                 propertySchemaCode[destField] = listViewData[i][sourceField + "_SchemaCode"];
                //                             }
                //                         }
                //                     }
                //                     gridView.AddRow($.IGuid(), newRowData, null, null, propertySchemaCode);
                //                 }
                //             }
                //         }
                //     }
                // });
            }
        },
        //主表关联子表
        //子->主/子->子
        _mainSchemaAssociateChildSchema: function (rowData, mapping) {
            var that = this;
            var $container = $(that.Element).closest("#SheetContent");
            //var mappingsControls = that.MappingControls;
            var mappings = {};
            if (mapping == undefined) {
                $.extend(mappings, that.MappingControls);//关联配置
                $.extend(mappings, that.MappingProperties);//关联属性
            } else {
                $.extend(mappings, mapping);
            }
            for (var destField in mappings) {
                var sourceField = mappings[destField];
                if (destField.indexOf(".") == -1) {
                    //子->主
                    var destControl = $container.find("div[data-datafield='" + destField + "']").JControl();
                    that._setDestControlValue(destControl, sourceField, rowData);
                } else {
                    //子->子
                    var dests = $container.find("div[data-datafield='" + destField + "']:not('.table_th')");
                    for (var i = 0; i < dests.length; i++) {
                        var destControl = $(dests[i]).JControl();
                        that._setDestControlValue(destControl, sourceField, rowData);
                    }
                }
            }
        },
        //子表关联主表
        //主->主/主->子
        _childSchemaAssociateMainSchema: function (rowData, mapping) {
            var that = this;
            var $container = $(that.Element).closest("#SheetContent");
            //var mappingControls = that.MappingControls;
            var mappings = {};
            if (mapping == undefined) {
                $.extend(mappings, that.MappingControls);//关联配置
                $.extend(mappings, that.MappingProperties);//关联属性
            } else {
                $.extend(mappings, mapping);
            }
            for (var destField in mappings) {
                var sourceField = mappings[destField];
                if (destField.indexOf(".") == -1) {
                    //主->主
                    var destControl = $container.find("div[data-datafield='" + destField + "']").JControl();
                    that._setDestControlValue(destControl, sourceField, rowData);
                } else {
                    //主->子
                    //取当前控件所在行的目标控件
                    var $currentTr = $(that.Element).closest("tr");
                    var destControl = $currentTr.find("div[data-datafield='" + destField + "']").JControl();
                    that._setDestControlValue(destControl, sourceField, rowData);
                }
            }
        },
        //子表关联子表
        //子->主/子->子
        _childSchemaAssociateChildSchema: function (rowData, mapping) {
            var that = this;
            var $container = $(that.Element).closest("#SheetContent");
            //var mappingControls = that.MappingControls;
            var mappings = {};
            if (mapping == undefined) {
                $.extend(mappings, that.MappingControls);//关联配置
                $.extend(mappings, that.MappingProperties);//关联属性
            } else {
                $.extend(mappings, mapping);
            }
            for (var destField in mappings) {
                var sourceField = mappings[destField];
                if (destField.indexOf(".") == -1) {
                    //子->主
                    var destControl = $container.find("div[data-datafield='" + destField + "']").JControl();
                    that._setDestControlValue(destControl, sourceField, rowData);
                } else {
                    //子->子
                    //取当前控件所在行的目标控件
                    var $currentTr = $(that.Element).closest("tr");
                    var destControl = $currentTr.find("div[data-datafield='" + destField + "']").JControl();
                    that._setDestControlValue(destControl, sourceField, rowData);
                }
            }
        },

        SetMappingValueOld: function (rowData) {
            var trId = this.$InputBody.closest("tr").attr("data-ObjectId");
            //如果关联查询控件在主表且关联配置是将关联表单子表字段带到当前表单子表字段
            //则要执行如下操作
            //清除当前子表的行，将关联表单子表的行添加到当前表单的子表
            var flag = false;
            if (this.DataField.indexOf(".") == -1) {
                //关联查询控件在主表
                for (var targetProperty in this.MappingControls) {
                    if (targetProperty.indexOf(".") > -1 && this.MappingControls[targetProperty].indexOf(".") > -1) {
                        flag = true;
                        break;
                    }
                }
            }
            //将主表和子表的mappingcontrol分开
            var mappingCtrl_schema = {
            };//主表关联配置
            var mappingCtrl_childSchema = {
            };//子表关联配置
            var targetChildSchema = {
            };//关联配置中涉及的子表

            for (var targetProperty in this.MappingControls) {
                if (!(targetProperty.indexOf('.') > -1 && this.MappingControls[targetProperty].indexOf('.') > -1)) {
                    mappingCtrl_schema[targetProperty] = this.MappingControls[targetProperty];
                } else {
                    mappingCtrl_childSchema[targetProperty] = this.MappingControls[targetProperty];
                    var targetChild = targetProperty.slice(0, targetProperty.indexOf('.'));
                    var sourceChild = this.MappingControls[targetProperty].slice(0, this.MappingControls[targetProperty].indexOf('.'));
                    var existInTargetChildSchema = false;
                    for (var target in targetChildSchema) {
                        if (target == targetChild) {
                            existInTargetChildSchema = true;
                            break;
                        }
                    }
                    if (!existInTargetChildSchema) {
                        targetChildSchema[targetChild] = sourceChild;
                    }
                }
            }
            var MappingCtrls = {
            };
            if (flag) {
                MappingCtrls = mappingCtrl_schema;
            } else {
                MappingCtrls = this.MappingControls;
            }
            for (var targetProperty in MappingCtrls) {
                var sourceProperty = MappingCtrls[targetProperty];
                var propertyName = sourceProperty;
                var potIndex = sourceProperty.indexOf('.');
                if (potIndex > 0) {
                    //propertyName = sourceProperty.slice(potIndex + 1);
                    //sourceProperty = propertyName;
                }
                var propertyValue = rowData[propertyName] /*|| rowData[sourceProperty]*/;
                var controlManager = null;
                if (targetProperty.indexOf(".") > -1) {
                    // 子表中找同行
                    var $controls = $("[data-datafield='" + targetProperty + "']:not(.table_th)");
                    for (var ci = 0, clen = $controls.length; ci < clen; ci++) {
                        var $control = $($controls[ci]);
                        if (($control.closest("tr").attr("data-ObjectId") == trId && trId != void 0) || (trId == void 0 && $control.closest("tr").attr("data-ObjectId") != void 0)) {
                            controlManager = $control.JControl();
                            break;
                        }
                    }
                } else {
                    //这里会找到两个dom;需要在表单内查找，不是在body内查找
                    var tempdoms = $("[data-datafield='" + targetProperty + "']");
                    if (tempdoms.length > 1) {
                        var tempSheetContent = $(this.Element).closest("#SheetContent");
                        controlManager = tempSheetContent.find("[data-datafield='" + targetProperty + "']").JControl();
                    } else {
                        controlManager = tempdoms.JControl();
                    }
                }
                if (controlManager) {
                    if (controlManager.Type == 50) { // 关联查询
                        var that = this;
                        var rowSchemaCode = rowData[sourceProperty + "_SchemaCode"];
                        if (rowSchemaCode == undefined) {
                            rowSchemaCode = controlManager.BOSchemaCode;
                        }
                        var propertyName = "Name";
                        if (sourceProperty.indexOf(".") > -1) {
                            propertyName = sourceProperty.split('.')[0] + ".Name";
                            //propertyName = propertyName[propertyName.length - 1];
                            //rowSchemaCode = rowData[propertyName + "_SchemaCode"];
                        }
                        propertyValue = rowData[propertyName] /*|| rowData[sourceProperty]*/;

                        if (rowSchemaCode == undefined && sourceProperty == targetProperty) {
                            rowSchemaCode = rowData[targetProperty + "_SchemaCode"];
                        }
                        if (rowSchemaCode == undefined) {
                            //携带过来的数据不对，清空当前数据
                            controlManager.ClearValue();
                        }
                        if (controlManager.BOSchemaCode == rowSchemaCode) {
                            //有关联配置
                            if (controlManager.MappingControls && !$.isEmptyObject(controlManager.MappingControls)) {
                                (function (ctrlManager) {
                                    var params = {
                                        SchemaCode: ctrlManager.BOSchemaCode,
                                        ObjectId: rowData[sourceProperty + "_Id"] || rowData[sourceProperty]
                                    }

                                    HTTP.getFormatBizObject(params).then((data) => {
                                        if (data.datas && data.datas.length > 0) {
                                            ctrlManager.SetValue(data.datas[0]);
                                        }
                                    })
                                })(controlManager);
                            } else {
                                //无关联配置
                                var objectId = rowData[sourceProperty + "_Id"] || rowData[sourceProperty];
                                if (targetProperty.indexOf('.') > -1 && sourceProperty.indexOf('.') > -1) {
                                    objectId = rowData[sourceProperty.split('.')[1] + "_Id"];
                                }
                                controlManager.SetValue({
                                    ObjectId: objectId, Name: propertyValue
                                });
                            }
                        }
                    } else if (controlManager.Type == 24) { // 附件
                        var that = this;
                        var objectId = rowData.ObjectId;
                        for (var key in rowData) {
                            if (key.toLowerCase().indexOf(".objectid") > -1) {
                                objectId = rowData[key];
                                break;
                            }
                        }
                        if (controlManager) {
                            (function (ctrlMgr) {
                                var params = {
                                    ActionName: "GetMappingFiles",
                                    SchemaCode: that.BOSchemaCode,
                                    BizObjectId: objectId,
                                    PropertyName: sourceProperty
                                }
                                that.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                                    // 清空控件上的附件
                                    ctrlMgr.ClearFiles();
                                    if (data.ReturnData.HandlerResult && data.ReturnData.HandlerResult.length > 0) {
                                        for (var i = 0, len = data.ReturnData.HandlerResult.length; i < len; i++) {
                                            var result = data.ReturnData.HandlerResult[i];
                                            var url = '/Form/Download?AttachmentID=' + result.AttachmentId;
                                            ctrlMgr.AppendFile(result.FileId, result.AttachmentId, result.FileName, result.Size, result.Thumb, result.Description, url);
                                        }
                                    }
                                });
                            })(controlManager);
                        }
                    } else {
                        if (controlManager.Type == 1) {
                            propertyValue = propertyValue == "是" ? true : false;
                        }
                        //多选人控件时，先清空再赋值
                        if (controlManager.Type == 27) {
                            controlManager.ClearValue();
                        }
                        controlManager.SetValue(propertyValue);
                        controlManager.OnChange();
                    }
                }
            }
            var completeTargetChildSchemas = [];
            //1.查看关联配置中是否配置target为主表单的字段

            //2.将关联表单子表行添加到当前表单子表
            //2.1清除主表子表行并将关联子表的行添加到当前子表
            var listViewData = [];
            for (var targetChild in targetChildSchema) {
                //请求关联的子表数据
                var params = {
                    ActionName: "GetChildSchemaDataByObjectId",
                    TargetChild: targetChild,
                    SchemaCode: this.BOSchemaCode,
                    BizObjectId: rowData.ObjectId,
                    PropertyName: targetChildSchema[targetChild]
                };


                this.Ajax("/Form/OnAction", "POST", { PostData: JSON.stringify(params) }, function (data) {
                    if (data.ReturnData.ListViewData && data.ReturnData.ListViewData.length > 0) {
                        var gridView = $("[data-datafield='" + data.ReturnData.TargetChild + "']").FormGridView();
                        gridView.ClearRows();
                        var listViewData = data.ReturnData.ListViewData;
                        for (var i = 0; i < listViewData.length; i++) {
                            var newRowData = {
                            };
                            newRowData["ObjectId"] = $.IGuid();
                            for (var targetProperty in mappingCtrl_childSchema) {
                                var fieldValue = listViewData[i][mappingCtrl_childSchema[targetProperty]];
                                if (fieldValue == void 0) continue;
                                newRowData[targetProperty] = fieldValue;
                            }
                            gridView.AddRow($.IGuid(), newRowData);
                        }
                    }
                    //var gridView = $("[data-datafield='" + data.ReturnData.TargetChild + "']");
                    //if (gridView.length > 0) {
                    //    gridView = gridView.FormGridView();
                    //    gridView.ResizeColumn(true);
                    //}
                });
            }
        }
    });
})(jQuery);;
// FormMultiQuery控件
; (function ($) {
    // 控件实例执行方式
    $.fn.FormMultiQuery = function () {
        return $.ControlManager.Run.call(this, "FormMultiQuery", arguments);
    };

    $.FormMultiQueryData = {
        PropertyQueryItems: {},
        PropertyQueryColumns: {},
        SchemaCodeAcl: {},
        PropertyQueryDefaultValues: {}
    };

    // 构造函数
    $.Controls.FormMultiQuery = function (element, options, sheetInfo) {
        $.Controls.FormMultiQuery.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormMultiQuery.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            var that = this;
            that.FirstLoad = true;
            //是否在子表里面子表
            that.IsInGridView = !$.isEmptyObject(this.ObjectId);
            //that.IsQueryControl = false;
            that.CurrentDocument = $(that.Element).closest("html").parent();
            that.CurrentBody = $(that.Element).closest("body").length == 0 ? $("body") : $(that.Element).closest("body");


            that.SheetData = {};//关联表单过滤用到的数据
            that.LoadData = [];//关联表单的数据，表示加载出来的当前表单对应的关联的数据
            if ($.FormMultiQueryData[that.BOSchemaCode]) {
                that.IsRunnable = $.FormMultiQueryData[that.BOSchemaCode].IsRunnable;
                that.CanCreate = $.FormMultiQueryData[that.BOSchemaCode].CanCreate;
                that._Render();
            }
            else {
                var postData = { PostData: JSON.stringify({ ActionName: "LoadSchemaAcl", SchemaCode: that.BOSchemaCode }) }
                // that.Ajax("/Form/OnAction", "GET", postData, function (data) {
                //     $.FormMultiQueryData[that.BOSchemaCode] = data.ReturnData;
                //     that.IsRunnable = data.ReturnData.IsRunnable;
                //     that.CanCreate = data.ReturnData.CanCreate;
                //     that._Render();
                // }, false);

                setTimeout((data) => {
                    data = { "Successful": true, "ErrorMessage": null, "Logined": true, "ReturnData": { "CanCreate": true, "IsRunnable": true } }
                    $.FormMultiQueryData[that.BOSchemaCode] = data.ReturnData;
                    that.IsRunnable = data.ReturnData.IsRunnable;
                    that.CanCreate = data.ReturnData.CanCreate;
                    that._Render();
                }, 500)
            }
        },

        _Render: function () {
            //是否通过Url传值过来
            if ($.IQuery(this.BOSchemaCode)) {
                if ($.IQuery(this.BOSchemaCode + "_Name")) {
                    this.Value = $.IQuery(this.BOSchemaCode);
                } else {
                    this.Editable = false;
                    //2017-3-22注释，关联列表新增的表单打开时候修改过的携带的值会被还原。
                    //this.Value = $.IQuery(this.BOSchemaCode);
                }
            }
            //是否可见
            if (!this.Visible) {
                $(this.Element).hide(); return;
            }
            //渲染前端
            this.HtmlRender();

            if ($.SmartForm != null && $.SmartForm.ResponseContext != null) {
                // 新增时，赋值需要处理改变事件，如携带之类的
                if ($.SmartForm.ResponseContext.IsCreateMode) {
                    this.BindChange("FormMultiQueryChange", this.Change);
                    //初始化默认值
                    this.InitValue();
                } else {
                    //初始化默认值
                    this.InitValue();
                    this.BindChange("FormMultiQueryChange", this.Change);
                }
            } else {
                this.BindChange("FormMultiQueryChange", this.Change);
                //初始化默认值
                this.InitValue();
            }
            //不可用
            if (!this.Editable) {
                this.SetReadonly(true);
            } else {
                this.BindEvent();
            }
        },

        //渲染前端
        HtmlRender: function () {
            var that = this;
            $(this.Element).addClass('SheetMultiQuery');
            if (!this.Editable) {
                this.$Input = $("<pre>");
                this.$InputBody.append(this.$Input);
            } else {
                this.ID = "FormMultiQuery_" + $.IGuid();
                this.$addModel = $("<a class='form-query-addModel icon-newsvg'></a>");
                this.$Input = $("<div class='form-control form-query-add' placeholder='点击选择已有表单的数据'></div");
                this.$InputBody.css({ 'position': 'relative', 'min-width': '210px' });
                this.$InputBody.append(this.$Input).append(this.$addModel);
                //改为点击时执行
                //setTimeout(that._renderDropDown(that), 0);//渲染下拉
                //setTimeout(that._renderModal(that), 0);//渲染模态框
            }
        },
        BindEvent: function () {
            var that = this;
            this.$addModel.one("click", function (e) {
                that._renderModal.apply(that);
                that.$addModel.trigger("click");
            });
            this.$Input.one("click", function (e) {
                if (!that.$dropDownItemContainer) {
                    that._renderDropDown.apply(that);
                }
            });
        },
        // 获取元素相对屏幕的绝对位置
        _getAbsPosition: function (element) {
            var that = this;
            var left = 0;
            var abs = {
                x: 0, y: 0
            };

            //火狐浏览器下拉框位置问题
            var inputOffset = $(element).offset();
            abs.x = inputOffset.left;
            abs.y = inputOffset.top;

            //if (document.documentElement.getBoundingClientRect) {
            //    abs.x = element.getBoundingClientRect().left;
            //    abs.y = element.getBoundingClientRect().top;
            //    abs.y += document.body.scrollTop | document.documentElement.scrollTop + document.documentElement.scrollTop - document.documentElement.clientTop;
            //} else {
            //    abs.x = $(element).offset().left;
            //    abs.y = $(element).offset().top + $(element).outerHeight;
            //}
            return abs;
        },
        //加载下拉框数据
        _loadDropDownData: function (needClear) {
            var that = this;
            that._getAssociationFilterData();
            if (needClear) {
                that.offset = 0;
            }
            var defaultParams = {
                ActionName: "DoAction",
                Command: 'Load',
                QueryCode: that.BOSchemaCode,
                Status: 1,
                SheetQuery: 1,
                //isFormControl: true,
                ListScene: 2,
                SheetCode: that.SchemaCode,
                DataField: that.DataField,
                SheetData: JSON.stringify(that.SheetData),
                scopeType: 3,
                pageNum: that.pageNumber,
                IsSheetQueryDropDown: true
            };
            var searchName = that.$dropDownInput.val().trim();
            var searchParams = {};
            var params = {};
            if (searchName) {
                if (that.associateChildSchema) {
                    params[that.BOSchemaCode + '.Name'] = [searchName];
                } else {
                    params['Name'] = [searchName];
                }
            }
            searchParams['searchParamsJson'] = JSON.stringify(params);

            $.extend(defaultParams, searchParams);
            if (!that.FirstLoad) {
                var param = {}
                param.QueryCode = that.BOSchemaCode;
                param.SheetData = JSON.stringify(that.SheetData);
                param.DataField = that.DataField;
                param.SheetCode = that.SchemaCode;
                param.isAssociateForm = 1
                if (!needClear) {
                    param.pageNum = Math.ceil(that.offset / 10) + 1;
                }
                if (searchName) {
                    param["nameSchema"] = searchName;
                }
                HTTP.appRunPage(param).then((data) => {
                    if (data.Code == 0) {
                        that.LoadData = data.Result.ReturnData;
                        that._bindDataToDropDown(needClear, that.LoadData);
                    } else {
                        Message.error({
                            content: "获取的关联信息错误" + data.msg,
                            duration: 3
                        });
                    }
                })

                // that.Ajax('/App/OnAction', 'GET', { PostData: JSON.stringify(defaultParams) }, function (data) {
                //     if (data.Successful) {
                //         that.LoadData = data.ReturnData.Response.ReturnData;
                //         that._bindDataToDropDown(needClear, data.ReturnData.Response.ReturnData);
                //     }
                // }, true);
            }
        },
        //绑定过滤的数据到下拉框
        _bindDataToDropDown: function (needClear, data) {
            var that = this;
            that.$dropDownItemContainer.hide();
            if (needClear) {
                that.$dropDownItemContainer.empty();
            }
            if (data && data.length > 0) {
                that.offset += data.length;
                //判断是关联主表还是子表
                //表单中的控件直接通过BOSchemaInfo判断关联的是否是子表；列表过滤条件要根据返回值判断
                if (that.associateChildSchema == undefined) {
                    that.associateChildSchema = false;
                    for (var key in data[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            that.associateChildSchema = true;
                            break;
                        }
                    }
                }
                var existObjectIds = that.$Input.data('ObjectId');
                if (existObjectIds) {
                    existObjectIds = existObjectIds.split(';');
                } else {
                    existObjectIds = [];
                }
                if (needClear && that.IsQueryControl) {
                    var arr = [];
                    if (that.associateChildSchema) {
                        var noSelectValue = {};
                        var objectId = that.BOSchemaCode + ".ObjectId";
                        var name = that.BOSchemaCode + ".Name";
                        noSelectValue[objectId] = "--";
                        noSelectValue[name] = "--(空值)";
                        arr.push(noSelectValue);
                    } else {
                        arr = [{ ObjectId: "--", Name: '--(空值)' }];
                    }
                    data = arr.concat(data);
                }
                for (var i = 0, len = data.length; i < len; i++) {
                    var id = $.IGuid();
                    var itemId = data[i].ObjectId;
                    var itemName = data[i].Name;
                    if (that.associateChildSchema) {
                        itemId = data[i][that.BOSchemaCode + '.ObjectId'];
                        itemName = data[i][that.BOSchemaCode + '.Name'];
                    }
                    itemName = (itemName == null || itemName == void 0) ? '--' : ($.trim(itemName) == '' ? '--' : itemName);
                    var $dropDownItemRow = $('<div class="row form-query-itemrow"></div>');
                    $dropDownItemRow.hover(function () {
                        $(this).find('label.form-query-item-label').css({
                            'background-color': '#eff7fd',
                            'color': '#38adff'
                        });
                    }, function () {
                        $(this).find('label.form-query-item-label').css({
                            'background-color': '#fff',
                            'color': '#818181'
                        })
                    });
                    var $dropDownItem = $('<input type="checkbox" data-itemid = "' + itemId + '"  id="' + id + '"  value="' + itemName + '" style="display:none;" />');
                    var $dropDownItemLabel = $('<label class="form-query-item-label" for= "' + id + '" data-itemid="' + itemId + '" title="' + itemName + '">' + itemName + '</label>');
                    $dropDownItemLabel.css('margin-left', '15px');
                    $dropDownItemRow.append($dropDownItem).append($dropDownItemLabel);
                    //对于搜索出来的数据，如果之前已经选过则要勾中
                    if ($.inArray(itemId, existObjectIds) > -1) {
                        $dropDownItem.prop('checked', true);
                    } else if (itemId == undefined) {//undefined情况要处理下
                        if ($.inArray('undefined', existObjectIds) > -1) {
                            $dropDownItem.prop('checked', true);
                        }
                    }
                    that.$dropDownItemContainer.append($dropDownItemRow);
                    var eventName = 'click.';
                    if (that.DataField) {
                        eventName += that.DataField;
                    } else if (that.ID) {
                        eventName += that.ID;
                    }
                    $dropDownItem.off(eventName).on(eventName, function (e) {
                        //这里不能清空Input
                        var $links = '';
                        var objectIds = '';
                        var checkState = $(this).is(':checked');
                        if (checkState) {//选中
                            var objectId = $(this).data('itemid');
                            objectIds = that.$Input.data('ObjectId') || '';
                            if (objectIds.indexOf(objectId) > -1) {
                                return;
                            }
                            var link = '<a href="javascript:;" class="label label-info" style="position:relative" title="' + $(this).val() + '">' + $(this).val() + '<i class="fa icon-close-middle" style="margin-left:5px;right:0;" data-objectId="' + objectId + '"></i></a>';
                            //添加时清空空的链接
                            that.$Input.append(link);
                            if (objectIds != '' && objectIds.charAt(objectIds.length - 1) != ';') {
                                objectIds += ';';
                            }
                            objectIds += (objectId + ';');
                            that.$Input.data('ObjectId', objectIds);
                        } else {//取消选中
                            var objectId = $(this).data('itemid');
                            that.$Input.find()
                            objectIds = that.$Input.data('ObjectId');
                            objectIds = objectIds.replace(objectId + ';', '');
                            that.$Input.data('ObjectId', objectIds);
                            that.$Input.find('i[data-objectId="' + objectId + '"]').parent().remove();
                        }

                        that.$Input.find('i').on('click', function () {
                            var $this = $(this);
                            $this.closest('a').remove();
                            var objectIds = that.$Input.data('ObjectId');
                            var thisObjectId = $this.attr('data-ObjectId');
                            objectIds = objectIds.replace(thisObjectId + ';', '');
                            that.$Input.data('ObjectId', objectIds);
                            that.OnChange();
                            that.$dropDownItemContainer.find('input[type="checkbox"][data-itemid="' + thisObjectId + '"]').prop('checked', false);
                        });
                        that.OnChange();
                    });
                    $dropDownItemLabel.off(eventName).on(eventName, function (e) {
                        e.stopPropagation();
                    });
                }
            }
            that.$dropDownItemContainer.show();
        },
        //渲染FormMultiQuery的下拉
        _renderDropDown: function () {
            this.offset = 0;
            var that = this;
            var h = that.$Input.outerHeight();
            if (h > 32) {
                //IE11中点击时候h会很大
                that.$Input.height(32);
                h = 32;
            }
            var w = that.$Input.outerWidth();
            var position = that._getAbsPosition(that.$Input[0]);

            var dropdownStr = "<div class='form-query-dropdown' style='left:" + position.x + "; top:" + (position.y + h) + "; width:" + w + "'></div>";

            that.$dropdown = $(dropdownStr);

            //绑定元素父元素的滚动事件，重新赋值$UserPanel的高度和left
            $.each($(this.Element).parents(), function (index, obj) {
                $(obj).scroll(function () {
                    that.$dropdown.css("top", that.$Input.offset().top + that.$Input.outerHeight());
                });
            });
            var $dropDownInputRow = $('<div class="row" style="margin-left:0;margin-right:0;"></div>');

            that.$dropDownInput = $('<input type="text" autofocus="autofocus" class="form-control form-input search-input-dropdown" placeholder="输入表单名称查找"  />');
            that.$dropDownInput.off('keyup').on('keyup', function (event) {
                that.TimeOut && window.clearTimeout(that.TimeOut);
                that.TimeOut = setTimeout(function () { that._loadDropDownData(true) }, 1000);
                event.stopPropagation();
            });

            $dropDownInputRow.append(that.$dropDownInput);
            that.$dropDownItemContainer = $('<div class="form-query-container">')
            that.$dropdown.append($dropDownInputRow).append(that.$dropDownItemContainer);

            //绑定滚动事件
            that.$dropDownItemContainer.scroll(function () {
                var h_container = $(this).height();//窗口高度
                var h_scrollTop = $(this).scrollTop();//滚动条顶部
                if (0 + h_scrollTop >= $(this)[0].scrollHeight - h_container) {
                    that._loadDropDownData(false);
                }
            });
            //初始时候请求数据
            that._loadDropDownData(true);
            //Error：报表过滤情况CurrentBody是空的，
            //原因是在初始化控件的时候没有把元素append到DOM中，
            //所以在下面的点击事件中加了判断，如果不存在要先append到DOM中
            $(that.CurrentBody).append(that.$dropdown);
            //点击文本狂显示
            that.$Input.on('click.addModel', function () {
                if ($(that.Element).css("visibility") == "hidden") {
                    return;
                }
                that.FirstLoad = false;
                //记录当前dropdown是否可见
                var thisDropDownIsVisible = that.$dropdown.is(":visible");
                //隐藏界面上所有的dropdown
                $('.form-query-dropdown').hide();
                //如果当前dropdown是可见的直接隐藏掉就可以了
                if (thisDropDownIsVisible) {
                    that.$dropdown.hide();
                    return;
                }
                //判断dom中是否有dropdown，如果没有就append进去
                //这种情况出现在render时候
                var $body = $($(that.Element).closest("body"));
                if ($body.find('div.form-query-dropdown').length == 0) {
                    $body.append(that.$dropdown);
                }
                var searchText = that.$dropDownInput.val().trim();
                //如果有搜索记录则清空
                if (searchText != '') {
                    that.$dropDownInput.val('');
                }
                that._getAssociationFilterData();
                //每次打开下拉框都要重新加载数据
                that._loadDropDownData(true);


                var hh = '300px';
                that.$dropDownItemContainer.css('max-height', '150px');
                //如果是列表过滤控件要重新获取坐标
                var h = that.$Input.outerHeight();
                var w = that.$Input.outerWidth();
                var position = that._getAbsPosition(that.$Input[0]);
                that.$dropdown.css({
                    'position': 'absolute',
                    'left': position.x,
                    'top': position.y + h,
                    'width': w
                });
                that.$dropdown.show();
                //获取焦点
                that.$dropdown.find('input.search-input-dropdown').focus();
                //if (that.$dropdown.is(':hidden'))
                //    return;
                //获取已经选中的item，在dropdown中设置勾中
                var selectedObjectIds = $(this).data('ObjectId');
                if (selectedObjectIds) {
                    var newSelectedObjectIds = [];
                    selectedObjectIds = selectedObjectIds.split(';');
                    for (var i = 0; i < selectedObjectIds.length; i++) {
                        if (selectedObjectIds[i] == 'undefined' || selectedObjectIds[i] == '') {
                            continue;
                        }
                        newSelectedObjectIds.push(selectedObjectIds[i]);
                    }
                    selectedObjectIds = newSelectedObjectIds;
                }
                if (selectedObjectIds && selectedObjectIds.length > 0) {
                    var checkboxItems = that.$dropDownItemContainer.find('input[type="checkbox"]');
                    for (var i = 0; i < checkboxItems.length; i++) {
                        $(checkboxItems[i]).prop('checked', false);
                        var itemObjectId = $(checkboxItems[i]).attr('data-itemid');
                        if ($.inArray(itemObjectId, selectedObjectIds) > -1) {
                            $(checkboxItems[i]).prop('checked', true);
                        }
                    }
                }
            });
            var $body = $(that.CurrentBody);
            var eventName = 'click.';
            if (that.DataField) {
                if (that.DataField.indexOf('.') > 0) {
                    //在子表
                    var trObjectId = $(that.Element).closest('tr').attr('data-objectid');
                    eventName += trObjectId + '.' + that.DataField;
                } else {
                    eventName += that.DataField;
                }
            } else if (that.ID) {
                eventName += that.ID;
            }
            //点击DropDown以外区域隐藏
            //后续要改进，不要每个控件绑定document的click事件，能不能在一个click里面隐藏所有的。需要考虑到主表，子表，列表过滤，报表过滤，列表默认值等地方
            //绑定事件到document
            $($body.parent().parent()).off(eventName).on(eventName, that, function (e) {
                var target = e.target;
                var ctrl = e.data;
                if (ctrl.$Input[0] != target && ctrl.$dropdown.find($(target)).length == 0) {
                    ctrl.$dropdown.hide();
                }
            });
            that.$Input.trigger("click");
        },
        //渲染 FormMultiQuery的Modal
        _renderModal: function () {
            var that = this;
            that.ID = "FormMultiQuery_" + $.IGuid();
            that.$modal = $("<div id='" + that.ID + "' class='modal fade modal-formquery' style='z-index:1000;' data-backdrop='false' role='dialog'>" +
                "<div class='modal-dialog modal-lg modal-dialog-form'>" +
                "<div class='modal-content'>" +
                "<div class='modal-header modal-header-form'><div class='close' style='margin- top:-2px;' data-dismiss='modal'><span aria-hidden='true' class='fa' style='font-size:16px;'><i class='ivu-icon ivu-icon-close' :color='white'></i></span></div><h4 class='modal-title modal-title-form'>选择" + that.DisplayName + "</h4></div>" +
                "</div>" +
                "</div>" +
                "</div>");

            var $modalBody = $("<div class='modal-body'></div>");

            // 查询条件
            that.$searchForm = $("<div class='form-horizontal searchform myform-horizontal backgroundcolor'></div>");
            $modalBody.append(that.$searchForm);

            //查询条件按钮分割线
            that.$partingLine = $("<div style='border-bottom:1px solid #E3E7E9;text-align:center;'><i class='fa icon-arrow-up-double-b btn-up btnToggle' style='color:#e5e6e6;'></i></div>")
            $modalBody.append(that.$partingLine);

            var $modalFooter = $("<div class='modal-footer modal-footer-form'></div>");

            // 按钮
            that.$toolbar = $("<div class='toolbar text-left' style='margin-top:10px;'><div class='btn-group btn-group-sm' role='group'><button class='btn btn-ok btn-search btnSearch hide '><i class='fa fa-search'></i>查询</button><button class='btn btn-create btnAdd hide'><i class='fa icon-increase'></i>新增</button></div></div>");
            $modalBody.append(that.$toolbar);

            // 表格
            that.Table_ID = "FormTable_" + $.IGuid();
            that.$table = $("<table id='" + that.Table_ID + "' ></table>");

            var pagerStr = '<div class="table-page" id="bar-' + that.Table_ID + '">' +
                '<div class="page-index">' +
                '<input type="text" value="1" class="Page_Index" />/<label class="Page_Count">1</label>' +
                '</div>' +
                '<div class="btn-group table-page_ButtonGroup" style="width: 160px;">' +
                '<button class="btn Page_Num_Pre">上一页</button>' +
                '<button class="btn Page_Num_Next">下一页</button>' +
                '</div>' +
                '<div class="page-size dropup">' +
                '<button class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                '<span class="Page_Per_Size">' + 10 + '</span>' +
                '<i class="fa fa-angle-down"></i>' +
                '</button>' +
                '<ul class="dropdown-menu">' +
                '<li><a>5</a></li>' +
                '<li><a>10</a></li>' +
                '<li><a>20</a></li>' +
                '<li><a>50</a></li>' +
                '</ul>' +
                '</div>' +
                '<div class="page-total">共0条</div>' +
                '</div>';
            var buttonStr = '<div class="btn-group btn-group-sm" role="group" style="width:100%;"><button class="btn btn-ok btnMultiSelect">确定</button></div>';
            $modalBody.append(that.$table).append(pagerStr);
            //如果关联查询控件在子表中则允许批量选择，增加确定按钮
            //新增的时候出现按钮
            $modalFooter.append(buttonStr);
            that.$modal.find(".modal-content").append($modalBody).append($modalFooter);
            $(that.CurrentBody).append(that.$modal);
            that.SheetData = {};
            that.TableNeedRefresh = false;//为true的情况：关联查询过滤规则中配置了主表单的字段
            that.$addModel.off("click").on("click", function () {
                that.$dropdown && that.$dropdown.hide();
                //关联表单信息
                var associationSchemaInfo = $(that.Element).attr('data-boSchemaInfo');
                if (associationSchemaInfo != void 0 && associationSchemaInfo != '') {
                    var infoJson = $.parseJSON(associationSchemaInfo);
                    that.associateChildSchema = infoJson.IsChildSchema;
                } else {
                    that.associateChildSchema = undefined;
                }

                that._getAssociationFilterData();
                that.$modal.modal("show");
            });

            that.SearchInitialized = false; // 查询条件是否已初始化
            that.TableInitialized = false; // 表格是否已初始化
            that.CheckedRows = [];//点击“确定”按钮或者“查询”按钮将勾选的行存入CheckedRows
            // modal的show事件
            that.$modal.on("show.bs.modal", function (e) {
                $.MsgFilter.show();
                that.SelectedItems = [];
                var items = that.$Input.find('i');
                for (var i = 0; i < items.length; i++) {
                    var $item = $(items[i]);
                    var objectId = $item.attr('data-objectid');
                    if (objectId == 'undefined') {
                        continue;
                    }
                    var name = $item.closest('a').text();
                    that.SelectedItems.push({
                        ObjectId: objectId, Name: name
                    });
                }

                that.$table.bootstrapTable('uncheckAll');
                var currModal = this;
                if (!$.FormMultiQueryData.PropertyQueryItems[that.BOSchemaCode] || !$.FormMultiQueryData.PropertyQueryColumns[that.BOSchemaCode]) {
                    //var params = {
                    //    ActionName: "GetPropertyQueryColumnAndItem",
                    //    SchemaCode: that.BOSchemaCode,
                    //    flag: $.IGuid()
                    //}
                    var params = {
                        ActionName: "LoadView",
                        QueryCode: that.BOSchemaCode,
                        flag: $.IGuid()
                    }


                    var param = {}
                    param.appId = that.BOSchemaCode;
                    // param.SheetData=JSON.stringify(that.SheetData);
                    // param.DataField=that.DataField;
                    // param.SheetCode= that.SchemaCode;
                    // param.isAssociateForm=1
                    HTTP.getListSetting(param).then((data) => {
                        if (data.Code != 0) {
                            Message.error({
                                content: "没有设置可用列！",
                                duration: 3
                            });
                            return;
                        }
                        var ret = [];
                        ret.push(
                            {
                                "Align": null,
                                "CanBeQueryItem": true,
                                "ChildColumns": null,
                                "Code": "Name",
                                "DisplayName": "数据标题",
                                "IsChild": null,
                                "IsLabel": null,
                                "IsQueryItem": false,
                                "OptionValue": null,
                                "PropertyName": null,
                                "ShowMode": null,
                                "Sortable": false,
                                "Type": null,
                                "UnitType": null,
                                "Url": null,
                                "Visible": true
                            }
                        )
                        for (var index = 0; index < data.Data.ListViewData.length; index++) {
                            ret.push(data.Data.ListViewData[index])
                        }

                        $.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = ret;
                        //$.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = data.ReturnData.SortedColumns;
                        //调整initSearchParams位置为initTable之前，原因是在关联列表中初始时候searchform是空
                        $.FormQueryData.PropertyQueryItems[that.BOSchemaCode] = [];
                        // $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode] = JSON.parse(data.ReturnData.QueryDefaultValues);
                        // if (!that.SearchInitialized) {
                        //     that._initSearchParams(data.ReturnData.QueryItems, $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode]);
                        // }

                        // $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode] = JSON.parse(data.ReturnData.QueryDefaultValues);


                        var qry = [];
                        qry.push({
                            "PropertyName": "Name",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "数据标题",
                            "DataType": 14,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })

                        qry.push({
                            "PropertyName": "CreatedTime",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "创建时间",
                            "DataType": 5,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })





                        if (!that.SearchInitialized) {
                            that._initSearchParams(qry, {});
                        }


                        if (!that.TableInitialized || that.TableNeedRefresh) {
                            that._initTable($.FormQueryData.PropertyQueryColumns[that.BOSchemaCode]);//合并表头
                        } else {
                            that._setRowChecked();
                        }
                        //that.afterTableInit();
                    })


                    // that.Ajax("/App/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                    //     if (data.ReturnData.Response.Columns.length == 0 && data.ReturnData.QueryItems.length == 0) {
                    //         $(currModal).modal("hide");
                    //         //$.IShowError("没有设置可用列！");
                    //         Message.error({
                    //             content:"没有设置可用列！",
                    //             duration: 3
                    //         });
                    //         return;
                    //     }
                    //     $.FormMultiQueryData.PropertyQueryColumns[that.BOSchemaCode] = data.ReturnData.Response.Columns;

                    //     //调整initSearchParams位置为initTable之前，原因是在关联列表中初始时候searchform是空
                    //     $.FormMultiQueryData.PropertyQueryItems[that.BOSchemaCode] = data.ReturnData.QueryItems;
                    //     $.FormMultiQueryData.PropertyQueryDefaultValues[that.BOSchemaCode] = JSON.parse(data.ReturnData.QueryDefaultValues);

                    //     if (!that.SearchInitialized) {
                    //         that._initSearchParams(data.ReturnData.QueryItems, $.FormMultiQueryData.PropertyQueryDefaultValues[that.BOSchemaCode]);
                    //     }

                    //     if (!that.TableInitialized || that.TableNeedRefresh) {
                    //         that._initTable(data.ReturnData.Response.Columns);//合并表头
                    //     } else {
                    //         that._setRowChecked();
                    //     }
                    // });
                } else {
                    if (!that.TableInitialized || that.TableNeedRefresh) {
                        that._initTable($.FormMultiQueryData.PropertyQueryColumns[that.BOSchemaCode]);
                    } else {
                        that._setRowChecked();
                    }
                    if (!that.SearchInitialized) {
                        var qry = [];
                        qry.push({
                            "PropertyName": "Name",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "数据标题",
                            "DataType": 14,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })

                        qry.push({
                            "PropertyName": "CreatedTime",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "创建时间",
                            "DataType": 5,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })
                        that._initSearchParams(qry, {});
                    }
                }
                //判断是否要合并表头
                that._setColumnColspan(that.TableAllColumns);
            });
            that.$modal.on("hidden.bs.modal", function (e) {
                $.MsgFilter.remove();
            });
            var $btnAdd = that.$toolbar.find(".btnAdd");
            // 只有表单中的关联查询允许新增关联对象
            if (that.IsRunnable && that.CanCreate && $(that.Element).hasClass("sheet-control")) {
                // 新增关联对象
                $btnAdd.removeClass("hide");
                $btnAdd.off("click").on("click", function () {

                    var params = {
                        ActionName: "GetBizObjectSchemaDisplayName",
                        SchemaCode: that.BOSchemaCode,
                        flag: $.IGuid()
                    }
                    HTTP.getBizObjectSchemaDisplayName(that.BOSchemaCode).then((data) => {
                        if (data.code == 0) {
                            //var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&BizObjectId=" + boId + "&Mode=View";
                            // $.ISideModal.Show(url,data.data.DisplayName);


                            let instanceNew = Modal.newInstance({
                                //scrollable:true,
                                title: data.data.DisplayName,
                                footerHide: true,
                                maskClosable: false,
                                closable: false,
                                render: (h) => {
                                    return h(addRelativeModal, {
                                        props: {
                                            code: that.BOSchemaCode
                                        }
                                    })
                                }
                            })
                            var options = { showCancel: true, width: "800px" };
                            options.onRemove = function () {
                                instanceNew = null;
                            };
                            instanceNew.show(options);

                        }
                    })



                    // that.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                    //     if (data.Successful) {
                    //         var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&SheetQueryField=" + that.DataField;
                    //         if (that.BizObjectId) {
                    //             url += "&SheetQueryRowId=" + that.BizObjectId;
                    //         }
                    //         that.$modal.modal("hide");
                    //         $.ISideModal.Show(url, data.ReturnData.DisplayName);
                    //     }
                    // });
                });
            } else {
                $btnAdd.addClass("hide");
            }

            //子表批量选择功能
            var $btnMultiSelect = that.$modal.find('.btnMultiSelect');
            //批量选择确定
            $btnMultiSelect.off('click').on('click', function () {

                that.$modal.modal('hide');
                $('.table-tip').hide();
                //获取check的行
                var datafield = that.DataField;
                var objectIds = '';
                //控件在主表中
                if (that.associateChildSchema == undefined) {
                    that.associateChildSchema = false;
                    for (var key in that.CheckedRows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            that.associateChildSchema = true;
                            break;
                        }
                    }
                }
                var objectIdStr = 'ObjectId';
                var nameStr = 'Name';
                if (that.associateChildSchema) {
                    objectIdStr = that.BOSchemaCode + '.ObjectId';
                    nameStr = that.BOSchemaCode + '.Name';
                }
                //用于列表过滤条件
                that.$Input.empty();
                that.$Input.data('ObjectId', '').empty();
                //Error：checkedRows有重复

                for (var i = 0; i < that.CheckedRows.length; i++) {
                    var objectId = that.CheckedRows[i][objectIdStr];
                    if (!objectId) {
                        continue;
                    }
                    var name = that.CheckedRows[i][nameStr] || "--";
                    var link = '<a href="javascript:;" class="label label-info">' + name + '<i class="fa icon-close-middle" style="margin-left:5px" data-objectId="' + objectId + '"></i></a>';
                    that.$Input.append(link);
                    objectIds = that.$Input.data('ObjectId') || '';
                    objectIds += (objectId + ';');
                    that.$Input.data('ObjectId', objectIds);
                }
                that.$Input.find('i').on('click', function () {
                    var $this = $(this);
                    $this.closest('a').remove();
                    var objectIds = that.$Input.data('ObjectId');
                    var thisObjectId = $this.attr('data-ObjectId');
                    objectIds = objectIds.replace(thisObjectId + ';', '');
                    that.$Input.data('ObjectId', objectIds);
                    that.OnChange();
                    that.$dropDownItemContainer.find('input[type="checkbox"][data-itemid="' + thisObjectId + '"]').prop('checked', false);
                });
                that.OnChange();
            });
        },

        //获取关联表单过滤条件中控件的值
        _getAssociationFilterData: function () {
            //判断关联查询是否配置了过滤规则
            //如果配置了过滤规则且规则中有当前主表单的字段
            //则要取主表单中的字段
            //兼容旧的bofilter
            var that = this;
            if (that.DataField == void 0) {
                return;
            }
            var bofilter = $(that.Element).attr('data-bofilter');
            if (that.AssociationFilter || bofilter) {
                var rule = that.AssociationFilter.Rule || $.parseJSON(bofilter).Rule;
                if (rule && rule.length > 0) {
                    var controlsList = $.ControlManager.Controls;
                    var hasCreatedByCtrl = false;//是否有创建者控件
                    var hasOwnerCtrl = false;//是否有拥有者控件
                    var hasOwnerDeptCtrl = false;//是否有所属部门控件
                    console.log(store.state.listview)
                    var controls = controlsList[that.SchemaCode + "_" + store.state.listview.currentTabIndex]
                    for (var control in controls) {
                        var ctrl = controls[control];
                        if (ctrl.IsQueryControl) {
                            continue;
                        }
                        var controlDataField = ctrl.DataField;
                        if (controlDataField == 'CreatedBy.FullName') {
                            controlDataField = controlDataField.split('.')[0];
                            hasCreatedByCtrl = true;
                        }
                        if (controlDataField == 'OwnerId') {
                            hasOwnerCtrl = true;
                        }
                        if (controlDataField == 'OwnerDeptId') {
                            hasOwnerDeptCtrl = true;
                        }
                        //rule.indexOf(controlDataField)<0这样不能判断rule中是否有controlDataField,例如rule:{D00001.helloworld}=="hi",controlDataField:hello
                        if (rule.indexOf(controlDataField + '}') < 0 || controlDataField == that.DataField) continue;
                        //如果rule中包含controlDataField，则应该是以如下形式存在
                        //{xx}或者{xxx.xx}形式，主表中的字段是{controlDataField}，子表中字段是{xxx.controlDataField}
                        var ctrlFieldIndex = rule.indexOf(controlDataField + '}');
                        var prefix = rule.slice(ctrlFieldIndex - 1, ctrlFieldIndex);
                        if (prefix != '{' && prefix != '.') {
                            continue;
                        }
                        //字表中的control不调用SaveDataField，由子表自己调用SaveDataField保存值
                        var controlValue = '';
                        if (controlDataField == 'CreatedBy') {
                            controlValue = []
                            controlValue.push($.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].id.toString());
                        } else {
                            if (ctrl.DataField == void 0 || controlDataField == "Comments") continue;
                            //判断关联查询控件是否在子表中
                            if (controlDataField.indexOf('.') > 0 && ctrl.Type != 26 && ctrl.Type != 27) {
                                //规则中的字段在子表中
                                if (that.DataField.indexOf('.') > 0) {
                                    //获取与关联查询控件同一行的子表控件
                                    var $tr = $(that.Element).closest('tr');
                                    var thisRowCtrl = $tr.find('div[data-datafield="' + controlDataField + '"]');
                                    if (thisRowCtrl.length > 0) {
                                        controlValue = $(thisRowCtrl[0]).JControl().GetValue();
                                    }
                                } else {
                                    var $ctrl = $('div[data-datafield="' + controlDataField + '"]').not('.table_th');
                                    if ($ctrl != undefined) {
                                        controlValue = [];
                                        for (var i = 0; i < $ctrl.length; i++) {
                                            controlValue.push($($ctrl[i]).JControl().GetValue());
                                        }
                                    }
                                }
                            } else {
                                if (ctrl.Type == 26 || ctrl.Type == 27) {
                                    //单人
                                    //控件没有渲染的情况
                                    if (!ctrl.Visible) {
                                        if (ctrl.Type == 26) {
                                            controlValue = ctrl.Value[0].UnitId;
                                        } else {

                                        }
                                    } else {
                                        controlValue = ctrl.GetUnitIDs();
                                    }
                                } else if (ctrl.Type == 7) {
                                    controlValue = ctrl.GetNum();
                                } else {
                                    controlValue = ctrl.GetValue();
                                }
                            }
                        }
                        that.SheetData[controlDataField] = controlValue;
                        that.TableNeedRefresh = true;
                        //if (controlValue) break;
                    }
                    // if (!hasCreatedByCtrl) {
                    //     that.SheetData["CreatedBy"] = $.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].UnitId;
                    // }
                    // if (!hasOwnerCtrl) {
                    //     that.SheetData["OwnerId"] = $.SmartForm.ResponseContext.ReturnData.OwnerId.Value[0].UnitId;
                    // }
                    // if (!hasOwnerDeptCtrl) {
                    //     that.SheetData["OwnerDeptId"] = $.SmartForm.ResponseContext.ReturnData.OwnerDeptId ? ($.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0] != undefined ? $.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0].UnitId : null) : null;
                    // }
                    // that.SheetData["CreatedTime"] = $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value;
                    // that.SheetData["ParentObjectId"] = $.SmartForm.ResponseContext.BizObjectId;
                }
            }
        },
        //判断是否要合并表头
        _setColumnColspan: function (columns) {
            if (columns == void 0 || columns.length == 0) {
                return;
            }
            var colspantr = this.$table.find('thead tr[class="tr-colspan"]');
            if (colspantr != void 0 && colspantr.length > 0) {
                return;
            }
            var parentColumnCount = 0;
            var childColumnCount = 0;
            for (var i = 0; i < columns.length; i++) {
                var field = columns[i].field;
                if (!columns[i].visible || field == undefined) {
                    continue;
                }
                if (field.indexOf('.') > -1) {
                    childColumnCount++;
                } else {
                    parentColumnCount++;
                }
            }
            if (childColumnCount > 0) {
                if (this.$table.find('th[data-field="checkcolumn"]').length == 0 && this.DataField.indexOf('.') > 0) {
                    //checkbox不可见
                    childColumnCount++;
                    parentColumnCount--;
                }
                var tr = $('<tr class="tr-colspan"></tr>').append('<th colspan="' + parentColumnCount + '" style="text-align:center;">主表</th>').append('<th colspan="' + childColumnCount + '" style="text-align:center;">子表</th>');
                var oldtr = this.$table.find('thead tr');
                $(tr).insertBefore(oldtr);
            }
        },
        _checkRows: function (rows) {
            var that = this;
            var childObjectId = undefined;
            //先判断是check的是单行还是多行
            var tempRows = that.CheckedRows;
            if (that.associateChildSchema == true) {
                childObjectId = that.BOSchemaCode + '.ObjectId';
            }
            if ($.isArray(rows)) {
                if (that.associateChildSchema == undefined) {
                    //兼容旧的
                    for (var key in rows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < rows.length; i++) {
                    var rowExist = false;
                    for (var j = 0; j < tempRows.length; j++) {
                        if (childObjectId != undefined) {
                            if (rows[i][childObjectId] == tempRows[j][childObjectId]) {
                                rowExist = true;
                                break;
                            }
                        } else {
                            if (rows[i]['ObjectId'] == that.CheckedRows[j]['ObjectId']) {
                                rowExist = true;
                                break;
                            }
                        }
                    }
                    if (!rowExist) {
                        that.CheckedRows.push(rows[i]);
                    }
                }
            } else {
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                var rowExist = false;
                for (var i = 0; i < tempRows.length; i++) {
                    if (childObjectId != undefined) {
                        if (tempRows[i][childObjectId] == rows[childObjectId]) {
                            rowExist = true;
                            break;
                        }
                    } else {
                        if (tempRows[i]['ObjectId'] == rows['ObjectId']) {
                            rowExist = true;
                        }
                    }
                }
                if (!rowExist) {
                    that.CheckedRows.push(rows);
                }
            }
        },
        _unCheckRows: function (rows) {
            var that = this;
            var childObjectId = undefined;
            var tempRows = that.CheckedRows;
            if (that.associateChildSchema == true) {
                childObjectId = that.BOSchemaCode + '.ObjectId';
            }
            if ($.isArray(rows)) {//多行
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < rows.length; i++) {
                    for (var j = 0; j < tempRows.length; j++) {
                        if (childObjectId != undefined) {
                            that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                                return item[childObjectId] == rows[i][childObjectId];
                            }, true);
                        } else {
                            that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                                return item['ObjectId'] == rows[i]['ObjectId'];
                            }, true);
                        }
                    }
                }
            } else {//单行
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < tempRows.length; i++) {
                    if (childObjectId != undefined) {
                        that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                            return item[childObjectId] == rows[childObjectId];
                        }, true);
                    } else {
                        that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                            return item['ObjectId'] == rows['ObjectId'];
                        }, true);
                    }
                }
            }
        },
        _initSearchParams: function (queryItems, queryDefaultValues) {
            var that = this;
            if (!queryItems || queryItems.length == 0) {
                this.$searchForm.hide();
                this.$partingLine.hide();
                return;
            }
            var searchHtml = "";
            var showCount = 0;
            for (var i = 0, len = queryItems.length; i < len; i++) {
                var queryItem = queryItems[i];
                if (queryItem.Visible == false) {
                    continue;
                }
                searchHtml += (showCount % 2 == 0 ? "<div class='form-group form-group-sm myform-group mgb5' style='margin-bottom:10px;margin-left:0px!important'>" : "");
                switch (queryItem.DataType) {
                    case 1:
                        var inputId = $.IGuid();
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName +
                            '</label><div class="col-sm-4 pdt5"><span class="mycheckbox" data-propertyname="' + queryItem.PropertyName + '">' +
                            '<input type="checkbox" id="' + inputId + 't" value="true" style="display:none;" /><label for="' + inputId + 't" class="checkbox-inline" style="margin:2px 10px 0 0"> 是</label>' +
                            '<input type="checkbox" id="' + inputId + 'f" value="false" style="display:none;" /> <label for="' + inputId + 'f" class="checkbox-inline" style="margin:2px 10px 0 0">否</label></span></div>';

                        break;
                    case 14:
                        if (queryItem.AssociationSchemaCode) {
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5"><div class="mycomboboxlist" data-dataField="' + queryItem.PropertyName + '" data-schemaCode="' + this.BOSchemaCode + '" data-width="100%" data-defalutvalue="' + queryItem.DefaultValue + '"> </div></div>';
                        }
                        else if (queryItem.SelectedValues && queryItem.SelectedValues !== "") {
                            var checkItemsHtml = "";
                            var checkItems = queryItem.SelectedValues.split(";");
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5">';
                            searchHtml += "<select id='" + queryItem.PropertyName + "' multiple='multiple' class='mymultiselect'>";
                            checkItemsHtml += "<option value='--'>--(空值)</option>";
                            for (var ci = 0, clen = checkItems.length; ci < clen; ci++) {
                                checkItemsHtml += "<option value='" + checkItems[ci] + "'> " + checkItems[ci] + "</option>";
                            }
                            searchHtml += checkItemsHtml;
                            searchHtml += "</select></div>";
                        }
                        else {
                            if (queryItem.PropertyName == "SeqNo") {
                                searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5"><input class="form-control mytext " type="text" data-propertyname="' + queryItem.PropertyName + '" /></div>';
                            }
                            else {
                                searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5"><div class="mycombobox" data-dataField="' + queryItem.PropertyName + '" data-schemaCode="' + this.BOSchemaCode + '" data-width="100%" data-defalutvalue="' + queryItem.DefaultValue + '"> </div></div>';
                            }
                        }
                        break;

                    case 13:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><input class="form-control mytext " type="text" data-propertyname="' + queryItem.PropertyName + '" /></div>';
                        break;
                    case 7:
                    case 9:
                    case 11:
                    case 35:
                        if (queryItem.DisplayName == "Status") {
                            //关联查询中的的筛选,隐藏流程状态
                            //add by jnyf
                            continue;
                            //流程状态
                            searchHtml += '<label class="col-sm-2 control-label">流程状态</label><div class="col-sm-4 pdt5">';
                            searchHtml += '<select id="' + queryItem.DisplayName + '" multiple="multiple" class="mymultiselect">';
                            searchHtml += '<option value="进行中">进行中</option><option value="已结束">已结束</option><option value="已取消">已取消</option>';
                            searchHtml += '</select>';
                            searchHtml += '</div>';
                        } else {
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><div class="input-group mynum" data-propertyname="' + queryItem.PropertyName + '"><div class="input-group-addon">从</div><input type="text" class="form-control" /><div class="input-group-addon">至</div><input type="text" class="form-control" /></div></div>';
                        }
                        break;
                    case 5:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="input-group mydatetime" data-propertyname="' + queryItem.PropertyName + '"><div class="input-group-addon">从</div><input type="text" data-datetimemode="' + queryItem.DateTimeMode + '" class="form-control mydatetimepicker mytimestart" /><div class="input-group-addon">至</div><input type="text" data-datetimemode="' + queryItem.DateTimeMode + '" class="form-control mydatetimepicker mytimeend" /></div></div>';
                        break;
                    case 26:
                        var tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-width="100%"></div></div>';
                        if (queryItem.PropertyName == 'OwnerId' || queryItem.PropertyName == 'CreatedBy') {
                            tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-orgunitvisible="false" data-width="100%"></div></div>';
                        } else if (queryItem.PropertyName == 'OwnerDeptId') {
                            tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-orgunitvisible="true" data-uservisible="false" data-width="100%"></div></div>';
                        }
                        searchHtml += tempHtml;
                        break;
                    case 50:
                    case 51:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 mydropdown pdt5" data-propertyname="' + queryItem.PropertyName + '" data-boschemacode="' + queryItem.AssociationSchemaCode + '"></div>';
                        break;
                }
                searchHtml += ((showCount % 2 || showCount === len - 1) != 0 ? "</div>" : "");
                showCount++;
            }
            this.$searchForm.append(searchHtml);

            this.$searchForm.find(".mycombobox").each(function () {
                var $combobox = $(this);
                var schemacode = $combobox.attr("data-schemaCode");
                var datafield = $combobox.attr("data-dataField");
                var defaultvalue = $combobox.attr("data-defalutvalue");
                var mycombobox = $combobox.FormComboBox({
                    SchemaCode: schemacode, DataField: datafield, DefaultValue: defaultvalue, Width: "50%",
                    OnChange: function () {
                        that._refreshTable(0);
                    },
                });
            });


            this.$searchForm.find(".mycombobox").removeClass("form-group");

            this.$searchForm.find(".mycomboboxlist").each(function () {
                var $combobox = $(this);
                var schemacode = $combobox.attr("data-schemaCode");
                var datafield = $combobox.attr("data-dataField");
                var defaultvalue = $combobox.attr("data-defalutvalue");
                var mycomboboxlist = $combobox.FormComboBoxList({
                    Width: "50%",
                    OnChange: function () {
                        that._refreshTable(0);
                    },
                });
            });
            this.$searchForm.find(".mycomboboxlist").removeClass("form-group");


            // 统一初始化datetimepicker
            this.$searchForm.find(".mydatetimepicker").each(function () {
                var $picker = $(this);
                var minView = 2;
                var startView = 2;
                var mode = $picker.attr("data-datetimemode");
                if (!mode) {
                    mode = "yyyy-mm-dd";
                }
                if (mode == "yyyy-mm-dd hh:ii") {
                    minView = 0;
                }
                $picker.datetimepicker({
                    language: 'zh-CN',
                    format: mode,
                    todayBtn: true,
                    container: $picker.closest(".modal-dialog"),
                    autoclose: true,
                    startView: startView, // 选择器打开后首先显示的视图
                    minView: minView// 选择器能够提供的最精确的视图
                }).on("changeDate", function () {
                    that._refreshTable(0);
                });;
            });
            // 统一初始化选人控件
            var $myuserpicker = this.$searchForm.find(".myuserpicker");

            if (!$.isEmptyObject($myuserpicker)) {
                for (var r = 0; r < $myuserpicker.length; r++) {
                    var tempSheetUser = $($myuserpicker[r]).FormMultiUser({ IsQueryControl: true });
                    tempSheetUser.OnChange = function () {
                        that._refreshTable(0);
                    }
                }
            }

            this.$searchForm.find(".myuserpicker").removeClass("form-group");
            this.$searchForm.find(".mymultiselect").each(function () {
                $(this).multiselect({
                    enableFiltering: true,
                    filterPlaceholder: '搜索',
                    buttonText: function (options, select) {
                        if (options.length === 0) {
                            return "";
                        }
                        else {
                            var labels = [];
                            options.each(function () {
                                if ($(this).attr("label") !== void 0) {
                                    labels.push($(this).attr("label"));
                                }
                                else {
                                    labels.push($(this).html());
                                }
                            });
                            return labels.join(",") + "";
                        }
                    },
                    onChange: function () {
                        //that._refreshTable();
                    },
                    onDropdownShow: function () {
                        //点击时选人控件隐藏
                        $("div[data-FormMultiUserPanel='SelectorPanel'],div[data-FormUserPanel='SelectorPanel'],div[data-formmultiuserpanel='searchdiv']").hide();
                        $(".form-query-dropdown").hide();
                    },
                    selectedClass: "multiselect-selected"
                });
            });
            // 下拉搜索自动获取焦点
            $(".dropdown-toggle").on('click', function () {
                var that = this;
                setTimeout(function () {
                    $(that).next().find("input.multiselect-search").focus();
                }, 200);
            });
            // 统一初始化关联查询控件
            this.$searchForm.find(".mydropdown").each(function () {
                var myquery = $(this).FormMultiQuery();
                myquery.IsQueryControl = true;
                myquery.OnChange = function () {
                    that._refreshTable(0);
                }
            });
            this.$searchForm.find(".mydropdown").removeClass("form-group");


            this.$searchForm.find("input[type='text']").blur(function () {
                //有下拉选项中在ValChange触发刷新数据
                if (!$(this).hasClass("comboboxtext")) {
                    that._refreshTable(0);
                }
            }).keydown(function (e) {
                if (e.which == 13) {
                    that._refreshTable(0);
                }
            });

            this.$searchForm.find("input[type='checkbox']").change(function () {
                that._refreshTable(0);
            });

            /***********************************关联查询默认查询 Begin***********************************/
            //格式化日期
            var formatDate = function (date) {
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                var day = date.getDate();
                return year + '-' + (month < 10 ? ('0' + month) : month) + '-' + (day < 10 ? ('0' + day) : day);
            };
            //当天
            var thisDay = function () {
                var date = new Date();
                date = formatDate(date);
                return date + ';' + date;
            };
            //本周
            var thisWeek = function () {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var day = date.getDate();
                var dayOfWeek = date.getDay();
                var start = new Date(year, month, day - dayOfWeek);
                start = formatDate(start);
                var end = new Date(year, month, day + (6 - dayOfWeek));
                end = formatDate(end);
                return start + ';' + end;
            };
            //本月
            var thisMonth = function () {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var start = new Date(year, month, 1);
                start = formatDate(start);
                var end = new Date(year, month + 1, 0);
                end = formatDate(end);
                return start + ';' + end;
            };
            //本季度
            var thisQuarter = function () {
                var startMonth = 0;
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                if (month < 3) {
                    startMonth = 0;
                } else if (month > 2 && month < 6) {
                    startMonth = 3;
                } else if (month > 5 && month < 9) {
                    startMonth = 6;
                } else if (month > 8) {
                    startMonth = 9;
                }
                var start = new Date(year, startMonth, 1);
                var end = new Date(year, startMonth + 3, 0);
                start = formatDate(start);
                end = formatDate(end);
                return start + ';' + end;
            };
            //本年度
            var thisYear = function () {
                var date = new Date();
                var year = date.getFullYear();
                var start = new Date(year, 0, 1);
                var end = new Date(year, 12, 0);
                start = formatDate(start);
                end = formatDate(end);
                return start + ';' + end;
            };
            //设置默认查询值
            //下面这段代码主要是用于关联查询中设置默认值的列表
            var searchParams = {
            };
            for (var i = 0; i < queryItems.length; i++) {
                var item = queryItems[i];
                if (item.DataType == 5) {
                    //datetime
                    var filterValue = parseInt(item.FilterValue);
                    switch (filterValue) {
                        case 1://当天
                            searchParams[item.PropertyName] = thisDay();
                            break;
                        case 2://本周
                            searchParams[item.PropertyName] = thisWeek();
                            break;
                        case 3://本月
                            searchParams[item.PropertyName] = thisMonth();
                            break;
                        case 4://本季度
                            searchParams[item.PropertyName] = thisQuarter();
                            break;
                        case 5://本年度
                            searchParams[item.PropertyName] = thisYear();
                            break;
                        default:
                            break;
                    }
                } else if (item.DataType == 26) {
                    var filterValue = parseInt(item.FilterValue);
                    var organizationType = parseInt(item.OrganizationType);
                    var defaultValue = queryDefaultValues[item.PropertyName];
                    switch (filterValue) {
                        case 1://本人
                            searchParams[item.PropertyName] = defaultValue + ";" + organizationType;
                            break;
                        case 2://本部门
                            searchParams[item.PropertyName] = defaultValue + ";" + organizationType;
                            break;
                        default:
                            break;
                    }
                }
                else {
                    //searchParams[queryItems[i].PropertyName] = queryItems[i].DefaultValue;
                    searchParams[queryItems[i].PropertyName] = queryDefaultValues[queryItems[i].PropertyName];
                }
            }
            var $divSearch = this.$searchForm;

            //单选、多选、下拉
            var myMultiSelect = $divSearch.find(".mymultiselect");
            for (var i = 0; i < myMultiSelect.length; i++) {
                var $property = $(myMultiSelect[i]);
                var propertyName = $property.attr("id");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    //$property.multiselect("select", propertyVal.split(";"));
                    $property.multiselect("select", propertyVal);
                }
            }
            // 文本
            var myText = $divSearch.find(".mytext");
            for (var i = 0; i < myText.length; i++) {
                var $property = $(myText[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    $property.val(propertyVal);
                }
            }
            // 选人
            var myUserPicker = $divSearch.find(".myuserpicker");
            for (var i = 0; i < myUserPicker.length; i++) {
                var $property = $(myUserPicker[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var arr = propertyVal.split(';');
                    var $ctrl = $property.FormMultiUser();//.SetValue(arr[0]);

                    $ctrl.SetValue(arr[0]);
                    if (parseInt(arr[1]) == 0) {
                        //人员可选
                        $($ctrl.Element).find('li[data-tabtype="tab_Deps"]').remove();
                    } else if (parseInt(arr[1]) == 1) {
                        //部门可选
                        $($ctrl.Element).find('li[data-tabtype="tab_Users"]').remove();
                    }
                }
            }
            // 数字
            var myNum = $divSearch.find(".mynum");
            for (var i = 0; i < myNum.length; i++) {
                var $property = $(myNum[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    //var defaultValue = propertyVal;
                    var valArr = propertyVal;//.split(";");
                    for (var i = 0; i < valArr.length; i++) {
                        if (!$.isNumeric(valArr[i])) {
                            continue;
                        }
                        $property.find("input:text").eq(i).val(valArr[i]);
                    }
                }
            }
            //是/否
            var myCheckBox = $divSearch.find('.mycheckbox');
            for (var i = 0; i < myCheckBox.length; i++) {
                var $property = $(myCheckBox[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal != undefined && propertyVal != null && propertyVal != "") {
                    if (propertyVal) {
                        $property.find("input[value='true']").prop("checked", "true");
                    }
                    else {
                        $property.find("input[value='false']").prop("checked", "true");
                    }
                }
            }
            //datetime
            var myDateTime = $divSearch.find(".mydatetime");
            for (var i = 0; i < myDateTime.length; i++) {
                var $property = $(myDateTime[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var days = propertyVal.split(';');
                    var picker = $property.find(".mydatetimepicker");
                    for (var j = 0; j < picker.length; j++) {
                        $(picker[j]).val(days[j]);
                    }
                }
            }
            // FormQuery
            var myDropDown = $divSearch.find(".mydropdown");
            for (var i = 0; i < myDropDown.length; i++) {
                var $property = $(myDropDown[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var formQuery = $property.FormMultiQuery();
                    formQuery.SetValue(propertyVal);
                }
            }
            /***********************************关联查询默认查询 End***********************************/



            var $btnSearch = this.$toolbar.find(".btnSearch");
            $btnSearch.removeClass("hide");
            $btnSearch.click(function () {
                that._refreshTable();
                return false;
            });
            // 查询条件展开or收起
            var $btnToggle = this.$partingLine.find(".btnToggle");
            $btnToggle.removeClass("hide");
            $btnToggle.click(function () {
                if ($(this).hasClass("btn-up")) {
                    $(this).removeClass("btn-up").addClass("btn-down").removeClass("icon-arrow-up-double-b").addClass("icon-arrow-down-double-b");
                    //$(this).html("<i class='fa icon-arrow-down-double'></i>");
                    that.$searchForm.find("div.form-group:gt(1)").hide();
                }
                else {
                    $(this).removeClass("btn-down").addClass("btn-up").removeClass("icon-arrow-down-double-b").addClass("icon-arrow-up-double-b");

                    that.$searchForm.find("div.form-group").show();
                }
                return false;
            });

            // 查询条件多于2行时默认触发收起
            var seachRowCount = this.$searchForm.find("div.form-group").length;
            if (seachRowCount > 2) {
                $btnToggle.trigger("click");
            }
            else { // 查询条件少于3行时，隐藏收起按钮
                //$btnToggle.hide();
                this.$partingLine.hide();

                // 没有查询条件时，隐藏查询按钮
                if (seachRowCount === 0) {
                    $btnSearch.hide();
                }
            }

            this.SearchInitialized = true;
        },

        _initTable: function (queryColumns) {
            var that = this;
            var columns = [];
            if (queryColumns) {
                //添加一个checkbox列
                columns.push({
                    field: 'checkcolumn',
                    title: '',
                    visible: true,
                    checkbox: true,
                    clickToSelect: true
                });

                var tempColumnList = [];
                var childSchema = []; //子表
                for (var key in queryColumns) {
                    if (queryColumns[key].ChildColumns) {
                        childSchema.push(queryColumns[key]);
                    } else {
                        tempColumnList.push(queryColumns[key]);
                    }
                }
                //添加完主表字段后再添加子表字段
                if (childSchema.length > 0) {
                    for (var i = 0; i < childSchema.length; i++) {
                        var chidColumns = childSchema[i].ChildColumns;
                        var key = childSchema[i].Code;
                        for (var childKey in chidColumns) {
                            chidColumns[childKey].Code = chidColumns[childKey].Code.indexOf(".") > -1 ?
                                chidColumns[childKey].Code :
                                key + "." + chidColumns[childKey].Code;
                            tempColumnList.push(chidColumns[childKey]);
                        }
                    }
                }

                for (var i = 0, len = tempColumnList.length; i < len; i++) {
                    var queryColumn = tempColumnList[i];
                    columns.push({
                        field: queryColumn["Code"],
                        title: queryColumn["DisplayName"],
                        visible: queryColumn["Visible"],
                        formatter: function (value, row, index, field) {
                            if (value != null && value.constructor == Object) {
                                if (value.IsCustom != null) {
                                    value = value.Value;
                                } else if (value.Color != null) {
                                    return "<span style='padding: 5px 15px 5px 15px;border-radius:4px; color:#fff;background-color:" + value.Color.toString() + ";'>" + value.Value + "</span>";
                                }
                            }
                            if (value != null && value.constructor == String && (value.indexOf("<") || value.indexOf(">"))) {
                                value = value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                            }
                            // if (field == OwnerDeptId_Name) {
                            //     return value;
                            // }
                            if (value == null || $.trim(value.toString()) == "") value = "--";
                            return value;
                        }
                    });
                }
            }

            that.TableAllColumns = columns;
            // 关联查询只显示审批通过的记录
            this.$table.bootstrapTable('destroy');
            var queryparams = {
                ActionName: "DoAction",
                Command: "Load",
                QueryCode: this.BOSchemaCode,
                Status: 1,
                SheetQuery: 1,
                //isFormControl: true,
                ListScene: 2,//列表场景，1表示普通列表，2表示弹窗内列表
                SheetCode: this.SchemaCode,
                DataField: this.DataField,
                SheetData: JSON.stringify(this.SheetData),
                scopeType: 3
            }

            var bootstrapTableOptions = {
                method: "post",
                // 添加SheetQuery标识，让关联查询只以列表展现
                //这里传入scopeType为OwnAndOwnDept。如果不传入默认权限为own
                url: axios.defaults.baseURL + "/act/app/appRunPage",
                // clickToSelect:true,
                cache: false,
                striped: false,
                sidePagination: "server",
                pagination: true,
                pageSize: 10,
                contentType: "application/x-www-form-urlencoded",
                pageList: [10, 20, 50],
                columns: columns,
                idField: "ObjectId",
                sortName: "",
                sortOrder: "",
                TargetId: that.Table_ID,
                queryParams: function (params) {
                    var param = that._formatQueryParams(params, that);
                    param["QueryCode"] = that.BOSchemaCode;
                    param["SheetData"] = JSON.stringify(that.SheetData);
                    param["DataField"] = that.DataField;
                    param["SheetCode"] = that.SchemaCode;
                    param["isAssociateForm"] = 1
                    return param;
                },
                onLoadSuccess: function (data) {
                    that.LoadData = data;
                    that.$table.find("tbody > tr").css({
                        "cursor": "pointer"
                    });
                    that.$table.find("th")
                    that.TableInitialized = true;

                    //不固定表头时需要给table指定高度，
                    if (that.FixedTableHeader == false) {
                        //高度调整到220,防止弹出框时确定按钮到屏幕之外
                        that.$table.closest('.fixed-table-body').css({ "height": "180px", "overflow": "auto" });
                    }
                    setTimeout(function () {
                        var fixedTableHeader = that.$table.closest(".fixed-table-container").find(".fixed-table-header");
                        if (fixedTableHeader) {
                            if (fixedTableHeader.find(".tr-colspan").length > 0) {
                                that.$modal.find("div.table-page").css("margin-top", "88px");
                            }
                            fixedTableHeader.removeAttr("style");
                        }
                    }, 100);

                    //设置选中行
                    that._setRowChecked();
                },
                onCheck: function (row, $element) {
                    that._checkRows(row);
                },
                onCheckAll: function (rows) {
                    that._checkRows(rows);
                },
                onUncheck: function (row, $element) {
                    that._unCheckRows(row);
                },
                onUncheckAll: function (rows) {
                    that._unCheckRows(rows);
                },
                onClickRow: function (row, $element) {
                    return;
                },
                responseHandler: function (params) {
                    if (params.ReturnData === null) params.ReturnData = new Array();
                    that.RenderPage.call(this, params);
                    return {
                        rows: params.ReturnData, total: params.DataCount
                    };
                },
                onAll: function () {
                }
            };
            if (that.FixedTableHeader == undefined || that.FixedTableHeader == true) {
                bootstrapTableOptions.height = 180;
            }

            this.$table.bootstrapTable(bootstrapTableOptions);
            that._setColumnColspan(columns);

            this.$table.off("mouseenter.list").on("mouseenter.list", 'td', function () {
                var $tableTip = $(".table-tip"), $TextLabel = $(".TextLabel");
                $tableTip.length == 0 && ($tableTip = $('<div class="table-tip" style="display: none;"></div>').appendTo(that.CurrentBody)); //.appendTo($("body")));
                $TextLabel.length == 0 && ($TextLabel = $('<label class="TextLabel" style="display: none; opacity:0; position:fixed;"></label>').appendTo(that.CurrentBody));//.appendTo($("body")));
                var $that = $(this);
                $TextLabel.text($that.text());
                if ($TextLabel.width() > $that.width()) {
                    var offset = $that.offset();
                    $tableTip.text($that.text()).css({
                        left: offset.left + ($that.outerWidth() - $tableTip.outerWidth()) / 2 - $(window).scrollLeft(), bottom: $(window).height() - offset.top + 6 + $(window).scrollTop()
                    }).show();
                }
            });

            this.$table.off("mouseleave.list").on("mouseleave.list", 'td', function () {
                $(".table-tip").hide();
                return false;
            });
        },
        //设置行选中
        _setRowChecked: function () {
            var that = this;
            if (that.SelectedItems.length == 0) {
                return;
            }
            //如果checkedrows中有selecteditems则不要添加
            var checkedRows = [];

            for (var i = 0; i < that.CheckedRows.length; i++) {
                checkedRows.push(that.CheckedRows[i].ObjectId);
            }
            for (var i = 0; i < that.SelectedItems.length; i++) {
                if ($.inArray(that.SelectedItems[i].ObjectId, checkedRows) == -1) {
                    that.CheckedRows.push(that.SelectedItems[i]);
                }
            }


            var data = that.$table.bootstrapTable('getData', true);
            if (that.associateChildSchema == undefined) {
                that.associateChildSchema = false;
                if (data && data.length > 0) {
                    for (var key in data[0]) {
                        if (key.indexOf('.ObjectId') > -1) {
                            that.associateChildSchema = true;
                            break;
                        }
                    }
                }
            }
            var objectIdStr = 'ObjectId';
            if (that.associateChildSchema) {
                objectIdStr = that.BOSchemaCode + '.ObjectId';
            }
            var childSchemaObjectId = undefined;
            for (var i = 0; i < data.length; i++) {
                for (var j = 0; j < that.SelectedItems.length; j++) {
                    if (data[i][objectIdStr] == that.CheckedRows[j].ObjectId) {
                        that.$table.bootstrapTable('check', i);
                        break;
                    }
                }
            }

            //设置选中行
            if (that.CheckedRows.length == 0)
                return;
            var data = that.$table.bootstrapTable('getData', true);
            var childSchemaObjectId = undefined;
            if (data.length > 0) {
                if (that.associateChildSchema == true) {
                    childSchemaObjectId = that.BOSchemaCode + '.ObjectId';
                } else if (that.associateChildSchema == undefined) {
                    for (var key in data[0]) {
                        if (key.toLowerCase().indexOf(".objectid") > -1) {
                            childSchemaObjectId = key;
                            break;
                        }
                    }
                }
            }
            for (var i = 0; i < data.length; i++) {
                for (var j = 0; j < that.CheckedRows.length; j++) {
                    if (childSchemaObjectId != undefined) {
                        if (data[i][childSchemaObjectId] == that.CheckedRows[j][childSchemaObjectId]) {
                            that.$table.bootstrapTable('check', i);
                            break;
                        }
                    } else {
                        if (data[i].ObjectId == that.CheckedRows[j].ObjectId) {
                            that.$table.bootstrapTable('check', i);
                            break;
                        }
                    }
                }
            }
        },
        _refreshTable: function (pageNumber) {
            //重置pageNumber到第一页
            if (pageNumber != void 0 || !isNaN(pageNumber)) {
                this.$table.bootstrapTable("refreshOptions", { pageNumber: 1 });
            }
            this.$table.bootstrapTable("refresh");
        },

        // 添加查询条件
        _formatQueryParams: function (params) {
            var searchParams = {
            };
            var $divSearch = this.$searchForm;

            var myMultiSelect = $divSearch.find(".mymultiselect");
            for (var i = 0; i < myMultiSelect.length; i++) {
                var v = [];
                var $multiSelect = $(myMultiSelect[i]);
                var selectedText = $multiSelect.parent().find(".multiselect-selected-text").text();
                if (selectedText) {
                    v = selectedText.split(/,|，|；|;/); //支持中文逗号
                }
                if (v.length > 0) {
                    for (var j = 0; j < v.length; j++) {
                        v[j] = $.trim(v[j]);
                    }
                    searchParams[$multiSelect.attr("id")] = v;
                }
            }
            // 文本
            var myText = $divSearch.find(".mytext");
            for (var i = 0; i < myText.length; i++) {
                var $text = $(myText[i]);
                var v = $.trim($text.val());
                if (v !== "") {
                    if (v.indexOf(",") > -1 || v.indexOf("，") > -1) {
                        v = v.split(/,|，|;|；/);
                        if (v.length > 0) {
                            for (var j = 0; j < v.length; j++) {
                                v[j] = $.trim(v[j]);
                                if (v[j] == "--")//未填写，空白值项
                                {
                                    v[j] = "";
                                }
                            }
                            searchParams[$text.attr("data-propertyname")] = v;
                        }
                    }
                    else if (v.indexOf("；") > -1 || v.indexOf(";") > -1) {
                        v = v.split(/;|；/);
                        if (v.length > 0) {
                            for (var j = 0; j < v.length; j++) {
                                v[j] = $.trim(v[j]);
                                if (v[j] == "--")//未填写，空白值项
                                {
                                    v[j] = "";
                                }
                            }
                            searchParams[$text.attr("data-propertyname")] = v;
                        }
                    }
                    else {
                        if ($.trim(v) == "--") {
                            searchParams[$text.attr("data-propertyname")] = [""];
                        }
                        else {
                            searchParams[$text.attr("data-propertyname")] = [v];
                        }

                    }
                }
            }
            // 选人
            var myUserPicker = $divSearch.find(".myuserpicker");
            for (var i = 0; i < myUserPicker.length; i++) {
                var $picker = $(myUserPicker[i]);
                var v = $picker.FormMultiUser().GetUnitIDs();
                if (v && v.length > 0) {
                    searchParams[$picker.attr("data-propertyname")] = v;
                }
            }
            // 数字
            var myNum = $divSearch.find(".mynum");
            for (var i = 0; i < myNum.length; i++) {
                var $myNum = $(myNum[i]);
                var v = [];
                var num = $myNum.find(":text");
                for (var j = 0; j < num.length; j++) {
                    var $num = $(num[j]);
                    var val = $num.val();
                    if ($.isNumeric(val)) {
                        v.push(val);
                    } else {
                        v.push(null);
                    }
                }
                if (v.length > 0) {
                    searchParams[$myNum.attr("data-propertyname")] = v;
                }
            }
            //是/否
            var myCheckBox = $divSearch.find('.mycheckbox');
            for (var i = 0; i < myCheckBox.length; i++) {
                var $myCheckBox = $(myCheckBox[i]);
                var v = [];
                var val = $myCheckBox.find('input[type="checkbox"]:checked').val();
                v.push(val);
                searchParams[$myCheckBox.attr('data-propertyname')] = v;
            }
            // datetime
            var myDateTime = $divSearch.find(".mydatetime");
            for (var i = 0; i < myDateTime.length; i++) {
                var $myDateTime = $(myDateTime[i]);
                var v = [];
                var myDateTimePicker = $myDateTime.find(".mydatetimepicker");
                for (var j = 0; j < myDateTimePicker.length; j++) {
                    var $myDateTimePicker = $(myDateTimePicker[j]);
                    var val = $myDateTimePicker.val();
                    if ($.trim(val) !== "") {
                        v.push(val);
                    } else {
                        v.push(null);
                    }
                }
                if (v.length > 0) {
                    searchParams[$myDateTime.attr("data-propertyname")] = v;
                }
            }

            // FormQuery
            var myDropDown = $divSearch.find(".mydropdown");
            for (var i = 0; i < myDropDown.length; i++) {
                var $mydropdown = $(myDropDown[i]);
                var v = $mydropdown.FormMultiQuery().GetValue();
                //多个关联表单中间用;隔开
                var arr = [];
                if (!$.isArray(v)) {
                    if (v && v.length > 0) {
                        v = v.split(';');
                        for (var i = 0; i < v.length; i++) {
                            if (v[i] == undefined || v[i] == 'undefined') {
                                arr.push('');
                            } else if (v[i] != '') {
                                arr.push(v[i]);
                            }
                        }
                        searchParams[$mydropdown.attr("data-propertyname")] = arr;
                    }
                } else {
                    //替换掉undefined
                    for (var j = 0; j < v.length; j++) {
                        if (v[j] == undefined || v[j] == 'undefined') {
                            arr.push('');
                        } else if (v[j] != '') {
                            arr.push(v[j]);
                        }
                    }
                    searchParams[$mydropdown.attr("data-propertyname")] = arr;
                }
            }
            if (searchParams.Name && searchParams.Name.length > 0) {
                params["nameSchema"] = searchParams.Name[0];
            }
            if (searchParams["CreatedTime"][0]) {
                params["startTime"] = Number(new Date(searchParams["CreatedTime"][0]))
            }
            if (searchParams["CreatedTime"][1]) {
                params["endTime"] = Number(new Date(searchParams["CreatedTime"][1])) + 24 * 60 * 60 * 1000
            }
            return params;
        },

        _getQueryParams: function () {
            var queryParams = {
            };
            if (this.InputMappings) {
                for (var datafield in this.InputMappings) {
                    // 根据datafield，从页面上取值
                    var controlManager = this._getTargetElement(datafield).JControl();
                    if (controlManager) {
                        queryParams[this.InputMappings[datafield]] = controlManager.GetValue();
                    }
                }
            }
            return queryParams;
        },

        _getTargetElement: function (datafield) {
            var $targetElement;
            var dataFieldName = $.ControlManager.PreDataKey + $.ControlManager.DataFieldKey;
            // 子表字段，通过datafield在当前行中找
            if (datafield.indexOf(".") > -1) {
                $targetElement = this.$InputBody.closest("tr").find("[" + dataFieldName + "='" + datafield + "']")
            }
            else {
                $targetElement = $("[" + dataFieldName + "='" + datafield + "']");
            }
            return $targetElement;
        },
        //重写DetailLink
        //link是文本框中总内容
        _toItemLink: function (link) {
            var that = this;
            var $newLink = $(link);

            if (that.Editable) {
                //可编辑状态绑定i的删除事件
                $newLink.find('i').on('click', function () {
                    var objectId = $(this).data('objectid');
                    var objectIds = that.$Input.data("ObjectId").split(";");
                    var newObjectIds = [];
                    for (var i = 0; i < objectIds.length; i++) {
                        if (objectIds[i] != objectId && objectIds[i] != "") {
                            newObjectIds.push(objectIds[i]);
                        }
                    }
                    $(this).parent('a').remove();
                    that.$Input.data("ObjectId", newObjectIds.join(";"));
                    that.OnChange(newObjectIds);
                });
            } else {
                //不可编辑状态改变标签样式并绑定点击事件
                $newLink = $newLink.removeClass("label label-info").css({
                    "border": "none",
                    "white-space": "pre-wrap",
                    "white-space": "-moz-pre-wrap",
                    "white-space": "-pre-wrap",
                    "white-space": "-o-pre-wrap",
                    "word-wrap": "break-word",
                    "overflow": "auto",
                    "word-break": "break-all"
                });
                var inputText = this.$Input.text();
                $newLink.find("i").remove();
                $newLink.on("click", function () {
                    var objectId = $(this).data('objectid');
                    var boId = that.GetValue();
                    if (objectId) {
                        HTTP.getBizObjectSchemaDisplayName(that.BOSchemaCode).then((data) => {
                            if (data.code == 0) {
                                let instance = Modal.newInstance({
                                    //scrollable:true,
                                    okText: '关闭',
                                    title: inputText,
                                    footerHide: true,
                                    render: (h) => {
                                        return h(assoModal, {
                                            props: {
                                                code: boId
                                            },
                                            on: {

                                            }
                                        })
                                    }
                                })
                                var options = { icon: "info", showCancel: false, width: "800px" };
                                options.onRemove = function () {
                                    instance = null;
                                };
                                instance.show(options);


                            }
                        })
                        // that.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                        //     var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&BizObjectId=" + objectId + "&Mode=View";
                        //     $.ISideModal.Show(url, data.ReturnData.DisplayName);
                        // });
                    }
                });
            }
            return $newLink;
        },

        RenderPage: function (data) {
            var that = this;
            var $target = $("#" + that["TargetId"]);
            if (!$target) return;
            if (that.pageNumber > 1 && data && data.length == 0) {
                $target.bootstrapTable("refreshOptions", {
                    pageNumber: that.pageNumber - 1
                });
            }
            if (!that.$PageNext) {
                var $pageBar = $("#bar-" + that["TargetId"]);
                that.$PageNext = $pageBar.find(".Page_Num_Next");
                that.$PagePre = $pageBar.find(".Page_Num_Pre");
                that.$PageIndex = $pageBar.find(".Page_Index");
                that.$PageCount = $pageBar.find(".Page_Count");
                that.$PageTotal = $pageBar.find(".page-total");
                that.$PageSize = $pageBar.find(".Page_Per_Size");
                that.$PageNext.bind('click', function () {
                    $target.bootstrapTable("nextPage");
                });
                that.$PagePre.bind('click', function () {
                    $target.bootstrapTable("prevPage");
                });

                var PageTimeout;
                that.$PageIndex.bind("keyup", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val().replace(/[^\d]/g, '');
                    v = v == "" ? 0 : parseInt(v);
                    v = v >= that.Count ? that.Count : v;
                    if (v == 0) return;
                    $(this).val(v);
                    PageTimeout = setTimeout(function () {
                        v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                        PageTimeout = null;
                    }, 600);
                });
                that.$PageIndex.bind("blur", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val();
                    v = v == "" || v == "0" ? 1 : parseInt(v);
                    $(this).val(v);
                    v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                });
                $pageBar.on("click", "li>a", function () {
                    var size = parseInt($(this).text());
                    that.$PageSize.html(size);
                    $target.bootstrapTable("refreshOptions", {
                        pageSize: size
                    });

                })
            }
            if (!data) {
                that.$PageNext.addClass("disable").attr("disabled", true);
                that.$PagePre.addClass("disable").attr("disabled", true);
                that.$PageIndex.val(1).attr("disabled", true);
                that.$PageCount.html(1);
                that.$PageTotal.html("共0条");
            }
            else {
                that.$PageIndex.val(that.pageNumber);
                that.Count = Math.ceil(data.Result.Count / that.pageSize);
                that.$PageCount.html(that.Count);
                that.$PageTotal.html("共" + data.Result.Count + "条");
                if (that.pageNumber <= 1) {
                    that.$PagePre.addClass("disable").attr("disabled", true);
                }
                else {
                    that.$PagePre.removeClass("disable").attr("disabled", false);
                }

                if (that.pageNumber == that.Count) {
                    that.$PageNext.addClass("disable").attr("disabled", true);
                }
                else {
                    that.$PageNext.removeClass("disable").attr("disabled", false);
                }
            }
        },

        //设置值
        InitValue: function () {
            var item = this.Value || this.DefaultValue;
            if (item != void 0) {
                this.SetValue(item, true);
            }
        },

        //设置值
        SetValue: function (item, asy) {
            //item可以是string或者数组
            if (item == void 0 || item == null || item == "") {
                this.$Input.text("");
                this.$Input.data("ObjectId", "");
                return;
            }
            var that = this;
            //把item转成数组
            (item.constructor == String) && (item = item.replace(/,/g, ';').split(";"));
            if (item.constructor == Object && item.ObjectId != undefined) {
                item = item.ObjectId;
            }
            if (item.constructor == String) {
                //传入单个值
                var name = "";
                if ($.SmartForm.ResponseContext && $.SmartForm.ResponseContext.AssociatedBoNames &&
                    $.SmartForm.ResponseContext.AssociatedBoNames[item]) {
                    name = $.SmartForm.ResponseContext.AssociatedBoNames[item].replace(/</g, "&lt;").replace(/>/g, "&gt;");
                }
                if ($.trim(name) == '') {
                    var params = {
                        SheetCode: that.BOSchemaCode,
                        ObjectId: item
                    };
                    HTTP.listViewData(params).then((data) => {
                        if (data.code == 0) {

                            if (data.datas != void 0 && data.datas.length > 0) {
                                name = $.trim(data.datas[0].Name);
                            }
                            if ($.trim(name) == '') {
                                name = '--';
                            }
                            var title = name;
                            if (!that.Editable && that.IsInGridView) {
                                title = "";
                            }
                            var link = '<a href="javascript:;" class="label label-info" title="' + title + '" data-objectId="' + item + '">' + name + '<i class="fa icon-close-middle" style="margin-left:5px" data-objectId="' + item + '"></i></a>';
                            link = that._toItemLink(link);
                            that.$Input.append(link).data("ObjectId", item);
                            that.OnChange({
                                ObjectId: item, Name: name
                            });

                            that.LoadData = data.ReturnData.ListViewData;
                            that._bindDataToDropDown(needClear, that.LoadData);
                        } else {
                            Message.error({
                                content: "获取的关联信息错误" + data.msg,
                                duration: 3
                            });
                        }
                    })

                    // that.Ajax("/Form/OnAction", "POST", { PostData: JSON.stringify(params) }, function (data) {
                    //     if (data.ReturnData.ListViewData != void 0 && data.ReturnData.ListViewData.length > 0) {
                    //         name = $.trim(data.ReturnData.ListViewData[0].Name);
                    //     }
                    //     if ($.trim(name) == '') {
                    //         name = '--';
                    //     }
                    //     var title = name;
                    //     if (!that.Editable && that.IsInGridView) {
                    //         title = "";
                    //     }
                    //     var link = '<a href="javascript:;" class="label label-info" title="' + title + '" data-objectId="' + item + '">' + name + '<i class="fa icon-close-middle" style="margin-left:5px" data-objectId="' + item + '"></i></a>';
                    //     link = that._toItemLink(link);
                    //     that.$Input.append(link).data("ObjectId", item);
                    //     that.OnChange({
                    //         ObjectId: item, Name: name
                    //     });
                    // }, asy);
                } else {
                    var title = name;
                    if (!that.Editable && that.IsInGridView) {
                        title = "";
                    }
                    var link = '<a href="javascript:;" class="label label-info" title="' + title + '" data-objectId="' + item + '">' + name + '<i class="fa icon-close-middle" style="margin-left:5px" data-objectId="' + item + '"></i></a>';
                    link = that._toItemLink(link);
                    that.$Input.append(link).data("ObjectId", item);
                    that.OnChange({
                        ObjectId: item, Name: name
                    });
                }
            } else if (item.constructor == Array) {
                //传入多个值
                var objectIds = "";
                var appRunList = '';
                var inputText = this.$Input.text();
                if (item.length > 0 && item[0].indexOf('[') >= 0) {
                    for (var i = 0; i < item.length - 1; i++) {
                        objectIds += item[i] + ','
                    }
                    if (item.length >= 1) {
                        objectIds += item[item.length - 1];
                    }
                    try {
                        var value = JSON.parse(objectIds);
                        value.forEach((data) => {
                            appRunList += data + ';'
                        })
                    }
                    catch (e) {
                        return;
                    }
                }
                else {
                    for (var i = 0; i < item.length; i++) {
                        appRunList += item[i] + ';'
                    }
                }
                var params = {
                    ActionName: "GetFormatBizObject123",
                    SchemaCode: "123",
                    ObjectId: appRunList
                };

                HTTP.listViewData(params).then((data) => {
                    if (data.ReturnData.ListViewData != void 0 && data.ReturnData.ListViewData.length > 0) {
                        var retData = data.ReturnData.ListViewData;
                        var objectIds = [];
                        var link = '';
                        var isAssociateChild = false;
                        for (var key in retData[0]) {
                            if (key.toLocaleLowerCase().indexOf('.objectid') > -1) {
                                isAssociateChild = true;
                                break;
                            }
                        }
                        for (var i = 0; i < retData.length; i++) {
                            var objectId = isAssociateChild ? retData[i][that.BOSchemaCode + ".ObjectId"] : retData[i].ObjectId;
                            var name = (isAssociateChild ? retData[i][that.BOSchemaCode + ".Name"] : retData[i].Name) || '--';
                            if ($.trim(name) == "") {
                                name = "--";
                            }
                            var title = name;
                            if (!that.Editable && that.IsInGridView) {
                                title = "";
                            }
                            link += '<a href="javascript:;" class="label label-info" title="' + title + '" data-objectId="' + objectId + '">' + name + '<i class="fa icon-close-middle" style="margin-left:5px" data-objectId="' + objectId + '"></i></a>';
                            if (!that.Editable) {
                                link += ";";//非编辑状态用";"分割
                            }
                            objectIds.push(objectId);
                        }
                        var newLink = $(link);
                        if (that.Editable) {
                            //可编辑状态绑定i的删除事件
                            newLink.find('i').on('click', function () {
                                var objectId = $(this).data('objectid');
                                var objectIds = that.$Input.data("ObjectId").split(";");
                                var newObjectIds = [];
                                for (var i = 0; i < objectIds.length; i++) {
                                    if (objectIds[i] != objectId && objectIds[i] != "") {
                                        newObjectIds.push(objectIds[i]);
                                    }
                                }
                                $(this).parent('a').remove();
                                that.$Input.data("ObjectId", newObjectIds.join(";"));
                                that.OnChange(newObjectIds);
                            });
                        } else {
                            //不可编辑状态改变标签样式并绑定点击事件
                            newLink = $(link).removeClass("label label-info").css({
                                "border": "none",
                                "white-space": "pre-wrap",
                                "white-space": "-moz-pre-wrap",
                                "white-space": "-pre-wrap",
                                "white-space": "-o-pre-wrap",
                                "word-wrap": "break-word",
                                "overflow": "auto",
                                "word-break": "break-all"
                            });
                            newLink.find("i").remove();
                            newLink.on("click", function () {
                                var objectId = $(this).data('objectid');
                                if (objectId) {
                                    if (!that.BOSchemaCode) {
                                        HTTP.getAppRunObjectSchemaDisplayName(objectId).then((data) => {
                                            if (data.code == 0) {
                                                // var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&BizObjectId=" + objectId + "&Mode=View";
                                                // $.ISideModal.Show(url, data.data.DisplayName);
                                                let instance = Modal.newInstance({
                                                    //scrollable:true,
                                                    okText: '关闭',
                                                    title: inputText,
                                                    footerHide: true,
                                                    render: (h) => {
                                                        return h(assoModal, {
                                                            props: {
                                                                code: objectId
                                                            },
                                                            on: {

                                                            }
                                                        })
                                                    }
                                                })
                                                var options = { icon: "info", showCancel: false, width: "800px" };
                                                options.onRemove = function () {
                                                    instance = null;
                                                };
                                                instance.show(options);
                                            }
                                        })

                                    }
                                    else {
                                        HTTP.getBizObjectSchemaDisplayName(that.BOSchemaCode).then((data) => {
                                            if (data.code == 0) {
                                                // var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&BizObjectId=" + objectId + "&Mode=View";
                                                // $.ISideModal.Show(url, data.data.DisplayName);
                                                let instance = Modal.newInstance({
                                                    //scrollable:true,
                                                    okText: '关闭',
                                                    title: inputText,
                                                    footerHide: true,
                                                    render: (h) => {
                                                        return h(assoModal, {
                                                            props: {
                                                                code: objectId
                                                            },
                                                            on: {

                                                            }
                                                        })
                                                    }
                                                })
                                                var options = { icon: "info", showCancel: false, width: "800px" };
                                                options.onRemove = function () {
                                                    instance = null;
                                                };
                                                instance.show(options);
                                            }
                                        })
                                    }

                                    // that.Ajax("/Form/OnAction", "GET", { PostData: JSON.stringify(params) }, function (data) {
                                    //     var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&BizObjectId=" + objectId + "&Mode=View";
                                    //     $.ISideModal.Show(url, data.ReturnData.DisplayName);
                                    // });
                                }
                            });
                        }
                        that.$Input.empty().append(newLink).data("ObjectId", objectIds.join(";"));
                        that.OnChange(objectIds);
                    }


                })
            }
        },

        //校验
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            if (this.Required && ($.isEmptyObject(val) || val.length == 0)) {
                if (this.SchemaCode != this.BOSchemaCode) {
                    this.AddInvalidText(this.$InputBody, "必填");
                    return false;
                } else {
                    //如果关联的是自己,且关联的数据是空的，则不要校验必填
                    if (this.LoadData != undefined && this.LoadData.length > 0) {
                        this.AddInvalidText(this.$InputBody, "必填");
                        return false;
                    }
                    //如果初始没有数据（this.LoadData.length==0）,在关联表单界面新增了也要校验
                    if (this.$Input.find('a').length == 0) {
                        this.AddInvalidText(this.$InputBody, "必填");
                        return false;
                    }
                }
            }
            this.RemoveInvalidText(this.$InputBody);
            return true;
        },

        SaveDataField: function () {
            var result = {
            };
            var val = this.GetValue();
            if (!this.ResponseContext.IsCreateMode && (!this.Visible)) return result;
            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (oldresult && oldresult.Value != val) {
                result[this.DataField] = val;
                return result;
            }
            result[this.DataField] = [];
            return result;
        },

        GetValue: function () {
            if (!this.Visible) {
                if (this.Value == null) {
                    return [];
                }
                return this.Value;
            }
            var objectId = undefined
            if (this.$Input) {
                objectId = this.$Input.data('ObjectId');
            }
            //去掉最后一个分号
            if (objectId == undefined || objectId == null)
                return [];
            var arr = objectId.split(';');
            //过滤掉""
            var vals = [];
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] != '') {
                    arr[i] == 'undefined' ? vals.push('') : vals.push(arr[i]);
                }
            }
            return vals;
        },

        GetText: function () {
            if (this.$Input) {
                return this.$Input.text();
            } else {
                return ""
            };
        },

        SetReadonly: function (flag) {
            if (flag) {
                this.$Input && this.$Input.prop("disabled", "disabled").off("click");
                this.$addModel && this.$addModel.off("click");

            } else {
                this.$Input.removeProp("disabled");
            }
        },

        Change: function (rowData) {
            this.Required && (this.$Input.text() != "" && this.$Input.css({
                "border": "1px solid #ddd", "box-shadow": "none"
            }));
            //如果控件在子表中，子表列宽要重新计算
            //if ($.fn.FormGridView) {
            //    var gridViewCtrl = $(this.Element).closest('div[data-controlkey="FormGridView"]');
            //    if (gridViewCtrl.length > 0) {
            //        gridViewCtrl = gridViewCtrl.FormGridView();
            //        gridViewCtrl && gridViewCtrl.ResizeColumn(true);
            //    }
            //}
        }
    });
})(jQuery);;
; (function ($) {
    // 控件实例执行方式
    $.fn.FormList = function () {
        return $.ControlManager.Run.call(this, "FormList", arguments);
    };

    $.FormListData = {
        PropertyQueryItems: {},
        PropertyQueryColumns: {},
        SchemaCodeAcl: {},
        PropertyQueryDefaultValues: {}
    };

    // 构造函数
    $.Controls.FormList = function (element, options, sheetInfo) {
        $.Controls.FormList.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormList.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            var that = this;
            that.FirstLoad = true;
            //是否在子表里面子表
            that.IsInGridView = !$.isEmptyObject(this.ObjectId);
            //that.IsQueryControl = false;
            that.CurrentDocument = $(that.Element).closest("html").parent();
            that.CurrentBody = $(that.Element).closest("body").length == 0 ? $("body") : $(that.Element).closest("body");

            this.Editable = false;
            that.SheetData = {};//关联表单过滤用到的数据
            that.LoadData = [];//关联表单的数据，表示加载出来的当前表单对应的关联的数据
            that._Render();
        },

        _Render: function () {
            //是否通过Url传值过来
            // if ($.IQuery(this.BOSchemaCode)) {
            //     if ($.IQuery(this.BOSchemaCode + "_Name")) {
            //         this.Value = $.IQuery(this.BOSchemaCode);
            //     } else {
            //         this.Editable = false;
            //         //2017-3-22注释，关联列表新增的表单打开时候修改过的携带的值会被还原。
            //         //this.Value = $.IQuery(this.BOSchemaCode);
            //     }
            // }
            this.Editable = false;
            //是否可见
            if (!this.Visible) {
                $(this.Element).hide(); return;
            }
            //渲染前端
            this.HtmlRender();

            // if ($.SmartForm != null && $.SmartForm.ResponseContext != null) {
            //     // 新增时，赋值需要处理改变事件，如携带之类的
            //     if ($.SmartForm.ResponseContext.IsCreateMode) {
            //         this.BindChange("FormMultiQueryChange", this.Change);
            //         //初始化默认值
            //         this.InitValue();
            //     } else {
            //         //初始化默认值
            //         this.InitValue();
            //         this.BindChange("FormMultiQueryChange", this.Change);
            //     }
            // } else {
            //     this.BindChange("FormMultiQueryChange", this.Change);
            //     //初始化默认值
            //     this.InitValue();
            // }
            //不可用
            this.InitValue();
            this.SetReadonly(true);
            // if (!this.Editable) {

            // } else {
            //     this.BindEvent();
            // }
        },

        //渲染前端
        HtmlRender: function () {
            // debugger
            var that = this;
            $(this.Element).addClass('SheetMultiQuery');
            if (true) {
                this.$Input = $("<pre>");
                this.$InputBody.append(this.$Input);
            } else {
                this.ID = "FormMultiQuery_" + $.IGuid();
                this.$addModel = $("<a class='form-query-addModel icon-newsvg'></a>");
                this.$Input = $("<div class='form-control form-query-add' placeholder='点击选择已有表单的数据'></div");
                this.$InputBody.css({ 'position': 'relative', 'min-width': '210px' });
                this.$InputBody.append(this.$Input).append(this.$addModel);
                //改为点击时执行
                //setTimeout(that._renderDropDown(that), 0);//渲染下拉
                //setTimeout(that._renderModal(that), 0);//渲染模态框
            }
        },
        BindEvent: function () {
            var that = this;
            this.$addModel.one("click", function (e) {
                that._renderModal.apply(that);
                that.$addModel.trigger("click");
            });
            this.$Input.one("click", function (e) {
                if (!that.$dropDownItemContainer) {
                    that._renderDropDown.apply(that);
                }
            });
        },
        // 获取元素相对屏幕的绝对位置
        _getAbsPosition: function (element) {
            var that = this;
            var left = 0;
            var abs = {
                x: 0, y: 0
            };

            //火狐浏览器下拉框位置问题
            var inputOffset = $(element).offset();
            abs.x = inputOffset.left;
            abs.y = inputOffset.top;

            //if (document.documentElement.getBoundingClientRect) {
            //    abs.x = element.getBoundingClientRect().left;
            //    abs.y = element.getBoundingClientRect().top;
            //    abs.y += document.body.scrollTop | document.documentElement.scrollTop + document.documentElement.scrollTop - document.documentElement.clientTop;
            //} else {
            //    abs.x = $(element).offset().left;
            //    abs.y = $(element).offset().top + $(element).outerHeight;
            //}
            return abs;
        },
        //加载下拉框数据
        _loadDropDownData: function (needClear) {
            var that = this;
            that._getAssociationFilterData();
            if (needClear) {
                that.offset = 0;
            }
            var defaultParams = {
                ActionName: "DoAction",
                Command: 'Load',
                QueryCode: that.BOSchemaCode,
                Status: 1,
                SheetQuery: 1,
                //isFormControl: true,
                ListScene: 2,
                SheetCode: that.SchemaCode,
                DataField: that.DataField,
                SheetData: JSON.stringify(that.SheetData),
                scopeType: 3,
                pageNum: that.pageNumber,
                IsSheetQueryDropDown: true
            };
            var searchName = that.$dropDownInput.val().trim();
            var searchParams = {};
            var params = {};
            if (searchName) {
                if (that.associateChildSchema) {
                    params[that.BOSchemaCode + '.Name'] = [searchName];
                } else {
                    params['Name'] = [searchName];
                }
            }
            searchParams['searchParamsJson'] = JSON.stringify(params);

            $.extend(defaultParams, searchParams);
            if (!that.FirstLoad) {
                var param = {}
                param.QueryCode = that.BOSchemaCode;
                param.SheetData = JSON.stringify(that.SheetData);
                param.DataField = that.DataField;
                param.SheetCode = that.SchemaCode;
                param.isAssociateForm = 1
                if (!needClear) {
                    param.pageNum = Math.ceil(that.offset / 10) + 1;
                }
                if (searchName) {
                    param["nameSchema"] = searchName;
                }
                HTTP.appRunPage(param).then((data) => {
                    if (data.Code == 0) {
                        that.LoadData = data.Result.ReturnData;
                        that._bindDataToDropDown(needClear, that.LoadData);
                    } else {
                        Message.error({
                            content: "获取的关联信息错误" + data.msg,
                            duration: 3
                        });
                    }
                })

                // that.Ajax('/App/OnAction', 'GET', { PostData: JSON.stringify(defaultParams) }, function (data) {
                //     if (data.Successful) {
                //         that.LoadData = data.ReturnData.Response.ReturnData;
                //         that._bindDataToDropDown(needClear, data.ReturnData.Response.ReturnData);
                //     }
                // }, true);
            }
        },


        //渲染 FormMultiQuery的Modal
        _renderModal: function () {
            var that = this;
            that.ID = "FormMultiQuery_" + $.IGuid();
            that.$modal = $("<div id='" + that.ID + "' class='modal fade modal-formquery' style='z-index:1000;' data-backdrop='false' role='dialog'>" +
                "<div class='modal-dialog modal-lg modal-dialog-form'>" +
                "<div class='modal-content'>" +
                "<div class='modal-header modal-header-form'><div class='close' style='margin- top:-2px;' data-dismiss='modal'><span aria-hidden='true' class='fa' style='font-size:16px;'><i class='ivu-icon ivu-icon-close' :color='white'></i></span></div><h4 class='modal-title modal-title-form'>选择" + that.DisplayName + "</h4></div>" +
                "</div>" +
                "</div>" +
                "</div>");

            var $modalBody = $("<div class='modal-body'></div>");

            // 查询条件
            that.$searchForm = $("<div class='form-horizontal searchform myform-horizontal backgroundcolor'></div>");
            $modalBody.append(that.$searchForm);

            //查询条件按钮分割线
            that.$partingLine = $("<div style='border-bottom:1px solid #E3E7E9;text-align:center;'><i class='fa icon-arrow-up-double-b btn-up btnToggle' style='color:#e5e6e6;'></i></div>")
            $modalBody.append(that.$partingLine);

            var $modalFooter = $("<div class='modal-footer modal-footer-form'></div>");

            // 按钮
            that.$toolbar = $("<div class='toolbar text-left' style='margin-top:10px;'><div class='btn-group btn-group-sm' role='group'><button class='btn btn-ok btn-search btnSearch hide '><i class='fa fa-search'></i>查询</button><button class='btn btn-create btnAdd hide'><i class='fa icon-increase'></i>新增</button></div></div>");
            $modalBody.append(that.$toolbar);

            // 表格
            that.Table_ID = "FormTable_" + $.IGuid();
            that.$table = $("<table id='" + that.Table_ID + "' ></table>");

            var pagerStr = '<div class="table-page" id="bar-' + that.Table_ID + '">' +
                '<div class="page-index">' +
                '<input type="text" value="1" class="Page_Index" />/<label class="Page_Count">1</label>' +
                '</div>' +
                '<div class="btn-group table-page_ButtonGroup" style="width: 160px;">' +
                '<button class="btn Page_Num_Pre">上一页</button>' +
                '<button class="btn Page_Num_Next">下一页</button>' +
                '</div>' +
                '<div class="page-size dropup">' +
                '<button class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                '<span class="Page_Per_Size">' + 10 + '</span>' +
                '<i class="fa fa-angle-down"></i>' +
                '</button>' +
                '<ul class="dropdown-menu">' +
                '<li><a>5</a></li>' +
                '<li><a>10</a></li>' +
                '<li><a>20</a></li>' +
                '<li><a>50</a></li>' +
                '</ul>' +
                '</div>' +
                '<div class="page-total">共0条</div>' +
                '</div>';
            var buttonStr = '<div class="btn-group btn-group-sm" role="group" style="width:100%;"><button class="btn btn-ok btnMultiSelect">确定</button></div>';
            $modalBody.append(that.$table).append(pagerStr);
            //如果关联查询控件在子表中则允许批量选择，增加确定按钮
            //新增的时候出现按钮
            $modalFooter.append(buttonStr);
            that.$modal.find(".modal-content").append($modalBody).append($modalFooter);
            $(that.CurrentBody).append(that.$modal);
            that.SheetData = {};
            that.TableNeedRefresh = false;//为true的情况：关联查询过滤规则中配置了主表单的字段
            that.$addModel.off("click").on("click", function () {
                that.$dropdown && that.$dropdown.hide();
                //关联表单信息
                var associationSchemaInfo = $(that.Element).attr('data-boSchemaInfo');
                if (associationSchemaInfo != void 0 && associationSchemaInfo != '') {
                    var infoJson = $.parseJSON(associationSchemaInfo);
                    that.associateChildSchema = infoJson.IsChildSchema;
                } else {
                    that.associateChildSchema = undefined;
                }

                that._getAssociationFilterData();
                that.$modal.modal("show");
            });

            that.SearchInitialized = false; // 查询条件是否已初始化
            that.TableInitialized = false; // 表格是否已初始化
            that.CheckedRows = [];//点击“确定”按钮或者“查询”按钮将勾选的行存入CheckedRows
            // modal的show事件
            that.$modal.on("show.bs.modal", function (e) {
                $.MsgFilter.show();
                that.SelectedItems = [];
                var items = that.$Input.find('i');
                for (var i = 0; i < items.length; i++) {
                    var $item = $(items[i]);
                    var objectId = $item.attr('data-objectid');
                    if (objectId == 'undefined') {
                        continue;
                    }
                    var name = $item.closest('a').text();
                    that.SelectedItems.push({
                        ObjectId: objectId, Name: name
                    });
                }

                that.$table.bootstrapTable('uncheckAll');
                var currModal = this;
                if (!$.FormMultiQueryData.PropertyQueryItems[that.BOSchemaCode] || !$.FormMultiQueryData.PropertyQueryColumns[that.BOSchemaCode]) {
                    //var params = {
                    //    ActionName: "GetPropertyQueryColumnAndItem",
                    //    SchemaCode: that.BOSchemaCode,
                    //    flag: $.IGuid()
                    //}
                    var params = {
                        ActionName: "LoadView",
                        QueryCode: that.BOSchemaCode,
                        flag: $.IGuid()
                    }


                    var param = {}
                    param.appId = that.BOSchemaCode;
                    // param.SheetData=JSON.stringify(that.SheetData);
                    // param.DataField=that.DataField;
                    // param.SheetCode= that.SchemaCode;
                    // param.isAssociateForm=1
                    HTTP.getListSetting(param).then((data) => {
                        if (data.Code != 0) {
                            Message.error({
                                content: "没有设置可用列！",
                                duration: 3
                            });
                            return;
                        }
                        var ret = [];
                        ret.push(
                            {
                                "Align": null,
                                "CanBeQueryItem": true,
                                "ChildColumns": null,
                                "Code": "Name",
                                "DisplayName": "数据标题",
                                "IsChild": null,
                                "IsLabel": null,
                                "IsQueryItem": false,
                                "OptionValue": null,
                                "PropertyName": null,
                                "ShowMode": null,
                                "Sortable": false,
                                "Type": null,
                                "UnitType": null,
                                "Url": null,
                                "Visible": true
                            }
                        )
                        for (var index = 0; index < data.Data.ListViewData.length; index++) {
                            ret.push(data.Data.ListViewData[index])
                        }

                        $.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = ret;
                        //$.FormQueryData.PropertyQueryColumns[that.BOSchemaCode] = data.ReturnData.SortedColumns;
                        //调整initSearchParams位置为initTable之前，原因是在关联列表中初始时候searchform是空
                        $.FormQueryData.PropertyQueryItems[that.BOSchemaCode] = [];
                        // $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode] = JSON.parse(data.ReturnData.QueryDefaultValues);
                        // if (!that.SearchInitialized) {
                        //     that._initSearchParams(data.ReturnData.QueryItems, $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode]);
                        // }

                        // $.FormQueryData.PropertyQueryDefaultValues[that.BOSchemaCode] = JSON.parse(data.ReturnData.QueryDefaultValues);


                        var qry = [];
                        qry.push({
                            "PropertyName": "Name",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "数据标题",
                            "DataType": 14,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })

                        qry.push({
                            "PropertyName": "CreatedTime",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "创建时间",
                            "DataType": 5,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })





                        if (!that.SearchInitialized) {
                            that._initSearchParams(qry, {});
                        }


                        if (!that.TableInitialized || that.TableNeedRefresh) {
                            that._initTable($.FormQueryData.PropertyQueryColumns[that.BOSchemaCode]);//合并表头
                        } else {
                            that._setRowChecked();
                        }
                        //that.afterTableInit();
                    })
                } else {
                    if (!that.TableInitialized || that.TableNeedRefresh) {
                        that._initTable($.FormMultiQueryData.PropertyQueryColumns[that.BOSchemaCode]);
                    } else {
                        that._setRowChecked();
                    }
                    if (!that.SearchInitialized) {
                        var qry = [];
                        qry.push({
                            "PropertyName": "Name",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "数据标题",
                            "DataType": 14,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })

                        qry.push({
                            "PropertyName": "CreatedTime",
                            "DefaultValue": "",
                            "OrganizationType": 2,
                            "DisplayName": "创建时间",
                            "DataType": 5,
                            "DataDictItemName": "",
                            "OptionalValues": null,
                            "itemValues": null,
                            "IsBoReservedPropertiesOnly": true,
                            "DisplayFormat": "",
                            "AssociationSchemaCode": "",
                            "UnitSelectRange": null,
                            "SelectedValues": "",
                            "DateTimeMode": "",
                            "AllowNotNull": true,
                            "FilterValue": "",
                            "Visible": true,
                            "AssociationField": null
                        })
                        that._initSearchParams(qry, {});
                    }
                }
                //判断是否要合并表头
                that._setColumnColspan(that.TableAllColumns);
            });
            that.$modal.on("hidden.bs.modal", function (e) {
                $.MsgFilter.remove();
            });
            var $btnAdd = that.$toolbar.find(".btnAdd");
            // 只有表单中的关联查询允许新增关联对象
            if (that.IsRunnable && that.CanCreate && $(that.Element).hasClass("sheet-control")) {
                // 新增关联对象
                $btnAdd.removeClass("hide");
                $btnAdd.off("click").on("click", function () {

                    var params = {
                        ActionName: "GetBizObjectSchemaDisplayName",
                        SchemaCode: that.BOSchemaCode,
                        flag: $.IGuid()
                    }
                    HTTP.getBizObjectSchemaDisplayName(that.BOSchemaCode).then((data) => {
                        if (data.code == 0) {
                            //var url = "/Form/DefaultSheet?SchemaCode=" + that.BOSchemaCode + "&BizObjectId=" + boId + "&Mode=View";
                            // $.ISideModal.Show(url,data.data.DisplayName);


                            let instanceNew = Modal.newInstance({
                                //scrollable:true,
                                title: data.data.DisplayName,
                                footerHide: true,
                                maskClosable: false,
                                closable: false,
                                render: (h) => {
                                    return h(addRelativeModal, {
                                        props: {
                                            code: that.BOSchemaCode
                                        }
                                    })
                                }
                            })
                            var options = { showCancel: true, width: "800px" };
                            options.onRemove = function () {
                                instanceNew = null;
                            };
                            instanceNew.show(options);

                        }
                    })

                });
            } else {
                $btnAdd.addClass("hide");
            }

            //子表批量选择功能
            var $btnMultiSelect = that.$modal.find('.btnMultiSelect');
            //批量选择确定
            $btnMultiSelect.off('click').on('click', function () {

                that.$modal.modal('hide');
                $('.table-tip').hide();
                //获取check的行
                var datafield = that.DataField;
                var objectIds = '';
                //控件在主表中
                if (that.associateChildSchema == undefined) {
                    that.associateChildSchema = false;
                    for (var key in that.CheckedRows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            that.associateChildSchema = true;
                            break;
                        }
                    }
                }
                var objectIdStr = 'ObjectId';
                var nameStr = 'Name';
                if (that.associateChildSchema) {
                    objectIdStr = that.BOSchemaCode + '.ObjectId';
                    nameStr = that.BOSchemaCode + '.Name';
                }
                //用于列表过滤条件
                that.$Input.empty();
                that.$Input.data('ObjectId', '').empty();
                //Error：checkedRows有重复

                for (var i = 0; i < that.CheckedRows.length; i++) {
                    var objectId = that.CheckedRows[i][objectIdStr];
                    if (!objectId) {
                        continue;
                    }
                    var name = that.CheckedRows[i][nameStr] || "--";
                    var link = '<a href="javascript:;" class="label label-info">' + name + '<i class="fa icon-close-middle" style="margin-left:5px" data-objectId="' + objectId + '"></i></a>';
                    that.$Input.append(link);
                    objectIds = that.$Input.data('ObjectId') || '';
                    objectIds += (objectId + ';');
                    that.$Input.data('ObjectId', objectIds);
                }
                that.$Input.find('i').on('click', function () {
                    var $this = $(this);
                    $this.closest('a').remove();
                    var objectIds = that.$Input.data('ObjectId');
                    var thisObjectId = $this.attr('data-ObjectId');
                    objectIds = objectIds.replace(thisObjectId + ';', '');
                    that.$Input.data('ObjectId', objectIds);
                    that.OnChange();
                    that.$dropDownItemContainer.find('input[type="checkbox"][data-itemid="' + thisObjectId + '"]').prop('checked', false);
                });
                that.OnChange();
            });
        },

        //获取关联表单过滤条件中控件的值
        _getAssociationFilterData: function () {
            //判断关联查询是否配置了过滤规则
            //如果配置了过滤规则且规则中有当前主表单的字段
            //则要取主表单中的字段
            //兼容旧的bofilter
            var that = this;
            if (that.DataField == void 0) {
                return;
            }
            var bofilter = $(that.Element).attr('data-bofilter');
            if (that.AssociationFilter || bofilter) {
                var rule = that.AssociationFilter.Rule || $.parseJSON(bofilter).Rule;
                if (rule && rule.length > 0) {
                    var controlsList = $.ControlManager.Controls;
                    var hasCreatedByCtrl = false;//是否有创建者控件
                    var hasOwnerCtrl = false;//是否有拥有者控件
                    var hasOwnerDeptCtrl = false;//是否有所属部门控件
                    var controls = controlsList[that.SchemaCode + "_" + store.state.listview.currentTabIndex]
                    for (var control in controls) {
                        var ctrl = controls[control];
                        if (ctrl.IsQueryControl) {
                            continue;
                        }
                        var controlDataField = ctrl.DataField;
                        if (controlDataField == 'CreatedBy.FullName') {
                            controlDataField = controlDataField.split('.')[0];
                            hasCreatedByCtrl = true;
                        }
                        if (controlDataField == 'OwnerId') {
                            hasOwnerCtrl = true;
                        }
                        if (controlDataField == 'OwnerDeptId') {
                            hasOwnerDeptCtrl = true;
                        }
                        //rule.indexOf(controlDataField)<0这样不能判断rule中是否有controlDataField,例如rule:{D00001.helloworld}=="hi",controlDataField:hello
                        if (rule.indexOf(controlDataField + '}') < 0 || controlDataField == that.DataField) continue;
                        //如果rule中包含controlDataField，则应该是以如下形式存在
                        //{xx}或者{xxx.xx}形式，主表中的字段是{controlDataField}，子表中字段是{xxx.controlDataField}
                        var ctrlFieldIndex = rule.indexOf(controlDataField + '}');
                        var prefix = rule.slice(ctrlFieldIndex - 1, ctrlFieldIndex);
                        if (prefix != '{' && prefix != '.') {
                            continue;
                        }
                        //字表中的control不调用SaveDataField，由子表自己调用SaveDataField保存值
                        var controlValue = '';
                        if (controlDataField == 'CreatedBy') {
                            controlValue = []
                            controlValue.push($.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].id.toString());
                        } else {
                            if (ctrl.DataField == void 0 || controlDataField == "Comments") continue;
                            //判断关联查询控件是否在子表中
                            if (controlDataField.indexOf('.') > 0 && ctrl.Type != 26 && ctrl.Type != 27) {
                                //规则中的字段在子表中
                                if (that.DataField.indexOf('.') > 0) {
                                    //获取与关联查询控件同一行的子表控件
                                    var $tr = $(that.Element).closest('tr');
                                    var thisRowCtrl = $tr.find('div[data-datafield="' + controlDataField + '"]');
                                    if (thisRowCtrl.length > 0) {
                                        controlValue = $(thisRowCtrl[0]).JControl().GetValue();
                                    }
                                } else {
                                    var $ctrl = $('div[data-datafield="' + controlDataField + '"]').not('.table_th');
                                    if ($ctrl != undefined) {
                                        controlValue = [];
                                        for (var i = 0; i < $ctrl.length; i++) {
                                            controlValue.push($($ctrl[i]).JControl().GetValue());
                                        }
                                    }
                                }
                            } else {
                                if (ctrl.Type == 26 || ctrl.Type == 27) {
                                    //单人
                                    //控件没有渲染的情况
                                    if (!ctrl.Visible) {
                                        if (ctrl.Type == 26) {
                                            controlValue = ctrl.Value[0].UnitId;
                                        } else {

                                        }
                                    } else {
                                        controlValue = ctrl.GetUnitIDs();
                                    }
                                } else if (ctrl.Type == 7) {
                                    controlValue = ctrl.GetNum();
                                } else {
                                    controlValue = ctrl.GetValue();
                                }
                            }
                        }
                        that.SheetData[controlDataField] = controlValue;
                        that.TableNeedRefresh = true;
                        //if (controlValue) break;
                    }
                    // if (!hasCreatedByCtrl) {
                    //     that.SheetData["CreatedBy"] = $.SmartForm.ResponseContext.ReturnData.CreatedBy.Value[0].UnitId;
                    // }
                    // if (!hasOwnerCtrl) {
                    //     that.SheetData["OwnerId"] = $.SmartForm.ResponseContext.ReturnData.OwnerId.Value[0].UnitId;
                    // }
                    // if (!hasOwnerDeptCtrl) {
                    //     that.SheetData["OwnerDeptId"] = $.SmartForm.ResponseContext.ReturnData.OwnerDeptId ? ($.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0] != undefined ? $.SmartForm.ResponseContext.ReturnData.OwnerDeptId.Value[0].UnitId : null) : null;
                    // }
                    // that.SheetData["CreatedTime"] = $.SmartForm.ResponseContext.ReturnData.CreatedTime.Value;
                    // that.SheetData["ParentObjectId"] = $.SmartForm.ResponseContext.BizObjectId;
                }
            }
        },
        //判断是否要合并表头
        _setColumnColspan: function (columns) {
            if (columns == void 0 || columns.length == 0) {
                return;
            }
            var colspantr = this.$table.find('thead tr[class="tr-colspan"]');
            if (colspantr != void 0 && colspantr.length > 0) {
                return;
            }
            var parentColumnCount = 0;
            var childColumnCount = 0;
            for (var i = 0; i < columns.length; i++) {
                var field = columns[i].field;
                if (!columns[i].visible || field == undefined) {
                    continue;
                }
                if (field.indexOf('.') > -1) {
                    childColumnCount++;
                } else {
                    parentColumnCount++;
                }
            }
            if (childColumnCount > 0) {
                if (this.$table.find('th[data-field="checkcolumn"]').length == 0 && this.DataField.indexOf('.') > 0) {
                    //checkbox不可见
                    childColumnCount++;
                    parentColumnCount--;
                }
                var tr = $('<tr class="tr-colspan"></tr>').append('<th colspan="' + parentColumnCount + '" style="text-align:center;">主表</th>').append('<th colspan="' + childColumnCount + '" style="text-align:center;">子表</th>');
                var oldtr = this.$table.find('thead tr');
                $(tr).insertBefore(oldtr);
            }
        },
        _checkRows: function (rows) {
            var that = this;
            var childObjectId = undefined;
            //先判断是check的是单行还是多行
            var tempRows = that.CheckedRows;
            if (that.associateChildSchema == true) {
                childObjectId = that.BOSchemaCode + '.ObjectId';
            }
            if ($.isArray(rows)) {
                if (that.associateChildSchema == undefined) {
                    //兼容旧的
                    for (var key in rows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < rows.length; i++) {
                    var rowExist = false;
                    for (var j = 0; j < tempRows.length; j++) {
                        if (childObjectId != undefined) {
                            if (rows[i][childObjectId] == tempRows[j][childObjectId]) {
                                rowExist = true;
                                break;
                            }
                        } else {
                            if (rows[i]['ObjectId'] == that.CheckedRows[j]['ObjectId']) {
                                rowExist = true;
                                break;
                            }
                        }
                    }
                    if (!rowExist) {
                        that.CheckedRows.push(rows[i]);
                    }
                }
            } else {
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                var rowExist = false;
                for (var i = 0; i < tempRows.length; i++) {
                    if (childObjectId != undefined) {
                        if (tempRows[i][childObjectId] == rows[childObjectId]) {
                            rowExist = true;
                            break;
                        }
                    } else {
                        if (tempRows[i]['ObjectId'] == rows['ObjectId']) {
                            rowExist = true;
                        }
                    }
                }
                if (!rowExist) {
                    that.CheckedRows.push(rows);
                }
            }
        },
        _unCheckRows: function (rows) {
            var that = this;
            var childObjectId = undefined;
            var tempRows = that.CheckedRows;
            if (that.associateChildSchema == true) {
                childObjectId = that.BOSchemaCode + '.ObjectId';
            }
            if ($.isArray(rows)) {//多行
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows[0]) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < rows.length; i++) {
                    for (var j = 0; j < tempRows.length; j++) {
                        if (childObjectId != undefined) {
                            that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                                return item[childObjectId] == rows[i][childObjectId];
                            }, true);
                        } else {
                            that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                                return item['ObjectId'] == rows[i]['ObjectId'];
                            }, true);
                        }
                    }
                }
            } else {//单行
                if (that.associateChildSchema == undefined) {//兼容旧的
                    for (var key in rows) {
                        if (key.toLowerCase().indexOf('.objectid') > -1) {
                            childObjectId = key;
                            break;
                        }
                    }
                }
                for (var i = 0; i < tempRows.length; i++) {
                    if (childObjectId != undefined) {
                        that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                            return item[childObjectId] == rows[childObjectId];
                        }, true);
                    } else {
                        that.CheckedRows = $.grep(that.CheckedRows, function (item, n) {
                            return item['ObjectId'] == rows['ObjectId'];
                        }, true);
                    }
                }
            }
        },
        _initSearchParams: function (queryItems, queryDefaultValues) {
            var that = this;
            if (!queryItems || queryItems.length == 0) {
                this.$searchForm.hide();
                this.$partingLine.hide();
                return;
            }
            var searchHtml = "";
            var showCount = 0;
            for (var i = 0, len = queryItems.length; i < len; i++) {
                var queryItem = queryItems[i];
                if (queryItem.Visible == false) {
                    continue;
                }
                searchHtml += (showCount % 2 == 0 ? "<div class='form-group form-group-sm myform-group mgb5' style='margin-bottom:10px;margin-left:0px!important'>" : "");
                switch (queryItem.DataType) {
                    case 1:
                        var inputId = $.IGuid();
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName +
                            '</label><div class="col-sm-4 pdt5"><span class="mycheckbox" data-propertyname="' + queryItem.PropertyName + '">' +
                            '<input type="checkbox" id="' + inputId + 't" value="true" style="display:none;" /><label for="' + inputId + 't" class="checkbox-inline" style="margin:2px 10px 0 0"> 是</label>' +
                            '<input type="checkbox" id="' + inputId + 'f" value="false" style="display:none;" /> <label for="' + inputId + 'f" class="checkbox-inline" style="margin:2px 10px 0 0">否</label></span></div>';

                        break;
                    case 14:
                        if (queryItem.AssociationSchemaCode) {
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5"><div class="mycomboboxlist" data-dataField="' + queryItem.PropertyName + '" data-schemaCode="' + this.BOSchemaCode + '" data-width="100%" data-defalutvalue="' + queryItem.DefaultValue + '"> </div></div>';
                        }
                        else if (queryItem.SelectedValues && queryItem.SelectedValues !== "") {
                            var checkItemsHtml = "";
                            var checkItems = queryItem.SelectedValues.split(";");
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5">';
                            searchHtml += "<select id='" + queryItem.PropertyName + "' multiple='multiple' class='mymultiselect'>";
                            checkItemsHtml += "<option value='--'>--(空值)</option>";
                            for (var ci = 0, clen = checkItems.length; ci < clen; ci++) {
                                checkItemsHtml += "<option value='" + checkItems[ci] + "'> " + checkItems[ci] + "</option>";
                            }
                            searchHtml += checkItemsHtml;
                            searchHtml += "</select></div>";
                        }
                        else {
                            if (queryItem.PropertyName == "SeqNo") {
                                searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5"><input class="form-control mytext " type="text" data-propertyname="' + queryItem.PropertyName + '" /></div>';
                            }
                            else {
                                searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-3 pdt5"><div class="mycombobox" data-dataField="' + queryItem.PropertyName + '" data-schemaCode="' + this.BOSchemaCode + '" data-width="100%" data-defalutvalue="' + queryItem.DefaultValue + '"> </div></div>';
                            }
                        }
                        break;

                    case 13:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><input class="form-control mytext " type="text" data-propertyname="' + queryItem.PropertyName + '" /></div>';
                        break;
                    case 7:
                    case 9:
                    case 11:
                    case 35:
                        if (queryItem.DisplayName == "Status") {
                            //关联查询中的的筛选,隐藏流程状态
                            //add by jnyf
                            continue;
                            //流程状态
                            searchHtml += '<label class="col-sm-2 control-label">流程状态</label><div class="col-sm-4 pdt5">';
                            searchHtml += '<select id="' + queryItem.DisplayName + '" multiple="multiple" class="mymultiselect">';
                            searchHtml += '<option value="进行中">进行中</option><option value="已结束">已结束</option><option value="已取消">已取消</option>';
                            searchHtml += '</select>';
                            searchHtml += '</div>';
                        } else {
                            searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 pdt5"><div class="input-group mynum" data-propertyname="' + queryItem.PropertyName + '"><div class="input-group-addon">从</div><input type="text" class="form-control" /><div class="input-group-addon">至</div><input type="text" class="form-control" /></div></div>';
                        }
                        break;
                    case 5:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="input-group mydatetime" data-propertyname="' + queryItem.PropertyName + '"><div class="input-group-addon">从</div><input type="text" data-datetimemode="' + queryItem.DateTimeMode + '" class="form-control mydatetimepicker mytimestart" /><div class="input-group-addon">至</div><input type="text" data-datetimemode="' + queryItem.DateTimeMode + '" class="form-control mydatetimepicker mytimeend" /></div></div>';
                        break;
                    case 26:
                        var tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-width="100%"></div></div>';
                        if (queryItem.PropertyName == 'OwnerId' || queryItem.PropertyName == 'CreatedBy') {
                            tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-orgunitvisible="false" data-width="100%"></div></div>';
                        } else if (queryItem.PropertyName == 'OwnerDeptId') {
                            tempHtml = '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-5 pdt5"><div class="myuserpicker" data-displayname="' + queryItem.DisplayName + '" data-propertyname="' + queryItem.PropertyName + '" data-orgunitvisible="true" data-uservisible="false" data-width="100%"></div></div>';
                        }
                        searchHtml += tempHtml;
                        break;
                    case 50:
                    case 51:
                        searchHtml += '<label class="col-sm-2 control-label">' + queryItem.DisplayName + '</label><div class="col-sm-4 mydropdown pdt5" data-propertyname="' + queryItem.PropertyName + '" data-boschemacode="' + queryItem.AssociationSchemaCode + '"></div>';
                        break;
                }
                searchHtml += ((showCount % 2 || showCount === len - 1) != 0 ? "</div>" : "");
                showCount++;
            }
            this.$searchForm.append(searchHtml);

            this.$searchForm.find(".mycombobox").each(function () {
                var $combobox = $(this);
                var schemacode = $combobox.attr("data-schemaCode");
                var datafield = $combobox.attr("data-dataField");
                var defaultvalue = $combobox.attr("data-defalutvalue");
                var mycombobox = $combobox.FormComboBox({
                    SchemaCode: schemacode, DataField: datafield, DefaultValue: defaultvalue, Width: "50%",
                    OnChange: function () {
                        that._refreshTable(0);
                    },
                });
            });


            this.$searchForm.find(".mycombobox").removeClass("form-group");

            this.$searchForm.find(".mycomboboxlist").each(function () {
                var $combobox = $(this);
                var schemacode = $combobox.attr("data-schemaCode");
                var datafield = $combobox.attr("data-dataField");
                var defaultvalue = $combobox.attr("data-defalutvalue");
                var mycomboboxlist = $combobox.FormComboBoxList({
                    Width: "50%",
                    OnChange: function () {
                        that._refreshTable(0);
                    },
                });
            });
            this.$searchForm.find(".mycomboboxlist").removeClass("form-group");


            // 统一初始化datetimepicker
            this.$searchForm.find(".mydatetimepicker").each(function () {
                var $picker = $(this);
                var minView = 2;
                var startView = 2;
                var mode = $picker.attr("data-datetimemode");
                if (!mode) {
                    mode = "yyyy-mm-dd";
                }
                if (mode == "yyyy-mm-dd hh:ii") {
                    minView = 0;
                }
                $picker.datetimepicker({
                    language: 'zh-CN',
                    format: mode,
                    todayBtn: true,
                    container: $picker.closest(".modal-dialog"),
                    autoclose: true,
                    startView: startView, // 选择器打开后首先显示的视图
                    minView: minView// 选择器能够提供的最精确的视图
                }).on("changeDate", function () {
                    that._refreshTable(0);
                });;
            });
            // 统一初始化选人控件
            var $myuserpicker = this.$searchForm.find(".myuserpicker");

            if (!$.isEmptyObject($myuserpicker)) {
                for (var r = 0; r < $myuserpicker.length; r++) {
                    var tempSheetUser = $($myuserpicker[r]).FormMultiUser({ IsQueryControl: true });
                    tempSheetUser.OnChange = function () {
                        that._refreshTable(0);
                    }
                }
            }

            this.$searchForm.find(".myuserpicker").removeClass("form-group");
            this.$searchForm.find(".mymultiselect").each(function () {
                $(this).multiselect({
                    enableFiltering: true,
                    filterPlaceholder: '搜索',
                    buttonText: function (options, select) {
                        if (options.length === 0) {
                            return "";
                        }
                        else {
                            var labels = [];
                            options.each(function () {
                                if ($(this).attr("label") !== void 0) {
                                    labels.push($(this).attr("label"));
                                }
                                else {
                                    labels.push($(this).html());
                                }
                            });
                            return labels.join(",") + "";
                        }
                    },
                    onChange: function () {
                        //that._refreshTable();
                    },
                    onDropdownShow: function () {
                        //点击时选人控件隐藏
                        $("div[data-FormMultiUserPanel='SelectorPanel'],div[data-FormUserPanel='SelectorPanel'],div[data-formmultiuserpanel='searchdiv']").hide();
                        $(".form-query-dropdown").hide();
                    },
                    selectedClass: "multiselect-selected"
                });
            });
            // 下拉搜索自动获取焦点
            $(".dropdown-toggle").on('click', function () {
                var that = this;
                setTimeout(function () {
                    $(that).next().find("input.multiselect-search").focus();
                }, 200);
            });
            // 统一初始化关联查询控件
            this.$searchForm.find(".mydropdown").each(function () {
                var myquery = $(this).FormMultiQuery();
                myquery.IsQueryControl = true;
                myquery.OnChange = function () {
                    that._refreshTable(0);
                }
            });
            this.$searchForm.find(".mydropdown").removeClass("form-group");


            this.$searchForm.find("input[type='text']").blur(function () {
                //有下拉选项中在ValChange触发刷新数据
                if (!$(this).hasClass("comboboxtext")) {
                    that._refreshTable(0);
                }
            }).keydown(function (e) {
                if (e.which == 13) {
                    that._refreshTable(0);
                }
            });

            this.$searchForm.find("input[type='checkbox']").change(function () {
                that._refreshTable(0);
            });

            /***********************************关联查询默认查询 Begin***********************************/
            //格式化日期
            var formatDate = function (date) {
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                var day = date.getDate();
                return year + '-' + (month < 10 ? ('0' + month) : month) + '-' + (day < 10 ? ('0' + day) : day);
            };
            //当天
            var thisDay = function () {
                var date = new Date();
                date = formatDate(date);
                return date + ';' + date;
            };
            //本周
            var thisWeek = function () {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var day = date.getDate();
                var dayOfWeek = date.getDay();
                var start = new Date(year, month, day - dayOfWeek);
                start = formatDate(start);
                var end = new Date(year, month, day + (6 - dayOfWeek));
                end = formatDate(end);
                return start + ';' + end;
            };
            //本月
            var thisMonth = function () {
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth();
                var start = new Date(year, month, 1);
                start = formatDate(start);
                var end = new Date(year, month + 1, 0);
                end = formatDate(end);
                return start + ';' + end;
            };
            //本季度
            var thisQuarter = function () {
                var startMonth = 0;
                var date = new Date();
                var year = date.getFullYear();
                var month = date.getMonth() + 1;
                if (month < 3) {
                    startMonth = 0;
                } else if (month > 2 && month < 6) {
                    startMonth = 3;
                } else if (month > 5 && month < 9) {
                    startMonth = 6;
                } else if (month > 8) {
                    startMonth = 9;
                }
                var start = new Date(year, startMonth, 1);
                var end = new Date(year, startMonth + 3, 0);
                start = formatDate(start);
                end = formatDate(end);
                return start + ';' + end;
            };
            //本年度
            var thisYear = function () {
                var date = new Date();
                var year = date.getFullYear();
                var start = new Date(year, 0, 1);
                var end = new Date(year, 12, 0);
                start = formatDate(start);
                end = formatDate(end);
                return start + ';' + end;
            };
            //设置默认查询值
            //下面这段代码主要是用于关联查询中设置默认值的列表
            var searchParams = {
            };
            for (var i = 0; i < queryItems.length; i++) {
                var item = queryItems[i];
                if (item.DataType == 5) {
                    //datetime
                    var filterValue = parseInt(item.FilterValue);
                    switch (filterValue) {
                        case 1://当天
                            searchParams[item.PropertyName] = thisDay();
                            break;
                        case 2://本周
                            searchParams[item.PropertyName] = thisWeek();
                            break;
                        case 3://本月
                            searchParams[item.PropertyName] = thisMonth();
                            break;
                        case 4://本季度
                            searchParams[item.PropertyName] = thisQuarter();
                            break;
                        case 5://本年度
                            searchParams[item.PropertyName] = thisYear();
                            break;
                        default:
                            break;
                    }
                } else if (item.DataType == 26) {
                    var filterValue = parseInt(item.FilterValue);
                    var organizationType = parseInt(item.OrganizationType);
                    var defaultValue = queryDefaultValues[item.PropertyName];
                    switch (filterValue) {
                        case 1://本人
                            searchParams[item.PropertyName] = defaultValue + ";" + organizationType;
                            break;
                        case 2://本部门
                            searchParams[item.PropertyName] = defaultValue + ";" + organizationType;
                            break;
                        default:
                            break;
                    }
                }
                else {
                    //searchParams[queryItems[i].PropertyName] = queryItems[i].DefaultValue;
                    searchParams[queryItems[i].PropertyName] = queryDefaultValues[queryItems[i].PropertyName];
                }
            }
            var $divSearch = this.$searchForm;

            //单选、多选、下拉
            var myMultiSelect = $divSearch.find(".mymultiselect");
            for (var i = 0; i < myMultiSelect.length; i++) {
                var $property = $(myMultiSelect[i]);
                var propertyName = $property.attr("id");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    //$property.multiselect("select", propertyVal.split(";"));
                    $property.multiselect("select", propertyVal);
                }
            }
            // 文本
            var myText = $divSearch.find(".mytext");
            for (var i = 0; i < myText.length; i++) {
                var $property = $(myText[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    $property.val(propertyVal);
                }
            }
            // 选人
            var myUserPicker = $divSearch.find(".myuserpicker");
            for (var i = 0; i < myUserPicker.length; i++) {
                var $property = $(myUserPicker[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var arr = propertyVal.split(';');
                    var $ctrl = $property.FormMultiUser();//.SetValue(arr[0]);

                    $ctrl.SetValue(arr[0]);
                    if (parseInt(arr[1]) == 0) {
                        //人员可选
                        $($ctrl.Element).find('li[data-tabtype="tab_Deps"]').remove();
                    } else if (parseInt(arr[1]) == 1) {
                        //部门可选
                        $($ctrl.Element).find('li[data-tabtype="tab_Users"]').remove();
                    }
                }
            }
            // 数字
            var myNum = $divSearch.find(".mynum");
            for (var i = 0; i < myNum.length; i++) {
                var $property = $(myNum[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    //var defaultValue = propertyVal;
                    var valArr = propertyVal;//.split(";");
                    for (var i = 0; i < valArr.length; i++) {
                        if (!$.isNumeric(valArr[i])) {
                            continue;
                        }
                        $property.find("input:text").eq(i).val(valArr[i]);
                    }
                }
            }
            //是/否
            var myCheckBox = $divSearch.find('.mycheckbox');
            for (var i = 0; i < myCheckBox.length; i++) {
                var $property = $(myCheckBox[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal != undefined && propertyVal != null && propertyVal != "") {
                    if (propertyVal) {
                        $property.find("input[value='true']").prop("checked", "true");
                    }
                    else {
                        $property.find("input[value='false']").prop("checked", "true");
                    }
                }
            }
            //datetime
            var myDateTime = $divSearch.find(".mydatetime");
            for (var i = 0; i < myDateTime.length; i++) {
                var $property = $(myDateTime[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var days = propertyVal.split(';');
                    var picker = $property.find(".mydatetimepicker");
                    for (var j = 0; j < picker.length; j++) {
                        $(picker[j]).val(days[j]);
                    }
                }
            }
            // FormQuery
            var myDropDown = $divSearch.find(".mydropdown");
            for (var i = 0; i < myDropDown.length; i++) {
                var $property = $(myDropDown[i]);
                var propertyName = $property.attr("data-propertyname");
                var propertyVal = searchParams[propertyName];
                if (propertyVal) {
                    var formQuery = $property.FormMultiQuery();
                    formQuery.SetValue(propertyVal);
                }
            }
            /***********************************关联查询默认查询 End***********************************/



            var $btnSearch = this.$toolbar.find(".btnSearch");
            $btnSearch.removeClass("hide");
            $btnSearch.click(function () {
                that._refreshTable();
                return false;
            });
            // 查询条件展开or收起
            var $btnToggle = this.$partingLine.find(".btnToggle");
            $btnToggle.removeClass("hide");
            $btnToggle.click(function () {
                if ($(this).hasClass("btn-up")) {
                    $(this).removeClass("btn-up").addClass("btn-down").removeClass("icon-arrow-up-double-b").addClass("icon-arrow-down-double-b");
                    //$(this).html("<i class='fa icon-arrow-down-double'></i>");
                    that.$searchForm.find("div.form-group:gt(1)").hide();
                }
                else {
                    $(this).removeClass("btn-down").addClass("btn-up").removeClass("icon-arrow-down-double-b").addClass("icon-arrow-up-double-b");

                    that.$searchForm.find("div.form-group").show();
                }
                return false;
            });

            // 查询条件多于2行时默认触发收起
            var seachRowCount = this.$searchForm.find("div.form-group").length;
            if (seachRowCount > 2) {
                $btnToggle.trigger("click");
            }
            else { // 查询条件少于3行时，隐藏收起按钮
                //$btnToggle.hide();
                this.$partingLine.hide();

                // 没有查询条件时，隐藏查询按钮
                if (seachRowCount === 0) {
                    $btnSearch.hide();
                }
            }

            this.SearchInitialized = true;
        },

        _initTable: function (queryColumns) {
            var that = this;
            var columns = [];
            if (queryColumns) {
                //添加一个checkbox列
                columns.push({
                    field: 'checkcolumn',
                    title: '',
                    visible: true,
                    checkbox: true,
                    clickToSelect: true
                });

                var tempColumnList = [];
                var childSchema = []; //子表
                for (var key in queryColumns) {
                    if (queryColumns[key].ChildColumns) {
                        childSchema.push(queryColumns[key]);
                    } else {
                        tempColumnList.push(queryColumns[key]);
                    }
                }
                //添加完主表字段后再添加子表字段
                if (childSchema.length > 0) {
                    for (var i = 0; i < childSchema.length; i++) {
                        var chidColumns = childSchema[i].ChildColumns;
                        var key = childSchema[i].Code;
                        for (var childKey in chidColumns) {
                            chidColumns[childKey].Code = chidColumns[childKey].Code.indexOf(".") > -1 ?
                                chidColumns[childKey].Code :
                                key + "." + chidColumns[childKey].Code;
                            tempColumnList.push(chidColumns[childKey]);
                        }
                    }
                }

                for (var i = 0, len = tempColumnList.length; i < len; i++) {
                    var queryColumn = tempColumnList[i];
                    columns.push({
                        field: queryColumn["Code"],
                        title: queryColumn["DisplayName"],
                        visible: queryColumn["Visible"],
                        formatter: function (value, row, index, field) {
                            if (value != null && value.constructor == Object) {
                                if (value.IsCustom != null) {
                                    value = value.Value;
                                } else if (value.Color != null) {
                                    return "<span style='padding: 5px 15px 5px 15px;border-radius:4px; color:#fff;background-color:" + value.Color.toString() + ";'>" + value.Value + "</span>";
                                }
                            }
                            if (value != null && value.constructor == String && (value.indexOf("<") || value.indexOf(">"))) {
                                value = value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                            }
                            // if (field == OwnerDeptId_Name) {
                            //     return value;
                            // }
                            if (value == null || $.trim(value.toString()) == "") value = "--";
                            return value;
                        }
                    });
                }
            }

            that.TableAllColumns = columns;
            // 关联查询只显示审批通过的记录
            this.$table.bootstrapTable('destroy');
            var queryparams = {
                ActionName: "DoAction",
                Command: "Load",
                QueryCode: this.BOSchemaCode,
                Status: 1,
                SheetQuery: 1,
                //isFormControl: true,
                ListScene: 2,//列表场景，1表示普通列表，2表示弹窗内列表
                SheetCode: this.SchemaCode,
                DataField: this.DataField,
                SheetData: JSON.stringify(this.SheetData),
                scopeType: 3
            }

            var bootstrapTableOptions = {
                method: "post",
                // 添加SheetQuery标识，让关联查询只以列表展现
                //这里传入scopeType为OwnAndOwnDept。如果不传入默认权限为own
                url: axios.defaults.baseURL + "/act/app/appRunPage",
                // clickToSelect:true,
                cache: false,
                striped: false,
                sidePagination: "server",
                pagination: true,
                pageSize: 10,
                contentType: "application/x-www-form-urlencoded",
                pageList: [10, 20, 50],
                columns: columns,
                idField: "ObjectId",
                sortName: "",
                sortOrder: "",
                TargetId: that.Table_ID,
                queryParams: function (params) {
                    var param = that._formatQueryParams(params, that);
                    param["QueryCode"] = that.BOSchemaCode;
                    param["SheetData"] = JSON.stringify(that.SheetData);
                    param["DataField"] = that.DataField;
                    param["SheetCode"] = that.SchemaCode;
                    param["isAssociateForm"] = 1
                    return param;
                },
                onLoadSuccess: function (data) {
                    that.LoadData = data;
                    that.$table.find("tbody > tr").css({
                        "cursor": "pointer"
                    });
                    that.$table.find("th")
                    that.TableInitialized = true;

                    //不固定表头时需要给table指定高度，
                    if (that.FixedTableHeader == false) {
                        //高度调整到220,防止弹出框时确定按钮到屏幕之外
                        that.$table.closest('.fixed-table-body').css({ "height": "180px", "overflow": "auto" });
                    }
                    setTimeout(function () {
                        var fixedTableHeader = that.$table.closest(".fixed-table-container").find(".fixed-table-header");
                        if (fixedTableHeader) {
                            if (fixedTableHeader.find(".tr-colspan").length > 0) {
                                that.$modal.find("div.table-page").css("margin-top", "88px");
                            }
                            fixedTableHeader.removeAttr("style");
                        }
                    }, 100);

                    //设置选中行
                    that._setRowChecked();
                },
                onCheck: function (row, $element) {
                    that._checkRows(row);
                },
                onCheckAll: function (rows) {
                    that._checkRows(rows);
                },
                onUncheck: function (row, $element) {
                    that._unCheckRows(row);
                },
                onUncheckAll: function (rows) {
                    that._unCheckRows(rows);
                },
                onClickRow: function (row, $element) {
                    return;
                },
                responseHandler: function (params) {
                    if (params.ReturnData === null) params.ReturnData = new Array();
                    that.RenderPage.call(this, params);
                    return {
                        rows: params.ReturnData, total: params.DataCount
                    };
                },
                onAll: function () {
                }
            };
            if (that.FixedTableHeader == undefined || that.FixedTableHeader == true) {
                bootstrapTableOptions.height = 180;
            }

            this.$table.bootstrapTable(bootstrapTableOptions);
            that._setColumnColspan(columns);

            this.$table.off("mouseenter.list").on("mouseenter.list", 'td', function () {
                var $tableTip = $(".table-tip"), $TextLabel = $(".TextLabel");
                $tableTip.length == 0 && ($tableTip = $('<div class="table-tip" style="display: none;"></div>').appendTo(that.CurrentBody)); //.appendTo($("body")));
                $TextLabel.length == 0 && ($TextLabel = $('<label class="TextLabel" style="display: none; opacity:0; position:fixed;"></label>').appendTo(that.CurrentBody));//.appendTo($("body")));
                var $that = $(this);
                $TextLabel.text($that.text());
                if ($TextLabel.width() > $that.width()) {
                    var offset = $that.offset();
                    $tableTip.text($that.text()).css({
                        left: offset.left + ($that.outerWidth() - $tableTip.outerWidth()) / 2 - $(window).scrollLeft(), bottom: $(window).height() - offset.top + 6 + $(window).scrollTop()
                    }).show();
                }
            });

            this.$table.off("mouseleave.list").on("mouseleave.list", 'td', function () {
                $(".table-tip").hide();
                return false;
            });
        },
        //设置行选中
        _setRowChecked: function () {
            var that = this;
            if (that.SelectedItems.length == 0) {
                return;
            }
            //如果checkedrows中有selecteditems则不要添加
            var checkedRows = [];

            for (var i = 0; i < that.CheckedRows.length; i++) {
                checkedRows.push(that.CheckedRows[i].ObjectId);
            }
            for (var i = 0; i < that.SelectedItems.length; i++) {
                if ($.inArray(that.SelectedItems[i].ObjectId, checkedRows) == -1) {
                    that.CheckedRows.push(that.SelectedItems[i]);
                }
            }


            var data = that.$table.bootstrapTable('getData', true);
            if (that.associateChildSchema == undefined) {
                that.associateChildSchema = false;
                if (data && data.length > 0) {
                    for (var key in data[0]) {
                        if (key.indexOf('.ObjectId') > -1) {
                            that.associateChildSchema = true;
                            break;
                        }
                    }
                }
            }
            var objectIdStr = 'ObjectId';
            if (that.associateChildSchema) {
                objectIdStr = that.BOSchemaCode + '.ObjectId';
            }
            var childSchemaObjectId = undefined;
            for (var i = 0; i < data.length; i++) {
                for (var j = 0; j < that.SelectedItems.length; j++) {
                    if (data[i][objectIdStr] == that.CheckedRows[j].ObjectId) {
                        that.$table.bootstrapTable('check', i);
                        break;
                    }
                }
            }

            //设置选中行
            if (that.CheckedRows.length == 0)
                return;
            var data = that.$table.bootstrapTable('getData', true);
            var childSchemaObjectId = undefined;
            if (data.length > 0) {
                if (that.associateChildSchema == true) {
                    childSchemaObjectId = that.BOSchemaCode + '.ObjectId';
                } else if (that.associateChildSchema == undefined) {
                    for (var key in data[0]) {
                        if (key.toLowerCase().indexOf(".objectid") > -1) {
                            childSchemaObjectId = key;
                            break;
                        }
                    }
                }
            }
            for (var i = 0; i < data.length; i++) {
                for (var j = 0; j < that.CheckedRows.length; j++) {
                    if (childSchemaObjectId != undefined) {
                        if (data[i][childSchemaObjectId] == that.CheckedRows[j][childSchemaObjectId]) {
                            that.$table.bootstrapTable('check', i);
                            break;
                        }
                    } else {
                        if (data[i].ObjectId == that.CheckedRows[j].ObjectId) {
                            that.$table.bootstrapTable('check', i);
                            break;
                        }
                    }
                }
            }
        },
        _refreshTable: function (pageNumber) {
            //重置pageNumber到第一页
            if (pageNumber != void 0 || !isNaN(pageNumber)) {
                this.$table.bootstrapTable("refreshOptions", { pageNumber: 1 });
            }
            this.$table.bootstrapTable("refresh");
        },

        // 添加查询条件
        _formatQueryParams: function (params) {
            var searchParams = {
            };
            var $divSearch = this.$searchForm;

            var myMultiSelect = $divSearch.find(".mymultiselect");
            for (var i = 0; i < myMultiSelect.length; i++) {
                var v = [];
                var $multiSelect = $(myMultiSelect[i]);
                var selectedText = $multiSelect.parent().find(".multiselect-selected-text").text();
                if (selectedText) {
                    v = selectedText.split(/,|，|；|;/); //支持中文逗号
                }
                if (v.length > 0) {
                    for (var j = 0; j < v.length; j++) {
                        v[j] = $.trim(v[j]);
                    }
                    searchParams[$multiSelect.attr("id")] = v;
                }
            }
            // 文本
            var myText = $divSearch.find(".mytext");
            for (var i = 0; i < myText.length; i++) {
                var $text = $(myText[i]);
                var v = $.trim($text.val());
                if (v !== "") {
                    if (v.indexOf(",") > -1 || v.indexOf("，") > -1) {
                        v = v.split(/,|，|;|；/);
                        if (v.length > 0) {
                            for (var j = 0; j < v.length; j++) {
                                v[j] = $.trim(v[j]);
                                if (v[j] == "--")//未填写，空白值项
                                {
                                    v[j] = "";
                                }
                            }
                            searchParams[$text.attr("data-propertyname")] = v;
                        }
                    }
                    else if (v.indexOf("；") > -1 || v.indexOf(";") > -1) {
                        v = v.split(/;|；/);
                        if (v.length > 0) {
                            for (var j = 0; j < v.length; j++) {
                                v[j] = $.trim(v[j]);
                                if (v[j] == "--")//未填写，空白值项
                                {
                                    v[j] = "";
                                }
                            }
                            searchParams[$text.attr("data-propertyname")] = v;
                        }
                    }
                    else {
                        if ($.trim(v) == "--") {
                            searchParams[$text.attr("data-propertyname")] = [""];
                        }
                        else {
                            searchParams[$text.attr("data-propertyname")] = [v];
                        }

                    }
                }
            }
            // 选人
            var myUserPicker = $divSearch.find(".myuserpicker");
            for (var i = 0; i < myUserPicker.length; i++) {
                var $picker = $(myUserPicker[i]);
                var v = $picker.FormMultiUser().GetUnitIDs();
                if (v && v.length > 0) {
                    searchParams[$picker.attr("data-propertyname")] = v;
                }
            }
            // 数字
            var myNum = $divSearch.find(".mynum");
            for (var i = 0; i < myNum.length; i++) {
                var $myNum = $(myNum[i]);
                var v = [];
                var num = $myNum.find(":text");
                for (var j = 0; j < num.length; j++) {
                    var $num = $(num[j]);
                    var val = $num.val();
                    if ($.isNumeric(val)) {
                        v.push(val);
                    } else {
                        v.push(null);
                    }
                }
                if (v.length > 0) {
                    searchParams[$myNum.attr("data-propertyname")] = v;
                }
            }
            //是/否
            var myCheckBox = $divSearch.find('.mycheckbox');
            for (var i = 0; i < myCheckBox.length; i++) {
                var $myCheckBox = $(myCheckBox[i]);
                var v = [];
                var val = $myCheckBox.find('input[type="checkbox"]:checked').val();
                v.push(val);
                searchParams[$myCheckBox.attr('data-propertyname')] = v;
            }
            // datetime
            var myDateTime = $divSearch.find(".mydatetime");
            for (var i = 0; i < myDateTime.length; i++) {
                var $myDateTime = $(myDateTime[i]);
                var v = [];
                var myDateTimePicker = $myDateTime.find(".mydatetimepicker");
                for (var j = 0; j < myDateTimePicker.length; j++) {
                    var $myDateTimePicker = $(myDateTimePicker[j]);
                    var val = $myDateTimePicker.val();
                    if ($.trim(val) !== "") {
                        v.push(val);
                    } else {
                        v.push(null);
                    }
                }
                if (v.length > 0) {
                    searchParams[$myDateTime.attr("data-propertyname")] = v;
                }
            }

            // FormQuery
            var myDropDown = $divSearch.find(".mydropdown");
            for (var i = 0; i < myDropDown.length; i++) {
                var $mydropdown = $(myDropDown[i]);
                var v = $mydropdown.FormMultiQuery().GetValue();
                //多个关联表单中间用;隔开
                var arr = [];
                if (!$.isArray(v)) {
                    if (v && v.length > 0) {
                        v = v.split(';');
                        for (var i = 0; i < v.length; i++) {
                            if (v[i] == undefined || v[i] == 'undefined') {
                                arr.push('');
                            } else if (v[i] != '') {
                                arr.push(v[i]);
                            }
                        }
                        searchParams[$mydropdown.attr("data-propertyname")] = arr;
                    }
                } else {
                    //替换掉undefined
                    for (var j = 0; j < v.length; j++) {
                        if (v[j] == undefined || v[j] == 'undefined') {
                            arr.push('');
                        } else if (v[j] != '') {
                            arr.push(v[j]);
                        }
                    }
                    searchParams[$mydropdown.attr("data-propertyname")] = arr;
                }
            }
            if (searchParams.Name && searchParams.Name.length > 0) {
                params["nameSchema"] = searchParams.Name[0];
            }
            if (searchParams["CreatedTime"][0]) {
                params["startTime"] = Number(new Date(searchParams["CreatedTime"][0]))
            }
            if (searchParams["CreatedTime"][1]) {
                params["endTime"] = Number(new Date(searchParams["CreatedTime"][1])) + 24 * 60 * 60 * 1000
            }
            return params;
        },

        _getQueryParams: function () {
            var queryParams = {
            };
            if (this.InputMappings) {
                for (var datafield in this.InputMappings) {
                    // 根据datafield，从页面上取值
                    var controlManager = this._getTargetElement(datafield).JControl();
                    if (controlManager) {
                        queryParams[this.InputMappings[datafield]] = controlManager.GetValue();
                    }
                }
            }
            return queryParams;
        },

        _getTargetElement: function (datafield) {
            var $targetElement;
            var dataFieldName = $.ControlManager.PreDataKey + $.ControlManager.DataFieldKey;
            // 子表字段，通过datafield在当前行中找
            if (datafield.indexOf(".") > -1) {
                $targetElement = this.$InputBody.closest("tr").find("[" + dataFieldName + "='" + datafield + "']")
            }
            else {
                $targetElement = $("[" + dataFieldName + "='" + datafield + "']");
            }
            return $targetElement;
        },
        //重写DetailLink
        //link是文本框中总内容
        _toItemLink: function (link, name) {
            var that = this;
            var $newLink = $(link);
            //不可编辑状态改变标签样式并绑定点击事件
            $newLink = $newLink.removeClass("label label-info").css({
                "border": "none",
                "white-space": "pre-wrap",
                "white-space": "-moz-pre-wrap",
                "white-space": "-pre-wrap",
                "white-space": "-o-pre-wrap",
                "word-wrap": "break-word",
                "overflow": "auto",
                "word-break": "break-all"
            });
            var inputText = this.$Input.text();
            $newLink.find("i").remove();

            $newLink.on("click", function () {
                // debugger
                that._getAssociationFilterData();
                let instance = Modal.newInstance({
                    //scrollable:true,
                    okText: '关闭',
                    title: name,
                    footerHide: true,
                    render: (h) => {
                        return h(cTablelistTable, {
                            props: {
                                currentId: that.BOSchemaCode,
                                SheetData: JSON.stringify(that.SheetData),
                                sheetCode: that.SchemaCode,
                                DataField: that.DataField,
                            },
                            on: {

                            }
                        })
                    }
                })
                var options = { icon: "info", showCancel: false, width: "1100px" };
                options.onRemove = function () {
                    instance = null;
                };
                instance.show(options);


            });

            return $newLink;
        },

        RenderPage: function (data) {
            var that = this;
            var $target = $("#" + that["TargetId"]);
            if (!$target) return;
            if (that.pageNumber > 1 && data && data.length == 0) {
                $target.bootstrapTable("refreshOptions", {
                    pageNumber: that.pageNumber - 1
                });
            }
            if (!that.$PageNext) {
                var $pageBar = $("#bar-" + that["TargetId"]);
                that.$PageNext = $pageBar.find(".Page_Num_Next");
                that.$PagePre = $pageBar.find(".Page_Num_Pre");
                that.$PageIndex = $pageBar.find(".Page_Index");
                that.$PageCount = $pageBar.find(".Page_Count");
                that.$PageTotal = $pageBar.find(".page-total");
                that.$PageSize = $pageBar.find(".Page_Per_Size");
                that.$PageNext.bind('click', function () {
                    $target.bootstrapTable("nextPage");
                });
                that.$PagePre.bind('click', function () {
                    $target.bootstrapTable("prevPage");
                });

                var PageTimeout;
                that.$PageIndex.bind("keyup", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val().replace(/[^\d]/g, '');
                    v = v == "" ? 0 : parseInt(v);
                    v = v >= that.Count ? that.Count : v;
                    if (v == 0) return;
                    $(this).val(v);
                    PageTimeout = setTimeout(function () {
                        v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                        PageTimeout = null;
                    }, 600);
                });
                that.$PageIndex.bind("blur", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val();
                    v = v == "" || v == "0" ? 1 : parseInt(v);
                    $(this).val(v);
                    v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                });
                $pageBar.on("click", "li>a", function () {
                    var size = parseInt($(this).text());
                    that.$PageSize.html(size);
                    $target.bootstrapTable("refreshOptions", {
                        pageSize: size
                    });

                })
            }
            if (!data) {
                that.$PageNext.addClass("disable").attr("disabled", true);
                that.$PagePre.addClass("disable").attr("disabled", true);
                that.$PageIndex.val(1).attr("disabled", true);
                that.$PageCount.html(1);
                that.$PageTotal.html("共0条");
            }
            else {
                that.$PageIndex.val(that.pageNumber);
                that.Count = Math.ceil(data.Result.Count / that.pageSize);
                that.$PageCount.html(that.Count);
                that.$PageTotal.html("共" + data.Result.Count + "条");
                if (that.pageNumber <= 1) {
                    that.$PagePre.addClass("disable").attr("disabled", true);
                }
                else {
                    that.$PagePre.removeClass("disable").attr("disabled", false);
                }

                if (that.pageNumber == that.Count) {
                    that.$PageNext.addClass("disable").attr("disabled", true);
                }
                else {
                    that.$PageNext.removeClass("disable").attr("disabled", false);
                }
            }
        },

        //设置值
        InitValue: function () {
            // debugger
            var item = this.Value || this.DefaultValue;
            this.SetValue(item, true);
        },

        //设置值
        SetValue: function (item, asy) {
            //item可以是string或者数组
            var that = this;
            //把item转成数组
            if (true) {
                //传入单个值
                // debugger
                var name = "";
                if ($.trim(name) == '') {
                    HTTP.getBizObjectSchemaDisplayName(that.BOSchemaCode).then((data) => {
                        console.log(data);
                        if (data.code == 0) {
                            name = $.trim(data.data.DisplayName);
                            if ($.trim(name) == '') {
                                name = '--';
                            }
                            var title = name;
                            if (!that.Editable && that.IsInGridView) {
                                title = "";
                            }
                            var link = '<a href="javascript:;" class="label label-info" title="' + title + '" data-objectId="' + that.BOSchemaCode + '">' + '查看' + '<i class="fa icon-close-middle" style="margin-left:5px" data-objectId="' + that.BOSchemaCode + '"></i></a>';
                            link = that._toItemLink(link, name);
                            that.$Input.append(link).data("ObjectId", that.BOSchemaCode);
                        } else {
                            Message.error({
                                content: "获取的关联列表名称错误" + data.msg,
                                duration: 3
                            });
                        }
                    })
                }
            }
        },

        //校验
        Validate: function () {
            //不可编辑
            if (!this.Editable) return true;

            var val = this.GetValue();

            if (this.Required && ($.isEmptyObject(val) || val.length == 0)) {
                if (this.SchemaCode != this.BOSchemaCode) {
                    this.AddInvalidText(this.$InputBody, "必填");
                    return false;
                } else {
                    //如果关联的是自己,且关联的数据是空的，则不要校验必填
                    if (this.LoadData != undefined && this.LoadData.length > 0) {
                        this.AddInvalidText(this.$InputBody, "必填");
                        return false;
                    }
                    //如果初始没有数据（this.LoadData.length==0）,在关联表单界面新增了也要校验
                    if (this.$Input.find('a').length == 0) {
                        this.AddInvalidText(this.$InputBody, "必填");
                        return false;
                    }
                }
            }
            this.RemoveInvalidText(this.$InputBody);
            return true;
        },

        SaveDataField: function () {
            var result = {
            };
            var val = this.GetValue();
            if (!this.ResponseContext.IsCreateMode && (!this.Visible)) return result;
            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (oldresult && oldresult.Value != val) {
                result[this.DataField] = val;
                return result;
            }
            result[this.DataField] = [];
            return result;
        },

        GetValue: function () {
            if (!this.Visible) {
                if (this.Value == null) {
                    return [];
                }
                return this.Value;
            }
            var objectId = undefined
            if (this.$Input) {
                objectId = this.$Input.data('ObjectId');
            }
            //去掉最后一个分号
            if (objectId == undefined || objectId == null)
                return [];
            var arr = objectId.split(';');
            //过滤掉""
            var vals = [];
            for (var i = 0; i < arr.length; i++) {
                if (arr[i] != '') {
                    arr[i] == 'undefined' ? vals.push('') : vals.push(arr[i]);
                }
            }
            return vals;
        },

        GetText: function () {
            if (this.$Input) {
                return this.$Input.text();
            } else {
                return ""
            };
        },

        SetReadonly: function (flag) {
            if (flag) {
                this.$Input && this.$Input.prop("disabled", "disabled").off("click");
                this.$addModel && this.$addModel.off("click");

            } else {
                this.$Input.removeProp("disabled");
            }
        },

        Change: function (rowData) {
            this.Required && (this.$Input.text() != "" && this.$Input.css({
                "border": "1px solid #ddd", "box-shadow": "none"
            }));
            //如果控件在子表中，子表列宽要重新计算
            //if ($.fn.FormGridView) {
            //    var gridViewCtrl = $(this.Element).closest('div[data-controlkey="FormGridView"]');
            //    if (gridViewCtrl.length > 0) {
            //        gridViewCtrl = gridViewCtrl.FormGridView();
            //        gridViewCtrl && gridViewCtrl.ResizeColumn(true);
            //    }
            //}
        }
    });
})(jQuery);;
(function ($) {
    $.fn.FormBoList = function () {
        return $.ControlManager.Run.call(this, "FormBoList", arguments);
    };

    // 构造函数
    $.Controls.FormBoList = function (element, options, sheetInfo) {
        $.Controls.FormBoList.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormBoList.Inherit($.Controls.BaseControl, {
        Render: function () {
            if (this.ResponseContext == null ||
                this.ResponseContext.IsCreateMode ||
                this.ResponseContext.BizObjectStatus == $.SmartForm.BizObjectStatus.Draft ||
                this.ResponseContext.BizObjectStatus == $.SmartForm.BizObjectStatus.Running) {
                $(this.Element).remove();
                return;
            }
            if (this.ResponseContext.IsCreateMode || $.isEmptyObject(this.BOSchemaCode)) {
                this.ShowEmptyList();
                return;
            }

            this.BizObjectStatus = {
                // 草稿，对于表单来说，用户点保存，表示是草稿状态；对于流程来说，审批完成前，都是草稿状态
                Draft: 0,
                // 审批通过
                Effective: 1,
                // 被取消
                Canceled: 3,
                // 进行中
                Running: 2
            };
            this.ListViewDisplayMode = {
                List: 0,
                Calendar: 1,
                Timeline: 2
            }
            this.SheetUrl = "/Form/DefaultSheet";
            this.HtmlRender();
        },

        HtmlRender: function () {
            var that = this;
            $(this.Element).attr("id", $.IGuid()).css({ "width": "100%", "overflow-x": "auto" });
            this.InitServer();
        },
        GetRowAttributes: function (row, index) {
            var that = this;
            if (row.Status == that.BizObjectStatus.Draft) {
                return { "class": "Draft-Row" };
            } else if (row.Status == that.BizObjectStatus.Running) {
                return { "class": "Running-Row" };
            } else if (row.Status == that.BizObjectStatus.Canceled) {
                return { "class": "Canceled-Row" };
            } else {
                return {};
            }
        },

        GetSheetBoListParams: function (params) {
            if (params == void 0) {
                params = {};
            }
            var paramData = $.extend(params, {
                Command: "LoadBoListData",
                BOSchemaCode: this.BOSchemaCode,
                AssociationCode: this.SchemaCode,
            }, $.SmartForm.RequestParameters);
            paramData.ActionName = $.SmartForm.BaseActionName;
            var queryParams = { PostData: JSON.stringify(paramData) };
            return queryParams;
        },


        ResponseHandler: function (res) {
            if (res == void 0) return;
            var that = this;
            var $target = $("#" + that.TableId);
            if (!$target) return;
            var returnData = res.StartFormResponse.ReturnData;
            if (returnData == undefined) {
                return;
            }
            if (that.pageNumber > 1 && returnData.BOListData && returnData.BOListData.total == 0) {
                $target.bootstrapTable("refreshOptions", { pageNumber: that.pageNumber - 1 });
            }
            if (!that.$PageNext) {
                var $pageBar = $("#bar-" + that.TableId);
                that.$PageNext = $pageBar.find(".Page_Num_Next");
                that.$PagePre = $pageBar.find(".Page_Num_Pre");
                that.$PageIndex = $pageBar.find(".Page_Index");
                that.$PageCount = $pageBar.find(".Page_Count");
                that.$PageTotal = $pageBar.find(".page-total");
                that.$PageSize = $pageBar.find(".Page_Per_Size");
                that.$PageNext.on('click', function (e) {
                    that.pageNumber++;
                    $target.bootstrapTable("nextPage");
                    $target.bootstrapTable("refresh");
                    return false;
                });
                that.$PagePre.on('click', function () {
                    that.pageNumber--;
                    $target.bootstrapTable("prevPage");
                    $target.bootstrapTable("refresh");
                    return false;
                });

                var PageTimeout;
                that.$PageIndex.on("keyup", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val().replace(/[^\d]/g, '');
                    v = v == "" ? 0 : parseInt(v);
                    v = v >= that.Count ? that.Count : v;
                    if (v == 0) return;
                    $(this).val(v);
                    PageTimeout = setTimeout(function () {
                        v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                        if (v != that.pageNumber) {
                            $target.bootstrapTable("selectPage", v);
                            that.pageNumber = v;
                            $target.bootstrapTable("refresh");
                        }
                        PageTimeout = null;
                    }, 600);
                });
                that.$PageIndex.on("blur", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val();
                    v = v == "" || v == "0" ? 1 : parseInt(v);
                    $(this).val(v);
                    if (v != that.pageNumber) {
                        $target.bootstrapTable("selectPage", v);
                        that.pageNumber = v;
                        $target.bootstrapTable("refresh");
                    }
                });
                $pageBar.on("click", "li>a", function () {
                    var size = parseInt($(this).text());
                    that.$PageSize.html(size);
                    that.pageSize = size;
                    $target.bootstrapTable("refreshOptions", { pageSize: size });
                })
            }
            if (that.pageNumber == undefined) {
                that.pageNumber = 1;
            }
            if (that.pageSize == undefined) {
                that.pageSize = 10;
            }
            that.$PageIndex.val(that.pageNumber);
            that.Count = Math.ceil(returnData.BOListData.total / that.pageSize);
            that.$PageCount.html(that.Count);
            that.$PageTotal.html("共" + returnData.BOListData.total + "条");
            if (that.pageNumber <= 1) {
                that.$PagePre.addClass("disable").attr("disabled", true);
            } else {
                that.$PagePre.removeClass("disable").attr("disabled", false);
            }
            if (that.Count == 0 || that.pageNumber == that.Count) {
                that.$PageNext.addClass("disable").attr("disabled", true);
            } else {
                that.$PageNext.removeClass("disable").attr("disabled", false);
            }
            //end
            return returnData.BOListData;
        },

        InitServer: function () {
            var that = this;
            $.SmartForm.PostForm("LoadBoListHeader", {
                BOSchemaCode: that.BOSchemaCode,
                AssociationCode: this.SchemaCode
            }, function (SmartFormResult) {
                if (SmartFormResult.Successful) {
                    that.InitDisplay.apply(that, [SmartFormResult.ReturnData]);
                } else {
                    that.ShowEmptyList.apply(that, [SmartFormResult.Errors]);
                }
            });
        },

        RenderTable: function (columns, actions, sortInfo) {
            var that = this;
            that.TableId = "FormTable_" + $.IGuid();
            that.$Table = $("<table id='" + that.TableId + "' class='table table-bordered table-hover table-condensed'>");//.addClass("table table-bordered table-hover table-condensed");
            //表格体
            that.$TableBody = $("<tbody>");
            that.$Table.append(that.$TableBody);
            var pagerStr = '<div class="table-page" id="bar-' + that.TableId + '">' +
                '<div class="page-index">' +
                '<input type="text" value="1" class="Page_Index" />/<label class="Page_Count">1</label>' +
                '</div>' +
                '<div class="btn-group table-page_ButtonGroup" style="width: 160px;">' +
                '<button class="btn Page_Num_Pre">上一页</button>' +
                '<button class="btn Page_Num_Next">下一页</button>' +
                '</div>' +
                '<div class="page-size dropup">' +
                '<button class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                '<span class="Page_Per_Size">' + 10 + '</span>' +
                '<i class="fa fa-angle-down"></i>' +
                '</button>' +
                '<ul class="dropdown-menu">' +
                '<li><a>10</a></li>' +
                '<li><a>50</a></li>' +
                '<li><a>100</a></li>' +
                '<li><a>150</a></li>' +
                '<li><a>200</a></li>' +
                '</ul>' +
                '</div>' +
                '<div class="page-total">共0条</div>' +
                '</div>';

            $(that.Element).append(that.$Table).append(pagerStr);
            var sortBy = "CreatedTime";
            var sortDirection = "desc";
            if (sortInfo != void 0) {
                sortBy = sortInfo.SortBy;
                sortDirection = sortInfo.SortDirection == 0 ? "asc" : "desc";
            }
            that.$Table.attr({
                "data-cache": "false",
                "data-toggle": "table",
                "data-click-to-select": "false",
                "data-url": $.SmartForm.AjaxUrl,
                "data-side-pagination": "server",
                "data-pagination": "true",
                "data-page-list": "[10,50,100,150,200]",
                "data-sort-name": sortBy,
                "data-sort-order": sortDirection,
                "data-method": "post",
                "data-boschema": "schema",
                "data-row-attributes": "GetRowAttributes" + that.Element.id,
                "data-query-params": "GetSheetBoListParams" + that.Element.id,
                "data-response-handler": "ResponseHandler" + that.Element.id,
                "data-content-type": "application/x-www-form-urlencoded"
            });

            window["GetRowAttributes" + that.Element.id] = function (row, index) { return that.GetRowAttributes.apply(that, [row, index]) };
            window["GetSheetBoListParams" + that.Element.id] = function (params) { return that.GetSheetBoListParams.apply(that, [params, that]) };
            window["ResponseHandler" + that.Element.id] = function (params) { return that.ResponseHandler.apply(that, [params]) };
            window["OperateFormatter" + that.Element.id] = function (value, row, index) { return that.OperateFormatter.apply(that, [value, row, index]); }

            that.$Table.off("mouseenter.BoList BoList.list").on("mouseenter.BoList mouseleave.BoList", 'td', function () {
                var $tableTip = $(".table-tip"), $TextLabel = $(".TextLabel");
                $tableTip.length == 0 && ($tableTip = $('<div class="table-tip" style="display: none;"></div>').appendTo($("body")));
                $TextLabel.length == 0 && ($TextLabel = $('<label class="TextLabel" style="display: none; opacity:0; position:fixed;"></label>').appendTo($("body")));
                var $that = $(this);
                $TextLabel.text($that.text());

                if ($TextLabel.width() > $that.width()) {
                    var offset = $that.offset();
                    $tableTip.text($that.text());
                    var left = offset.left + ($that.outerWidth() - $tableTip.outerWidth()) / 2 - $(window).scrollLeft();
                    left = left < 0 ? 1 : left;
                    $tableTip.css({ left: left, bottom: $(window).height() - offset.top + 6 + $(window).scrollTop() }).toggle();
                }
            });
            that.InitHeader(columns);
            var actionPanelId = that.InitAction(actions);
            this.$Table.attr("data-toolbar", "#" + actionPanelId);
            that.$Table.bootstrapTable({ TargetId: that.TableId });
        },

        //获取时间轴参数
        GetTimelineParams: function (params) {
            if (params == void 0) {
                params = {};
            }
            var paramData = $.extend(params, {
                Command: "LoadBoListData",
                BOSchemaCode: this.BOSchemaCode,
                SchemaCode: this.SchemaCode,
                AssociationCode: this.SchemaCode,
                BizObjectId: this.Element.id,
                Mode: "View",
                sort: "CreatedTime",
                order: "desc",
                pageNum: this.pageNumber,
                limit: this.pageNumber,
                offset: this.pageSize * (this.pageNumber - 1)
            }, $.SmartForm.RequestParameters);
            paramData.ActionName = $.SmartForm.BaseActionName;
            var queryParams = { PostData: JSON.stringify(paramData) };
            //return params;
            return queryParams;
        },

        //渲染时间轴
        RenderTimeline: function (actions) {
            var that = this;
            that.pageSize = 10;
            that.pageNumber = 1;
            //渲染actions
            var actionPanelId = that.InitAction(actions);
            var $actionPanel = $("#" + actionPanelId);
            $actionPanel.height(50);

            var $container = $("<div></div>");

            var $window = $(window);
            var h_window = $window.height();
            var $sheetContent = $("#SheetContent");
            var $tab = $sheetContent.find(".nav-tabs-wrap");
            var h_tab = $tab.height();
            var $nav = $("nav.sheet-navbar.navbar.navbar-default.navbar-fixed-top");
            var h_nav = $nav.height();

            var $sheetContainer = $(".container-fluid.sheet_container");
            $sheetContainer.css("padding", "0 40px 0");

            var h_container = h_window - h_nav - parseInt($nav.css("margin-top")) - parseInt($nav.css("margin-bottom"));
            h_container -= (h_tab + parseInt($tab.css("margin-top")) + parseInt($tab.css("margin-bottom")));
            h_container -= parseInt($sheetContainer.css("padding-bottom"));
            h_container -= 10;
            h_container -= $actionPanel.height();
            h_container -= (parseInt($actionPanel.css("margin-top")) + parseInt($actionPanel.css("margin-bottom")));

            //容器高度=window高度-nav高度-navmargin-tab高度-tabmargin-sheetContainer的padding;
            $container.css("height", h_container);
            $(that.Element).append($container);
            that.FormlistTimeline = $container.FormlistTimeline({
                url: $.SmartForm.AjaxUrl,
                sheetUrl: "/Form/DefaultSheet/",
                sheetCode: that.BOSchemaCode,
                axis: "CreatedTime",
                gotop: true,
                queryParams: that.GetTimelineParams(),
                loaded: function () { },
                handler: function (data) {
                    //处理返回的数据，封装成Timeline需要的格式
                    var returnData = {};
                    returnData["Successful"] = data.Successful;
                    returnData["DataCount"] = data.ReturnData.StartFormResponse.ReturnData.BOListData.total;
                    returnData["ReturnData"] = data.ReturnData.StartFormResponse.ReturnData.BOListData.rows;
                    return returnData;
                },
                loaded: function (Timeline) {
                    that.LoadedTimeline(Timeline);
                }
            });

            //绑定滚动事件
            that.FormlistTimeline.$template.scroll({ Timeline: that.FormlistTimeline }, function (e) {
                var scrollTop = $(this).scrollTop();
                var clientHeight = this.clientHeight;
                var scrollHeight = this.scrollHeight;
                if (scrollTop + clientHeight >= scrollHeight) {
                    e.data.Timeline.scrollLoad(function (timeline) {
                        var $template = timeline.$template;
                        $template.find(".rightContainer").attr("style", "padding-left:30px !important");
                    });
                }
                //滚动高度超过500就显示“返回顶部”
                if (scrollTop > 500) {
                    e.data.Timeline.$top.show(500);
                } else {
                    e.data.Timeline.$top.hide(500);
                }
            });
        },

        //时间轴加载完成后执行的事件
        LoadedTimeline: function (timeline) {
            //调整样式
            var $template = timeline.$template;
            $template.height("100%");
            $template.find(".rightContainer").attr("style", "padding-left:30px !important");
        },

        //渲染显示模式，是用列表显示还是用时间轴显示
        InitDisplay: function (data) {
            var that = this;
            var columns = [];
            var actions = null;
            var sortInfo = {};
            if (data) {
                that.DisplayMode = data.DefaultDisplayMode;
                columns = data.Columns;
                actions = data.Actions;
                sortInfo["SortBy"] = data.SortBy;
                sortInfo["SortDirection"] = data.SortDirection;
            }

            //var defaultDisplayMode = data.DefaultDisplayMode;
            that.RenderTable(columns, actions, sortInfo);
            //if (defaultDisplayMode == that.ListViewDisplayMode.Timeline) {
            //    that.RenderTimeline(actions);
            //} else {
            //    that.RenderTable(columns, actions);
            //}
        },

        InitHeader: function (Headers) {
            if (!Headers) return;
            var $Tr = $('<tr><th data-formatter="OperateFormatter' + this.Element.id + '" data-field="Name">名称</th></tr>');
            var trStr = '<tr><th data-formatter="OperateFormatter' + this.Element.id + '" data-field="Name">名称</th>';
            for (var key in Headers) {
                trStr += "<th style='min-width:100px;' data-switchable='true' data-field='" + key + "' data-visible='" + Headers[key].Visible + "' data-sortable='" + Headers[key].Sortable + "'>" + Headers[key].DisplayName + "</th>";
            }
            trStr += '</tr>';
            this.$Table.append($("<thead>").append(trStr));
        },

        InitAction: function (Actions) {
            if (!Actions) return;
            var ActionPanelId = $.IGuid();
            this.$ActionPanel = $("<div id='" + ActionPanelId + "' class='btn-toolbar' role='toolbar'>");//.attr("id", ActionPanelId).addClass("btn-toolbar").attr("role", "toolbar");
            for (var key in Actions) {
                //如果是时间轴模式只支持"新增"
                if (this.DisplayMode == this.ListViewDisplayMode.Timeline && key != "Create") {
                    continue;
                }
                // 暂时屏蔽掉导入导出删除按钮
                if (key == "Import" || key == "Export" || key == "Remove") {
                    continue;
                }
                if (Actions[key].Icon == "fa-plus") {
                    Actions[key].Icon = "icon-dian";
                }

                var $Button = $("<div class='btn btn-default' id='" + key + "'><i class='fa " + Actions[key].Icon + "'></i>" + Actions[key].DisplayName + "</div>");//.addClass("btn btn-default").attr("id", key).append("<i class='fa " + Actions[key].Icon + "'></i>" + Actions[key].DisplayName);
                this.$ActionPanel.append($("<div class='btn-group' role='group'>").append($Button));
                $Button.click(this, function (e) {
                    e.data.DoAction.apply(e.data, [$(this).attr("id")]);
                });
            }
            //this.$Table.attr("data-toolbar", "#" + ActionPanelId);
            $(this.Element).append(this.$ActionPanel);
            return ActionPanelId;
        },

        DoAction: function (ActionName) {
            var that = this;
            switch (ActionName) {
                case "Create":
                    //that.CreateBO.apply(that);
                    that.CreateBO();
                    break;
                case "Remove":
                    //that.RemoveBOs.apply(that);
                    that.RemoveBOs();
                    break;
            }
        },

        CreateBO: function () {
            var that = this;
            $.ISideModal.Show(that.SheetUrl + "?SchemaCode=" + that.BOSchemaCode + "&" + this.SchemaCode + "=" + this.ResponseContext.BizObjectId + "&" + this.SchemaCode + "_Name=" + encodeURIComponent(this.ResponseContext.Name), "", function () {
                that.ReloadList();
            });
        },

        OperateFormatter: function (value, row, index) {
            var that = this;
            window.EditBORow = function (SchemaCode, ObjectId, InstanceId, AssociationCode, TargetObjectId) {
                $.ISideModal.Show(that.SheetUrl + "?SchemaCode=" + SchemaCode + "&BizObjectId=" + ObjectId + "&" + AssociationCode + "=" + TargetObjectId, "", function () {
                    that.ReloadList.apply(that);
                });
            };
            if (value == null || value.trim() == "") value = "--";
            return "<a class='edit ml10' href=\"javascript:EditBORow(\'" + that.BOSchemaCode + "\',\'" + row.ObjectId + "\',\'" + row.WorkflowInstanceId + "\',\'" + that.SchemaCode + "\',\'" + that.ResponseContext.BizObjectId + "\')\"' >" + value.replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</a>";
        },

        RemoveBOs: function () {
            var that = this;
            var rows = that.$Table.bootstrapTable("getSelections");
            if (rows.length == 0) {
                //$.IShowWarn("提示", "没有选中任何行");
                Message.warning({
                    content: "没有选中任何行",
                    duration: 3
                });
                return;
            }

            if (confirm("确定删除" + rows.length + "行数据")) {
                var ObjectIds = {};
                var ids = Array();
                for (var i = 0; i < rows.length; i++) {
                    ObjectIds[rows[i].ObjectId] = rows[i].ObjectId;
                    ids.push(rows[i].ObjectId);
                }
                $.ajax({
                    type: "GET",
                    url: "/Home/RemoveAppData",
                    data: { SchemaCode: that.BOSchemaCode, ObjectIds: ObjectIds },
                    //async: false,//同步执行
                    dataType: "json",
                    success: function (result) {
                        if (result) {
                            //$("#tb_Applist").bootstrapTable("remove", { field: "ObjectId", values: ids });
                            that.ReloadList.apply(that);
                        }
                    },
                    error: function (e) {
                        //$.IshowError("错误", e.responseText);
                        Message.error({
                            content: e.responseText,
                            duration: 3
                        });
                    }
                });
            }
        },

        ReloadList: function () {
            var that = this;
            //由于关联列表还没有支持时间轴模式，所以刷新时候都是刷新列表
            that.$Table.bootstrapTable("refresh");
            return;
            if (that.DisplayMode == that.ListViewDisplayMode.List) {
                that.$Table.bootstrapTable("refresh");
            } else {
                that.pageNumber = 1;
                that.FormlistTimeline.reload({
                    queryParams: that.GetTimelineParams()
                }, function (timeline) {
                    that.LoadedTimeline(timeline);
                });
            }
        },

        ShowEmptyList: function (Errors) {
            $(this.Element).html("");
            if (Errors) {
                var errorStr = '';
                for (var i = 0; i < Errors.length; i++) {
                    errorStr += "<span>" + Errors[i] + "</span>";
                    //$(this.Element).append("<span>" + Errors[i] + "</span>");
                }
                $(this.Element).append(errorStr);
            } else {
                $(this.Element).append("<span>当前列表为空!</span>");
            }
            $(this.Element).css({
                "text-align": "center",
                "color": "gainsboro",
                "border": "1px dotted",
                "padding-top": "10px",
                "padding-bottom": "10px"
            });
        }
    });
})(jQuery);;
(function ($) {
    $.fn.FormMap = function () {
        return $.ControlManager.Run.call(this, "FormMap", arguments);
    };

    // 构造函数
    $.Controls.FormMap = function (element, ptions, sheetInfo) {
        $.Controls.FormMap.Base.constructor.call(this, element, ptions, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormMap.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }

            this.Address = "";
            this.Point = { lat: 0, lng: 0 };


            //渲染界面
            this.HtmlRender();
            ////初始化默认值
            this.InitValue();
            //绑定事件
            this.BindEvent();

        },

        //界面渲染
        HtmlRender: function () {
            if (!this.Editable) {
                this.$Input = $("<pre style='border:none'>");//.css("border", "none");
                this.$InputBody.append(this.$Input);
            } else {
                this.$Input = $("<div>").css({ "padding-top": "5px", "padding-bottom": "5px", "border": "1px solid #ddd", "height": "30px", "border-bottom": 0, "border-radius": "3px 3px 0 0" });
                this.$InputBody.append(this.$Input);
                if (this.Value) {
                    var loc = JSON.parse(this.Value);
                    this.Address = loc.address;
                }
                this.$Input.append(" " + this.Address);
            }

            if (this.Editable) {
                // 悬浮 iframe
                this.$IframePanel = $("<div style='border:1px solid #ddd;height:280px'>");//.height("280px");
                this.$Iframe = $("<iframe style='height:100%;width:100%' frameborder='0' >");//.height("100%").width("100%").attr("frameborder", 0);
                this.$Iframe.attr("src", "/Content/Mobile/Template/LocationMap.html?ismobile=false&rowid=" + (this.BizObjectId || "") + "&datafield=" + this.DataField + "&Range=" + this.Range + "&Address=" + this.Address);
                this.$IframePanel.append(this.$Iframe);
                this.$InputBody.append(this.$IframePanel);
            }
        },

        BindEvent: function () {
            var that = this;
            $(this.$Input).change(function () {
                that.Validate();
            });
        },
        InitValue: function () {
            if (this.Value) {
                try {
                    this.SetValue(JSON.parse(this.Value));
                } catch (ex) { }
            } else if (this.Editable) {
                this.$Input.append("pc端定位不准确，请到移动端进行定位！");
            }
        },

        SetValue: function (data) {
            this.Address = data.Address;
            this.Point = data.Point;
            this.$Input.html("");
            if (this.Address) {
                this.$Input.append(" " + this.Address);
            }
            this.OnChange();
        },

        GetValue: function () {
            var pointData = {
                Address: this.Address || "",
                Point: this.Point || ""
            };
            return JSON.stringify(pointData);
        },
        SetReadonly: function (flag) {
            if (flag) {
                this.$Iframe && this.$Iframe.hide();
            } else {
                this.$Iframe && this.$Iframe.show();
            }
        },
        Validate: function () {
            var val = this.GetValue();
            var address = $.parseJSON(val).Address;
            if (this.Required && address.trim() == "") {
                this.AddInvalidText(this.$Input, "必填");
                return false;
            }
            this.RemoveInvalidText(this.$Input);
            return true;
        },
        //返回数据值
        SaveDataField: function () {
            if (this.Validate()) {
                var result = {};
                if (!this.Visible) return result;
                var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
                if (!oldresult) {
                    return {};
                }

                if (("" + oldresult.Value) != this.GetValue()) {
                    result[this.DataField] = this.GetValue();
                    return result;
                }

                return {};
            }
        }
    });
})(jQuery);;;
// SheetSns控件
; (function ($) {
    //控件执行
    $.fn.FormSns = function () {
        return $.ControlManager.Run.call(this, "FormSns", arguments);
    };

    // 构造函数
    $.Controls.FormSns = function (element, options, sheetInfo) {
        $.Controls.FormSns.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormSns.Inherit($.Controls.BaseControl, {
        // post发布成功后执行
        AfterPost: function () { },
        //控件渲染函数
        Render: function () {
            //渲染前端
            this.HtmlRender();
        },

        //渲染前端
        HtmlRender: function () {
            // Create模式时，不显示
            if (this.ResponseContext == null || this.ResponseContext.IsCreateMode) {
                $(this.Element).css({ "display": "none" });
                return false;
            }

            // 将控件的Title隐藏
            $(this.Element).find("." + this.Css.ControlTitle).hide();

            var that = this;

            this.$panel = $('<div class="panel panel-info"><div class="panel-heading"><span class="fa fa-comments"></span>动态</div></div>');
            this.$panelBody = $('<div class="panel-body"></div>');
            this.$panel.append(this.$panelBody);

            this.$addPost = $('<div class="row" style="margin-bottom:3px;"><div class="col-sm-12"><textarea class="form-control" rows="3" placeholder="内容"></textarea></div></div><div class="row" style="margin-bottom:10px;"><div class="col-sm-11 text-left" id="fileUploader"></div><div class="col-sm-1 text-right"><button type="button" class="btn btn-success btn-xs">&nbsp;发布&nbsp;</button></div></div>');

            this.$filePicker = $('<a href="javascript:;" id="filePicker"><span class="fa fa-paperclip"></span>文件(最多支持9个，单个大小不能超过5M)</a>');
            this.$fileList = $('<div id="fileList" class="uploader-list"></div>');
            this.$addPost.find("#fileUploader").append(this.$filePicker).append(this.$fileList);

            this.$panelBody.append(this.$addPost);

            this._initWebUploader();
            // 控件所属panel的id
            var panelid = this.$InputBody.closest(".tab-pane").attr("id");
            /*
             * WebUploader按钮或者其父级被设置成display:none，flash会停止运行，导致失效
             * 在控件所属所属panel显示后，重新初始化WebUploader
             */
            $(".nav-tabs  a[href='#" + panelid + "']").on("shown.bs.tab", function () {
                that._initWebUploader();
            });

            // ctrl+enter快捷发布Post
            this.$postTextarea = this.$addPost.find("textarea");
            this.$postTextarea.keydown(function (e) {
                if (e.ctrlKey && e.which === 13) {
                    // 防止重复提交
                    if (!that.$btnPost.prop("disabled")) {
                        that.$btnPost.trigger("click");
                    }
                }
            });
            // 发布Post
            this.$btnPost = this.$addPost.find("button");
            this.$btnPost.click(function () {
                var $textarea = that.$postTextarea;
                var txt = $.trim($textarea.val());
                if (txt === "") {
                    $textarea.focus();
                    //$.IShowWarn("提示", "请填写动态内容");
                    Message.warning({
                        content: "请填写动态内容",
                        duration: 3
                    });
                }
                else {
                    // 设置发布按钮不可用
                    that.$btnPost.prop("disabled", true);

                    that.fileIds = "";
                    // 上传图片，文件
                    that.picUploader.upload();
                }
            });
            this._initPost();
            $(this.$InputBody).append(this.$panel);
        },

        _initPost: function () {
            var that = this;
            var params = { PostData: JSON.stringify({ ActionName: 'GetSNSPost', bizObjectId: $.SmartForm.ResponseContext.BizObjectId, flag: $.IGuid() }) };
            that.Ajax(
                "/Form/OnAction",
                "POST",
                params,
                function (data) {
                    if (data.Successful) {
                        that._initPostCallBack.apply(that, [data.ReturnData.snsItemList]);
                    }

                });
        },

        _initPostCallBack: function (data) {
            var that = this;
            if (data) {
                that.$panelBody.find(".panel").remove();
                $.each(data, function (p, post) {
                    if (post.ItemType == 1) {//post
                        var $postPanel = $('<div class="panel panel-success"></div>');
                        var $postPanelHeader = $('<div class="panel-heading"></div>');
                        var $postPanelFooter = $('<div class="panel-footer"></div>');
                        //var $postPanelBody = $('<div class="panel-body"><div class="media"><div class="media-left"><img class="media-object img-circle" src="' + post.ProfilePhotoUrl + '" alt="" style="width: 40px;margin-top:10px;" /></div><div class="media-body" style="width:100%;"><h5><a href="javascript:;">' + post.Name + '</a>&nbsp;' + post.FormatCreatedTime + '</h5>' + that._changeTextareaValue(post.Text) + '</div></div><div class="row" style="margin-bottom:3px;"><div class="col-sm-12"><textarea class="form-control" rows="2" placeholder="快速回复"></textarea></div></div><div class="row"><div class="col-sm-12 text-right"><button type="button" class="btn btn-success btn-xs">&nbsp;回复&nbsp;</button></div></div></div>');
                        var $postPanelBody = $('<div class="panel-body"></div>');
                        var $postPanelBody_media = $('<div class="media"><div class="media-left"><img class="media-object img-circle" src="' + post.ProfilePhotoUrl + '" alt="" style="width: 40px;margin-top:10px;" /></div><div class="media-body" style="width:100%;"><h5><a href="javascript:;">' + post.Name + '</a>&nbsp;' + post.FormatCreatedTime + '</h5>' + that._changeTextareaValue(post) + '</div></div>');
                        var $postPanelBody_textarea = $('<div class="row" style="margin-bottom:3px;"><div class="col-sm-12"><textarea class="form-control" rows="2" placeholder="快速回复"></textarea></div></div>');
                        var $postPanelBody_button = $('<div class="row"><div class="col-sm-12 text-right"><button type="button" class="btn btn-success btn-xs">&nbsp;回复&nbsp;</button></div></div></div>');

                        var $postPanelBody_comment = $('<div style="margin-left:30px;margin-top:10px;">');
                        //加载回复
                        for (var i = 0; i < post.Comments.length; i++) {
                            var comment = post.Comments[i];
                            var $commentPanelBody = $('<div class="panel-body" style="padding:10px"></div>').attr('id', comment.ObjectId).attr('data-user', comment.UserID);
                            //   var $commentPanelBody_media = $('<div class="comment"><div class="media-left"><img class="media-object img-circle" src="' + comment.ProfilePhotoUrl + '" alt="" style="width: 40px;margin-top:10px;" /></div><div class="media-body" style="width:100%;"><h5><a href="javascript:;">' + comment.Name + '</a>&nbsp;回复了&nbsp;<a href="javascript:;">' + post.Name + '</a>&nbsp;' + comment.FormatCreatedTime + '</h5>' + that._changeTextareaValue(comment.Text) + '</div></div>');
                            var $commentPanelBody_media = $('<div class="comment"><div class="media-left"><img class="media-object img-circle" src="' + comment.ProfilePhotoUrl + '" alt="" style="width: 40px;margin-top:10px;" /></div><div class="media-body" style="width:100%;"><h5><a href="javascript:;">' + comment.Name + '</a>&nbsp;回复了&nbsp;<a href="javascript:;">' + post.Name + '</a>&nbsp;' + comment.FormatCreatedTime + '</h5>' + that._changeTextareaValue(comment) + '</div></div>');
                            $($commentPanelBody).append($commentPanelBody_media);
                            $($postPanelBody_comment).append($commentPanelBody);
                            if (comment.UserID == $.SmartForm.ResponseContext.Originator) {
                                var $remove = $("<div class='media-right'><button type='button' class='btn btn-link'>删除</button></div>");
                                $($commentPanelBody_media).append($remove);
                                $($remove).find('button').click(function () {
                                    var btn = this;
                                    var commentBox = $(this).parent().parent().parent();
                                    var commentId = $(commentBox).attr('id');
                                    var userId = $(commentBox).attr('data-user');
                                    var params = { PostData: JSON.stringify({ ActionName: 'DeleteComment', commentId: commentId, userID: userId }) };
                                    that.Ajax(
                                        '/Form/OnAction',
                                        'POST',
                                        params,
                                        function (data) {
                                            if (data.Successful) {
                                                $('#' + commentId).remove();
                                                //$.IShowSuccess("提示", "删除成功");
                                                Message.success({
                                                    content: '删除成功',
                                                    duration: 3
                                                });
                                                return;
                                            }
                                            else {
                                                //$.IShowError("提示", "删除失败");
                                                Message.error({
                                                    content: "删除失败",
                                                    duration: 3
                                                });
                                            }
                                        }
                                    )
                                });
                            }
                        }

                        $($postPanelBody).append($postPanelBody_media).append($postPanelBody_textarea).append($postPanelBody_button).append($postPanelBody_comment);

                        if (post.IsMyItem && (typeof post.LinkContent == "undefined" || post.LinkContent == "")) {
                            var $btnContainer = $("<div class='media-right'><button type='button' class='btn btn-link'>删除</button></div>");
                            $postPanelBody.find(".media").append($btnContainer);
                            $btnContainer.find("button").click(function () {
                                var params = { PostData: JSON.stringify({ ActionName: 'DeletePost', postId: post.ObjectId, createdBy: post.CreatedBy }) };
                                that.Ajax(
                                    "/Form/OnAction",
                                    "POST",
                                    params,
                                    function (data) {
                                        if (data.Successful) {
                                            $postPanel.remove();
                                            //$.IShowSuccess("提示", "删除成功");
                                            Message.success({
                                                content: '删除成功',
                                                duration: 3
                                            });
                                            return;
                                        }
                                        else {
                                            //$.IShowError("提示", "删除失败");
                                            Message.error({
                                                content: "删除失败",
                                                duration: 3
                                            });
                                        }
                                    });
                            });

                        }

                        // 文件
                        if (post.Files) {
                            var $fileContainer = $("<div></div>");
                            $.each(post.Files, function (f, file) {
                                var fileUrl = "/Form/GetPostFile/?postId=" + file.PostId + "&fileId=" + file.ObjectId;
                                if (file.ContentType.indexOf("image") > -1 && file.ThumbnailUrl) {
                                    $fileContainer.append("<a target='_blank' style='cursor:pointer;' href='" + fileUrl + "'><div class='file-item thumbnail'><img src='" + file.ThumbnailUrl + "'><div class='info' title='" + file.FileName + "'>" + file.FileName + "</div></div></a>");
                                }
                                else {
                                    $fileContainer.append("<a target='_blank' style='cursor:pointer;' href='" + fileUrl + "'><div class='file-item thumbnail text-center'><span class='fa fa-file-text-o fa-4x' style='margin-top:5px;'></span><div class='info' title='" + file.FileName + "'>" + file.FileName + "</div></div></a>");
                                }
                            });
                            $postPanelBody.find(".media .media-body").append($fileContainer);
                        }

                        var $commentTextarea = $postPanelBody.find("textarea");
                        var $btnComment = $postPanelBody.find("button");
                        // ctrl+enter快速回复
                        $commentTextarea.keydown(function (e) {
                            if (e.ctrlKey && e.which === 13) {
                                // 防止重复提交
                                if (!$btnComment.prop("disabled")) {
                                    $btnComment.trigger("click");
                                }
                            }
                        });
                        //回复post
                        $btnComment.click(function () {
                            var txt = $.trim($commentTextarea.val());
                            if (txt === "") {
                                $commentTextarea.focus();
                                //$.IShowWarn("提示", "请填写回复内容");
                                Message.warning({
                                    content: "请填写动态内容",
                                    duration: 3
                                });

                            }
                            else {
                                $btnComment.prop("disabled", true);
                                //$.post("/Sheet/AddSNSComment/", { text: txt, targetId: post.ObjectId }, function (data) {
                                //    $btnComment.prop("disabled", false);
                                //    if (data.IsScuccess) {
                                //        that._initPost();
                                //    }
                                //}, "json");
                                var params = { PostData: JSON.stringify({ ActionName: 'AddSNSComment', text: txt, targetId: post.ObjectId }) };
                                that.Ajax(
                                    "/Form/OnAction/",
                                    "POST",
                                    params,
                                    function (data) {
                                        $btnComment.prop("disabled", false);
                                        if (data.Successful) {
                                            that._initPost();
                                        }
                                    });
                            }
                        });

                        if (post.Comments) {
                            $.each(post.Comments, function (c, comment) {
                                var replyTo = comment.ReplyToUser ?
                                    ('@<a href="javascript:;">' + comment.ReplyToUser + '</a>&nbsp;') : '';

                                //    var $comment = $('<div class="media"><div class="media-left"><img class="media-object img-circle" src="' + comment.ProfilePhotoUrl + '" alt="" style="width:30px;margin-top:10px;" /></div><div class="media-body commentBody" style="width:100%;"><h5><a href="javascript:;">' + comment.Name + '</a>&nbsp;' + comment.FormatCreatedTime + '</h5>' + replyTo + that._changeTextareaValue(comment.Text) + '</div><div class="media-right"></div></div>');
                                var $comment = $('<div class="media"><div class="media-left"><img class="media-object img-circle" src="' + comment.ProfilePhotoUrl + '" alt="" style="width:30px;margin-top:10px;" /></div><div class="media-body commentBody" style="width:100%;"><h5><a href="javascript:;">' + comment.Name + '</a>&nbsp;' + comment.FormatCreatedTime + '</h5>' + replyTo + that._changeTextareaValue(comment) + '</div><div class="media-right"></div></div>');
                                if (comment.IsMyComment) {
                                    var $btnDelete = $('<button type="button" class="btn btn-link">删除</button>');
                                    $comment.find(".media-right").append($btnDelete);
                                    $btnDelete.click(function () {
                                        var params = { PostData: JSON.stringify({ ActionName: 'DeleteComment', commentId: comment.ObjectId, userID: comment.UserID }) };
                                        that.Ajax(
                                            "/Form/OnAction",
                                            "POST",
                                            params,
                                            function (data) {
                                                if (data.Successful) {
                                                    $comment.remove();
                                                    //$.IShowSuccess("提示", "删除成功");
                                                    Message.success({
                                                        content: '删除成功',
                                                        duration: 3
                                                    });
                                                }
                                                else {
                                                    //$.IShowError("提示", "删除失败");
                                                    Message.error({
                                                        content: "删除失败",
                                                        duration: 3
                                                    });
                                                }
                                            });
                                    });
                                    return;
                                }

                                var $btnReply = $('<button type="button" class="btn btn-link">回复</button>');
                                $comment.find(".media-right").append($btnReply);

                                $postPanelFooter.append($comment);

                                //回复comment
                                $btnReply.click(function () {
                                    $comment.find(".commentBody > .commentReply").remove();
                                    var $commentReply = $('<div class="commentReply"><textarea class="form-control" rows="2"></textarea><div class="row" style="padding-top:3px;"><div class="col-sm-12 text-right"><div class="btn-group" role="group"><button type="button" class="btn btn-default btn-xs btnCancel">&nbsp;取消&nbsp;</button><button type="button" class="btn btn-success btn-xs btnReply">&nbsp;回复&nbsp;</button></div></div></div></div>');
                                    $comment.find(".commentBody").append($commentReply);

                                    var $textarea = $commentReply.find("textarea");
                                    $textarea.focus();

                                    $commentReply.find(".btnCancel").click(function () {
                                        $commentReply.remove();
                                    });

                                    var $btnReply = $commentReply.find(".btnReply");

                                    // ctrl+enter快捷回复comment
                                    $textarea.keydown(function (e) {
                                        if (e.ctrlKey && e.which === 13) {
                                            // 防止重复提交
                                            if (!$btnReply.prop("disabled")) {
                                                $btnReply.trigger("click");
                                            }
                                        }
                                    });
                                    $btnReply.click(function () {
                                        var txt = $.trim($textarea.val());
                                        if (txt === "") {
                                            $textarea.focus();
                                            //$.IShowWarn("提示", "请填写评论内容");
                                            Message.warning({
                                                content: "请填写评论内容",
                                                duration: 3
                                            });

                                        }
                                        else {
                                            $btnReply.prop("disabled", true);
                                            var params = {
                                                PostData: JSON.stringify({
                                                    ActionName: 'AddSNSComment', replyTo: comment.ObjectId, replyToUserId: comment.UserID,
                                                    schemaCode: $.SmartForm.ResponseContext.SchemaCode,
                                                    bizObjectId: $.SmartForm.ResponseContext.BizObjectId,
                                                    targetId: post.ObjectId, text: $textarea.val()
                                                })
                                            };
                                            that.Ajax(
                                                "/Form/OnAction/",
                                                "POST",
                                                params,
                                                function (data) {
                                                    $btnReply.prop("disabled", false);
                                                    if (data.Successful) {
                                                        that._initPost();
                                                    }
                                                });
                                        }
                                    });
                                });
                            });
                        }
                        $postPanel.append($postPanelHeader).append($postPanelBody).append($postPanelFooter)
                            .appendTo(that.$panelBody);
                    }
                    else { //feed
                        var $feedPanel = $('<div class="panel panel-info"></div>');
                        var $feedPanelHeader = $('<div class="panel-heading"></div>');
                        var $feedPanelBody = $('<div class="panel-body"><div class="row"><div class="col-sm-2 text-center"><img class="media-object img-circle" src="' + post.ProfilePhotoUrl + '" alt="" style="width: 40px;" /></div><div class="col-sm-10"><a href="javascript:;">' + post.Name + '</a><div>' + post.FormatCreatedTime + '</div><p>' + post.Text + '</p></div></div></div>');
                        $feedPanel.append($feedPanelHeader).append($feedPanelBody).appendTo(that.$panelBody);
                    }
                });
            }
        },

        _initWebUploader: function () {
            var that = this;
            // 初始化WebUploader
            this.picUploader = WebUploader.create({
                pick: that.$filePicker,
                //runtimeOrder: "html5",
                swf: "/Scripts/plugins/webuploader/Uploader.swf",
                server: "/Form/UploadFile",
                fileNumLimit: 9,
                fileSizeLimit: 45 * 1024 * 1024, // 45M
                fileSingleSizeLimit: 5 * 1024 * 1024 // 5M
            });
            //限制文件数量和大小信息
            this.picUploader.on('error', function (handler) {
                if (handler == 'Q_EXCEED_NUM_LIMIT') {
                    //$.IShowWarn('最多只能上传9个文件');
                    Message.warning({
                        content: "最多只能上传9个文件",
                        duration: 3
                    });
                } else if (handler == 'Q_EXCEED_SIZE_LIMIT') {
                    //$.IShowWarn('单个附件最大支持5M');
                    Message.warning({
                        content: "单个附件最大支持5M",
                        duration: 3
                    });
                }
            });
            // 当一批文件被加入队列后触发
            this.picUploader.on("filesQueued", function (files) {
                $.each(files, function (f, file) {
                    var $picLi = $("<div id='" + file.id + "' class='file-item thumbnail text-center'><img><div class='info' title='" + file.name + "'>" + file.name + "</div></div>");

                    var $btns = $("<div class='remove'><span class='fa fa-trash-o'></span></div>").appendTo($picLi);
                    $btns.find("span").click(function () {
                        $picLi.remove();
                        // 将文件从队列中移除
                        that.picUploader.cancelFile(file);

                        // Textarea方便快捷添加
                        that.$postTextarea.focus();
                    });

                    var $img = $picLi.find("img");
                    that.$fileList.append($picLi);
                    that.picUploader.makeThumb(file, function (error, src) {
                        if (error) {
                            $img.replaceWith("<span class='fa fa-file-text-o fa-4x' style='margin-top:5px;'></span>");
                            return;
                        }
                        $img.attr("src", src);
                    }, 100, 100);
                });

                // focus到Textarea，方便快捷添加
                that.$postTextarea.focus();
            });

            // 文件上传过程中创建进度条实时显示
            this.picUploader.on("uploadProgress", function (file, percentage) {
                var $li = $("#" + file.id),
                    $percent = $li.find(".progress span");

                if (!$percent.length) {
                    $percent = $('<p class="progress"><span></span></p>').appendTo($li).find("span");
                }

                $percent.css("width", percentage * 100 + "%");
            });

            this.fileIds = ""; // 保存SNSPostFile的ObjectId

            // 文件一个一个上传到服务器
            this.picUploader.on("uploadSuccess", function (file, response) {
                if (response.success) {
                    that.fileIds += (response.fileid + ",");
                }
                that.picUploader.cancelFile(file);
            });

            // 非自动上传，发布post调用upload方法，所有文件上传结束时触发
            this.picUploader.on("uploadFinished", function () {
                var txt = $.trim(that.$addPost.find("textarea").val());
                // 发布分享内容
                var params = {
                    PostData: JSON.stringify({
                        ActionName: 'AddSNSPost', text: txt, fileIds: that.fileIds, schemaCode: $.SmartForm.ResponseContext.SchemaCode,
                        bizObjectId: $.SmartForm.ResponseContext.BizObjectId
                    })
                };

                that.Ajax(
                    "/Form/OnAction/",
                    "POST",
                    params,
                    function (data) {
                        if (data.Successful) {
                            that.$addPost.find("textarea").val("");
                            that.$fileList.empty();
                            that._initPost();

                            // 执行AfterPost方法
                            that.AfterPost.apply(that);
                        }

                        // 重置发布按钮状态
                        that.$btnPost.prop("disabled", false);
                    });
            });
        },

        _changeTextareaValue: function (post) {
            if (post.LinkContent == "" || post.LinkContent == null)
                return (post.Text || "").replace(/\n/g, "<br />");
            else {
                var text = (post.Text || "").replace(/\n/g, "<br />");
                var linkcontent = "";
                try {
                    linkcontent = JSON.parse(post.LinkContent);
                }
                catch (e) { return (post.Text || "").replace(/\n/g, "<br />"); };
                var html = "";
                if (linkcontent.PostType == 0) {
                    html += "<span>创建了</span>";
                }
                else {
                    html += "<span>更新了</span>";
                }
                var url = "/Form/DefaultSheet/{SchemaCode}?SchemaCode={SchemaCode}&BizObjectId={BizObjectId}";
                url = url.replace("{SchemaCode}", linkcontent.SchemaCode).replace("{SchemaCode}", linkcontent.SchemaCode).replace("{BizObjectId}", linkcontent.BizObjectId);
                html += "<a href=\"javascript: $.ISideModal.Show('" + url + "');\">" + linkcontent.DisplayName + ":" + linkcontent.Name + "</a>";
                return html;
            }
        },

        //校验
        Validate: function () {
            return true;
        },

        SaveDataField: function () {
            return {};
        },

        GetValue: function () {
            return "Sns";
        }
    });
})(jQuery);;
(function ($) {
    $.fn.FormSeqNo = function () {
        return $.ControlManager.Run.call(this, "FormSeqNo", arguments);
    };

    // 构造函数
    $.Controls.FormSeqNo = function (element, options, sheetInfo) {
        $.Controls.FormSeqNo.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormSeqNo.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            //渲染Html页面
            this.HtmlRender();

            //Error:新建的话，可以制作默认值 ，非新建设置值加载的值
            if (this.ResponseContext.IsCreateMode) {
                this.SetValue("系统自动生成");
                this.$Input.css({ "color": "#333333", "font-size": "14px" });
            } else {
                if (this.Value) {
                    this.SetValue(this.Value);
                }
                this.$Input.css({ "color": "#000", "font-style": "normal" });
            }

            // 不可编辑
            this.SetReadonly(true);
        },

        //渲染html内容
        HtmlRender: function () {
            this.$Input = $("<pre style='border:none'>");
            this.$InputBody.append(this.$Input);
        },

        //设置值
        SetValue: function (v) {
            this.Value = v.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            this.$Input.html(this.Value);
            this.OnChange();
        },

        GetValue: function () {
            if (!this.Editable) {
                if (this.ResponseContext.IsCreateMode) {
                    return "";
                } else {
                    return this.Value;
                }
            }
            else {
                return this.$Input.val().trim();
            }
        },

        GetText: function () {
            return this.GetValue();
        },

        //设置只读
        SetReadonly: function (v) {
            if (v) {
                this.$Input.prop("readonly", "readonly");
            }
            else {
                this.$Input.removeProp("readonly");
            }
        },

        //返回数据值
        SaveDataField: function () {
            return {};
        }
    });
})(jQuery);;
//地区选择
(function ($) {
    $.fn.FormAreaSelect = function () {
        return $.ControlManager.Run.call(this, "FormAreaSelect", arguments);
    };

    // 构造函数
    $.Controls.FormAreaSelect = function (element, options, sheetInfo) {
        $.Controls.FormAreaSelect.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormAreaSelect.Inherit($.Controls.BaseControl, {
        //控件渲染函数
        Render: function () {
            this.IsInGridView = !$.isEmptyObject(this.ObjectId);
            //获取数据源
            this.FormAreaSelectSourceDataUrl = "/Form/OnAction";
            // this.FormAreaSelectSourceDataUrl = "/act/app/loadAreasData"
            this.adcodeName = "adcode";
            this.DetailName = "Detail";
            this.SpecialKey = {
                139000: true,
                419000: true,
                429000: true,
                469000: true
            }//在国家统计局内虚拟的省直辖市

            this.SpecialName = ["北京市市辖区", "天津市市辖区", "上海市市辖区"];

            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }

            //加载地区数据
            this.LoadAreasData();

            //渲染Html页面
            this.HtmlRender();

            //绑定事件
            this.BindEvent();

            //Error:新建的话，可以制作默认值 ，非新建设置值加载的值
            if (this.Value) {
                this.SetValue(this.Value);
            }

            // 不可编辑
            if (!this.Editable) {
                this.SetReadonly(true);
            } else {
                this.RenderDropDownList();
            }
            this.RenderFinished = true;
        },
        RenderDropDownList: function () {
            if (!$(this.Element).attr("data-export") == "export") {
                this.$Province.DropDownList();
                this.$City.DropDownList();
                this.$Town.DropDownList();
            }
        },


        //渲染html内容
        HtmlRender: function () {
            var that = this;
            if (that.Editable) {
                $(this.Element).addClass("SheetAreaSelect");
                this.$SelectWrap = $("<div class='AreaSelectWrap'>");
                this.$Province = $("<select class='province form-control' style='display:none;'><option value=''>省份</option></select>");
                this.$ProvinceText = $('<span type="text" class="form-control style="width:100 %;">省份</span>');
                this.$City = $("<select class='city form-control' style='display:none;'><option value=''>市级</option></select>");
                this.$CityText = $('<span type="text" class="form-control style="width:100 %;" >市级</span>');
                this.$Town = $("<select class='town form-control' style='display:none;'><option value=''>县级</option></select>");
                this.$TownText = $('<span type="text" class="form-control style="width:100 %;" >县级</span>');
                this.$Detail = $("<textarea rows='2' maxlength='100' placeholder='详细地址' class='area-item detail form-control'>");

                if (this.AreaMode == "P-C-T") {
                    this.$SelectWrap.append($("<div class='area-item province'>").append(this.$ProvinceText).append(this.$Province))
                        .append($("<div class='area-item city'>").append(this.$CityText).append(this.$City))
                        .append($("<div class='area-item town'>").append(this.$TownText).append(this.$Town));
                } else if (this.AreaMode == "P-C") {
                    this.$SelectWrap.append($("<div class='area-item province' style='width:48%;'>").append(this.$ProvinceText).append(this.$Province))
                        .append($("<div class='area-item city'  style='width:49%;'>").append(this.$CityText).append(this.$City));
                } else if (this.AreaMode == "P") {
                    this.$SelectWrap.append($("<div class='area-item province' style='width:100%;'>").append(this.$ProvinceText).append(this.$Province));
                }
                if (this.ShowDetailAddr) {
                    this.$SelectWrap.append(this.$Detail);
                }

                var options = "";
                if ($.SmartForm.AddressCache && $.SmartForm.AddressCache.ProvincesOption) {
                    var options = $.SmartForm.AddressCache.ProvincesOption.children().clone();
                    that.$Province.empty().append(options);
                } else {
                    for (var i = 0; i < that.ProvincesData.length; i++) {
                        options += "<option value='" + that.ProvincesData[i] + "'>" + that.AddressCache[that.ProvincesData[i]] + "</option>";
                    }
                    $.SmartForm.AddressCache.ProvincesOption = that.$Province;
                    that.$Province.append(options);
                }

                this.$InputBody.css({ "line-height": 1, "margin-bottom": "3px" }).append(this.$SelectWrap);
                if (this.IsQueryControl) {
                    $(this.Element).find("span.ControlTitle").remove();
                    this.$InputBody.attr("class", "");
                }
            } else {
                this.$Input = $("<pre class='input-pre'>");
                this.$InputBody.append(this.$Input);
            }
        },
        //绑定事件
        BindEvent: function () {
            if (!this.Editable) return;
            var that = this;
            //省份变更
            this.$Province.off("change.SheetAreasProvince").on("change.SheetAreasProvince", this, function (e) {
                var that = e.data;
                var province = $(this).val();
                var citys = that.CitiesData[province];
                that.$CityText.text("市级");
                that.$TownText.text("县级");
                that.$City.empty().append("<option value=''>市级</option>");
                that.$Town.empty().append("<option value=''>县级</option>");
                if (citys != void 0) {
                    var options = '';
                    for (var i = 0; i < citys.length; i++) {
                        options += "<option value='" + citys[i] + "'>" + that.AddressCache[citys[i]] + "</option>";
                    }
                    that.$City.append(options);
                    that.$City.DropDown && that.$City.DropDown.Refresh();
                    that.$Town.DropDown && that.$Town.DropDown.Refresh();
                }
                if (that.AreaMode.indexOf("-C") > -1) {
                    that.RenderSelect(that.$City, true);
                }
                if (that.AreaMode.indexOf("-T") > -1) {
                    that.RenderSelect(that.$Town, true);
                }
                that.ValueChange();
                that.Required && ((this.value != "" && this.value != '省级') && that.$SelectWrap.removeAttr("style"));
            });
            //市级变更
            this.$City.off("change.SheetAreasCity").on("change.SheetAreasCity", this, function (e) {
                var that = e.data;
                var city = $(this).val();
                var towns = that.TownsData[city];
                that.$TownText.text("县级");
                that.$Town.empty().append("<option value=''>县级</option>");
                if (towns != void 0) {
                    var options = "";
                    for (var i = 0; i < towns.length; i++) {
                        options += "<option value='" + towns[i] + "'>" + that.AddressCache[towns[i]] + "</option>";
                    }
                    that.$Town.append(options);
                    that.$Town.DropDown && that.$Town.DropDown.Refresh();
                }
                if (that.AreaMode.indexOf("-T") > -1) {
                    that.RenderSelect(that.$Town, true);
                }
                that.ValueChange();
                that.Required && ((this.value != "" && this.value != '市级') && that.$SelectWrap.removeAttr("style"));
            });
            this.$Town.off("change.SheetAreasTown").on("change.SheetAreasTown", this, function (e) {
                var that = e.data;
                that.ValueChange();
                that.Required && ((this.value != "" && this.value != '县级') && that.$SelectWrap.removeAttr("style"));
            });
            this.$Detail.off("change.SheetAreasDetail").on("change.SheetAreasDetail", this, function (e) {
                var that = e.data;
                that.ValueChange();
            });

            //click时渲染控件
            if (this.AreaMode.indexOf("P") > -1) {
                this.$ProvinceText.off("click").on("click", function (e) {
                    that.RenderSelect(that.$Province);
                });
            }
            if (this.AreaMode.indexOf("C") > -1) {
                this.$CityText.off("click").on("click", function (e) {
                    that.RenderSelect(that.$City);
                });
            }
            if (this.AreaMode.indexOf("T") > -1) {
                this.$TownText.off("click").on("click", function (e) {
                    that.RenderSelect(that.$Town);
                });
            }
        },

        RenderSelect: function (select, resetOptions) {
            var that = this;
            var $select = $(select);
            var $selectP = $select.parent();
            resetOptions = resetOptions === true ? true : false;
            if (!$select.attr("data-render") && !resetOptions) {
                $select.attr("data-render", "true");
                var $ListContainer = $('<div class="list list-container" style="position: fixed;z-index: 99999;"></div>');
                var $DropList = $('<ul class="drop-list form-query-dropdown" style="width: 100%;"></ul>');
                //添加搜索框
                var $SearchInput = $('<input type="text" class="dropdownlist_search" style="width:100%;height:32px;padding-left:12px;" placeholder="搜索"></input> ');
                var $SearchLi = $("<li data-type='search' style='border-bottom:1px solid #d7d5d5'></li>").append($SearchInput);
                var $DropListDetail = $('<ul class="drop-combox droplistdetail" style="list-style:none;left:0;padding-left:0;max-height:200px;overflow:auto;"></ul>');
                var $li = $("<li></li>").append($DropListDetail);
                $DropList.append($SearchLi).append($li);
                //添加选项
                var options = $select.children();
                for (var i = 0, len = options.length; i < len; i++) {
                    var o = options[i];
                    $li = $("<li></li>")
                        .append($('<a tabindex="' + i + '"><label class=" form-query-item-label drop-item-btn" data-val="' + o.value + '">' + o.text + '</label></a>'));
                    $DropListDetail.append($li);
                }
                $select.parent().append($ListContainer.append($DropList));
            }
            else if ($select.attr("data-render") && resetOptions) {
                //联动重绘下拉选项
                var options = $select.children();
                $selectP.find(".droplistdetail").empty();
                for (var i = 0, len = options.length; i < len; i++) {
                    var o = options[i];
                    $li = $("<li></li>")
                        .append($('<a tabindex="' + i + '"><label class=" form-query-item-label drop-item-btn" data-val="' + o.value + '">' + o.text + '</label></a>'));
                    $selectP.find(".droplistdetail").append($li);
                }
                return;
            }
            else if (!this.RenderFinished) {
                return;
            }
            var position = $selectP.offset();
            var scrollTop = $(document).scrollTop();
            var width = $(select).prev().outerWidth();
            width = width < 130 ? 130 : width;
            var left = position.left;
            if (this.IsInGridView) { //子表位置调整
                var GridViewWrap = $select.closest(".GridViewWrap");
                var l = GridViewWrap.offset().left + GridViewWrap.width();
                if (position.left + width > l) {
                    left = l - width - 15;
                }
            }

            var top = position.top;
            var $parentModal = $(that.Element).closest("div.modal-dialog");
            if ($parentModal != undefined && $parentModal.length > 0) {
                left -= $parentModal.offset().left;
                top -= $parentModal.offset().top;
            }

            $select.parent().find(".list-container")
                .css("left", left)
                .css("top", top + $selectP.height() - scrollTop)
                .width(width);

            $selectP.find(".drop-list").show();
            setTimeout(function () {
                $selectP.find(".dropdownlist_search").focus();
                //点击DropDown以外区域隐藏,需要排除搜索框
                var eventName = "click.DropdownList" + (that.DataField || $(that.Element).attr("id"));
                //关闭
                $(document).off(eventName).on(eventName, that, function (e) {
                    var target = e.target;
                    var ctrl = e.data;
                    if ($select.prev() != target && $selectP.find($(target)).length == 0
                        && !$(target).hasClass("dropdownlist_search")) {
                        $selectP.find(".drop-list").hide();
                        $(document).off(eventName);
                        $(document).off("scroll.FormDropDownList");
                    }
                });
                //滚动
                $(document).off("scroll.FormDropDownList").on("scroll.FormDropDownList", function () {
                    var position = $selectP.offset();
                    var scrollTop = $(document).scrollTop();
                    $selectP.find(".list-container").css("top", position.top + $selectP.height() - scrollTop);
                });
                //选中
                $selectP.find(".list-container").off('click.select').on("click.select", "label", function (e) {
                    var v = $(this).data().val + "";
                    var t = $(this).text();
                    $selectP.find(".drop-list").hide();
                    $selectP.find("span[type='text']").text(t);
                    $select.val(v);
                    $select.trigger("change");
                });
                //搜索
                $selectP.find("input").off("input.search").on("input.search", function () {
                    var options = $selectP.find(".droplistdetail").find("label")
                    var searchKey = this.value || "";
                    for (var i = 1, len = options.length; i < len; i++) {
                        var o = options[i];
                        if (searchKey == "") {
                            $(o).show();
                        } else if ($(o).text().indexOf(searchKey) == -1) {
                            $(o).hide();
                        } else {
                            $(o).show();
                        }
                    }
                });
            }, 0);
        },

        ValueChange: function () {
            this.OnChange();
            this.Validate();
        },

        IsJsonString: function (str) {
            var JSON_START = /^\[|^\{(?!\{)/;
            var JSON_ENDS = {
                '[': /]$/,
                '{': /}$/
            };
            var jsonStart = str.match(JSON_START);
            return jsonStart && JSON_ENDS[jsonStart[0]].test(str);
        },

        //清空地址数据
        ClearValue: function () {
            if (this.Editable) {
                this.$Province.empty().append("<option value=''>省份</option>");
                var that = this;
                setTimeout(function () {
                    var options = "";
                    for (var i = 0; i < that.ProvincesData.length; i++) {
                        options += "<option value='" + that.ProvincesData[i] + "'>" + that.AddressCache[that.ProvincesData[i]] + "</option>";
                        //that.$Province.append("<option>" + that.ProvincesData[i] + "</option>");
                    }
                    that.$Province.append(options);
                }, 0);
                this.$City.empty().append("<option value=''>市级</option>");
                this.$Town.empty().append("<option value=''>县级</option>");
                this.$Province.val("");
                this.$ProvinceText.text("省份");
                this.$City.val("");
                this.$CityText.text("市级");
                this.$Town.val("");
                this.$TownText.text("县级");
                this.$Detail.val('');
            } else {
                this.$Input.text('').attr("data-val", "");
            }
        },

        SetValue: function (v) {
            if (v == null || v.trim() == "") {
                this.ClearValue();
                return;
            }
            if (this.IsJsonString(v)) {
                v = v.replace(/[\r\n]/g, "");//去掉换行
                v = v.replace(/\\/g, "\\\\");// \
                v = v.replace(/\t/g, "");
                v = JSON.parse(v);
                if (v["Detail"]) {
                    if (v[this.adcodeName] && v[this.adcodeName].trim() == "" && v["Detail"].trim() == "") {
                        this.ClearValue();
                        return;
                    }
                } else {
                    if (v[this.adcodeName] && v[this.adcodeName].trim() == "") {
                        this.ClearValue();
                        return;
                    }
                }
            }
            var areas = [];
            var areasDisplay = [];

            var adcode = v[this.adcodeName] || "";
            var citykey = adcode.substr(2, 2);
            var townkey = adcode.substr(4, 2);
            var provinceValue = "";
            var citykeyValue = "";
            var townkeyValeu = "";
            if (citykey == "00") {
                provinceValue = adcode;
            }
            else if (townkey == "00") {
                provinceValue = adcode.substring(0, 2) + "0000";
                citykeyValue = adcode.substring(0, 4) + "00";
            }
            else {
                provinceValue = adcode.substring(0, 2) + "0000";
                citykeyValue = adcode.substring(0, 4) + "00";
                townkeyValeu = adcode;
            }
            if ($.isPlainObject(v)) {
                areas.push(provinceValue);
                if (this.SpecialKey[citykeyValue]) {
                    areas.push(townkeyValeu);
                }
                else {
                    areas.push(citykeyValue);
                }
                areas.push(townkeyValeu);
                areas.push(v[this.DetailName] ? v[this.DetailName] : "");
                areasDisplay.push(this.AddressCache[provinceValue] ? this.AddressCache[provinceValue] : "");
                if (this.SpecialKey[citykeyValue]) {
                    areasDisplay.push(this.AddressCache[townkeyValeu] ? this.AddressCache[townkeyValeu] : "");
                }
                else {
                    areasDisplay.push(this.AddressCache[citykeyValue] ? this.AddressCache[citykeyValue] : "");
                }

                areasDisplay.push(this.AddressCache[townkeyValeu] ? this.AddressCache[townkeyValeu] : "");
                areasDisplay.push(v[this.DetailName] ? v[this.DetailName] : "");

            }
            if (!this.Editable) {
                this.$Input.text(areasDisplay.join(" "));
                this.$Input.attr("data-val", adcode + ";" + v[this.DetailName]);
                return;
            }

            var arr = this.$InputBody.find("select");
            this.$InputBody.find("textarea").val(areas[3]);
            $(arr[0]).val(provinceValue);
            this.$ProvinceText.text(areasDisplay[0] || "省份");
            this.$Province.change();
            if (arr.length > 1) {
                $(arr[1]).val(citykeyValue);
                this.$CityText.text(areasDisplay[1] || "市级");
                this.$City.change();
            }

            if (arr.length > 2) {
                $(arr[2]).val(townkeyValeu);
                this.$TownText.text(areasDisplay[2] || "县级");
                this.$Town.change();
            }

            //判断传入省份和字典中是否匹配
            this.OnChange();
            if (this.Editable) {
                this.RenderDropDownList();
            }
        },

        GetValue: function () {
            var province = "";
            var city = "";
            var town = "";
            var adcode = "";
            var adname = "";
            var detail = "";
            if (this.Editable) {
                var area = this.$InputBody.find("select");
                var detail = "";
                var tempdetail = this.$InputBody.find("textarea").val();
                if (tempdetail) {
                    detail = tempdetail;
                }

                if ($(area).eq(0).length > 0 && ($(area).eq(0).val() != "") && ($(area).eq(0).val() != null)) {
                    province = $(area).eq(0).val();
                    adcode = province;
                }


                if ($(area).length > 1 && ($(area).eq(1).val() != "") && ($(area).eq(1).val() != null)) {
                    city = $(area).eq(1).val();
                    adcode = city;
                }


                if ($(area).length > 2 && ($(area).eq(2).val() != "") && ($(area).eq(2).val() != null)) {
                    town = $(area).eq(2).val();
                    adcode = town;
                }
                if (province == "" && city == "" && town == "" && detail == "") {
                    return "";
                }
            } else {
                var areas = '';
                if (this.$Input && this.$Input.attr("data-val")) {
                    areas = this.$Input.attr("data-val").split(";");
                }
                adcode = areas[0] ? areas[0] : "";
                detail = areas[1] ? areas[1] : "";
                if (adcode == "" && detail == "") {
                    return "";
                }
                //分割adcode到province,city,town
                town = adcode;
                province = adcode.substring(0, 2) + '0000';
                city = adcode.substring(0, 4) + '00';
            }

            if (town != "") {
                adcode = town;
            }
            adname = (this.AddressCache[province] ? (this.AddressCache[province] + " ") : "") + (this.AddressCache[city] ? (this.AddressCache[city] + " ") : "") + (this.AddressCache[town] ? (this.AddressCache[town]) : "");
            return JSON.stringify({ "adcode": adcode.trim(), "adname": adname, Detail: detail.trim() });
        },

        GetText: function () {
            var value = this.GetValue();
            if (value == "") return ""
            var value = JSON.parse(value);
            return value.adname + value.Detail;
        },

        //校验
        Validate: function () {
            var val = this.GetValue();
            if (this.Required && val != null && val.trim() == "") {
                this.AddInvalidText(this.$InputBody, "必填");
                return false;
            }
            this.RemoveInvalidText(this.$InputBody);
            return true;
        },

        //设置只读
        SetReadonly: function (v) {
            if (!this.Editable) { return; }
            if (v) {
                this.$ProvinceText.off("click");
                this.$CityText.off("click");
                this.$TownText.off("click");

                //this.$InputBody.find("select").attr("disabled", "disabled").css("color", "#808080");;
                this.$InputBody.find("textarea").attr("disabled", "disabled").css({ "color": "#808080", "background": "#fff" });
            }
            else {
                //this.$InputBody.find("select").removeAttr("disabled").css("color", "#000");
                this.$InputBody.find("textarea").attr("disabled", "disabled").css({ "color": "#000", "background": "#fff" });
                this.BindEvent();
            }
        },

        //返回数据值
        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;
            var oldresult = $.Controls.GetSheetDataItem(this.DataField, $(this.Element));
            if (!oldresult) {
                return {};
            }
            if (("" + oldresult.Value) != this.GetValue()) {
                result[this.DataField] = this.GetValue().trim();
                return result;
            }
            return {};
        },

        //加载地区数据
        LoadAreasData: function () {
            var that = this;
            //初步阶段，地区数据是写死js的，后续做了主数据，这些数据会从服务端读取
            if ($.SmartForm && $.SmartForm.AddressCache) {
                this.AddressCache = $.SmartForm.AddressCache.All;
                this.ProvincesData = $.SmartForm.AddressCache.ProvincesData;
                this.CitiesData = $.SmartForm.AddressCache.CitiesData;
                this.TownsData = $.SmartForm.AddressCache.TownsData;
            } else if (localStorage.getItem("AddressCache") && !$.isEmptyObject(JSON.parse(localStorage.getItem("AddressCache")))) {
                //只作在研发环境无外网时构造数据
                this.AddressCache = JSON.parse(localStorage.getItem("AddressCache"));

                //this.AddressCache = JSON.parse(AddressCache);

                this.LoadAreasDatadata();
                $.SmartForm.AddressCache = {};
                $.SmartForm.AddressCache.All = this.AddressCache;
                $.SmartForm.AddressCache.ProvincesData = this.ProvincesData;
                $.SmartForm.AddressCache.CitiesData = this.CitiesData;
                $.SmartForm.AddressCache.TownsData = this.TownsData;
            }
            else {
                this.AddressCache = allAddress;
                this.LoadAreasDatadata();
                localStorage.setItem("AddressCache", JSON.stringify(this.AddressCache));
                $.SmartForm.AddressCache = {};
                $.SmartForm.AddressCache.All = this.AddressCache;
                $.SmartForm.AddressCache.ProvincesData = this.ProvincesData;
                $.SmartForm.AddressCache.CitiesData = this.CitiesData;
                $.SmartForm.AddressCache.TownsData = this.TownsData;
                // var params = { "ActionName": "GetAddressSourceData" }
                /* this.Ajax(
                    that.FormAreaSelectSourceDataUrl,
                    "POST",
                    {
                        PostData: JSON.stringify(params)
                    },
                    function (data) {
                        that.AddressCache = data.ReturnData["AddressData"];
                        that.LoadAreasDatadata();
                        localStorage.setItem("AddressCache", JSON.stringify(that.AddressCache));
                        $.SmartForm.AddressCache = {};
                        $.SmartForm.AddressCache.All = that.AddressCache;
                        $.SmartForm.AddressCache.ProvincesData = that.ProvincesData;
                        $.SmartForm.AddressCache.CitiesData = that.CitiesData;
                        $.SmartForm.AddressCache.TownsData = that.TownsData;
                    }, false); */
            }

        },
        LoadAreasDatadata: function () {
            var that = this;
            that.ProvincesData = [];
            that.CitiesData = {};
            that.TownsData = {};
            for (var i = 11; i < 99; i++) {
                var provinceKey = i + "0000";
                if (!that.AddressCache[provinceKey])
                    continue;

                that.ProvincesData.push(provinceKey);

                that.CitiesData[provinceKey] = [];
                for (var j = 1; j < 99; j++) {
                    var cityKey = j + "";
                    if (j < 10) {
                        cityKey = "0" + cityKey;
                    }
                    var cityKeyFull = i + cityKey + "00";
                    if (!that.AddressCache[cityKeyFull])
                        continue;
                    if (!this.SpecialKey[cityKeyFull]) {
                        that.CitiesData[provinceKey].push(cityKeyFull);
                        that.TownsData[cityKeyFull] = [];
                        for (var k = 1; k < 99; k++) {
                            var townKey = k + "";
                            if (k < 10) {
                                townKey = "0" + townKey;
                            }
                            var townKeyFull = i + cityKey + townKey;
                            if (!that.AddressCache[townKeyFull])
                                continue;
                            that.TownsData[cityKeyFull].push(townKeyFull);
                        }
                    }
                    else {
                        that.TownsData[cityKeyFull] = [];
                        for (var k = 1; k < 99; k++) {
                            var townKey = k + "";
                            if (k < 10) {
                                townKey = "0" + townKey;
                            }
                            var townKeyFull = i + cityKey + townKey;
                            if (!that.AddressCache[townKeyFull])
                                continue;
                            that.TownsData[cityKeyFull].push(townKeyFull);
                            that.TownsData[townKeyFull] = [];
                            that.TownsData[townKeyFull].push(townKeyFull);
                            that.CitiesData[provinceKey].push(townKeyFull);
                        }
                    }
                }
            }
        }
    });
})(jQuery);;
// FormTaskTips控件 caojp
; (function ($) {
    //控件执行
    $.fn.FormTaskTips = function () {
        return $.ControlManager.Run.call(this, "FormTaskTips", arguments);
    };

    // 构造函数
    $.Controls.FormTaskTips = function (element, options, sheetInfo) {
        $.Controls.FormTaskTips.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormTaskTips.Inherit($.Controls.BaseControl, {
        // post发布成功后执行
        AfterPost: function () { },
        //控件渲染函数
        Render: function () {
            //渲染前端
            this.HtmlRender();
        },

        HtmlRender: function () {
            $(this.Element).attr("id", $.IGuid());
            this.InitTable();
        },
        InitTable: function () {
            var that = this;

            //table
            var ID = $.IGuid();
            this.$Table = $('<table id="' + ID + '" class="table table-bordered table-hover table-condensed" data-content-type="application/x-www-form-urlencoded"></table>');
            //this.$Table = $("<table>");
            var params = {
                ActionName: "GetTaskTipByCode",
                code: $.SmartForm.ResponseContext.BizObjectId
            };
            this.$Table.attr({
                "data-cache": "false",
                "data-toggle": "table",
                "data-click-to-select": "false",
                "data-url": "/FormTaskTips/OnAction?PostData=" + JSON.stringify(params),//ActionName=GetTaskTipByCode&code=" + $.SmartForm.ResponseContext.BizObjectId,
                "data-side-pagination": "client",
                "data-pagination": "true",
                "data-page-list": "[10,50,100,150,200]",
                "data-sort-name": "",
                "data-sort-order": "",
                "data-method": "post",
                "data-align": "center",
                "data-sort-name": "AlertTime"
            });
            //this.$Table.attr("data-sort-order", "AlertTime");

            //this.$Table.attr("data-content-type", "application/x-www-form-urlencoded");
            //thead
            var theadStr = '<thead>' +
                '<tr>' +
                '<th data-field="Sender" data-visible=false>Sender</th>' +
                '<th data-field="ObjectId" data-visible=false>ObjectId</th>' +
                '<th data-field="Name" data-formatter="OperateFormatter_TaskName' + this.Element.id + '">任务名称</th>' +
                '<th style="width:200px;" data-field="Summary" data-width=300>内容</th>' +
                '<th data-field="TaskState" data-formatter="OperateFormatter_TaskState' + this.Element.id + '">状态</th>' +
                '<th data-field="ReminderType" data-width=80 data-formatter="OperateFormatter_ReminderType' + this.Element.id + '">提醒类型</th>' +
                '<th data-field="AlertTime" data-width=150 data-formatter="OperateFormatter_AlertTime' + this.Element.id + '">提醒时间</th>' +
                '<th data-field="UserName" data-formatter="OperateFormatter_UserName' + this.Element.id + '">指派人员</th>' +
                '<th data-field="UserId" data-visible=false>UserId</th>' +
                '<th data-field="Action" data-formatter="OperateFormatter_Action' + this.Element.id + '" data-events="TaskTipActionEvents">操作</th>' +
                '</tr>' +
                '</thead>';

            this.$Table.append(theadStr);

            //tbody
            this.$TableBody = $('<tbody>');
            this.$Table.append(this.$TableBody);
            $(this.Element).append(this.$Table);
            var pagerStr = '<div class="table-page" id="bar-' + ID + '">' +
                '<div class="page-index">' +
                '<input type="text" value="1" class="Page_Index" />/<label class="Page_Count">1</label>' +
                '</div>' +
                '<div class="btn-group table-page_ButtonGroup" style="width: 160px;">' +
                '<button class="btn Page_Num_Pre">上一页</button>' +
                '<button class="btn Page_Num_Next">下一页</button>' +
                '</div>' +
                '<div class="page-size dropup">' +
                '<button class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">' +
                '<span class="Page_Per_Size">10</span>' +
                '<i class="fa fa-angle-down"></i>' +
                '</button>' +
                '<ul class="dropdown-menu">' +
                '<li><a>10</a></li>' +
                '<li><a>50</a></li>' +
                '<li><a>100</a></li>' +
                '<li><a>150</a></li>' +
                '<li><a>200</a></li>' +
                '</ul>' +
                '</div>' +
                '<div class="page-total">共0条</div>' +
                '</div>';
            $(this.Element).append(pagerStr);
            //toolbar
            this.$Toolbar = $('<div class="btn-toolbar" role="toolbar" id="toolbar_tasktips">');
            this.$Btn = $('<div class="btn btn-create"><i class="fa icon-increase"></i>新建</div>');
            this.$Toolbar.append(this.$Btn);
            this.$Btn.click(function () {
                $.ISideModal.Show('/FormTaskTips/CreateTaskTip?SchemaCode=' + $.SmartForm.ResponseContext.SchemaCode + '&TargetId=' + $.SmartForm.ResponseContext.BizObjectId, '', function () {
                    that.$Table.bootstrapTable('refresh');
                });
            });
            $(this.Element).append(this.$Toolbar);
            this.$Table.attr('data-toolbar', '#toolbar_tasktips');
            this.$Table.bootstrapTable({
                TargetId: ID,
                responseHandler: that.ResponseHandler
            });
            //this.$Table.find('th').attr('data-formatter', 'OperateFormatter' + this.Element.id);
            //window["OperateFormatter" + this.Element.id] = function (value, row, index, field) { return that.OperateFormatter.apply(that, [value, row, index, field]); }
            window["OperateFormatter" + this.Element.id] = function (value, row, index) { return that.OperateFormatter(value, row, index); }
            window["OperateFormatter_TaskName" + this.Element.id] = function (value, row, index) { return that.OperateFormatter_TaskName(value, row, index); }
            window["OperateFormatter_TaskState" + this.Element.id] = function (value, row, index) { return that.OperateFormatter_TaskState(value, row, index); }
            window["OperateFormatter_ReminderType" + this.Element.id] = function (value, row, index) { return that.OperateFormatter_ReminderType(value, row, index); }
            window["OperateFormatter_AlertTime" + this.Element.id] = function (value, row, index) { return that.OperateFormatter_AlertTime(value, row, index); }
            window["OperateFormatter_UserName" + this.Element.id] = function (value, row, index) { return that.OperateFormatter_UserName(value, row, index); }
            window["OperateFormatter_Action" + this.Element.id] = function (value, row, index) { return that.OperateFormatter_Action(value, row, index); }
            window["ResponseHandler" + this.Element.id] = function (params) { return that.ResponseHandler(params); }
            //OperateFormatter需要优化，之前传入field取不到数据
            window["TaskTipActionEvents"] = {
                'click .ExecuteTask': function (e, value, row, index) {
                    if (row.TaskState == 1) {
                        //$.IShowSuccess('该提醒已完成，无需再次确认!');
                        Message.success({
                            content: '该提醒已完成，无需再次确认!',
                            duration: 3
                        });
                        return;
                    }
                    var param = {
                        //Command: 'DoAction',
                        ObjectId: row.ObjectId,
                        UserId: row.UserId,
                        ActionName: "ExecuteTask"
                    };
                    $.post('/FormTaskTips/OnAction', { PostData: JSON.stringify(param) }, function (data) {
                        if (data.Successful) {
                            row.TaskState = 1;
                            that.$Table.bootstrapTable('updateRow', { index: index, row: row });
                            that.$Table.bootstrapTable("refresh");
                        } else {
                            //$.IShowError(data.info);
                            Message.error({
                                content: data.info,
                                duration: 3
                            });
                        }
                    }, 'json');
                },
                'click .RemoveTask': function (e, value, row, index) {
                    $.IConfirm('提示', '确定要删除当前提醒吗?', function (data) {
                        if (data) {
                            var param = {
                                ObjectId: row.ObjectId,
                                ActionName: "RemoveTask"
                            };
                            $.post('/FormTaskTips/OnAction', { PostData: JSON.stringify(param) }, function (ret) {
                                if (ret.Successful) {
                                    //that.$Table.bootstrapTable('remove', { field: 'ObjectId', values: row.ObjectId });
                                    that.$Table.bootstrapTable('hideRow', { index: index });
                                    that.$Table.bootstrapTable("refresh");
                                }
                            });
                        }
                    });
                }
            };
        },

        ActionEvents: function () {

        },
        OperateFormatter_TaskName: function (value, row, index) {

            return "<a onclick='RenderPage.call(this,\"" + row.ObjectId + "\")'>" + value + "</a>";
        },
        OperateFormatter_TaskState: function (value, row, index) {
            if (row.ReminderType == 1) {
                if (value == 0) {
                    return "未结束";
                } else {
                    return '<span style="color:#ccc;">已结束</span>';
                }
            } else {
                if (value == 0) {
                    return "未终止";
                } else {
                    return '<span style="color:#ccc;">已终止</span>';
                }
            }
        },
        OperateFormatter_ReminderType: function (value, row, index) {
            if (value == 1) {
                return "定时";
            } else if (value == 2) {
                return "每日";
            } else if (value == 3) {
                return "每周";
            } else if (value == 4) {
                return "每月";
            } else if (value == 5) {
                return "每年";
            }
        },
        OperateFormatter_AlertTime: function (value, row, index) {
            var date = eval("new " + (value.replace(/\//g, "")));
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            var d = date.getDate();
            var h = date.getHours();
            var mm = date.getMinutes();
            var s = date.getSeconds();
            return y + '-' + (m < 10 ? '0' + m : m) + '-' + (d < 10 ? '0' + d : d) + ' ' + (h < 10 ? '0' + h : h) + ':' + (mm < 10 ? '0' + mm : mm) + ':' + (s < 10 ? '0' + s : s);
        },
        OperateFormatter_UserName: function (value, row, index) {
            return "<a  href=\"javascript: $.ISideModal.Show('/Account/Setting/" + row.UserId + "');\"' >" + value + "</a>";
        },
        OperateFormatter_Action: function (value, row, index) {
            var strAction = '';
            if (row.TaskState == 0) {
                if (row.UserId == $.SmartForm.ResponseContext.Originator) {
                    //if (row.TaskState == 1) { return; }
                    if (row.ReminderType == 1) {
                        //定时
                        strAction = '<a class="ExecuteTask fa fa-check">结束</a>';
                    } else {
                        //循环
                        strAction = '<a class="ExecuteTask fa fa-check" >终止</a>';
                    }
                }
                if (row.Sender == $.SmartForm.ResponseContext.Originator) {
                    strAction += '<a class="RemoveTask fa fa-times">删除</a>';
                }
            }
            return strAction;
        },
        OperateFormatter: function (value, row, index) {
            var taskState = '';
            var reminderType = '';
            var alertTime = '';
            var userName = '';
            var strAction = '';
            if (row.ReminderType == 1) {
                if (row.TaskState == 0) {
                    taskState = '未结束';
                } else {
                    taskState = '<span style="color:#ccc;">已结束</span>';
                }
            } else {
                if (row.TaskState == 0) {
                    taskState = '未终止';
                } else {
                    taskState = '<span style="color:#ccc;">已终止</span>';
                }
            }
            switch (row.ReminderType) {
                case 1:
                    reminderType = '定时';
                    break;
                case 2:
                    reminderType = '每日';
                    break;
                case 3:
                    reminderType = '每周';
                    break;
                case 4:
                    reminderType = '每月';
                    break;
                case 5:
                    reminderType = '每年';
                    break;
            }

            var date = eval("new " + (row.AlertTime.replace(/\//g, "")));
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            var d = date.getDate();
            var h = date.getHours();
            var mm = date.getMinutes();
            var s = date.getSeconds();
            alertTime = y + '-' + (m < 10 ? '0' + m : m) + '-' + (d < 10 ? '0' + d : d) + ' ' + (h < 10 ? '0' + h : h) + ':' + (mm < 10 ? '0' + mm : mm) + ':' + (s < 10 ? '0' + s : s);
            userName = "<a  href=\"javascript: $.ISideModal.Show('/Account/Setting/" + row.UserId + "');\"' >" + value + "</a>";


            if (row.TaskState == 0) {
                if (row.UserId == $.SmartForm.ResponseContext.Originator) {
                    //if (row.TaskState == 1) { return; }
                    if (row.ReminderType == 1) {
                        //定时
                        strAction = '<a class="ExecuteTask fa fa-check">结束</a>';
                    } else {
                        //循环
                        strAction = '<a class="ExecuteTask fa fa-check" >终止</a>';
                    }
                }
                if (row.Sender == $.SmartForm.ResponseContext.Originator) {
                    strAction += '<a class="RemoveTask fa fa-times">删除</a>';
                }
            }

            row.TaskState = taskState;
            row.ReminderType = reminderType;
            row.AlertTime = alertTime;
            row.UserName = userName;
            row.Action = strAction;
        },
        ResponseHandler: function (data) {////
            var that = this;
            var $target = $("#" + that["TargetId"]);
            if (!$target) return;
            if (that.pageNumber > 1 && data && data.Tasks.length == 0) {
                $target.bootstrapTable("refreshOptions", { pageNumber: that.pageNumber - 1 });
            }
            if (!that.$PageNext) {
                var $pageBar = $("#bar-" + that["TargetId"]);
                that.$PageNext = $pageBar.find(".Page_Num_Next");
                that.$PagePre = $pageBar.find(".Page_Num_Pre");
                that.$PageIndex = $pageBar.find(".Page_Index");
                that.$PageCount = $pageBar.find(".Page_Count");
                that.$PageTotal = $pageBar.find(".page-total");
                that.$PageSize = $pageBar.find(".Page_Per_Size");
                that.$PageNext.bind('click', function (e) {
                    $target.bootstrapTable("nextPage");
                    $target.bootstrapTable("refresh");
                    return false;
                });
                that.$PagePre.bind('click', function () {
                    $target.bootstrapTable("prevPage");
                    $target.bootstrapTable("refresh");
                    return false;
                });

                var PageTimeout;
                that.$PageIndex.bind("keyup", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val().replace(/[^\d]/g, '');
                    v = v == "" ? 0 : parseInt(v);
                    v = v >= that.Count ? that.Count : v;
                    if (v == 0) return;
                    $(this).val(v);
                    PageTimeout = setTimeout(function () {
                        v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                        $target.bootstrapTable("refresh");
                        PageTimeout = null;
                    }, 600);
                });
                that.$PageIndex.bind("blur", function (e) {
                    PageTimeout && clearTimeout(PageTimeout);
                    PageTimeout = null;
                    var v = $(this).val();
                    v = v == "" || v == "0" ? 1 : parseInt(v);
                    $(this).val(v);
                    v != that.pageNumber && $target.bootstrapTable("selectPage", v);
                    $target.bootstrapTable("refresh");
                });
                $pageBar.on("click", "li>a", function () {
                    var size = parseInt($(this).text());
                    that.$PageSize.html(size);
                    $target.bootstrapTable("refreshOptions", { pageSize: size });
                })
            }
            that.$PageIndex.val(that.pageNumber);
            that.Count = Math.ceil(data.Tasks.length / that.pageSize);
            that.$PageCount.html(that.Count);
            that.$PageTotal.html("共" + data.Tasks.length + "条");
            if (that.pageNumber <= 1) {
                that.$PagePre.addClass("disable").attr("disabled", true);
            }
            else {
                that.$PagePre.removeClass("disable").attr("disabled", false);
            }

            if (that.pageNumber == that.Count) {
                that.$PageNext.addClass("disable").attr("disabled", true);
            }
            else {
                that.$PageNext.removeClass("disable").attr("disabled", false);
            }

            return data.Tasks;
        }
    });

})(jQuery);

function RenderPage(v) {
    $.ISideModal.Show('/FormTaskTips/DetailTask?TaskId=' + v);
};
/*公式型控件*/
(function ($) {
    $.fn.FormFormula = function () {
        return $.ControlManager.Run.call(this, "FormFormula", arguments);
    };

    // 构造函数
    $.Controls.FormFormula = function (element, options, sheetInfo) {
        $.Controls.FormFormula.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormFormula.Inherit($.Controls.BaseControl, {
        //绑定类型为数值时需要使用
        NumberMode: {
            Normal: 0,
            Kbit: 1
        },
        //邦定的类型
        BindControlType: {
            Text: "text",
            DateTime: "datetime",
            Number: "number",
            Bool: "boolean"
        },
        //控件渲染函数
        Render: function () {
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            this.editor = {}
            //是否在子表里面
            this.IsInGridView = !$.isEmptyObject(this.ObjectId);

            //整数最大长度，超过21位的话，就会变成科学计数法
            this.IntegerMaxLength = 15;
            //小数最大长度，超过5位的话，就会变成科学计数法
            this.DecimalMaxLength = 5;
            this.editor = {}
            this.SheetAttachmentHandler = axios.defaults.baseURL + "/Form/SheetAttachmentAction/";
            //渲染Html页面
            this.HtmlRender();


        },



        //渲染html内容
        HtmlRender: function () {
            var that = this
            var index = store.state.listview.currentTabIndex
            this.$Input = $("<div style='height:400px' id='editor" + index + "'" + "></div>");
            this.$InputTemp = $("<div id='editorTest' style='dispaly:none'" + "></div>");
            this.$InputBody.append(this.$Input).append(this.$InputTemp);
            var editorName = "#editor" + index;
            var toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'], //开关按钮
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'script': 'sub' }, { 'script': 'super' }], // 上标/下标
                [{ 'indent': '-1' }, { 'indent': '+1' }], // 减少缩进/缩进
                [{ 'direction': 'rtl' }], // 文本方向
                [{ 'size': ['small', false, 'large', 'huge'] }], // 自定义下拉
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [{ 'color': [] }, { 'background': [] }], //使用主题的默认下拉
                [{ 'align': [] }],
                ['clean'], //移除格式化
                ['image'],
                ['video'],
            ];
            this.editor = new Quill(editorName, {
                modules: {
                    //formula: true, //公式；需要加载cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js
                    //syntax: true,  //高亮；需要加载cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js
                    /*toolbar: {
                        container:"#editor_header"
                    }*/ // 或者 toolbar :'#editor_header'
                    toolbar: toolbarOptions  //指定编辑器操作条
                },
                theme: 'snow', //主题，有两种，snow和bubble
                readOnly: this.Editable == true ? false : true,
                height: '500px',
            });
            //ctg-workflow/Form/SheetAttachmentAction2
            this.editor.container.firstChild.innerHTML = this.Value





        },



        //绑定事件
        BindEvent: function () {
            this.$Input.off("change.FormFormula").on("change.FormFormula", this, function (event) {
                var $this = $(this);
                var that = event.data;
                that.ValChange.apply(that);
            });
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (v === "" && this.GetValue() === "") return;
            //if (this.GetValue() != "" && this.GetValue() == v) return;

            this.editor.container.firstChild.innerHTML = v;

            // if (!this.Editable) {
            //     this.editor.$textElem.attr('contenteditable', false)
            // }
            // else {
            //     this.editor.$textElem.attr('contenteditable', true)
            // }

        },

        GetText: function () {
            return this.GetValue() + "";
        },

        GetValue: function () {


            if (this.editor.container.firstChild.innerHTML == null) {
                return "";
            } else {
                return this.editor.container.firstChild.innerHTML + '';
            }

        },


        //返回数据值
        SaveDataField: function () {
            var result = {};
            if (!this.Visible) return result;
            result[this.DataField] = this.GetValue()
            return result;
        },


        GetNum: function () {
            var v = this.GetValue();
            if ($.isNumeric(v)) {
                return parseFloat(v);
            }
            else {
                return 0.0;
            }
        },
        ConvertValue: function (v) {
            if (this.BindType == this.BindControlType.DateTime) {
                v = new Date(v);
                if (isNaN(v.getFullYear()) || v.getFullYear() < 1971) {
                    v = "";
                } else {
                    v = v.Format('yyyy-MM-dd hh:mm:ss');
                }

            }

            if (this.BindType == this.BindControlType.Bool) {
                v = new Boolean(v).toString();
            }

            if (this.BindType == this.BindControlType.Number) {
                if (!$.isNumeric(v)) {
                    v = "0";
                }
            }

            return v;
        }
    });

})(jQuery);;
/*FormEmbedCode控件*/
(function ($) {
    $.fn.FormEmbedCode = function () {
        return $.ControlManager.Run.call(this, "FormEmbedCode", arguments);
    };

    // 构造函数
    $.Controls.FormEmbedCode = function (element, options, sheetInfo) {
        this.DataField = options.DataField
        $.Controls.FormEmbedCode.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormEmbedCode.Inherit($.Controls.BaseControl, {
        //绑定类型为数值时需要使用
        NumberMode: {
            Normal: 0,
            Kbit: 1
        },
        //邦定的类型
        BindControlType: {
            Text: "text",
            DateTime: "datetime",
            Number: "number",
            Bool: "boolean"
        },
        //控件渲染函数
        Render: function () {
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            $(this.Element).html("")
            const interfaceOptions = $(this.Element).attr('data-interfaceoptions')
            let interfaceObj = {}
            if (interfaceOptions && interfaceOptions.length > 0) {
                interfaceObj = JSON.parse(interfaceOptions)
                this.loadFormEmbedCode(interfaceObj)
            }
            //             $(this.Element).replaceWith(`<div class="row sheet-control form-group formEmbedCode" data-datafield="F00005" data-controlkey="FormTextArea"
            // data-displayname="订单信息" data-width="100%" data-rows="4" data-displayrule="" data-placeholder="" data-description=""
            // data-jcontrolid="jcontrolid-3" data-printable="false">
            // <span class="col-sm-2 col-xs-2 ControlTitle">订单信息</span>
            // <div class="col-sm-10 col-xs-10">
            //     <pre style="white-space: pre-wrap; overflow-wrap: break-word; word-break: break-all;">白云机场-首都国际机场
            // 2018.10.15 09:00-2018.10.15 12:10
            // 机票费用：￥1630.00元
            // 订单已完成</pre>
            // </div>
            // </div><div class="row sheet-control form-group formEmbedCode" data-datafield="F00005" data-controlkey="FormTextArea"
            // data-displayname="订单信息" data-width="100%" data-rows="4" data-displayrule="" data-placeholder="" data-description=""
            // data-jcontrolid="jcontrolid-3" data-printable="false">
            // <span class="col-sm-2 col-xs-2 ControlTitle">订单信息</span>
            // <div class="col-sm-10 col-xs-10">
            //     <pre style="white-space: pre-wrap; overflow-wrap: break-word; word-break: break-all;">白云机场-首都国际机场
            // 2018.10.15 09:00-2018.10.15 12:10
            // 机票费用：￥1630.00元
            // 订单已完成</pre>
            // </div>
            //         </div><style>.formEmbedCode{border-bottom: 1px solid #ddd;}</style>`)
            // this.editor={}
            // //是否在子表里面
            // this.IsInGridView = !$.isEmptyObject(this.ObjectId);

            // //整数最大长度，超过21位的话，就会变成科学计数法
            // this.IntegerMaxLength = 15;
            // //小数最大长度，超过5位的话，就会变成科学计数法
            // this.DecimalMaxLength = 5;
            // this.editor={}
            // //渲染Html页面
            // this.HtmlRender();

            // this.SetValue(this.Value);
        },
        // 加载FormEmbedCode控件
        async loadFormEmbedCode(interfaceObj) {
            if (interfaceObj.id) {
                const result = await HTTP_INTERFACE.getInterfaceData({
                    appId: this.SchemaCode,
                    controlId: this.DataField,
                    appRunId: this.ResponseContext.appRunId
                })
                if (+result.code === 0 && result.datas) {
                    var $el = $('<div class="formEmbedCode" data-datafield="' + this.DataField + '">')
                    $el.html((result.datas + '').replace(/\\n/g, '\n'))
                    $(this.Element).replaceWith($el)
                    //是否可见
                    var $formEmbedCodeEl = $('div.formEmbedCode[data-datafield="' + this.DataField + '"]');
                    if (this.FormEmbedCodeVisible) {
                        $formEmbedCodeEl.show();
                    } else {
                        $formEmbedCodeEl.hide();
                    }
                }
            }
        },
        //渲染html内容
        HtmlRender: function () {
            var index = store.state.listview.currentTabIndex
            this.$Input = $("<div id='editor" + index + "'" + "></div>");

            this.$InputBody.append(this.$Input);
            var editorName = "#editor" + index;
            this.editor = new editor({
                el: document.querySelector(editorName),
                initialEditType: 'markdown',
                previewStyle: 'vertical',
                height: '300px'
            });
            // this.editor.customConfig.menus =[
            //     'bold',  // 粗体
            //     'fontSize',  // 字号
            //     'fontName',  // 字体
            //     'italic',  // 斜体
            //     'underline',  // 下划线
            //     'strikeThrough',  // 删除线
            //     'foreColor',  // 文字颜色
            //     'backColor',  // 背景颜色
            //     'link',  // 插入链接
            //     'justify',  // 对齐方式
            //     'quote',  // 引用
            //     'emoticon',  // 表情
            //     'image',  // 插入图片
            //     'table',  // 表格
            //     'video',  // 插入视频
            //     'code',  // 插入代码
            //     'undo',  // 撤销
            //     'redo'  // 重复
            // ]
            // this.editor.create()//就创建好了编辑器
            //     //说说里面的配置，PC端常用的未以下这些
            //     // 自定义菜单配置---选中你想要的来配置，

            //     //插入链接
            // this.editor.customConfig.linkCheck = function (text, link) {
            //         console.log(text) // 插入的文字
            //         console.log(link) // 插入的链接
            //         return true // 返回 true 表示校验成功
            //         // return '验证失败' // 返回字符串，即校验失败的提示信息
            //     };
            //     //处理图片，我用的是自定义的方式来选图，
            // //如果想完全自己控制图片上传的过程，可以使用如下代码
            // this.editor.customConfig.customUploadImg = function (files, insert) {
            //     // files 是 input 中选中的文件列表
            //     // insert 是获取图片 url 后，插入到编辑器的方法

            //     // 上传代码返回结果之后，将图片插入到编辑器中
            //     insert(imgUrl)
            // }
        },

        //绑定事件
        BindEvent: function () {
            this.$Input.off("change.FormFormula").on("change.FormFormula", this, function (event) {
                var $this = $(this);
                var that = event.data;
                that.ValChange.apply(that);
            });
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (v === "" && this.GetValue() === "") return;
            if (this.GetValue() != "" && this.GetValue() == v) return;
            this.editor.txt.html(v)

            if (!this.Editable) {
                this.editor.$textElem.attr('contenteditable', false)
            }
            else {
                this.editor.$textElem.attr('contenteditable', true)
            }

        },

        GetText: function () {
            return this.GetValue() + "";
        },

        GetValue: function () {
            if (!this.Visible) {
                if (this.editor.txt.html() == null) {
                    return "";
                } else {
                    return this.editor.txt.html() + '';
                }
            }
            return this.editor.txt.html() + '';
        },


        //返回数据值
        SaveDataField: function () {
            // var result = {};
            // if (!this.Visible) return result;
            // result[this.DataField] = this.GetValue()
            // return result;
            return null
        },


        GetNum: function () {
            var v = this.GetValue();
            if ($.isNumeric(v)) {
                return parseFloat(v);
            }
            else {
                return 0.0;
            }
        },
        ConvertValue: function (v) {
            if (this.BindType == this.BindControlType.DateTime) {
                v = new Date(v);
                if (isNaN(v.getFullYear()) || v.getFullYear() < 1971) {
                    v = "";
                } else {
                    v = v.Format('yyyy-MM-dd hh:mm:ss');
                }

            }

            if (this.BindType == this.BindControlType.Bool) {
                v = new Boolean(v).toString();
            }

            if (this.BindType == this.BindControlType.Number) {
                if (!$.isNumeric(v)) {
                    v = "0";
                }
            }

            return v;
        }
    });

})(jQuery);;
/*FormApprovalRecord控件*/
(function ($) {
    $.fn.FormApprovalRecord = function () {
        return $.ControlManager.Run.call(this, "FormApprovalRecord", arguments);
    };

    // 构造函数
    $.Controls.FormApprovalRecord = function (element, options, sheetInfo) {
        this.DataField = options.DataField
        $.Controls.FormApprovalRecord.Base.constructor.call(this, element, options, sheetInfo);
    };

    // 继承及控件实现
    $.Controls.FormApprovalRecord.Inherit($.Controls.BaseControl, {
        //绑定类型为数值时需要使用
        NumberMode: {
            Normal: 0,
            Kbit: 1
        },
        //邦定的类型
        BindControlType: {
            Text: "text",
            DateTime: "datetime",
            Number: "number",
            Bool: "boolean"
        },
        //控件渲染函数
        Render: function () {
            // 展示打印状态时渲染
            if (Object.keys(this.ResponseContext.Actions)[0] !== 'Print') {
                $(this.Element).html("")
                return;
            }
            //是否可见
            if (!this.Visible) { $(this.Element).hide(); return; }
            $(this.Element).html("")
            const formApprovalRecordEl = this.loadFormApprovalRecord()
            let titleEl = `<span class="col-sm-2 col-xs-2 ControlTitle">${this.DisplayName}</span>`
            let contentEl = $(`<div class="col-sm-10 col-xs-10"></div>`).append(formApprovalRecordEl)
            $(this.Element).append(titleEl, contentEl)

        },
        // 加载审批记录
        loadFormApprovalRecord() {
            let self = this
            const Instance = new Vue({
                data() {
                    return {};
                },
                render(h) {
                    return h(FormApprovalRecord, {
                        props: {
                            appRunId: self.Value
                        }
                    });
                }
            });
            const component = Instance.$mount();
            return component.$el
        },
        //渲染html内容
        HtmlRender: function () {
            var index = store.state.listview.currentTabIndex
            this.$Input = $("<div id='editor" + index + "'" + "></div>");

            this.$InputBody.append(this.$Input);
            var editorName = "#editor" + index;
            this.editor = new editor({
                el: document.querySelector(editorName),
                initialEditType: 'markdown',
                previewStyle: 'vertical',
                height: '300px'
            });
            // this.editor.customConfig.menus =[
            //     'bold',  // 粗体
            //     'fontSize',  // 字号
            //     'fontName',  // 字体
            //     'italic',  // 斜体
            //     'underline',  // 下划线
            //     'strikeThrough',  // 删除线
            //     'foreColor',  // 文字颜色
            //     'backColor',  // 背景颜色
            //     'link',  // 插入链接
            //     'justify',  // 对齐方式
            //     'quote',  // 引用
            //     'emoticon',  // 表情
            //     'image',  // 插入图片
            //     'table',  // 表格
            //     'video',  // 插入视频
            //     'code',  // 插入代码
            //     'undo',  // 撤销
            //     'redo'  // 重复
            // ]
            // this.editor.create()//就创建好了编辑器
            //     //说说里面的配置，PC端常用的未以下这些
            //     // 自定义菜单配置---选中你想要的来配置，

            //     //插入链接
            // this.editor.customConfig.linkCheck = function (text, link) {
            //         console.log(text) // 插入的文字
            //         console.log(link) // 插入的链接
            //         return true // 返回 true 表示校验成功
            //         // return '验证失败' // 返回字符串，即校验失败的提示信息
            //     };
            //     //处理图片，我用的是自定义的方式来选图，
            // //如果想完全自己控制图片上传的过程，可以使用如下代码
            // this.editor.customConfig.customUploadImg = function (files, insert) {
            //     // files 是 input 中选中的文件列表
            //     // insert 是获取图片 url 后，插入到编辑器的方法

            //     // 上传代码返回结果之后，将图片插入到编辑器中
            //     insert(imgUrl)
            // }
        },

        //绑定事件
        BindEvent: function () {
            this.$Input.off("change.FormFormula").on("change.FormFormula", this, function (event) {
                var $this = $(this);
                var that = event.data;
                that.ValChange.apply(that);
            });
        },

        //设置值
        SetValue: function (v) {
            if (v == null) return;
            if (v === "" && this.GetValue() === "") return;
            if (this.GetValue() != "" && this.GetValue() == v) return;
            this.editor.txt.html(v)

            if (!this.Editable) {
                this.editor.$textElem.attr('contenteditable', false)
            }
            else {
                this.editor.$textElem.attr('contenteditable', true)
            }

        },

        GetText: function () {
            return this.GetValue() + "";
        },

        GetValue: function () {
            if (!this.Visible) {
                if (this.editor.txt.html() == null) {
                    return "";
                } else {
                    return this.editor.txt.html() + '';
                }
            }
            return this.editor.txt.html() + '';
        },


        //返回数据值
        SaveDataField: function () {
            // var result = {};
            // if (!this.Visible) return result;
            // result[this.DataField] = this.GetValue()
            // return result;
            return null
        },


        GetNum: function () {
            var v = this.GetValue();
            if ($.isNumeric(v)) {
                return parseFloat(v);
            }
            else {
                return 0.0;
            }
        },
        ConvertValue: function (v) {
            if (this.BindType == this.BindControlType.DateTime) {
                v = new Date(v);
                if (isNaN(v.getFullYear()) || v.getFullYear() < 1971) {
                    v = "";
                } else {
                    v = v.Format('yyyy-MM-dd hh:mm:ss');
                }

            }

            if (this.BindType == this.BindControlType.Bool) {
                v = new Boolean(v).toString();
            }

            if (this.BindType == this.BindControlType.Number) {
                if (!$.isNumeric(v)) {
                    v = "0";
                }
            }

            return v;
        }
    });

})(jQuery);;
(function (r) {
    r.fn.qrcode = function (h) {
        var s; function u(a) { this.mode = s; this.data = a } function o(a, c) { this.typeNumber = a; this.errorCorrectLevel = c; this.modules = null; this.moduleCount = 0; this.dataCache = null; this.dataList = [] } function q(a, c) { if (void 0 == a.length) throw Error(a.length + "/" + c); for (var d = 0; d < a.length && 0 == a[d];)d++; this.num = Array(a.length - d + c); for (var b = 0; b < a.length - d; b++)this.num[b] = a[b + d] } function p(a, c) { this.totalCount = a; this.dataCount = c } function t() { this.buffer = []; this.length = 0 } u.prototype = {
            getLength: function () { return this.data.length },
            write: function (a) { for (var c = 0; c < this.data.length; c++)a.put(this.data.charCodeAt(c), 8) }
        }; o.prototype = {
            addData: function (a) { this.dataList.push(new u(a)); this.dataCache = null }, isDark: function (a, c) { if (0 > a || this.moduleCount <= a || 0 > c || this.moduleCount <= c) throw Error(a + "," + c); return this.modules[a][c] }, getModuleCount: function () { return this.moduleCount }, make: function () {
                if (1 > this.typeNumber) {
                    for (var a = 1, a = 1; 40 > a; a++) {
                        for (var c = p.getRSBlocks(a, this.errorCorrectLevel), d = new t, b = 0, e = 0; e < c.length; e++)b += c[e].dataCount;
                        for (e = 0; e < this.dataList.length; e++)c = this.dataList[e], d.put(c.mode, 4), d.put(c.getLength(), j.getLengthInBits(c.mode, a)), c.write(d); if (d.getLengthInBits() <= 8 * b) break
                    } this.typeNumber = a
                } this.makeImpl(!1, this.getBestMaskPattern())
            }, makeImpl: function (a, c) {
            this.moduleCount = 4 * this.typeNumber + 17; this.modules = Array(this.moduleCount); for (var d = 0; d < this.moduleCount; d++) { this.modules[d] = Array(this.moduleCount); for (var b = 0; b < this.moduleCount; b++)this.modules[d][b] = null } this.setupPositionProbePattern(0, 0); this.setupPositionProbePattern(this.moduleCount -
                7, 0); this.setupPositionProbePattern(0, this.moduleCount - 7); this.setupPositionAdjustPattern(); this.setupTimingPattern(); this.setupTypeInfo(a, c); 7 <= this.typeNumber && this.setupTypeNumber(a); null == this.dataCache && (this.dataCache = o.createData(this.typeNumber, this.errorCorrectLevel, this.dataList)); this.mapData(this.dataCache, c)
            }, setupPositionProbePattern: function (a, c) {
                for (var d = -1; 7 >= d; d++)if (!(-1 >= a + d || this.moduleCount <= a + d)) for (var b = -1; 7 >= b; b++)-1 >= c + b || this.moduleCount <= c + b || (this.modules[a + d][c + b] =
                    0 <= d && 6 >= d && (0 == b || 6 == b) || 0 <= b && 6 >= b && (0 == d || 6 == d) || 2 <= d && 4 >= d && 2 <= b && 4 >= b ? !0 : !1)
            }, getBestMaskPattern: function () { for (var a = 0, c = 0, d = 0; 8 > d; d++) { this.makeImpl(!0, d); var b = j.getLostPoint(this); if (0 == d || a > b) a = b, c = d } return c }, createMovieClip: function (a, c, d) { a = a.createEmptyMovieClip(c, d); this.make(); for (c = 0; c < this.modules.length; c++)for (var d = 1 * c, b = 0; b < this.modules[c].length; b++) { var e = 1 * b; this.modules[c][b] && (a.beginFill(0, 100), a.moveTo(e, d), a.lineTo(e + 1, d), a.lineTo(e + 1, d + 1), a.lineTo(e, d + 1), a.endFill()) } return a },
            setupTimingPattern: function () { for (var a = 8; a < this.moduleCount - 8; a++)null == this.modules[a][6] && (this.modules[a][6] = 0 == a % 2); for (a = 8; a < this.moduleCount - 8; a++)null == this.modules[6][a] && (this.modules[6][a] = 0 == a % 2) }, setupPositionAdjustPattern: function () { for (var a = j.getPatternPosition(this.typeNumber), c = 0; c < a.length; c++)for (var d = 0; d < a.length; d++) { var b = a[c], e = a[d]; if (null == this.modules[b][e]) for (var f = -2; 2 >= f; f++)for (var i = -2; 2 >= i; i++)this.modules[b + f][e + i] = -2 == f || 2 == f || -2 == i || 2 == i || 0 == f && 0 == i ? !0 : !1 } }, setupTypeNumber: function (a) {
                for (var c =
                    j.getBCHTypeNumber(this.typeNumber), d = 0; 18 > d; d++) { var b = !a && 1 == (c >> d & 1); this.modules[Math.floor(d / 3)][d % 3 + this.moduleCount - 8 - 3] = b } for (d = 0; 18 > d; d++)b = !a && 1 == (c >> d & 1), this.modules[d % 3 + this.moduleCount - 8 - 3][Math.floor(d / 3)] = b
            }, setupTypeInfo: function (a, c) {
                for (var d = j.getBCHTypeInfo(this.errorCorrectLevel << 3 | c), b = 0; 15 > b; b++) { var e = !a && 1 == (d >> b & 1); 6 > b ? this.modules[b][8] = e : 8 > b ? this.modules[b + 1][8] = e : this.modules[this.moduleCount - 15 + b][8] = e } for (b = 0; 15 > b; b++)e = !a && 1 == (d >> b & 1), 8 > b ? this.modules[8][this.moduleCount -
                    b - 1] = e : 9 > b ? this.modules[8][15 - b - 1 + 1] = e : this.modules[8][15 - b - 1] = e; this.modules[this.moduleCount - 8][8] = !a
            }, mapData: function (a, c) { for (var d = -1, b = this.moduleCount - 1, e = 7, f = 0, i = this.moduleCount - 1; 0 < i; i -= 2)for (6 == i && i--; ;) { for (var g = 0; 2 > g; g++)if (null == this.modules[b][i - g]) { var n = !1; f < a.length && (n = 1 == (a[f] >>> e & 1)); j.getMask(c, b, i - g) && (n = !n); this.modules[b][i - g] = n; e--; -1 == e && (f++ , e = 7) } b += d; if (0 > b || this.moduleCount <= b) { b -= d; d = -d; break } } }
        }; o.PAD0 = 236; o.PAD1 = 17; o.createData = function (a, c, d) {
            for (var c = p.getRSBlocks(a,
                c), b = new t, e = 0; e < d.length; e++) { var f = d[e]; b.put(f.mode, 4); b.put(f.getLength(), j.getLengthInBits(f.mode, a)); f.write(b) } for (e = a = 0; e < c.length; e++)a += c[e].dataCount; if (b.getLengthInBits() > 8 * a) throw Error("code length overflow. (" + b.getLengthInBits() + ">" + 8 * a + ")"); for (b.getLengthInBits() + 4 <= 8 * a && b.put(0, 4); 0 != b.getLengthInBits() % 8;)b.putBit(!1); for (; !(b.getLengthInBits() >= 8 * a);) { b.put(o.PAD0, 8); if (b.getLengthInBits() >= 8 * a) break; b.put(o.PAD1, 8) } return o.createBytes(b, c)
        }; o.createBytes = function (a, c) {
            for (var d =
                0, b = 0, e = 0, f = Array(c.length), i = Array(c.length), g = 0; g < c.length; g++) { var n = c[g].dataCount, h = c[g].totalCount - n, b = Math.max(b, n), e = Math.max(e, h); f[g] = Array(n); for (var k = 0; k < f[g].length; k++)f[g][k] = 255 & a.buffer[k + d]; d += n; k = j.getErrorCorrectPolynomial(h); n = (new q(f[g], k.getLength() - 1)).mod(k); i[g] = Array(k.getLength() - 1); for (k = 0; k < i[g].length; k++)h = k + n.getLength() - i[g].length, i[g][k] = 0 <= h ? n.get(h) : 0 } for (k = g = 0; k < c.length; k++)g += c[k].totalCount; d = Array(g); for (k = n = 0; k < b; k++)for (g = 0; g < c.length; g++)k < f[g].length &&
                    (d[n++] = f[g][k]); for (k = 0; k < e; k++)for (g = 0; g < c.length; g++)k < i[g].length && (d[n++] = i[g][k]); return d
        }; s = 4; for (var j = {
            PATTERN_POSITION_TABLE: [[], [6, 18], [6, 22], [6, 26], [6, 30], [6, 34], [6, 22, 38], [6, 24, 42], [6, 26, 46], [6, 28, 50], [6, 30, 54], [6, 32, 58], [6, 34, 62], [6, 26, 46, 66], [6, 26, 48, 70], [6, 26, 50, 74], [6, 30, 54, 78], [6, 30, 56, 82], [6, 30, 58, 86], [6, 34, 62, 90], [6, 28, 50, 72, 94], [6, 26, 50, 74, 98], [6, 30, 54, 78, 102], [6, 28, 54, 80, 106], [6, 32, 58, 84, 110], [6, 30, 58, 86, 114], [6, 34, 62, 90, 118], [6, 26, 50, 74, 98, 122], [6, 30, 54, 78, 102, 126], [6, 26, 52,
                78, 104, 130], [6, 30, 56, 82, 108, 134], [6, 34, 60, 86, 112, 138], [6, 30, 58, 86, 114, 142], [6, 34, 62, 90, 118, 146], [6, 30, 54, 78, 102, 126, 150], [6, 24, 50, 76, 102, 128, 154], [6, 28, 54, 80, 106, 132, 158], [6, 32, 58, 84, 110, 136, 162], [6, 26, 54, 82, 110, 138, 166], [6, 30, 58, 86, 114, 142, 170]], G15: 1335, G18: 7973, G15_MASK: 21522, getBCHTypeInfo: function (a) { for (var c = a << 10; 0 <= j.getBCHDigit(c) - j.getBCHDigit(j.G15);)c ^= j.G15 << j.getBCHDigit(c) - j.getBCHDigit(j.G15); return (a << 10 | c) ^ j.G15_MASK }, getBCHTypeNumber: function (a) {
                    for (var c = a << 12; 0 <= j.getBCHDigit(c) -
                        j.getBCHDigit(j.G18);)c ^= j.G18 << j.getBCHDigit(c) - j.getBCHDigit(j.G18); return a << 12 | c
                }, getBCHDigit: function (a) { for (var c = 0; 0 != a;)c++ , a >>>= 1; return c }, getPatternPosition: function (a) { return j.PATTERN_POSITION_TABLE[a - 1] }, getMask: function (a, c, d) {
                    switch (a) {
                        case 0: return 0 == (c + d) % 2; case 1: return 0 == c % 2; case 2: return 0 == d % 3; case 3: return 0 == (c + d) % 3; case 4: return 0 == (Math.floor(c / 2) + Math.floor(d / 3)) % 2; case 5: return 0 == c * d % 2 + c * d % 3; case 6: return 0 == (c * d % 2 + c * d % 3) % 2; case 7: return 0 == (c * d % 3 + (c + d) % 2) % 2; default: throw Error("bad maskPattern:" +
                            a);
                    }
                }, getErrorCorrectPolynomial: function (a) { for (var c = new q([1], 0), d = 0; d < a; d++)c = c.multiply(new q([1, l.gexp(d)], 0)); return c }, getLengthInBits: function (a, c) {
                    if (1 <= c && 10 > c) switch (a) { case 1: return 10; case 2: return 9; case s: return 8; case 8: return 8; default: throw Error("mode:" + a); } else if (27 > c) switch (a) { case 1: return 12; case 2: return 11; case s: return 16; case 8: return 10; default: throw Error("mode:" + a); } else if (41 > c) switch (a) {
                        case 1: return 14; case 2: return 13; case s: return 16; case 8: return 12; default: throw Error("mode:" +
                            a);
                    } else throw Error("type:" + c);
                }, getLostPoint: function (a) {
                    for (var c = a.getModuleCount(), d = 0, b = 0; b < c; b++)for (var e = 0; e < c; e++) { for (var f = 0, i = a.isDark(b, e), g = -1; 1 >= g; g++)if (!(0 > b + g || c <= b + g)) for (var h = -1; 1 >= h; h++)0 > e + h || c <= e + h || 0 == g && 0 == h || i == a.isDark(b + g, e + h) && f++; 5 < f && (d += 3 + f - 5) } for (b = 0; b < c - 1; b++)for (e = 0; e < c - 1; e++)if (f = 0, a.isDark(b, e) && f++ , a.isDark(b + 1, e) && f++ , a.isDark(b, e + 1) && f++ , a.isDark(b + 1, e + 1) && f++ , 0 == f || 4 == f) d += 3; for (b = 0; b < c; b++)for (e = 0; e < c - 6; e++)a.isDark(b, e) && !a.isDark(b, e + 1) && a.isDark(b, e +
                        2) && a.isDark(b, e + 3) && a.isDark(b, e + 4) && !a.isDark(b, e + 5) && a.isDark(b, e + 6) && (d += 40); for (e = 0; e < c; e++)for (b = 0; b < c - 6; b++)a.isDark(b, e) && !a.isDark(b + 1, e) && a.isDark(b + 2, e) && a.isDark(b + 3, e) && a.isDark(b + 4, e) && !a.isDark(b + 5, e) && a.isDark(b + 6, e) && (d += 40); for (e = f = 0; e < c; e++)for (b = 0; b < c; b++)a.isDark(b, e) && f++; a = Math.abs(100 * f / c / c - 50) / 5; return d + 10 * a
                }
        }, l = {
            glog: function (a) { if (1 > a) throw Error("glog(" + a + ")"); return l.LOG_TABLE[a] }, gexp: function (a) { for (; 0 > a;)a += 255; for (; 256 <= a;)a -= 255; return l.EXP_TABLE[a] }, EXP_TABLE: Array(256),
            LOG_TABLE: Array(256)
        }, m = 0; 8 > m; m++)l.EXP_TABLE[m] = 1 << m; for (m = 8; 256 > m; m++)l.EXP_TABLE[m] = l.EXP_TABLE[m - 4] ^ l.EXP_TABLE[m - 5] ^ l.EXP_TABLE[m - 6] ^ l.EXP_TABLE[m - 8]; for (m = 0; 255 > m; m++)l.LOG_TABLE[l.EXP_TABLE[m]] = m; q.prototype = {
            get: function (a) { return this.num[a] }, getLength: function () { return this.num.length }, multiply: function (a) { for (var c = Array(this.getLength() + a.getLength() - 1), d = 0; d < this.getLength(); d++)for (var b = 0; b < a.getLength(); b++)c[d + b] ^= l.gexp(l.glog(this.get(d)) + l.glog(a.get(b))); return new q(c, 0) }, mod: function (a) {
                if (0 >
                    this.getLength() - a.getLength()) return this; for (var c = l.glog(this.get(0)) - l.glog(a.get(0)), d = Array(this.getLength()), b = 0; b < this.getLength(); b++)d[b] = this.get(b); for (b = 0; b < a.getLength(); b++)d[b] ^= l.gexp(l.glog(a.get(b)) + c); return (new q(d, 0)).mod(a)
            }
        }; p.RS_BLOCK_TABLE = [[1, 26, 19], [1, 26, 16], [1, 26, 13], [1, 26, 9], [1, 44, 34], [1, 44, 28], [1, 44, 22], [1, 44, 16], [1, 70, 55], [1, 70, 44], [2, 35, 17], [2, 35, 13], [1, 100, 80], [2, 50, 32], [2, 50, 24], [4, 25, 9], [1, 134, 108], [2, 67, 43], [2, 33, 15, 2, 34, 16], [2, 33, 11, 2, 34, 12], [2, 86, 68], [4, 43, 27],
        [4, 43, 19], [4, 43, 15], [2, 98, 78], [4, 49, 31], [2, 32, 14, 4, 33, 15], [4, 39, 13, 1, 40, 14], [2, 121, 97], [2, 60, 38, 2, 61, 39], [4, 40, 18, 2, 41, 19], [4, 40, 14, 2, 41, 15], [2, 146, 116], [3, 58, 36, 2, 59, 37], [4, 36, 16, 4, 37, 17], [4, 36, 12, 4, 37, 13], [2, 86, 68, 2, 87, 69], [4, 69, 43, 1, 70, 44], [6, 43, 19, 2, 44, 20], [6, 43, 15, 2, 44, 16], [4, 101, 81], [1, 80, 50, 4, 81, 51], [4, 50, 22, 4, 51, 23], [3, 36, 12, 8, 37, 13], [2, 116, 92, 2, 117, 93], [6, 58, 36, 2, 59, 37], [4, 46, 20, 6, 47, 21], [7, 42, 14, 4, 43, 15], [4, 133, 107], [8, 59, 37, 1, 60, 38], [8, 44, 20, 4, 45, 21], [12, 33, 11, 4, 34, 12], [3, 145, 115, 1, 146,
            116], [4, 64, 40, 5, 65, 41], [11, 36, 16, 5, 37, 17], [11, 36, 12, 5, 37, 13], [5, 109, 87, 1, 110, 88], [5, 65, 41, 5, 66, 42], [5, 54, 24, 7, 55, 25], [11, 36, 12], [5, 122, 98, 1, 123, 99], [7, 73, 45, 3, 74, 46], [15, 43, 19, 2, 44, 20], [3, 45, 15, 13, 46, 16], [1, 135, 107, 5, 136, 108], [10, 74, 46, 1, 75, 47], [1, 50, 22, 15, 51, 23], [2, 42, 14, 17, 43, 15], [5, 150, 120, 1, 151, 121], [9, 69, 43, 4, 70, 44], [17, 50, 22, 1, 51, 23], [2, 42, 14, 19, 43, 15], [3, 141, 113, 4, 142, 114], [3, 70, 44, 11, 71, 45], [17, 47, 21, 4, 48, 22], [9, 39, 13, 16, 40, 14], [3, 135, 107, 5, 136, 108], [3, 67, 41, 13, 68, 42], [15, 54, 24, 5, 55, 25], [15,
            43, 15, 10, 44, 16], [4, 144, 116, 4, 145, 117], [17, 68, 42], [17, 50, 22, 6, 51, 23], [19, 46, 16, 6, 47, 17], [2, 139, 111, 7, 140, 112], [17, 74, 46], [7, 54, 24, 16, 55, 25], [34, 37, 13], [4, 151, 121, 5, 152, 122], [4, 75, 47, 14, 76, 48], [11, 54, 24, 14, 55, 25], [16, 45, 15, 14, 46, 16], [6, 147, 117, 4, 148, 118], [6, 73, 45, 14, 74, 46], [11, 54, 24, 16, 55, 25], [30, 46, 16, 2, 47, 17], [8, 132, 106, 4, 133, 107], [8, 75, 47, 13, 76, 48], [7, 54, 24, 22, 55, 25], [22, 45, 15, 13, 46, 16], [10, 142, 114, 2, 143, 115], [19, 74, 46, 4, 75, 47], [28, 50, 22, 6, 51, 23], [33, 46, 16, 4, 47, 17], [8, 152, 122, 4, 153, 123], [22, 73, 45,
            3, 74, 46], [8, 53, 23, 26, 54, 24], [12, 45, 15, 28, 46, 16], [3, 147, 117, 10, 148, 118], [3, 73, 45, 23, 74, 46], [4, 54, 24, 31, 55, 25], [11, 45, 15, 31, 46, 16], [7, 146, 116, 7, 147, 117], [21, 73, 45, 7, 74, 46], [1, 53, 23, 37, 54, 24], [19, 45, 15, 26, 46, 16], [5, 145, 115, 10, 146, 116], [19, 75, 47, 10, 76, 48], [15, 54, 24, 25, 55, 25], [23, 45, 15, 25, 46, 16], [13, 145, 115, 3, 146, 116], [2, 74, 46, 29, 75, 47], [42, 54, 24, 1, 55, 25], [23, 45, 15, 28, 46, 16], [17, 145, 115], [10, 74, 46, 23, 75, 47], [10, 54, 24, 35, 55, 25], [19, 45, 15, 35, 46, 16], [17, 145, 115, 1, 146, 116], [14, 74, 46, 21, 75, 47], [29, 54, 24, 19,
            55, 25], [11, 45, 15, 46, 46, 16], [13, 145, 115, 6, 146, 116], [14, 74, 46, 23, 75, 47], [44, 54, 24, 7, 55, 25], [59, 46, 16, 1, 47, 17], [12, 151, 121, 7, 152, 122], [12, 75, 47, 26, 76, 48], [39, 54, 24, 14, 55, 25], [22, 45, 15, 41, 46, 16], [6, 151, 121, 14, 152, 122], [6, 75, 47, 34, 76, 48], [46, 54, 24, 10, 55, 25], [2, 45, 15, 64, 46, 16], [17, 152, 122, 4, 153, 123], [29, 74, 46, 14, 75, 47], [49, 54, 24, 10, 55, 25], [24, 45, 15, 46, 46, 16], [4, 152, 122, 18, 153, 123], [13, 74, 46, 32, 75, 47], [48, 54, 24, 14, 55, 25], [42, 45, 15, 32, 46, 16], [20, 147, 117, 4, 148, 118], [40, 75, 47, 7, 76, 48], [43, 54, 24, 22, 55, 25], [10,
            45, 15, 67, 46, 16], [19, 148, 118, 6, 149, 119], [18, 75, 47, 31, 76, 48], [34, 54, 24, 34, 55, 25], [20, 45, 15, 61, 46, 16]]; p.getRSBlocks = function (a, c) { var d = p.getRsBlockTable(a, c); if (void 0 == d) throw Error("bad rs block @ typeNumber:" + a + "/errorCorrectLevel:" + c); for (var b = d.length / 3, e = [], f = 0; f < b; f++)for (var h = d[3 * f + 0], g = d[3 * f + 1], j = d[3 * f + 2], l = 0; l < h; l++)e.push(new p(g, j)); return e }; p.getRsBlockTable = function (a, c) {
                switch (c) {
                    case 1: return p.RS_BLOCK_TABLE[4 * (a - 1) + 0]; case 0: return p.RS_BLOCK_TABLE[4 * (a - 1) + 1]; case 3: return p.RS_BLOCK_TABLE[4 *
                        (a - 1) + 2]; case 2: return p.RS_BLOCK_TABLE[4 * (a - 1) + 3]
                }
            }; t.prototype = { get: function (a) { return 1 == (this.buffer[Math.floor(a / 8)] >>> 7 - a % 8 & 1) }, put: function (a, c) { for (var d = 0; d < c; d++)this.putBit(1 == (a >>> c - d - 1 & 1)) }, getLengthInBits: function () { return this.length }, putBit: function (a) { var c = Math.floor(this.length / 8); this.buffer.length <= c && this.buffer.push(0); a && (this.buffer[c] |= 128 >>> this.length % 8); this.length++ } }; "string" === typeof h && (h = { text: h }); h = r.extend({}, {
                render: "canvas", width: 256, height: 256, typeNumber: -1,
                correctLevel: 2, background: "#ffffff", foreground: "#000000"
            }, h); return this.each(function () {
                var a; if ("canvas" == h.render) {
                    a = new o(h.typeNumber, h.correctLevel); a.addData(h.text); a.make(); var c = document.createElement("canvas"); c.width = h.width; c.height = h.height; for (var d = c.getContext("2d"), b = h.width / a.getModuleCount(), e = h.height / a.getModuleCount(), f = 0; f < a.getModuleCount(); f++)for (var i = 0; i < a.getModuleCount(); i++) {
                    d.fillStyle = a.isDark(f, i) ? h.foreground : h.background; var g = Math.ceil((i + 1) * b) - Math.floor(i * b),
                        j = Math.ceil((f + 1) * b) - Math.floor(f * b); d.fillRect(Math.round(i * b), Math.round(f * e), g, j)
                    }
                } else {
                    a = new o(h.typeNumber, h.correctLevel); a.addData(h.text); a.make(); c = r("<table></table>").css("width", h.width + "px").css("height", h.height + "px").css("border", "0px").css("border-collapse", "collapse").css("background-color", h.background); d = h.width / a.getModuleCount(); b = h.height / a.getModuleCount(); for (e = 0; e < a.getModuleCount(); e++) {
                        f = r("<tr></tr>").css("height", b + "px").appendTo(c); for (i = 0; i < a.getModuleCount(); i++)r("<td></td>").css("width",
                            d + "px").css("background-color", a.isDark(e, i) ? h.foreground : h.background).appendTo(f)
                    }
                } a = c; jQuery(a).appendTo(this)
            })
    }
})(jQuery);
;
/*!
 * Viewer v0.1.0
 * https://github.com/fengyuanchen/viewer
 *
 * Copyright (c) 2015 Fengyuan Chen
 * Released under the MIT license
 *
 * Date: 2015-09-02T09:08:17.666Z
 */

(function (factory) {
    if (typeof define === 'function' && define.amd) {
        // AMD. Register as anonymous module.
        define('viewer', ['jquery'], factory);
    } else if (typeof exports === 'object') {
        // Node / CommonJS
        factory(require('jquery'));
    } else {
        // Browser globals.
        factory(jQuery);
    }
})(function ($) {

    'use strict';

    var $window = $(top.window);
    var $document = $(top.document);

    // Constants
    var NAMESPACE = 'viewer';
    var ELEMENT_VIEWER = document.createElement(NAMESPACE);

    // Classes
    var CLASS_TOGGLE = 'viewer-toggle';
    var CLASS_FIXED = 'viewer-fixed';
    var CLASS_OPEN = 'viewer-open';
    var CLASS_SHOW = 'viewer-show';
    var CLASS_HIDE = 'viewer-hide';
    var CLASS_FADE = 'viewer-fade';
    var CLASS_IN = 'viewer-in';
    var CLASS_MOVE = 'viewer-move';
    var CLASS_ACTIVE = 'viewer-active';
    var CLASS_INVISIBLE = 'viewer-invisible';
    var CLASS_TRANSITION = 'viewer-transition';
    var CLASS_FULLSCREEN = 'viewer-fullscreen';
    var CLASS_FULLSCREEN_EXIT = 'viewer-fullscreen-exit';
    var CLASS_CLOSE = 'viewer-close icon-close';

    // Selectors
    var SELECTOR_IMG = 'img';

    // Events
    var EVENT_MOUSEDOWN = 'mousedown touchstart pointerdown MSPointerDown';
    var EVENT_MOUSEMOVE = 'mousemove touchmove pointermove MSPointerMove';
    var EVENT_MOUSEUP = 'mouseup touchend touchcancel pointerup pointercancel MSPointerUp MSPointerCancel';
    var EVENT_WHEEL = 'wheel mousewheel DOMMouseScroll';
    var EVENT_TRANSITIONEND = 'transitionend';
    var EVENT_LOAD = 'load.' + NAMESPACE;
    var EVENT_KEYDOWN = 'keydown.' + NAMESPACE;
    var EVENT_CLICK = 'click.' + NAMESPACE;
    var EVENT_RESIZE = 'resize.' + NAMESPACE;
    var EVENT_BUILD = 'build.' + NAMESPACE;
    var EVENT_BUILT = 'built.' + NAMESPACE;
    var EVENT_SHOW = 'show.' + NAMESPACE;
    var EVENT_SHOWN = 'shown.' + NAMESPACE;
    var EVENT_HIDE = 'hide.' + NAMESPACE;
    var EVENT_HIDDEN = 'hidden.' + NAMESPACE;
    var EVENT_VIEW = 'view.' + NAMESPACE;
    var EVENT_VIEWED = 'viewed.' + NAMESPACE;

    // Supports
    var SUPPORT_TRANSITION = typeof ELEMENT_VIEWER.style.transition !== 'undefined';

    // Others
    var round = Math.round;
    var sqrt = Math.sqrt;
    var abs = Math.abs;
    var min = Math.min;
    var max = Math.max;
    var num = parseFloat;

    // Prototype
    var prototype = {};

    function isString(s) {
        return typeof s === 'string';
    }

    function isNumber(n) {
        return typeof n === 'number' && !isNaN(n);
    }

    function isUndefined(u) {
        return typeof u === 'undefined';
    }

    function toArray(obj, offset) {
        var args = [];

        if (isNumber(offset)) { // It's necessary for IE8
            args.push(offset);
        }

        return args.slice.apply(obj, args);
    }

    // Custom proxy to avoid jQuery's guid
    function proxy(fn, context) {
        var args = toArray(arguments, 2);

        return function () {
            return fn.apply(context, args.concat(toArray(arguments)));
        };
    }

    function getTransform(options) {
        var transforms = [];
        var rotate = options.rotate;
        var scaleX = options.scaleX;
        var scaleY = options.scaleY;

        if (isNumber(rotate)) {
            transforms.push('rotate(' + rotate + 'deg)');
        }

        if (isNumber(scaleX) && isNumber(scaleY)) {
            transforms.push('scale(' + scaleX + ',' + scaleY + ')');
        }

        return transforms.length ? transforms.join(' ') : 'none';
    }

    // e.g.: http://domain.com/path/to/picture.jpg?size=1280脳960 -> picture.jpg
    function getImageName(url) {
        return isString(url) ? url.replace(/^.*\//, '').replace(/[\?&#].*$/, '') : '';
    }

    function getImageSize(image, callback) {
        var newImage;

        // Modern browsers
        if (image.naturalWidth) {
            return callback(image.naturalWidth, image.naturalHeight);
        }

        // IE8: Don't use `new Image()` here
        newImage = document.createElement('img');

        newImage.onload = function () {
            callback(this.width, this.height);
        };

        newImage.src = image.src;
    }

    function Viewer(element, options) {
        this.$element = $(element);
        this.options = $.extend({}, Viewer.DEFAULTS, $.isPlainObject(options) && options);
        this.isImg = false;
        this.isBuilt = false;
        this.isShown = false;
        this.isViewed = false;
        this.isFulled = false;
        this.isPlayed = false;
        this.playing = false;
        this.fading = false;
        this.transitioning = false;
        this.action = false;
        this.target = false;
        this.index = 0;
        this.length = 0;
        this.init();
    }

    $.extend(prototype, {
        init: function () {
            var options = this.options;
            var $this = this.$element;
            var isImg = $this.is(SELECTOR_IMG);
            var $images = isImg ? $this : $this.find(SELECTOR_IMG);
            var length = $images.length;
            var ready = $.proxy(this.ready, this);

            if (!length) {
                return;
            }

            if ($.isFunction(options.build)) {
                $this.one(EVENT_BUILD, options.build);
            }

            if (this.trigger(EVENT_BUILD).isDefaultPrevented()) {
                return;
            }

            // Override `transiton` option if it is not supported
            if (!SUPPORT_TRANSITION) {
                options.transition = false;
            }

            this.isImg = isImg;
            this.length = length;
            this.count = 0;
            this.$images = $images;
            this.$body = $('body');

            if (options.inline) {
                $this.one(EVENT_BUILT, $.proxy(function () {
                    this.view();
                }, this));

                $images.each(function () {
                    if (this.complete) {
                        ready();
                    } else {
                        $(this).one(EVENT_LOAD, ready);
                    }
                });
            } else {
                $images.addClass(CLASS_TOGGLE);
                $this.on(EVENT_CLICK, $.proxy(this.start, this));
            }
        },

        ready: function () {
            this.count++;

            if (this.count === this.length) {
                this.build();
            }
        }
    });

    $.extend(prototype, {
        build: function () {
            var options = this.options;
            var $this = this.$element;
            var $parent;
            var $viewer;
            var $button;
            var $toolbar;

            if (this.isBuilt) {
                return;
            }

            if (!$parent || !$parent.length) {
                $parent = $this.parent();
            }

            this.$parent = $parent;
            this.$viewer = $viewer = $(Viewer.TEMPLATE);
            this.$canvas = $viewer.find('.viewer-canvas');
            this.$switch = $viewer.find('.viewer-switch');
            this.$footer = $viewer.find('.viewer-footer');
            this.$title = $viewer.find('.viewer-title').toggleClass(CLASS_HIDE, !options.title);
            this.$toolbar = $toolbar = $viewer.find('.viewer-toolbar').toggleClass(CLASS_HIDE, !options.toolbar);
            this.$navbar = $viewer.find('.viewer-navbar').toggleClass(CLASS_HIDE, !options.navbar);
            this.$button = $button = $viewer.find('.viewer-button').toggleClass(CLASS_HIDE, !options.button);
            this.$tooltip = $viewer.find('.viewer-tooltip');
            this.$player = $viewer.find('.viewer-player');
            this.$list = $viewer.find('.viewer-list');

            $toolbar.find('li[class*=zoom]').toggleClass(CLASS_INVISIBLE, !options.zoomable);
            $toolbar.find('li[class*=flip]').toggleClass(CLASS_INVISIBLE, !options.scalable);

            if (!options.rotatable) {
                $toolbar.find('li[class*=rotate]').addClass(CLASS_INVISIBLE).appendTo($toolbar);
            }

            if (options.inline) {
                $button.addClass(CLASS_FULLSCREEN);
                $viewer.css('z-index', options.zIndexInline);

                if ($parent.css('position') === 'static') {
                    $parent.css('position', 'relative');
                }
            } else {
                $button.addClass(CLASS_CLOSE);
                $viewer.
                    css('z-index', options.zIndex).
                    addClass([CLASS_FIXED, CLASS_FADE, CLASS_HIDE].join(' '));
            }
            $(top.window.document.body).append($viewer)
            //$this.after($viewer);

            if (options.inline) {
                this.render();
                this.bind();
                this.isShown = true;
            }

            this.isBuilt = true;

            if ($.isFunction(options.built)) {
                $this.one(EVENT_BUILT, options.built);
            }

            this.trigger(EVENT_BUILT);
        },

        unbuild: function () {
            var options = this.options;
            var $this = this.$element;

            if (!this.isBuilt) {
                return;
            }

            if (options.inline && !options.container) {
                $this.removeClass(CLASS_HIDE);
            }

            this.$viewer.remove();
        }
    });

    $.extend(prototype, {
        bind: function () {
            this.$viewer.
                on(EVENT_CLICK, $.proxy(this.click, this)).
                on(EVENT_WHEEL, $.proxy(this.wheel, this));

            this.$canvas.on(EVENT_MOUSEDOWN, $.proxy(this.mousedown, this));

            $document.
                on(EVENT_MOUSEMOVE, (this._mousemove = proxy(this.mousemove, this))).
                on(EVENT_MOUSEUP, (this._mouseup = proxy(this.mouseup, this))).
                on(EVENT_KEYDOWN, (this._keydown = proxy(this.keydown, this)));

            $window.on(EVENT_RESIZE, (this._resize = proxy(this.resize, this)));
        },

        unbind: function () {
            this.$viewer.
                off(EVENT_CLICK, this.click).
                off(EVENT_WHEEL, this.wheel);

            this.$canvas.off(EVENT_MOUSEDOWN, this.mousedown);

            $document.
                off(EVENT_MOUSEMOVE, this._mousemove).
                off(EVENT_MOUSEUP, this._mouseup).
                off(EVENT_KEYDOWN, this._keydown);

            $window.off(EVENT_RESIZE, this._resize);
        }
    });

    $.extend(prototype, {
        render: function () {
            this.initContainer();
            this.initViewer();
            this.initList();
            this.renderViewer();
        },

        initContainer: function () {
            this.container = {
                width: $window.innerWidth(),
                height: $window.innerHeight()
            };
        },

        initViewer: function () {
            var options = this.options;
            var $parent = this.$parent;
            var viewer;

            if (options.inline) {
                this.parent = viewer = {
                    width: max($parent.width(), options.minWidth),
                    height: max($parent.height(), options.minHeight)
                };
            }

            if (this.isFulled || !viewer) {
                viewer = this.container;
            }

            this.viewer = $.extend({}, viewer);
        },

        renderViewer: function () {
            if (this.options.inline && !this.isFulled) {
                this.$viewer.css(this.viewer);
            }
        },

        initList: function () {
            var options = this.options;
            var $this = this.$element;
            var $list = this.$list;
            var list = [];

            this.$images.each(function (i) {
                var src = this.src;
                var alt = this.alt || getImageName(src);
                var url = options.url;

                if (!src) {
                    return;
                }

                if (isString(url)) {
                    url = this.getAttribute(url);
                } else if ($.isFunction(url)) {
                    url = url.call(this, this);
                }

                list.push(
                    '<li>' +
                    '<img' +
                    ' src="' + src + '"' +
                    ' data-action="view"' +
                    ' data-index="' + i + '"' +
                    ' data-original-url="' + (url || src) + '"' +
                    ' alt="' + alt + '"' +
                    '>' +
                    '</li>'
                );
            });

            $list.html(list.join('')).find(SELECTOR_IMG).one(EVENT_LOAD, {
                filled: true
            }, $.proxy(this.loadImage, this));

            this.$items = $list.children();

            if (options.transition) {
                $this.one(EVENT_VIEWED, function () {
                    $list.addClass(CLASS_TRANSITION);
                });
            }
        },

        renderList: function (index) {
            var i = index || this.index;
            var width = this.$items.eq(i).width();
            var outerWidth = width + 1; // 1 pixel of `margin-left` width

            // Place the active item in the center of the screen
            this.$list.css({
                width: outerWidth * this.length,
                marginLeft: (this.viewer.width - width) / 2 - outerWidth * i
            });
        },

        resetList: function () {
            this.$list.empty().removeClass(CLASS_TRANSITION).css('margin-left', 0);
        },

        initImage: function (callback) {
            var options = this.options;
            var $image = this.$image;
            var viewer = this.viewer;
            var footerHeight = this.$footer.height();
            var viewerWidth = viewer.width;
            var viewerHeight = max(viewer.height - footerHeight, footerHeight);
            var oldImage = this.image || {};

            getImageSize($image[0], $.proxy(function (naturalWidth, naturalHeight) {
                var aspectRatio = naturalWidth / naturalHeight;
                var width = viewerWidth;
                var height = viewerHeight;
                var initialImage;
                var image;

                if (viewerHeight * aspectRatio > viewerWidth) {
                    height = viewerWidth / aspectRatio;
                } else {
                    width = viewerHeight * aspectRatio;
                }

                width = min(width * 0.9, naturalWidth);
                height = min(height * 0.9, naturalHeight);

                image = {
                    naturalWidth: naturalWidth,
                    naturalHeight: naturalHeight,
                    aspectRatio: aspectRatio,
                    ratio: width / naturalWidth,
                    width: width,
                    height: height,
                    left: (viewerWidth - width) / 2,
                    top: (viewerHeight - height) / 2
                };

                initialImage = $.extend({}, image);

                if (options.rotatable) {
                    image.rotate = oldImage.rotate || 0;
                    initialImage.rotate = 0;
                }

                if (options.scalable) {
                    image.scaleX = oldImage.scaleX || 1;
                    image.scaleY = oldImage.scaleY || 1;
                    initialImage.scaleX = 1;
                    initialImage.scaleY = 1;
                }

                this.image = image;
                this.initialImage = initialImage;

                if ($.isFunction(callback)) {
                    callback();
                }
            }, this));
        },

        renderImage: function (callback) {
            var image = this.image;
            var $image = this.$image;

            $image.css({
                width: image.width,
                height: image.height,
                marginLeft: image.left,
                marginTop: image.top,
                transform: getTransform(image)
            });

            if ($.isFunction(callback)) {
                if (this.options.transition) {
                    $image.one(EVENT_TRANSITIONEND, callback);
                } else {
                    callback();
                }
            }
        },

        resetImage: function () {
            this.$image.remove();
            this.$image = null;
        }
    });

    $.extend(prototype, {
        start: function (e) {
            var target = e.target;

            if ($(target).hasClass(CLASS_TOGGLE)) {
                this.target = target;
                this.show();
            }
        },

        click: function (e) {
            e.stopPropagation();
            var $target = $(e.target);
            var action = $target.data('action');
            var image = this.image;

            switch (action) {
                case 'mix':
                    if (this.isPlayed) {
                        this.stop();
                    } else {
                        if (this.options.inline) {
                            if (this.isFulled) {
                                this.exit();
                            } else {
                                this.full();
                            }
                        } else {
                            this.hide();
                        }
                    }

                    break;
                case 'download':
                    this.download();
                    break;
                case 'view':
                    this.view($target.data('index'));
                    break;

                case 'zoom-in':
                    this.zoom(0.1, true);
                    break;

                case 'zoom-out':
                    this.zoom(-0.1, true);
                    break;

                case 'one-to-one':
                    if (this.image.ratio === 1) {
                        this.zoomTo(this.initialImage.ratio);
                    } else {
                        this.zoomTo(1);
                    }

                    break;

                case 'reset':
                    this.reset();
                    break;

                case 'prev':
                    this.prev();
                    break;

                case 'play':
                    this.play();
                    break;

                case 'next':
                    this.next();
                    break;

                case 'rotate-left':
                    this.rotate(-90);
                    break;

                case 'rotate-right':
                    this.rotate(90);
                    break;

                case 'flip-horizontal':
                    this.scale(-image.scaleX || -1, image.scaleY || 1);
                    break;

                case 'flip-vertical':
                    this.scale(image.scaleX || 1, -image.scaleY || -1);
                    break;

                default:
                    if (this.isPlayed) {
                        this.stop();
                    }
            }
        },

        load: function () {
            this.initImage($.proxy(function () {
                this.renderImage($.proxy(function () {
                    this.isViewed = true;
                    this.trigger(EVENT_VIEWED);
                }, this));
            }, this));
        },

        loadImage: function (e) {
            var image = e.target;
            var $image = $(image);
            var $parent = $image.parent();
            var parentWidth = $parent.width();
            var parentHeight = $parent.height();
            var filled = e.data && e.data.filled;

            getImageSize(image, $.proxy(function (naturalWidth, naturalHeight) {
                var aspectRatio = naturalWidth / naturalHeight;
                var width = parentWidth;
                var height = parentHeight;

                if (parentHeight * aspectRatio > parentWidth) {
                    if (filled) {
                        width = parentHeight * aspectRatio;
                    } else {
                        height = parentWidth / aspectRatio;
                    }
                } else {
                    if (filled) {
                        height = parentWidth / aspectRatio;
                    } else {
                        width = parentHeight * aspectRatio;
                    }
                }

                $image.css({
                    width: width,
                    height: height,
                    marginLeft: (parentWidth - width) / 2,
                    marginTop: (parentHeight - height) / 2
                });
            }, this));
        },

        resize: function () {
            this.initContainer();
            this.initViewer();
            this.renderViewer();
            this.renderList();
            this.initImage($.proxy(function () {
                this.renderImage();
            }, this));

            if (this.isPlayed) {
                this.$player.
                    find(SELECTOR_IMG).
                    one(EVENT_LOAD, $.proxy(this.loadImage, this)).
                    trigger(EVENT_LOAD);
            }
        },

        wheel: function (event) {
            var e = event.originalEvent;
            var ratio = num(this.options.zoomRatio) || 0.1;
            var delta = 1;

            if (!this.isViewed) {
                return;
            }

            event.preventDefault();

            if (e.deltaY) {
                delta = e.deltaY > 0 ? 1 : -1;
            } else if (e.wheelDelta) {
                delta = -e.wheelDelta / 120;
            } else if (e.detail) {
                delta = e.detail > 0 ? 1 : -1;
            }

            this.zoom(-delta * ratio, true);
        },

        keydown: function (e) {
            var options = this.options;
            var which = e.which;

            if (!this.isFulled || !options.keyboard) {
                return;
            }

            switch (which) {

                // (Key: Esc)
                case 27:
                    if (this.isPlayed) {
                        this.stop();
                    } else {
                        if (options.inline) {
                            if (this.isFulled) {
                                this.exit();
                            }
                        } else {
                            this.hide();
                        }
                    }

                    break;

                // View previous (Key: 鈫�)
                case 37:
                    this.prev();
                    break;

                // Zoom in (Key: 鈫�)
                case 38:
                    this.zoom(options.zoomRatio, true);
                    break;

                // View next (Key: 鈫�)
                case 39:
                    this.next();
                    break;

                // Zoom out (Key: 鈫�)
                case 40:
                    this.zoom(-options.zoomRatio, true);
                    break;

                // Zoom out to initial size (Key: Ctrl + 0)
                case 48:
                // Go to next

                // Zoom in to natural size (Key: Ctrl + 1)
                case 49:
                    if (e.ctrlKey || e.shiftKey) {
                        e.preventDefault();

                        if (this.image.ratio === 1) {
                            this.zoomTo(this.initialImage.ratio);
                        } else {
                            this.zoomTo(1);
                        }
                    }

                    break;

                // No default
            }
        },

        mousedown: function (event) {
            var options = this.options;
            var originalEvent = event.originalEvent;
            var touches = originalEvent && originalEvent.touches;
            var e = event;
            var action = options.movable ? 'move' : false;
            var touchesLength;

            if (!this.isViewed) {
                return;
            }

            if (touches) {
                touchesLength = touches.length;

                if (touchesLength > 1) {
                    if (options.zoomable && touchesLength === 2) {
                        e = touches[1];
                        this.startX2 = e.pageX;
                        this.startY2 = e.pageY;
                        action = 'zoom';
                    } else {
                        return;
                    }
                } else {
                    if (this.isSwitchable()) {
                        action = 'switch';
                    }
                }

                e = touches[0];
            }

            if (action) {
                event.preventDefault();

                if (action === 'move' && options.transition) {
                    this.$image.removeClass(CLASS_TRANSITION);
                }

                this.action = action;

                // IE8  has `event.pageX/Y`, but not `event.originalEvent.pageX/Y`
                // IE10 has `event.originalEvent.pageX/Y`, but not `event.pageX/Y`
                this.startX = e.pageX || originalEvent && originalEvent.pageX;
                this.startY = e.pageY || originalEvent && originalEvent.pageY;
            }
        },

        mousemove: function (event) {
            var options = this.options;
            var originalEvent = event.originalEvent;
            var touches = originalEvent && originalEvent.touches;
            var e = event;
            var touchesLength;

            if (!this.isViewed) {
                return;
            }

            if (touches) {
                touchesLength = touches.length;

                if (touchesLength > 1) {
                    if (options.zoomable && touchesLength === 2) {
                        e = touches[1];
                        this.endX2 = e.pageX;
                        this.endY2 = e.pageY;
                    } else {
                        return;
                    }
                }

                e = touches[0];
            }

            if (this.action) {
                event.preventDefault();

                this.endX = e.pageX || originalEvent && originalEvent.pageX;
                this.endY = e.pageY || originalEvent && originalEvent.pageY;

                this.change();
            }
        },

        mouseup: function (event) {
            var action = this.action;

            if (action) {
                event.preventDefault();

                if (action === 'move' && this.options.transition) {
                    this.$image.addClass(CLASS_TRANSITION);
                }

                this.action = false;
            }
        }
    });

    $.extend(prototype, {

        // Show the viewer (only available in modal mode)
        show: function () {
            var options = this.options;
            var $viewer;

            if (options.inline || this.transitioning) {
                return;
            }

            if (!this.isBuilt) {
                this.build();
            }

            if ($.isFunction(options.show)) {
                this.$element.one(EVENT_SHOW, options.show);
            }

            if (this.trigger(EVENT_SHOW).isDefaultPrevented()) {
                return;
            }

            this.$body.addClass(CLASS_OPEN);
            $viewer = this.$viewer.removeClass(CLASS_HIDE);

            this.$element.one(EVENT_SHOWN, $.proxy(function () {
                var index = this.target ? this.$images.index(this.target) : 0;
                if (typeof index == "undefined")
                    index = this.index;
                this.view(index);
                //this.view((this.target ? this.$images.index(this.target) : 0) || this.index);
                this.target = false;
                this.canprev_next();
            }, this));

            if (options.transition) {
                this.transitioning = true;

                /* jshint expr:true */
                $viewer.addClass(CLASS_TRANSITION).get(0).offsetWidth;
                $viewer.one(EVENT_TRANSITIONEND, $.proxy(this.shown, this)).addClass(CLASS_IN);
            } else {
                $viewer.addClass(CLASS_IN);
                this.shown();
            }
        },

        // Hide the viewer (only available in modal mode)
        hide: function () {
            var options = this.options;
            var $viewer = this.$viewer;

            if (options.inline || this.transitioning || !this.isShown) {
                return;
            }

            if ($.isFunction(options.hide)) {
                this.$element.one(EVENT_HIDE, options.hide);
            }

            if (this.trigger(EVENT_HIDE).isDefaultPrevented()) {
                return;
            }

            if (this.isViewed && options.transition) {
                this.transitioning = true;
                this.$image.one(EVENT_TRANSITIONEND, $.proxy(function () {
                    $viewer.one(EVENT_TRANSITIONEND, $.proxy(this.hidden, this)).removeClass(CLASS_IN);
                }, this));
                this.zoomTo(0, false, true);
            } else {
                $viewer.removeClass(CLASS_IN);
                this.hidden();
            }
        },

        //download img
        download: function () {
            var downloadImg = this.$canvas.find('img');
            var downloadUrl = downloadImg.attr('src');
            if (downloadUrl.indexOf('data:image/png;base64') > -1) {
                return
            }
            top.window.open(downloadUrl, '_blank');
        },

        /**
         * View one of the images with image's index
         *
         * @param {Number} index
         */
        view: function (index) {
            var options = this.options;
            var viewer = this.viewer;
            var $title = this.$title;
            var $image;
            var $item;
            var $img;
            var url;
            var alt;

            index = Number(index) || 0;

            if (!this.isShown || this.isPlayed || index < 0 || index >= this.length ||
                this.isViewed && index === this.index) {
                return;
            }

            if (this.trigger(EVENT_VIEW).isDefaultPrevented()) {
                return;
            }

            $item = this.$items.eq(index);
            $img = $item.find(SELECTOR_IMG);
            url = $img.data('originalUrl');
            alt = $img.attr('alt');

            this.$image = $image = $('<img src="' + url + '" alt="' + alt + '">');

            $image.
                toggleClass(CLASS_TRANSITION, options.transition).
                toggleClass(CLASS_MOVE, options.movable).
                css({
                    width: 0,
                    height: 0,
                    marginLeft: viewer.width / 2,
                    marginTop: viewer.height / 2
                });

            this.$items.eq(this.index).removeClass(CLASS_ACTIVE);
            $item.addClass(CLASS_ACTIVE);

            this.isViewed = false;
            this.index = index;
            this.image = null;
            $image.one(EVENT_LOAD, $.proxy(this.load, this));
            this.$canvas.html($image);
            $title.empty();

            // Center current item
            this.renderList();

            // Show title when viewed
            this.$element.one(EVENT_VIEWED, $.proxy(function () {
                var image = this.image;
                var width = image.naturalWidth;
                var height = image.naturalHeight;

                $title.html(alt + ' (' + width + ' &times; ' + height + ')');
            }, this));
        },

        // View the previous image
        prev: function () {
            this.view(max(this.index - 1, 0));
            this.canprev_next();
        },

        // View the next image
        next: function () {
            this.view(min(this.index + 1, this.length - 1));
            this.canprev_next();
        },
        //can prev or next
        canprev_next: function () {
            if (this.length == 1) {
                this.$switch.find(".viewer-prev").addClass("disabled");
                this.$switch.find(".viewer-next").addClass("disabled");
            }
            else if (this.index == 0) {
                this.$switch.find(".viewer-prev").addClass("disabled");
                this.$switch.find(".viewer-next").removeClass("disabled");
            } else if (this.index == this.length - 1) {
                this.$switch.find(".viewer-prev").removeClass("disabled");
                this.$switch.find(".viewer-next").addClass("disabled");
            } else {
                this.$switch.find(".viewer-prev").removeClass("disabled");
                this.$switch.find(".viewer-next").removeClass("disabled");
            }
        },

        /**
         * Move the image
         *
         * @param {Number} offsetX
         * @param {Number} offsetY (optional)
         */
        move: function (offsetX, offsetY) {
            var image = this.image;

            // If "offsetY" is not present, its default value is "offsetX"
            if (isUndefined(offsetY)) {
                offsetY = offsetX;
            }

            offsetX = num(offsetX);
            offsetY = num(offsetY);

            if (this.isShown && !this.isPlayed && this.options.movable) {
                image.left += isNumber(offsetX) ? offsetX : 0;
                image.top += isNumber(offsetY) ? offsetY : 0;
                this.renderImage();
            }
        },

        /**
         * Zoom the image
         *
         * @param {Number} ratio
         * @param {Boolean} hasTooltip (optional)
         */
        zoom: function (ratio, hasTooltip) {
            var options = this.options;
            var minZoomRatio = max(0.01, options.minZoomRatio);
            var maxZoomRatio = min(100, options.maxZoomRatio);
            var image = this.image;
            var width;
            var height;

            ratio = num(ratio);

            if (isNumber(ratio) && this.isShown && !this.isPlayed && options.zoomable) {
                if (ratio < 0) {
                    ratio = 1 / (1 - ratio);
                } else {
                    ratio = 1 + ratio;
                }

                width = image.width * ratio;
                height = image.height * ratio;
                ratio = width / image.naturalWidth;
                ratio = min(max(ratio, minZoomRatio), maxZoomRatio);

                if (ratio > 0.95 && ratio < 1.05) {
                    ratio = 1;
                    width = image.naturalWidth;
                    height = image.naturalHeight;
                }

                image.left -= (width - image.width) / 2;
                image.top -= (height - image.height) / 2;
                image.width = width;
                image.height = height;
                image.ratio = ratio;
                this.renderImage();

                if (hasTooltip) {
                    this.tooltip();
                }
            }
        },

        /**
         * Zoom the image to a special ratio
         *
         * @param {Number} ratio
         * @param {Boolean} hasTooltip (optional)
         * @param {Boolean} _zoomable (private)
         */
        zoomTo: function (ratio, hasTooltip, _zoomable) {
            var image = this.image;
            var width;
            var height;

            ratio = max(ratio, 0);

            if (isNumber(ratio) && this.isShown && !this.isPlayed && (_zoomable || this.options.zoomable)) {
                width = image.naturalWidth * ratio;
                height = image.naturalHeight * ratio;
                image.left -= (width - image.width) / 2;
                image.top -= (height - image.height) / 2;
                image.width = width;
                image.height = height;
                image.ratio = ratio;
                this.renderImage();

                if (hasTooltip) {
                    this.tooltip();
                }
            }
        },

        /**
         * Rotate the image
         * https://developer.mozilla.org/en-US/docs/Web/CSS/transform-function#rotate()
         *
         * @param {Number} degrees
         */
        rotate: function (degrees) {
            var image = this.image;

            degrees = num(degrees);

            if (isNumber(degrees) && this.isShown && !this.isPlayed && this.options.rotatable) {
                image.rotate = ((image.rotate || 0) + degrees);
                this.renderImage();
            }
        },

        /**
         * Rotate the image to a special angle
         *
         * @param {Number} degrees
         */
        rotateTo: function (degrees) {
            var image = this.image;

            degrees = num(degrees);

            if (isNumber(degrees) && this.isShown && !this.isPlayed && this.options.rotatable) {
                image.rotate = degrees;
                this.renderImage();
            }
        },

        /**
         * Scale the image
         * https://developer.mozilla.org/en-US/docs/Web/CSS/transform-function#scale()
         *
         * @param {Number} scaleX
         * @param {Number} scaleY (optional)
         */
        scale: function (scaleX, scaleY) {
            var image = this.image;

            // If "scaleY" is not present, its default value is "scaleX"
            if (isUndefined(scaleY)) {
                scaleY = scaleX;
            }

            scaleX = num(scaleX);
            scaleY = num(scaleY);

            if (this.isShown && !this.isPlayed && this.options.scalable) {
                image.scaleX = isNumber(scaleX) ? scaleX : 1;
                image.scaleY = isNumber(scaleY) ? scaleY : 1;
                this.renderImage();
            }
        },

        /**
         * Scale the abscissa of the image
         *
         * @param {Number} scaleX
         */
        scaleX: function (scaleX) {
            this.scale(scaleX, this.image.scaleY);
        },

        /**
         * Scale the ordinate of the image
         *
         * @param {Number} scaleY
         */
        scaleY: function (scaleY) {
            this.scale(this.image.scaleX, scaleY);
        },

        // Play the images
        play: function () {
            var options = this.options;
            var $player = this.$player;
            var load = $.proxy(this.loadImage, this);
            var list = [];
            var total = 0;
            var index = 0;
            var playing;

            if (!this.isShown || this.isPlayed) {
                return;
            }

            if (options.fullscreen) {
                this.fullscreen();
            }

            this.isPlayed = true;
            $player.addClass(CLASS_SHOW);

            this.$items.each(function (i) {
                var $this = $(this);
                var $img = $this.find(SELECTOR_IMG);
                var $image = $('<img src="' + $img.data('originalUrl') + '" alt="' + $img.attr('alt') + '">');

                total++;

                $image.addClass(CLASS_FADE).toggleClass(CLASS_TRANSITION, options.transition);

                if ($this.hasClass(CLASS_ACTIVE)) {
                    $image.addClass(CLASS_IN);
                    index = i;
                }

                list.push($image);
                $image.one(EVENT_LOAD, {
                    filled: false
                }, load);
                $player.append($image);
            });

            if (isNumber(options.interval) && options.interval > 0) {
                playing = $.proxy(function () {
                    this.playing = setTimeout(function () {
                        list[index].removeClass(CLASS_IN);
                        index++;
                        index = index < total ? index : 0;
                        list[index].addClass(CLASS_IN);

                        playing();
                    }, options.interval);
                }, this);

                if (total > 1) {
                    playing();
                }
            }
        },

        // Stop play
        stop: function () {
            if (!this.isPlayed) {
                return;
            }

            this.isPlayed = false;
            clearTimeout(this.playing);
            this.$player.removeClass(CLASS_SHOW).empty();
        },

        // Enter modal mode (only available in inline mode)
        full: function () {
            var options = this.options;
            var $image = this.$image;
            var $list = this.$list;

            if (!this.isShown || this.isPlayed || this.isFulled || !options.inline) {
                return;
            }

            this.isFulled = true;
            this.$body.addClass(CLASS_OPEN);
            this.$button.addClass(CLASS_FULLSCREEN_EXIT);

            if (options.transition) {
                $image.removeClass(CLASS_TRANSITION);
                $list.removeClass(CLASS_TRANSITION);
            }

            this.$viewer.addClass(CLASS_FIXED).removeAttr('style').css('z-index', options.zIndex);
            this.initContainer();
            this.viewer = $.extend({}, this.container);
            this.renderList();
            this.initImage($.proxy(function () {
                this.renderImage(function () {
                    if (options.transition) {
                        setTimeout(function () {
                            $image.addClass(CLASS_TRANSITION);
                            $list.addClass(CLASS_TRANSITION);
                        }, 0);
                    }
                });
            }, this));
        },

        // Exit modal mode (only available in inline mode)
        exit: function () {
            var options = this.options;
            var $image = this.$image;
            var $list = this.$list;

            if (!this.isFulled) {
                return;
            }

            this.isFulled = false;
            this.$body.removeClass(CLASS_OPEN);
            this.$button.removeClass(CLASS_FULLSCREEN_EXIT);

            if (options.transition) {
                $image.removeClass(CLASS_TRANSITION);
                $list.removeClass(CLASS_TRANSITION);
            }

            this.$viewer.removeClass(CLASS_FIXED).css('z-index', options.zIndexInline);
            this.viewer = $.extend({}, this.parent);
            this.renderViewer();
            this.renderList();
            this.initImage($.proxy(function () {
                this.renderImage(function () {
                    if (options.transition) {
                        setTimeout(function () {
                            $image.addClass(CLASS_TRANSITION);
                            $list.addClass(CLASS_TRANSITION);
                        }, 0);
                    }
                });
            }, this));
        },

        // Show the current ratio of the image with percentage
        tooltip: function () {
            var options = this.options;
            var $tooltip = this.$tooltip;
            var image = this.image;
            var classes = [
                CLASS_SHOW,
                CLASS_FADE,
                CLASS_TRANSITION
            ].join(' ');

            if (!this.isShown || this.isPlayed || !options.tooltip) {
                return;
            }

            $tooltip.text(round(image.ratio * 100) + '%');

            if (!this.fading) {
                if (options.transition) {

                    /* jshint expr:true */
                    $tooltip.addClass(classes).get(0).offsetWidth;
                    $tooltip.addClass(CLASS_IN);
                } else {
                    $tooltip.addClass(CLASS_SHOW);
                }
            } else {
                clearTimeout(this.fading);
            }

            this.fading = setTimeout($.proxy(function () {
                if (options.transition) {
                    $tooltip.one(EVENT_TRANSITIONEND, function () {
                        $tooltip.removeClass(classes);
                    }).removeClass(CLASS_IN);
                } else {
                    $tooltip.removeClass(CLASS_SHOW);
                }

                this.fading = false;
            }, this), 1000);
        },

        // Toggle the image size between its natural size and initial size.
        toggle: function () {
            if (this.image.ratio === 1) {
                this.zoomTo(this.initialImage.ratio);
            } else {
                this.zoomTo(1);
            }
        },

        // Reset the image to its initial state.
        reset: function () {
            if (this.isShown && !this.isPlayed) {
                this.image = $.extend({}, this.initialImage);
                this.renderImage();
            }
        },

        // Destroy the viewer
        destroy: function () {
            var $this = this.$element;

            if (this.options.inline) {
                this.unbind();
            } else {
                if (this.isShown) {
                    this.unbind();
                }

                this.$images.removeClass(CLASS_TOGGLE);
                $this.off(EVENT_CLICK, this.start);
            }

            this.unbuild();
            $this.removeData(NAMESPACE);
        }
    });

    $.extend(prototype, {

        // A shortcut for triggering custom events
        trigger: function (type, data) {
            var e = $.Event(type, data);

            this.$element.trigger(e);

            return e;
        },

        shown: function () {
            var options = this.options;

            this.transitioning = false;
            this.isFulled = true;
            this.isShown = true;
            this.isVisible = true;
            this.render();
            this.bind();

            if ($.isFunction(options.shown)) {
                this.$element.one(EVENT_SHOWN, options.shown);
            }

            this.trigger(EVENT_SHOWN);
        },

        hidden: function () {
            var options = this.options;

            this.transitioning = false;
            this.isViewed = false;
            this.isFulled = false;
            this.isShown = false;
            this.isVisible = false;
            this.unbind();
            this.$body.removeClass(CLASS_OPEN);
            this.$viewer.addClass(CLASS_HIDE);
            this.resetList();
            this.resetImage();

            if ($.isFunction(options.hidden)) {
                this.$element.one(EVENT_HIDDEN, options.hidden);
            }

            this.trigger(EVENT_HIDDEN);
        },

        fullscreen: function () {
            var documentElement = document.documentElement;

            if (this.isFulled && !document.fullscreenElement && !document.mozFullScreenElement &&
                !document.webkitFullscreenElement && !document.msFullscreenElement) {

                if (documentElement.requestFullscreen) {
                    documentElement.requestFullscreen();
                } else if (documentElement.msRequestFullscreen) {
                    documentElement.msRequestFullscreen();
                } else if (documentElement.mozRequestFullScreen) {
                    documentElement.mozRequestFullScreen();
                } else if (documentElement.webkitRequestFullscreen) {
                    documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                }
            }
        },

        change: function () {
            var offsetX = this.endX - this.startX;
            var offsetY = this.endY - this.startY;

            switch (this.action) {

                // Move the current image
                case 'move':
                    //this.move(offsetX, offsetY);//取消move事件
                    break;

                // Zoom the current image
                case 'zoom':
                    this.zoom(function (x1, y1, x2, y2) {
                        var z1 = sqrt(x1 * x1 + y1 * y1);
                        var z2 = sqrt(x2 * x2 + y2 * y2);

                        return (z2 - z1) / z1;
                    }(
                        abs(this.startX - this.startX2),
                        abs(this.startY - this.startY2),
                        abs(this.endX - this.endX2),
                        abs(this.endY - this.endY2)
                    ));

                    this.startX2 = this.endX2;
                    this.startY2 = this.endY2;
                    break;

                case 'switch':
                    this.action = 'switched';

                    if (offsetX > 1) {
                        this.prev();
                    } else if (offsetX < -1) {
                        this.next();
                    }

                    break;

                // No default
            }

            // Override
            this.startX = this.endX;
            this.startY = this.endY;
        },

        isSwitchable: function () {
            var image = this.image;
            var viewer = this.viewer;

            return (image.left >= 0 && image.top >= 0 && image.width <= viewer.width &&
                image.height <= viewer.height);
        }
    });

    $.extend(Viewer.prototype, prototype);

    Viewer.DEFAULTS = {
        // Enable inline mode
        inline: false,

        // Show the button on the top-right of the viewer
        button: true,

        // Show the navbar
        navbar: true,

        // Show the title
        title: true,

        // Show the toolbar
        toolbar: true,

        // Show the tooltip with image ratio (percentage) when zoom in or zoom out
        tooltip: true,

        // Enable to move the image
        movable: true,

        // Enable to zoom the image
        zoomable: true,

        // Enable to rotate the image
        rotatable: true,

        // Enable to scale the image
        scalable: true,

        // Enable CSS3 Transition for some special elements
        transition: true,

        // Enable to request fullscreen when play
        fullscreen: true,

        // Enable keyboard support
        keyboard: true,

        // Define interval of each image when playing
        interval: 5000,

        // Min width of the viewer in inline mode
        minWidth: 200,

        // Min height of the viewer in inline mode
        minHeight: 100,

        // Define the ratio when zoom the image by wheeling mouse
        zoomRatio: 0.1,

        // Define the min ratio of the image when zoom out
        minZoomRatio: 0.01,

        // Define the max ratio of the image when zoom in
        maxZoomRatio: 100,

        // Define the CSS `z-index` value of viewer in modal mode.
        zIndex: 2015,

        // Define the CSS `z-index` value of viewer in inline mode.
        zIndexInline: 0,

        // Define where to get the original image URL for viewing
        // Type: String (an image attribute) or Function (should return an image URL)
        url: 'src',

        // Event shortcuts
        build: null,
        built: null,
        show: null,
        shown: null,
        hide: null,
        hidden: null
    };

    Viewer.TEMPLATE = (
        '<div class="viewer-container">' +
        '<div class="viewer-canvas"></div>' +
        '<div class="viewer-switch">' +
        '<div class="viewer-prev icon-xiangzuo ivu-icon ivu-icon-ios-rewind-outline" data-action="prev"></div>' +
        '<div class="viewer-next icon-xiangyou ivu-icon ivu-icon-ios-fastforward-outline" data-action="next"></div>' +
        '</div>' +
        '<div class="viewer-footer">' +
        '<div class="viewer-title"></div>' +
        '<ul class="viewer-toolbar">' +
        '<li class="viewer-download icon-download ivu-icon ivu-icon-arrow-down-a" data-action="download"><span>下载</span></li>' +
        '<li class="viewer-rotate-left icon-zhuo ivu-icon ivu-icon-reply" data-action="rotate-left"><span>左旋</span></li>' +
        '<li class="viewer-rotate-right icon-you ivu-icon ivu-icon-forward" data-action="rotate-right"><span>右旋</span></li>' +
        '<li class="viewer-zoom-in icon-da ivu-icon ivu-icon-plus" data-action="zoom-in"><span>放大</span></li>' +
        '<li class="viewer-zoom-out icon-xiaosvg ivu-icon ivu-icon-minus" data-action="zoom-out"><span>缩小</span></li>' +
        //'<li class="viewer-one-to-one" data-action="one-to-one"></li>' +
        '<li class="viewer-reset icon-yuanshi ivu-icon ivu-icon-refresh" data-action="reset"><span>重置</span></li>' +
        //'<li class="viewer-prev" data-action="prev"></li>' +
        //'<li class="viewer-play" data-action="play"></li>' +
        //'<li class="viewer-next" data-action="next"></li>' +
        //'<li class="viewer-flip-horizontal" data-action="flip-horizontal"></li>' +
        //'<li class="viewer-flip-vertical" data-action="flip-vertical"></li>' +
        '</ul>' +
        '<div class="viewer-navbar">' +
        '<ul class="viewer-list"></ul>' +
        '</div>' +
        '</div>' +
        '<div class="viewer-tooltip"></div>' +
        '<div class="viewer-button viewer-close ivu-icon ivu-icon-close" data-action="mix"></div>' +
        '<div class="viewer-player"></div>' +
        '</div>'
    );

    // Save the other viewer
    Viewer.other = $.fn.viewer;

    // Register as jQuery plugin
    $.fn.viewer = function (options) {
        var args = toArray(arguments, 1);
        var result;

        this.each(function () {
            var $this = $(this);
            var data = $this.data(NAMESPACE);
            var fn;

            if (!data) {
                if (/destroy|hide|exit|stop|reset/.test(options)) {
                    return;
                }

                $this.data(NAMESPACE, (data = new Viewer(this, options)));
            }

            if (isString(options) && $.isFunction(fn = data[options])) {
                result = fn.apply(data, args);
            }
        });

        return isUndefined(result) ? this : result;
    };

    $.fn.viewer.Constructor = Viewer;
    $.fn.viewer.setDefaults = Viewer.setDefaults;

    // No conflict
    $.fn.viewer.noConflict = function () {
        $.fn.viewer = Viewer.other;
        return this;
    };

});;
//列表时间轴模式插件
(function ($) {
    $.fn.FormlistTimeline = function (option, callback) {
        var opts = $.extend({}, defaults, option);
        var timeline = new FormlistTimeline(this, opts);
        if (callback != undefined && typeof callback == 'function') {
            callback(timeline);
        }
        var defaults = [];
        return timeline;
    };
    var FormlistTimeline = function (element, options) {
        var that = this;
        var Timeline = this;
        this.$element = $(element);
        this.data = options.data || [];
        this.url = options.url || "";//请求数据的URL
        this.loaded = options.loaded;//加载完成后的回调函数
        this.isLoading = false;//正在执行请求
        this.queryParams = options.queryParams ? options.queryParams : {};//查询条件
        this.pageIndex = options.pageIndex || 0;//页码
        this.pageSize = options.pageSize || 10;//页尺寸
        this.total = 0;//总记录数
        this.axis = options.axis;//时间轴字段
        //this.iconProperty = options.iconProperty;//显示缩略图
        this.sheetUrl = options.sheetUrl;//打开表单的URL
        this.sheetCode = options.sheetCode;//表单编码
        this.handler = options.handler;//格式化请求返回的数据
        //this.multiSelectable = options.multiSelectable;//允许批量选择
        //this.noDataImg = options.noDataImg;
        //this.noDataInfo = options.noDataInfo;
        this.colors = ['#17C295', '#37ABFD', '#F7B55E', '#F2725E', '#568AAD', '#B38979', '#8A8A8A'];
        this.colorIndex = 0;
        this.gotop = options.gotop || false;//是否显示返回顶部图标

        this.$template = $("<div class='formlistTimeline container'></div>");
        if (this.gotop) {
            this.$top = $("<div class='goTop'></div>");
            this.$top.click(function () {
                Timeline.$template.animate({ scrollTop: 0 }, 200);
            });
            this.$template.append(this.$top);
        }
        this.$element.append(this.$template);


        this.generateItemDate = function (date) {
            var $itemDate = $("<div class='itemDate'></div>");
            var regDate = /^\d{4}-\d{2}-\d{2}$/;
            if (!regDate.test(date)) {
                $itemDate.append("<span class='day'></span>");
                $itemDate.append("<span class='weekDay'></span>");
                $itemDate.append("<span class='month'></span>");
            } else {
                date = date.replace(/-/g, '/');
                date = new Date(date);
                var y = date.getFullYear();
                var m = date.getMonth() + 1;
                var d = date.getDate();
                m = (m < 10) ? ("0" + m) : m;
                d = (d < 10) ? ("0" + d) : d;
                var weekDay = new Array("星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六")[date.getDay()];
                var $itemDate = $("<div class='itemDate'></div>");
                $itemDate.append("<span class='day'>" + d + "</span>");
                $itemDate.append("<span class='weekDay'>" + weekDay + "</span>");
                $itemDate.append("<span class='month'>" + (m + "/" + y) + "</span>");
            }
            return $itemDate;
        }
        //生成一个Item
        this.generateItem = function (itemDate, itemTime, objectId, name, summary, imgUrl) {
            if (this.colorIndex > 6) {
                this.colorIndex = 0;
            }

            var $row = $("<div class='row'></div>");//行
            var $leftContainer = $("<div class='col-md-2 leftContainer'></div>");//左边
            var $leftContent = $("<div class='leftContent'></div>");//左边内容
            var $rightContainer = $("<div class='col-md-10 rightContainer'></div>");//右边
            var $rightContent = $("<div class='rightContent'></div>");//右边内容
            var $dayPoint = $("<div class='dayPoint'></div>");//.css("border-color", this.colors[this.colorIndex]);//大圆点
            var $timePoint = $("<div class='timePoint'></div>").css("background-color", this.colors[this.colorIndex]);//小圆点

            $leftContainer.append($leftContent);
            if (itemDate) {
                //是一个日期项，渲染一个日期行
                var $itemDate = this.generateItemDate(itemDate);
                $leftContent.append($itemDate);
                $leftContainer.append($dayPoint);
            } else {
                //是一个时间项，包含内容
                var regTime = /^\d{2}:\d{2}$/;
                if (!regTime.test(itemTime)) {
                    $leftContent.append("<span class='time'></span>");
                } else {
                    $leftContent.append("<span class='time'>" + itemTime + "</span>");
                }
                $leftContainer.append($timePoint);
                $rightContainer.append("<div class='arrow'></div>");
                $rightContainer.append($rightContent);
                $rightContent.append("<div class='itemName'>" + name + "</div>").append($("<pre class='itemSummary'></pre>").html(summary));
            }
            $row.append($leftContainer).append($rightContainer);
            this.colorIndex++;
            return $row;
        };
        this.formatDateTime = function (date, format) {
            date = date.replace(/-/g, "/");
            var d = new Date(date);
            var y = d.getFullYear();
            var m = d.getMonth() + 1;
            var dd = d.getDate();
            var h = d.getHours();
            var mm = d.getMinutes();
            if (format == 'yyyy-mm-dd') {
                return y + '-' + (m > 9 ? m : ('0' + m)) + '-' + (dd > 9 ? dd : ('0' + dd));
            } else if (format == 'hh:ii') {
                return (h > 9 ? h : ('0' + h)) + ':' + (mm > 9 ? mm : ('0' + mm));
            }
        };
        //渲染所有Items
        this.renderItems = function (items) {
            if (items && items.length > 0) {
                //取到Timeline里面最后一个Item的时间
                var itemDates = [];
                for (var i = 0; i < items.length; i++) {
                    var item = items[i];
                    //用于渲染item的参数
                    var itemDate = null;
                    var itemTime = null;
                    var objectId = null;
                    var name = item["Name"];
                    var summary = item["Summary"];
                    var imgUrl = item["__IconUrl"];

                    name = item["Name"];
                    objectId = item["ObjectId"];
                    var axis = item[this.axis].replace(/-/g, '/');
                    itemDate = this.formatDateTime(axis, "yyyy-mm-dd");
                    //itemTime = (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(axis) || /^\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}$/.test(axis)) ? this.formatDateTime(axis, "hh:ii") : null;
                    if (/^\d{4}-\d{2}-\d{2}$/.test(axis) || /^\d{4}\/\d{2}\/\d{2}$/.test(axis)) {
                        itemTime = null;
                    } else {
                        itemTime = this.formatDateTime(axis, "hh:ii");
                        if (itemTime.split(":")[0] == "0NaN") {
                            itemTime = null;
                        }
                    }
                    if ($.inArray(itemDate, itemDates) == -1) {
                        //不存在，显示日期
                        this.$template.append(this.generateItem(itemDate));
                        itemDates.push(itemDate);
                    }
                    var $item = this.generateItem(null, itemTime, objectId, name, summary, imgUrl);
                    //绑定Item的点击事件
                    $item.find(".rightContent").click(item, function (e) {
                        var data = e.data;
                        //$.ISideModal.CloseAllModal();
                        var url = Timeline.sheetUrl + "?SchemaCode=" + Timeline.sheetCode + '&BizObjectId=' + data.ObjectId;
                        if (data.WorkItemId) {
                            url += '&WorkItemId=' + data.WorkItemId;
                        }
                        var currentItem = this;
                        $.ISideModal.Show(url, null, function (data) {
                            var actions = ["REMOVE"];//要移除Item的操作
                            var action = null;
                            if (data != undefined) {
                                action = data.Action.toUpperCase();
                            }
                            if ($.inArray(action, actions) > -1) {
                                //移除当前Item
                                Timeline.removeItem(currentItem);
                            }
                        });
                    });
                    this.$template.append($item);
                    var h_row = $item.height();
                    $item.find(".leftContainer").height(h_row);
                }
            }
        };
        //移除Item
        this.removeItem = function (item) {
            if (item == undefined) {
                return;
            }
            //如果item的上一个节点和下一个节点都是日期，则同时删除
            var $prev = $(item).prev();
            var $next = $(item).next();
            if ($prev != undefined && $next != undefined && $prev.length > 0 & $next.length > 0) {
                //判断前驱后继是否是日期节点
                if ($prev.hasClass('itemDate') && $next.hasClass('itemDate')) {
                    $prev.remove();
                }
            }
            $(item).remove();
        };
        //重新加载
        this.reload = function (options, callback) {
            this.stopLoad = false;//重置标志位
            if (this.isLoading) {
                return;
            }
            this.queryParams = {};
            if (options != undefined) {
                this.queryParams = options.queryParams;
            }
            this.$template.empty();
            if (this.gotop) {
                this.$template.append(this.$top);
            }
            $.post(this.url, this.queryParams, function (data) {
                Timeline.isLoading = true;
                var resultData = data.ReturnData.Response;
                if (Timeline.handler && typeof Timeline.handler == "function") {
                    resultData = Timeline.handler(data);
                }
                var dataItems = resultData.ReturnData;
                Timeline.total = resultData.DataCount;
                if (Timeline.total > 0) {
                    Timeline.renderItems(dataItems);
                } else {
                    Timeline.setNoData();
                }
                if (callback != void 0 && typeof callback == "function") {
                    callback(Timeline);
                }
                Timeline.isLoading = false;
            });
        };
        //无数据
        this.setNoData = function () {
            var $noData = $("<div class='noData'></div>");
            var $noDataImg = $("<img src='/Content/images/meiyoushuju.png' />");
            var $noDataInfo = $("<div class='noData-info'>还没有任何数据</div>");
            $noData.append($noDataImg).append($noDataInfo);
            this.$template.append($noData);
        };
        if (this.url) {
            //控件自己请求数据
            $.post(this.url, this.queryParams, function (data) {
                if (data.Successful) {
                    var resultData = data.ReturnData.Response;
                    if (Timeline.handler && typeof Timeline.handler == "function") {
                        resultData = Timeline.handler(data);
                    }
                    Timeline.total = resultData.DataCount;
                    var returnItems = resultData.ReturnData;
                    if (returnItems && returnItems.length > 0) {
                        Timeline.renderItems(returnItems);
                    } else {
                        //没有数据
                        Timeline.setNoData();
                    }
                } else {
                    //请求失败
                }
                if (Timeline.loaded != undefined && typeof Timeline.loaded == "function") {
                    Timeline.loaded(Timeline);
                }
            }, 'json');
        } else if (this.data) {
            this.total = this.data.length;
            if (this.data.length > 0) {
                this.renderItems(this.data);
            } else {
                this.setNoData();
            }
        }

        this.cache = [];
        this.stopLoad = false;
        this.renderIndex = 0;

        //滚动加载数据
        this.scrollLoad = function (callback) {
            if (this.cache.length > 0) {
                //从缓存加载数据
                var cache = this.cache;
                var items = cache.slice(this.pageSize * this.renderIndex, this.pageSize * (this.renderIndex + 1));
                this.cache = cache.slice(this.pageSize * (this.renderIndex + 1));
                this.renderItems(items);
            } else {
                //请求后台数据
                if (this.isLoading || this.stopLoad) {
                    return;
                }
                this.isLoading = true;
                var jsonParams = JSON.parse(this.queryParams.PostData);
                jsonParams["limit"] = jsonParams["limit"] + this.pageSize;
                jsonParams["offset"] = jsonParams["offset"] + this.pageSize;
                this.queryParams = { PostData: JSON.stringify(jsonParams) }
                $.post(this.url, this.queryParams, function (data) {
                    if (data.Successful) {
                        var returnData = data.ReturnData.Response;
                        if (Timeline.handler && typeof Timeline.handler == "function") {
                            returnData = Timeline.handler(data);
                        }
                        var dataItems = returnData.ReturnData;
                        Timeline.total = returnData.DataCount;
                        if (dataItems && dataItems.length > 0) {
                            if (dataItems.length > Timeline.pageSize) {
                                var temp = dataItems;
                                dataItems = dataItems.slice(0, Timeline.pageSize);
                                Timeline.cache = dataItems.slice(Timeline.pageSize);
                            }
                            Timeline.renderItems(dataItems);
                            if (callback != undefined && typeof callback == "function") {
                                callback(Timeline);
                            }
                        } else {
                            Timeline.stopLoad = true;
                        }
                    }
                    Timeline.isLoading = false;
                });
            }
        };

        //设置$template的高度
        //去掉兄弟节点之后的高度
        //<div>
        //<div>兄弟1</div>
        //<div>兄弟2</div>
        //<div>----this.element
        //  <div>当前节点</div>----this.$template
        //</div >
        //</div>
        var $parent = this.$element.parent();
        var h_parent = $parent.height();
        h_parent = h_parent - parseInt($parent.css("padding-top")) - parseInt($parent.css("padding-bottom"));

        var $siblings = this.$element.siblings();
        var h_siblings = 0;
        $siblings.each(function () {
            h_siblings += $(this).height();
            h_siblings += parseInt($(this).css("margin-top"));
            h_siblings += parseInt($(this).css("margin-bottom"));
        });
        this.$template.height(h_parent - h_siblings);
    };
})(window.jQuery);;
